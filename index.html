<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinemaTracker | Your Movie Journey</title>
        <!-- ========================= FAVICON (BOOKMARK/TAB ICON) START =========================
            This is the icon browsers use for tabs + bookmarks.
            To change it later: replace the embedded SVG inside the href="data:image/svg+xml,..." below.
            Tip: If you prefer a file instead of inline, swap these for: <link rel="icon" href="/favicon.ico">.
        ========================== FAVICON (BOOKMARK/TAB ICON) START ========================== -->
        <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%2309090b'/%3E%3Ctext x='32' y='42' text-anchor='middle' font-size='30' font-family='Arial, sans-serif' font-weight='700' fill='%2314b8a6'%3ECT%3C/text%3E%3C/svg%3E">
        <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%2309090b'/%3E%3Ctext x='32' y='42' text-anchor='middle' font-size='30' font-family='Arial, sans-serif' font-weight='700' fill='%2314b8a6'%3ECT%3C/text%3E%3C/svg%3E">
        <!-- ========================== FAVICON (BOOKMARK/TAB ICON) END ========================== -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;      /* Zinc 950 */
            --surface: #18181b;      /* Zinc 900 */
            --border: #27272a;       /* Zinc 800 */
            --text-main: #e4e4e7;    /* Zinc 200 */
            --text-muted: #a1a1aa;   /* Zinc 400 */
            
            --brand: #14b8a6;        /* Teal 500 */
            --brand-hover: #0d9488;  /* Teal 600 */
            --brand-light: rgba(20, 184, 166, 0.1);

            /* Tier colors (match Data Dashboard tier colors) */
            --tier-s-rgb: 239, 68, 68;   /* Red (#ef4444) */
            --tier-a-rgb: 251, 146, 60;  /* Orange (#fb923c) */
            --tier-b-rgb: 250, 204, 21;  /* Yellow (#facc15) */
            --tier-c-rgb: 74, 222, 128;  /* Green (#4ade80) */
            --tier-d-rgb: 96, 165, 250;  /* Blue (#60a5fa) */
            --tier-f-rgb: 168, 85, 247;  /* Purple (#a855f7) */
            
            --font-family: 'Outfit', sans-serif;
            --container-width: 1280px;
            --header-height: 64px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }

        a { text-decoration: none; color: inherit; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; }
        input, select, textarea { font-family: inherit; }
        .container {
            max-width: var(--container-width);
            margin: 0 auto;
            padding: 0 1.5rem;
            width: 100%;
        }

        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .grid { display: grid; }
        .hidden { display: none !important; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(1, 1fr); } /* Mobile default */
        .grid-4 { grid-template-columns: repeat(2, 1fr); } /* Mobile default */

        @media (min-width: 768px) {
            .grid-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-4 { grid-template-columns: repeat(4, 1fr); }
            .md-block { display: block; }
            .md-hidden { display: none; }
            .md-row { flex-direction: row; }
            .col-span-2 { grid-column: span 2; }
        }
        .fade-in { animation: fadeIn 0.4s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .animate-marquee {
            display: flex;
            width: max-content;
            animation: marquee 40s linear infinite;
        }
        .animate-marquee:hover { animation-play-state: paused; }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .glass-panel {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 50;
            border-bottom: 1px solid var(--border);
        }
        .nav-inner {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-brand { font-size: 1.25rem; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 0.5rem; }
        .nav-brand span { color: var(--brand); }
        .nav-links { display: flex; gap: 0.75rem; }
        .nav-link {
            font-size: 0.95rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            color: rgba(255,255,255,0.9);
            padding: 0.55rem 0.95rem;
            border-radius: 999px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.14);
            transition: background 0.2s, border-color 0.2s, transform 0.2s, box-shadow 0.2s, color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .nav-link:hover {
            color: #fff;
            background: rgba(255,255,255,0.07);
            border-color: rgba(255,255,255,0.30);
            transform: translateY(-1px);
        }
        .nav-link.active {
            color: #fff;
            background: linear-gradient(135deg, rgba(20,184,166,0.28), rgba(168,85,247,0.22));
            border-color: rgba(20,184,166,0.45);
            box-shadow: 0 10px 26px rgba(0,0,0,0.35);
        }
        .mobile-menu-btn { color: var(--text-muted); display: none; }
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .mobile-menu-btn { display: block; }
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary {
            background-color: var(--brand);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(20, 184, 166, 0.3);
        }
        .btn-primary:hover { background-color: var(--brand-hover); }
        
        .btn-glass {
            background: rgba(255,255,255,0.05);
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-glass:hover { background: rgba(255,255,255,0.1); }

        .btn-outline {
            background: var(--surface);
            border: 1px solid var(--border);
            color: white;
        }
        .btn-outline:hover { border-color: var(--brand); }
        .input-group { position: relative; }
        .input-field, .select-field, .textarea-field {
            width: 100%;
            background-color: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: white;
            outline: none;
            transition: border-color 0.2s;
            color-scheme: dark; /* For calendar picker */
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 1px var(--brand);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding-left: 3rem; /* Space for icon */
            font-size: 1.125rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        /* Make native date picker indicator easier to find/click (Safari/Chrome) */
        input[type="date"] { cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            width: 22px;
            height: 22px;
            padding: 10px;
            cursor: pointer;
            opacity: 0.95;
        }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        /* Genre chips (tap/click selection, max 2) */
        .genre-chip-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .genre-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0.75rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: #fff;
            font-size: 0.875rem;
            font-weight: 600;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .genre-chip:hover { border-color: var(--brand); }
        .genre-chip.selected {
            border-color: var(--brand);
            background: var(--brand-light);
        }

        /* Tier selector buttons (single-choice, not locked) */
        .tier-btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.6rem;
        }
        @media (min-width: 768px) {
            .tier-btn-group { grid-template-columns: repeat(6, 1fr); }
        }
        .tier-btn {
            --tier-rgb: 255, 255, 255;
            width: 100%;
            padding: 0.75rem 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(var(--tier-rgb), 0.45);
            color: white;
            font-weight: 800;
            letter-spacing: 0.04em;
            transition: transform 0.15s ease, opacity 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            background: rgba(var(--tier-rgb), 0.22);
        }
        .tier-btn[data-tier="S-Tier"] { --tier-rgb: var(--tier-s-rgb); }
        .tier-btn[data-tier="A-Tier"] { --tier-rgb: var(--tier-a-rgb); }
        .tier-btn[data-tier="B-Tier"] { --tier-rgb: var(--tier-b-rgb); }
        .tier-btn[data-tier="C-Tier"] { --tier-rgb: var(--tier-c-rgb); }
        .tier-btn[data-tier="D-Tier"] { --tier-rgb: var(--tier-d-rgb); }
        .tier-btn[data-tier="F-Tier"] { --tier-rgb: var(--tier-f-rgb); }

        .tier-btn:active { transform: scale(0.98); }
        .tier-btn-group[data-has-selection="true"] .tier-btn {
            opacity: 0.16;
            filter: grayscale(0.75) brightness(0.95);
            box-shadow: none;
        }
        .tier-btn-group[data-has-selection="true"] .tier-btn.selected {
            opacity: 1;
            filter: none;
            transform: translateY(-1px);
            background: rgba(var(--tier-rgb), 0.32);
            border-color: rgba(var(--tier-rgb), 0.75);
            box-shadow:
                0 0 0 2px rgba(var(--tier-rgb), 0.55),
                0 10px 28px rgba(0,0,0,0.45),
                0 0 28px rgba(var(--tier-rgb), 0.22);
        }

        /* Watch-method modal selection highlight */
        .watch-method-option.selected {
            box-shadow: 0 0 0 2px rgba(255,255,255,0.35);
            border-color: rgba(255,255,255,0.45) !important;
        }
        #watch-method-overlay[data-has-selection="true"] .watch-method-option {
            opacity: 0.22;
            filter: grayscale(0.9) brightness(0.9);
            box-shadow: none;
        }
        #watch-method-overlay[data-has-selection="true"] .watch-method-option.selected {
            opacity: 1;
            filter: none;
            box-shadow:
                0 0 0 2px rgba(255,255,255,0.28),
                0 16px 40px rgba(0,0,0,0.45);
        }
        .input-readonly {
            background-color: rgba(255,255,255,0.02);
            color: white;
            cursor: not-allowed;
        }

        /* Cards */
        .movie-card {
            position: relative;
            aspect-ratio: 2/3;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: var(--surface);
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .movie-card:hover {
            transform: scale(1.03);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .movie-card img { width: 100%; height: 100%; object-fit: cover; }
        .movie-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1rem;
        }
        .movie-card:hover .movie-overlay { opacity: 1; }

        /* Trending Card */
        .trending-card {
            flex: 0 0 160px;
            height: 240px;
            border-radius: 0.5rem;
            overflow: hidden;
            margin: 0 0.5rem;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--surface);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .trending-card:hover { transform: scale(1.05); }
        .trending-card img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Search Dropdown */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            margin-top: 0.5rem;
            background-color: #18181b;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 50;
            max-height: 360px;
            overflow-y: auto;
        }
        .search-item {
            padding: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .search-item:hover { background-color: var(--brand-light); }
        .search-item:last-child { border-bottom: none; }

        /* Range Sliders */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .slider-container.slider-vertical {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        .slider-container.slider-vertical .relative {
            width: 100% !important;
        }
        input[type=range] {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--brand);
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: #0d9488;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 100;
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        /* Auth Modal */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.25rem;
            font-size: 1.18rem;
            font-weight: 900;
            letter-spacing: 0.01em;
        }
        .auth-overlay.open { display: flex; }
        .auth-modal {
            font-weight: 900;
            font-size: 1.06rem;
            background: rgba(24, 24, 27, 0.92);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: 0 24px 60px rgba(0,0,0,0.55);
            padding: 1.25rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 460px;
        }
        .auth-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .auth-modal-title {
            font-size: 1.05rem;
            font-weight: 800;
            color: #fff;
        }
        .auth-modal-close {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 0.7rem;
            padding: 0.45rem 0.65rem;
            color: white;
            font-weight: 800;
        }
        .auth-modal-close:hover { background: rgba(255,255,255,0.10); }
        .auth-modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 0.75rem;
        }

        /* Lists Page */
        .lists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }
        @media (max-width: 520px) {
            .lists-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        .lists-movie-card {
            padding: 0.9rem;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.04);
            transition: transform 0.18s ease, border-color 0.18s ease, background 0.18s ease;
        }
        .lists-movie-card:hover {
            transform: translateY(-2px);
            border-color: rgba(20,184,166,0.38);
            background: rgba(20,184,166,0.07);
        }
        .lists-poster-btn {
            width: 100%;
            padding: 0;
            border: 0;
            background: transparent;
            cursor: pointer;
            text-align: left;
        }
        .lists-poster {
            width: 100%;
            aspect-ratio: 2 / 3;
            border-radius: 0.95rem;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06);
        }
        .lists-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .lists-title {
            color: #fff;
            font-weight: 950;
            font-size: 1.08rem;
            line-height: 1.18;
            overflow: hidden;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .lists-title-year {
            color: rgba(255,255,255,0.68);
            font-weight: 900;
        }
        .lists-meta {
            margin-top: 0.15rem;
            color: rgba(255,255,255,0.76);
            font-weight: 850;
            font-size: 0.98rem;
            line-height: 1.25;
            overflow-wrap: anywhere;
        }
        .lists-meta-list {
            margin-top: 0.35rem;
            display: grid;
            gap: 6px;
        }
        .lists-meta-item {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            color: rgba(255,255,255,0.76);
            font-weight: 850;
            font-size: 0.98rem;
            line-height: 1.25;
            overflow-wrap: anywhere;
        }
        .lists-bullet {
            color: var(--brand);
            font-weight: 950;
            line-height: 1;
            margin-top: 2px;
            flex: 0 0 auto;
        }
        .lists-card-actions {
            margin-top: 0.35rem;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-actions { display: flex; align-items: center; gap: 0.75rem; }
        .nav-auth-btn {
            padding: 0.5rem 0.9rem;
            border-radius: 0.75rem;
            font-weight: 800;
            font-size: 0.875rem;
            background: rgba(255,255,255,0.05);
            color: white;
            border: 1px solid rgba(255,255,255,0.10);
        }
        .nav-auth-btn:hover { background: rgba(255,255,255,0.10); }

        .log-fab {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            z-index: 110;
            background: rgba(24, 24, 27, 0.92);
            color: white;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 999px;
            padding: 0.6rem 0.9rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.35);
        }
        .log-fab:hover { border-color: rgba(255,255,255,0.22); }
        .log-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.6rem;
            height: 1.6rem;
            padding: 0 0.45rem;
            border-radius: 999px;
            background: rgba(20, 184, 166, 0.35);
            border: 1px solid rgba(20, 184, 166, 0.55);
            font-size: 0.8rem;
            line-height: 1;
        }
        .log-panel {
            position: fixed;
            left: 1.5rem;
            bottom: 4.5rem;
            width: min(720px, calc(100vw - 3rem));
            max-height: min(60vh, 520px);
            z-index: 120;
            background: rgba(9, 9, 11, 0.96);
            color: white;
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 0.9rem;
            box-shadow: 0 18px 45px rgba(0,0,0,0.5);
            overflow: hidden;
            display: none;
        }
        .log-panel.open { display: flex; flex-direction: column; }
        .log-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            gap: 0.75rem;
        }
        .log-panel-title { font-weight: 800; }
        .log-panel-actions { display: flex; gap: 0.5rem; }
        .log-btn {
            background: rgba(255,255,255,0.08);
            color: white;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 0.6rem;
            padding: 0.45rem 0.65rem;
            cursor: pointer;
            font-weight: 700;
        }
        .log-btn:hover { background: rgba(255,255,255,0.12); }
        .log-body {
            overflow: auto;
            padding: 0.75rem 0.9rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.85rem;
            line-height: 1.35;
            white-space: pre-wrap;
        }
        .log-item { padding: 0.4rem 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
        .log-item:last-child { border-bottom: none; }
        .log-meta { opacity: 0.75; }
        .log-level-error { color: #fb7185; }
        .log-level-warn { color: #fbbf24; }
        .log-level-info { color: #34d399; }

        /* Footer */
        footer {
            background-color: var(--surface);
            border-top: 1px solid var(--border);
            margin-top: auto;
            padding: 2rem 0;
        }

        /* Typography Helpers */
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-xl { font-size: 1.25rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .text-5xl { font-size: 3rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-mono { font-family: monospace; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .text-brand { color: var(--brand); }
        .text-white { color: white; }
        .text-gray { color: var(--text-muted); }
        .uppercase { text-transform: uppercase; letter-spacing: 0.05em; }
        .capitalize { text-transform: capitalize; }
        .mb-2 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        /* Increased label-to-input gap for submit page */
        .label-gap { margin-bottom: 0.5rem !important; }
        /* Force spacing when an input/select/textarea follows a submit label */
        .submit-label + .input-field,
        .submit-label + .select-field,
        .submit-label + .textarea-field { margin-top: 0.5rem !important; }
        /* Handle wrapped controls (e.g., sliders, quote input) */
        .submit-label + .slider-container { margin-top: 0.5rem !important; }
        .submit-label + .relative { margin-top: 0.5rem !important; }
        /* Handle grid blocks (e.g., External Ratings) and read-only inputs */
        .submit-label + .grid { margin-top: 0.5rem !important; }

        /* Form validation helpers */
        .field-error-msg {
            color: rgba(254, 202, 202, 0.95);
            font-size: 0.78rem;
            font-weight: 800;
            margin-bottom: 0.35rem;
            letter-spacing: 0.01em;
        }
        .field-error-outline {
            outline: 2px solid rgba(239, 68, 68, 0.40);
            outline-offset: 2px;
            border-color: rgba(239, 68, 68, 0.55) !important;
        }
        
        /* Mobile Menu */
        #mobile-menu { display: none; }
        #mobile-menu.open { display: block; border-top: 1px solid var(--border); padding: 1rem; }
        .mobile-link {
            display: block;
            padding: 0.8rem 0.9rem;
            color: rgba(255,255,255,0.92);
            font-weight: 800;
            letter-spacing: 0.03em;
            border-radius: 0.75rem;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.03);
        }
        .mobile-link:hover {
            background: rgba(255,255,255,0.07);
            color: #fff;
            border-color: rgba(255,255,255,0.25);
        }

        @media (max-width: 768px) {
            .text-5xl { font-size: 2.25rem; }
            .text-4xl { font-size: 1.75rem; }
            .navbar { padding: 0; }
        }

        /* Dashboard helpers */
        .dash-mini-kpi {
            padding: 0.9rem 0.95rem;
            border-radius: 0.75rem;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .dash-kpi-clickable {
            cursor: pointer;
            transition: transform 140ms ease, background 140ms ease, border-color 140ms ease;
        }
        .dash-kpi-clickable:hover {
            transform: translateY(-1px);
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.22);
        }
        .dash-mini-kpi-value { line-height: 1; }
        .dash-mini-kpi-label {
            margin-top: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.07em;
        }

        .dash-tier-card {
            padding: 0.9rem 0.95rem;
            border-radius: 0.85rem;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .dash-tier-progress {
            height: 9px;
            background: rgba(255,255,255,0.06);
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .dash-tier-progressFill { height: 100%; }
        .dash-tier-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.07em;
        }
        .dash-tier-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .dash-movie-row {
            padding: 0.6rem 0.75rem;
            border-radius: 0.7rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Help-text emphasis (scores + tiers) */
        .dash-help-score {
            /* Match the CinemaTracker logo color */
            color: var(--brand);
            font-weight: 900;
        }
        .dash-help-tier {
            font-weight: 900;
        }
        .dash-help-tier[data-tier-letter="S"] { color: rgb(var(--tier-s-rgb)); }
        .dash-help-tier[data-tier-letter="A"] { color: rgb(var(--tier-a-rgb)); }
        .dash-help-tier[data-tier-letter="B"] { color: rgb(var(--tier-b-rgb)); }
        .dash-help-tier[data-tier-letter="C"] { color: rgb(var(--tier-c-rgb)); }
        .dash-help-tier[data-tier-letter="D"] { color: rgb(var(--tier-d-rgb)); }
        .dash-help-tier[data-tier-letter="F"] { color: rgb(var(--tier-f-rgb)); }

        /* Feed */
        .feed-actor {
            color: rgba(255,255,255,0.95);
            font-weight: 900;
        }

        .feed-sort-btn {
            padding: 0.55rem 0.8rem;
            font-size: 0.9rem;
        }

        .feed-card-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .feed-card-poster {
            width: 54px;
            height: 78px;
            border-radius: 0.75rem;
            overflow: hidden;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.06);
            flex: 0 0 auto;
        }
        .feed-card-main {
            min-width: 0;
            flex: 1 1 220px;
        }
        .feed-card-actor {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            white-space: nowrap;
            flex: 0 0 auto;
        }
        .feed-card-actor-name {
            color: rgba(255,255,255,0.92);
            font-weight: 900;
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }

        .feed-item-card {
            cursor: pointer;
        }
        .feed-card-details {
            display: none;
            margin-top: 0.75rem;
        }
        .feed-item-card.is-open .feed-card-details {
            display: block;
        }

        /* Library (My Movies) */
        .library-card-row {
            display: flex;
            gap: 14px;
            align-items: flex-start;
            flex-wrap: nowrap;
        }
        .library-card-left {
            flex: 0 0 auto;
            width: 128px;
            min-width: 128px;
            max-width: 128px;
        }
        .library-card-poster {
            width: 100%;
            height: 190px;
            border-radius: 0.95rem;
            overflow: hidden;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.06);
        }

        .library-poster-flip {
            position: relative;
            width: 100%;
            height: 100%;
            perspective: 900px;
        }
        .library-poster-flip-inner {
            position: absolute;
            inset: 0;
            transform-style: preserve-3d;
            transition: transform 560ms cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .library-card-poster:hover .library-poster-flip-inner {
            transform: rotateY(180deg);
        }
        .library-poster-face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .library-poster-front {
            background: rgba(255,255,255,0.02);
        }
        .library-poster-back {
            transform: rotateY(180deg);
            background: rgba(0,0,0,0.78);
            border: 1px solid rgba(255,255,255,0.10);
            padding: 0.6rem 0.65rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
        }
        .library-poster-back-line {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: baseline;
        }
        .library-poster-back-key {
            color: rgba(255,255,255,0.60);
            font-weight: 850;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            white-space: nowrap;
            flex: 0 0 auto;
            text-align: left;
            font-size: 0.72rem;
        }
        .library-poster-back-val {
            color: rgba(255,255,255,0.94);
            font-weight: 900;
            text-align: right;
            min-width: 0;
            flex: 1 1 auto;
            display: block;
            width: 100%;
            font-size: 0.78rem;
            line-height: 1.25;
            white-space: normal;
            overflow-wrap: normal;
            word-break: normal;
            hyphens: none;
        }
        .library-under {
            margin-top: 0.55rem;
            display: grid;
            gap: 6px;
            font-size: 0.72rem;
            line-height: 1.25;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        .library-under-line {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: baseline;
            flex-wrap: nowrap;
            width: 100%;
            max-width: 100%;
        }
        .library-under-key {
            color: rgba(255,255,255,0.55);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            white-space: nowrap;
            flex: 0 0 auto;
            text-align: left;
        }
        .library-under-val {
            color: rgba(255,255,255,0.92);
            font-weight: 850;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            flex: 1 1 auto;
        }
        .library-under-val-wrap {
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: normal;
            min-width: 0;
            flex: 1 1 auto;
        }

        .library-under-val-multiline {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .library-title-line {
            display: inline;
            white-space: normal;
            font-size: 1.18rem;
            font-weight: 950;
            letter-spacing: 0.01em;
        }
        .library-title-meta {
            color: rgba(255,255,255,0.88);
            font-weight: 900;
            font-size: 1.06rem;
        }

        .library-title-sep {
            color: var(--brand);
            font-weight: 950;
        }

        .library-subratings .dash-quote-pill {
            font-size: 0.98rem;
            padding: 0.32rem 0.72rem;
            border-color: rgba(255,255,255,0.16);
            background: rgba(0,0,0,0.26);
            letter-spacing: 0.02em;
        }
        .library-chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.72rem;
        }
        @media (max-width: 520px) {
            .library-card-row { flex-wrap: wrap; }
            .library-card-left { width: 116px; min-width: 116px; max-width: 116px; }
            .library-card-poster { width: 100%; height: 172px; }
        }
        .user-icon {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: 0 10px 24px rgba(0,0,0,0.30);
            color: rgba(255,255,255,0.92);
            flex: 0 0 auto;
        }
        .user-icon svg {
            width: 16px;
            height: 16px;
            stroke-width: 2.2;
        }
        .user-icon[data-icon-id="icon_01"] { background: linear-gradient(135deg, rgba(20,184,166,0.55), rgba(20,184,166,0.10)); }
        .user-icon[data-icon-id="icon_02"] { background: linear-gradient(135deg, rgba(168,85,247,0.55), rgba(168,85,247,0.12)); }
        .user-icon[data-icon-id="icon_03"] { background: linear-gradient(135deg, rgba(59,130,246,0.55), rgba(59,130,246,0.12)); }
        .user-icon[data-icon-id="icon_04"] { background: linear-gradient(135deg, rgba(245,158,11,0.55), rgba(245,158,11,0.12)); }
        .user-icon[data-icon-id="icon_05"] { background: linear-gradient(135deg, rgba(239,68,68,0.55), rgba(239,68,68,0.12)); }
        .user-icon[data-icon-id="icon_06"] { background: linear-gradient(135deg, rgba(34,197,94,0.55), rgba(34,197,94,0.12)); }
        .user-icon[data-icon-id="icon_07"] { background: linear-gradient(135deg, rgba(14,165,233,0.55), rgba(14,165,233,0.12)); }
        .user-icon[data-icon-id="icon_08"] { background: linear-gradient(135deg, rgba(236,72,153,0.55), rgba(236,72,153,0.12)); }
        .user-icon[data-icon-id="icon_09"] { background: linear-gradient(135deg, rgba(129,140,248,0.55), rgba(129,140,248,0.12)); }
        .user-icon[data-icon-id="icon_10"] { background: linear-gradient(135deg, rgba(148,163,184,0.50), rgba(148,163,184,0.12)); }

        .account-icon-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 10px;
            margin-top: 0.6rem;
        }
        @media (max-width: 520px) {
            .account-icon-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        .account-icon-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border-radius: 0.9rem;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.04);
            cursor: pointer;
            transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
        }
        .account-icon-btn:hover {
            border-color: rgba(255,255,255,0.22);
            background: rgba(255,255,255,0.07);
            transform: translateY(-1px);
        }
        .account-icon-btn[aria-pressed="true"] {
            border-color: rgba(20,184,166,0.55);
            background: rgba(20,184,166,0.10);
            box-shadow: 0 0 0 1px rgba(20,184,166,0.35);
        }
        .feed-metrics {
            margin-top: 0.35rem;
            font-size: 0.95rem;
            line-height: 1.15;
            display: flex;
            align-items: baseline;
            gap: 10px;
            flex-wrap: wrap;
        }
        .feed-metrics .dash-help-score {
            font-size: 1.15rem;
        }
        .feed-metrics .dash-help-tier {
            font-size: 1.0rem;
        }

        /* Quote Wall */
        .dash-quote-wall-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 14px;
            align-items: stretch;
        }
        .dash-quote-card {
            position: relative;
            border-radius: 1rem;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.05);
            overflow: hidden;
            cursor: pointer;
            transition: border-color 140ms ease, background 140ms ease, box-shadow 140ms ease;
        }
        .dash-quote-card:hover {
            border-color: rgba(20,184,166,0.40);
            background: rgba(255,255,255,0.07);
            box-shadow: 0 18px 50px rgba(0,0,0,0.40);
        }
        .dash-quote-card::before {
            content: "";
            position: absolute;
            inset: -2px;
            background: radial-gradient(600px circle at var(--mx, 40%) var(--my, 25%), rgba(168,85,247,0.18), transparent 45%),
                        radial-gradient(520px circle at var(--mx2, 70%) var(--my2, 80%), rgba(20,184,166,0.14), transparent 50%);
            opacity: 0.85;
            pointer-events: none;
        }
        .dash-quote-card-inner {
            position: relative;
            padding: 1rem 1rem 0.95rem;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
            /* Intentionally no motion: keep text easy to read. */
        }
        .dash-quote-text {
            font-size: 0.98rem;
            line-height: 1.35;
            color: rgba(255,255,255,0.95);
            font-weight: 750;
            letter-spacing: 0.01em;
        }
        .dash-quote-text em { font-style: italic; font-weight: 750; }
        .dash-quote-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            color: rgba(255,255,255,0.78);
            font-size: 0.78rem;
        }
        .dash-quote-pill {
            padding: 0.22rem 0.55rem;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(0,0,0,0.20);
            font-weight: 850;
            letter-spacing: 0.03em;
        }
        .dash-quote-title {
            font-size: 0.92rem;
            font-weight: 900;
            color: rgba(255,255,255,0.96);
            line-height: 1.2;
        }

        /* Icon Size Helper */
        svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm svg { width: 16px; height: 16px; }
        .icon-lg svg { width: 32px; height: 32px; }

        /* Save gating UX */
        #btn-save-diary[aria-disabled="true"] { cursor: not-allowed; }

        /* Dashboard tabs + timeframe buttons */
        .dash-pill-btn {
            padding: 0.6rem 0.95rem !important;
            border-radius: 999px !important;
            font-size: 0.95rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            line-height: 1;
            border-width: 1px;
        }
        .dash-pill-btn.btn-outline {
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.16);
            color: rgba(255,255,255,0.92);
        }
        .dash-pill-btn.btn-outline:hover {
            border-color: rgba(255,255,255,0.32);
            background: rgba(255,255,255,0.07);
        }
        .dash-pill-btn.btn-glass {
            background: linear-gradient(135deg, rgba(20,184,166,0.24), rgba(168,85,247,0.18));
            border-color: rgba(20,184,166,0.42);
            color: #fff;
            box-shadow: 0 10px 26px rgba(0,0,0,0.35);
        }
        .dash-pill-btn.btn-glass:hover {
            background: linear-gradient(135deg, rgba(20,184,166,0.30), rgba(168,85,247,0.22));
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar glass-panel">
        <div class="container nav-inner">
            <div class="nav-brand" onclick="router.navigate('home')" style="cursor:pointer;">
                <span class="icon-wrapper" id="nav-logo-icon"></span>
                <span>Cinema<span>Tracker</span></span>
            </div>
            
            <div class="nav-links">
                <button onclick="router.navigate('home')" class="nav-link">Home</button>
                <button onclick="router.navigate('feed')" class="nav-link">Feed</button>
                <button onclick="router.navigate('library')" class="nav-link">My Movies</button>
                <button onclick="router.navigate('lists')" class="nav-link">Lists</button>
                <button onclick="router.navigate('dashboard')" class="nav-link">Data Dash</button>
            </div>

            <div class="nav-actions">
                <button id="nav-login-btn" class="nav-auth-btn" type="button" onclick="handleNavAccountButtonClick(event)">Login</button>

                <div class="mobile-menu-btn">
                    <button onclick="toggleMobileMenu()" id="menu-icon-btn"></button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="glass-panel">
            <button onclick="router.navigate('home')" class="mobile-link">Home</button>
            <button onclick="router.navigate('feed')" class="mobile-link">Feed</button>
            <button onclick="router.navigate('library')" class="mobile-link">My Movies</button>
            <button onclick="router.navigate('lists')" class="mobile-link">Lists</button>
            <button onclick="router.navigate('dashboard')" class="mobile-link">Data Dash</button>
            <button id="mobile-auth-btn" onclick="handleNavAccountButtonClick(event); document.getElementById('mobile-menu').classList.remove('open');" class="mobile-link">Login</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-root" style="padding-top: var(--header-height);">
        <!-- Content injected by JS -->
    </main>

    <button id="log-fab" class="log-fab" type="button" aria-label="Open message log">
        <span class="icon-sm" id="log-fab-icon"></span>
        Logs <span id="log-badge" class="log-badge">0</span>
    </button>

    <div id="log-panel" class="log-panel" aria-live="polite">
        <div class="log-panel-header">
            <div class="log-panel-title">Message Log</div>
            <div class="log-panel-actions">
                <button id="log-copy" class="log-btn" type="button">Copy</button>
                <button id="log-clear" class="log-btn" type="button">Clear</button>
                <button id="log-close" class="log-btn" type="button">Close</button>
            </div>
        </div>
        <div id="log-body" class="log-body"></div>
    </div>

    <div id="toast" class="toast">
        <span id="toast-icon"></span>
        <span id="toast-message" class="font-semibold">Action successful!</span>
    </div>

    <div id="ratings-success-overlay" class="auth-overlay" onclick="if(event.target === this) closeRatingsSuccessModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="ratings-success-title" style="max-width: 420px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="ratings-success-title">Movie Ratings Saved</div>
                <button class="auth-modal-close" type="button" onclick="closeRatingsSuccessModal()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Your diary has been updated.
            </div>
        </div>
    </div>

    <div id="auth-overlay" class="auth-overlay" onclick="if(event.target === this) closeAuthModal();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="auth-modal-title">Login</div>
                <button class="auth-modal-close" type="button" onclick="closeAuthModal()">Close</button>
            </div>

            <div class="grid md-row gap-6" style="margin-top: 0px;">
                <div style="flex:1;">
                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Email</label>
                    <input id="auth-email" type="email" class="input-field" placeholder="you@example.com" autocomplete="email">
                </div>
                <div style="flex:1;">
                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Password</label>
                    <input id="auth-password" type="password" class="input-field" placeholder="" autocomplete="current-password">
                </div>
            </div>

            <div class="flex items-center gap-3" style="margin-top: 0.75rem;">
                <div id="auth-modal-status" class="text-sm" style="flex:1; color: var(--text-muted);">Not logged in.</div>
            </div>

            <div class="auth-modal-actions">
                <button type="button" id="auth-login-btn" class="btn btn-glass" onclick="handleLoginClick(event)">Log in</button>
                <button type="button" id="auth-logout-btn" class="btn btn-outline" onclick="handleLogoutClick(event)" style="display:none;">Log out</button>
            </div>
        </div>
    </div>

    <div id="dashboard-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeDashboardAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="dashboard-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="dashboard-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeDashboardAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to view your data dashboard
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeDashboardAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="feed-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeFeedAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="feed-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="feed-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeFeedAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to view your feed
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeFeedAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="library-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeLibraryAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="library-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="library-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeLibraryAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to view your movies
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeLibraryAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="lists-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeListsAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="lists-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="lists-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeListsAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to view your lists
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeListsAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="list-picker-overlay" class="auth-overlay" onclick="if(event.target === this) closeListPickerModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="list-picker-title" style="max-width: 520px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="list-picker-title">Add to List</div>
                <button class="auth-modal-close" type="button" onclick="closeListPickerModal()">Close</button>
            </div>

            <div id="list-picker-movie" class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;"></div>

            <div class="glass-panel" style="margin-top: 0.85rem; padding: 0.85rem; border-radius: 0.85rem; background: rgba(0,0,0,0.10);">
                <div class="text-white font-bold">Choose a list</div>
                <div id="list-picker-lists" class="text-gray" style="margin-top: 0.65rem; display:flex; flex-direction: column; gap: 0.5rem;">Loading</div>
            </div>

            <form id="list-picker-create-form" style="margin-top: 0.85rem; display:grid; gap: 0.65rem;">
                <div class="text-white font-bold">Or create a new list</div>
                <input id="list-picker-new-name" type="text" class="input-field" placeholder="e.g. 2026 Watchlist" maxlength="80">
                <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Create & Add</button>
                    <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="closeListPickerModal()">Cancel</button>
                </div>
                <div id="list-picker-status" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
            </form>
        </div>
    </div>

    <div id="lists-create-overlay" class="auth-overlay" onclick="if(event.target === this) closeListsCreateModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="lists-create-title" style="max-width: 520px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="lists-create-title">Create New List</div>
                <button class="auth-modal-close" type="button" onclick="closeListsCreateModal()">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Give your list a name (max 80 characters).
            </div>

            <form id="lists-create-form" style="margin-top: 0.85rem; display:grid; gap: 0.65rem;">
                <input id="lists-create-name" type="text" class="input-field" placeholder="e.g. 2026 Watchlist" maxlength="80" autocomplete="off">
                <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Save</button>
                    <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="closeListsCreateModal()">Cancel</button>
                </div>
                <div id="lists-create-status" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
            </form>
        </div>
    </div>

    <div id="library-sortfilter-overlay" class="auth-overlay" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="library-sortfilter-title" style="max-width: 560px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="library-sortfilter-title">Filters & Sort</div>
                <button class="auth-modal-close" type="button" data-library-action="cancel_sort_filter">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Choose filters + sorting, then press <span class="text-white font-semibold">Save</span> to update your list.
            </div>

            <div class="glass-panel" style="margin-top: 0.85rem; padding: 0.85rem; border-radius: 0.85rem; background: rgba(0,0,0,0.10);">
                <div class="text-white font-bold" style="margin-bottom: 0.55rem;">Sort</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="library-modal-sort-key" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="watch_date">Watch Date</option>
                        <option value="overall">Overall %</option>
                        <option value="sound">Sound %</option>
                        <option value="pace">Pace %</option>
                        <option value="imagery">Imagery %</option>
                        <option value="acting">Acting %</option>
                        <option value="plot">Plot %</option>
                        <option value="dialogue">Dialogue %</option>
                        <option value="imdb">IMDb %</option>
                        <option value="release_year">Release Year</option>
                    </select>
                    <select id="library-modal-sort-dir" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="desc">Descending</option>
                        <option value="asc">Ascending</option>
                    </select>
                </div>

                <div style="height: 1px; background: rgba(255,255,255,0.06); margin: 0.85rem 0;"></div>

                <div class="text-white font-bold" style="margin-bottom: 0.55rem;">Filters</div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                    <select id="library-modal-filter-tier" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Tier (All)</option>
                        <option value="S-Tier">S-Tier</option>
                        <option value="A-Tier">A-Tier</option>
                        <option value="B-Tier">B-Tier</option>
                        <option value="C-Tier">C-Tier</option>
                        <option value="D-Tier">D-Tier</option>
                        <option value="F-Tier">F-Tier</option>
                        <option value="UNRANKED">Unranked</option>
                    </select>

                    <select id="library-modal-filter-decade" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Release Decade (All)</option>
                    </select>

                    <input id="library-modal-filter-director" class="input-field" placeholder="Director (contains)" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;" />

                    <select id="library-modal-filter-mpa" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">MPA (All)</option>
                    </select>

                    <select id="library-modal-filter-genre" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Genre (All)</option>
                    </select>
                </div>
            </div>

            <div class="auth-modal-actions" style="margin-top: 0.85rem; display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                <button type="button" class="btn btn-outline" data-library-action="reset_sort_filter_draft" style="border-radius: 0.85rem;">Reset</button>
                <button type="button" class="btn btn-outline" data-library-action="cancel_sort_filter" style="border-radius: 0.85rem;">Cancel</button>
                <button type="button" class="btn btn-primary" data-library-action="save_sort_filter" style="border-radius: 0.85rem;">Save</button>
            </div>
        </div>
    </div>

    <div id="account-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeAccountAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="account-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="account-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeAccountAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to manage your account
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeAccountAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="update-watch-overlay" class="auth-overlay" onclick="if(event.target === this) closeUpdateWatchModal(null);" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="update-watch-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="update-watch-title">Update Ratings</div>
                <button class="auth-modal-close" type="button" onclick="closeUpdateWatchModal(null)">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem;">
                Youre updating an existing rating. Do you also want to add <span class="text-white font-semibold">+1 watch</span>?
            </div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem;">
                <button type="button" id="btn-update-only" class="btn btn-outline" style="flex:1;" onclick="closeUpdateWatchModal('update_only')">Only Update Rating</button>
                <button type="button" id="btn-update-and-watch" class="btn btn-primary" style="flex:1;" onclick="closeUpdateWatchModal('update_and_watch')">Update and +1 to Watch Logs</button>
            </div>
        </div>
    </div>

    <div id="delete-rating-overlay" class="auth-overlay" onclick="if(event.target === this) closeDeleteRatingModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="delete-rating-title" style="max-width: 720px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="delete-rating-title">Delete</div>
                <button class="auth-modal-close" type="button" onclick="closeDeleteRatingModal()">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.35rem;">
                Movie: <span id="delete-rating-movie" class="text-white font-semibold">(loading)</span>
            </div>

            <div class="glass-panel" style="margin-top: 0.85rem; padding: 0.95rem; border-radius: 0.95rem; background: rgba(0,0,0,0.10); border: 1px solid rgba(239,68,68,0.25);">
                <div class="text-white font-bold">Option A  Delete rating + all watch logs</div>
                <div class="text-sm" style="color: var(--text-muted); margin-top: 0.4rem;">
                    This permanently deletes your <span class="text-white font-semibold">Movie Ratings</span> row and all related <span class="text-white font-semibold">Watch Logs</span> for this movie.
                </div>
                <div style="margin-top: 0.75rem; display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" style="border-radius: 0.85rem; border-color: rgba(239,68,68,0.55); color: rgba(239,68,68,0.95); background: rgba(239,68,68,0.10);" onclick="confirmDeleteRatingAndAllLogs()">Delete rating + all watch logs</button>
                </div>
                <div id="delete-rating-status" class="text-xs" style="color: rgba(255,255,255,0.60); margin-top: 0.45rem;"></div>
            </div>

            <div class="glass-panel" style="margin-top: 0.85rem; padding: 0.95rem; border-radius: 0.95rem; background: rgba(0,0,0,0.10);">
                <div class="flex justify-between items-center" style="gap: 10px; flex-wrap: wrap;">
                    <div class="text-white font-bold">Option B  Delete selected watch logs</div>
                    <div id="delete-logs-count" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
                </div>
                <div class="text-sm" style="color: var(--text-muted); margin-top: 0.4rem;">
                    Select watch logs to delete. You must keep <span class="text-white font-semibold">at least 1</span> watch log.
                </div>

                <div id="delete-logs-list" style="margin-top: 0.75rem; display:flex; flex-direction: column; gap: 0.5rem; max-height: 280px; overflow: auto; padding-right: 4px;">
                    <div class="text-sm" style="color: rgba(255,255,255,0.65);">Loading watch logs</div>
                </div>

                <div class="auth-modal-actions" style="margin-top: 0.85rem; display:flex; gap: 10px; flex-wrap: wrap; justify-content: space-between;">
                    <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="clearDeleteLogsSelection()">Clear</button>
                        <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="toggleSelectAllDeleteLogs()">Select all</button>
                    </div>
                    <button type="button" id="btn-delete-selected-logs" class="btn btn-primary" style="border-radius: 0.85rem; background: rgba(239,68,68,0.90); border-color: rgba(239,68,68,0.90);" onclick="confirmDeleteSelectedWatchLogs()" disabled aria-disabled="true" title="Select at least one watch log.">Delete selected</button>
                </div>
                <div id="delete-logs-status" class="text-xs" style="color: rgba(255,255,255,0.60); margin-top: 0.45rem;"></div>
            </div>
        </div>
    </div>

    <div id="duplicate-rating-overlay" class="auth-overlay" onclick="if(event.target === this) closeDuplicateRatingModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="duplicate-rating-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="duplicate-rating-title">Already Rated</div>
                <button class="auth-modal-close" type="button" onclick="closeDuplicateRatingModal()">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem;">
                You have already rated <span id="duplicate-rating-movie" class="text-white font-semibold">this movie</span>. Would you like to update your ratings?
            </div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem;">
                <button type="button" class="btn btn-primary" style="flex:1;" onclick="proceedDuplicateUpdateRatings()">Update Ratings</button>
                <button type="button" class="btn btn-outline" style="flex:1;" onclick="proceedDuplicateReturnHome()">Return Home</button>
            </div>
        </div>
    </div>

    <div id="watch-method-overlay" class="auth-overlay" onclick="if(event.target === this) closeWatchMethodModal(null);" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="watch-method-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="watch-method-title">Watch Method</div>
                <button class="auth-modal-close" type="button" onclick="closeWatchMethodModal(null)">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem;">
                How did you watch it?
            </div>

            <div style="margin-top: 0.85rem;">
                <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Date Watched</label>
                <input id="watch-method-date" type="date" class="input-field" onclick="openDatePickerFromInput(this)" onfocus="openDatePickerFromInput(this)" required>
                <div class="text-xs text-gray" style="margin-top: 0.35rem;">This date will be saved to your Watch Logs.</div>
            </div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem; flex-wrap: wrap;">
                <button
                    type="button"
                    class="btn watch-method-option"
                    style="flex:1; background-color: rgba(168, 85, 247, 0.35); border: 1px solid rgba(168, 85, 247, 0.5); color: white;"
                    data-watch-method-option="true"
                    onclick="selectWatchMethodModal('At Home')"
                >At Home</button>
                <button
                    type="button"
                    class="btn watch-method-option"
                    style="flex:1; background-color: rgba(20, 184, 166, 0.35); border: 1px solid rgba(20, 184, 166, 0.5); color: white;"
                    data-watch-method-option="true"
                    onclick="selectWatchMethodModal('In Theater')"
                >In Theater</button>
                <button type="button" id="watch-method-save" class="btn btn-primary" style="width: 100%;" onclick="submitWatchMethodModal()" disabled aria-disabled="true" title="Select a watch method first.">
                    <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Save
                </button>
            </div>
        </div>
    </div>

    <div id="prior-watches-overlay" class="auth-overlay" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="prior-watches-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="prior-watches-title">Add Previous Watches</div>
            </div>

            <div class="text-sm" id="prior-watches-message" style="color: var(--text-muted); margin-top: 0.5rem;"></div>

            <div id="prior-watches-fields" style="margin-top: 0.85rem; display:flex; flex-direction: column; gap: 0.75rem;"></div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem; flex-wrap: wrap;">
                <button type="button" class="btn btn-primary" style="flex:1;" onclick="submitPriorWatchesModal()">Save Previous Watches</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="auth-overlay" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="loading-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="loading-title">Loading</div>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem; display:flex; align-items:center; gap: 0.5rem;">
                <span class="icon-sm"><svg viewBox="0 0 24 24" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></span>
                <span>Hang tight  fetching your existing entry</span>
            </div>
        </div>
    </div>
    <footer>
        <div class="container flex flex-col md-row justify-between items-center">
            <div class="mb-4">
                <span class="text-gray text-sm"> 2024 CinemaTracker. Designed for film lovers.</span>
            </div>
            <div class="flex gap-4" id="footer-icons">
            </div>
        </div>
    </footer>

    <script>
        const SUPABASE_URL = 'https://dbxhaseoxpnmzdxbzdpj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_UcpiMVqtkCgky9HN8nu85Q_iFXsVY_r';
        const supabaseClient = window.supabase?.createClient
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
            : null;

        // Column name for the date-only watch date field in both "Movie Ratings" and "Watch Logs".
        // If you rename the column to a different identifier (e.g. "Watch_Date"), update this value.
        const COL_WATCH_DATE = 'watch_date';
        const icons = {
            film: `<svg viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg>`,
            menu: `<svg viewBox="0 0 24 24"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>`,
            checkCircle: `<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            twitter: `<svg viewBox="0 0 24 24"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 14-4.5-4.5 1.6-11.7 8-12 1.1-2 3.5-3.5 6-3.5 0 0 .7 3.4 2.7 4.5"/></svg>`,
            github: `<svg viewBox="0 0 24 24"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>`,
            instagram: `<svg viewBox="0 0 24 24"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/></svg>`,
            search: `<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            plusCircle: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`,
            refreshCw: `<svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>`,
            arrowRight: `<svg viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            arrowRightCircle: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="m12 16 4-4-4-4"/></svg>`,
            clock: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
            barChart2: `<svg viewBox="0 0 24 24"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>`,
            star: `<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
            arrowLeft: `<svg viewBox="0 0 24 24"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>`,
            database: `<svg viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>`,
            info: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`,
            edit3: `<svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>`,
            quote: `<svg viewBox="0 0 24 24"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></svg>`,
            save: `<svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            calendar: `<svg viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            trendingUp: `<svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>`,
            trendingDown: `<svg viewBox="0 0 24 24"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>`,
            percent: `<svg viewBox="0 0 24 24"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="7" cy="7" r="2"/><circle cx="17" cy="17" r="2"/></svg>`,
            activity: `<svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
            pieChart: `<svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>`,
            video: `<svg viewBox="0 0 24 24"><rect x="3" y="7" width="14" height="10" rx="2" ry="2"/><path d="m17 10 4-2v8l-4-2z"/></svg>`,
            tv: `<svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="12" rx="2" ry="2"/><path d="M7 21h10"/><path d="M12 7 8 3"/><path d="M12 7l4-4"/></svg>`,
            user: `<svg viewBox="0 0 24 24"><path d="M20 21a8 8 0 0 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>`,
            loader: `<svg viewBox="0 0 24 24" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`
        };
        document.getElementById('nav-logo-icon').innerHTML = icons.film;
        document.getElementById('menu-icon-btn').innerHTML = icons.menu;
        document.getElementById('toast-icon').innerHTML = icons.checkCircle;
        document.getElementById('footer-icons').innerHTML = `
            <a href="#">${icons.twitter}</a>
            <a href="#">${icons.github}</a>
            <a href="#">${icons.instagram}</a>
        `;
        const router = {
            currentPage: 'home',
            selectedMovie: null,
            pendingTitle: '',
            formMode: 'new',
            
            init() {
                this.navigate('home');
            },

            navigate(page, mode = 'new') {
                // If the user is not logged in, block the Data Dash and prompt them to log in.
                if ((page === 'dashboard' || page === 'dashboard_kpi') && !cachedIsAuthed) {
                    openDashboardAuthWarning();
                    return;
                }

                // If the user is not logged in, block the Feed page and prompt them to log in.
                if (page === 'feed' && !cachedIsAuthed) {
                    openFeedAuthWarning();
                    return;
                }

                // If the user is not logged in, block the Library page and prompt them to log in.
                if (page === 'library' && !cachedIsAuthed) {
                    openLibraryAuthWarning();
                    return;
                }

                // If the user is not logged in, block the Lists page and prompt them to log in.
                if (page === 'lists' && !cachedIsAuthed) {
                    openListsAuthWarning();
                    return;
                }

                // If the user is not logged in, block the Account page and prompt them to log in.
                if (page === 'account' && !cachedIsAuthed) {
                    openAccountAuthWarning();
                    return;
                }

                // Disallow opening the submit form without selecting a movie from the dropdown.
                if (page === 'submit' && String(mode || 'new') === 'new') {
                    const hasPicked = Boolean(this.selectedMovie);
                    const hasDetails = Boolean(this.selectedMovie?.detailsReadonly);
                    if (!hasPicked || !hasDetails) {
                        showToast('Please search and select a movie from the dropdown first.', { level: 'warn' });
                        page = 'home';
                        mode = 'new';
                    }
                }

                this.currentPage = page;
                this.formMode = mode;
                const root = document.getElementById('app-root');
                
                // Active Nav
                document.querySelectorAll('.nav-link').forEach(el => {
                    let label = '';
                    if (page === 'home') label = 'home';
                    else if (page === 'submit') label = 'log';
                    else if (page === 'library') label = 'movies';
                    else if (page === 'lists') label = 'lists';
                    else if (page === 'feed') label = 'feed';
                    else if (page === 'account') label = 'account';
                    else if (page === 'dashboard' || page === 'dashboard_kpi') label = 'data';
                    if (label && el.innerText.toLowerCase().includes(label)) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                });

                document.getElementById('mobile-menu').classList.remove('open');

                if (page === 'home') {
                    root.innerHTML = this.renderHome();
                    this.selectedMovie = null;
                    this.pendingTitle = '';
                    resetHomeSearchAndFilters();
                    loadTrendingNow();
                } else if (page === 'feed') {
                    root.innerHTML = this.renderFeed();
                    refreshAuthStateAndUI();
                    initFeedPage();
                    loadFeedPage();
                } else if (page === 'library') {
                    root.innerHTML = this.renderLibrary();
                    refreshAuthStateAndUI();
                    initLibraryPage();
                    loadLibraryPage({ reset: true });
                } else if (page === 'lists') {
                    root.innerHTML = this.renderLists();
                    refreshAuthStateAndUI();
                    initListsPage();
                    loadListsPage({ reset: true });
                } else if (page === 'account') {
                    root.innerHTML = this.renderAccount();
                    refreshAuthStateAndUI();
                    initAccountPage();
                    loadAccountPage();
                } else if (page === 'submit') {
                    root.innerHTML = this.renderSubmit();
                    initializeWatchMethodToggle();
                    refreshAuthStateAndUI();
                } else if (page === 'dashboard') {
                    root.innerHTML = this.renderDashboard();
                    refreshAuthStateAndUI();
                    initDashboardTabs();
                    initDashboardTimeframe();
                    initDashboardFavoritesMetric();
                    initDashboardGeneralKpiClicks();
                    initDashboardPosterUpdateRatingsClicks();
                    setDashboardTimeframe(dashboardTimeframe || 'all_time');
                    syncDashboardFavoritesMetricUI();
                } else if (page === 'dashboard_kpi') {
                    root.innerHTML = this.renderDashboardKpiDetail();
                    refreshAuthStateAndUI();
                    initDashboardPosterUpdateRatingsClicks();
                    loadDashboardKpiDetail();
                }
                
                window.scrollTo(0, 0);
            },

            async selectMovie(movie) {
                this.selectedMovie = movie;
                this.pendingTitle = movie?.title || '';
                const input = document.getElementById('movie-search-input');
                const results = document.getElementById('search-results');
                const updateBtn = document.getElementById('update-existing-btn');
                const updateOpts = document.getElementById('update-options');
                const logNewBtn = document.getElementById('btn-log-new-entry');

                if (input) input.value = movie.title;
                if (results) results.classList.add('hidden');

                // Prevent UI flash: hide both buttons immediately.
                if (logNewBtn) logNewBtn.style.display = 'none';
                if (updateBtn) updateBtn.style.display = 'none';
                if (updateOpts) {
                    updateOpts.classList.add('hidden');
                    updateOpts.classList.remove('grid');
                }

                // Show the action area and hide the placeholder text.
                setHomeActionsVisible(true);

                // Default behavior when we can't confirm diary status: allow Log as New Entry.
                const showLogNewOnly = () => {
                    if (logNewBtn) logNewBtn.style.display = '';
                    if (updateBtn) updateBtn.style.display = 'none';
                    if (updateOpts) {
                        updateOpts.classList.add('hidden');
                        updateOpts.classList.remove('grid');
                    }
                };

                const showUpdateOnly = () => {
                    if (logNewBtn) logNewBtn.style.display = 'none';
                    if (updateBtn) {
                        updateBtn.style.display = '';
                        updateBtn.disabled = false;
                        updateBtn.style.opacity = '1';
                        updateBtn.style.pointerEvents = 'auto';
                    }
                };

                try {
                    if (!supabaseClient) {
                        showLogNewOnly();
                        return;
                    }

                    const { data } = await supabaseClient.auth.getSession();
                    const authedUser = data?.session?.user;
                    if (!authedUser?.id) {
                        showLogNewOnly();
                        return;
                    }

                    const movie_id = await resolveDbMovieIdFromSelectedMovie(movie);
                    if (!movie_id) {
                        // If it isn't in Movies yet, it can't be in Movie Ratings.
                        showLogNewOnly();
                        return;
                    }

                    const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id });
                    if (alreadyRated) showUpdateOnly();
                    else showLogNewOnly();
                } catch (_) {
                    // Safe fallback: allow Log as New Entry.
                    showLogNewOnly();
                }
            },

            async startNewEntry() {
                const btn = document.getElementById('btn-log-new-entry');
                const originalHTML = btn ? btn.innerHTML : null;

                try {
                    // Users must pick a movie from the dropdown first.
                    if (!this.selectedMovie) {
                        showToast('Please select a movie from the search dropdown first.', { level: 'warn' });
                        return;
                    }

                    // If the user is logged in and already has a rating for this movie, prevent duplicates.
                    try {
                        if (supabaseClient) {
                            const { data } = await supabaseClient.auth.getSession();
                            const authedUser = data?.session?.user;
                            if (authedUser?.id) {
                                const movie_id = await resolveDbMovieIdFromSelectedMovie(this.selectedMovie);
                                if (movie_id) {
                                    const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id });
                                    if (alreadyRated) {
                                        showToast('This movie is already in your diary. Use Update Existing instead.', { level: 'warn' });
                                        return;
                                    }
                                }
                            }
                        }
                    } catch (_) {}

                    // If we already have full details, just navigate.
                    if (this.selectedMovie?.detailsReadonly) {
                        this.navigate('submit', 'new');
                        return;
                    }

                    const tmdb_id = Number(this.selectedMovie?.tmdb_id ?? this.selectedMovie?.id);
                    if (!Number.isFinite(tmdb_id) || tmdb_id <= 0) {
                        showToast('Please select a movie from the search dropdown first.', { level: 'warn' });
                        return;
                    }

                    if (btn) {
                        btn.innerHTML = `${icons.loader} Loading`;
                        btn.disabled = true;
                        btn.style.opacity = 0.85;
                    }

                    const details = await callSwiftApiGetMovieDetails({ tmdb_id });

                    // Shape the prefill object to match the submit page expectations.
                    const genres = Array.isArray(details?.genres)
                        ? details.genres.map(s => String(s).trim()).filter(Boolean)
                        : [];

                    const joinedGenres = genres.length
                        ? genres.join(', ')
                        : String(details?.genre || this.selectedMovie?.genre || '').trim();

                    this.selectedMovie = {
                        ...this.selectedMovie,
                        tmdb_id: Number(details?.tmdb_id ?? tmdb_id),
                        title: String(details?.title || this.selectedMovie?.title || '').trim(),
                        year: details?.year ?? this.selectedMovie?.year ?? null,
                        mpa: String(details?.mpa || '').trim(),
                        runtime: details?.runtime ?? null,
                        isSeries: Boolean(details?.isSeries),
                        director: String(details?.director || '').trim(),
                        imdb: (details?.imdb_rating_pct === null || details?.imdb_rating_pct === undefined)
                            ? ''
                            : String(details.imdb_rating_pct),
                        genres,
                        genre: joinedGenres,
                        poster_path: details?.poster_path ?? this.selectedMovie?.poster_path ?? null,
                        detailsReadonly: true,
                    };

                    this.navigate('submit', 'new');
                } catch (err) {
                    showToast(`Failed to load movie details: ${String(err?.message || err)}`, { level: 'warn' });
                    // Do not allow manual entry.
                    return;
                } finally {
                    if (btn && originalHTML !== null) {
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                        btn.style.opacity = 1;
                    }
                }
            },

            async quickIncrement() {
                const m = this.selectedMovie;
                if (!m) return;

                try {
                    if (!supabaseClient) {
                        throw new Error('Supabase SDK failed to load.');
                    }
                    const { user: authedUser } = await requireAuthOrThrow();

                    // Resolve the DB UUID from the selected movie (prefer UUID, else map tmdb_id -> Movies.id).
                    const movie_id = await resolveDbMovieIdFromSelectedMovie(m);
                    if (!movie_id) {
                        showToast('Quick Watch is only available for movies already in your diary. Use Log as New Entry first.');
                        return;
                    }

                    // Only allow Quick Watch for movies already logged (rated) by this user.
                    const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id });
                    if (!alreadyRated) {
                        showToast('Quick Watch is only for movies you\'ve already logged. Use Log as New Entry first.');
                        return;
                    }

                    const watchChoice = await promptWatchMethodChoice();
                    if (!watchChoice) {
                        showToast('Quick Watch canceled.', { level: 'warn' });
                        return;
                    }

                    await insertWatchLog({
                        user_id: authedUser.id,
                        movie_id,
                        watch_method: watchChoice.watch_method,
                        watch_date: watchChoice.watch_date,
                    });
                    showToast(`Added another watch for ${m.title}!`);

                    // Reset
                    const input = document.getElementById('movie-search-input');
                    if (input) input.value = '';
                    const results = document.getElementById('search-results');
                    if (results) {
                        results.classList.add('hidden');
                        results.innerHTML = '';
                    }
                    this.selectedMovie = null;
                    setHomeActionsVisible(false);
                    setUpdateOptionsHidden();
                    const updateBtn = document.getElementById('update-existing-btn');
                    if (updateBtn) updateBtn.style.display = '';
                } catch (err) {
                    showToast(`Quick Watch failed: ${String(err.message || err)}`);
                }
            },

            async startUpdateRatings() {
                const m = this.selectedMovie;
                if (!m) return;

                try {
                    showLoadingOverlay('Hang tight  fetching your existing entry');
                    if (!supabaseClient) throw new Error('Supabase SDK failed to load.');
                    const { user: authedUser } = await requireAuthOrThrow();

                    // Resolve DB movie UUID using tmdb_id -> Movies.id mapping (read-only).
                    const movie_id = await resolveDbMovieIdFromSelectedMovie(m);
                    if (!movie_id) {
                        showToast('No matching movie found in your database for this selection. Use Log as New Entry first.');
                        return;
                    }

                    const existing = await getExistingMovieRatingRow({ user_id: authedUser.id, movie_id });
                    if (!existing) {
                        showToast('No existing rating found for this movie. Use Log as New Entry instead.');
                        return;
                    }

                    // Pull movie details from the DB so the update form is fully populated.
                    let movieRow = null;
                    try {
                        movieRow = await getDbMovieRowById(movie_id);
                    } catch (_) {
                        movieRow = null;
                    }

                    const latestWatch = await getLatestWatchLog({ user_id: authedUser.id, movie_id });
                    const earliestWatch = await getEarliestWatchLog({ user_id: authedUser.id, movie_id });
                    let watchCount = null;
                    try {
                        watchCount = await getWatchLogCount({ user_id: authedUser.id, movie_id });
                    } catch (_) {
                        watchCount = null;
                    }
                    const watchedTimes = (() => {
                        const n = Number(watchCount);
                        if (Number.isFinite(n) && n > 0) return n;
                        // Back-compat: older data may be missing Watch Logs rows.
                        return 1;
                    })();
                    const defaultDate = getLocalISODate();
                    const date = existing?.[COL_WATCH_DATE]
                        ? String(existing[COL_WATCH_DATE])
                        : (latestWatch?.[COL_WATCH_DATE] ? String(latestWatch[COL_WATCH_DATE]) : defaultDate);

                    const review = {
                        date,
                        tier: existing?.tier ?? '',
                        scores: {
                            overall: Number(existing?.overall_rating ?? 50),
                            sound: Number(existing?.sound_rating ?? 50),
                            pace: Number(existing?.pacing_rating ?? 50),
                            imagery: Number(existing?.imagery_rating ?? 50),
                            acting: Number(existing?.acting_rating ?? 50),
                            plot: Number(existing?.plot_rating ?? 50),
                            dialogue: Number(existing?.dialogue_rating ?? 50),
                        },
                        quote: (() => {
                            const fromDb = String(existing?.fav_quote ?? '').trim();
                            if (fromDb) return fromDb;
                            const fromSelection = String(m?.prefill_quote ?? m?.prefillQuote ?? m?.quote ?? '').trim();
                            return fromSelection;
                        })(),
                        notes: String(existing?.notes ?? ''),
                        watched: watchedTimes,
                        // When updating, show the original (oldest) watch method as the locked form value.
                        watch_method: String(earliestWatch?.watch_method || latestWatch?.watch_method || 'At Home')
                    };

                    const coalesceYear = (row) => {
                        const y = row?.release_year ?? row?.year;
                        const n = Number(y);
                        return Number.isFinite(n) && n > 0 ? n : (m?.year ?? '');
                    };

                    const coalesceRuntime = (row) => {
                        const v = row?.runtime_minutes ?? row?.runtime;
                        const n = Number(v);
                        return Number.isFinite(n) ? n : (m?.runtime ?? '');
                    };

                    const coalesceGenre = (row) => {
                        if (!row) return m?.genre || '';
                        if (typeof row?.genre === 'string') return row.genre;
                        if (Array.isArray(row?.genres)) return row.genres.map(s => String(s).trim()).filter(Boolean).join(', ');
                        if (typeof row?.genres === 'string') return row.genres;
                        return m?.genre || '';
                    };

                    const isGenrePlaceholder = (raw) => {
                        const s = String(raw ?? '').trim();
                        if (!s) return true;
                        const lower = s.toLowerCase();
                        return lower === 'movie' || lower === '0';
                    };

                    // Director/genre can be missing or placeholder in the Movies table.
                    // Prefer DB values, but fall back to TMDb details so the update form matches the Search-bar flow.
                    let resolvedDirector = String(
                        movieRow?.director ??
                        movieRow?.director_name ??
                        movieRow?.directorName ??
                        m?.director ??
                        ''
                    ).trim();

                    let resolvedGenre = String(coalesceGenre(movieRow) ?? '').trim();

                    let resolvedPosterPath = String(
                        movieRow?.poster_path ??
                        m?.poster_path ??
                        m?.posterPath ??
                        m?.poster_url ??
                        m?.posterUrl ??
                        ''
                    ).trim();

                    const tmdb_id = Number(movieRow?.tmdb_id ?? m?.tmdb_id ?? getTmdbIdFromSelectedMovie(m) ?? null);
                    const needsTmdbDetails = (
                        (!resolvedDirector) ||
                        isGenrePlaceholder(resolvedGenre) ||
                        (!resolvedPosterPath)
                    ) && (Number.isFinite(tmdb_id) && tmdb_id > 0);

                    if (needsTmdbDetails) {
                        try {
                            const details = await callSwiftApiGetMovieDetails({ tmdb_id });

                            if (!resolvedDirector) {
                                resolvedDirector = String(details?.director || '').trim();
                            }

                            if (isGenrePlaceholder(resolvedGenre)) {
                                const genres = Array.isArray(details?.genres)
                                    ? details.genres.map(s => String(s).trim()).filter(Boolean)
                                    : [];
                                const joined = genres.length
                                    ? genres.join(', ')
                                    : String(details?.genre || '').trim();
                                if (joined) resolvedGenre = joined;
                            }

                            if (!resolvedPosterPath) {
                                const p = String(details?.poster_path ?? '').trim();
                                if (p) resolvedPosterPath = p;
                            }

                            const imdbPct = details?.imdb_rating_pct;
                            if (imdbPct !== null && imdbPct !== undefined) {
                                m.imdb = String(imdbPct);
                            }
                        } catch (_) {}
                    }

                    this.selectedMovie = {
                        ...m,
                        id: movie_id,
                        tmdb_id: Number(movieRow?.tmdb_id ?? m?.tmdb_id ?? getTmdbIdFromSelectedMovie(m) ?? null) || undefined,
                        title: String(movieRow?.title ?? m?.title ?? '').trim(),
                        year: coalesceYear(movieRow),
                        director: resolvedDirector,
                        mpa: String(movieRow?.mpa_rating ?? movieRow?.mpa ?? m?.mpa ?? '').trim(),
                        runtime: coalesceRuntime(movieRow),
                        isSeries: (movieRow?.is_series ?? movieRow?.isSeries ?? m?.isSeries) === true,
                        genre: resolvedGenre,
                        poster_path: resolvedPosterPath,
                        detailsReadonly: true,
                        mockUserReview: review
                    };

                    // Close the home dropdown UI if it's open.
                    try {
                        document.getElementById('update-options')?.classList?.add('hidden');
                        document.getElementById('update-options')?.classList?.remove('grid');
                    } catch (_) {}

                    this.navigate('submit', 'update');
                } catch (err) {
                    showToast(`Update Ratings failed: ${String(err?.message || err)}`);
                } finally {
                    hideLoadingOverlay();
                }
            },

            toggleUpdateOptions() {
                const opts = document.getElementById('update-options');
                const updateBtn = document.getElementById('update-existing-btn');
                if (!opts) return;

                if (opts.classList.contains('hidden')) {
                    opts.classList.remove('hidden');
                    opts.classList.add('grid');
                    // Once expanded, hide the "Update Existing" button so only the two options remain.
                    if (updateBtn) updateBtn.style.display = 'none';
                    return;
                }

                // If we ever collapse programmatically, restore the button.
                opts.classList.add('hidden');
                opts.classList.remove('grid');
                if (updateBtn) updateBtn.style.display = '';
            },

            renderHome() {
                return `
                    <div class="fade-in">
                        <!-- Hero (Full Width) -->
                        <div class="relative w-full" style="height: 62vh; margin-bottom: 1.5rem;">
                            <!-- Backgrounds -->
                            <div class="absolute" style="inset:0; background-image: url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=2525&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.4;"></div>
                            <div class="absolute" style="inset:0; background: linear-gradient(to top, var(--bg-dark) 10%, transparent 90%); z-index: -1;"></div>
                            
                            <!-- Content (Containerized) -->
                            <div class="container" style="height: 100%; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 2.25rem;">
                                <span class="text-xs font-semibold text-brand uppercase" style="background: var(--brand-light); padding: 0.25rem 0.75rem; border-radius: 99px; border: 1px solid rgba(20,184,166,0.2); width: fit-content; margin-bottom: 1rem;">Start Logging</span>
                                <h1 class="text-5xl font-bold text-white mb-6" style="line-height: 1.1;">Cinematic <br/> <span style="background: linear-gradient(to right, var(--brand), #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Masterpieces</span></h1>
                                
                                <div style="max-width: 600px; position: relative;">
                                    <p class="text-xl text-gray mb-4">Search for a movie to add it to your diary.</p>
                                    
                                    <!-- Search -->
                                    <div style="position: relative;">
                                        <div class="input-group mb-4">
                                            <div class="input-icon">${icons.search}</div>
                                            <input type="text" id="movie-search-input" oninput="handleSearch(this.value)" autocomplete="off" placeholder="Type a movie title..." class="input-field glass-input" style="border-radius: 0.85rem;">
                                            <div id="search-results" class="search-dropdown hidden"></div>
                                        </div>
                                        <button type="button" id="movie-search-filters-toggle" class="btn btn-glass" onclick="toggleSearchFiltersPanel()" style="position:absolute; right: 0; top: -36px; height: 30px; padding: 0 0.75rem; border-radius: 0.85rem; font-size: 0.75rem; font-weight: 800; letter-spacing: 0.02em;">Use Filters</button>
                                    </div>

                                    <!-- Optional Filters -->
                                    <div id="movie-search-filters" class="hidden" style="margin-top: -0.25rem; margin-bottom: 1rem; width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 0.75rem; align-items: stretch;">
                                        <input
                                            type="text"
                                            id="movie-search-year"
                                            inputmode="numeric"
                                            placeholder="Year"
                                            class="input-field glass-input"
                                            style="width: 100%; padding-left: 0.9rem; height: 46px; border-radius: 0.85rem;"
                                            oninput="markSearchFiltersDirty()"
                                        />
                                        <select
                                            id="movie-search-mpa"
                                            class="select-field"
                                            style="width: 100%; height: 46px; border-radius: 0.85rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); color: white; padding: 0 0.75rem;"
                                            onchange="markSearchFiltersDirty()"
                                        >
                                            <option value="">MPA</option>
                                            <option value="G">G</option>
                                            <option value="PG">PG</option>
                                            <option value="PG-13">PG-13</option>
                                            <option value="R">R</option>
                                            <option value="NC-17">NC-17</option>
                                            <option value="NR">NR / Unrated</option>
                                        </select>
                                        <button type="button" class="btn btn-glass" style="width: 100%; height:46px; padding: 0 1rem; border-radius: 0.85rem;" onclick="applySearchFilters()">Apply Filters</button>
                                        <button type="button" class="btn btn-glass" style="width: 100%; height:46px; padding: 0 1rem; border-radius: 0.85rem;" onclick="clearSearchFilters()">Clear</button>
                                    </div>

                                    <!-- Action Slot (fixed space so the search UI doesn't jump) -->
                                    <div id="home-action-slot" style="margin-top: 2rem; min-height: 120px;">
                                        <div id="home-action-card" class="glass-panel" style="padding: 1rem; border-radius: 0.75rem;">
                                            <div id="home-action-placeholder" class="text-sm text-gray" style="text-align:center; max-width: 520px; margin: 0 auto;">
                                                Select a movie from the dropdown to log it or update an existing entry.
                                            </div>

                                            <!-- Dynamic Actions (replaces placeholder in the same spot) -->
                                            <div id="movie-actions" class="hidden flex-col gap-4 fade-in">
                                                <div class="flex gap-3">
                                                    <button id="btn-log-new-entry" onclick="router.startNewEntry()" class="btn btn-primary" style="flex:1;">
                                                        ${icons.plusCircle} Log as New Entry
                                                    </button>
                                                    <button id="update-existing-btn" onclick="router.toggleUpdateOptions()" class="btn btn-outline" style="flex:1; border-color: rgba(168, 85, 247, 0.55); background: rgba(168, 85, 247, 0.10);">
                                                        <span style="color:#a855f7; width:20px;">${icons.refreshCw}</span> Update Existing
                                                    </button>
                                                </div>

                                                <div class="flex gap-3">
                                                    <button id="btn-add-to-list" type="button" onclick="openAddToListModal()" class="btn btn-glass" style="flex:1; border-radius: 0.85rem;">
                                                        ${icons.plusCircle} Add to List
                                                    </button>
                                                    <button type="button" onclick="router.navigate('lists')" class="btn btn-outline" style="flex:1; border-radius: 0.85rem;">
                                                        ${icons.arrowRight} View Lists
                                                    </button>
                                                </div>

                                                <div id="update-options" class="hidden grid-2 gap-3" style="padding: 1rem; border-radius: 0.75rem; border-style: dashed; border: 1px solid rgba(255,255,255,0.10);">
                                                    <button onclick="router.startUpdateRatings()" class="text-left" style="padding:0.75rem; border-radius:0.5rem; transition: background 0.2s; border: 1px solid rgba(168, 85, 247, 0.45); background: rgba(168, 85, 247, 0.10);">
                                                        <span class="text-brand font-semibold mb-2" style="display:block;">Update Ratings &rarr;</span>
                                                        <span class="text-xs text-gray">Edit your review, scores, and tier.</span>
                                                    </button>
                                                    <button onclick="router.quickIncrement()" class="text-left" style="padding:0.75rem; border-radius:0.5rem; transition: background 0.2s; border: 1px solid rgba(20, 184, 166, 0.45); background: rgba(20, 184, 166, 0.10);">
                                                        <span class="text-brand font-semibold mb-2" style="display:block;">Quick Watch (+1) &rarr;</span>
                                                        <span class="text-xs text-gray">Simply add a view to your count.</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Marquee (Full Width) -->
                        <div style="background: var(--surface); padding: 3rem 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
                            <div class="container mb-6">
                                <h2 class="text-xl font-semibold text-white">Trending Now</h2>
                            </div>
                            <div class="w-full" style="overflow: hidden; position: relative;">
                                <div class="animate-marquee">
                                    <div class="flex" id="trending-track-1"></div>
                                    <div class="flex" id="trending-track-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderLists() {
                return `
                    <div class="fade-in">
                        <!-- Background -->
                        <div style="position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?q=80&w=2070&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.15; pointer-events: none;"></div>
                        <div style="position: fixed; inset: 0; background: linear-gradient(to bottom, rgba(20,184,166, 0.10), transparent 22%, var(--bg-dark) 90%); z-index: -1; pointer-events: none;"></div>

                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div>
                                    <h1 class="text-3xl font-bold text-white">Lists</h1>
                                </div>
                                <div class="flex" style="gap: 10px; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-primary" onclick="openListsCreateModal()" style="border-radius: 0.85rem;">New List</button>
                                    <button type="button" class="btn btn-outline" data-lists-action="refresh" style="border-radius: 0.85rem;">Refresh</button>
                                </div>
                            </div>

                            <div class="grid md-row gap-6" style="align-items: stretch;">
                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem; width: 100%; max-width: 360px;">
                                    <div class="text-white font-bold">Your Lists</div>
                                    <div id="lists-list" class="text-gray" style="margin-top: 0.85rem;">
                                        <select id="lists-select" class="input-field" style="width:100%; border-radius: 0.85rem;">
                                            <option value="">Loading</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem; flex: 1;">
                                    <div class="flex justify-between items-center" style="gap: 10px; flex-wrap: wrap;">
                                        <div>
                                            <div id="lists-active-title" class="text-white font-bold">Select a list</div>
                                            <div id="lists-active-subtitle" class="text-xs text-gray" style="margin-top: 0.25rem;"></div>
                                        </div>

                                        <!-- Lists-only Search (adds directly to the active list) -->
                                        <div style="position: relative; width: 260px; max-width: 100%;">
                                            <div class="input-group" style="margin: 0;">
                                                <div class="input-icon" style="height: 34px; display:flex; align-items:center;">${icons.search}</div>
                                                <input
                                                    type="text"
                                                    id="lists-movie-search-input"
                                                    oninput="handleListsAddMovieSearch(this.value)"
                                                    autocomplete="off"
                                                    placeholder="Select a list to add movies"
                                                    class="input-field glass-input"
                                                    style="border-radius: 0.75rem; height: 34px; font-size: 0.85rem; padding-left: 2.35rem;"
                                                    disabled
                                                >
                                                <div id="lists-movie-search-results" class="search-dropdown hidden"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="lists-items" class="text-gray" style="margin-top: 0.85rem;">Choose a list on the left.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderSubmit() {
                const prefill = this.selectedMovie || {};
                const isUpdate = this.formMode === 'update';
                const uuidLike = isUuidLike;
                const hasDbMovie = uuidLike(prefill?.id);
                const detailsReadonly = hasDbMovie || Boolean(prefill?.detailsReadonly);
                const defaultDate = getLocalISODate();
                const allowEditMissingDetails = detailsReadonly && !hasDbMovie;

                const formAccent = isUpdate
                    ? { rgb: '168, 85, 247', hex: '#a855f7', name: 'Update Ratings' }
                    : { rgb: '20, 184, 166', hex: '#14b8a6', name: 'Log New Entry' };

                const u = (isUpdate && prefill.mockUserReview) ? prefill.mockUserReview : {
                    date: defaultDate, tier: "", scores: { overall: 50, sound: 50, pace: 50, imagery: 50, acting: 50, plot: 50, dialogue: 50 },
                    quote: "", notes: "", watched: 1,
                    watch_method: 'At Home'
                };

                const scoreDefaults = { overall: 50, sound: 50, pace: 50, imagery: 50, acting: 50, plot: 50, dialogue: 50 };
                const scores = { ...scoreDefaults, ...(u?.scores || {}) };
                const scoreOrder = ['overall', 'sound', 'pace', 'imagery', 'acting', 'plot', 'dialogue'];

                const tierLetter = String(u.tier || '').trim().charAt(0).toUpperCase();

                const tierHelpText = (() => {
                    const t = (['S','A','B','C','D','F'].includes(tierLetter)) ? `${tierLetter}-Tier` : String(u.tier || '').trim();
                    if (t === 'S-Tier') return 'The Pantheon. Best of the Best.';
                    if (t === 'A-Tier') return 'Great! Highly recommended films!';
                    if (t === 'B-Tier') return 'Worth a Watch. Solidly good and Entertaining';
                    if (t === 'C-Tier') return "Totally Average. Fine if it's on, but don't go out of your way.";
                    if (t === 'D-Tier') return 'Skip it. Seriously Flawed and not worth the time.';
                    if (t === 'F-Tier') return 'Avoid at all costs! A genuinely bad experience.';
                    return 'Choose exactly one tier';
                })();
                
                const m = {
                    title: prefill.title || '', genre: prefill.genre || '', year: prefill.year || '', mpa: prefill.mpa || '',
                    runtime: (prefill.runtime === null || prefill.runtime === undefined) ? '' : String(prefill.runtime),
                    // For DB movies, we can display Yes/No but still submit TRUE/FALSE.
                    isSeriesDisplay: (prefill.isSeries === true) ? 'Yes' : ((prefill.isSeries === false) ? 'No' : ''),
                    isSeriesValue: (prefill.isSeries === true) ? 'TRUE' : ((prefill.isSeries === false) ? 'FALSE' : ''),
                    director: prefill.director || '', imdb: prefill.imdb || '',
                    poster_path: prefill.poster_path || prefill.posterPath || prefill.poster_url || prefill.posterUrl || ''
                };

                const posterUrl = (() => {
                    const raw = String(m.poster_path || '').trim();
                    if (!raw) return '';
                    if (raw.startsWith('http://') || raw.startsWith('https://')) return raw;
                    // TMDb poster_path comes like "/abc.jpg"
                    return `https://image.tmdb.org/t/p/w342${raw}`;
                })();

                const hasText = (v) => {
                    const s = String(v ?? '').trim();
                    if (!s) return false;
                    if (s === '0') return false;
                    return true;
                };
                const hasPositiveInt = (v) => {
                    const n = Number(String(v ?? '').trim());
                    return Number.isFinite(n) && n > 0;
                };

                // Lock only fields that already have meaningful values.
                // This prevents users getting stuck with blank read-only fields while we enforce required inputs.
                const titleLocked = detailsReadonly && hasText(m.title);
                const yearLocked = detailsReadonly && hasPositiveInt(m.year);
                const mpaLocked = detailsReadonly && hasText(m.mpa);
                const runtimeLocked = detailsReadonly && hasPositiveInt(m.runtime);
                const seriesLocked = detailsReadonly && hasText(m.isSeriesValue);
                const directorLocked = detailsReadonly && hasText(m.director);

                // When updating an existing rating, Times Watched should reflect Watch Logs history,
                // and it should not be editable on the form.
                const timesWatchedLocked = isUpdate;

                // When updating an existing rating, Watch Method should not be editable on the form.
                // New watches are recorded via Watch Logs with a separate watch-method prompt.
                const watchMethodLocked = isUpdate;

                const genreLower = String(m.genre || '').trim().toLowerCase();
                const genrePlaceholder = allowEditMissingDetails && (genreLower === 'movie' || genreLower === '0');
                const genreLocked = detailsReadonly && (hasText(m.genre) && !genrePlaceholder);

                const clampPct = (n) => {
                    const v = Number(n);
                    if (!Number.isFinite(v)) return 0;
                    return Math.max(0, Math.min(100, v));
                };

                const parseExternalPercent = (raw, { imdb = false } = {}) => {
                    const s = String(raw ?? '').trim();
                    if (!s) return 0;
                    const num = parseFloat(s.replace('%', ''));
                    if (!Number.isFinite(num)) return 0;
                    let out = num;
                    // Accept a few common forms:
                    // - 83%  -> 83
                    // - 0.83 -> 83
                    // - IMDb 8.7 (/10) -> 87
                    if (num <= 1) out = num * 100;
                    else if (imdb && num <= 10) out = num * 10;
                    return clampPct(Math.round(out));
                };

                const imdbPct = parseExternalPercent(m.imdb, { imdb: true });
                // Only lock IMDb when we actually have a real (non-zero) value.
                // DB movies can legitimately be missing IMDb; do not lock the user out at 0.
                const imdbLocked = detailsReadonly && (imdbPct > 0);

                const selectedGenres = String(m.genre || '')
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean);

                const genreOptions = [
                    'Action','Adventure','Animation','Comedy','Crime','Documentary','Drama','Family','Fantasy','History',
                    'Horror','Music','Mystery','Romance','Sci-Fi','TV Movie','Thriller','War','Western'
                ];

                return `
                    <div class="fade-in">
                        <!-- Background -->
                        <div style="position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1513106580091-1d82408b8cd8?q=80&w=2076&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.15; pointer-events: none;"></div>
                        <div style="position: fixed; inset: 0; background: linear-gradient(to bottom, rgba(${formAccent.rgb}, 0.14), transparent 22%, var(--bg-dark) 90%); z-index: -1; pointer-events: none;"></div>
                        
                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                        <div class="flex items-center gap-4 mb-8">
                            <button onclick="router.navigate('home')" style="color: var(--text-muted); padding: 0.5rem; border-radius: 50%;">
                                ${icons.arrowLeft}
                            </button>
                            <div>
                                <div class="flex items-center gap-2" style="flex-wrap: wrap;">
                                    <h1 class="text-3xl font-bold text-white">${isUpdate ? 'Update Ratings' : 'Log New Entry'}</h1>
                                    <span style="display:inline-flex; align-items:center; height: 28px; padding: 0 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 900; letter-spacing: 0.06em; text-transform: uppercase; color: rgba(255,255,255,0.95); background: rgba(${formAccent.rgb}, 0.16); border: 1px solid rgba(${formAccent.rgb}, 0.35);">
                                        ${formAccent.name}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <form onsubmit="handleFormSubmit(event)" class="grid grid-3 gap-6" style="border: 1px solid rgba(${formAccent.rgb}, 0.14); border-radius: 1.2rem; padding: 0.75rem; background: rgba(0,0,0,0.12);">
                            <input type="hidden" name="entryType" value="${isUpdate ? 'update' : 'new'}">
                            <input type="hidden" id="fld-movie-id" value="${hasDbMovie ? String(prefill.id) : ''}">
                            <input type="hidden" id="fld-tmdb-id" value="${Number.isFinite(Number(prefill?.tmdb_id)) ? String(Number(prefill.tmdb_id)) : ''}">
                            <!-- Read Only Section -->
                            <div class="glass-panel" style="padding: 1.5rem; border-radius: 1rem; background: rgba(${formAccent.rgb}, 0.10); border: 1px solid rgba(${formAccent.rgb}, 0.22);">
                                <div class="flex items-center gap-3 mb-4">
                                    <span style="color: ${formAccent.hex};">${icons.database}</span>
                                    <h2 class="text-xl font-semibold text-white">Movie Details</h2>
                                </div>
                                <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1.5rem;" class="text-sm flex items-center gap-2">
                                    <span style="width:16px;">${icons.info}</span>
                                    <span style="color: #bfdbfe;">${hasDbMovie ? 'Auto-filled from DB' : (allowEditMissingDetails ? 'Auto-filled from TMDb (edit any missing fields)' : 'Auto-filled from TMDb')}</span>
                                </div>

                                ${posterUrl ? `
                                    <div style="display:flex; justify-content:center; margin-bottom: 1.25rem;">
                                        <img
                                            src="${posterUrl}"
                                            alt="${escapeHtml(m.title || 'Movie poster')}"
                                            style="width: 180px; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 0.9rem; border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 16px 40px rgba(0,0,0,0.35);"
                                            loading="lazy"
                                            onerror="this.onerror=null; this.parentElement.remove();"
                                        >
                                    </div>
                                ` : ''}

                                <div class="flex flex-col gap-4">
                                    <div><label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Title</label><input id="fld-title" name="Title" class="input-field ${titleLocked ? 'input-readonly' : ''}" value="${m.title}" ${titleLocked ? 'readonly' : ''} ${(titleLocked && hasText(m.title)) ? '' : 'required'} placeholder="Type a movie title"></div>
                                    <div class="grid grid-2 gap-4">
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Year</label>
                                            <input
                                                id="fld-year"
                                                name="Year"
                                                type="number"
                                                inputmode="numeric"
                                                step="1"
                                                class="input-field ${yearLocked ? 'input-readonly' : ''}"
                                                value="${m.year}"
                                                ${yearLocked ? 'readonly' : ''}
                                                placeholder="e.g. 2024"
                                            >
                                        </div>
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">MPA</label>
                                            ${mpaLocked ? `
                                                <input id="fld-mpa" name="MPA" class="input-field input-readonly" value="${m.mpa}" readonly>
                                            ` : `
                                                <select id="fld-mpa" name="MPA" class="select-field" required>
                                                    <option value="" disabled ${!String(m.mpa || '').trim() ? 'selected' : ''}>Select...</option>
                                                    <option value="G" ${String(m.mpa).trim() === 'G' ? 'selected' : ''}>G</option>
                                                    <option value="PG" ${String(m.mpa).trim() === 'PG' ? 'selected' : ''}>PG</option>
                                                    <option value="PG-13" ${String(m.mpa).trim() === 'PG-13' ? 'selected' : ''}>PG-13</option>
                                                    <option value="R" ${String(m.mpa).trim() === 'R' ? 'selected' : ''}>R</option>
                                                    <option value="NC-17" ${String(m.mpa).trim() === 'NC-17' ? 'selected' : ''}>NC-17</option>
                                                </select>
                                            `}
                                        </div>
                                    </div>
                                    <div class="grid grid-2 gap-4">
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Runtime (min)</label>
                                            ${runtimeLocked ? `
                                                <input id="fld-runtime" name="Run Time" type="number" inputmode="numeric" step="1" class="input-field input-readonly" value="${m.runtime}" readonly>
                                            ` : `
                                                <input
                                                    id="fld-runtime"
                                                    name="Run Time"
                                                    type="number"
                                                    inputmode="numeric"
                                                    step="1"
                                                    min="0"
                                                    autocomplete="off"
                                                    class="input-field"
                                                    value="${m.runtime}"
                                                    placeholder="Minutes"
                                                >
                                            `}
                                        </div>
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Series?</label>
                                            ${seriesLocked ? `
                                                <input id="fld-series-display" class="input-field input-readonly" value="${m.isSeriesDisplay}" readonly>
                                                <input type="hidden" id="fld-series" name="Series" value="${m.isSeriesValue}">
                                            ` : `
                                                <select id="fld-series" name="Series" class="select-field">
                                                    <option value="" disabled ${!String(m.isSeriesValue || '').trim() ? 'selected' : ''}>Select...</option>
                                                    <option value="TRUE" ${String(m.isSeriesValue).trim() === 'TRUE' ? 'selected' : ''}>Yes</option>
                                                    <option value="FALSE" ${String(m.isSeriesValue).trim() === 'FALSE' ? 'selected' : ''}>No</option>
                                                </select>
                                            `}
                                        </div>
                                    </div>
                                    <div><label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Director</label><input id="fld-director" name="Director" class="input-field ${directorLocked ? 'input-readonly' : ''}" value="${m.director}" ${directorLocked ? 'readonly' : ''}></div>
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Genre</label>
                                        ${genreLocked ? `
                                            <input id="fld-genre" name="Genre" class="input-field input-readonly" value="${m.genre}" readonly>
                                        ` : `
                                            <input type="hidden" id="fld-genre" name="Genre" value="${selectedGenres.join(', ')}">
                                            <div id="genre-chip-wrap" class="genre-chip-wrap">
                                                ${genreOptions.map(g => `
                                                    <button
                                                        type="button"
                                                        class="genre-chip ${selectedGenres.includes(g) ? 'selected' : ''}"
                                                        data-genre="${g}"
                                                        aria-pressed="${selectedGenres.includes(g) ? 'true' : 'false'}"
                                                        onclick="toggleGenreChip(this)"
                                                    >${g}</button>
                                                `).join('')}
                                            </div>
                                            <div class="text-xs text-gray" style="margin-top:0.5rem;">Select any genres that apply</div>
                                        `}
                                    </div>

                                    <div style="border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1rem; margin-top: 0.5rem;">
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">External Ratings</label>
                                        <div class="flex flex-col gap-4">
                                            <div>
                                                <label class="text-xs text-gray submit-label block" style="margin-bottom: 0.25rem;">IMDb Rating</label>
                                                <div class="slider-container">
                                                    <input
                                                        id="fld-imdb-range"
                                                        type="range"
                                                        min="0"
                                                        max="100"
                                                        value="${imdbPct}"
                                                        ${imdbLocked ? 'disabled' : ''}
                                                        ${imdbLocked ? '' : "oninput=\"document.getElementById('fld-imdb').value = this.value\""}
                                                    >
                                                    <div class="relative" style="width: 140px;">
                                                        <input
                                                            type="number"
                                                            id="fld-imdb"
                                                            name="IMDb"
                                                            value="${imdbPct}"
                                                            min="0"
                                                            max="100"
                                                            class="input-field text-center ${imdbLocked ? 'input-readonly' : ''}"
                                                            ${imdbLocked ? 'readonly' : ''}
                                                            ${imdbLocked ? '' : "oninput=\"document.getElementById('fld-imdb-range').value = this.value\""}
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- User Input Section -->
                            <div class="glass-panel col-span-2" style="padding: 2rem; padding-bottom: calc(2rem - 10px); border-radius: 1rem; border: 1px solid rgba(${formAccent.rgb}, 0.14);">
                                <div class="flex justify-between items-center mb-6" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; margin-bottom: 10px;">
                                    <div class="flex items-center gap-3">
                                        <span style="color: ${formAccent.hex};">${icons.edit3}</span>
                                        <h2 class="text-xl font-semibold text-white">Your Review</h2>
                                    </div>
                                </div>

                                <div class="grid md-row gap-6 mb-6" style="margin-top: 0px;">
                                    <div style="flex:1;">
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Date Watched</label>
                                        <input id="fld-datewatch" name="Date Watch" type="date" class="input-field ${isUpdate ? 'input-readonly' : ''}" value="${u.date}" ${isUpdate ? 'readonly title="Locked while updating"' : ''} onclick="openDatePickerFromInput(this)" onfocus="openDatePickerFromInput(this)" required>
                                    </div>
                                    <div style="flex:1;">
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Tier List</label>
                                        <input type="hidden" id="fld-tier" name="Tier List" value="${(['S','A','B','C','D','F'].includes(tierLetter) ? `${tierLetter}-Tier` : String(u.tier || ''))}">
                                        <div class="tier-btn-group" style="margin-top: 0.35rem;" data-target-input="fld-tier" data-has-selection="${String(u.tier || '').trim() ? 'true' : 'false'}">
                                            <button type="button" class="tier-btn ${tierLetter === 'S' ? 'selected' : ''}" data-tier="S-Tier" aria-pressed="${tierLetter === 'S' ? 'true' : 'false'}" onclick="setTierFromButton(this)">S</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'A' ? 'selected' : ''}" data-tier="A-Tier" aria-pressed="${tierLetter === 'A' ? 'true' : 'false'}" onclick="setTierFromButton(this)">A</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'B' ? 'selected' : ''}" data-tier="B-Tier" aria-pressed="${tierLetter === 'B' ? 'true' : 'false'}" onclick="setTierFromButton(this)">B</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'C' ? 'selected' : ''}" data-tier="C-Tier" aria-pressed="${tierLetter === 'C' ? 'true' : 'false'}" onclick="setTierFromButton(this)">C</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'D' ? 'selected' : ''}" data-tier="D-Tier" aria-pressed="${tierLetter === 'D' ? 'true' : 'false'}" onclick="setTierFromButton(this)">D</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'F' ? 'selected' : ''}" data-tier="F-Tier" aria-pressed="${tierLetter === 'F' ? 'true' : 'false'}" onclick="setTierFromButton(this)">F</button>
                                        </div>
                                        <div class="text-xs text-gray" id="tier-help-text" style="margin-top: 0.4rem;">${tierHelpText}</div>
                                    </div>
                                </div>

                                <div class="mb-8">
                                    <h3 class="text-sm font-bold text-white uppercase mb-4 label-gap">Detailed Scoring (%)</h3>
                                    <div class="grid grid-2 gap-6">
                                        ${scoreOrder.map(key => `
                                            <div style="${key === 'overall' ? 'grid-column: span 2; padding: 1rem; border-radius: 0.75rem; background: var(--brand-light); border: 1px solid rgba(20,184,166,0.22);' : ''}">
                                                <label class="text-sm ${key === 'overall' ? 'text-white' : 'text-white'} font-bold mb-2 label-gap submit-label block capitalize" style="${key === 'overall' ? 'display:flex; align-items:center; gap:0.5rem;' : ''}">${key === 'overall' ? `<span class=\"text-brand\">${icons.star}</span><span>Overall</span>` : key === 'sound' ? 'Score - Sound Design' : key === 'imagery' ? 'Imagery - CGI - Animation' : key === 'acting' ? 'Acting - Character Animation' : key}</label>
                                                <div class="slider-container">
                                                    <input type="range" min="0" max="100" value="${scores[key]}" oninput="document.getElementById('num-${key}').value = this.value">
                                                    <div class="relative" style="width: 140px;">
                                                        <input
                                                            type="number"
                                                            id="num-${key}"
                                                            name="${key === 'overall' ? 'Overall' : key === 'sound' ? 'Score - Sound Design' : key === 'pace' ? 'Pace' : key === 'imagery' ? 'Imagery - CGI - Animation' : key === 'plot' ? 'Plot - Writting' : key === 'acting' ? 'Acting - Character Animation' : key === 'dialogue' ? 'Dialogue' : key}"
                                                            value="${scores[key]}"
                                                            min="0"
                                                            max="100"
                                                            class="input-field text-center ${key === 'overall' ? 'font-bold' : ''}"
                                                            oninput="this.parentElement.previousElementSibling.value = this.value"
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="flex flex-col gap-6" style="margin-bottom: 0px;">
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Favorite Quote</label>
                                        <div class="relative">
                                            <div class="input-icon">${icons.quote}</div>
                                            <input id="fld-quote" name="Fav Quote" type="text" class="input-field" style="padding-left: 2.5rem;" value="${escapeHtml(u.quote)}" placeholder="One liner...">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Notes / Review</label>
                                        <textarea id="fld-notes" name="Notes" class="textarea-field" rows="4" placeholder="Review...">${u.notes}</textarea>
                                    </div>
                                        <div class="grid grid-2 gap-6">
                                            <div class="flex items-center justify-start" style="gap: 25px;">
                                                <span class="text-sm text-white font-bold label-gap capitalize">Times Watched</span>
                                                <input id="fld-timeswatch" name="Times Watch" type="number" min="1" value="${u.watched}" class="input-field text-center ${timesWatchedLocked ? 'input-readonly' : ''}" style="width: 100px; height: 42px;" ${timesWatchedLocked ? 'readonly' : ''}>
                                            </div>
                                            <div class="flex items-center justify-start" style="gap: 25px;">
                                                <span class="text-sm text-white font-bold label-gap capitalize">Watch Method</span>
                                                <button
                                                    type="button"
                                                    id="watchmethod-toggle"
                                                    class="input-field ${watchMethodLocked ? 'input-readonly' : ''}"
                                                    style="width: 110px; height: 42px; display:flex; align-items:center; justify-content:center; padding:0; background-color: ${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'rgba(20, 184, 166, 0.35)' : 'rgba(168, 85, 247, 0.35)'}; color: white; border-color: ${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'rgba(20, 184, 166, 0.5)' : 'rgba(168, 85, 247, 0.5)'};"
                                                    ${watchMethodLocked ? 'disabled title="Locked while updating"' : 'onclick="toggleWatchMethod(this)"'}
                                                >
                                                    ${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'In Theater' : 'At Home'}
                                                </button>
                                                <input type="hidden" id="fld-watchmethod" name="Watch Method" value="${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'In Theater' : 'At Home'}">
                                            </div>
                                        </div>
                                </div>

                                <div class="flex" style="border-top: 1px solid rgba(255,255,255,0.05); margin-top: 15px; padding-top: 15px; justify-content: ${isUpdate ? 'space-between' : 'center'}; gap: 10px; flex-wrap: wrap;">
                                    ${isUpdate ? `
                                        <button id="btn-delete-rating" type="button" class="btn btn-outline" style="margin-top: 0px; border-radius: 0.85rem; border-color: rgba(239,68,68,0.55); color: rgba(239,68,68,0.95); background: rgba(239,68,68,0.10);" onclick="openDeleteRatingModal()">
                                            Delete
                                        </button>
                                    ` : ''}
                                    <button id="btn-save-diary" type="submit" class="btn btn-primary" style="margin-top: 0px; opacity: 0.6;" aria-disabled="true" title="Please log in first.">
                                        ${icons.save} Save to Diary
                                    </button>
                                </div>
                            </div>
                        </form>
                        </div>
                    </div>
                `;
            },

            renderDashboard() {
                return `
                    <div class="fade-in">
                        <!-- Background -->
                        <div style="position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1518676590629-3dcbd9c5a5c9?q=80&w=2028&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.15; pointer-events: none;"></div>
                        <div style="position: fixed; inset: 0; background: linear-gradient(to bottom, var(--bg-dark), transparent 20%, var(--bg-dark) 90%); z-index: -1; pointer-events: none;"></div>

                        <div class="container" style="padding-top: 2rem; position: relative;">
                        <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                            <div>
                                <h1 class="text-3xl font-bold text-white">Data Dashboard</h1>
                                <p class="text-gray mt-2">Insights into your viewing habits.</p>
                            </div>

                            <!-- Tabs (moved up) -->
                            <div class="glass-panel" style="padding: 0.55rem; border-radius: 0.9rem;">
                                <div class="flex" style="gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                    <button type="button" class="btn dash-pill-btn btn-glass" id="dash-tab-general" data-tab="general" style="padding: 0.6rem 0.9rem;">General</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-ratings" data-tab="ratings" style="padding: 0.6rem 0.9rem;">Ratings</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-tiers" data-tab="tiers" style="padding: 0.6rem 0.9rem;">Tiers</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-favorites" data-tab="favorites" style="padding: 0.6rem 0.9rem;">Favorites</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-quotes" data-tab="quotes" style="padding: 0.6rem 0.9rem;">Quote Wall</button>
                                </div>
                            </div>
                        </div>

                        <!-- Timeframe (shown for all tabs) -->
                        <div style="display:flex; gap: 12px; align-items: flex-start; flex-wrap: wrap; margin-bottom: 1.25rem;">
                            <div class="glass-panel" style="padding: 0.55rem 0.75rem; border-radius: 0.9rem;">
                                <div class="text-xs text-gray" style="margin-bottom: 0.4rem;">Timeframe</div>
                                <div class="flex" style="gap: 10px; flex-wrap: wrap;">
                                    <button type="button" class="btn dash-pill-btn btn-glass" id="dash-range-all-time" data-range="all_time" style="padding: 0.55rem 0.85rem;">All Time</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-range-this-year" data-range="this_year" style="padding: 0.55rem 0.85rem;">This Year</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-range-this-month" data-range="this_month" style="padding: 0.55rem 0.85rem;">This Month</button>
                                </div>
                            </div>

                            <!-- Favorites-only: Rank By controls (shown only when Favorites tab active) -->
                            <div id="dash-fav-metric-panel" class="glass-panel hidden" style="padding: 0.55rem 0.75rem; border-radius: 0.9rem;">
                                <div class="text-xs text-gray" style="margin-bottom: 0.4rem;">Rank by</div>
                                <div id="dash-fav-metric-wrap" class="flex" style="gap: 10px; flex-wrap: wrap;">
                                    <button type="button" class="btn dash-pill-btn btn-glass" data-metric="overall" id="dash-fav-metric-overall" style="padding: 0.55rem 0.85rem;">Overall</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="sound" id="dash-fav-metric-sound" style="padding: 0.55rem 0.85rem;">Sound</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="plot" id="dash-fav-metric-plot" style="padding: 0.55rem 0.85rem;">Plot</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="pace" id="dash-fav-metric-pace" style="padding: 0.55rem 0.85rem;">Pace</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="acting" id="dash-fav-metric-acting" style="padding: 0.55rem 0.85rem;">Acting</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="imagery" id="dash-fav-metric-imagery" style="padding: 0.55rem 0.85rem;">Imagery</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="dialogue" id="dash-fav-metric-dialogue" style="padding: 0.55rem 0.85rem;">Dialogue</button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: General -->
                        <div id="dash-pane-general">
                            <div class="grid grid-3 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Watch Events</span><span class="text-brand">${icons.video}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-watch-events-total"></div>
                                            <div class="dash-mini-kpi-label">Total watches</div>
                                        </div>
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-watch-events-unique"></div>
                                            <div class="dash-mini-kpi-label">Unique movies</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Hours Watched</span><span class="text-brand">${icons.clock}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-hours-watched"></div>
                                            <div class="dash-mini-kpi-label">Total hours</div>
                                        </div>
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-hours-watched-unique"></div>
                                            <div class="dash-mini-kpi-label">Unique hours</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Watch Method</span><span class="text-brand">${icons.tv}</span></div>
                                    <div class="grid grid-3" style="gap: 12px;">
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="watch_method_at_home_events">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-at-home-watches"></div>
                                            <div class="dash-mini-kpi-label">At home (watch events)</div>
                                        </div>
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="watch_method_at_home_unique">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-at-home-movies"></div>
                                            <div class="dash-mini-kpi-label">At home (unique movies)</div>
                                        </div>
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="watch_method_in_theater">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-in-theater-watches"></div>
                                            <div class="dash-mini-kpi-label">In theater</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-3 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Genre</span><span class="text-brand">${icons.pieChart}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_genre">
                                            <div class="text-white font-bold dash-mini-kpi-value" id="dash-general-top-genre-events" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">All watch events</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-genre-events-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_genre_unique">
                                            <div class="text-white font-bold dash-mini-kpi-value" id="dash-general-top-genre-unique" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">Unique movies only</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-genre-unique-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Decade</span><span class="text-brand">${icons.calendar}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_decade">
                                            <div class="text-white font-bold tabular-nums dash-mini-kpi-value" id="dash-general-top-decade-events" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">All watch events</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-decade-events-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_decade_unique">
                                            <div class="text-white font-bold tabular-nums dash-mini-kpi-value" id="dash-general-top-decade-unique" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">Unique movies only</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-decade-unique-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Director</span><span class="text-brand">${icons.user}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_director">
                                            <div class="text-white font-bold dash-mini-kpi-value" id="dash-general-top-director-events" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">All watch events</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-director-events-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_director_unique">
                                            <div class="text-white font-bold dash-mini-kpi-value" id="dash-general-top-director-unique" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">Unique movies only</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-director-unique-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-3 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Actor</span><span class="text-brand">${icons.user}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_actor">
                                            <div class="text-white font-bold dash-mini-kpi-value" id="dash-general-top-actor-events" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">All watch events</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-actor-events-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_actor_unique">
                                            <div class="text-white font-bold dash-mini-kpi-value" id="dash-general-top-actor-unique" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">Unique movies only</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-actor-unique-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="glass-panel dash-kpi-clickable" data-general-kpi="most_watched_movie" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Movie</span><span class="text-brand">${icons.film}</span></div>
                                    <div class="text-xl font-bold text-white" id="dash-general-top-movie"></div>
                                    <div class="mt-2 text-sm text-gray tabular-nums" id="dash-general-top-movie-count">&nbsp;</div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched MPA Rating</span><span class="text-brand">${icons.star}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_mpa">
                                            <div class="text-white font-bold dash-mini-kpi-value" id="dash-general-top-mpa-events" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">All watch events</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-mpa-events-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                        <div class="dash-mini-kpi dash-kpi-clickable" data-general-kpi="most_watched_mpa_unique">
                                            <div class="text-white font-bold dash-mini-kpi-value" id="dash-general-top-mpa-unique" style="font-size: 1.35rem; line-height: 1.15;"></div>
                                            <div class="dash-mini-kpi-label">Unique movies only</div>
                                            <div class="text-xs text-gray tabular-nums" id="dash-general-top-mpa-unique-count" style="margin-top: 0.35rem;">&nbsp;</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Ratings (placeholder for now) -->
                        <div id="dash-pane-ratings" class="hidden">
                            <div class="grid grid-2 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Avg Overall</span><span class="text-brand">${icons.percent}</span></div>
                                    <div class="text-5xl font-bold text-white tabular-nums" id="dash-ratings-avg-overall"></div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Average Abs Diff Rating: You vs IMDb</span>
                                        <span class="text-brand">${icons.activity}</span>
                                    </div>
                                    <div class="text-5xl font-bold text-white tabular-nums" id="dash-ratings-avg-imdb-diff"></div>
                                </div>
                            </div>

                            <div class="grid grid-2 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Highest Rated Genre</span>
                                        <span class="text-brand">${icons.trendingUp}</span>
                                    </div>
                                    <div class="text-2xl font-bold text-white" id="dash-ratings-top-genre"></div>
                                    <div class="mt-2 text-sm text-gray">Avg <span class="dash-help-score tabular-nums" id="dash-ratings-top-genre-avg"></span>  <span class="tabular-nums" id="dash-ratings-top-genre-n"></span> rated movies</div>
                                    <div class="mt-2 text-xs text-gray">Only includes genres with at least 2 rated movies.</div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Lowest Rated Genre</span>
                                        <span class="text-brand">${icons.trendingDown}</span>
                                    </div>
                                    <div class="text-2xl font-bold text-white" id="dash-ratings-bottom-genre"></div>
                                    <div class="mt-2 text-sm text-gray">Avg <span class="dash-help-score tabular-nums" id="dash-ratings-bottom-genre-avg"></span>  <span class="tabular-nums" id="dash-ratings-bottom-genre-n"></span> rated movies</div>
                                    <div class="mt-2 text-xs text-gray">Only includes genres with at least 2 rated movies.</div>
                                </div>
                            </div>

                            <div class="grid grid-2 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Highest Rated Director</span>
                                        <span class="text-brand">${icons.user}</span>
                                    </div>
                                    <div class="text-2xl font-bold text-white" id="dash-ratings-top-director"></div>
                                    <div class="mt-2 text-sm text-gray">Avg <span class="dash-help-score tabular-nums" id="dash-ratings-top-director-avg"></span>  <span class="tabular-nums" id="dash-ratings-top-director-n"></span> rated movies</div>
                                    <div class="mt-2 text-xs text-gray">Only includes directors with at least 2 rated movies.</div>
                                </div>

                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Lowest Rated Director</span>
                                        <span class="text-brand">${icons.user}</span>
                                    </div>
                                    <div class="text-2xl font-bold text-white" id="dash-ratings-bottom-director"></div>
                                    <div class="mt-2 text-sm text-gray">Avg <span class="dash-help-score tabular-nums" id="dash-ratings-bottom-director-avg"></span>  <span class="tabular-nums" id="dash-ratings-bottom-director-n"></span> rated movies</div>
                                    <div class="mt-2 text-xs text-gray">Only includes directors with at least 2 rated movies.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Tiers (placeholder for now) -->
                        <div id="dash-pane-tiers" class="hidden">
                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem; margin-bottom: 1.25rem;">
                                <div class="flex justify-between mb-4">
                                    <span class="text-gray text-sm">Tier Distribution</span>
                                    <span class="text-brand">${icons.pieChart}</span>
                                </div>
                                <div id="dash-tiers-bars"></div>
                            </div>

                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                <div class="flex justify-between mb-4">
                                    <span class="text-gray text-sm">Movies By Tier</span>
                                    <span class="text-brand">${icons.film}</span>
                                </div>
                                <div id="dash-tiers-lists"></div>
                            </div>
                        </div>

                        <!-- Tab: Favorites -->
                        <div id="dash-pane-favorites" class="hidden">
                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem; margin-bottom: 1.25rem;">
                                <div class="flex justify-between mb-4">
                                    <span style="font-size: 1.05rem; font-weight: 700; color: #34d399;">Top 5</span>
                                    <span style="color: #34d399;">${icons.trendingUp}</span>
                                </div>
                                <div id="dash-fav-top"></div>
                            </div>

                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                <div class="flex justify-between mb-4">
                                    <span style="font-size: 1.05rem; font-weight: 700; color: #fb7185;">Bottom 5</span>
                                    <span style="color: #fb7185;">${icons.trendingDown}</span>
                                </div>
                                <div id="dash-fav-bottom"></div>
                            </div>
                        </div>

                        <!-- Tab: Quote Wall -->
                        <div id="dash-pane-quotes" class="hidden">
                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.95rem;">
                                <div class="flex justify-between mb-4" style="gap: 14px; align-items: flex-start; flex-wrap: wrap;">
                                    <div>
                                        <div class="text-white" style="font-size: 1.1rem; font-weight: 800;">Quote Wall</div>
                                        <div class="text-xs text-gray" style="margin-top: 0.35rem;">Top quotes (max 50), ranked by Overall rating. Click a card to jump to Update Ratings.</div>
                                    </div>
                                    <div class="text-xs text-gray" id="dash-quote-wall-meta" style="text-align:right;"></div>
                                </div>
                                <div id="dash-quote-wall" class="text-gray">Loading</div>
                            </div>
                        </div>

                        </div>
                    </div>
                `;
            },

            renderFeed() {
                return `
                    <div class="fade-in">
                        <!-- Background -->
                        <div style="position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1485846234645-a62644f84728?q=80&w=2000&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.12; pointer-events: none;"></div>
                        <div style="position: fixed; inset: 0; background: linear-gradient(to bottom, var(--bg-dark), transparent 20%, var(--bg-dark) 90%); z-index: -1; pointer-events: none;"></div>

                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div>
                                    <h1 class="text-3xl font-bold text-white">Feed</h1>
                                    <p class="text-gray mt-2">New and updated ratings from people you follow.</p>
                                </div>
                            </div>

                            <div class="grid" style="grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: start;">
                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem;">
                                    <div class="flex justify-between items-center" style="gap: 12px; flex-wrap: wrap;">
                                        <div>
                                            <div class="text-white font-bold">Following Activity</div>
                                            <div id="feed-meta" class="text-xs text-gray" style="margin-top: 0.25rem;"></div>
                                        </div>
                                        <div style="display:flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: flex-end;">
                                            <button id="feed-sort-watched" type="button" class="nav-link feed-sort-btn" data-feed-action="set_sort" data-feed-sort-mode="watch_date">Watched</button>
                                            <button id="feed-sort-updated" type="button" class="nav-link feed-sort-btn" data-feed-action="set_sort" data-feed-sort-mode="updated_at">Updated</button>
                                            <button id="feed-refresh" type="button" class="btn btn-outline" data-feed-action="refresh" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Refresh</button>
                                        </div>
                                    </div>

                                    <div id="feed-list" style="margin-top: 0.9rem; display: grid; gap: 12px;"></div>
                                </div>

                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem;">
                                    <div class="text-white font-bold">Follow People</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.25rem;">Search by username.</div>

                                    <form id="feed-search-form" style="margin-top: 0.85rem;">
                                        <div class="relative">
                                            <input id="feed-search-input" type="text" class="input-field" placeholder="username" autocomplete="off" style="padding-right: 130px;">
                                            <div style="position:absolute; right: 8px; top: 50%; transform: translateY(-50%); display:flex; gap: 8px;">
                                                <button id="feed-search-btn" type="submit" class="btn btn-primary" style="padding: 0.5rem 0.75rem; border-radius: 0.75rem;">Search</button>
                                                <button id="feed-clear-btn" type="button" class="btn btn-outline" style="padding: 0.5rem 0.75rem; border-radius: 0.75rem;">Clear</button>
                                            </div>
                                        </div>
                                    </form>

                                    <div id="feed-search-results" style="margin-top: 0.9rem; display: grid; gap: 10px;"></div>

                                    <div style="height: 1px; background: rgba(255,255,255,0.06); margin: 1rem 0;"></div>

                                    <div class="text-white font-bold">Following</div>
                                    <div id="feed-following" style="margin-top: 0.75rem; display: grid; gap: 10px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderLibrary() {
                return `
                    <div class="fade-in">
                        <!-- Background -->
                        <div style="position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?q=80&w=2000&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.10; pointer-events: none;"></div>
                        <div style="position: fixed; inset: 0; background: linear-gradient(to bottom, var(--bg-dark), transparent 20%, var(--bg-dark) 90%); z-index: -1; pointer-events: none;"></div>

                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div>
                                    <h1 class="text-3xl font-bold text-white">My Movies</h1>
                                    <p class="text-gray mt-2">Your most recent watches, with all stored details and ratings.</p>
                                </div>
                                <div style="display:flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: flex-end;">
                                    <button id="library-open-sortfilter" type="button" class="btn btn-outline" data-library-action="open_sort_filter" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Change Filters/Sort</button>
                                    <button id="library-refresh" type="button" class="btn btn-outline" data-library-action="refresh" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Refresh</button>
                                </div>
                            </div>

                            <div class="glass-panel" style="padding: 1rem; border-radius: 1rem;">
                                <div class="flex justify-between items-center" style="gap: 12px; flex-wrap: wrap;">
                                    <div>
                                        <div class="text-white font-bold">Recent Watches</div>
                                        <div id="library-meta" class="text-xs text-gray" style="margin-top: 0.25rem;"></div>
                                    </div>
                                </div>
                                <div id="library-list" style="margin-top: 0.9rem; display: grid; gap: 12px;"></div>

                                <div id="library-load-more-wrap" style="margin-top: 1rem; display:none; justify-content: center;">
                                    <button id="library-load-more" type="button" class="btn btn-glass" data-library-action="load_more" style="padding: 0.75rem 1.25rem; border-radius: 0.95rem;">Load More</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderAccount() {
                return `
                    <div class="fade-in">
                        <div style="position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?q=80&w=2000&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.10; pointer-events: none;"></div>
                        <div style="position: fixed; inset: 0; background: linear-gradient(to bottom, var(--bg-dark), transparent 20%, var(--bg-dark) 90%); z-index: -1; pointer-events: none;"></div>

                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div>
                                    <h1 class="text-3xl font-bold text-white">Account</h1>
                                    <p class="text-gray mt-2">Update your profile and password.</p>
                                </div>
                                <div style="display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                    <button type="button" class="btn btn-outline" data-account-action="logout" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Log out</button>
                                    <button type="button" class="btn btn-outline" onclick="router.navigate('home')" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Back</button>
                                </div>
                            </div>

                            <div class="grid" style="grid-template-columns: 1fr; gap: 16px; align-items: start;">
                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem;">
                                    <div class="text-white font-bold">Profile</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.25rem;">Your username is used for search + following.</div>

                                    <div id="account-profile-status" class="text-xs" style="margin-top: 0.6rem; color: rgba(255,255,255,0.60);"></div>

                                    <form id="account-profile-form" style="margin-top: 0.85rem; display:grid; gap: 0.75rem;">
                                        <input id="account-icon" type="hidden" value="">
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Username</label>
                                            <input id="account-username" type="text" class="input-field" placeholder="e.g. landon" autocomplete="username" spellcheck="false">
                                            <div class="text-xs text-gray" style="margin-top: 0.35rem;">320 chars  letters/numbers/underscore  stored without @.</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Display name</label>
                                            <input id="account-display-name" type="text" class="input-field" placeholder="e.g. Landon James" autocomplete="name">
                                        </div>

                                        <div>
                                            <div class="text-sm text-white font-bold">Icon</div>
                                            <div class="text-xs text-gray" style="margin-top: 0.25rem;">Pick one of 10 preset icons.</div>
                                            <div id="account-icon-grid" class="account-icon-grid"></div>
                                        </div>
                                        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                            <button id="account-save-profile" type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Save profile</button>
                                            <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" data-account-action="reload">Reload</button>
                                        </div>
                                    </form>
                                </div>

                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem;">
                                    <div class="text-white font-bold">Security</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.25rem;">Password changes update Supabase Auth (not your Users table).</div>

                                    <div style="margin-top: 0.85rem; display:grid; gap: 0.75rem;">
                                        <div>
                                            <div class="text-sm text-white font-bold">Email</div>
                                            <div id="account-email" class="text-xs" style="margin-top: 0.25rem; color: rgba(255,255,255,0.70);"></div>
                                        </div>

                                        <form id="account-password-form" style="display:grid; gap: 0.75rem;">
                                            <div>
                                                <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">New password</label>
                                                <input id="account-new-password" type="password" class="input-field" placeholder="" autocomplete="new-password">
                                            </div>
                                            <div>
                                                <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Confirm new password</label>
                                                <input id="account-confirm-password" type="password" class="input-field" placeholder="" autocomplete="new-password">
                                            </div>
                                            <div id="account-password-status" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
                                            <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                                <button id="account-change-password" type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Change password</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderDashboardKpiDetail() {
                return `
                    <div class="fade-in">
                        <!-- Background -->
                        <div style="position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1518676590629-3dcbd9c5a5c9?q=80&w=2028&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.15; pointer-events: none;"></div>
                        <div style="position: fixed; inset: 0; background: linear-gradient(to bottom, var(--bg-dark), transparent 20%, var(--bg-dark) 90%); z-index: -1; pointer-events: none;"></div>

                        <div class="container" style="padding-top: 2rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div class="flex" style="gap: 12px; align-items: center;">
                                    <button type="button" class="btn btn-outline" id="dash-kpi-back" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem; display:flex; align-items:center; gap: 8px;" onclick="dashboardActiveTab='general'; router.navigate('dashboard');">
                                        <span style="display:inline-flex; width: 18px; height: 18px;">${icons.arrowLeft}</span>
                                        Back
                                    </button>
                                    <div>
                                        <h1 class="text-2xl font-bold text-white" id="dash-kpi-title">KPI</h1>
                                        <p class="text-gray mt-2" id="dash-kpi-subtitle"></p>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-panel" style="padding:1.25rem; border-radius:0.95rem;">
                                <div id="dash-kpi-grid" class="text-gray">Loading</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        let homeSearchDebounceTimer = null;
        let homeSearchAbortController = null;
        let homeSearchItems = [];

        let homeTrendingItems = [];
        let homeTrendingAbortController = null;

        async function callSwiftApiPublic(body, { signal } = {}) {
            const url = `${SUPABASE_URL}/functions/v1/swift-api`;

            // If the user is logged in, include Authorization. If not, allow a public call.
            let authHeader = null;
            try {
                const { data } = await supabaseClient?.auth?.getSession?.();
                const token = data?.session?.access_token || null;
                if (token) authHeader = `Bearer ${token}`;
            } catch (_) {}

            const headers = {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
            };
            if (authHeader) headers['Authorization'] = authHeader;

            const res = await fetch(url, {
                method: 'POST',
                headers,
                body: JSON.stringify(body || {}),
                signal,
            });

            const text = await res.text();
            let data = null;
            try {
                data = text ? JSON.parse(text) : null;
            } catch (_) {
                data = text;
            }

            if (!res.ok) {
                const serverMsg =
                    data && typeof data === 'object'
                        ? (data.message || data.error || JSON.stringify(data))
                        : String(data || '');
                throw new Error(`${serverMsg || 'Request failed'}`);
            }

            return data;
        }

        async function loadDashboard() {
            // Called on router.navigate('dashboard') after the DOM is rendered.
            const elUnique = document.getElementById('dash-unique-movies-year');
            const elHours = document.getElementById('dash-total-hours');
            const elAvg = document.getElementById('dash-avg-rating');
            const elGenre = document.getElementById('dash-top-genre');
            const elGenreCount = document.getElementById('dash-top-genre-count');
            const elGenreAvg = document.getElementById('dash-top-genre-avg');

            const elTopMovieTitle = document.getElementById('dash-top-movie-title');
            const elTopMovieRating = document.getElementById('dash-top-movie-rating');
            const elWatchEventsYear = document.getElementById('dash-watch-events-year');
            const elWatchEventsAll = document.getElementById('dash-watch-events-all');

            const elDecade = document.getElementById('dash-most-watched-decade');
            const elDecadeCount = document.getElementById('dash-most-watched-decade-count');
            const elActor = document.getElementById('dash-most-watched-actor');
            const elActorCount = document.getElementById('dash-most-watched-actor-count');
            const elDirector = document.getElementById('dash-most-watched-director');
            const elDirectorCount = document.getElementById('dash-most-watched-director-count');

            const elHighDirector = document.getElementById('dash-highest-rated-director');
            const elHighDirectorAvg = document.getElementById('dash-highest-rated-director-avg');
            const elHighDirectorN = document.getElementById('dash-highest-rated-director-n');

            const elAtHome = document.getElementById('dash-at-home');
            const elInTheater = document.getElementById('dash-in-theater');

            const elTierBars = document.getElementById('dash-tier-bars');

            const required = [
                elUnique, elHours, elAvg, elGenre, elGenreCount, elGenreAvg,
                elTopMovieTitle, elTopMovieRating,
                elWatchEventsYear, elWatchEventsAll,
                elDecade, elDecadeCount,
                elActor, elActorCount,
                elDirector, elDirectorCount,
                elHighDirector, elHighDirectorAvg, elHighDirectorN,
                elAtHome, elInTheater,
                elTierBars,
            ];
            if (required.some(x => !x)) return;

            if (!supabaseClient) {
                elUnique.textContent = '';
                elHours.textContent = '';
                elAvg.textContent = '';
                elGenre.textContent = '';
                elGenreCount.textContent = '';
                elGenreAvg.textContent = '';

                elTopMovieTitle.textContent = '';
                elTopMovieRating.textContent = '';
                elWatchEventsYear.textContent = '';
                elWatchEventsAll.textContent = '';

                elDecade.textContent = '';
                elDecadeCount.textContent = '';
                elActor.textContent = '';
                elActorCount.textContent = '';
                elDirector.textContent = '';
                elDirectorCount.textContent = '';

                elHighDirector.textContent = '';
                elHighDirectorAvg.textContent = '';
                elHighDirectorN.textContent = '';

                elAtHome.textContent = '';
                elInTheater.textContent = '';

                elTierBars.innerHTML = '';
                return;
            }

            // Require auth for dashboard metrics.
            let authedUser = null;
            try {
                const { data } = await supabaseClient.auth.getUser();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!authedUser?.id) {
                elUnique.textContent = '';
                elHours.textContent = '';
                elAvg.textContent = '';
                elGenre.textContent = '';
                elGenreCount.textContent = '';
                elGenreAvg.textContent = '';

                elTopMovieTitle.textContent = '';
                elTopMovieRating.textContent = '';
                elWatchEventsYear.textContent = '';
                elWatchEventsAll.textContent = '';

                elDecade.textContent = '';
                elDecadeCount.textContent = '';
                elActor.textContent = '';
                elActorCount.textContent = '';
                elDirector.textContent = '';
                elDirectorCount.textContent = '';

                elHighDirector.textContent = '';
                elHighDirectorAvg.textContent = '';
                elHighDirectorN.textContent = '';

                elAtHome.textContent = '';
                elInTheater.textContent = '';

                elTierBars.innerHTML = '';
                return;
            }

            // Loading state.
            elUnique.textContent = '';
            elHours.textContent = '';
            elAvg.textContent = '';
            elGenre.textContent = '';
            elGenreCount.textContent = '';
            elGenreAvg.textContent = '';

            elTopMovieTitle.textContent = '';
            elTopMovieRating.textContent = '';
            elWatchEventsYear.textContent = '';
            elWatchEventsAll.textContent = '';

            elDecade.textContent = '';
            elDecadeCount.textContent = '';
            elActor.textContent = '';
            elActorCount.textContent = '';
            elDirector.textContent = '';
            elDirectorCount.textContent = '';

            elHighDirector.textContent = '';
            elHighDirectorAvg.textContent = '';
            elHighDirectorN.textContent = '';

            elAtHome.textContent = '';
            elInTheater.textContent = '';

            elTierBars.innerHTML = '';

            try {
                const { data, error } = await supabaseClient.rpc('get_dashboard_summary');
                if (error) throw error;

                const uniqueMovies = Number(data?.unique_movies_this_year ?? 0);
                const totalHours = Number(data?.total_watch_hours_all_time ?? 0);
                const avgRating = Number(data?.avg_overall_rating ?? 0);
                const topGenre = String(data?.top_genre ?? '').trim();
                const topGenreCount = Number(data?.top_genre_count ?? 0);
                const topGenreAvg = Number(data?.top_genre_avg_overall ?? 0);

                const topMovieTitle = String(data?.highest_rated_movie?.title ?? '').trim();
                const topMovieRating = Number(data?.highest_rated_movie?.overall_rating ?? 0);

                const watchEventsYear = Number(data?.total_watch_events_this_year ?? 0);
                const watchEventsAll = Number(data?.total_watch_events_all_time ?? 0);

                const decade = data?.most_watched_decade?.decade;
                const decadeWatches = Number(data?.most_watched_decade?.watches ?? 0);

                const actorName = String(data?.most_watched_actor?.name ?? '').trim();
                const actorWatches = Number(data?.most_watched_actor?.watches ?? 0);

                const directorName = String(data?.most_watched_director?.name ?? '').trim();
                const directorWatches = Number(data?.most_watched_director?.watches ?? 0);

                const highDirectorName = String(data?.highest_rated_director?.name ?? '').trim();
                const highDirectorAvg = Number(data?.highest_rated_director?.avg_overall ?? 0);
                const highDirectorN = Number(data?.highest_rated_director?.n ?? 0);

                const atHome = Number(data?.watch_method_breakdown?.at_home ?? 0);
                const inTheater = Number(data?.watch_method_breakdown?.in_theater ?? 0);

                const tierDist = Array.isArray(data?.tier_distribution) ? data.tier_distribution : [];

                elUnique.textContent = Number.isFinite(uniqueMovies) ? String(uniqueMovies) : '0';
                elHours.textContent = Number.isFinite(totalHours) ? String(totalHours) : '0';
                elAvg.textContent = Number.isFinite(avgRating) ? String(avgRating) : '0';
                elGenre.textContent = topGenre || '';
                elGenreCount.textContent = Number.isFinite(topGenreCount) ? String(topGenreCount) : '0';
                elGenreAvg.textContent = Number.isFinite(topGenreAvg) ? String(topGenreAvg) : '0';

                elTopMovieTitle.textContent = topMovieTitle || '';
                elTopMovieRating.textContent = Number.isFinite(topMovieRating) ? String(topMovieRating) : '0';

                elWatchEventsYear.textContent = Number.isFinite(watchEventsYear) ? String(watchEventsYear) : '0';
                elWatchEventsAll.textContent = Number.isFinite(watchEventsAll) ? String(watchEventsAll) : '0';

                elDecade.textContent = (decade === null || decade === undefined) ? '' : `${String(decade)}s`;
                elDecadeCount.textContent = Number.isFinite(decadeWatches) ? String(decadeWatches) : '0';

                elActor.textContent = actorName || '';
                elActorCount.textContent = Number.isFinite(actorWatches) ? String(actorWatches) : '0';

                elDirector.textContent = directorName || '';
                elDirectorCount.textContent = Number.isFinite(directorWatches) ? String(directorWatches) : '0';

                elHighDirector.textContent = highDirectorName || '';
                elHighDirectorAvg.textContent = Number.isFinite(highDirectorAvg) ? String(highDirectorAvg) : '0';
                elHighDirectorN.textContent = Number.isFinite(highDirectorN) ? String(highDirectorN) : '0';

                elAtHome.textContent = Number.isFinite(atHome) ? String(atHome) : '0';
                elInTheater.textContent = Number.isFinite(inTheater) ? String(inTheater) : '0';

                const tierColors = {
                    'S': 'rgba(var(--tier-s-rgb), 0.35)',
                    'A': 'rgba(var(--tier-a-rgb), 0.35)',
                    'B': 'rgba(var(--tier-b-rgb), 0.35)',
                    'C': 'rgba(var(--tier-c-rgb), 0.35)',
                    'D': 'rgba(var(--tier-d-rgb), 0.35)',
                    'F': 'rgba(var(--tier-f-rgb), 0.35)',
                };

                elTierBars.innerHTML = tierDist.map((t) => {
                    const tier = String(t?.tier ?? '').trim() || '';
                    const pct = Number(t?.pct ?? 0);
                    const count = Number(t?.count ?? 0);
                    const width = Number.isFinite(pct) ? Math.max(0, Math.min(100, pct)) : 0;
                    const bg = tierColors[tier.toUpperCase()] || 'rgba(255,255,255,0.10)';
                    const tierLetter = String(tier || '').trim().toUpperCase();
                    const tierText = /^[SABCDF]$/.test(tierLetter)
                        ? `Tier <span class=\"dash-help-tier\" data-tier-letter=\"${escapeHtml(tierLetter)}\">${escapeHtml(tierLetter)}</span>`
                        : `Tier ${escapeHtml(tier)}`;
                    return `
                        <div style="min-width: 140px; flex: 1;">
                            <div class="flex justify-between" style="margin-bottom: 6px;">
                                <span class="text-xs text-gray">${tierText}</span>
                                <span class="text-xs text-gray">${Number.isFinite(pct) ? pct.toFixed(1) : '0.0'}% (${Number.isFinite(count) ? count : 0})</span>
                            </div>
                            <div style="height: 10px; background: rgba(255,255,255,0.06); border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06);">
                                <div style="height: 100%; width: ${width}%; background: ${bg};"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                // Quiet failure; keep placeholders.
                elUnique.textContent = '';
                elHours.textContent = '';
                elAvg.textContent = '';
                elGenre.textContent = '';
                elGenreCount.textContent = '';
                elGenreAvg.textContent = '';

                elTopMovieTitle.textContent = '';
                elTopMovieRating.textContent = '';
                elWatchEventsYear.textContent = '';
                elWatchEventsAll.textContent = '';

                elDecade.textContent = '';
                elDecadeCount.textContent = '';
                elActor.textContent = '';
                elActorCount.textContent = '';
                elDirector.textContent = '';
                elDirectorCount.textContent = '';

                elHighDirector.textContent = '';
                elHighDirectorAvg.textContent = '';
                elHighDirectorN.textContent = '';

                elAtHome.textContent = '';
                elInTheater.textContent = '';

                elTierBars.innerHTML = '';
            }
        }

        function initDashboardTabs() {
            const wrap = document.getElementById('dash-tab-general')?.parentElement;
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-tab]') : null;
                const tab = btn?.dataset?.tab;
                if (!tab) return;
                setDashboardTab(tab);
            });
        }

        let dashboardTimeframe = 'all_time';
        let dashboardActiveTab = 'general';
        let dashboardAuthWarned = false;
        let dashboardFavoritesMetric = 'overall';

        let dashboardGeneralLastData = null;
        let dashboardKpiDetailState = null;

        const dashPosterCacheByTmdbId = new Map();
        const dashRatingCacheByMovieId = new Map();

        function dashNormalizePosterPath(p) {
            const raw = String(p ?? '').trim();
            if (!raw) return '';
            // Allow full URLs (future-proof).
            if (raw.startsWith('http://') || raw.startsWith('https://')) return raw;
            // TMDb poster_path should be "/abc.jpg" but some sources may provide "abc.jpg".
            return raw.startsWith('/') ? raw : `/${raw}`;
        }

        function dashBuildPosterUrl(posterPath, size = 'w342') {
            const normalized = dashNormalizePosterPath(posterPath);
            if (!normalized) return '';
            if (normalized.startsWith('http://') || normalized.startsWith('https://')) return normalized;
            return `https://image.tmdb.org/t/p/${String(size || 'w342')}${normalized}`;
        }

        async function dashEnsurePosterPath(item) {
            // 1) If the item already has a poster path, use it (no DB needed).
            const direct = dashNormalizePosterPath(item?.poster_path ?? item?.posterPath ?? item?.poster_url ?? item?.posterUrl ?? '');
            if (direct) return direct;

            const tmdb_id = Number(item?.tmdb_id);
            if (Number.isFinite(tmdb_id) && tmdb_id > 0) {
                if (dashPosterCacheByTmdbId.has(tmdb_id)) return dashPosterCacheByTmdbId.get(tmdb_id);
            }

            // Prefer DB if the movie exists there; never call TMDb here.
            if (!supabaseClient) {
                if (Number.isFinite(tmdb_id) && tmdb_id > 0) dashPosterCacheByTmdbId.set(tmdb_id, null);
                return null;
            }

            const movie_id = String(item?.movie_id ?? item?.movieId ?? item?.id ?? '').trim();

            // 2) DB lookup by movie_id (most reliable in this app)
            if (isUuidLike(movie_id)) {
                try {
                    const { data, error } = await supabaseClient
                        .from('Movies')
                        .select('tmdb_id, poster_path')
                        .eq('id', movie_id)
                        .maybeSingle();
                    if (error) throw error;

                    const pRaw = String(data?.poster_path || '').trim();
                    const p = pRaw ? (dashNormalizePosterPath(pRaw) || null) : null;
                    const tmdbFromDb = Number(data?.tmdb_id);
                    if (Number.isFinite(tmdbFromDb) && tmdbFromDb > 0) dashPosterCacheByTmdbId.set(tmdbFromDb, p);
                    if (Number.isFinite(tmdb_id) && tmdb_id > 0) dashPosterCacheByTmdbId.set(tmdb_id, p);
                    return p;
                } catch (_) {
                    if (Number.isFinite(tmdb_id) && tmdb_id > 0) dashPosterCacheByTmdbId.set(tmdb_id, null);
                    return null;
                }
            }

            // 3) DB lookup by tmdb_id fallback
            if (!Number.isFinite(tmdb_id) || tmdb_id <= 0) return null;
            try {
                const { data, error } = await supabaseClient
                    .from('Movies')
                    .select('poster_path')
                    .eq('tmdb_id', tmdb_id)
                    .maybeSingle();
                if (error) throw error;
                const pRaw = String(data?.poster_path || '').trim();
                const p = pRaw ? (dashNormalizePosterPath(pRaw) || null) : null;
                dashPosterCacheByTmdbId.set(tmdb_id, p);
                return p;
            } catch (_) {
                dashPosterCacheByTmdbId.set(tmdb_id, null);
                return null;
            }
        }

        function dashFormatScore(n) {
            const num = Number(n);
            if (!Number.isFinite(num)) return '';
            const rounded = Math.round(num * 10) / 10;
            if (Math.abs(rounded - Math.round(rounded)) < 1e-9) return `${Math.round(rounded)}%`;
            return `${rounded.toFixed(1)}%`;
        }

        function dashNormalizeTierLabel(tierRaw) {
            const t = String(tierRaw ?? '').trim();
            if (!t) return '';
            const u = t.toUpperCase();
            if (u === 'UNRANKED') return 'Unranked';
            if (/^[SABCDF]$/i.test(t)) return `${u}-Tier`;
            if (/^[SABCDF]\s*-?\s*TIER$/i.test(t)) return `${u[0]}-Tier`;
            return t;
        }

        function dashTierLetterFromLabel(label) {
            const raw = String(label ?? '').trim();
            if (!raw) return '';
            const upper = raw.toUpperCase();
            if (upper === 'UNRANKED') return '';
            const m = upper.match(/^([SABCDF])/);
            return m ? m[1] : '';
        }

        function dashRenderHelpScore(scoreText) {
            const s = String(scoreText ?? '').trim();
            if (!s) return '';
            return `<span class="dash-help-score tabular-nums">${escapeHtml(s)}</span>`;
        }

        function dashRenderHelpTier(tierLabel) {
            const t = String(tierLabel ?? '').trim();
            if (!t) return '';
            const letter = dashTierLetterFromLabel(t);
            const attr = letter ? ` data-tier-letter="${escapeHtml(letter)}"` : '';
            return `<span class="dash-help-tier"${attr}>${escapeHtml(t)}</span>`;
        }

        function dashJoinHelpParts(parts) {
            return (Array.isArray(parts) ? parts : []).filter(Boolean).join('  ');
        }

        function openFeedAuthWarning() {
            const el = document.getElementById('feed-auth-warning');
            if (!el) return;
            el.style.display = 'flex';
        }

        function closeFeedAuthWarning() {
            const el = document.getElementById('feed-auth-warning');
            if (!el) return;
            el.style.display = 'none';
        }

        function openLibraryAuthWarning() {
            const el = document.getElementById('library-auth-warning');
            if (!el) return;
            el.style.display = 'flex';
        }

        function closeLibraryAuthWarning() {
            const el = document.getElementById('library-auth-warning');
            if (!el) return;
            el.style.display = 'none';
        }

        function openListsAuthWarning() {
            const el = document.getElementById('lists-auth-warning');
            if (!el) return;
            el.style.display = 'flex';
        }

        function closeListsAuthWarning() {
            const el = document.getElementById('lists-auth-warning');
            if (!el) return;
            el.style.display = 'none';
        }

        let listsBound = false;
        let listsLoading = false;
        let listsActiveListId = null;
        let listsActiveListName = '';
        let cachedLists = [];
        let cachedListsUserId = null;

        let listsMoviePrefillById = new Map();

        let cachedBucketListId = null;
        let bucketListEnsuredForUserId = null;

        let listPickerSelectedMovie = null;
        let listPickerBusy = false;
        let listsCreateBusy = false;

        function closeListPickerModal() {
            const overlay = document.getElementById('list-picker-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';

            const statusEl = document.getElementById('list-picker-status');
            if (statusEl) statusEl.textContent = '';
            const nameEl = document.getElementById('list-picker-new-name');
            if (nameEl) nameEl.value = '';
            listPickerSelectedMovie = null;
            listPickerBusy = false;
        }

        function openListsCreateModal() {
            const overlay = document.getElementById('lists-create-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';

            const statusEl = document.getElementById('lists-create-status');
            if (statusEl) statusEl.textContent = '';
            const input = document.getElementById('lists-create-name');
            if (input) {
                input.value = '';
                try { input.focus(); } catch (_) {}
            }
            listsCreateBusy = false;
        }

        function closeListsCreateModal() {
            const overlay = document.getElementById('lists-create-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';
            const statusEl = document.getElementById('lists-create-status');
            if (statusEl) statusEl.textContent = '';
            const input = document.getElementById('lists-create-name');
            if (input) input.value = '';
            listsCreateBusy = false;
        }

        async function ensureBucketListForUser({ user_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            if (!uid) throw new Error('Missing user_id.');

            if (bucketListEnsuredForUserId === uid && cachedBucketListId) return cachedBucketListId;

            const row = { user_id: uid, list_name: 'Bucket List' };
            const { data, error } = await supabaseClient
                .from('Lists')
                .upsert(row, { onConflict: 'user_id,list_name' })
                .select('id, list_name')
                .single();

            if (error) throw error;
            cachedBucketListId = data?.id || null;
            bucketListEnsuredForUserId = uid;
            return cachedBucketListId;
        }

        function normalizeListName(name) {
            const s = String(name ?? '').trim();
            if (!s) return '';
            return s.replace(/\s+/g, ' ').trim();
        }

        async function loadUserLists({ user_id, force = false } = {}) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            if (!uid) throw new Error('Missing user_id.');

            if (!force && cachedListsUserId === uid && Array.isArray(cachedLists) && cachedLists.length) {
                return cachedLists;
            }

            const { data, error } = await supabaseClient
                .from('Lists')
                .select('id, list_name, created_at')
                .eq('user_id', uid)
                .order('created_at', { ascending: true });
            if (error) throw error;

            const rows = Array.isArray(data) ? data : [];
            rows.sort((a, b) => {
                const an = String(a?.list_name || '').toLowerCase();
                const bn = String(b?.list_name || '').toLowerCase();
                if (an === 'bucket list' && bn !== 'bucket list') return -1;
                if (bn === 'bucket list' && an !== 'bucket list') return 1;
                return 0;
            });

            cachedLists = rows;
            cachedListsUserId = uid;

            const bucket = rows.find(r => String(r?.list_name || '').toLowerCase() === 'bucket list');
            if (bucket?.id) {
                cachedBucketListId = bucket.id;
                bucketListEnsuredForUserId = uid;
            }

            return cachedLists;
        }

        async function createUserList({ user_id, list_name }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            const name = normalizeListName(list_name);
            if (!uid) throw new Error('Missing user_id.');
            if (!name) throw new Error('List name is required.');

            const { data, error } = await supabaseClient
                .from('Lists')
                .insert({ user_id: uid, list_name: name })
                .select('id, list_name, created_at')
                .single();

            if (error) throw error;
            return data;
        }

        async function addMovieToList({ user_id, list_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            const lid = String(list_id || '').trim();
            const mid = String(movie_id || '').trim();
            if (!uid) throw new Error('Missing user_id.');
            if (!lid) throw new Error('Missing list_id.');
            if (!mid) throw new Error('Missing movie_id.');

            const { error } = await supabaseClient
                .from('Movie Lists')
                .insert({ user_id: uid, list_id: lid, movie_id: mid });

            if (error) throw error;
        }

        async function removeMovieFromList({ user_id, list_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            const lid = String(list_id || '').trim();
            const mid = String(movie_id || '').trim();
            if (!uid || !lid || !mid) return;

            const { error } = await supabaseClient
                .from('Movie Lists')
                .delete()
                .eq('user_id', uid)
                .eq('list_id', lid)
                .eq('movie_id', mid);
            if (error) throw error;
        }

        async function removeMovieFromBucketList({ user_id, movie_id }) {
            const uid = String(user_id || '').trim();
            const mid = String(movie_id || '').trim();
            if (!uid || !mid) return;

            let bucketId = cachedBucketListId;
            try {
                bucketId = await ensureBucketListForUser({ user_id: uid });
            } catch (_) {}
            if (!bucketId) return;

            await removeMovieFromList({ user_id: uid, list_id: bucketId, movie_id: mid });
        }

        async function openAddToListModal() {
            if (!supabaseClient) {
                showToast('Supabase SDK failed to load.', { level: 'warn' });
                return;
            }

            let authedUser = null;
            let accessToken = null;
            try {
                const res = await requireAuthOrThrow();
                authedUser = res.user;
                accessToken = res.accessToken;
            } catch (_) {
                openAuthModal();
                return;
            }

            const picked = router?.selectedMovie || null;
            if (!picked) {
                showToast('Select a movie first.', { level: 'warn' });
                return;
            }

            const title = String(picked?.title || '').trim();
            const year = Number(picked?.year ?? picked?.release_year ?? null);
            const tmdbId = Number(picked?.tmdb_id ?? picked?.tmdbId ?? picked?.id ?? null);
            const existingDbMovieId = (isUuidLike(picked?.id) ? String(picked.id).trim() : '');

            listPickerSelectedMovie = {
                title,
                year: Number.isFinite(year) ? year : null,
                tmdb_id: Number.isFinite(tmdbId) ? tmdbId : null,
                db_movie_id: existingDbMovieId || null,
                accessToken,
                user_id: authedUser.id,
            };

            const overlay = document.getElementById('list-picker-overlay');
            if (overlay) overlay.style.display = 'flex';

            const movieEl = document.getElementById('list-picker-movie');
            if (movieEl) {
                movieEl.textContent = title ? `Movie: ${title}${(Number.isFinite(year) && year > 0) ? ` (${year})` : ''}` : 'Movie: (unknown)';
            }

            await ensureBucketListForUser({ user_id: authedUser.id }).catch(() => null);
            const lists = await loadUserLists({ user_id: authedUser.id, force: true }).catch(() => []);
            renderListPickerLists(lists);
        }

        function renderListPickerLists(lists) {
            const el = document.getElementById('list-picker-lists');
            if (!el) return;
            const rows = Array.isArray(lists) ? lists : [];
            if (rows.length === 0) {
                el.innerHTML = `<div class="text-gray">No lists yet.</div>`;
                return;
            }
            el.innerHTML = rows
                .map((l) => {
                    const name = String(l?.list_name || '').trim() || 'Untitled';
                    const id = String(l?.id || '').trim();
                    if (!id) return '';
                    const isBucket = name.toLowerCase() === 'bucket list';
                    return `
                        <button
                            type="button"
                            class="btn ${isBucket ? 'btn-primary' : 'btn-glass'}"
                            data-list-picker-action="add"
                            data-list-id="${escapeHtml(id)}"
                            style="width:100%; display:flex; justify-content: space-between; align-items: center; border-radius: 0.85rem;"
                        >
                            <span style="font-weight: 800;">${escapeHtml(name)}</span>
                            <span style="opacity: 0.8;">Add</span>
                        </button>
                    `;
                })
                .filter(Boolean)
                .join('');
        }

        async function ensureMovieFullySyncedForLists({ accessToken, title, release_year, tmdb_id, movie_id }) {
            const token = String(accessToken || '').trim();
            if (!token) throw new Error('Missing access token.');

            const uuidLike = isUuidLike;
            let dbMovieId = uuidLike(movie_id) ? String(movie_id).trim() : null;

            if (!dbMovieId && Number.isFinite(Number(tmdb_id)) && Number(tmdb_id) > 0) {
                try {
                    const mapped = await getDbMovieIdByTmdbId(Number(tmdb_id));
                    if (uuidLike(mapped)) dbMovieId = mapped;
                } catch (_) {}
            }

            if (dbMovieId) {
                const res = await callSwiftApi({ movie_id: dbMovieId, sync_people: true }, token);
                const outId = res?.movie_id || dbMovieId;
                return String(outId || '').trim();
            }

            const t = String(title || '').trim();
            const y = (release_year === null || release_year === undefined) ? null : Number(release_year);
            if (!t) throw new Error('Missing movie title.');

            const res = await callSwiftApi({ title: t, release_year: Number.isFinite(y) ? y : null, sync_people: true }, token);
            return String(res?.movie_id || '').trim();
        }

        async function handleListPickerAddToList(list_id) {
            if (listPickerBusy) return;
            const lid = String(list_id || '').trim();
            if (!lid) return;

            if (!listPickerSelectedMovie) {
                showToast('No movie selected.', { level: 'warn' });
                return;
            }

            const statusEl = document.getElementById('list-picker-status');
            const setStatus = (s) => {
                if (statusEl) statusEl.textContent = String(s || '');
            };

            listPickerBusy = true;
            setStatus('Syncing movie metadata');

            try {
                const uid = String(listPickerSelectedMovie.user_id || '').trim();
                const accessToken = String(listPickerSelectedMovie.accessToken || '').trim();

                const ensuredMovieId = await ensureMovieFullySyncedForLists({
                    accessToken,
                    title: listPickerSelectedMovie.title,
                    release_year: listPickerSelectedMovie.year,
                    tmdb_id: listPickerSelectedMovie.tmdb_id,
                    movie_id: listPickerSelectedMovie.db_movie_id,
                });

                if (!ensuredMovieId) throw new Error('Failed to ensure movie exists.');
                setStatus('Adding to list');

                try {
                    await addMovieToList({ user_id: uid, list_id: lid, movie_id: ensuredMovieId });
                } catch (err) {
                    const msg = String(err?.message || err);
                    if (/duplicate|unique/i.test(msg)) {
                        showToast('Already in that list.', { level: 'warn' });
                        closeListPickerModal();
                        return;
                    }
                    throw err;
                }

                showToast('Added to list!', { level: 'success' });

                // Refresh lists page if it's open.
                if (router?.currentPage === 'lists') {
                    await loadListsPage({ reset: false });
                }

                closeListPickerModal();
            } catch (err) {
                setStatus('');
                showToast(`Add to list failed: ${String(err?.message || err)}`, { level: 'warn' });
            } finally {
                listPickerBusy = false;
            }
        }

        function initListsPage() {
            if (listsBound) return;
            listsBound = true;

            document.addEventListener('click', (e) => {
                const el = e?.target?.closest ? e.target.closest('[data-lists-action]') : null;
                if (!el) return;
                const action = String(el.dataset.listsAction || '').trim();
                if (!action) return;

                if (action === 'refresh') {
                    (async () => {
                        await loadListsPage({ reset: true });
                    })().catch(() => {});
                    return;
                }

                if (action === 'open_movie') {
                    const mid = String(el.dataset.movieId || '').trim();
                    if (!mid) return;

                    (async () => {
                        const prefill = listsMoviePrefillById.get(mid) || null;
                        if (!prefill) {
                            showToast('Movie details not available yet. Try Refresh.', { level: 'warn' });
                            return;
                        }

                        // Decide whether to open fully-populated Log New Entry (no existing rating)
                        // or fully-populated Update Ratings (existing rating).
                        let authedUser = null;
                        try {
                            const res = await requireAuthOrThrow();
                            authedUser = res.user;
                        } catch (_) {
                            openAuthModal();
                            return;
                        }

                        const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id: mid });

                        // Start from our cached DB prefill, but route through the existing flows
                        // so MPA/Runtime/Series and rating fields are always filled correctly.
                        router.selectedMovie = { ...prefill, id: mid, detailsReadonly: false };
                        router.pendingTitle = String(prefill?.title || '').trim();

                        if (alreadyRated) {
                            await router.startUpdateRatings();
                        } else {
                            await router.startNewEntry();
                        }
                    })().catch((err) => {
                        showToast(`Open entry failed: ${String(err?.message || err)}`, { level: 'warn' });
                    });
                    return;
                }

                if (action === 'remove_movie') {
                    const lid = String(el.dataset.listId || '').trim();
                    const mid = String(el.dataset.movieId || '').trim();
                    if (!lid || !mid) return;

                    (async () => {
                        let authedUser = null;
                        try {
                            const { user } = await requireAuthOrThrow();
                            authedUser = user;
                        } catch (_) {
                            openAuthModal();
                            return;
                        }

                        try {
                            await removeMovieFromList({ user_id: authedUser.id, list_id: lid, movie_id: mid });
                            showToast('Removed.', { level: 'success' });
                            await loadListsPage({ reset: false });
                        } catch (err) {
                            showToast(`Remove failed: ${String(err?.message || err)}`, { level: 'warn' });
                        }
                    })().catch(() => {});
                }
            }, { capture: true });

            document.addEventListener('change', async (e) => {
                const sel = e?.target?.closest ? e.target.closest('#lists-select') : null;
                if (!sel) return;
                const lid = String(sel.value || '').trim();
                if (!lid) return;
                listsActiveListId = lid;
                const label = String(sel.selectedOptions?.[0]?.textContent || '').trim();
                if (label) listsActiveListName = label;

                // Reset the quick-add search UI when changing lists.
                try {
                    const input = document.getElementById('lists-movie-search-input');
                    if (input) input.value = '';
                    clearListsSearchUI();
                    setListsQuickAddEnabledState();
                } catch (_) {}

                await loadListsPage({ reset: false });
            }, { capture: true });

            document.addEventListener('click', async (e) => {
                const el = e?.target?.closest ? e.target.closest('[data-list-picker-action]') : null;
                if (!el) return;
                const action = String(el.dataset.listPickerAction || '').trim();
                if (action !== 'add') return;
                const lid = String(el.dataset.listId || '').trim();
                if (!lid) return;
                await handleListPickerAddToList(lid);
            }, { capture: true });

            const createForm = document.getElementById('list-picker-create-form');
            if (createForm) {
                createForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (listPickerBusy) return;

                    const statusEl = document.getElementById('list-picker-status');
                    const nameEl = document.getElementById('list-picker-new-name');
                    const setStatus = (s) => { if (statusEl) statusEl.textContent = String(s || ''); };

                    let authedUser = null;
                    let accessToken = null;
                    try {
                        const res = await requireAuthOrThrow();
                        authedUser = res.user;
                        accessToken = res.accessToken;
                    } catch (_) {
                        openAuthModal();
                        return;
                    }

                    const name = normalizeListName(nameEl?.value || '');
                    if (!name) {
                        setStatus('List name is required.');
                        return;
                    }

                    if (!listPickerSelectedMovie) {
                        setStatus('Select a movie first.');
                        return;
                    }

                    listPickerBusy = true;
                    setStatus('Creating list');

                    try {
                        const newList = await createUserList({ user_id: authedUser.id, list_name: name });
                        cachedListsUserId = null;

                        setStatus('Syncing movie metadata');
                        const ensuredMovieId = await ensureMovieFullySyncedForLists({
                            accessToken,
                            title: listPickerSelectedMovie.title,
                            release_year: listPickerSelectedMovie.year,
                            tmdb_id: listPickerSelectedMovie.tmdb_id,
                            movie_id: listPickerSelectedMovie.db_movie_id,
                        });

                        if (!ensuredMovieId) throw new Error('Failed to ensure movie exists.');
                        setStatus('Adding to list');
                        await addMovieToList({ user_id: authedUser.id, list_id: newList.id, movie_id: ensuredMovieId });

                        showToast('Created list and added movie!', { level: 'success' });
                        closeListPickerModal();
                    } catch (err) {
                        const msg = String(err?.message || err);
                        if (/duplicate|unique/i.test(msg)) {
                            setStatus('You already have a list with that name.');
                            return;
                        }
                        setStatus('');
                        showToast(`Create/add failed: ${msg}`, { level: 'warn' });
                    } finally {
                        listPickerBusy = false;
                    }
                }, { capture: true });
            }

            const listsCreateForm = document.getElementById('lists-create-form');
            if (listsCreateForm) {
                listsCreateForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (listsCreateBusy) return;

                    const statusEl = document.getElementById('lists-create-status');
                    const nameEl = document.getElementById('lists-create-name');
                    const setStatus = (s) => { if (statusEl) statusEl.textContent = String(s || ''); };

                    const name = normalizeListName(nameEl?.value || '');
                    if (!name) {
                        setStatus('List name is required.');
                        return;
                    }

                    let authedUser = null;
                    try {
                        const { user } = await requireAuthOrThrow();
                        authedUser = user;
                    } catch (_) {
                        setStatus('Please log in first.');
                        openAuthModal();
                        return;
                    }

                    listsCreateBusy = true;
                    setStatus('Saving');

                    try {
                        const created = await createUserList({ user_id: authedUser.id, list_name: name });
                        cachedListsUserId = null;

                        // Auto-select the newly created list.
                        if (created?.id) {
                            listsActiveListId = String(created.id);
                            listsActiveListName = String(created?.list_name || name).trim();
                        }

                        closeListsCreateModal();
                        await loadListsPage({ reset: true });
                        showToast('List created!', { level: 'success' });
                    } catch (err) {
                        const msg = String(err?.message || err);
                        if (/duplicate|unique/i.test(msg)) {
                            setStatus('You already have a list with that name.');
                            return;
                        }
                        setStatus('');
                        showToast(`Create list failed: ${msg}`, { level: 'warn' });
                    } finally {
                        listsCreateBusy = false;
                    }
                }, { capture: true });
            }
        }

        async function loadListsPage({ reset = true } = {}) {
            const elLists = document.getElementById('lists-list');
            const elItems = document.getElementById('lists-items');
            const elTitle = document.getElementById('lists-active-title');
            const elSub = document.getElementById('lists-active-subtitle');
            if (!elLists || !elItems) return;

            listsMoviePrefillById = new Map();

            if (!supabaseClient || !cachedIsAuthed) {
                elLists.innerHTML = `<div class="text-gray">Log in to view your lists.</div>`;
                elItems.innerHTML = `<div class="text-gray">Log in to view your lists.</div>`;
                if (elTitle) elTitle.textContent = 'Lists';
                if (elSub) elSub.textContent = '';
                try { setListsQuickAddEnabledState(); } catch (_) {}
                return;
            }

            if (listsLoading) return;
            listsLoading = true;
            if (reset) {
                elLists.innerHTML = `<div class="text-gray">Loading</div>`;
                elItems.innerHTML = `<div class="text-gray">Loading</div>`;
            }

            try {
                const { user } = await requireAuthOrThrow();

                await ensureBucketListForUser({ user_id: user.id }).catch(() => null);
                const lists = await loadUserLists({ user_id: user.id, force: true });

                if (!listsActiveListId) {
                    listsActiveListId = cachedBucketListId || (lists[0]?.id || null);
                }

                const active = lists.find(l => String(l?.id || '') === String(listsActiveListId || '')) || null;
                listsActiveListName = String(active?.list_name || listsActiveListName || '').trim();

                elLists.innerHTML = lists.length
                    ? `
                        <select id="lists-select" class="input-field" style="width:100%; border-radius: 0.85rem;">
                            ${lists.map((l) => {
                                const id = String(l?.id || '').trim();
                                const name = String(l?.list_name || '').trim() || 'Untitled';
                                if (!id) return '';
                                const selected = (String(listsActiveListId || '') === id) ? 'selected' : '';
                                return `<option value="${escapeHtml(id)}" ${selected}>${escapeHtml(name)}</option>`;
                            }).filter(Boolean).join('')}
                        </select>
                    `
                    : `
                        <select id="lists-select" class="input-field" style="width:100%; border-radius: 0.85rem;" disabled>
                            <option value="">No lists found</option>
                        </select>
                    `;

                if (elTitle) elTitle.textContent = listsActiveListName || 'List';
                if (elSub) elSub.textContent = '';
                try { setListsQuickAddEnabledState(); } catch (_) {}

                if (!listsActiveListId) {
                    elItems.innerHTML = `<div class="text-gray">Create a list to get started.</div>`;
                    try { setListsQuickAddEnabledState(); } catch (_) {}
                    return;
                }

                const { data: joins, error: joinErr } = await supabaseClient
                    .from('Movie Lists')
                    .select('movie_id, created_at')
                    .eq('user_id', user.id)
                    .eq('list_id', listsActiveListId)
                    .order('created_at', { ascending: false });
                if (joinErr) throw joinErr;

                const joinRows = Array.isArray(joins) ? joins : [];
                const movieIds = joinRows.map(r => r?.movie_id).filter(Boolean);
                if (movieIds.length === 0) {
                    elItems.innerHTML = `<div class="text-gray">No movies in this list yet.</div>`;
                    try { setListsQuickAddEnabledState(); } catch (_) {}
                    return;
                }

                const { data: movies, error: moviesErr } = await supabaseClient
                    .from('Movies')
                    .select('*')
                    .in('id', movieIds);
                if (moviesErr) throw moviesErr;

                const moviesById = new Map();
                for (const m of (Array.isArray(movies) ? movies : [])) {
                    if (m?.id) moviesById.set(m.id, m);
                }

                const cards = movieIds
                    .map((id) => {
                        const movie = moviesById.get(id) || null;
                        const title = String(movie?.title || '').trim() || 'Untitled';
                        const year = (movie?.release_year === null || movie?.release_year === undefined) ? '' : String(movie.release_year);
                        const tmdb_id = Number(movie?.tmdb_id);
                        const poster_path = String(movie?.poster_path || '').trim();
                        const posterUrl = poster_path ? `https://image.tmdb.org/t/p/w500${poster_path.startsWith('/') ? poster_path : `/${poster_path}`}` : '';

                        const directorVal = normalizeMovieFieldValue(movie?.director ?? movie?.director_name);
                        const genreVal = (() => {
                            if (Array.isArray(movie?.genres) && movie.genres.length) {
                                return normalizeMovieFieldValue(movie.genres.map(s => String(s).trim()).filter(Boolean).join(', '));
                            }
                            return normalizeMovieFieldValue(movie?.genre);
                        })();
                        const imdbVal = (() => {
                            const raw = (movie?.imdb_rating_pct ?? movie?.imdb_pct ?? movie?.imdb_rating ?? movie?.imdb);
                            const n = parsePercentLike(raw, { imdb: true });
                            return (n !== null && n !== undefined) ? formatPctForDisplay(n) : '';
                        })();

                        const mpaVal = normalizeMovieFieldValue(movie?.mpa_rating ?? movie?.mpa);

                        const metaLines = [];
                        if (directorVal) metaLines.push({ label: 'Director', value: directorVal });
                        if (genreVal) metaLines.push({ label: 'Genres', value: genreVal });
                        if (imdbVal) metaLines.push({ label: 'IMDb', value: imdbVal });

                        // Cache a prefill object for poster-click navigation to the Log New Entry flow.
                        listsMoviePrefillById.set(String(id), {
                            ...(movie || {}),
                            id: String(id),
                            title,
                            year: year || null,
                            release_year: movie?.release_year ?? null,
                            director: directorVal || normalizeMovieFieldValue(movie?.director ?? movie?.director_name) || '',
                            genre: genreVal || normalizeMovieFieldValue(movie?.genre) || '',
                            imdb: imdbVal || '',
                            tmdb_id: Number.isFinite(tmdb_id) ? tmdb_id : undefined,
                            poster_path: poster_path || movie?.posterPath || movie?.poster_url || movie?.posterUrl || '',
                            mpa: String(movie?.mpa_rating ?? movie?.mpa ?? '').trim(),
                            runtime: (() => {
                                const n = Number(movie?.runtime_minutes ?? movie?.runtime);
                                return Number.isFinite(n) ? n : (movie?.runtime_minutes ?? movie?.runtime ?? null);
                            })(),
                            isSeries: (movie?.is_series ?? movie?.isSeries) === true,
                            detailsReadonly: false,
                        });

                        return `
                            <div class="lists-movie-card">
                                <button type="button" class="lists-poster-btn" data-lists-action="open_movie" data-movie-id="${escapeHtml(String(id))}" title="Open entry">
                                    <div class="lists-poster">
                                        ${posterUrl
                                            ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" onerror="this.style.display='none';">`
                                            : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`}
                                    </div>
                                </button>

                                <div>
                                    <div class="lists-title">
                                        ${escapeHtml(title)}${year ? ` <span class="lists-title-year">(${escapeHtml(year)})</span>` : ''}${mpaVal ? ` <span class="lists-title-year">- ${escapeHtml(mpaVal)}</span>` : ''}
                                    </div>
                                    ${metaLines.length ? `
                                        <div class="lists-meta-list">
                                            ${metaLines.map(({ label, value }) => (
                                                `<div class="lists-meta-item"><span class="lists-bullet"></span><span>${escapeHtml(label)}: ${escapeHtml(value)}</span></div>`
                                            )).join('')}
                                        </div>
                                    ` : ''}

                                    <div class="lists-card-actions">
                                        <button type="button" class="btn btn-outline" data-lists-action="remove_movie" data-list-id="${escapeHtml(String(listsActiveListId))}" data-movie-id="${escapeHtml(String(id))}" style="border-radius: 0.85rem; padding: 0.5rem 0.75rem;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    })
                    .join('');

                elItems.innerHTML = `<div class="lists-grid">${cards}</div>`;
            } catch (err) {
                const msg = String(err?.message || err);
                elLists.innerHTML = `<div class="text-gray">Failed to load lists: ${escapeHtml(msg)}</div>`;
                elItems.innerHTML = `<div class="text-gray">Failed to load list items.</div>`;
            } finally {
                try { setListsQuickAddEnabledState(); } catch (_) {}
                listsLoading = false;
            }
        }

        let feedBound = false;
        let feedFollowingIds = new Set();
        let feedLastSearchQuery = '';
        let feedSortMode = 'watch_date'; // 'updated_at' | 'watch_date'

        let libraryBound = false;
        let libraryOffset = 0;
        const libraryLimit = 25;
        let libraryHasMore = true;
        let libraryLoading = false;

        const LIBRARY_LATEST_WATCH_VIEW = 'user_movie_latest_watch';
        const LIBRARY_ITEMS_VIEW = 'user_library_items_v2';
        let libraryItems = [];
        let libraryFacetsLoaded = false;

        // (director filter is applied via modal Save)

        function formatFeedTimestamp(ts) {
            if (!ts) return '';
            const d = new Date(ts);
            if (Number.isNaN(d.getTime())) return '';
            try {
                return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            } catch (_) {
                return String(ts);
            }
        }

        function initFeedPage() {
            if (feedBound) return;
            feedBound = true;

            document.addEventListener('click', (e) => {
                const card = e?.target?.closest ? e.target.closest('[data-feed-card]') : null;
                if (!card) return;

                // Don't toggle when clicking buttons/controls.
                const actionEl = e?.target?.closest ? e.target.closest('[data-feed-action]') : null;
                if (actionEl) return;

                card.classList.toggle('is-open');
            });

            document.addEventListener('click', async (e) => {
                const btn = e?.target?.closest ? e.target.closest('[data-feed-action]') : null;
                if (!btn) return;
                const action = String(btn.dataset.feedAction || '').trim();
                const targetUserId = String(btn.dataset.feedUserId || '').trim();
                if (!action) return;

                if (action === 'refresh') {
                    await loadFeedPage();
                    return;
                }

                if (action === 'set_sort') {
                    const mode = String(btn.dataset.feedSortMode || '').trim();
                    feedSortMode = (mode === 'watch_date') ? 'watch_date' : 'updated_at';
                    syncFeedSortUI();
                    await loadFeedItems();
                    return;
                }

                if (!supabaseClient) {
                    showToast('Supabase SDK failed to load.', { level: 'warn' });
                    return;
                }

                let authedUser = null;
                try {
                    const { user } = await requireAuthOrThrow();
                    authedUser = user;
                } catch (err) {
                    showToast(String(err?.message || err), { level: 'warn' });
                    return;
                }

                if (!targetUserId) return;
                if (targetUserId === authedUser.id) {
                    showToast('You cannot follow yourself.', { level: 'warn' });
                    return;
                }

                try {
                    if (action === 'follow') {
                        const { error } = await supabaseClient
                            .from('Follows')
                            .insert({ follower_id: authedUser.id, followed_id: targetUserId });
                        if (error) throw error;
                        showToast('Followed!', { level: 'success' });
                    }

                    if (action === 'unfollow') {
                        const { error } = await supabaseClient
                            .from('Follows')
                            .delete()
                            .eq('follower_id', authedUser.id)
                            .eq('followed_id', targetUserId);
                        if (error) throw error;
                        showToast('Unfollowed.', { level: 'success' });
                    }

                    await loadMyFollowingIds();
                    await loadFeedFollowingList();
                    await loadFeedItems();
                    if (feedLastSearchQuery) {
                        await searchFeedUsers(feedLastSearchQuery);
                    }
                } catch (err) {
                    const msg = String(err?.message || err);
                    // Common duplicate follow error
                    if (/duplicate|unique/i.test(msg)) {
                        showToast('You are already following that user.', { level: 'warn' });
                        return;
                    }
                    showToast(`Feed action failed: ${msg}`, { level: 'warn' });
                }
            }, { capture: true });
        }

        function initLibraryPage() {
            if (libraryBound) return;
            libraryBound = true;

            document.addEventListener('click', async (e) => {
                const btn = e?.target?.closest ? e.target.closest('[data-library-action]') : null;
                if (!btn) return;
                const action = String(btn.dataset.libraryAction || '').trim();
                if (!action) return;

                if (action === 'refresh') {
                    await loadLibraryPage({ reset: true });
                    return;
                }
                if (action === 'load_more') {
                    await loadLibraryMore({ replace: false });
                    return;
                }

                if (action === 'open_sort_filter') {
                    openLibrarySortFilterModal();
                    return;
                }

                if (action === 'cancel_sort_filter') {
                    closeLibrarySortFilterModal({ restoreDraft: true });
                    return;
                }

                if (action === 'reset_sort_filter_draft') {
                    ensureLibrarySortFilterStateInitialized();
                    setLibrarySortFilterModalFromState(getDefaultLibrarySortFilterState());
                    return;
                }

                if (action === 'save_sort_filter') {
                    saveLibrarySortFilterModal();
                    return;
                }

                if (action === 'delete_entry') {
                    const mid = String(btn.dataset.movieId || '').trim();
                    const title = String(btn.dataset.movieTitle || '').trim();
                    if (!mid) return;

                    (async () => {
                        try {
                            await openDeleteRatingModalForMovie({ movie_id: mid, title, source: 'library' });
                        } catch (err) {
                            const msg = String(err?.message || err);
                            if (/log in/i.test(msg)) {
                                openAuthModal();
                                return;
                            }
                            showToast(msg, { level: 'warn' });
                        }
                    })().catch(() => {});
                    return;
                }
            }, { capture: true });
        }

        let librarySortFilterState = null;
        let librarySortFilterDraft = null;

        function getDefaultLibrarySortFilterState() {
            return {
                sortKey: 'watch_date',
                sortDir: 'desc',
                tier: '',
                decade: '',
                directorContains: '',
                mpa: '',
                genre: '',
            };
        }

        function ensureLibrarySortFilterStateInitialized() {
            if (!librarySortFilterState) {
                librarySortFilterState = getDefaultLibrarySortFilterState();
            }
        }

        function getLibrarySortFilterModalEls() {
            return {
                overlay: document.getElementById('library-sortfilter-overlay'),
                sortKey: document.getElementById('library-modal-sort-key'),
                sortDir: document.getElementById('library-modal-sort-dir'),
                tier: document.getElementById('library-modal-filter-tier'),
                decade: document.getElementById('library-modal-filter-decade'),
                director: document.getElementById('library-modal-filter-director'),
                mpa: document.getElementById('library-modal-filter-mpa'),
                genre: document.getElementById('library-modal-filter-genre'),
            };
        }

        function setLibrarySortFilterModalFromState(state) {
            const els = getLibrarySortFilterModalEls();
            if (!els.sortKey || !els.sortDir) return;
            els.sortKey.value = String(state?.sortKey || 'watch_date');
            els.sortDir.value = (String(state?.sortDir || 'desc') === 'asc') ? 'asc' : 'desc';
            if (els.tier) els.tier.value = String(state?.tier || '');
            if (els.decade) els.decade.value = String(state?.decade || '');
            if (els.director) els.director.value = String(state?.directorContains || '');
            if (els.mpa) els.mpa.value = String(state?.mpa || '');
            if (els.genre) els.genre.value = String(state?.genre || '');
        }

        function readLibrarySortFilterModalState() {
            const els = getLibrarySortFilterModalEls();
            const getVal = (el) => String(el?.value || '').trim();
            return {
                sortKey: getVal(els.sortKey) || 'watch_date',
                sortDir: (getVal(els.sortDir) === 'asc') ? 'asc' : 'desc',
                tier: getVal(els.tier),
                decade: getVal(els.decade),
                directorContains: getVal(els.director),
                mpa: getVal(els.mpa),
                genre: getVal(els.genre),
            };
        }

        function openLibrarySortFilterModal() {
            ensureLibrarySortFilterStateInitialized();
            const els = getLibrarySortFilterModalEls();
            if (!els.overlay) return;
            // snapshot current inputs as draft
            librarySortFilterDraft = { ...librarySortFilterState };
            loadLibraryFacets().catch(() => null);
            setLibrarySortFilterModalFromState(librarySortFilterState);
            els.overlay.style.display = 'flex';
            setTimeout(() => {
                try { els.sortKey?.focus?.(); } catch (_) {}
            }, 0);
        }

        function closeLibrarySortFilterModal({ restoreDraft = false } = {}) {
            const els = getLibrarySortFilterModalEls();
            if (!els.overlay) return;
            if (restoreDraft && librarySortFilterDraft) {
                setLibrarySortFilterModalFromState(librarySortFilterDraft);
            }
            els.overlay.style.display = 'none';
        }

        function saveLibrarySortFilterModal() {
            ensureLibrarySortFilterStateInitialized();
            const next = readLibrarySortFilterModalState();
            librarySortFilterState = next;
            librarySortFilterDraft = null;
            closeLibrarySortFilterModal({ restoreDraft: false });
            loadLibraryPage({ reset: true }).catch(() => null);
        }

        function renderLibraryList() {
            const elList = document.getElementById('library-list');
            const elMeta = document.getElementById('library-meta');
            const wrap = document.getElementById('library-load-more-wrap');
            if (!elList) return;

            const shown = Array.isArray(libraryItems) ? libraryItems.length : 0;
            const slice = Array.isArray(libraryItems) ? libraryItems : [];

            const formatIsoDateLabel = (iso) => {
                const raw = String(iso || '').trim();
                if (!raw) return '';
                const d = new Date(raw.includes('T') ? raw : `${raw}T00:00:00`);
                if (Number.isNaN(d.getTime())) return raw;
                try {
                    return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                } catch (_) {
                    return raw;
                }
            };

            const html = slice.map((it) => {
                const movie_id = String(it?.movie_id || '').trim();
                const title = String(it?.title || '').trim() || 'Untitled';
                const year = (it?.release_year === null || it?.release_year === undefined) ? '' : String(it.release_year);
                const poster_path = String(it?.poster_path || '').trim();
                const posterUrl = poster_path ? `https://image.tmdb.org/t/p/w342${poster_path.startsWith('/') ? poster_path : `/${poster_path}`}` : '';

                const overall = dashFormatScore(it?.overall_rating);
                const tierLabel = dashNormalizeTierLabel(it?.tier);
                const quote = String(it?.fav_quote ?? '').trim();
                const notes = String(it?.notes ?? '').trim();

                const mostRecentLabel = formatIsoDateLabel(it?.latest_watch_date);

                const runtimeRaw = (it?.runtime_minutes ?? it?.runtime);
                const runtimeVal = (() => {
                    const v = normalizeMovieFieldValue(runtimeRaw);
                    if (!v) return '';
                    const n = Number(v);
                    if (Number.isFinite(n) && n > 0) return `${Math.round(n)} min`;
                    return /min/i.test(v) ? v : v;
                })();
                const mpaVal = normalizeMovieFieldValue(it?.mpa_rating ?? it?.mpa);
                const directorVal = normalizeMovieFieldValue(it?.director);
                const genreVal = normalizeMovieFieldValue(it?.genre);
                const imdbVal = (() => {
                    const raw = (it?.imdb_rating_pct ?? it?.imdb_pct ?? it?.imdb_rating ?? it?.imdb);
                    const n2 = parsePercentLike(raw, { imdb: true });
                    if (n2 !== null && n2 !== undefined) return formatPctForDisplay(n2);
                    return '';
                })();

                const ratingChips = [
                    overall ? dashRenderHelpScore(overall) : '',
                    tierLabel ? dashRenderHelpTier(tierLabel) : '',
                ].join('');

                const subRatingRows = [
                    { k: 'Sound', v: dashFormatScore(it?.sound_rating) },
                    { k: 'Pace', v: dashFormatScore(it?.pacing_rating) },
                    { k: 'Imagery', v: dashFormatScore(it?.imagery_rating) },
                    { k: 'Acting', v: dashFormatScore(it?.acting_rating) },
                    { k: 'Plot', v: dashFormatScore(it?.plot_rating) },
                    { k: 'Dialogue', v: dashFormatScore(it?.dialogue_rating) },
                ].filter(x => String(x.v || '').trim());

                const extraMovieChips = renderLibraryInfoChips(it || {}, {
                    blacklist: [
                        // Identity / paging
                        'id', 'user_id', 'movie_id', 'latest_watch_date',

                        // Already shown elsewhere on the card
                        'title', 'release_year', 'tmdb_id', 'imdb_id',
                        'genre', 'genres', 'director', 'director_name',
                        'runtime', 'runtime_minutes', 'mpa', 'mpa_rating', 'is_series',
                        'imdb', 'imdb_rating', 'imdb_pct', 'imdb_rating_pct',

                        // Ratings + tier are already rendered as chips/subchips
                        'overall_rating', 'tier',
                        'sound_rating', 'pacing_rating', 'imagery_rating', 'acting_rating', 'plot_rating', 'dialogue_rating',

                        // Notes/quote already have dedicated sections
                        'fav_quote', 'notes',

                        // Misc
                        'poster_path', 'posterPath', 'poster_url', 'posterUrl',
                        'created_at', 'updated_at',
                    ],
                });

                const posterBackDetailsHtml = (() => {
                    const lines = [];
                    const genreBackHtml = (() => {
                        const raw = String(genreVal || '').trim();
                        if (!raw) return '';
                        const parts = raw
                            .split(/[,|;]/g)
                            .map(s => String(s).trim())
                            .filter(Boolean);
                        if (!parts.length) return '';
                        return parts.map(p => escapeHtml(p)).join('<br>');
                    })();
                    if (runtimeVal) lines.push(`<div class="library-poster-back-line"><span class="library-poster-back-key">Runtime</span><span class="library-poster-back-val">${escapeHtml(runtimeVal)}</span></div>`);
                    if (mpaVal) lines.push(`<div class="library-poster-back-line"><span class="library-poster-back-key">MPA</span><span class="library-poster-back-val">${escapeHtml(mpaVal)}</span></div>`);
                    if (genreBackHtml) lines.push(`<div class="library-poster-back-line"><span class="library-poster-back-key">Genre</span><span class="library-poster-back-val">${genreBackHtml}</span></div>`);
                    if (imdbVal) lines.push(`<div class="library-poster-back-line"><span class="library-poster-back-key">IMDb</span><span class="library-poster-back-val">${escapeHtml(imdbVal)}</span></div>`);
                    return lines.join('');
                })();

                return `
                    <div class="glass-panel" style="padding: 0.9rem; border-radius: 1rem;">
                        <div class="library-card-row">
                            <div class="library-card-left">
                                <div class="library-card-poster">
                                    <div class="library-poster-flip">
                                        <div class="library-poster-flip-inner">
                                            <div class="library-poster-face library-poster-front">
                                                ${posterUrl
                                                    ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width:100%; height:100%; object-fit: cover; display:block;" onerror="this.style.display='none';">`
                                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`}
                                            </div>
                                            <div class="library-poster-face library-poster-back">
                                                ${posterBackDetailsHtml || `<div class="text-xs text-gray" style="text-align:center;">No details</div>`}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="library-under">
                                    ${mostRecentLabel
                                        ? `<div class="text-xs text-gray tabular-nums" style="margin-top: 0.55rem;">Most Recent Watch: ${escapeHtml(mostRecentLabel)}</div>`
                                        : ''
                                    }
                                </div>
                            </div>

                            <div class="feed-card-main">
                                <div class="text-white font-bold" style="white-space: normal; overflow: hidden;">
                                    <span class="library-title-line">${escapeHtml(title)}${year ? ` <span style="color: rgba(255,255,255,0.65); font-weight: 800;">(${escapeHtml(year)})</span>` : ''}</span>
                                    ${(directorVal || mpaVal)
                                        ? `<span class="library-title-meta">${directorVal ? `<span class="library-title-sep">  </span>${escapeHtml(directorVal)}` : ''}${mpaVal ? `<span class="library-title-sep">  </span>${escapeHtml(mpaVal)}` : ''}</span>`
                                        : ''}
                                </div>

                                ${(overall || tierLabel)
                                    ? `<div class="feed-metrics">${ratingChips}</div>`
                                    : `<div class="text-xs text-gray" style="margin-top: 0.25rem;">No rating yet</div>`
                                }

                                ${movie_id ? `
                                    <div style="margin-top: 0.65rem; display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                        <button
                                            type="button"
                                            class="btn btn-outline"
                                            data-library-action="delete_entry"
                                            data-movie-id="${escapeHtml(movie_id)}"
                                            data-movie-title="${escapeHtml(title)}"
                                            style="border-radius: 0.85rem; padding: 0.5rem 0.75rem; border-color: rgba(239,68,68,0.55); color: rgba(239,68,68,0.95); background: rgba(239,68,68,0.10);"
                                            title="Delete rating and/or watch logs"
                                        >Delete</button>
                                    </div>
                                ` : ''}

                                <div class="library-chip-row library-subratings" style="margin-top: 0.6rem;">
                                    ${subRatingRows.map(d => `<span class=\"dash-quote-pill\">${escapeHtml(d.k)}: ${escapeHtml(d.v)}</span>`).join('')}
                                </div>

                                ${String(extraMovieChips || '').trim()
                                    ? `<div class="library-chip-row" style="margin-top: 0.55rem;">${extraMovieChips}</div>`
                                    : ''
                                }

                                ${quote ? `
                                    <div style="margin-top: 0.75rem;">
                                        <div class="text-xs text-gray" style="margin-bottom: 0.25rem;">Favorite Quote</div>
                                        <div class="text-white" style="line-height: 1.4;">${escapeHtml(quote)}</div>
                                    </div>
                                ` : ''}
                                ${notes ? `
                                    <div style="margin-top: 0.75rem;">
                                        <div class="text-xs text-gray" style="margin-bottom: 0.25rem;">Notes</div>
                                        <div class="text-white" style="line-height: 1.4; white-space: pre-wrap;">${escapeHtml(notes)}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            elList.innerHTML = html || `<div class="text-gray">No watched movies found yet.</div>`;

            if (elMeta) {
                elMeta.textContent = `Showing ${shown}${libraryHasMore ? '  Load more to continue' : ''}`;
            }
            if (wrap) wrap.style.display = libraryHasMore ? 'flex' : 'none';
        }

        async function loadLibraryFacets() {
            if (libraryFacetsLoaded) return;
            if (!supabaseClient || !cachedIsAuthed) return;

            const decadeEl = document.getElementById('library-modal-filter-decade');
            const mpaEl = document.getElementById('library-modal-filter-mpa');
            const genreEl = document.getElementById('library-modal-filter-genre');
            if (!decadeEl || !mpaEl || !genreEl) return;

            let authedUser = null;
            try {
                const { user } = await requireAuthOrThrow();
                authedUser = user;
            } catch (_) {
                return;
            }

            try {
                // Grab a capped sample to populate dropdowns without loading the full dataset.
                const { data, error } = await supabaseClient
                    .from(LIBRARY_ITEMS_VIEW)
                    .select('release_year, mpa_rating, genres, genre, user_id')
                    .eq('user_id', authedUser.id)
                    .range(0, 999);
                if (error) throw error;
                const rows = Array.isArray(data) ? data : [];

                const decades = new Set();
                const mpas = new Set();
                const genres = new Set();
                for (const r of rows) {
                    const y = Number(r?.release_year);
                    if (Number.isFinite(y) && y > 0) decades.add(Math.floor(y / 10) * 10);
                    const mpa = String(r?.mpa_rating || '').trim();
                    if (mpa) mpas.add(mpa);
                    const arr = Array.isArray(r?.genres) ? r.genres : [];
                    for (const g of arr) {
                        const s = String(g || '').trim();
                        if (s) genres.add(s);
                    }
                    const rawGenre = String(r?.genre || '').trim();
                    if (rawGenre) {
                        rawGenre.split(/[,|;]/g).map(s => String(s).trim()).filter(Boolean).forEach(g => genres.add(g));
                    }
                }

                const sortedDecades = Array.from(decades).filter(Number.isFinite).sort((a, b) => b - a);
                const sortedMpas = Array.from(mpas).sort((a, b) => a.localeCompare(b));
                const sortedGenres = Array.from(genres).sort((a, b) => a.localeCompare(b));

                const keep = {
                    decade: String(decadeEl.value || ''),
                    mpa: String(mpaEl.value || ''),
                    genre: String(genreEl.value || ''),
                };

                decadeEl.innerHTML = `<option value="">Release Decade (All)</option>` +
                    sortedDecades.map(d => `<option value="${escapeHtml(String(d))}">${escapeHtml(String(d))}s</option>`).join('');
                mpaEl.innerHTML = `<option value="">MPA (All)</option>` +
                    sortedMpas.map(v => `<option value="${escapeHtml(String(v))}">${escapeHtml(String(v))}</option>`).join('');
                genreEl.innerHTML = `<option value="">Genre (All)</option>` +
                    sortedGenres.map(v => `<option value="${escapeHtml(String(v))}">${escapeHtml(String(v))}</option>`).join('');

                decadeEl.value = keep.decade;
                mpaEl.value = keep.mpa;
                genreEl.value = keep.genre;
                libraryFacetsLoaded = true;
            } catch (_) {
                // Keep defaults; do not block modal.
            }
        }

        function normalizeMovieFieldValue(v) {
            if (v === null || v === undefined) return '';
            if (typeof v === 'boolean') return v ? 'Yes' : 'No';
            if (typeof v === 'number') return Number.isFinite(v) ? String(v) : '';
            return String(v).trim();
        }

        function parsePercentLike(raw, { imdb = false } = {}) {
            if (raw === null || raw === undefined) return null;
            if (typeof raw === 'number') {
                if (!Number.isFinite(raw)) return null;
                if (imdb && raw <= 10) return raw * 10;
                return raw;
            }
            const s = String(raw).trim();
            if (!s) return null;
            const m = s.match(/([0-9]+(?:\.[0-9]+)?)/);
            if (!m) return null;
            const n = Number(m[1]);
            if (!Number.isFinite(n)) return null;
            if (imdb && n <= 10) return n * 10;
            return n;
        }

        function formatPctForDisplay(pct) {
            const n = Number(pct);
            if (!Number.isFinite(n)) return '';
            const v = String(dashFormatScore(n) || '').trim();
            if (!v) return '';
            return /%\s*$/.test(v) ? v : `${v}%`;
        }

        function getAnyStringField(row, { preferKeys = [], avoidKeysRe = null } = {}) {
            if (!row || typeof row !== 'object') return '';
            const avoid = avoidKeysRe instanceof RegExp ? avoidKeysRe : null;
            for (const k of preferKeys) {
                const v = row?.[k];
                if (typeof v === 'string' && v.trim()) return v.trim();
            }
            for (const [k, v] of Object.entries(row)) {
                if (avoid && avoid.test(k)) continue;
                if (typeof v === 'string' && v.trim()) return v.trim();
            }
            return '';
        }

        function getMovieIdFromAnyRow(r) {
            if (!r || typeof r !== 'object') return '';
            const candidates = [
                r?.movie_id,
                r?.movieId,
                r?.movie_uuid,
                r?.movieUuid,
                r?.movie,
                r?.movieID,
            ];
            for (const c of candidates) {
                const s = String(c ?? '').trim();
                if (s) return s;
            }
            return '';
        }

        async function selectAllFromFirstAvailableTable(tableNames, idCandidates, ids) {
            const tables = Array.isArray(tableNames) ? tableNames : [];
            const cols = Array.isArray(idCandidates) ? idCandidates : [];
            let lastErr = null;

            for (const table of tables) {
                for (const col of cols) {
                    try {
                        const { data, error } = await supabaseClient
                            .from(table)
                            .select('*')
                            .in(col, ids);
                        if (error) throw error;
                        return data;
                    } catch (err) {
                        lastErr = err;
                        const msg = String(err?.message || err);
                        // Try next table/column on common schema mismatches.
                        if (/relation\s+"?.+"?\s+does\s+not\s+exist/i.test(msg)) continue;
                        if (/column\s+"?.+"?\s+does\s+not\s+exist/i.test(msg)) continue;
                        // Otherwise bubble up.
                        throw err;
                    }
                }
            }

            if (lastErr) throw lastErr;
            return null;
        }

        async function loadLibraryHydratedGenreDirectorImdb({ movieIds }) {
            const genresByMovieId = new Map();
            const directorByMovieId = new Map();
            const imdbPctByMovieId = new Map();
            const ids = Array.isArray(movieIds) ? movieIds : [];
            if (!supabaseClient || ids.length === 0) {
                return { genresByMovieId, directorByMovieId, imdbPctByMovieId };
            }

            // Genres
            try {
                const genreRows = await selectAllFromFirstAvailableTable(
                    ['Movies Genres', 'Movie Genres', 'Movies_Genres', 'movie_genres', 'movies_genres'],
                    ['movie_id', 'movieId', 'movie_uuid', 'movieUuid'],
                    ids
                );
                const rows = Array.isArray(genreRows) ? genreRows : [];
                for (const r of rows) {
                    const mid = getMovieIdFromAnyRow(r);
                    if (!mid) continue;
                    const g = getAnyStringField(r, {
                        preferKeys: ['genre', 'genre_name', 'name', 'genreName', 'genre_title', 'title'],
                        avoidKeysRe: /(id|uuid|created|updated|tmdb|imdb)/i,
                    });
                    if (!g) continue;
                    const arr = genresByMovieId.get(mid) || [];
                    if (!arr.includes(g)) arr.push(g);
                    genresByMovieId.set(mid, arr);
                }
            } catch (_) {}

            // Directors (from crew)
            try {
                const crewRows = await selectAllFromFirstAvailableTable(
                    ['Movie Crew', 'Movie Crew Table', 'Movies Crew', 'movie_crew', 'movies_crew'],
                    ['movie_id', 'movieId', 'movie_uuid', 'movieUuid'],
                    ids
                );
                const rows = Array.isArray(crewRows) ? crewRows : [];
                for (const r of rows) {
                    const mid = getMovieIdFromAnyRow(r);
                    if (!mid || directorByMovieId.has(mid)) continue;
                    const job = String(r?.job ?? r?.role ?? r?.credit_job ?? r?.job_name ?? r?.job_title ?? r?.position ?? '').trim();
                    const dept = String(r?.department ?? r?.dept ?? r?.known_for_department ?? '').trim();
                    const isDirector = (r?.is_director === true) || /director/i.test(job) || (/directing/i.test(dept) && (!job || /director/i.test(job)));
                    if (!isDirector) continue;
                    const name = getAnyStringField(r, {
                        preferKeys: ['name', 'person_name', 'crew_name', 'full_name', 'display_name', 'person'],
                        avoidKeysRe: /(movie|job|role|department|dept|id|uuid|created|updated)/i,
                    });
                    if (!name) continue;
                    directorByMovieId.set(mid, name);
                }
            } catch (_) {}

            // IMDb (external ratings)
            try {
                const extRows = await selectAllFromFirstAvailableTable(
                    ['Movie External Ratings', 'Movies External Ratings', 'movie_external_ratings', 'movies_external_ratings'],
                    ['movie_id', 'movieId', 'movie_uuid', 'movieUuid'],
                    ids
                );
                const rows = Array.isArray(extRows) ? extRows : [];
                for (const r of rows) {
                    const mid = getMovieIdFromAnyRow(r);
                    if (!mid) continue;

                    // Common schema: a single row per movie with imdb_rating_pct
                    const directPct = parsePercentLike(r?.imdb_rating_pct ?? r?.imdbPct ?? r?.imdb_rating ?? r?.imdb, { imdb: true });
                    if (directPct !== null && directPct !== undefined) {
                        imdbPctByMovieId.set(mid, directPct);
                        continue;
                    }

                    // Multi-source schema: provider/source + rating
                    const provider = String(r?.provider ?? r?.source ?? r?.site ?? r?.rating_source ?? r?.type ?? '').trim().toLowerCase();
                    if (provider && !provider.includes('imdb')) continue;
                    const pct = parsePercentLike(r?.rating_pct ?? r?.ratingPercent ?? r?.percent ?? r?.score_pct ?? r?.scorePercent ?? r?.score ?? r?.rating, { imdb: true });
                    if (pct !== null && pct !== undefined) {
                        imdbPctByMovieId.set(mid, pct);
                    }
                }
            } catch (_) {}

            return { genresByMovieId, directorByMovieId, imdbPctByMovieId };
        }

        async function loadLibraryTmdbFallbackForMovies({ movieIds, moviesById, genresByMovieId, directorByMovieId }) {
            if (!Array.isArray(movieIds) || movieIds.length === 0) return;

            // Build a list of tmdb_ids we still need details for.
            const needs = [];
            for (const id of movieIds) {
                const m = moviesById.get(id) || null;
                const mid = String(m?.id || id || '').trim();
                if (!mid) continue;

                const hasGenre = (() => {
                    const arr = genresByMovieId.get(mid);
                    if (Array.isArray(arr) && arr.length) return true;
                    if (Array.isArray(m?.genres) && m.genres.length) return true;
                    return Boolean(String(m?.genre ?? '').trim());
                })();
                const hasDirector = (() => {
                    if (directorByMovieId.has(mid)) return true;
                    return Boolean(String(m?.director ?? m?.director_name ?? '').trim());
                })();

                if (hasGenre && hasDirector) continue;
                const tmdb = Number(m?.tmdb_id);
                if (!Number.isFinite(tmdb) || tmdb <= 0) continue;
                needs.push({ mid, tmdb, needGenre: !hasGenre, needDirector: !hasDirector });
            }

            if (needs.length === 0) return;

            // De-dupe by tmdb_id (1:1 in your schema, but safe).
            const byTmdb = new Map();
            for (const n of needs) {
                const prev = byTmdb.get(n.tmdb) || { tmdb: n.tmdb, movieIds: [], needGenre: false, needDirector: false };
                prev.movieIds.push(n.mid);
                prev.needGenre = prev.needGenre || n.needGenre;
                prev.needDirector = prev.needDirector || n.needDirector;
                byTmdb.set(n.tmdb, prev);
            }

            const items = Array.from(byTmdb.values());
            const concurrency = 4;
            for (let i = 0; i < items.length; i += concurrency) {
                const chunk = items.slice(i, i + concurrency);
                await Promise.allSettled(chunk.map(async (it) => {
                    try {
                        const details = await callSwiftApiGetMovieDetails({ tmdb_id: it.tmdb });
                        const genres = Array.isArray(details?.genres)
                            ? details.genres.map(s => String(s).trim()).filter(Boolean)
                            : (String(details?.genre || '').trim() ? [String(details.genre).trim()] : []);
                        const director = String(details?.director || '').trim();

                        for (const mid of it.movieIds) {
                            if (it.needGenre && genres.length) {
                                genresByMovieId.set(mid, genres);
                            }
                            if (it.needDirector && director) {
                                directorByMovieId.set(mid, director);
                            }
                        }
                    } catch (_) {
                        // ignore
                    }
                }));
            }
        }

        function renderLibraryInfoChips(obj, opts = {}) {
            const blacklist = Array.isArray(opts.blacklist) ? opts.blacklist : [];
            const order = Array.isArray(opts.order) ? opts.order : [];
            const max = Number.isFinite(opts.max) ? Number(opts.max) : 0;

            const keys = Object.keys(obj || {});
            const filtered = keys
                .filter(k => !blacklist.includes(k))
                .filter(k => !/(cast|crew|actor|actress|writers?|producers?)/i.test(k));

            const orderedKeys = [];
            for (const k of order) {
                if (filtered.includes(k)) orderedKeys.push(k);
            }
            for (const k of filtered) {
                if (!orderedKeys.includes(k)) orderedKeys.push(k);
            }

            const chips = [];
            for (const k of orderedKeys) {
                const raw = obj?.[k];
                if (raw === null || raw === undefined) continue;
                if (typeof raw === 'object') continue;
                const v = normalizeMovieFieldValue(raw);
                if (!v) continue;
                chips.push(`<span class="dash-quote-pill">${escapeHtml(k)}: ${escapeHtml(v)}</span>`);
                if (max > 0 && chips.length >= max) break;
            }
            return chips.join('');
        }

        async function loadLibraryPage({ reset = true } = {}) {
            const elList = document.getElementById('library-list');
            const elMeta = document.getElementById('library-meta');
            const wrap = document.getElementById('library-load-more-wrap');
            if (!elList) return;

            if (!supabaseClient || !cachedIsAuthed) {
                elList.innerHTML = `<div class="text-gray">Log in to view your movies.</div>`;
                if (elMeta) elMeta.textContent = '';
                if (wrap) wrap.style.display = 'none';
                return;
            }

            if (reset) {
                libraryOffset = 0;
                libraryHasMore = true;
                libraryLoading = false;
                libraryItems = [];
                elList.innerHTML = `<div class="text-gray">Loading</div>`;
                if (wrap) wrap.style.display = 'none';
            }

            await loadLibraryMore({ replace: true });
        }

        function libraryBuildServerQuery({ userId, offset, limit }) {
            ensureLibrarySortFilterStateInitialized();
            const state = librarySortFilterState;

            const sortKey = String(state?.sortKey || 'watch_date');
            const sortDir = (String(state?.sortDir || 'desc') === 'asc') ? 'asc' : 'desc';

            let q = supabaseClient
                .from(LIBRARY_ITEMS_VIEW)
                .select('user_id, movie_id, latest_watch_date, title, release_year, tmdb_id, poster_path, mpa_rating, runtime_minutes, director, genres, genre, imdb_rating_pct, imdb_pct, imdb_rating, overall_rating, tier, fav_quote, notes, sound_rating, pacing_rating, imagery_rating, acting_rating, plot_rating, dialogue_rating')
                .eq('user_id', userId);

            // Filters
            const tierWanted = String(state?.tier || '').trim();
            if (tierWanted) {
                if (tierWanted === 'UNRANKED') {
                    // null/empty or an explicit 'Unranked' value
                    q = q.or('tier.is.null,tier.eq.,tier.eq.UNRANKED,tier.eq.Unranked');
                } else {
                    q = q.eq('tier', tierWanted);
                }
            }

            const decadeWanted = String(state?.decade || '').trim();
            if (decadeWanted) {
                const d = Number(decadeWanted);
                if (Number.isFinite(d)) {
                    q = q.gte('release_year', d).lte('release_year', d + 9);
                }
            }

            const directorNeedle = String(state?.directorContains || '').trim();
            if (directorNeedle) {
                q = q.ilike('director', `%${directorNeedle}%`);
            }

            const mpaWanted = String(state?.mpa || '').trim();
            if (mpaWanted) {
                // stored as raw label (e.g. PG-13)
                q = q.ilike('mpa_rating', mpaWanted);
            }

            const genreWanted = String(state?.genre || '').trim();
            if (genreWanted) {
                // Try array first; if the column isn't an array this will error and be handled by caller.
                q = q.contains('genres', [genreWanted]);
            }

            // Sorting
            const asc = (sortDir === 'asc');
            const addOrder = (col) => q.order(col, { ascending: asc, nullsFirst: false }).order('movie_id', { ascending: true });

            if (sortKey === 'watch_date') addOrder('latest_watch_date');
            else if (sortKey === 'release_year') addOrder('release_year');
            else if (sortKey === 'imdb') addOrder('imdb_rating_pct');
            else if (sortKey === 'overall') addOrder('overall_rating');
            else if (sortKey === 'sound') addOrder('sound_rating');
            else if (sortKey === 'pace') addOrder('pacing_rating');
            else if (sortKey === 'imagery') addOrder('imagery_rating');
            else if (sortKey === 'acting') addOrder('acting_rating');
            else if (sortKey === 'plot') addOrder('plot_rating');
            else if (sortKey === 'dialogue') addOrder('dialogue_rating');
            else addOrder('latest_watch_date');

            // Pagination (+1 to detect hasMore)
            q = q.range(offset, offset + limit);
            return q;
        }

        async function loadLibraryMore({ replace = false } = {}) {
            const elList = document.getElementById('library-list');
            const wrap = document.getElementById('library-load-more-wrap');
            const btn = document.getElementById('library-load-more');

            if (!elList || !supabaseClient || !cachedIsAuthed) return;
            if (libraryLoading) return;
            if (!libraryHasMore && !replace) return;

            libraryLoading = true;
            if (btn) btn.disabled = true;

            let authedUser = null;
            try {
                const { user } = await requireAuthOrThrow();
                authedUser = user;
            } catch (err) {
                libraryLoading = false;
                if (btn) btn.disabled = false;
                showToast(String(err?.message || err), { level: 'warn' });
                return;
            }

            const start = replace ? 0 : libraryOffset;
            const limitPlusOne = libraryLimit; // we pass extra via range end

            try {
                // Primary: server-side sort/filter/paging via `user_library_items`.
                let q = libraryBuildServerQuery({ userId: authedUser.id, offset: start, limit: limitPlusOne });
                let { data, error } = await q;

                // If genres column isn't an array, `.contains` may fail; retry genre filter via `genre` string.
                if (error && String(error?.message || '').toLowerCase().includes('operator')) {
                    ensureLibrarySortFilterStateInitialized();
                    const genreWanted = String(librarySortFilterState?.genre || '').trim();
                    if (genreWanted) {
                        q = supabaseClient
                            .from(LIBRARY_ITEMS_VIEW)
                            .select('user_id, movie_id, latest_watch_date, title, release_year, tmdb_id, poster_path, mpa_rating, runtime_minutes, director, genres, genre, imdb_rating_pct, imdb_pct, imdb_rating, overall_rating, tier, fav_quote, notes, sound_rating, pacing_rating, imagery_rating, acting_rating, plot_rating, dialogue_rating')
                            .eq('user_id', authedUser.id);

                        const state = librarySortFilterState;
                        const tierWanted = String(state?.tier || '').trim();
                        if (tierWanted) {
                            if (tierWanted === 'UNRANKED') q = q.or('tier.is.null,tier.eq.,tier.eq.UNRANKED,tier.eq.Unranked');
                            else q = q.eq('tier', tierWanted);
                        }
                        const decadeWanted = String(state?.decade || '').trim();
                        if (decadeWanted) {
                            const d = Number(decadeWanted);
                            if (Number.isFinite(d)) q = q.gte('release_year', d).lte('release_year', d + 9);
                        }
                        const directorNeedle = String(state?.directorContains || '').trim();
                        if (directorNeedle) q = q.ilike('director', `%${directorNeedle}%`);
                        const mpaWanted = String(state?.mpa || '').trim();
                        if (mpaWanted) q = q.ilike('mpa_rating', mpaWanted);

                        q = q.ilike('genre', `%${genreWanted}%`);

                        const sortKey = String(state?.sortKey || 'watch_date');
                        const sortDir = (String(state?.sortDir || 'desc') === 'asc') ? 'asc' : 'desc';
                        const asc = (sortDir === 'asc');
                        const addOrder = (col) => q.order(col, { ascending: asc, nullsFirst: false }).order('movie_id', { ascending: true });
                        if (sortKey === 'watch_date') addOrder('latest_watch_date');
                        else if (sortKey === 'release_year') addOrder('release_year');
                        else if (sortKey === 'imdb') addOrder('imdb_rating_pct');
                        else if (sortKey === 'overall') addOrder('overall_rating');
                        else if (sortKey === 'sound') addOrder('sound_rating');
                        else if (sortKey === 'pace') addOrder('pacing_rating');
                        else if (sortKey === 'imagery') addOrder('imagery_rating');
                        else if (sortKey === 'acting') addOrder('acting_rating');
                        else if (sortKey === 'plot') addOrder('plot_rating');
                        else if (sortKey === 'dialogue') addOrder('dialogue_rating');
                        else addOrder('latest_watch_date');
                        q = q.range(start, start + limitPlusOne);

                        ({ data, error } = await q);
                    }
                }

                if (error) throw error;
                const rows = Array.isArray(data) ? data : [];

                // PostgREST range is inclusive; we requested `limit`+1 via range end.
                const hasMore = rows.length > libraryLimit;
                const page = hasMore ? rows.slice(0, libraryLimit) : rows;

                libraryHasMore = hasMore;
                if (replace) {
                    libraryItems = page;
                    libraryOffset = page.length;
                } else {
                    libraryItems = libraryItems.concat(page);
                    libraryOffset += page.length;
                }

                renderLibraryList();
                if (wrap) wrap.style.display = libraryHasMore ? 'flex' : 'none';
            } catch (err) {
                const msg = String(err?.message || err);
                if (replace) {
                    elList.innerHTML = `<div class="text-gray">Could not load movies: ${escapeHtml(msg)}</div>`;
                } else {
                    showToast(`Could not load more: ${msg}`, { level: 'warn' });
                }
                if (wrap) wrap.style.display = 'none';
            } finally {
                libraryLoading = false;
                if (btn) btn.disabled = false;
            }
        }

        async function loadMyFollowingIds() {
            feedFollowingIds = new Set();
            if (!supabaseClient) return;
            let authedUser = null;
            try {
                const { data } = await supabaseClient.auth.getUser();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }
            if (!authedUser?.id) return;

            const { data, error } = await supabaseClient
                .from('Follows')
                .select('followed_id')
                .eq('follower_id', authedUser.id);
            if (error) throw error;
            const rows = Array.isArray(data) ? data : [];
            for (const r of rows) {
                const id = String(r?.followed_id || '').trim();
                if (id) feedFollowingIds.add(id);
            }
        }

        async function loadFeedPage() {
            // Bind per-render DOM elements.
            syncFeedSortUI();

            const form = document.getElementById('feed-search-form');
            const input = document.getElementById('feed-search-input');
            const clearBtn = document.getElementById('feed-clear-btn');

            if (form && !form.dataset.bound) {
                form.dataset.bound = 'true';
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const q = String(input?.value || '').trim();
                    await searchFeedUsers(q);
                });
            }

            if (clearBtn && !clearBtn.dataset.bound) {
                clearBtn.dataset.bound = 'true';
                clearBtn.addEventListener('click', async () => {
                    if (input) input.value = '';
                    feedLastSearchQuery = '';
                    const el = document.getElementById('feed-search-results');
                    if (el) el.innerHTML = '';
                });
            }

            try {
                await loadMyFollowingIds();
                await loadFeedFollowingList();
                await loadFeedItems();
            } catch (err) {
                showToast(`Feed failed: ${String(err?.message || err)}`, { level: 'warn' });
            }
        }

        function syncFeedSortUI() {
            const btnUpdated = document.getElementById('feed-sort-updated');
            const btnWatched = document.getElementById('feed-sort-watched');
            const activate = (btn, on) => {
                if (!btn) return;
                btn.classList.toggle('active', Boolean(on));
            };
            activate(btnUpdated, feedSortMode === 'updated_at');
            activate(btnWatched, feedSortMode === 'watch_date');
        }

        async function loadFeedFollowingList() {
            const el = document.getElementById('feed-following');
            if (!el) return;

            if (!supabaseClient || !cachedIsAuthed) {
                el.innerHTML = `<div class="text-gray">Log in to manage follows.</div>`;
                return;
            }

            const ids = Array.from(feedFollowingIds);
            if (ids.length === 0) {
                el.innerHTML = `<div class="text-gray">You arent following anyone yet.</div>`;
                return;
            }

            let data = null;
            try {
                const r1 = await supabaseClient
                    .from('Users')
                    .select('id, username, display_name, privacy_level, icon')
                    .in('id', ids);
                if (r1.error) throw r1.error;
                data = r1.data;
            } catch (err1) {
                const msg1 = String(err1?.message || err1);
                if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                    const r2 = await supabaseClient
                        .from('Users')
                        .select('id, username, display_name, privacy_level')
                        .in('id', ids);
                    if (r2.error) throw r2.error;
                    data = r2.data;
                } else {
                    throw err1;
                }
            }

            const rows = Array.isArray(data) ? data : [];
            // Preserve the order of ids.
            const map = new Map(rows.map(r => [String(r?.id || '').trim(), r]));
            const ordered = ids.map(id => map.get(id)).filter(Boolean);

            el.innerHTML = ordered.map((u) => {
                const id = String(u?.id || '').trim();
                const username = String(u?.username || '').trim();
                const name = String(u?.display_name || '').trim() || (username ? `@${username}` : 'User');
                const privacy = String(u?.privacy_level || 'public').trim();
                const iconId = String(u?.icon || '').trim();
                return `
                    <div class="glass-panel" style="padding: 0.75rem; border-radius: 0.9rem; display:flex; align-items:center; justify-content: space-between; gap: 10px;">
                        <div style="min-width:0; display:flex; gap: 10px; align-items: center;">
                            ${renderUserIconHtml(iconId, 28)}
                            <div style="min-width:0;">
                                <div class="text-white font-semibold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(name)}</div>
                                <div class="text-xs text-gray" style="margin-top: 0.15rem;">${username ? `@${escapeHtml(username)}` : ''}${privacy ? `  ${escapeHtml(privacy)}` : ''}</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline" data-feed-action="unfollow" data-feed-user-id="${escapeHtml(id)}" style="padding: 0.45rem 0.7rem; border-radius: 0.75rem;">Unfollow</button>
                    </div>
                `;
            }).join('');
        }

        async function searchFeedUsers(query) {
            const el = document.getElementById('feed-search-results');
            if (!el) return;
            const q = String(query || '').trim();
            feedLastSearchQuery = q;

            if (!q) {
                el.innerHTML = `<div class="text-gray">Type a username to search.</div>`;
                return;
            }

            if (!supabaseClient || !cachedIsAuthed) {
                el.innerHTML = `<div class="text-gray">Log in to search users.</div>`;
                return;
            }

            el.innerHTML = `<div class="text-gray">Searching</div>`;

            let data = null;
            try {
                const r1 = await supabaseClient
                    .from('Users')
                    .select('id, username, display_name, privacy_level, icon')
                    .ilike('username', `%${q}%`)
                    .limit(20);
                if (r1.error) throw r1.error;
                data = r1.data;
            } catch (err1) {
                const msg1 = String(err1?.message || err1);
                if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                    const r2 = await supabaseClient
                        .from('Users')
                        .select('id, username, display_name, privacy_level')
                        .ilike('username', `%${q}%`)
                        .limit(20);
                    if (r2.error) throw r2.error;
                    data = r2.data;
                } else {
                    throw err1;
                }
            }

            const rows = Array.isArray(data) ? data : [];
            if (rows.length === 0) {
                el.innerHTML = `<div class="text-gray">No users found for ${escapeHtml(q)}.</div>`;
                return;
            }

            // Determine authed user id so we can hide follow-self.
            let authedUserId = '';
            try {
                const { data: udata } = await supabaseClient.auth.getUser();
                authedUserId = String(udata?.user?.id || '').trim();
            } catch (_) {
                authedUserId = '';
            }

            el.innerHTML = rows.map((u) => {
                const id = String(u?.id || '').trim();
                const username = String(u?.username || '').trim();
                const name = String(u?.display_name || '').trim() || (username ? `@${username}` : 'User');
                const privacy = String(u?.privacy_level || 'public').trim();
                const iconId = String(u?.icon || '').trim();
                const isMe = authedUserId && id === authedUserId;
                const isFollowing = feedFollowingIds.has(id);

                const right = isMe
                    ? `<span class="text-xs text-gray" style="white-space: nowrap;">This is you</span>`
                    : (isFollowing
                        ? `<button type="button" class="btn btn-outline" data-feed-action="unfollow" data-feed-user-id="${escapeHtml(id)}" style="padding: 0.45rem 0.7rem; border-radius: 0.75rem;">Unfollow</button>`
                        : `<button type="button" class="btn btn-primary" data-feed-action="follow" data-feed-user-id="${escapeHtml(id)}" style="padding: 0.45rem 0.7rem; border-radius: 0.75rem;">Follow</button>`);

                return `
                    <div class="glass-panel" style="padding: 0.75rem; border-radius: 0.9rem; display:flex; align-items:center; justify-content: space-between; gap: 10px;">
                        <div style="min-width:0; display:flex; gap: 10px; align-items: center;">
                            ${renderUserIconHtml(iconId, 28)}
                            <div style="min-width:0;">
                                <div class="text-white font-semibold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(name)}</div>
                                <div class="text-xs text-gray" style="margin-top: 0.15rem;">${username ? `@${escapeHtml(username)}` : ''}${privacy ? `  ${escapeHtml(privacy)}` : ''}</div>
                            </div>
                        </div>
                        ${right}
                    </div>
                `;
            }).join('');
        }

        async function loadFeedItems() {
            const elList = document.getElementById('feed-list');
            const elMeta = document.getElementById('feed-meta');
            if (!elList) return;

            if (!supabaseClient || !cachedIsAuthed) {
                elList.innerHTML = `<div class="text-gray">Log in to view your feed.</div>`;
                if (elMeta) elMeta.textContent = '';
                return;
            }

            const followedIds = Array.from(feedFollowingIds);
            if (followedIds.length === 0) {
                elList.innerHTML = `<div class="text-gray">Follow someone to see activity here.</div>`;
                if (elMeta) elMeta.textContent = '';
                return;
            }

            elList.innerHTML = `<div class="text-gray">Loading</div>`;
            if (elMeta) elMeta.textContent = '';

            let rows = [];

            // Mode A: sort by rating updated_at (most recently created/updated ratings)
            if (feedSortMode === 'updated_at') {
                const { data: ratings, error } = await supabaseClient
                    .from('Movie Ratings')
                    .select('user_id, movie_id, overall_rating, tier, watch_date, updated_at, fav_quote, notes, sound_rating, pacing_rating, imagery_rating, acting_rating, plot_rating, dialogue_rating')
                    .in('user_id', followedIds)
                    .order('updated_at', { ascending: false })
                    .limit(15);
                if (error) throw error;
                rows = Array.isArray(ratings) ? ratings : [];
            }

            // Mode B: sort by most recent watch_date (ignores rating edits that weren't watched)
            if (feedSortMode === 'watch_date') {
                const { data: watches, error: wErr } = await supabaseClient
                    .from('Watch Logs')
                    .select('user_id, movie_id, watch_date')
                    .in('user_id', followedIds)
                    .order('watch_date', { ascending: false })
                    .limit(15);
                if (wErr) throw wErr;
                const wrows = Array.isArray(watches) ? watches : [];

                if (wrows.length) {
                    const movieIds2 = Array.from(new Set(wrows.map(r => r?.movie_id).filter(Boolean)));
                    const userIds2 = Array.from(new Set(wrows.map(r => r?.user_id).filter(Boolean)));
                    const { data: ratings2, error: rErr } = await supabaseClient
                        .from('Movie Ratings')
                        .select('user_id, movie_id, overall_rating, tier, watch_date, updated_at, fav_quote, notes, sound_rating, pacing_rating, imagery_rating, acting_rating, plot_rating, dialogue_rating')
                        .in('movie_id', movieIds2)
                        .in('user_id', userIds2);
                    if (rErr) throw rErr;

                    const ratingMap = new Map();
                    for (const rr of (Array.isArray(ratings2) ? ratings2 : [])) {
                        const k = `${String(rr?.user_id || '').trim()}|${String(rr?.movie_id || '').trim()}`;
                        if (k !== '|') ratingMap.set(k, rr);
                    }

                    rows = wrows.map((w) => {
                        const k = `${String(w?.user_id || '').trim()}|${String(w?.movie_id || '').trim()}`;
                        const rr = ratingMap.get(k) || {};
                        // Ensure watch_date comes from Watch Logs sort mode.
                        return { ...rr, user_id: w?.user_id, movie_id: w?.movie_id, watch_date: w?.watch_date };
                    });
                } else {
                    rows = [];
                }
            }

            if (rows.length === 0) {
                const msg = (feedSortMode === 'watch_date')
                    ? 'No recent watch logs found from people you follow (or their privacy blocks access).'
                    : 'No ratings found from people you follow (or their privacy blocks access).';
                elList.innerHTML = `<div class="text-gray">${msg}</div>`;
                if (elMeta) elMeta.textContent = '';
                return;
            }

            const movieIds = Array.from(new Set(rows.map(r => r?.movie_id).filter(Boolean)));
            const userIds = Array.from(new Set(rows.map(r => r?.user_id).filter(Boolean)));

            const moviesById = new Map();
            if (movieIds.length) {
                const { data: moviesData, error: moviesErr } = await supabaseClient
                    .from('Movies')
                    .select('id, title, release_year, tmdb_id, poster_path')
                    .in('id', movieIds);
                if (moviesErr) throw moviesErr;
                const mrows = Array.isArray(moviesData) ? moviesData : [];
                for (const m of mrows) moviesById.set(m.id, m);
            }

            const usersById = new Map();
            if (userIds.length) {
                let usersData = null;
                try {
                    const r1 = await supabaseClient
                        .from('Users')
                        .select('id, username, display_name, icon')
                        .in('id', userIds);
                    if (r1.error) throw r1.error;
                    usersData = r1.data;
                } catch (err1) {
                    const msg1 = String(err1?.message || err1);
                    if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                        const r2 = await supabaseClient
                            .from('Users')
                            .select('id, username, display_name')
                            .in('id', userIds);
                        if (r2.error) throw r2.error;
                        usersData = r2.data;
                    } else {
                        throw err1;
                    }
                }

                const urows = Array.isArray(usersData) ? usersData : [];
                for (const u of urows) usersById.set(u.id, u);
            }

            // Posters are lazy-loaded from stored DB poster_path; no TMDb calls.

            if (elMeta) {
                const label = (feedSortMode === 'watch_date') ? 'Most recent watches first' : 'Most recent updates first';
                elMeta.textContent = `${rows.length} item${rows.length === 1 ? '' : 's'}  ${label}`;
            }

            elList.innerHTML = rows.map((r) => {
                const actorId = String(r?.user_id || '').trim();
                const actor = usersById.get(actorId) || null;
                const actorUsernameRaw = String(actor?.username || '').trim().replace(/^@+/, '');
                const actorUsername = actorUsernameRaw ? `@${actorUsernameRaw}` : 'User';
                const actorIconId = String(actor?.icon || '').trim();

                const movie = moviesById.get(r?.movie_id) || null;
                const title = String(movie?.title || '').trim() || 'Untitled';
                const year = (movie?.release_year === null || movie?.release_year === undefined) ? '' : String(movie.release_year);

                const overall = dashFormatScore(r?.overall_rating);
                const tierLabel = dashNormalizeTierLabel(r?.tier);

                const tmdb_id = Number(movie?.tmdb_id);
                const poster_path = dashNormalizePosterPath(String(movie?.poster_path ?? '').trim() || (Number.isFinite(tmdb_id) ? (dashPosterCacheByTmdbId.get(tmdb_id) || '') : ''));
                const posterUrl = dashBuildPosterUrl(poster_path, 'w342');

                const quote = String(r?.fav_quote ?? '').trim();
                const notes = String(r?.notes ?? '').trim();
                const updatedAt = formatFeedTimestamp(r?.updated_at);
                const watched = String(r?.watch_date ?? '').trim();

                const subRatingRows = [
                    { k: 'Sound', v: dashFormatScore(r?.sound_rating) },
                    { k: 'Pace', v: dashFormatScore(r?.pacing_rating) },
                    { k: 'Imagery', v: dashFormatScore(r?.imagery_rating) },
                    { k: 'Acting', v: dashFormatScore(r?.acting_rating) },
                    { k: 'Plot', v: dashFormatScore(r?.plot_rating) },
                    { k: 'Dialogue', v: dashFormatScore(r?.dialogue_rating) },
                ].filter(x => String(x.v || '').trim());

                return `
                    <div class="glass-panel feed-item-card" data-feed-card="1" style="padding: 0.9rem; border-radius: 1rem;">
                        <div class="feed-card-row">
                            <div class="feed-card-poster">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width:100%; height:100%; object-fit: cover; display:block;" onerror="this.style.display='none';">`
                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`}
                            </div>

                            <div class="feed-card-main">
                                <div class="text-white font-bold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(title)}${year ? ` <span style="color: rgba(255,255,255,0.65); font-weight: 800;">(${escapeHtml(year)})</span>` : ''}</div>

                                ${(overall || tierLabel)
                                    ? `<div class="feed-metrics">${overall ? dashRenderHelpScore(overall) : ''}${tierLabel ? dashRenderHelpTier(tierLabel) : ''}</div>`
                                    : `<div class="text-xs text-gray" style="margin-top: 0.25rem;">No rating yet</div>`
                                }

                                ${(feedSortMode === 'watch_date')
                                    ? (watched ? `<div class="text-xs" style="margin-top: 0.25rem; color: rgba(255,255,255,0.55);">Watched: ${escapeHtml(watched)}</div>` : '')
                                    : (updatedAt ? `<div class="text-xs" style="margin-top: 0.25rem; color: rgba(255,255,255,0.55);">Updated: ${escapeHtml(updatedAt)}</div>` : '')
                                }
                            </div>

                            <div class="feed-card-actor" title="${escapeHtml(actorUsernameRaw || '')}">
                                ${renderUserIconHtml(actorIconId, 26)}
                                <span class="feed-card-actor-name">${escapeHtml(actorUsername)}</span>
                            </div>
                        </div>

                        <div class="feed-card-details">
                            ${subRatingRows.length
                                ? `<div class="library-chip-row" style="margin-top: 0.55rem;">
                                        ${subRatingRows.map(d => `<span class=\"dash-quote-pill\">${escapeHtml(d.k)}: ${escapeHtml(d.v)}</span>`).join('')}
                                   </div>`
                                : ''}

                            ${quote ? `
                                <div style="margin-top: 0.75rem;">
                                    <div class="text-xs text-gray" style="margin-bottom: 0.25rem;">Favorite Quote</div>
                                    <div class="text-white" style="line-height: 1.4;">${escapeHtml(quote)}</div>
                                </div>
                            ` : ''}

                            ${notes ? `
                                <div style="margin-top: 0.75rem;">
                                    <div class="text-xs text-gray" style="margin-bottom: 0.25rem;">Notes</div>
                                    <div class="text-white" style="line-height: 1.4; white-space: pre-wrap;">${escapeHtml(notes)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function dashTitleForGeneralKpiKey(kpiKey) {
            const k = String(kpiKey || '').trim().toLowerCase();
            if (k === 'most_watched_genre' || k === 'most_watched_genre_unique') return 'Most Watched Genre';
            if (k === 'most_watched_decade' || k === 'most_watched_decade_unique') return 'Most Watched Decade';
            if (k === 'most_watched_director' || k === 'most_watched_director_unique') return 'Most Watched Director';
            if (k === 'most_watched_actor' || k === 'most_watched_actor_unique') return 'Most Watched Actor';
            if (k === 'most_watched_movie') return 'Most Watched Movie';
            if (k === 'most_watched_mpa' || k === 'most_watched_mpa_unique') return 'Most Watched MPA Rating';
            if (k === 'watch_method_at_home_events' || k === 'watch_method_at_home_unique' || k === 'watch_method_in_theater') return 'Watch Method';
            return 'KPI Details';
        }

        function dashSubtitleForGeneralKpiKey(kpiKey) {
            const k = String(kpiKey || '').trim().toLowerCase();
            const data = dashboardGeneralLastData || {};

            const suffix = k.endsWith('_unique') ? 'Unique movies only' : 'All watch events';
            if (k === 'most_watched_genre' || k === 'most_watched_genre_unique') {
                const v = k.endsWith('_unique') ? data?.most_watched_genre_unique?.name : data?.most_watched_genre?.name;
                const name = String(v ?? '').trim();
                return [name || '', suffix].join('  ');
            }
            if (k === 'most_watched_decade' || k === 'most_watched_decade_unique') {
                const raw = k.endsWith('_unique') ? data?.most_watched_decade_unique?.decade : data?.most_watched_decade?.decade;
                const decade = (raw === null || raw === undefined) ? '' : `${String(raw)}s`;
                return [decade || '', suffix].join('  ');
            }
            if (k === 'most_watched_director' || k === 'most_watched_director_unique') {
                const v = k.endsWith('_unique') ? data?.most_watched_director_unique?.name : data?.most_watched_director?.name;
                const name = String(v ?? '').trim();
                return [name || '', suffix].join('  ');
            }
            if (k === 'most_watched_actor' || k === 'most_watched_actor_unique') {
                const v = k.endsWith('_unique') ? data?.most_watched_actor_unique?.name : data?.most_watched_actor?.name;
                const name = String(v ?? '').trim();
                return [name || '', suffix].join('  ');
            }
            if (k === 'most_watched_mpa' || k === 'most_watched_mpa_unique') {
                const v = k.endsWith('_unique') ? data?.most_watched_mpa_unique?.rating : data?.most_watched_mpa?.rating;
                const rating = String(v ?? '').trim();
                return [rating || '', suffix].join('  ');
            }
            if (k === 'most_watched_movie') {
                const title = String(data?.most_watched_movie?.title ?? '').trim();
                const year = data?.most_watched_movie?.release_year;
                const label = title
                    ? `${title}${(year === null || year === undefined || String(year).trim() === '') ? '' : ` (${String(year)})`}`
                    : '';
                return label || '';
            }
            if (k === 'watch_method_at_home_events') return 'At home (watch events)';
            if (k === 'watch_method_at_home_unique') return 'At home (unique movies)';
            if (k === 'watch_method_in_theater') return 'In theater';
            return '';
        }

        function initDashboardGeneralKpiClicks() {
            const pane = document.getElementById('dash-pane-general');
            if (!pane) return;
            if (pane.dataset.boundKpiClicks) return;
            pane.dataset.boundKpiClicks = 'true';

            pane.addEventListener('click', (e) => {
                const el = e?.target?.closest ? e.target.closest('[data-general-kpi]') : null;
                const key = String(el?.dataset?.generalKpi ?? '').trim();
                if (!key) return;

                dashboardKpiDetailState = {
                    kpi: key,
                    title: dashTitleForGeneralKpiKey(key),
                    subtitle: dashSubtitleForGeneralKpiKey(key),
                };
                router.navigate('dashboard_kpi');
            });
        }

        function initDashboardPosterUpdateRatingsClicks() {
            // Global delegation so it works for Favorites + KPI detail pages.
            // Bound once per session.
            if (document.documentElement.dataset.boundDashPosterClicks === 'true') return;
            document.documentElement.dataset.boundDashPosterClicks = 'true';

            const shouldHandleNow = () => {
                const p = String(router?.currentPage || '').trim().toLowerCase();
                return p === 'dashboard' || p === 'dashboard_kpi';
            };

            document.addEventListener('click', async (e) => {
                if (!shouldHandleNow()) return;
                const target = e?.target?.closest ? e.target.closest('[data-dash-movie-id]') : null;
                if (!target) return;

                const movieIdRaw = String(target.dataset.dashMovieId || '').trim();
                const tmdbIdRaw = String(target.dataset.dashTmdbId || '').trim();
                const titleRaw = String(target.dataset.dashMovieTitle || '').trim();
                const posterRaw = String(target.dataset.dashPosterPath || '').trim();
                const quoteRaw = String(target.dataset.dashMovieQuote || '').trim();

                if (!movieIdRaw && !tmdbIdRaw) return;

                e.preventDefault?.();
                e.stopPropagation?.();

                // Reuse the exact same update flow as the Home dropdown "Update Ratings" path.
                // startUpdateRatings() resolves the DB movie id and loads existing rating + watch log data.
                router.selectedMovie = {
                    id: movieIdRaw || undefined,
                    db_movie_id: movieIdRaw || undefined,
                    tmdb_id: tmdbIdRaw ? Number(tmdbIdRaw) : undefined,
                    title: titleRaw || undefined,
                    poster_path: posterRaw || undefined,
                    prefill_quote: quoteRaw || undefined,
                };

                await router.startUpdateRatings();
            }, { capture: true });

            // Cosmetic: move the Quote Wall glow with the mouse.
            document.addEventListener('mousemove', (e) => {
                if (!shouldHandleNow()) return;
                const card = e?.target?.closest ? e.target.closest('.dash-quote-card') : null;
                if (!card) return;
                const rect = card.getBoundingClientRect();
                const x = Math.max(0, Math.min(100, ((e.clientX - rect.left) / Math.max(1, rect.width)) * 100));
                const y = Math.max(0, Math.min(100, ((e.clientY - rect.top) / Math.max(1, rect.height)) * 100));
                card.style.setProperty('--mx', `${x}%`);
                card.style.setProperty('--my', `${y}%`);
                card.style.setProperty('--mx2', `${100 - x}%`);
                card.style.setProperty('--my2', `${100 - y}%`);
            }, { passive: true });
        }

        async function loadDashboardKpiDetail() {
            const elTitle = document.getElementById('dash-kpi-title');
            const elSubtitle = document.getElementById('dash-kpi-subtitle');
            const elGrid = document.getElementById('dash-kpi-grid');
            if (!elTitle || !elSubtitle || !elGrid) return;

            const state = dashboardKpiDetailState || null;
            const kpi = String(state?.kpi ?? '').trim();
            elTitle.textContent = String(state?.title ?? 'KPI Details');
            elSubtitle.textContent = String(state?.subtitle ?? '');

            if (!kpi) {
                elGrid.innerHTML = `<div class="text-gray">No KPI selected.</div>`;
                return;
            }

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                elGrid.innerHTML = `<div class="text-gray">Log in to view KPI details.</div>`;
                return;
            }

            elGrid.innerHTML = `<div class="text-gray">Loading</div>`;

            try {
                let res = await supabaseClient.rpc('get_dashboard_general_kpi_movies', {
                    p_timeframe: dashboardTimeframe,
                    p_kpi: kpi,
                });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const missingRpc = /get_dashboard_general_kpi_movies/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (missingRpc) {
                        elGrid.innerHTML = `<div class="text-gray">KPI detail RPC missing. Run dashboard_rpc.sql to add get_dashboard_general_kpi_movies.</div>`;
                        return;
                    }
                }
                if (res?.error) throw res.error;
                const data = res?.data;
                const items = Array.isArray(data?.movies) ? data.movies : [];

                // Prefer the server-computed leader for the subtitle so it always matches the timeframe.
                try {
                    const leader = String(data?.leader ?? '').trim();
                    if (leader) {
                        const key = String(kpi || '').trim().toLowerCase();
                        const isUnique = key.endsWith('_unique');
                        const suffix = isUnique ? 'Unique movies only' : 'All watch events';
                        if (key.startsWith('most_watched_') && key !== 'most_watched_movie') {
                            elSubtitle.textContent = [leader, suffix].filter(Boolean).join('  ');
                        } else if (key === 'most_watched_movie') {
                            elSubtitle.textContent = leader;
                        } else if (key.startsWith('watch_method_')) {
                            elSubtitle.textContent = leader;
                        }
                    }
                } catch (_) {}

                if (items.length === 0) {
                    elGrid.innerHTML = `<div class="text-gray">No movies found for this KPI in the selected timeframe.</div>`;
                    return;
                }

                // Posters are lazy-loaded from stored DB poster_path.

                const ensuredPosterPaths = await Promise.all(items.map((r) => dashEnsurePosterPath(r)));

                const cards = items.map((r, idx) => {
                    const title = String(r?.title ?? '').trim() || 'Untitled';
                    const year = (r?.release_year === null || r?.release_year === undefined) ? '' : String(r.release_year);
                    const overall = dashFormatScore(r?.overall_rating);
                    const tierLabel = dashNormalizeTierLabel(r?.tier);

                    const dashMovieId = String(r?.movie_id ?? '').trim();
                    const dashTmdbId = (r?.tmdb_id === null || r?.tmdb_id === undefined) ? '' : String(r.tmdb_id);

                    const tmdb_id = Number(r?.tmdb_id);
                    const ensured = ensuredPosterPaths[idx] || '';
                    const poster_path = dashNormalizePosterPath(ensured || String(r?.poster_path ?? '').trim() || (Number.isFinite(tmdb_id) ? (dashPosterCacheByTmdbId.get(tmdb_id) || '') : ''));
                    const posterUrl = dashBuildPosterUrl(poster_path, 'w342');

                    const metaHtml = dashJoinHelpParts([
                        year ? escapeHtml(year) : '',
                        overall ? `${dashRenderHelpScore(overall)} Overall` : '',
                        tierLabel ? dashRenderHelpTier(tierLabel) : '',
                    ]);

                    return `
                        <div style="display:flex; flex-direction: column; gap: 8px;">
                            <div
                                data-dash-movie-id="${escapeHtml(dashMovieId)}"
                                data-dash-tmdb-id="${escapeHtml(dashTmdbId)}"
                                data-dash-movie-title="${escapeHtml(title)}"
                                data-dash-poster-path="${escapeHtml(poster_path)}"
                                role="button"
                                tabindex="0"
                                aria-label="Update Ratings for ${escapeHtml(title)}"
                                style="width: 100%; aspect-ratio: 2/3; border-radius: 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); cursor: pointer;"
                            >
                                ${posterUrl
                                    ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.closest('div')?.remove?.()">`
                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`
                                }
                            </div>
                            <div class="text-sm text-white" style="font-weight: 700; line-height: 1.2;">${escapeHtml(title)}</div>
                            <div class="text-xs text-gray tabular-nums">${metaHtml}</div>
                        </div>
                    `;
                }).join('');

                elGrid.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px;">
                        ${cards}
                    </div>
                `;
            } catch (err) {
                showToast(`KPI details failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard KPI detail load failed', err);
                elGrid.innerHTML = `<div class="text-gray">Unable to load KPI details right now.</div>`;
            }
        }

        function initDashboardFavoritesMetric() {
            const wrap = document.getElementById('dash-fav-metric-wrap');
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-metric]') : null;
                const metric = btn?.dataset?.metric;
                if (!metric) return;
                setDashboardFavoritesMetric(metric);
            });
        }

        function syncDashboardFavoritesMetricUI() {
            const m = String(dashboardFavoritesMetric || '').trim().toLowerCase();
            const allowed = new Set(['overall', 'sound', 'plot', 'pace', 'acting', 'imagery', 'dialogue']);
            dashboardFavoritesMetric = allowed.has(m) ? m : 'overall';

            const wrap = document.getElementById('dash-fav-metric-wrap');
            if (!wrap) return;
            wrap.querySelectorAll('button[data-metric]').forEach((btn) => {
                const isOn = String(btn.dataset.metric || '').trim().toLowerCase() === dashboardFavoritesMetric;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
            });
        }

        function setDashboardFavoritesMetric(metric) {
            const m = String(metric || '').trim().toLowerCase();
            const allowed = new Set(['overall', 'sound', 'plot', 'pace', 'acting', 'imagery', 'dialogue']);
            dashboardFavoritesMetric = allowed.has(m) ? m : 'overall';

            // The Favorites poster meta line shows the selected metric. Clear cached rating rows so we
            // always have the needed columns for the currently selected metric.
            try {
                dashRatingCacheByMovieId.clear();
            } catch (_) {}

            const wrap = document.getElementById('dash-fav-metric-wrap');
            if (wrap) {
                wrap.querySelectorAll('button[data-metric]').forEach((btn) => {
                    const isOn = String(btn.dataset.metric || '').trim().toLowerCase() === dashboardFavoritesMetric;
                    btn.classList.remove('btn-glass', 'btn-outline');
                    btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
                });
            }

            if (dashboardActiveTab === 'favorites') {
                setDashboardTab('favorites');
            }
        }

        function initDashboardTimeframe() {
            const wrap = document.getElementById('dash-range-all-time')?.parentElement;
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-range]') : null;
                const range = btn?.dataset?.range;
                if (!range) return;
                setDashboardTimeframe(range);
            });
        }

        function setDashboardTimeframe(range) {
            const r = String(range || '').trim().toLowerCase();
            const allowed = new Set(['all_time', 'this_year', 'this_month']);
            dashboardTimeframe = allowed.has(r) ? r : 'all_time';

            const btnAll = document.getElementById('dash-range-all-time');
            const btnYear = document.getElementById('dash-range-this-year');
            const btnMonth = document.getElementById('dash-range-this-month');
            const activate = (btn, on) => {
                if (!btn) return;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(on ? 'btn-glass' : 'btn-outline');
            };
            activate(btnAll, dashboardTimeframe === 'all_time');
            activate(btnYear, dashboardTimeframe === 'this_year');
            activate(btnMonth, dashboardTimeframe === 'this_month');

            // Reload the active tab under the new timeframe.
            setDashboardTab(dashboardActiveTab);
        }

        async function setDashboardTab(tab) {
            if (!cachedIsAuthed) {
                openDashboardAuthWarning();
                return;
            }
            const t = String(tab || '').trim().toLowerCase();
            dashboardActiveTab = t || 'general';
            const tabGeneral = document.getElementById('dash-tab-general');
            const tabRatings = document.getElementById('dash-tab-ratings');
            const tabTiers = document.getElementById('dash-tab-tiers');
            const tabFavorites = document.getElementById('dash-tab-favorites');
            const tabQuotes = document.getElementById('dash-tab-quotes');
            const paneGeneral = document.getElementById('dash-pane-general');
            const paneRatings = document.getElementById('dash-pane-ratings');
            const paneTiers = document.getElementById('dash-pane-tiers');
            const paneFavorites = document.getElementById('dash-pane-favorites');
            const paneQuotes = document.getElementById('dash-pane-quotes');
            const favMetricPanel = document.getElementById('dash-fav-metric-panel');
            if (!tabGeneral || !tabRatings || !tabTiers || !tabFavorites || !tabQuotes || !paneGeneral || !paneRatings || !paneTiers || !paneFavorites || !paneQuotes) return;

            const activate = (btn, on) => {
                if (!btn) return;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(on ? 'btn-glass' : 'btn-outline');
            };

            const show = (pane, on) => {
                if (!pane) return;
                if (on) pane.classList.remove('hidden');
                else pane.classList.add('hidden');
            };

            activate(tabGeneral, t === 'general');
            activate(tabRatings, t === 'ratings');
            activate(tabTiers, t === 'tiers');
            activate(tabFavorites, t === 'favorites');
            activate(tabQuotes, t === 'quotes');

            show(paneGeneral, t === 'general');
            show(paneRatings, t === 'ratings');
            show(paneTiers, t === 'tiers');
            show(paneFavorites, t === 'favorites');
            show(paneQuotes, t === 'quotes');

            // Favorites-only header controls
            if (favMetricPanel) {
                if (t === 'favorites') favMetricPanel.classList.remove('hidden');
                else favMetricPanel.classList.add('hidden');
            }

            if (t === 'general') {
                await loadDashboardGeneral();
            } else if (t === 'ratings') {
                await loadDashboardRatings();
            } else if (t === 'tiers') {
                await loadDashboardTiers();
            } else if (t === 'favorites') {
                await loadDashboardFavorites();
            } else if (t === 'quotes') {
                await loadDashboardQuoteWall();
            }
        }

        async function loadDashboardFavorites() {
            const elTop = document.getElementById('dash-fav-top');
            const elBottom = document.getElementById('dash-fav-bottom');
            if (!elTop || !elBottom) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                elTop.innerHTML = `<div class="text-gray">Log in to view favorites.</div>`;
                elBottom.innerHTML = `<div class="text-gray">Log in to view favorites.</div>`;
                return;
            }

            elTop.innerHTML = `<div class="text-gray">Loading</div>`;
            elBottom.innerHTML = `<div class="text-gray">Loading</div>`;

            const metricFieldForFavorites = (metric) => {
                const m = String(metric || '').trim().toLowerCase();
                if (m === 'sound') return { field: 'sound_rating', label: 'Sound' };
                if (m === 'plot') return { field: 'plot_rating', label: 'Plot' };
                if (m === 'pace') return { field: 'pacing_rating', label: 'Pace' };
                if (m === 'acting') return { field: 'acting_rating', label: 'Acting' };
                if (m === 'imagery') return { field: 'imagery_rating', label: 'Imagery' };
                if (m === 'dialogue') return { field: 'dialogue_rating', label: 'Dialogue' };
                return { field: 'overall_rating', label: 'Overall' };
            };

            const ensureRatingsForItems = async (items) => {
                const safe = Array.isArray(items) ? items : [];
                const ids = Array.from(new Set(
                    safe
                        .map((r) => r?.movie_id)
                        .filter(Boolean)
                ));
                const missing = ids.filter((id) => !dashRatingCacheByMovieId.has(id));
                if (missing.length === 0) return;

                const { data, error } = await supabaseClient
                    .from('Movie Ratings')
                    .select('movie_id, overall_rating, sound_rating, plot_rating, pacing_rating, acting_rating, imagery_rating, dialogue_rating, tier')
                    .eq('user_id', authedUser.id)
                    .in('movie_id', missing);

                if (error) throw error;

                const rows = Array.isArray(data) ? data : [];
                const byId = new Map(rows.map((r) => [r.movie_id, r]));
                for (const id of missing) {
                    dashRatingCacheByMovieId.set(id, byId.get(id) || null);
                }
            };

            const renderRow = async (items) => {
                const safe = Array.isArray(items) ? items.slice(0, 5) : [];
                if (safe.length === 0) {
                    return `<div class="text-gray">No rated movies found for this timeframe.</div>`;
                }

                // Posters are lazy-loaded from stored DB poster_path.
                await ensureRatingsForItems(safe);

                // Ensure we have poster_path from Movies even if the RPC doesn't return it.
                const ensuredPosterPaths = await Promise.all(safe.map((r) => dashEnsurePosterPath(r)));

                const cards = safe.map((r, idx) => {
                    const title = String(r?.title ?? '').trim() || 'Untitled';
                    const year = (r?.release_year === null || r?.release_year === undefined) ? '' : String(r.release_year);
                    const ratingRow = dashRatingCacheByMovieId.get(r?.movie_id) || null;

                    const dashMovieId = String(r?.movie_id ?? '').trim();
                    const dashTmdbId = (r?.tmdb_id === null || r?.tmdb_id === undefined) ? '' : String(r.tmdb_id);

                    const { field: metricField, label: metricLabel } = metricFieldForFavorites(dashboardFavoritesMetric);
                    const metricValue = ratingRow ? ratingRow?.[metricField] : null;
                    const metricText = dashFormatScore(metricValue);
                    const tierLabel = dashNormalizeTierLabel(ratingRow ? ratingRow.tier : '');
                    const tmdb_id = Number(r?.tmdb_id);
                    const ensured = ensuredPosterPaths[idx] || '';
                    const poster_path = dashNormalizePosterPath(ensured || String(r?.poster_path ?? '').trim() || (Number.isFinite(tmdb_id) ? (dashPosterCacheByTmdbId.get(tmdb_id) || '') : ''));
                    const posterUrl = dashBuildPosterUrl(poster_path, 'w342');

                    const metaHtml = dashJoinHelpParts([
                        year ? escapeHtml(year) : '',
                        metricText ? `${dashRenderHelpScore(metricText)} ${escapeHtml(metricLabel)}` : '',
                        tierLabel ? dashRenderHelpTier(tierLabel) : '',
                    ]);

                    return `
                        <div style="display:flex; flex-direction: column; gap: 8px;">
                            <div
                                data-dash-movie-id="${escapeHtml(dashMovieId)}"
                                data-dash-tmdb-id="${escapeHtml(dashTmdbId)}"
                                data-dash-movie-title="${escapeHtml(title)}"
                                data-dash-poster-path="${escapeHtml(poster_path)}"
                                role="button"
                                tabindex="0"
                                aria-label="Update Ratings for ${escapeHtml(title)}"
                                style="width: 100%; aspect-ratio: 2/3; border-radius: 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); cursor: pointer;"
                            >
                                ${posterUrl
                                    ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.closest('div')?.remove?.()">`
                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`
                                }
                            </div>
                            <div class="text-sm text-white" style="font-weight: 700; line-height: 1.2;">${escapeHtml(title)}</div>
                            <div class="text-xs text-gray tabular-nums">${metaHtml}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px;">
                        ${cards}
                    </div>
                `;
            };

            try {
                let res = await supabaseClient.rpc('get_dashboard_favorites', {
                    p_timeframe: dashboardTimeframe,
                    p_metric: dashboardFavoritesMetric,
                });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const missingRpc = /get_dashboard_favorites/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (missingRpc) {
                        elTop.innerHTML = `<div class="text-gray">Favorites RPC missing. Run dashboard_rpc.sql to add get_dashboard_favorites.</div>`;
                        elBottom.innerHTML = `<div class="text-gray">Favorites RPC missing. Run dashboard_rpc.sql to add get_dashboard_favorites.</div>`;
                        return;
                    }
                }
                if (res?.error) throw res.error;

                const data = res?.data;
                const top = Array.isArray(data?.top) ? data.top : [];
                const bottom = Array.isArray(data?.bottom) ? data.bottom : [];

                elTop.innerHTML = await renderRow(top);
                elBottom.innerHTML = await renderRow(bottom);
            } catch (err) {
                showToast(`Dashboard (Favorites) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard favorites load failed', err);
                elTop.innerHTML = `<div class="text-gray">Unable to load favorites right now.</div>`;
                elBottom.innerHTML = `<div class="text-gray">Unable to load favorites right now.</div>`;
            }
        }

        async function loadDashboardQuoteWall() {
            const elWall = document.getElementById('dash-quote-wall');
            const elMeta = document.getElementById('dash-quote-wall-meta');
            if (!elWall) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your Quote Wall.', { level: 'warn' });
                }
                elWall.innerHTML = `<div class="text-gray">Log in to view your Quote Wall.</div>`;
                if (elMeta) elMeta.textContent = '';
                return;
            }

            elWall.innerHTML = `<div class="text-gray">Loading</div>`;
            if (elMeta) elMeta.textContent = '';

            const computeRange = () => {
                const tf = String(dashboardTimeframe || 'all_time').trim().toLowerCase();
                if (tf === 'this_year') {
                    const now = new Date();
                    const start = new Date(now.getFullYear(), 0, 1);
                    const end = new Date(now.getFullYear() + 1, 0, 1);
                    return { start_date: getLocalISODate(start), end_date: getLocalISODate(end) };
                }
                if (tf === 'this_month') {
                    const now = new Date();
                    const start = new Date(now.getFullYear(), now.getMonth(), 1);
                    const end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    return { start_date: getLocalISODate(start), end_date: getLocalISODate(end) };
                }
                return { start_date: null, end_date: null };
            };

            const isNonBlank = (v) => {
                const s = String(v ?? '').trim();
                return s.length > 0;
            };

            try {
                const { start_date, end_date } = computeRange();

                let q = supabaseClient
                    .from('Movie Ratings')
                    .select('movie_id, overall_rating, tier, fav_quote, updated_at, watch_date')
                    .eq('user_id', authedUser.id)
                    .not('overall_rating', 'is', null)
                    .not('fav_quote', 'is', null)
                    .neq('fav_quote', '');

                if (start_date && end_date) {
                    q = q.gte('watch_date', start_date).lt('watch_date', end_date);
                }

                // Pull more than 50 to account for whitespace-only quotes.
                q = q
                    .order('overall_rating', { ascending: false })
                    .order('updated_at', { ascending: false })
                    .order('watch_date', { ascending: false })
                    .limit(140);

                const { data, error } = await q;
                if (error) throw error;

                const rows = Array.isArray(data) ? data : [];
                const filtered = rows
                    .filter((r) => isNonBlank(r?.fav_quote))
                    .slice(0, 50);

                if (filtered.length === 0) {
                    elWall.innerHTML = `<div class="text-gray">No quotes found. Add a Favorite Quote on a movie and it will appear here.</div>`;
                    if (elMeta) elMeta.textContent = '';
                    return;
                }

                const movieIds = Array.from(new Set(filtered.map((r) => r?.movie_id).filter(Boolean)));
                const moviesById = new Map();
                if (movieIds.length) {
                    const { data: moviesData, error: moviesErr } = await supabaseClient
                        .from('Movies')
                        .select('id, title, release_year, tmdb_id')
                        .in('id', movieIds);
                    if (moviesErr) throw moviesErr;
                    const mrows = Array.isArray(moviesData) ? moviesData : [];
                    for (const m of mrows) moviesById.set(m.id, m);
                }

                if (elMeta) {
                    const tfLabel = (() => {
                        const tf = String(dashboardTimeframe || 'all_time').trim().toLowerCase();
                        if (tf === 'this_year') return 'This Year';
                        if (tf === 'this_month') return 'This Month';
                        return 'All Time';
                    })();
                    elMeta.textContent = `${filtered.length} quote${filtered.length === 1 ? '' : 's'}  ${tfLabel}`;
                }

                const cardsHtml = filtered.map((r, i) => {
                    const quote = String(r?.fav_quote ?? '').trim();
                    const movie_id = String(r?.movie_id ?? '').trim();
                    const overall = dashFormatScore(r?.overall_rating);
                    const tierLabel = dashNormalizeTierLabel(r?.tier);

                    const movie = moviesById.get(r?.movie_id) || null;
                    const title = String(movie?.title ?? '').trim() || 'Untitled';
                    const year = (movie?.release_year === null || movie?.release_year === undefined) ? '' : String(movie.release_year);
                    const tmdb_id = (movie?.tmdb_id === null || movie?.tmdb_id === undefined) ? '' : String(movie.tmdb_id);
                    const poster_path = '';

                    const floatDelay = `${(i % 11) * 0.22}s`;
                    const tilt = `${(((i * 37) % 7) - 3) * 0.35}deg`;
                    const mx = `${35 + ((i * 19) % 45)}%`;
                    const my = `${18 + ((i * 29) % 55)}%`;
                    const mx2 = `${20 + ((i * 13) % 60)}%`;
                    const my2 = `${35 + ((i * 23) % 55)}%`;

                    const metaParts = [
                        overall ? { kind: 'score', value: overall } : null,
                        tierLabel ? { kind: 'tier', value: tierLabel } : null,
                    ].filter(Boolean);

                    return `
                        <div
                            class="dash-quote-card"
                            data-dash-movie-id="${escapeHtml(movie_id)}"
                            data-dash-tmdb-id="${escapeHtml(tmdb_id)}"
                            data-dash-movie-title="${escapeHtml(title)}"
                            data-dash-poster-path="${escapeHtml(poster_path)}"
                            data-dash-movie-quote="${escapeHtml(quote)}"
                            role="button"
                            tabindex="0"
                            aria-label="Update Ratings for ${escapeHtml(title)}"
                            style="--floatDelay:${escapeHtml(floatDelay)}; --tilt:${escapeHtml(tilt)}; --mx:${escapeHtml(mx)}; --my:${escapeHtml(my)}; --mx2:${escapeHtml(mx2)}; --my2:${escapeHtml(my2)};"
                        >
                            <div class="dash-quote-card-inner">
                                <div class="dash-quote-text">${escapeHtml(quote)}</div>
                                <div class="dash-quote-title">${escapeHtml(title)}${year ? ` <span style="color: rgba(255,255,255,0.65); font-weight: 800;">(${escapeHtml(year)})</span>` : ''}</div>
                                <div class="dash-quote-meta">
                                    ${metaParts.map((p) => {
                                        if (p.kind === 'score') {
                                            return `<span class=\"dash-quote-pill\">${dashRenderHelpScore(p.value)} Overall</span>`;
                                        }
                                        if (p.kind === 'tier') {
                                            const letter = dashTierLetterFromLabel(p.value);
                                            const attr = letter ? ` data-tier-letter=\"${escapeHtml(letter)}\"` : '';
                                            return `<span class=\"dash-quote-pill dash-help-tier\"${attr}>${escapeHtml(p.value)}</span>`;
                                        }
                                        return '';
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                elWall.innerHTML = `<div class="dash-quote-wall-grid">${cardsHtml}</div>`;
            } catch (err) {
                showToast(`Dashboard (Quote Wall) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard quote wall load failed', err);
                elWall.innerHTML = `<div class="text-gray">Unable to load Quote Wall right now.</div>`;
                if (elMeta) elMeta.textContent = '';
            }
        }

        async function loadDashboardTiers() {
            const elBars = document.getElementById('dash-tiers-bars');
            const elLists = document.getElementById('dash-tiers-lists');
            if (!elBars || !elLists) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                elBars.innerHTML = '';
                elLists.innerHTML = `<div class="text-gray">Log in to view your tier stats.</div>`;
                return;
            }

            elBars.innerHTML = `<div class="text-gray">Loading</div>`;
            elLists.innerHTML = `<div class="text-gray">Loading</div>`;

            try {
                let res = await supabaseClient.rpc('get_dashboard_tiers', { p_timeframe: dashboardTimeframe });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const looksLikeOldSignature = /get_dashboard_tiers/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (looksLikeOldSignature) res = await supabaseClient.rpc('get_dashboard_tiers');
                }
                if (res?.error) throw res.error;
                const data = res?.data;

                const ratedTotal = Number(data?.rated_total ?? 0);
                const tierDist = Array.isArray(data?.tier_distribution) ? data.tier_distribution : [];
                const tierMovies = Array.isArray(data?.tier_movies) ? data.tier_movies : [];

                const tierOrder = ['S', 'A', 'B', 'C', 'D', 'F'];
                // Tier colors (requested palette)
                const tierColorSolid = {
                    'S': '#ef4444', // red
                    'A': '#f97316', // orange
                    'B': '#facc15', // yellow
                    'C': '#22c55e', // green
                    'D': '#3b82f6', // blue
                    'F': '#a855f7', // purple
                    'UNRANKED': '#6b7280',
                };
                const tierColorBg = {
                    'S': 'rgba(239, 68, 68, 0.22)',
                    'A': 'rgba(249, 115, 22, 0.22)',
                    'B': 'rgba(250, 204, 21, 0.20)',
                    'C': 'rgba(34, 197, 94, 0.22)',
                    'D': 'rgba(59, 130, 246, 0.22)',
                    'F': 'rgba(168, 85, 247, 0.22)',
                    'UNRANKED': 'rgba(107, 114, 128, 0.22)',
                };

                const tierHelp = {
                    'S': 'The Pantheon. Best of the Best.',
                    'A': 'Great! Highly Recommended Films!',
                    'B': 'Worth a Watch. Solidly Good and Entertaining.',
                    'C': "Totally Average. Fine if it's on, but don't go out of your way.",
                    'D': 'Skip it. Seriously Flawed and Not Worth the Time.',
                    'F': 'Avoid at All Costs. A Genuinely Bad Experience.',
                };

                const distByTier = new Map();
                for (const t of tierDist) {
                    const tier = String(t?.tier ?? '').trim().toUpperCase();
                    if (!tier) continue;
                    distByTier.set(tier, {
                        tier,
                        count: Number(t?.count ?? 0),
                        pct: Number(t?.pct ?? 0),
                    });
                }

                // Render distribution bars (S/A/B/C/D/F first, then anything else like Unranked)
                const extraTiers = [...distByTier.keys()]
                    .filter(t => !tierOrder.includes(t))
                    .sort((a, b) => {
                        if (a === 'UNRANKED') return 1;
                        if (b === 'UNRANKED') return -1;
                        return a.localeCompare(b);
                    });
                const tiersForBars = [...tierOrder.filter(t => distByTier.has(t)), ...extraTiers];

                const formatTierLabel = (tier) => {
                    const t = String(tier ?? '').trim().toUpperCase();
                    if (!t) return '';
                    if (t === 'UNRANKED') return 'Unranked';
                    if (tierOrder.includes(t)) return `${t}-Tier`;
                    return String(tier ?? '').trim();
                };

                // Vertical bar chart distribution (much larger)
                const tiersForChart = [...tierOrder, ...extraTiers.filter(t => t !== 'UNRANKED'), ...(distByTier.has('UNRANKED') ? ['UNRANKED'] : [])];
                const totalCount = Number.isFinite(ratedTotal) && ratedTotal > 0
                    ? ratedTotal
                    : tiersForChart.reduce((sum, t) => sum + (Number(distByTier.get(t)?.count ?? 0) || 0), 0);

                if (!totalCount) {
                    elBars.innerHTML = `<div class="text-gray">No tier data yet. Rate a movie to get started.</div>`;
                } else {
                    const barsHTML = tiersForChart
                        .filter(t => distByTier.has(t))
                        .map((t) => {
                            const label = formatTierLabel(t) || 'Tier';
                            const count = Number(distByTier.get(t)?.count ?? 0) || 0;
                            const pctFromRpc = Number(distByTier.get(t)?.pct ?? 0);
                            const pct = Number.isFinite(pctFromRpc) && pctFromRpc > 0
                                ? pctFromRpc
                                : (count / totalCount) * 100;
                            const h = Math.max(0, Math.min(100, pct));
                            const fill = tierColorSolid[t] || '#6b7280';
                            const bg = tierColorBg[t] || 'rgba(255,255,255,0.10)';
                            return `
                                <div style="width: 100%; min-width: 120px; display:flex; flex-direction: column; gap: 10px; align-items: center;">
                                    <div class="text-xs text-gray tabular-nums" style="height: 16px;">${pct.toFixed(1)}%</div>
                                    <div style="height: 320px; width: 100%; background: rgba(255,255,255,0.06); border-radius: 14px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; display:flex; align-items: flex-end;">
                                        <div style="height: ${h}%; width: 100%; background: ${bg}; display:flex; align-items: flex-end;">
                                            <div style="height: 100%; width: 100%; background: ${fill}; opacity: 0.92;"></div>
                                        </div>
                                    </div>
                                    <div class="text-sm text-white" style="font-weight: 800; line-height: 1.1; text-align: center;">${escapeHtml(label)}</div>
                                    <div class="text-xs text-gray tabular-nums" style="margin-top: -6px;">${count} movie${count === 1 ? '' : 's'}</div>
                                </div>
                            `;
                        })
                        .join('');

                    elBars.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 18px; align-items: flex-end; width: 100%;">
                            ${barsHTML}
                        </div>
                    `;
                }

                // Group movies by tier
                const byTier = new Map();
                for (const row of tierMovies) {
                    const tier = String(row?.tier ?? '').trim().toUpperCase() || '';
                    if (!byTier.has(tier)) byTier.set(tier, []);
                    byTier.get(tier).push(row);
                }

                const formatMovieRow = (r) => {
                    const title = String(r?.title ?? '').trim();
                    const year = (r?.release_year === null || r?.release_year === undefined) ? '' : String(r.release_year);
                    const rating = (r?.overall_rating === null || r?.overall_rating === undefined) ? '' : String(r.overall_rating);
                    const metaParts = [year, rating ? `Overall ${rating}` : ''].filter(Boolean);

                    return `
                        <div class="flex justify-between dash-movie-row">
                            <div>
                                <div class="text-white" style="font-weight: 600;">${escapeHtml(title || 'Untitled')}</div>
                                <div class="text-xs text-gray tabular-nums">${escapeHtml(metaParts.join('  ') || '')}</div>
                            </div>
                        </div>
                    `;
                };

                const tiersToRender = [...tierOrder, ...[...byTier.keys()].filter(t => !tierOrder.includes(t) && t !== ''), ...(byTier.has('') ? [''] : [])];

                const listsHTML = tiersToRender
                    .filter(tier => byTier.has(tier))
                    .map((tier) => {
                        const items = byTier.get(tier) || [];
                        const ratingNums = items
                            .map((r) => Number(r?.overall_rating))
                            .filter((n) => Number.isFinite(n));
                        const avgOverall = ratingNums.length
                            ? (ratingNums.reduce((sum, n) => sum + n, 0) / ratingNums.length)
                            : null;
                        const avgOverallText = avgOverall === null ? '' : `${Math.round(avgOverall)}%`;
                        const headerBg = tierColorBg[tier] || 'rgba(255,255,255,0.06)';
                        const headerLabel = formatTierLabel(tier) || 'Tier';
                        const help = tierHelp[String(tier ?? '').trim().toUpperCase()] || '';
                        return `
                            <details style="margin-bottom: 10px;">
                                <summary style="list-style: none; cursor: pointer; user-select: none; padding: 0.85rem 1rem; border-radius: 0.75rem; background: ${headerBg}; border: 1px solid rgba(255,255,255,0.08); display:flex; justify-content: space-between; align-items: center;">
                                    <div style="display:flex; flex-direction: column; gap: 2px;">
                                        <span class="text-white" style="font-weight: 800;">${escapeHtml(headerLabel)}</span>
                                        ${help ? `<span class=\"text-xs text-gray\">${escapeHtml(help)}</span>` : ''}
                                    </div>
                                    <div style="display:flex; flex-direction: column; align-items: flex-end; gap: 2px;">
                                        <span class="text-xs text-gray">${items.length} movie${items.length === 1 ? '' : 's'}</span>
                                        <span class="text-xs text-gray" style="white-space: nowrap;">Average Overall Rating: ${escapeHtml(avgOverallText)}</span>
                                    </div>
                                </summary>
                                <div style="padding: 0.85rem 0.5rem 0.25rem 0.5rem; display: grid; gap: 8px;">
                                    ${items.map(formatMovieRow).join('')}
                                </div>
                            </details>
                        `;
                    })
                    .join('');

                elLists.innerHTML = listsHTML || `<div class="text-gray">No tiered movies yet. Rate a movie to populate tiers.</div>`;

                // Small footnote if there are zero ratings
                if (!ratedTotal) {
                    elBars.innerHTML = `<div class="text-gray">No tier data yet. Rate a movie to get started.</div>`;
                }
            } catch (err) {
                showToast(`Dashboard (Tiers) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard tiers load failed', err);
                elBars.innerHTML = '';
                elLists.innerHTML = `<div class="text-gray">Unable to load tiers right now.</div>`;
            }
        }

        async function loadDashboardRatings() {
            const elAvgOverall = document.getElementById('dash-ratings-avg-overall');
            const elAvgImdbDiff = document.getElementById('dash-ratings-avg-imdb-diff');

            const elTopGenre = document.getElementById('dash-ratings-top-genre');
            const elTopGenreAvg = document.getElementById('dash-ratings-top-genre-avg');
            const elTopGenreN = document.getElementById('dash-ratings-top-genre-n');
            const elBottomGenre = document.getElementById('dash-ratings-bottom-genre');
            const elBottomGenreAvg = document.getElementById('dash-ratings-bottom-genre-avg');
            const elBottomGenreN = document.getElementById('dash-ratings-bottom-genre-n');

            const elTopDirector = document.getElementById('dash-ratings-top-director');
            const elTopDirectorAvg = document.getElementById('dash-ratings-top-director-avg');
            const elTopDirectorN = document.getElementById('dash-ratings-top-director-n');

            const elBottomDirector = document.getElementById('dash-ratings-bottom-director');
            const elBottomDirectorAvg = document.getElementById('dash-ratings-bottom-director-avg');
            const elBottomDirectorN = document.getElementById('dash-ratings-bottom-director-n');

            const required = [
                elAvgOverall,
                elAvgImdbDiff,
                elTopGenre, elTopGenreAvg, elTopGenreN,
                elBottomGenre, elBottomGenreAvg, elBottomGenreN,
                elTopDirector, elTopDirectorAvg, elTopDirectorN,
                elBottomDirector, elBottomDirectorAvg, elBottomDirectorN,
            ];
            if (required.some(x => !x)) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            const setAll = (v) => {
                elAvgOverall.textContent = v;
                elAvgImdbDiff.textContent = v;
                elTopGenre.textContent = v;
                elTopGenreAvg.textContent = v;
                elTopGenreN.textContent = v;
                elBottomGenre.textContent = v;
                elBottomGenreAvg.textContent = v;
                elBottomGenreN.textContent = v;
                elTopDirector.textContent = v;
                elTopDirectorAvg.textContent = v;
                elTopDirectorN.textContent = v;
                elBottomDirector.textContent = v;
                elBottomDirectorAvg.textContent = v;
                elBottomDirectorN.textContent = v;
            };

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                setAll('');
                return;
            }

            setAll('');

            try {
                let res = await supabaseClient.rpc('get_dashboard_ratings', { p_timeframe: dashboardTimeframe });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const looksLikeOldSignature = /get_dashboard_ratings/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (looksLikeOldSignature) res = await supabaseClient.rpc('get_dashboard_ratings');
                }
                if (res?.error) throw res.error;
                const data = res?.data;

                const formatScore = (n) => {
                    if (!Number.isFinite(n)) return '0';
                    const rounded = Math.round(n * 10) / 10;
                    if (Math.abs(rounded - Math.round(rounded)) < 1e-9) return String(Math.round(rounded));
                    return rounded.toFixed(1);
                };

                const ratedCount = Number(data?.rated_movies_count ?? 0);
                const avgOverall = Number(data?.avg_overall_rating ?? 0);
                const avgImdbDiff = Number(data?.avg_abs_imdb_diff ?? 0);

                const topGenre = data?.highest_rated_genre || {};
                const topGenreName = String(topGenre?.name ?? '').trim();
                const topGenreAvg = Number(topGenre?.avg_overall ?? 0);
                const topGenreN = Number(topGenre?.n ?? 0);

                const bottomGenre = data?.lowest_rated_genre || {};
                const bottomGenreName = String(bottomGenre?.name ?? '').trim();
                const bottomGenreAvg = Number(bottomGenre?.avg_overall ?? 0);
                const bottomGenreN = Number(bottomGenre?.n ?? 0);

                const topDirector = data?.highest_rated_director || {};
                const topDirectorName = String(topDirector?.name ?? '').trim();
                const topDirectorAvg = Number(topDirector?.avg_overall ?? 0);
                const topDirectorN = Number(topDirector?.n ?? 0);

                const bottomDirector = data?.lowest_rated_director || {};
                const bottomDirectorName = String(bottomDirector?.name ?? '').trim();
                const bottomDirectorAvg = Number(bottomDirector?.avg_overall ?? 0);
                const bottomDirectorN = Number(bottomDirector?.n ?? 0);

                // Any KPI that represents a rating shows as a percentage.
                elAvgOverall.textContent = `${formatScore(avgOverall)}%`;
                elAvgImdbDiff.textContent = `${formatScore(avgImdbDiff)}% points`;

                elTopGenre.textContent = topGenreName || '';
                elTopGenreAvg.textContent = `${formatScore(topGenreAvg)}%`;
                elTopGenreN.textContent = Number.isFinite(topGenreN) ? String(topGenreN) : '0';

                elBottomGenre.textContent = bottomGenreName || '';
                elBottomGenreAvg.textContent = `${formatScore(bottomGenreAvg)}%`;
                elBottomGenreN.textContent = Number.isFinite(bottomGenreN) ? String(bottomGenreN) : '0';

                elTopDirector.textContent = topDirectorName || '';
                elTopDirectorAvg.textContent = `${formatScore(topDirectorAvg)}%`;
                elTopDirectorN.textContent = Number.isFinite(topDirectorN) ? String(topDirectorN) : '0';

                elBottomDirector.textContent = bottomDirectorName || '';
                elBottomDirectorAvg.textContent = `${formatScore(bottomDirectorAvg)}%`;
                elBottomDirectorN.textContent = Number.isFinite(bottomDirectorN) ? String(bottomDirectorN) : '0';
            } catch (err) {
                showToast(`Dashboard (Ratings) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard ratings load failed', err);
                setAll('');
            }
        }

        async function loadDashboardGeneral() {
            const elEventsTotal = document.getElementById('dash-general-watch-events-total');
            const elEventsUnique = document.getElementById('dash-general-watch-events-unique');
            const elHours = document.getElementById('dash-general-hours-watched');
            const elHoursUnique = document.getElementById('dash-general-hours-watched-unique');
            const elAtHomeWatches = document.getElementById('dash-general-at-home-watches');
            const elAtHomeMovies = document.getElementById('dash-general-at-home-movies');
            const elInTheaterWatches = document.getElementById('dash-general-in-theater-watches');

            const elTopGenreEvents = document.getElementById('dash-general-top-genre-events');
            const elTopGenreUnique = document.getElementById('dash-general-top-genre-unique');
            const elTopGenreEventsCount = document.getElementById('dash-general-top-genre-events-count');
            const elTopGenreUniqueCount = document.getElementById('dash-general-top-genre-unique-count');

            const elTopDirectorEvents = document.getElementById('dash-general-top-director-events');
            const elTopDirectorUnique = document.getElementById('dash-general-top-director-unique');
            const elTopDirectorEventsCount = document.getElementById('dash-general-top-director-events-count');
            const elTopDirectorUniqueCount = document.getElementById('dash-general-top-director-unique-count');

            const elTopActorEvents = document.getElementById('dash-general-top-actor-events');
            const elTopActorUnique = document.getElementById('dash-general-top-actor-unique');
            const elTopActorEventsCount = document.getElementById('dash-general-top-actor-events-count');
            const elTopActorUniqueCount = document.getElementById('dash-general-top-actor-unique-count');

            const elTopDecadeEvents = document.getElementById('dash-general-top-decade-events');
            const elTopDecadeUnique = document.getElementById('dash-general-top-decade-unique');
            const elTopDecadeEventsCount = document.getElementById('dash-general-top-decade-events-count');
            const elTopDecadeUniqueCount = document.getElementById('dash-general-top-decade-unique-count');

            const elTopMovie = document.getElementById('dash-general-top-movie');
            const elTopMovieCount = document.getElementById('dash-general-top-movie-count');

            const elTopMpaEvents = document.getElementById('dash-general-top-mpa-events');
            const elTopMpaUnique = document.getElementById('dash-general-top-mpa-unique');
            const elTopMpaEventsCount = document.getElementById('dash-general-top-mpa-events-count');
            const elTopMpaUniqueCount = document.getElementById('dash-general-top-mpa-unique-count');

            const required = [
                elEventsTotal, elEventsUnique,
                elHours, elHoursUnique,
                elAtHomeWatches, elAtHomeMovies, elInTheaterWatches,
                elTopGenreEvents, elTopGenreUnique, elTopGenreEventsCount, elTopGenreUniqueCount,
                elTopDirectorEvents, elTopDirectorUnique, elTopDirectorEventsCount, elTopDirectorUniqueCount,
                elTopActorEvents, elTopActorUnique, elTopActorEventsCount, elTopActorUniqueCount,
                elTopDecadeEvents, elTopDecadeUnique, elTopDecadeEventsCount, elTopDecadeUniqueCount,
                elTopMovie, elTopMovieCount,
                elTopMpaEvents, elTopMpaUnique, elTopMpaEventsCount, elTopMpaUniqueCount,
            ];
            if (required.some(x => !x)) return;

            // Require auth for dashboard.
            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            const setAll = (v) => {
                elEventsTotal.textContent = v;
                elEventsUnique.textContent = v;
                elHours.textContent = v;
                elHoursUnique.textContent = v;
                elAtHomeWatches.textContent = v;
                elAtHomeMovies.textContent = v;
                elInTheaterWatches.textContent = v;
                elTopGenreEvents.textContent = v;
                elTopGenreUnique.textContent = v;
                elTopGenreEventsCount.innerHTML = '&nbsp;';
                elTopGenreUniqueCount.innerHTML = '&nbsp;';
                elTopDirectorEvents.textContent = v;
                elTopDirectorUnique.textContent = v;
                elTopDirectorEventsCount.innerHTML = '&nbsp;';
                elTopDirectorUniqueCount.innerHTML = '&nbsp;';
                elTopActorEvents.textContent = v;
                elTopActorUnique.textContent = v;
                elTopActorEventsCount.innerHTML = '&nbsp;';
                elTopActorUniqueCount.innerHTML = '&nbsp;';
                elTopDecadeEvents.textContent = v;
                elTopDecadeUnique.textContent = v;
                elTopDecadeEventsCount.innerHTML = '&nbsp;';
                elTopDecadeUniqueCount.innerHTML = '&nbsp;';
                elTopMovie.textContent = v;
                elTopMovieCount.innerHTML = '&nbsp;';
                elTopMpaEvents.textContent = v;
                elTopMpaUnique.textContent = v;
                elTopMpaEventsCount.innerHTML = '&nbsp;';
                elTopMpaUniqueCount.innerHTML = '&nbsp;';
            };

            const pluralize = (n, one, many) => {
                const x = Number(n);
                const v = Number.isFinite(x) ? x : 0;
                return `${v} ${v === 1 ? one : many}`;
            };

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                setAll('');
                return;
            }

            setAll('');

            try {
                let res = await supabaseClient.rpc('get_dashboard_general', { p_timeframe: dashboardTimeframe });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const looksLikeOldSignature = /get_dashboard_general/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (looksLikeOldSignature) res = await supabaseClient.rpc('get_dashboard_general');
                }
                if (res?.error) throw res.error;
                const data = res?.data;
                dashboardGeneralLastData = data;

                const watchEvents = data?.watch_events || {};
                const totalWatches = Number(watchEvents?.watches ?? 0);
                const uniqueMovies = Number(watchEvents?.movies ?? 0);

                const totalHours = Number(data?.hours_watched ?? 0);
                const uniqueHours = Number(data?.hours_watched_unique ?? 0);

                const method = data?.watch_method_breakdown || {};
                const atHomeObj = method?.at_home || {};
                const inTheaterObj = method?.in_theater || {};

                const atHome = Number(atHomeObj?.watches ?? 0);
                const atHomeUnique = Number(atHomeObj?.movies ?? 0);
                const inTheater = Number(inTheaterObj?.watches ?? 0);

                const topGenre = data?.most_watched_genre || {};
                const topGenreUnique = data?.most_watched_genre_unique || {};
                const topDirector = data?.most_watched_director || {};
                const topDirectorUnique = data?.most_watched_director_unique || {};
                const topActor = data?.most_watched_actor || {};
                const topActorUnique = data?.most_watched_actor_unique || {};
                const topDecade = data?.most_watched_decade || {};
                const topDecadeUnique = data?.most_watched_decade_unique || {};

                elEventsTotal.textContent = Number.isFinite(totalWatches) ? String(totalWatches) : '0';
                elEventsUnique.textContent = Number.isFinite(uniqueMovies) ? String(uniqueMovies) : '0';

                elHours.textContent = Number.isFinite(totalHours) ? String(totalHours) : '0';
                elHoursUnique.textContent = Number.isFinite(uniqueHours) ? String(uniqueHours) : '0';

                elAtHomeWatches.textContent = Number.isFinite(atHome) ? String(atHome) : '0';
                elAtHomeMovies.textContent = Number.isFinite(atHomeUnique) ? String(atHomeUnique) : '0';
                elInTheaterWatches.textContent = Number.isFinite(inTheater) ? String(inTheater) : '0';

                const genreEventsName = String(topGenre?.name ?? '').trim();
                const genreUniqueName = String(topGenreUnique?.name ?? '').trim();
                elTopGenreEvents.textContent = genreEventsName || '';
                elTopGenreUnique.textContent = genreUniqueName || '';
                elTopGenreEventsCount.textContent = pluralize(topGenre?.watches, 'watch event', 'watch events');
                elTopGenreUniqueCount.textContent = pluralize(topGenreUnique?.movies, 'unique movie', 'unique movies');

                const directorEventsName = String(topDirector?.name ?? '').trim();
                const directorUniqueName = String(topDirectorUnique?.name ?? '').trim();
                elTopDirectorEvents.textContent = directorEventsName || '';
                elTopDirectorUnique.textContent = directorUniqueName || '';
                elTopDirectorEventsCount.textContent = pluralize(topDirector?.watches, 'watch event', 'watch events');
                elTopDirectorUniqueCount.textContent = pluralize(topDirectorUnique?.movies, 'unique movie', 'unique movies');

                const actorEventsName = String(topActor?.name ?? '').trim();
                const actorUniqueName = String(topActorUnique?.name ?? '').trim();
                elTopActorEvents.textContent = actorEventsName || '';
                elTopActorUnique.textContent = actorUniqueName || '';
                elTopActorEventsCount.textContent = pluralize(topActor?.watches, 'watch event', 'watch events');
                elTopActorUniqueCount.textContent = pluralize(topActorUnique?.movies, 'unique movie', 'unique movies');

                const decadeEvents = topDecade?.decade;
                const decadeEventsLabel = (decadeEvents === null || decadeEvents === undefined) ? '' : `${String(decadeEvents)}s`;
                const decadeUnique = topDecadeUnique?.decade;
                const decadeUniqueLabel = (decadeUnique === null || decadeUnique === undefined) ? '' : `${String(decadeUnique)}s`;
                elTopDecadeEvents.textContent = decadeEventsLabel || '';
                elTopDecadeUnique.textContent = decadeUniqueLabel || '';
                elTopDecadeEventsCount.textContent = pluralize(topDecade?.watches, 'watch event', 'watch events');
                elTopDecadeUniqueCount.textContent = pluralize(topDecadeUnique?.movies, 'unique movie', 'unique movies');

                const topMovie = data?.most_watched_movie || {};
                const topMovieTitle = String(topMovie?.title ?? '').trim();
                const topMovieYear = topMovie?.release_year;
                const topMovieLabel = topMovieTitle
                    ? `${topMovieTitle}${(topMovieYear === null || topMovieYear === undefined || String(topMovieYear).trim() === '') ? '' : ` (${String(topMovieYear)})`}`
                    : '';
                elTopMovie.textContent = topMovieLabel || '';
                elTopMovieCount.textContent = pluralize(topMovie?.watches, 'watch event', 'watch events');

                const topMpa = data?.most_watched_mpa || {};
                const topMpaUnique = data?.most_watched_mpa_unique || {};
                const topMpaRating = String(topMpa?.rating ?? '').trim();
                const topMpaRatingUnique = String(topMpaUnique?.rating ?? '').trim();
                elTopMpaEvents.textContent = topMpaRating || '';
                elTopMpaUnique.textContent = topMpaRatingUnique || '';
                elTopMpaEventsCount.textContent = pluralize(topMpa?.watches, 'watch event', 'watch events');
                elTopMpaUniqueCount.textContent = pluralize(topMpaUnique?.movies, 'unique movie', 'unique movies');
            } catch (err) {
                showToast(`Dashboard (General) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard general load failed', err);
                try {
                    const details = {
                        message: err?.message,
                        code: err?.code,
                        details: err?.details,
                        hint: err?.hint,
                    };
                    addMessageToLog('error', 'Dashboard (General) error details', JSON.stringify(details));
                } catch (_) {}
                setAll('');
            }
        }

        async function callSwiftApiSearchMovies({ query, page = 1, signal }) {
            try {
                const year = homeSearchAppliedYear;
                const mpa = homeSearchAppliedMpa;
                return await callSwiftApiPublic({ action: 'search', query, page, year, mpa, limit: 8 }, { signal });
            } catch (err) {
                throw new Error(`Search failed: ${String(err?.message || err)}`);
            }
        }

        async function callSwiftApiSearchMoviesForLists({ query, page = 1, signal }) {
            try {
                // Lists page search should be dedicated to adding movies to lists only.
                // It intentionally does not use the Home page filter state.
                return await callSwiftApiPublic({ action: 'search', query, page, limit: 8 }, { signal });
            } catch (err) {
                throw new Error(`Search failed: ${String(err?.message || err)}`);
            }
        }

        async function callSwiftApiGetMovieDetails({ tmdb_id, signal }) {
            try {
                return await callSwiftApiPublic({ action: 'details', tmdb_id }, { signal });
            } catch (err) {
                throw new Error(`Details failed: ${String(err?.message || err)}`);
            }
        }

        async function callSwiftApiGetTrendingMovies({ time_window = 'day', limit = 10, signal } = {}) {
            try {
                return await callSwiftApiPublic({ action: 'trending', time_window, limit }, { signal });
            } catch (err) {
                throw new Error(`Trending failed: ${String(err?.message || err)}`);
            }
        }

        function renderTrendingNow(items) {
            const safeItems = Array.isArray(items) ? items : [];
            const cardsHTML = safeItems.map((m) => {
                const title = String(m?.title || '').trim();
                const genre = String(m?.genre || '').trim();
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w342${posterPath}` : '';
                if (!posterUrl) return '';

                return `
                    <div class="trending-card">
                        <img src="${posterUrl}" alt="${escapeHtml(title)}" onerror="this.closest('.trending-card')?.remove?.()">
                        <div class="movie-overlay">
                            ${genre ? `<span class=\"text-xs text-brand font-bold uppercase mb-1\">${escapeHtml(genre)}</span>` : ''}
                            <h4 class="text-white font-bold text-sm">${escapeHtml(title)}</h4>
                        </div>
                    </div>
                `;
            }).join('');

            const track1 = document.getElementById('trending-track-1');
            const track2 = document.getElementById('trending-track-2');
            if (track1) track1.innerHTML = cardsHTML;
            if (track2) track2.innerHTML = cardsHTML;
        }

        async function loadTrendingNow() {
            const track1 = document.getElementById('trending-track-1');
            const track2 = document.getElementById('trending-track-2');
            if (!track1 || !track2) return;

            // Cancel any in-flight trending request (e.g., navigating home repeatedly).
            try { homeTrendingAbortController?.abort?.(); } catch (_) {}
            homeTrendingAbortController = new AbortController();

            // Lightweight loading state (no hardcoded movies/posters).
            track1.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">Loading trending</div>`;
            track2.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">Loading trending</div>`;

            try {
                const data = await callSwiftApiGetTrendingMovies({ time_window: 'day', limit: 10, signal: homeTrendingAbortController.signal });
                const items = Array.isArray(data?.results) ? data.results : [];
                homeTrendingItems = items;
                renderTrendingNow(items);
            } catch (err) {
                if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                // Quiet failure: keep marquee area but show a small message.
                const msg = `Trending unavailable`;
                track1.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">${escapeHtml(msg)}</div>`;
                track2.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">${escapeHtml(msg)}</div>`;
            }
        }

        function renderHomeSearchResults(items) {
            const results = document.getElementById('search-results');
            if (!results) return;

            // Keep the dropdown lightweight.
            homeSearchItems = Array.isArray(items) ? items.slice(0, 4) : [];

            if (homeSearchItems.length === 0) {
                results.innerHTML = `<div class="search-item text-gray justify-center">No movies found</div>`;
                results.classList.remove('hidden');
                return;
            }

            results.innerHTML = homeSearchItems.map((m, idx) => {
                const title = String(m?.title || '').trim();
                const year = m?.year ? String(m.year) : '';
                const genres = Array.isArray(m?.genres)
                    ? m.genres.map(s => String(s).trim()).filter(Boolean)
                    : String(m?.genre || '').split(',').map(s => s.trim()).filter(Boolean);
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w154${posterPath}` : '';

                // Dropdown preview: do not show director (only fetched on details after selection).
                const metaParts = [
                    year,
                    (genres.length ? genres.join(', ') : ''),
                ].filter(Boolean);

                return `
                    <div class="search-item" data-idx="${idx}">
                        <div style="display:flex; align-items:center; gap: 0.75rem;">
                            <div style="width: 34px; height: 51px; flex: 0 0 34px; border-radius: 7px; overflow:hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center;">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.style.display='none'; this.parentElement.style.opacity='0.6';">`
                                    : `<div style="opacity:0.65; color: var(--text-muted); width: 16px; height: 16px; display:flex; align-items:center; justify-content:center;">${icons.film}</div>`
                                }
                            </div>
                            <div>
                                <div class="text-white font-semibold">${escapeHtml(title)}</div>
                                <div class="text-xs text-gray">${escapeHtml(metaParts.join('  '))}</div>
                            </div>
                        </div>
                        <div style="color:var(--text-muted);">${icons.arrowRightCircle}</div>
                    </div>
                `;
            }).join('');
            results.classList.remove('hidden');

            if (!results.dataset.boundClicks) {
                results.dataset.boundClicks = 'true';
                results.addEventListener('click', (e) => {
                    const row = e?.target?.closest ? e.target.closest('.search-item[data-idx]') : null;
                    if (!row) return;
                    const idx = Number(row.getAttribute('data-idx'));
                    const picked = Number.isFinite(idx) ? homeSearchItems[idx] : null;
                    if (!picked) return;
                    router.selectMovie(picked);
                });
            }
        }

        let listsSearchItems = [];
        let listsSearchDebounceTimer = null;
        let listsSearchAbortController = null;
        let listsQuickAddBusy = false;

        function setListsQuickAddEnabledState() {
            const input = document.getElementById('lists-movie-search-input');
            if (!input) return;
            const hasList = Boolean(String(listsActiveListId || '').trim());
            input.disabled = !hasList || listsQuickAddBusy;
            input.placeholder = hasList
                ? `Add movies to ${String(listsActiveListName || 'this list').trim() || 'this list'}`
                : 'Select a list to add movies';
        }

        async function addListsSearchMovieToActiveList(picked) {
            if (listsQuickAddBusy) return;

            if (!supabaseClient) {
                showToast('Supabase SDK failed to load.', { level: 'warn' });
                return;
            }

            const lid = String(listsActiveListId || '').trim();
            if (!lid) {
                showToast('Select a list first.', { level: 'warn' });
                setListsQuickAddEnabledState();
                return;
            }

            let authedUser = null;
            let accessToken = null;
            try {
                const res = await requireAuthOrThrow();
                authedUser = res.user;
                accessToken = res.accessToken;
            } catch (_) {
                openAuthModal();
                return;
            }

            const title = String(picked?.title || '').trim();
            const year = Number(picked?.year ?? picked?.release_year ?? null);
            const tmdbId = Number(picked?.tmdb_id ?? picked?.tmdbId ?? picked?.id ?? null);
            const existingDbMovieId = (isUuidLike(picked?.id) ? String(picked.id).trim() : '');

            if (!title) {
                showToast('Movie title missing. Try a different result.', { level: 'warn' });
                return;
            }

            listsQuickAddBusy = true;
            setListsQuickAddEnabledState();

            try {
                const ensuredMovieId = await ensureMovieFullySyncedForLists({
                    accessToken,
                    title,
                    release_year: Number.isFinite(year) ? year : null,
                    tmdb_id: Number.isFinite(tmdbId) ? tmdbId : null,
                    movie_id: existingDbMovieId || null,
                });

                if (!ensuredMovieId) throw new Error('Failed to ensure movie exists.');

                try {
                    await addMovieToList({ user_id: authedUser.id, list_id: lid, movie_id: ensuredMovieId });
                } catch (err) {
                    const msg = String(err?.message || err);
                    if (/duplicate|unique/i.test(msg)) {
                        showToast('Already in this list.', { level: 'warn' });
                        return;
                    }
                    throw err;
                }

                const listLabel = String(listsActiveListName || '').trim() || 'list';
                showToast(`Added to ${listLabel}!`, { level: 'success' });
                await loadListsPage({ reset: false });
            } catch (err) {
                showToast(`Add failed: ${String(err?.message || err)}`, { level: 'warn' });
            } finally {
                listsQuickAddBusy = false;
                setListsQuickAddEnabledState();
            }
        }

        function setListsSearchLoading() {
            const results = document.getElementById('lists-movie-search-results');
            if (!results) return;
            results.innerHTML = `
                <div class="search-item text-gray justify-center" style="gap:0.5rem;">
                    <span class="icon-sm">${icons.loader}</span>
                    Searching
                </div>
            `;
            results.classList.remove('hidden');
        }

        function clearListsSearchUI() {
            const results = document.getElementById('lists-movie-search-results');
            if (results) results.classList.add('hidden');
            listsSearchItems = [];
        }

        function renderListsAddMovieSearchResults(items) {
            const results = document.getElementById('lists-movie-search-results');
            if (!results) return;

            listsSearchItems = Array.isArray(items) ? items.slice(0, 6) : [];
            if (listsSearchItems.length === 0) {
                results.innerHTML = `<div class="search-item text-gray justify-center">No movies found</div>`;
                results.classList.remove('hidden');
                return;
            }

            results.innerHTML = listsSearchItems.map((m, idx) => {
                const title = String(m?.title || '').trim();
                const year = m?.year ? String(m.year) : '';
                const genres = Array.isArray(m?.genres)
                    ? m.genres.map(s => String(s).trim()).filter(Boolean)
                    : String(m?.genre || '').split(',').map(s => s.trim()).filter(Boolean);
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w154${posterPath}` : '';
                const metaParts = [year, (genres.length ? genres.join(', ') : '')].filter(Boolean);

                return `
                    <div class="search-item" data-lists-idx="${idx}" title="Add to list">
                        <div style="display:flex; align-items:center; gap: 0.75rem;">
                            <div style="width: 34px; height: 51px; flex: 0 0 34px; border-radius: 7px; overflow:hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center;">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.style.display='none'; this.parentElement.style.opacity='0.6';">`
                                    : `<div style="opacity:0.65; color: var(--text-muted); width: 16px; height: 16px; display:flex; align-items:center; justify-content:center;">${icons.film}</div>`
                                }
                            </div>
                            <div>
                                <div class="text-white font-semibold">${escapeHtml(title)}</div>
                                <div class="text-xs text-gray">${escapeHtml(metaParts.join('  '))}</div>
                            </div>
                        </div>
                        <div style="color:var(--text-muted);">${icons.plusCircle}</div>
                    </div>
                `;
            }).join('');
            results.classList.remove('hidden');

            if (!results.dataset.boundClicks) {
                results.dataset.boundClicks = 'true';
                results.addEventListener('click', (e) => {
                    const row = e?.target?.closest ? e.target.closest('.search-item[data-lists-idx]') : null;
                    if (!row) return;
                    const idx = Number(row.getAttribute('data-lists-idx'));
                    const picked = Number.isFinite(idx) ? listsSearchItems[idx] : null;
                    if (!picked) return;

                    // This Lists-only search does ONE thing: add the picked movie to the active list.
                    const input = document.getElementById('lists-movie-search-input');
                    if (input) input.value = '';
                    clearListsSearchUI();
                    addListsSearchMovieToActiveList(picked).catch(() => null);
                });
            }
        }

        function handleListsAddMovieSearch(query, opts = {}) {
            const inputEl = document.getElementById('lists-movie-search-input');
            const results = document.getElementById('lists-movie-search-results');
            // If the Lists page isn't mounted, do nothing.
            if (!inputEl || !results) return;

            if (inputEl.disabled) return;

            const q = String(query || '').trim();
            if (!q || q.length < 1) {
                if (listsSearchDebounceTimer) clearTimeout(listsSearchDebounceTimer);
                if (listsSearchAbortController) listsSearchAbortController.abort();
                clearListsSearchUI();
                return;
            }

            // Debounce + cancel in-flight request.
            if (listsSearchDebounceTimer) clearTimeout(listsSearchDebounceTimer);
            if (listsSearchAbortController) listsSearchAbortController.abort();
            listsSearchAbortController = new AbortController();

            // Keep it lightweight; wait until the user types at least 3 characters.
            if (q.length < 3) {
                results.classList.add('hidden');
                listsSearchItems = [];
                return;
            }

            const debounceMs = opts?.force ? 0 : 320;
            listsSearchDebounceTimer = setTimeout(async () => {
                try {
                    setListsSearchLoading();

                    const data = await callSwiftApiSearchMoviesForLists({
                        query: q,
                        page: 1,
                        signal: listsSearchAbortController.signal,
                    });

                    const items = Array.isArray(data?.results) ? data.results : [];
                    renderListsAddMovieSearchResults(items);
                } catch (err) {
                    // Ignore aborts
                    if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                    if (String(err?.message || '').toLowerCase().includes('aborted')) return;

                    results.innerHTML = `<div class="search-item text-gray justify-center">Search unavailable  please try again</div>`;
                    results.classList.remove('hidden');
                }
            }, debounceMs);
        }

        function setHomeActionsVisible(isVisible) {
            const actions = document.getElementById('movie-actions');
            if (!actions) return;
            const placeholder = document.getElementById('home-action-placeholder');
            if (placeholder) {
                placeholder.style.display = isVisible ? 'none' : 'block';
            }
            if (isVisible) {
                actions.classList.remove('hidden');
                actions.classList.add('flex');
            } else {
                actions.classList.add('hidden');
                actions.classList.remove('flex');
            }
        }

        function setUpdateOptionsHidden() {
            const updateBtn = document.getElementById('update-existing-btn');
            const updateOpts = document.getElementById('update-options');
            if (updateOpts) {
                updateOpts.classList.add('hidden');
                updateOpts.classList.remove('grid');
            }
            if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.style.opacity = '0.5';
                updateBtn.style.pointerEvents = 'none';
            }
        }

        function setHomeSearchLoading() {
            const results = document.getElementById('search-results');
            if (!results) return;
            results.innerHTML = `
                <div class="search-item text-gray justify-center" style="gap:0.5rem;">
                    <span class="icon-sm">${icons.loader}</span>
                    Searching
                </div>
            `;
            results.classList.remove('hidden');
        }

        function clearHomeSearchUI() {
            const results = document.getElementById('search-results');
            if (results) results.classList.add('hidden');
            setHomeActionsVisible(false);
            setUpdateOptionsHidden();
            router.selectedMovie = null;
            router.pendingTitle = '';
            homeSearchItems = [];
        }

        function escapeHtml(s) {
            return String(s ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        let homeSearchAppliedYear = '';
        let homeSearchAppliedMpa = '';
        let homeSearchFiltersDirty = false;

        function resetHomeSearchAndFilters() {
            // Clear applied filter state (so nothing is accidentally carried over).
            homeSearchAppliedYear = '';
            homeSearchAppliedMpa = '';
            homeSearchFiltersDirty = false;

            const input = document.getElementById('movie-search-input');
            if (input) input.value = '';

            const yearEl = document.getElementById('movie-search-year');
            const mpaEl = document.getElementById('movie-search-mpa');
            if (yearEl) yearEl.value = '';
            if (mpaEl) mpaEl.value = '';

            const panel = document.getElementById('movie-search-filters');
            if (panel) panel.classList.add('hidden');

            const btn = document.getElementById('movie-search-filters-toggle');
            if (btn) btn.textContent = 'Use Filters';

            // Clear any results/actions from prior home interactions.
            try { clearHomeSearchUI(); } catch (_) {}
        }

        function toggleSearchFiltersPanel() {
            const panel = document.getElementById('movie-search-filters');
            if (!panel) return;
            const btn = document.getElementById('movie-search-filters-toggle');
            const isHidden = panel.classList.contains('hidden');
            if (isHidden) {
                panel.classList.remove('hidden');
                if (btn) btn.textContent = 'Hide Filters';
            } else {
                panel.classList.add('hidden');
                if (btn) btn.textContent = 'Use Filters';
            }
        }

        function markSearchFiltersDirty() {
            homeSearchFiltersDirty = true;
        }

        function applySearchFilters() {
            const yearEl = document.getElementById('movie-search-year');
            const mpaEl = document.getElementById('movie-search-mpa');
            const yearRaw = yearEl ? String(yearEl.value || '').trim() : '';
            const year = yearRaw && /^\d{4}$/.test(yearRaw) ? yearRaw : '';
            const mpa = mpaEl ? String(mpaEl.value || '').trim() : '';

            homeSearchAppliedYear = year;
            homeSearchAppliedMpa = mpa;
            homeSearchFiltersDirty = false;

            const input = document.getElementById('movie-search-input');
            const q = String(input?.value || '').trim();
            if (q.length < 3) {
                showToast('Type at least 3 characters, then apply filters.', { level: 'warn' });
                return;
            }
            handleSearch(q, { force: true });
        }

        function clearSearchFilters() {
            const yearEl = document.getElementById('movie-search-year');
            const mpaEl = document.getElementById('movie-search-mpa');
            if (yearEl) yearEl.value = '';
            if (mpaEl) mpaEl.value = '';
            homeSearchAppliedYear = '';
            homeSearchAppliedMpa = '';
            homeSearchFiltersDirty = false;
            const input = document.getElementById('movie-search-input');
            const q = String(input?.value || '').trim();
            if (!q) {
                clearHomeSearchUI();
                return;
            }
            handleSearch(q, { force: true });
        }

        let duplicateRatingContext = null;

        function openDuplicateRatingModal({ movie_id, tmdb_id, title } = {}) {
            duplicateRatingContext = {
                movie_id: movie_id || null,
                tmdb_id: tmdb_id || null,
                title: String(title || '').trim(),
            };

            const overlay = document.getElementById('duplicate-rating-overlay');
            const label = document.getElementById('duplicate-rating-movie');
            if (label) label.textContent = duplicateRatingContext.title || 'this movie';
            if (!overlay) return;
            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function closeDuplicateRatingModal() {
            const overlay = document.getElementById('duplicate-rating-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }
            duplicateRatingContext = null;
        }

        async function proceedDuplicateUpdateRatings() {
            const ctx = duplicateRatingContext;
            closeDuplicateRatingModal();

            const movieId = String(ctx?.movie_id || '').trim();
            if (!isUuidLike(movieId)) {
                showToast('Could not determine this movie record. Please search and select it again.', { level: 'warn' });
                router.navigate('home');
                return;
            }

            // Reuse the same update flow as the Home dropdown "Update Ratings" entry point
            // so we get the same prefill + locks.
            router.selectedMovie = {
                id: movieId,
                tmdb_id: Number.isFinite(Number(ctx?.tmdb_id)) ? Number(ctx.tmdb_id) : undefined,
                title: String(ctx?.title || '').trim(),
                detailsReadonly: true,
            };
            router.pendingTitle = router.selectedMovie.title || '';

            try {
                await router.startUpdateRatings();
            } catch (err) {
                showToast(`Update Ratings failed: ${String(err?.message || err)}`, { level: 'warn' });
            }
        }

        function proceedDuplicateReturnHome() {
            closeDuplicateRatingModal();
            router.navigate('home');
        }

        function handleSearch(query, opts = {}) {
            const results = document.getElementById('search-results');

            const q = String(query || '').trim();
            if (!results || !q || q.length < 1) {
                if (homeSearchDebounceTimer) clearTimeout(homeSearchDebounceTimer);
                if (homeSearchAbortController) homeSearchAbortController.abort();
                clearHomeSearchUI();
                return;
            }

            router.selectedMovie = null;
            router.pendingTitle = q;
            setHomeActionsVisible(false);
            setUpdateOptionsHidden();

            // Debounce + cancel in-flight request
            if (homeSearchDebounceTimer) clearTimeout(homeSearchDebounceTimer);
            if (homeSearchAbortController) homeSearchAbortController.abort();
            homeSearchAbortController = new AbortController();

            // Keep dropdown behavior similar: show results panel quickly, but avoid hammering the server.
            // Do not search until the user types at least 3 characters.
            if (q.length < 3) {
                results.classList.add('hidden');
                homeSearchItems = [];
                return;
            }

            const debounceMs = opts?.force ? 0 : 320;
            homeSearchDebounceTimer = setTimeout(async () => {
                try {
                    setHomeSearchLoading();

                    const data = await callSwiftApiSearchMovies({
                        query: q,
                        page: 1,
                        signal: homeSearchAbortController.signal,
                    });

                    const items = Array.isArray(data?.results) ? data.results : [];
                    renderHomeSearchResults(items);

                    // If nothing found, do not allow manual entry.
                    if (!items || items.length === 0) {
                        setHomeActionsVisible(false);
                        setUpdateOptionsHidden();
                    }
                } catch (err) {
                    // Ignore aborts
                    if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                    if (String(err?.message || '').toLowerCase().includes('aborted')) return;

                    showToast(`Search failed: ${String(err?.message || err)}`, { level: 'warn' });
                    results.innerHTML = `<div class="search-item text-gray justify-center">Search unavailable  please try again</div>`;
                    results.classList.remove('hidden');
                    setHomeActionsVisible(false);
                    setUpdateOptionsHidden();
                }
            }, debounceMs);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('open');
        }

        // Close the Lists-only movie search dropdown when clicking outside it.
        // (This is separate from the Home page search UI.)
        document.addEventListener('click', (e) => {
            const results = document.getElementById('lists-movie-search-results');
            const input = document.getElementById('lists-movie-search-input');
            if (!results || !input) return;
            const within = (e?.target && (results.contains(e.target) || input.contains(e.target)));
            if (!within) {
                try { results.classList.add('hidden'); } catch (_) {}
            }
        }, { capture: true });

        function initializeWatchMethodToggle() {
            const btn = document.getElementById('watchmethod-toggle');
            if (!btn) return;
            const hidden = document.getElementById('fld-watchmethod');
            const isTheater = btn.textContent.trim().toLowerCase().includes('theater');
            if (hidden) hidden.value = isTheater ? 'In Theater' : 'At Home';
            if (isTheater) {
                btn.style.backgroundColor = 'rgba(20, 184, 166, 0.35)';
                btn.style.borderColor = 'rgba(20, 184, 166, 0.5)';
            } else {
                btn.style.backgroundColor = 'rgba(168, 85, 247, 0.35)';
                btn.style.borderColor = 'rgba(168, 85, 247, 0.5)';
            }
        }

        function normalizeSeriesValue(seriesText) {
            const s = String(seriesText || '').trim().toLowerCase();
            if (!s) return '';
            if (s === 'yes' || s === 'true' || s === '1') return 'TRUE';
            if (s === 'no' || s === 'false' || s === '0') return 'FALSE';
            return seriesText;
        }

        function parseGenreString(value) {
            return String(value || '')
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);
        }

        function setGenreSelection(selectedGenres) {
            const hidden = document.getElementById('fld-genre');
            if (!hidden) return;
            const unique = Array.from(new Set((selectedGenres || []).map(s => String(s).trim()).filter(Boolean)));
            hidden.value = unique.join(', ');

            const wrap = document.getElementById('genre-chip-wrap');
            if (!wrap) return;

            wrap.querySelectorAll('button[data-genre]').forEach((btn) => {
                const g = btn.getAttribute('data-genre');
                const isOn = unique.includes(g);
                btn.classList.toggle('selected', isOn);
                btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
            });
        }

        function toggleGenreChip(btnEl) {
            if (!btnEl) return;
            const hidden = document.getElementById('fld-genre');
            if (!hidden) return;

            const genre = btnEl.getAttribute('data-genre');
            if (!genre) return;

            const current = parseGenreString(hidden.value);
            const isSelected = current.includes(genre);

            if (isSelected) {
                setGenreSelection(current.filter(g => g !== genre));
                return;
            }

            setGenreSelection([...current, genre]);
        }

        function clearInlineValidationHints() {
            try {
                document.querySelectorAll('.field-error-msg[data-inline-validation="true"]').forEach((n) => n.remove());
                document.querySelectorAll('.field-error-outline').forEach((n) => n.classList.remove('field-error-outline'));
            } catch (_) {}
        }

        function addInlineValidationHint(targetEl, message) {
            if (!targetEl) return;
            const msg = String(message || '').trim() || 'Required';

            const anchor = (() => {
                // Prefer a visual container for certain composite controls.
                const id = String(targetEl?.id || '').trim();
                if (id === 'fld-genre') return document.getElementById('genre-chip-wrap') || targetEl;
                if (id === 'fld-tier') {
                    return document.querySelector('.tier-btn-group[data-target-input="fld-tier"]') || targetEl;
                }
                if (id === 'fld-watchmethod') return document.getElementById('watchmethod-toggle') || targetEl;
                return targetEl;
            })();

            try {
                anchor?.classList?.add('field-error-outline');
            } catch (_) {}

            const wrap = anchor?.parentElement;
            if (!wrap) return;

            // Avoid duplicate messages if multiple validations run.
            try {
                const existing = wrap.querySelector('.field-error-msg[data-inline-validation="true"]');
                if (existing) return;
            } catch (_) {}

            const div = document.createElement('div');
            div.className = 'field-error-msg';
            div.setAttribute('data-inline-validation', 'true');
            div.textContent = msg;
            wrap.insertBefore(div, anchor);
        }

        function ensureMissingMovieDetailsOverlay() {
            let overlay = document.getElementById('missing-movie-details-overlay');
            if (overlay) return overlay;

            overlay = document.createElement('div');
            overlay.id = 'missing-movie-details-overlay';
            overlay.style.cssText = [
                'display:none',
                'position:fixed',
                'inset:0',
                'z-index:9999',
                'background:rgba(0,0,0,0.60)',
                'backdrop-filter: blur(6px)',
                '-webkit-backdrop-filter: blur(6px)',
                'align-items:center',
                'justify-content:center',
                'padding: 1.25rem'
            ].join(';');

            overlay.innerHTML = `
                <div class="glass-panel" style="max-width: 680px; width: 100%; border-radius: 1rem; padding: 1.25rem; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.55);">
                    <div class="flex" style="justify-content: space-between; align-items: flex-start; gap: 0.75rem;">
                        <div>
                            <div class="text-white" style="font-size: 1.15rem; font-weight: 950; letter-spacing: 0.01em;">Missing Movie Details</div>
                            <div class="text-gray" style="margin-top: 0.35rem; line-height: 1.45;">
                                Unfortunately this our API calls were unable to populate the following movie details for you:
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline" id="missing-movie-details-close" style="white-space: nowrap;">Close</button>
                    </div>
                    <div id="missing-movie-details-list" style="margin-top: 0.9rem; display:flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                    <div class="text-gray" style="margin-top: 0.95rem; line-height: 1.45;">
                        Please search the web and update these fields accordingly.
                    </div>
                </div>
            `;

            overlay.addEventListener('click', (e) => {
                if (e?.target === overlay) {
                    overlay.style.display = 'none';
                }
            });

            // Close button
            setTimeout(() => {
                const btn = document.getElementById('missing-movie-details-close');
                if (btn) btn.onclick = () => { overlay.style.display = 'none'; };
            }, 0);

            document.body.appendChild(overlay);
            return overlay;
        }

        function openMissingMovieDetailsOverlay(missingLabels) {
            const labels = Array.from(new Set((missingLabels || []).map((s) => String(s || '').trim()).filter(Boolean)));
            if (labels.length === 0) return;

            const overlay = ensureMissingMovieDetailsOverlay();
            const list = overlay.querySelector('#missing-movie-details-list');
            if (list) {
                list.innerHTML = labels
                    .map((l) => `<span class="dash-quote-pill" style="background: rgba(239, 68, 68, 0.12); border-color: rgba(239, 68, 68, 0.28);">${escapeHtml(l)}</span>`)
                    .join('');
            }

            overlay.style.display = 'flex';
        }

        function openDatePickerFromInput(el) {
            try {
                if (!el || el.disabled || el.readOnly) return;
                // Modern browsers: open the picker programmatically.
                if (typeof el.showPicker === 'function') {
                    el.showPicker();
                    return;
                }

                // Fallback: at least focus the field.
                if (typeof el.focus === 'function') el.focus();
            } catch (_) {}
        }

        function getMissingRequiredFieldsForDiaryFormCore() {
            // Core fields required before we do any network/save work.
            // This excludes Movie Details fields that we can attempt to re-hydrate from the API.
            const missing = [];

            const getEl = (id) => document.getElementById(id);
            const getText = (id) => String(getEl(id)?.value ?? '').trim();
            const isBlank = (v) => String(v ?? '').trim() === '';

            const ensureText = (id, label, { kind = 'review', anchorEl = null } = {}) => {
                const el = anchorEl || getEl(id);
                const v = getText(id);
                if (!el || isBlank(v)) missing.push({ label, el, kind });
            };

            const ensureNumber = (id, label, { min = null, max = null, kind = 'review', anchorEl = null } = {}) => {
                const el = anchorEl || getEl(id);
                const raw = getText(id);
                if (!el || isBlank(raw)) {
                    missing.push({ label, el, kind });
                    return;
                }
                const n = Number(raw);
                if (!Number.isFinite(n)) {
                    missing.push({ label, el, kind });
                    return;
                }
                if (min !== null && n < min) {
                    missing.push({ label, el, kind });
                    return;
                }
                if (max !== null && n > max) {
                    missing.push({ label, el, kind });
                    return;
                }
            };

            // Basic required fields
            ensureText('fld-datewatch', 'Date Watched');

            // Tier uses a hidden input + button group.
            {
                const tierEl = document.getElementById('fld-tier');
                const tierRaw = getText('fld-tier');
                const anchor = document.querySelector('.tier-btn-group[data-target-input="fld-tier"]') || tierEl;
                if (!anchor || isBlank(tierRaw)) missing.push({ label: 'Tier List', el: anchor, kind: 'review' });
            }

            // Need these to resolve the movie (and they're required regardless).
            ensureText('fld-title', 'Title', { kind: 'movie_details' });
            ensureNumber('fld-year', 'Year', { kind: 'movie_details', min: 1 });

            // Ratings
            ensureNumber('num-overall', 'Overall', { min: 0, max: 100 });
            ensureNumber('num-sound', 'Score (Sound)', { min: 0, max: 100 });
            ensureNumber('num-pace', 'Pace', { min: 0, max: 100 });
            ensureNumber('num-imagery', 'Imagery', { min: 0, max: 100 });
            ensureNumber('num-acting', 'Acting', { min: 0, max: 100 });
            ensureNumber('num-plot', 'Plot', { min: 0, max: 100 });
            ensureNumber('num-dialogue', 'Dialogue', { min: 0, max: 100 });

            ensureText('fld-notes', 'Notes');
            ensureNumber('fld-timeswatch', 'Times Watched', { min: 1 });

            // Watch method is stored in a hidden input controlled by a toggle button.
            {
                const el = document.getElementById('watchmethod-toggle') || getEl('fld-watchmethod');
                const raw = getText('fld-watchmethod');
                if (!el || isBlank(raw)) missing.push({ label: 'Watch Method', el, kind: 'review' });
            }

            return missing;
        }

        function getMissingRequiredFieldsForDiaryFormStrict() {
            const missing = [];

            const getEl = (id) => document.getElementById(id);
            const getText = (id) => String(getEl(id)?.value ?? '').trim();
            const isBlank = (v) => String(v ?? '').trim() === '';

            const ensureText = (id, label, { kind = 'review', anchorEl = null } = {}) => {
                const el = anchorEl || getEl(id);
                const v = getText(id);
                if (!el || isBlank(v)) missing.push({ label, el, kind });
            };

            const ensureNumber = (id, label, { min = null, max = null, kind = 'review', anchorEl = null } = {}) => {
                const el = anchorEl || getEl(id);
                const raw = getText(id);
                if (!el || isBlank(raw)) {
                    missing.push({ label, el, kind });
                    return;
                }
                const n = Number(raw);
                if (!Number.isFinite(n)) {
                    missing.push({ label, el, kind });
                    return;
                }
                if (min !== null && n < min) {
                    missing.push({ label, el, kind });
                    return;
                }
                if (max !== null && n > max) {
                    missing.push({ label, el, kind });
                    return;
                }
            };

            ensureText('fld-datewatch', 'Date Watched');

            // Tier uses a hidden input + button group.
            {
                const tierEl = document.getElementById('fld-tier');
                const tierRaw = getText('fld-tier');
                const anchor = document.querySelector('.tier-btn-group[data-target-input="fld-tier"]') || tierEl;
                if (!anchor || isBlank(tierRaw)) missing.push({ label: 'Tier List', el: anchor, kind: 'review' });
            }

            // Movie details (must be present before submit)
            ensureText('fld-title', 'Title', { kind: 'movie_details' });
            ensureNumber('fld-year', 'Year', { kind: 'movie_details', min: 1 });
            ensureText('fld-mpa', 'MPA', { kind: 'movie_details' });
            ensureNumber('fld-runtime', 'Runtime (min)', { kind: 'movie_details', min: 1 });
            ensureText('fld-series', 'Series?', { kind: 'movie_details' });
            ensureText('fld-director', 'Director', { kind: 'movie_details' });

            // Genre is submitted via a hidden input when using chips.
            {
                const el = document.getElementById('genre-chip-wrap') || getEl('fld-genre');
                const raw = getText('fld-genre');
                const picked = Array.isArray(parseGenreString(raw)) ? parseGenreString(raw) : [];
                if (!el || picked.length === 0) missing.push({ label: 'Genre', el, kind: 'movie_details' });
            }

            // Ratings
            ensureNumber('num-overall', 'Overall', { min: 0, max: 100 });
            ensureNumber('num-sound', 'Score (Sound)', { min: 0, max: 100 });
            ensureNumber('num-pace', 'Pace', { min: 0, max: 100 });
            ensureNumber('num-imagery', 'Imagery', { min: 0, max: 100 });
            ensureNumber('num-acting', 'Acting', { min: 0, max: 100 });
            ensureNumber('num-plot', 'Plot', { min: 0, max: 100 });
            ensureNumber('num-dialogue', 'Dialogue', { min: 0, max: 100 });

            ensureText('fld-notes', 'Notes');
            ensureNumber('fld-timeswatch', 'Times Watched', { min: 1 });

            // Watch method is stored in a hidden input controlled by a toggle button.
            {
                const el = document.getElementById('watchmethod-toggle') || getEl('fld-watchmethod');
                const raw = getText('fld-watchmethod');
                if (!el || isBlank(raw)) missing.push({ label: 'Watch Method', el, kind: 'review' });
            }

            // IMPORTANT: IMDb rating is required and 0 means "missing" in this UI.
            // Block save unless it's a real value.
            ensureNumber('fld-imdb', 'IMDb Rating', { kind: 'movie_details', min: 1, max: 100 });

            return missing;
        }

        function blockSubmitWithValidationUI(missing) {
            const items = Array.isArray(missing) ? missing : [];
            if (items.length === 0) return;

            clearInlineValidationHints();
            for (const m of items) {
                addInlineValidationHint(m?.el, `Missing: ${String(m?.label || '').trim() || 'Required field'}`);
            }

            const missingMovieDetails = items
                .filter((m) => String(m?.kind || '') === 'movie_details')
                .map((m) => m.label);
            if (missingMovieDetails.length > 0) {
                openMissingMovieDetailsOverlay(missingMovieDetails);
            }

            const labels = items.map(m => m.label);
            const list = labels.join(', ');
            showToast(`Please fill out: ${list}`, { level: 'warn', durationMs: 8000 });
            try {
                const firstEl = items.find(m => m?.el)?.el;
                if (firstEl && typeof firstEl.focus === 'function') firstEl.focus();
            } catch (_) {}
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const entryType = String(e.target.querySelector('input[name="entryType"]')?.value || '').trim().toLowerCase();
            // Hard guarantee: no DB writes if anything (except Favorite Quote) is missing.
            // Phase 1: validate core fields required to proceed.
            const coreMissing = getMissingRequiredFieldsForDiaryFormCore();
            if (coreMissing.length > 0) {
                blockSubmitWithValidationUI(coreMissing);
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `${icons.loader} Saving...`;
            btn.disabled = true;
            btn.style.opacity = 0.7;

            let lastKnownMovieId = null;
            let lastKnownTmdbId = null;
            let lastKnownTitle = '';
            let lastKnownEntryType = entryType;

            try {
                if (!supabaseClient) {
                    throw new Error('Supabase SDK failed to load. Check the Supabase <script> include and your network.');
                }
                const { user: authedUser, accessToken } = await requireAuthOrThrow();
                lastKnownEntryType = entryType;

                const toNumberOrNull = (v) => {
                    const n = Number(v);
                    return Number.isFinite(n) ? n : null;
                };

                const uuidLike = isUuidLike;

                const parseRuntimeMinutes = (raw) => {
                    const s = String(raw || '').trim();
                    if (!s) return null;
                    // Preferred: minutes (e.g., 136)
                    if (!s.includes(':')) {
                        const minutes = Number(s.replace(/\D/g, ''));
                        return Number.isFinite(minutes) ? minutes : null;
                    }
                    // Back-compat: accept HH:MM if someone types it.
                    const [hRaw, mRaw] = s.split(':');
                    const h = Number(String(hRaw || '').replace(/\D/g, ''));
                    const m = Number(String(mRaw || '').replace(/\D/g, ''));
                    if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
                    return h * 60 + m;
                };
                const selectedId = router?.selectedMovie?.id;
                const hiddenMovieId = String(document.getElementById('fld-movie-id')?.value || '').trim();
                const hiddenTmdbId = String(document.getElementById('fld-tmdb-id')?.value || '').trim();

                lastKnownTmdbId = hiddenTmdbId || String(router?.selectedMovie?.tmdb_id || '').trim();
                lastKnownTitle = String(document.getElementById('fld-title')?.value || router?.selectedMovie?.title || '').trim();

                // Best-effort: if any Movie Details fields are missing (including IMDb), try re-hydrating
                // from the public details endpoint BEFORE we decide whether to block saving.
                try {
                    const strictPre = getMissingRequiredFieldsForDiaryFormStrict();
                    const missingMovieLabels = strictPre
                        .filter((m) => String(m?.kind || '') === 'movie_details')
                        .map((m) => m.label);

                    const tmdbIdNum = Number(hiddenTmdbId || lastKnownTmdbId || 0);
                    if (missingMovieLabels.length > 0 && Number.isFinite(tmdbIdNum) && tmdbIdNum > 0) {
                        const details = await callSwiftApiGetMovieDetails({ tmdb_id: tmdbIdNum });
                        if (details) {
                            const title = String(details?.title ?? '').trim();
                            const year = Number(details?.year ?? 0);
                            const runtime = Number(details?.runtime ?? 0);
                            const mpa = String(details?.mpa ?? '').trim();
                            const isSeries = details?.isSeries;
                            const director = String(details?.director ?? '').trim();
                            const genres = Array.isArray(details?.genres) ? details.genres : [];
                            const imdbPct = Number(details?.imdb_rating_pct ?? 0);

                            if (title) {
                                const el = document.getElementById('fld-title');
                                if (el) el.value = title;
                            }
                            if (Number.isFinite(year) && year > 0) {
                                const el = document.getElementById('fld-year');
                                if (el && !String(el.value || '').trim()) el.value = String(year);
                            }
                            if (mpa) {
                                const el = document.getElementById('fld-mpa');
                                if (el && !String(el.value || '').trim()) el.value = mpa;
                            }
                            if (Number.isFinite(runtime) && runtime > 0) {
                                const el = document.getElementById('fld-runtime');
                                if (el && !String(el.value || '').trim()) el.value = String(runtime);
                            }
                            if (isSeries === true || isSeries === false) {
                                const el = document.getElementById('fld-series');
                                const val = isSeries ? 'TRUE' : 'FALSE';
                                if (el && !String(el.value || '').trim()) el.value = val;
                            }
                            if (director) {
                                const el = document.getElementById('fld-director');
                                if (el && !String(el.value || '').trim()) el.value = director;
                            }
                            if (genres.length > 0) {
                                try {
                                    const current = parseGenreString(String(document.getElementById('fld-genre')?.value || ''));
                                    if (!Array.isArray(current) || current.length === 0) {
                                        setGenreSelection(genres);
                                    }
                                } catch (_) {}
                            }
                            if (Number.isFinite(imdbPct) && imdbPct > 0) {
                                const el = document.getElementById('fld-imdb');
                                const range = document.getElementById('fld-imdb-range');
                                if (el && (!String(el.value || '').trim() || Number(el.value) === 0)) el.value = String(Math.round(imdbPct));
                                if (range) range.value = String(Math.round(imdbPct));
                            }
                        }
                    }
                } catch (_) {
                    // Ignore hydration failures; strict validation below will catch missing fields.
                }

                // Phase 2: strict validation (includes Movie Details + IMDb).
                // If anything is still missing, BLOCK before any DB writes.
                const strictMissing = getMissingRequiredFieldsForDiaryFormStrict();
                if (strictMissing.length > 0) {
                    blockSubmitWithValidationUI(strictMissing);
                    return;
                }

                // Clear any stale validation messages once the form is valid.
                clearInlineValidationHints();

                let movie_id = uuidLike(hiddenMovieId)
                    ? hiddenMovieId
                    : (uuidLike(selectedId) ? selectedId : null);

                const movieIdWasSelected = Boolean(movie_id);

                // Updates must target an existing (user,movie) rating row.
                // Do not attempt any title-based resolution/upsert for updates.
                if (entryType === 'update' && !movie_id) {
                    // Last chance: if we have a tmdb_id from the form, map it to a DB UUID.
                    if (hiddenTmdbId) {
                        try {
                            const mapped = await getDbMovieIdByTmdbId(Number(hiddenTmdbId));
                            if (uuidLike(mapped)) movie_id = mapped;
                        } catch (_) {}
                    }

                    if (!movie_id) {
                        throw new Error('To update ratings, open the form via Update Ratings for a movie already in your diary.');
                    }
                }

                const shouldSyncPeople = entryType === 'new';

                if (!movie_id) {
                    const title = String(document.getElementById('fld-title')?.value || '').trim();
                    const release_year = toNumberOrNull(document.getElementById('fld-year')?.value);

                    if (!title) throw new Error('Title is required.');

                    // TMDb lookup + Movies upsert happens server-side in an Edge Function.
                    // This avoids exposing a TMDb key in the browser and allows Movies to remain read-only under RLS.
                    const tmdbData = await callSwiftApi(
                        { title, release_year: release_year ?? null, sync_people: shouldSyncPeople },
                        accessToken
                    );

                    movie_id = tmdbData?.movie_id || null;

                    // People sync should never block saving the rating.
                    if (tmdbData?.people_sync && tmdbData.people_sync.ok === false) {
                        const msg = tmdbData.people_sync.details
                            ? `${tmdbData.people_sync.message} (${tmdbData.people_sync.details})`
                            : `${tmdbData.people_sync.message}`;
                        showToast(`Cast sync warning: ${msg}`);
                    }
                }

                // If the movie already exists/was selected, still sync People when logging a New Entry.
                // Avoid calling twice when we just created/resolved the movie via title lookup.
                if (movieIdWasSelected && movie_id && shouldSyncPeople && uuidLike(movie_id)) {
                    try {
                        const peopleRes = await callSwiftApi({ movie_id, sync_people: true }, accessToken);
                        if (peopleRes?.people_sync && peopleRes.people_sync.ok === false) {
                            const msg = peopleRes.people_sync.details
                                ? `${peopleRes.people_sync.message} (${peopleRes.people_sync.details})`
                                : `${peopleRes.people_sync.message}`;
                            showToast(`Cast sync warning: ${msg}`);
                        }
                    } catch (e) {
                        showToast(`Cast sync warning: ${String(e?.message || e)}`);
                    }
                }

                if (!movie_id) throw new Error('Failed to determine movie_id.');

                lastKnownMovieId = movie_id;

                // NOTE: Only after strict validation passes do we run any server-side sync that writes to DB.
                // ("Movie External Ratings" has no user_id; it should be written from the Edge Function.)
                try {
                    const syncRes = await callSwiftApi({ movie_id, sync_people: false }, accessToken);
                    const imdbPct = syncRes?.imdb_rating_pct;
                    if (imdbPct !== null && imdbPct !== undefined) {
                        const imdbEl = document.getElementById('fld-imdb');
                        const imdbVal = String(imdbEl?.value || '').trim();
                        if (imdbEl && (!imdbVal || Number(imdbVal) === 0)) {
                            imdbEl.value = String(imdbPct);
                        }

                        const imdbPctNum = Number(imdbPct);
                        if (Number.isFinite(imdbPctNum) && imdbPctNum > 0) {
                            try {
                                imdbEl?.setAttribute('readonly', '');
                                imdbEl?.classList?.add('input-readonly');
                                document.getElementById('fld-imdb-range')?.setAttribute('disabled', '');
                            } catch (_) {}
                        }
                    }

                    const ext = syncRes?.external_ratings?.imdb;
                    if (ext && ext.ok === false && ext.error) {
                        showToast(`IMDb sync warning: ${String(ext.error)}`, { level: 'warn' });
                    }
                } catch (e) {
                    showToast(`IMDb sync warning: ${String(e?.message || e)}`, { level: 'warn' });
                }

                const tier = String(document.getElementById('fld-tier')?.value || '').trim() || null;
                const overall_rating = toNumberOrNull(document.getElementById('num-overall')?.value);
                const acting_rating = toNumberOrNull(document.getElementById('num-acting')?.value);
                const pacing_rating = toNumberOrNull(document.getElementById('num-pace')?.value);
                const sound_rating = toNumberOrNull(document.getElementById('num-sound')?.value);
                const imagery_rating = toNumberOrNull(document.getElementById('num-imagery')?.value);
                const plot_rating = toNumberOrNull(document.getElementById('num-plot')?.value);
                const dialogue_rating = toNumberOrNull(document.getElementById('num-dialogue')?.value);
                const notes = String(document.getElementById('fld-notes')?.value || '').trim() || null;
                const fav_quote = String(document.getElementById('fld-quote')?.value || '').trim() || null;
                const watch_method = String(document.getElementById('fld-watchmethod')?.value || '').trim() || null;
                const watch_date_from_form = String(document.getElementById('fld-datewatch')?.value || '').trim();
                const times_watched_raw = toNumberOrNull(document.getElementById('fld-timeswatch')?.value);
                const times_watched = Number.isFinite(times_watched_raw)
                    ? Math.max(1, Math.floor(Number(times_watched_raw)))
                    : 1;

                if (!watch_date_from_form) {
                    throw new Error('Date Watched is required.');
                }

                if (!Number.isFinite(times_watched) || times_watched < 1) {
                    throw new Error('Times Watched must be at least 1.');
                }

                const insertRow = {
                    user_id: authedUser.id,
                    movie_id,
                    [COL_WATCH_DATE]: watch_date_from_form,
                    tier,
                    overall_rating,
                    acting_rating,
                    pacing_rating,
                    sound_rating,
                    imagery_rating,
                    plot_rating,
                    dialogue_rating,
                    notes,
                    fav_quote
                };

                if (entryType === 'update') {
                    const choice = await promptUpdateWatchChoice();
                    if (!choice) {
                        showToast('Update canceled.', { level: 'warn' });
                        return;
                    }
                    const shouldAddWatch = choice === 'update_and_watch';

                    let watchChoice = null;
                    if (shouldAddWatch) {
                        watchChoice = await promptWatchMethodChoice();
                        if (!watchChoice) {
                            showToast('Update canceled.', { level: 'warn' });
                            return;
                        }
                    }

                    const updateRow = {
                        tier,
                        overall_rating,
                        acting_rating,
                        pacing_rating,
                        sound_rating,
                        imagery_rating,
                        plot_rating,
                        dialogue_rating,
                        notes,
                        fav_quote,
                        updated_at: new Date().toISOString(),
                    };

                    // Final safety gate: absolutely no DB writes if anything is missing.
                    // (This should already be true, but we re-check right before writing.)
                    {
                        const finalMissing = getMissingRequiredFieldsForDiaryFormStrict();
                        if (finalMissing.length > 0) {
                            blockSubmitWithValidationUI(finalMissing);
                            return;
                        }
                    }

                    const { error: updateError } = await supabaseClient
                        .from('Movie Ratings')
                        .update(updateRow)
                        .eq('user_id', authedUser.id)
                        .eq('movie_id', movie_id);

                    if (updateError) throw updateError;

                    if (shouldAddWatch) {
                        await insertWatchLog({
                            user_id: authedUser.id,
                            movie_id,
                            watch_method: watchChoice.watch_method,
                            watch_date: watchChoice.watch_date,
                        });
                    }

                    // Best-effort: if this movie was in Bucket List, remove it now that it's rated.
                    try {
                        await removeMovieFromBucketList({ user_id: authedUser.id, movie_id });
                    } catch (_) {}

                    openRatingsSuccessModal('updated');
                    return;
                }

                // Final safety gate: absolutely no DB writes if anything is missing.
                // (This should already be true, but we re-check right before writing.)
                {
                    const finalMissing = getMissingRequiredFieldsForDiaryFormStrict();
                    if (finalMissing.length > 0) {
                        blockSubmitWithValidationUI(finalMissing);
                        return;
                    }
                }

                const { error: insertError } = await supabaseClient
                    .from('Movie Ratings')
                    .insert(insertRow);

                if (insertError) throw insertError;

                // Only create a Watch Logs row for "Log as New Entry" once per (user,movie),
                // and only after the Movie Ratings insert succeeds.
                if (entryType === 'new') {
                    await insertWatchLogIfMissing({
                        user_id: authedUser.id,
                        movie_id,
                        watch_method,
                        watch_date: watch_date_from_form,
                    });
                }

                // If user says they've watched this movie multiple times, collect the prior watches now.
                // We treat the current save as 1 watch, and ask for the previous (times_watched - 1) entries.
                if (entryType === 'new' && times_watched > 1) {
                    const priorCount = times_watched - 1;
                    const prior = await promptPriorWatches(priorCount);
                    if (prior && Array.isArray(prior.entries) && prior.entries.length > 0) {
                        await insertWatchLogsBulk({
                            user_id: authedUser.id,
                            movie_id,
                            entries: prior.entries,
                        });
                        showToast(`Added ${prior.entries.length} previous watch${prior.entries.length === 1 ? '' : 'es'}!`);
                    }
                }

                // Best-effort: if this movie was in Bucket List, remove it now that it's rated.
                try {
                    await removeMovieFromBucketList({ user_id: authedUser.id, movie_id });
                } catch (_) {}

                openRatingsSuccessModal('saved');
                return;
            } catch (err) {
                const msg = String(err?.message || err || 'Unknown error');
                const code = String(err?.code || '').trim();
                const isDuplicate =
                    code === '23505' ||
                    msg.toLowerCase().includes('duplicate key value') ||
                    msg.includes('movie_ratings_user_movie_unique');

                if (isDuplicate && String(lastKnownEntryType || '').toLowerCase() === 'new') {
                    openDuplicateRatingModal({
                        movie_id: lastKnownMovieId,
                        tmdb_id: lastKnownTmdbId,
                        title: lastKnownTitle,
                    });
                    return;
                }

                showToast(`Save failed: ${msg}`);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        }

        let updateWatchChoiceResolver = null;
        let watchMethodChoiceResolver = null;
        let watchMethodPendingSelection = null;
        let priorWatchesChoiceResolver = null;
        let priorWatchesPendingCount = 0;

        let ratingsSuccessTimer = null;

        function openRatingsSuccessModal(kind) {
            const overlay = document.getElementById('ratings-success-overlay');
            const titleEl = document.getElementById('ratings-success-title');
            if (!overlay) return;

            const k = String(kind || '').toLowerCase();
            if (titleEl) {
                titleEl.textContent = (k === 'updated') ? 'Movie Ratings Updated' : 'Movie Ratings Saved';
            }

            overlay.style.display = 'flex';
            overlay.classList.add('open');

            if (ratingsSuccessTimer) {
                clearTimeout(ratingsSuccessTimer);
                ratingsSuccessTimer = null;
            }

            ratingsSuccessTimer = setTimeout(() => {
                closeRatingsSuccessModal();
            }, 3000);
        }

        function closeRatingsSuccessModal() {
            const overlay = document.getElementById('ratings-success-overlay');

            if (ratingsSuccessTimer) {
                clearTimeout(ratingsSuccessTimer);
                ratingsSuccessTimer = null;
            }

            if (!overlay) return;
            overlay.classList.remove('open');
            overlay.style.display = 'none';
        }

        function openUpdateWatchModal() {
            const overlay = document.getElementById('update-watch-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        let deleteConfirmState = {
            action: null,
            token: null,
            ts: 0,
        };

        let deleteRatingState = {
            user_id: null,
            movie_id: null,
            title: '',
            logs: [],
            source: 'submit',
        };

        function armDeleteConfirmation({ action, token, message, statusElId }) {
            const now = Date.now();
            const statusEl = statusElId ? document.getElementById(statusElId) : null;

            // If the user clicks the same action twice within 8 seconds, treat as confirmed.
            const isSame = (
                deleteConfirmState.action === action &&
                deleteConfirmState.token === token &&
                (now - Number(deleteConfirmState.ts || 0)) < 8000
            );

            if (isSame) {
                deleteConfirmState = { action: null, token: null, ts: 0 };
                if (statusEl) statusEl.textContent = '';
                return true;
            }

            deleteConfirmState = { action, token, ts: now };
            if (statusEl) {
                statusEl.textContent = String(message || 'Click again to confirm.');
                statusEl.style.color = 'rgba(239,68,68,0.95)';
            }
            return false;
        }

        async function openDeleteRatingModalForMovie({ movie_id, title = '', source = 'submit' } = {}) {
            const mid = String(movie_id || '').trim();
            if (!mid) throw new Error('Missing movie_id for delete modal.');

            const { user: authedUser } = await requireAuthOrThrow();

            deleteRatingState = {
                user_id: authedUser.id,
                movie_id: mid,
                title: String(title || '').trim(),
                logs: [],
                source: String(source || 'submit'),
            };

            const overlay = document.getElementById('delete-rating-overlay');
            if (!overlay) return;
            const movieEl = document.getElementById('delete-rating-movie');
            if (movieEl) movieEl.textContent = deleteRatingState.title || 'this movie';

            const statusA = document.getElementById('delete-rating-status');
            const statusB = document.getElementById('delete-logs-status');
            if (statusA) {
                statusA.textContent = '';
                statusA.style.color = 'rgba(255,255,255,0.60)';
            }
            if (statusB) {
                statusB.textContent = '';
                statusB.style.color = 'rgba(255,255,255,0.60)';
            }

            overlay.style.display = 'flex';
            overlay.classList.add('open');

            await loadDeleteRatingWatchLogs();
        }

        function openDeleteRatingModal() {
            (async () => {
                try {
                    let movie_id = String(document.getElementById('fld-movie-id')?.value || '').trim();
                    if (!movie_id) {
                        movie_id = await resolveDbMovieIdFromSelectedMovie(router?.selectedMovie);
                    }
                    if (!movie_id) throw new Error('Missing movie_id for this entry.');

                    const title = String(router?.selectedMovie?.title || '').trim();
                    await openDeleteRatingModalForMovie({ movie_id, title, source: 'submit' });
                } catch (err) {
                    showToast(String(err?.message || err || 'Delete failed.'), { level: 'warn' });
                }
            })();
        }

        function closeDeleteRatingModal() {
            const overlay = document.getElementById('delete-rating-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
            overlay.style.display = 'none';
        }

        async function loadDeleteRatingWatchLogs() {
            const list = document.getElementById('delete-logs-list');
            const countEl = document.getElementById('delete-logs-count');
            const btn = document.getElementById('btn-delete-selected-logs');
            if (list) {
                list.innerHTML = `<div class="text-sm" style="color: rgba(255,255,255,0.65);">Loading watch logs</div>`;
            }

            deleteRatingState.logs = [];

            const { user_id, movie_id } = deleteRatingState;
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id || !movie_id) throw new Error('Missing delete context. Close and re-open Delete.');

            const { data, error } = await supabaseClient
                .from('Watch Logs')
                .select(`id, watch_method, ${COL_WATCH_DATE}`)
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .order(COL_WATCH_DATE, { ascending: false })
                .order('id', { ascending: false });

            if (error) throw error;

            const logs = Array.isArray(data) ? data : [];
            deleteRatingState.logs = logs;

            if (countEl) {
                countEl.textContent = `${logs.length} watch log${logs.length === 1 ? '' : 's'}`;
            }

            if (!list) return;

            if (logs.length === 0) {
                list.innerHTML = `<div class="text-sm" style="color: rgba(255,255,255,0.65);">No watch logs found for this movie.</div>`;
                if (btn) {
                    btn.disabled = true;
                    btn.setAttribute('aria-disabled', 'true');
                    btn.title = 'No watch logs to delete.';
                }
                return;
            }

            const fmt = (raw) => {
                const s = String(raw ?? '').trim();
                return s || '(unknown date)';
            };

            list.innerHTML = logs.map((r) => {
                const id = String(r?.id || '').trim();
                const method = String(r?.watch_method || '');
                const wd = fmt(r?.[COL_WATCH_DATE]);
                const label = method ? `${wd}  ${escapeHtml(method)}` : `${wd}`;
                return `
                    <label style="display:flex; gap: 0.65rem; align-items: flex-start; padding: 0.65rem; border: 1px solid rgba(255,255,255,0.08); border-radius: 0.85rem; background: rgba(255,255,255,0.03);">
                        <input type="checkbox" class="delete-log-checkbox" data-log-id="${escapeHtml(id)}" onchange="handleDeleteLogCheckboxChange()" style="margin-top: 0.25rem;">
                        <div style="display:flex; flex-direction: column; gap: 0.2rem;">
                            <div class="text-white font-semibold" style="font-size: 0.9rem;">${label}</div>
                            <div class="text-xs" style="color: rgba(255,255,255,0.60);">id: ${escapeHtml(id)}</div>
                        </div>
                    </label>
                `;
            }).join('');

            handleDeleteLogCheckboxChange();
        }

        function getDeleteSelectedLogIds() {
            try {
                const checked = Array.from(document.querySelectorAll('#delete-logs-list .delete-log-checkbox:checked'));
                return checked
                    .map((el) => String(el?.getAttribute('data-log-id') || '').trim())
                    .filter(Boolean);
            } catch (_) {
                return [];
            }
        }

        function handleDeleteLogCheckboxChange() {
            const btn = document.getElementById('btn-delete-selected-logs');
            const status = document.getElementById('delete-logs-status');
            const total = Array.isArray(deleteRatingState.logs) ? deleteRatingState.logs.length : 0;
            const selectedIds = getDeleteSelectedLogIds();
            const selectedCount = selectedIds.length;

            if (status) status.textContent = '';

            if (!btn) return;
            if (total === 0 || selectedCount === 0) {
                btn.disabled = true;
                btn.setAttribute('aria-disabled', 'true');
                btn.title = total === 0 ? 'No watch logs to delete.' : 'Select at least one watch log.';
                btn.textContent = 'Delete selected';
                return;
            }

            if (selectedCount >= total) {
                btn.disabled = true;
                btn.setAttribute('aria-disabled', 'true');
                btn.title = 'You must keep at least 1 watch log.';
                btn.textContent = `Delete selected (${selectedCount})`;
                if (status) status.textContent = 'You cannot delete all watch logs. Leave at least 1 unchecked.';
                return;
            }

            btn.disabled = false;
            btn.setAttribute('aria-disabled', 'false');
            btn.title = `Delete ${selectedCount} watch log${selectedCount === 1 ? '' : 's'}.`;
            btn.textContent = `Delete selected (${selectedCount})`;
        }

        function clearDeleteLogsSelection() {
            try {
                document.querySelectorAll('#delete-logs-list .delete-log-checkbox').forEach((el) => {
                    el.checked = false;
                });
            } catch (_) {}
            handleDeleteLogCheckboxChange();
        }

        function toggleSelectAllDeleteLogs() {
            const boxes = Array.from(document.querySelectorAll('#delete-logs-list .delete-log-checkbox'));
            if (boxes.length === 0) return;
            const allChecked = boxes.every(b => b.checked);
            boxes.forEach((b) => { b.checked = !allChecked; });
            handleDeleteLogCheckboxChange();
        }

        async function confirmDeleteSelectedWatchLogs() {
            try {
                const { user_id, movie_id } = deleteRatingState;
                if (!user_id || !movie_id) throw new Error('Missing delete context. Close and re-open Delete.');
                const total = Array.isArray(deleteRatingState.logs) ? deleteRatingState.logs.length : 0;
                const ids = getDeleteSelectedLogIds();
                if (ids.length === 0) {
                    showToast('Select at least one watch log to delete.', { level: 'warn' });
                    return;
                }
                if (total > 0 && ids.length >= total) {
                    showToast('You must keep at least 1 watch log.', { level: 'warn' });
                    return;
                }
                const status = document.getElementById('delete-logs-status');
                if (status) {
                    status.textContent = '';
                    status.style.color = 'rgba(255,255,255,0.60)';
                }

                const token = `${user_id}:${movie_id}:${ids.slice().sort().join(',')}`;
                const confirmed = armDeleteConfirmation({
                    action: 'delete_selected_logs',
                    token,
                    statusElId: 'delete-logs-status',
                    message: `Click Delete selected again to confirm deleting ${ids.length} watch log${ids.length === 1 ? '' : 's'} (you must keep at least 1).`,
                });
                if (!confirmed) return;

                if (status) {
                    status.textContent = 'Deleting selected watch logs';
                    status.style.color = 'rgba(255,255,255,0.60)';
                }

                const { error: delErr } = await supabaseClient
                    .from('Watch Logs')
                    .delete()
                    .in('id', ids)
                    .eq('user_id', user_id)
                    .eq('movie_id', movie_id);

                if (delErr) throw delErr;

                // Keep Movie Ratings watch_date aligned to the latest remaining Watch Logs entry.
                const latest = await getLatestWatchLog({ user_id, movie_id });
                const latestDate = String(latest?.[COL_WATCH_DATE] || '').trim();
                if (latestDate) {
                    const { error: updErr } = await supabaseClient
                        .from('Movie Ratings')
                        .update({
                            [COL_WATCH_DATE]: latestDate,
                            updated_at: new Date().toISOString(),
                        })
                        .eq('user_id', user_id)
                        .eq('movie_id', movie_id);
                    if (updErr) throw updErr;
                }

                const remaining = await getWatchLogCount({ user_id, movie_id });
                const timesEl = document.getElementById('fld-timeswatch');
                if (timesEl && Number.isFinite(Number(remaining)) && Number(remaining) >= 1) {
                    timesEl.value = String(Number(remaining));
                }

                showToast(`Deleted ${ids.length} watch log${ids.length === 1 ? '' : 's'}.`);
                await loadDeleteRatingWatchLogs();

                // If launched from My Movies, refresh the cards behind the modal.
                if (String(deleteRatingState?.source || '') === 'library' && String(router?.currentPage || '') === 'library') {
                    await loadLibraryPage({ reset: true });
                }
            } catch (err) {
                const msg = String(err?.message || err);
                const status = document.getElementById('delete-logs-status');
                if (status) {
                    status.textContent = `Delete failed: ${msg}`;
                    status.style.color = 'rgba(239,68,68,0.95)';
                }
                showToast(`Delete failed: ${msg}`);
            }
        }

        async function confirmDeleteRatingAndAllLogs() {
            try {
                const { user_id, movie_id, title } = deleteRatingState;
                if (!user_id || !movie_id) throw new Error('Missing delete context. Close and re-open Delete.');
                const status = document.getElementById('delete-rating-status');
                if (status) {
                    status.textContent = '';
                    status.style.color = 'rgba(255,255,255,0.60)';
                }

                const token = `${user_id}:${movie_id}`;
                const confirmed = armDeleteConfirmation({
                    action: 'delete_rating_and_all_logs',
                    token,
                    statusElId: 'delete-rating-status',
                    message: `Click again to confirm deleting your rating and all watch logs for ${title || 'this movie'}. This cannot be undone.`,
                });
                if (!confirmed) return;

                if (status) {
                    status.textContent = 'Deleting rating and watch logs';
                    status.style.color = 'rgba(255,255,255,0.60)';
                }

                // Delete logs first (works with or without DB cascades).
                const { error: logsErr } = await supabaseClient
                    .from('Watch Logs')
                    .delete()
                    .eq('user_id', user_id)
                    .eq('movie_id', movie_id);
                if (logsErr) throw logsErr;

                const { error: ratingErr } = await supabaseClient
                    .from('Movie Ratings')
                    .delete()
                    .eq('user_id', user_id)
                    .eq('movie_id', movie_id);
                if (ratingErr) throw ratingErr;

                closeDeleteRatingModal();
                showToast('Deleted rating and watch logs.');
                if (String(deleteRatingState?.source || '') === 'library' && String(router?.currentPage || '') === 'library') {
                    await loadLibraryPage({ reset: true });
                } else {
                    try { router.navigate('library'); } catch (_) { router.navigate('home'); }
                }
            } catch (err) {
                const msg = String(err?.message || err);
                const status = document.getElementById('delete-rating-status');
                if (status) {
                    status.textContent = `Delete failed: ${msg}`;
                    status.style.color = 'rgba(239,68,68,0.95)';
                }
                showToast(`Delete failed: ${msg}`);
            }
        }

        function closeUpdateWatchModal(choice) {
            const overlay = document.getElementById('update-watch-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }

            try {
                if (typeof updateWatchChoiceResolver === 'function') {
                    const resolve = updateWatchChoiceResolver;
                    updateWatchChoiceResolver = null;
                    resolve(choice);
                }
            } catch (_) {
                updateWatchChoiceResolver = null;
            }
        }

        function promptUpdateWatchChoice() {
            // Returns: 'update_only' | 'update_and_watch' | null
            return new Promise((resolve) => {
                updateWatchChoiceResolver = resolve;
                openUpdateWatchModal();
            });
        }

        function openWatchMethodModal() {
            const overlay = document.getElementById('watch-method-overlay');
            if (!overlay) return;
            const dateEl = document.getElementById('watch-method-date');
            if (dateEl) {
                dateEl.value = getLocalISODate();
            }

            // Reset selection every time to prevent accidental saves.
            watchMethodPendingSelection = null;
            try {
                overlay.setAttribute('data-has-selection', 'false');
                const saveBtn = document.getElementById('watch-method-save');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.setAttribute('aria-disabled', 'true');
                }
                overlay.querySelectorAll('[data-watch-method-option="true"]').forEach((btn) => {
                    btn.classList.remove('selected');
                    btn.setAttribute('aria-pressed', 'false');
                });
            } catch (_) {}

            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function selectWatchMethodModal(method) {
            watchMethodPendingSelection = String(method || '').trim() || null;
            const overlay = document.getElementById('watch-method-overlay');
            if (!overlay) return;

            try {
                overlay.setAttribute('data-has-selection', watchMethodPendingSelection ? 'true' : 'false');
                overlay.querySelectorAll('[data-watch-method-option="true"]').forEach((btn) => {
                    const isSelected = String(btn.textContent || '').trim() === watchMethodPendingSelection;
                    btn.classList.toggle('selected', isSelected);
                    btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                });
                const saveBtn = document.getElementById('watch-method-save');
                if (saveBtn) {
                    saveBtn.disabled = !watchMethodPendingSelection;
                    saveBtn.setAttribute('aria-disabled', (!watchMethodPendingSelection).toString());
                }
            } catch (_) {}
        }

        function submitWatchMethodModal() {
            if (!watchMethodPendingSelection) {
                showToast('Select At Home or In Theater, then tap Save.', { level: 'warn' });
                return;
            }

            const dateEl = document.getElementById('watch-method-date');
            const watch_date = String(dateEl?.value || '').trim();
            if (!watch_date) {
                showToast('Please select a watch date.', { level: 'warn' });
                try { dateEl?.focus?.(); } catch (_) {}
                return;
            }

            closeWatchMethodModal({
                watch_method: watchMethodPendingSelection,
                watch_date,
            });
        }

        function closeWatchMethodModal(choice) {
            const overlay = document.getElementById('watch-method-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }

            try {
                if (typeof watchMethodChoiceResolver === 'function') {
                    const resolve = watchMethodChoiceResolver;
                    watchMethodChoiceResolver = null;
                    resolve(choice);
                }
            } catch (_) {
                watchMethodChoiceResolver = null;
            }
        }

        function promptWatchMethodChoice() {
            // Returns: { watch_method: 'At Home' | 'In Theater', watch_date: 'YYYY-MM-DD' } | null
            return new Promise((resolve) => {
                watchMethodChoiceResolver = resolve;
                openWatchMethodModal();
            });
        }

        function openPriorWatchesModal(count) {
            priorWatchesPendingCount = Math.max(0, Math.floor(Number(count || 0)));
            const overlay = document.getElementById('prior-watches-overlay');
            const msg = document.getElementById('prior-watches-message');
            const fields = document.getElementById('prior-watches-fields');
            if (!overlay || !fields) return;

            if (msg) {
                msg.textContent = `It looks like you've seen this movie multiple times; please tell us about the first ${priorWatchesPendingCount} time${priorWatchesPendingCount === 1 ? '' : 's'} you've seen this movie.`;
            }

            const today = getLocalISODate();
            fields.innerHTML = Array.from({ length: priorWatchesPendingCount }).map((_, i) => {
                const n = i + 1;
                return `
                    <div style="border: 1px solid rgba(255,255,255,0.08); border-radius: 0.75rem; padding: 0.85rem; background: rgba(255,255,255,0.03);">
                        <div class="text-sm text-white font-semibold" style="margin-bottom: 0.5rem;">Previous viewing #${n}</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label class="text-xs text-gray" style="display:block; margin-bottom: 0.35rem;">Date</label>
                                <input id="prior-watch-date-${n}" type="date" class="input-field" max="${today}" onclick="openDatePickerFromInput(this)" onfocus="openDatePickerFromInput(this)" required>
                            </div>
                            <div>
                                <label class="text-xs text-gray" style="display:block; margin-bottom: 0.35rem;">Watch Method</label>
                                <select id="prior-watch-method-${n}" class="input-field" required>
                                    <option value="" disabled selected>Select...</option>
                                    <option value="At Home">At Home</option>
                                    <option value="In Theater">In Theater</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function closePriorWatchesModal(result) {
            const overlay = document.getElementById('prior-watches-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }

            try {
                if (typeof priorWatchesChoiceResolver === 'function') {
                    const resolve = priorWatchesChoiceResolver;
                    priorWatchesChoiceResolver = null;
                    resolve(result);
                }
            } catch (_) {
                priorWatchesChoiceResolver = null;
            }
        }

        function submitPriorWatchesModal() {
            const entries = [];
            for (let i = 1; i <= priorWatchesPendingCount; i++) {
                const dateEl = document.getElementById(`prior-watch-date-${i}`);
                const methodEl = document.getElementById(`prior-watch-method-${i}`);
                const watch_date = String(dateEl?.value || '').trim();
                const watch_method = String(methodEl?.value || '').trim() || null;
                if (!watch_date) {
                    showToast(`Please select a date for previous viewing #${i}.`, { level: 'warn' });
                    try { dateEl?.focus?.(); } catch (_) {}
                    return;
                }
                if (!watch_method) {
                    showToast(`Please select a watch method for previous viewing #${i}.`, { level: 'warn' });
                    try { methodEl?.focus?.(); } catch (_) {}
                    return;
                }
                entries.push({ watch_date, watch_method });
            }

            closePriorWatchesModal({ entries });
        }

        function promptPriorWatches(count) {
            // Returns: { entries: Array<{watch_date, watch_method}> }
            return new Promise((resolve) => {
                priorWatchesChoiceResolver = resolve;
                openPriorWatchesModal(count);
            });
        }

        function getTierHelpText(tier) {
            const t = String(tier || '').trim();
            if (t === 'S-Tier') return 'The Pantheon. Best of the Best.';
            if (t === 'A-Tier') return 'Great! Highly recommended films!';
            if (t === 'B-Tier') return 'Worth a Watch. Solidly good and Entertaining';
            if (t === 'C-Tier') return "Totally Average. Fine if it's on, but don't go out of your way.";
            if (t === 'D-Tier') return 'Skip it. Seriously Flawed and not worth the time.';
            if (t === 'F-Tier') return 'Avoid at all costs! A genuinely bad experience.';
            return 'Choose exactly one tier';
        }

        function setTierFromButton(btn) {
            try {
                const group = btn?.closest?.('.tier-btn-group');
                if (!group) return;
                const tier = String(btn.getAttribute('data-tier') || '').trim();
                const targetInputId = String(group.getAttribute('data-target-input') || '').trim();
                const input = targetInputId ? document.getElementById(targetInputId) : null;
                if (input) input.value = tier;

                group.querySelectorAll('.tier-btn').forEach((b) => {
                    const isSelected = b === btn;
                    b.classList.toggle('selected', isSelected);
                    b.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                });

                group.setAttribute('data-has-selection', tier ? 'true' : 'false');

                const help = document.getElementById('tier-help-text');
                if (help) help.textContent = getTierHelpText(tier);
            } catch (_) {}
        }

        function showLoadingOverlay(message) {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            if (message) {
                try {
                    const msgEl = overlay.querySelector('.text-sm span:last-child');
                    if (msgEl) msgEl.textContent = String(message);
                } catch (_) {}
            }
            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
            overlay.style.display = 'none';
        }

        function toggleWatchMethod(btn) {
            try {
                if (btn?.disabled) return;
            } catch (_) {}
            const isTheater = btn.textContent.trim().toLowerCase().includes('theater');
            const hidden = document.getElementById('fld-watchmethod');
            if (isTheater) {
                btn.textContent = 'At Home';
                if (hidden) hidden.value = 'At Home';
                btn.style.backgroundColor = 'rgba(168, 85, 247, 0.35)';
                btn.style.borderColor = 'rgba(168, 85, 247, 0.5)';
            } else {
                btn.textContent = 'In Theater';
                if (hidden) hidden.value = 'In Theater';
                btn.style.backgroundColor = 'rgba(20, 184, 166, 0.35)';
                btn.style.borderColor = 'rgba(20, 184, 166, 0.5)';
            }
        }

        async function requireAuthOrThrow() {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const { data, error } = await supabaseClient.auth.getSession();
            if (error) throw error;
            let session = data?.session || null;
            let user = session?.user || null;
            let accessToken = session?.access_token || null;
            if (!user?.id || !accessToken) throw new Error('Please log in first.');

            // Validate the token with Supabase Auth. If invalid/expired, try a refresh.
            const { data: userData, error: userErr } = await supabaseClient.auth.getUser();
            if (userErr || !userData?.user?.id) {
                const { data: refreshed, error: refreshErr } = await supabaseClient.auth.refreshSession();
                if (refreshErr) {
                    throw new Error('Session invalid. Click Log out, then Log in again.');
                }
                session = refreshed?.session || null;
                user = session?.user || null;
                accessToken = session?.access_token || null;
                if (!user?.id || !accessToken) {
                    throw new Error('Session invalid. Click Log out, then Log in again.');
                }

                const { data: userData2, error: userErr2 } = await supabaseClient.auth.getUser();
                if (userErr2 || !userData2?.user?.id) {
                    throw new Error('Invalid JWT. Click Log out, then Log in again.');
                }
            }

            return { user, accessToken };
        }

        async function insertWatchLog({ user_id, movie_id, watch_method = null, watch_date }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');
            const wd = String(watch_date || '').trim();
            if (!wd) throw new Error('Missing watch_date.');

            const row = {
                user_id,
                movie_id,
                watch_method,
                [COL_WATCH_DATE]: wd,
            };

            const { error } = await supabaseClient
                .from('Watch Logs')
                .insert(row);

            if (error) throw error;
        }

        async function insertWatchLogIfMissing({ user_id, movie_id, watch_method = null, watch_date }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');
            const wd = String(watch_date || '').trim();
            if (!wd) throw new Error('Missing watch_date.');

            const { data: existing, error: existsErr } = await supabaseClient
                .from('Watch Logs')
                .select('id')
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .limit(1);

            if (existsErr) throw existsErr;
            if (Array.isArray(existing) && existing.length > 0) return;

            await insertWatchLog({ user_id, movie_id, watch_method, watch_date: wd });
        }

        async function insertWatchLogsBulk({ user_id, movie_id, entries }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');
            if (!Array.isArray(entries) || entries.length === 0) return;

            const rows = entries.map((e) => {
                const wd = String(e?.watch_date || '').trim();
                if (!wd) throw new Error('Missing watch_date.');
                return {
                    user_id,
                    movie_id,
                    watch_method: (e?.watch_method ?? null),
                    [COL_WATCH_DATE]: wd,
                };
            });

            const { error } = await supabaseClient
                .from('Watch Logs')
                .insert(rows);

            if (error) throw error;
        }

        function isUuidLike(v) {
            return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(v || '').trim());
        }

        function getTmdbIdFromSelectedMovie(movie) {
            if (!movie) return null;
            // Common shapes:
            // - movie.tmdb_id (number)
            // - movie.id (TMDb numeric id)
            // - movie.id (uuid) -> ignore
            if (movie?.tmdb_id !== undefined && movie?.tmdb_id !== null) {
                const n = Number(movie.tmdb_id);
                return Number.isFinite(n) && n > 0 ? n : null;
            }

            const rawId = movie?.id;
            if (isUuidLike(rawId)) return null;
            const n = Number(rawId);
            return Number.isFinite(n) && n > 0 ? n : null;
        }

        async function getDbMovieIdByTmdbId(tmdb_id) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const n = Number(tmdb_id);
            if (!Number.isFinite(n) || n <= 0) throw new Error('Missing tmdb_id.');

            const { data, error } = await supabaseClient
                .from('Movies')
                .select('id')
                .eq('tmdb_id', n)
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0]?.id || null;
        }

        async function getDbMovieRowById(movie_id) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Movies')
                .select('*')
                .eq('id', movie_id)
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function resolveDbMovieIdFromSelectedMovie(movie) {
            if (!movie) return null;
            // Allow callers (like Data Dash poster clicks) to pass the DB id explicitly.
            if (movie?.db_movie_id !== undefined && movie?.db_movie_id !== null && String(movie.db_movie_id).trim() !== '') {
                return movie.db_movie_id;
            }
            if (isUuidLike(movie?.id)) return movie.id;
            const tmdb_id = getTmdbIdFromSelectedMovie(movie);
            if (!tmdb_id) return null;
            return await getDbMovieIdByTmdbId(tmdb_id);
        }

        async function hasExistingMovieRating({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Movie Ratings')
                .select('id')
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .limit(1);

            if (error) throw error;
            return Array.isArray(data) && data.length > 0;
        }

        async function getExistingMovieRatingRow({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Movie Ratings')
                .select('*')
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function getLatestWatchLog({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Watch Logs')
                .select(`id, watch_method, ${COL_WATCH_DATE}`)
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .order(COL_WATCH_DATE, { ascending: false })
                .order('id', { ascending: false })
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function getEarliestWatchLog({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Watch Logs')
                .select(`id, watch_method, ${COL_WATCH_DATE}`)
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .order(COL_WATCH_DATE, { ascending: true })
                .order('id', { ascending: true })
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function getWatchLogCount({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            // Use an efficient count-only query.
            const { count, error } = await supabaseClient
                .from('Watch Logs')
                .select('id', { count: 'exact', head: true })
                .eq('user_id', user_id)
                .eq('movie_id', movie_id);

            if (error) throw error;
            return Number.isFinite(Number(count)) ? Number(count) : 0;
        }

        function getLocalISODate(d = new Date()) {
            const dt = (d instanceof Date) ? d : new Date(d);
            const year = dt.getFullYear();
            const month = String(dt.getMonth() + 1).padStart(2, '0');
            const day = String(dt.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function decodeJwtPayload(token) {
            try {
                const parts = String(token || '').split('.');
                if (parts.length < 2) return null;
                const b64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                const padded = b64 + '='.repeat((4 - (b64.length % 4)) % 4);
                const json = atob(padded);
                return JSON.parse(json);
            } catch (_) {
                return null;
            }
        }

        async function callSwiftApi(body, accessToken) {
            const iss = decodeJwtPayload(accessToken)?.iss;
            if (iss && typeof iss === 'string' && !iss.includes(SUPABASE_URL)) {
                throw new Error(
                    `Auth token is for a different Supabase project (iss=${iss}). Check SUPABASE_URL.`
                );
            }

            const url = `${SUPABASE_URL}/functions/v1/swift-api`;
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify(body)
            });

            const text = await res.text();
            let data = null;
            try {
                data = text ? JSON.parse(text) : null;
            } catch (_) {
                data = text;
            }

            if (!res.ok) {
                const serverMsg =
                    data && typeof data === 'object'
                        ? (data.message || data.error || JSON.stringify(data))
                        : String(data || '');
                const serverDetails =
                    data && typeof data === 'object' && data.details
                        ? ` (${String(data.details)})`
                        : '';
                throw new Error(`swift-api failed (HTTP ${res.status}) - ${serverMsg}${serverDetails}`);
            }

            return data;
        }

        let cachedAuthUser = null;
        let cachedIsAuthed = false;

        let cachedUserDisplayNameId = null;
        let cachedUserDisplayName = '';
        let cachedUserDisplayNameLoaded = false;

        function fallbackAccountName(user) {
            const email = String(user?.email || '').trim();
            if (email) return email.split('@')[0] || email;

            const id = String(user?.id || '').trim();
            if (!id) return '';
            return id.length > 8 ? `${id.slice(0, 8)}` : id;
        }

        async function refreshAuthStateAndUI() {
            if (!supabaseClient) return;

            const navLoginBtn = document.getElementById('nav-login-btn');
            const statusEl = document.getElementById('auth-modal-status');
            const loginBtn = document.getElementById('auth-login-btn');
            const logoutBtn = document.getElementById('auth-logout-btn');
            const emailEl = document.getElementById('auth-email');
            const pwdEl = document.getElementById('auth-password');
            const saveBtn = document.getElementById('btn-save-diary');

            const { data, error } = await supabaseClient.auth.getSession();
            if (error) {
                cachedAuthUser = null;
                cachedIsAuthed = false;
                if (statusEl) statusEl.textContent = 'Auth error.';
                if (statusEl) statusEl.style.color = 'rgba(239,68,68,0.95)';
                if (navLoginBtn) navLoginBtn.textContent = 'Login';
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = 0.6;
                    saveBtn.setAttribute('aria-disabled', 'true');
                    saveBtn.title = 'Please log in first.';
                }
                return;
            }

            const user = data?.session?.user || null;
            const isAuthed = Boolean(user?.id);

            cachedAuthUser = user;
            cachedIsAuthed = isAuthed;

            if (isAuthed) {
                const uid = String(user.id);
                // Best-effort; don't block UI.
                ensureBucketListForUser({ user_id: uid }).catch(() => null);
            } else {
                cachedLists = [];
                cachedListsUserId = null;
                listsActiveListId = null;
                listsActiveListName = '';
                cachedBucketListId = null;
                bucketListEnsuredForUserId = null;
            }

            let displayName = '';
            if (isAuthed) {
                const uid = String(user.id);
                if (cachedUserDisplayNameId !== uid) {
                    cachedUserDisplayNameId = uid;
                    cachedUserDisplayName = '';
                    cachedUserDisplayNameLoaded = false;
                }

                if (!cachedUserDisplayNameLoaded) {
                    cachedUserDisplayNameLoaded = true;
                    try {
                        const { data: usersRows, error: usersErr } = await supabaseClient
                            .from('Users')
                            .select('display_name')
                            .eq('id', uid)
                            .limit(1);
                        if (!usersErr && Array.isArray(usersRows) && usersRows.length > 0) {
                            cachedUserDisplayName = String(usersRows[0]?.display_name || '').trim();
                        }
                    } catch (_) {
                        // RLS or missing table: fall back silently.
                    }
                }

                displayName = String(cachedUserDisplayName || '').trim();
            }

            if (navLoginBtn) {
                if (isAuthed) {
                    const dn = displayName || fallbackAccountName(user);
                    navLoginBtn.textContent = dn ? `${dn} - Account` : 'Account';
                } else {
                    navLoginBtn.textContent = 'Login';
                }
            }

            const mobileAuthBtn = document.getElementById('mobile-auth-btn');
            if (mobileAuthBtn) {
                mobileAuthBtn.textContent = isAuthed
                    ? (displayName ? `${displayName} - Account` : 'Account')
                    : 'Login';
            }
            if (statusEl) {
                if (isAuthed) {
                    const dn = displayName || fallbackAccountName(user);
                    statusEl.textContent = dn ? `Logged in as ${dn}` : `Logged in as ${user.email || user.id}`;
                } else {
                    statusEl.textContent = 'Not logged in.';
                }
                statusEl.style.color = 'var(--text-muted)';
            }
            if (loginBtn) loginBtn.style.display = isAuthed ? 'none' : 'inline-flex';
            if (logoutBtn) logoutBtn.style.display = isAuthed ? 'inline-flex' : 'none';

            if (emailEl) {
                emailEl.disabled = isAuthed;
                emailEl.classList.toggle('input-readonly', isAuthed);
            }
            if (pwdEl) {
                pwdEl.disabled = isAuthed;
                pwdEl.classList.toggle('input-readonly', isAuthed);
            }

            if (saveBtn) {
                const locked = !isAuthed;
                saveBtn.disabled = false;
                saveBtn.style.opacity = locked ? 0.6 : 1;
                saveBtn.setAttribute('aria-disabled', locked ? 'true' : 'false');
                saveBtn.title = locked ? 'Please log in first.' : '';
            }
        }

        async function handleLoginClick(e) {
            e?.preventDefault?.();
            try {
                if (!supabaseClient) throw new Error('Supabase client not initialized.');
                const email = String(document.getElementById('auth-email')?.value || '').trim();
                const password = String(document.getElementById('auth-password')?.value || '').trim();
                if (!email || !password) throw new Error('Enter email + password, then click Log in.');

                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                // Validate immediately (catches Invalid JWT situations early).
                const { data: userData, error: userErr } = await supabaseClient.auth.getUser();
                if (userErr || !userData?.user?.id) {
                    await supabaseClient.auth.signOut();
                    throw new Error('Login succeeded, but session token is invalid for this project. Verify SUPABASE_URL/keys.');
                }

                const pwdEl = document.getElementById('auth-password');
                if (pwdEl) pwdEl.value = '';

                await refreshAuthStateAndUI();
                showToast('Logged in. You can now save.');
                closeAuthModal();
            } catch (err) {
                // Refresh UI first (so button visibility/disabled states are correct),
                // then set the error text last so it doesn't get overwritten.
                await refreshAuthStateAndUI();

                const statusEl = document.getElementById('auth-modal-status');
                if (statusEl) {
                    statusEl.textContent = `Login failed: ${String(err?.message || err)}`;
                    statusEl.style.color = 'rgba(239,68,68,0.95)';
                }
            }
        }

        async function handleLogoutClick(e) {
            e?.preventDefault?.();
            try {
                if (!supabaseClient) return;
                await supabaseClient.auth.signOut();
                await refreshAuthStateAndUI();
                showToast('Logged out.');
                closeAuthModal();
            } catch (err) {
                showToast(`Logout failed: ${String(err.message || err)}`);
            }
        }

        function openAuthModal() {
            const overlay = document.getElementById('auth-overlay');
            if (!overlay) return;
            overlay.classList.add('open');
            refreshAuthStateAndUI();

            // Focus the first enabled field.
            const emailEl = document.getElementById('auth-email');
            const pwdEl = document.getElementById('auth-password');
            if (emailEl && !emailEl.disabled) emailEl.focus();
            else if (pwdEl && !pwdEl.disabled) pwdEl.focus();
        }

        function openDashboardAuthWarning() {
            const overlay = document.getElementById('dashboard-auth-warning');
            if (!overlay) return;
            overlay.classList.add('open');
        }

        function openAccountAuthWarning() {
            const overlay = document.getElementById('account-auth-warning');
            if (!overlay) return;
            overlay.classList.add('open');
        }

        function closeDashboardAuthWarning() {
            const overlay = document.getElementById('dashboard-auth-warning');
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        function closeAccountAuthWarning() {
            const overlay = document.getElementById('account-auth-warning');
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        function closeAuthModal() {
            const overlay = document.getElementById('auth-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        function handleNavAccountButtonClick(e) {
            e?.preventDefault?.();
            try {
                if (cachedIsAuthed) {
                    router.navigate('account');
                    return;
                }
                openAuthModal();
            } catch (_) {
                openAuthModal();
            }
        }

        let accountBound = false;
        let accountSelectedIconId = '';

        function getPresetUserIconOptions() {
            // These IDs should match your `Users.icon` allowed values.
            return [
                { id: 'icon_01', svg: icons.film },
                { id: 'icon_02', svg: icons.quote },
                { id: 'icon_03', svg: icons.activity },
                { id: 'icon_04', svg: icons.tv },
                { id: 'icon_05', svg: icons.video },
                { id: 'icon_06', svg: icons.pieChart },
                { id: 'icon_07', svg: icons.barChart2 },
                { id: 'icon_08', svg: icons.percent },
                { id: 'icon_09', svg: icons.clock },
                { id: 'icon_10', svg: icons.user },
            ];
        }

        function isValidPresetUserIconId(iconId) {
            const id = String(iconId || '').trim();
            return /^icon_0[1-9]$/.test(id) || id === 'icon_10';
        }

        function renderUserIconHtml(iconId, sizePx = 28) {
            const id = isValidPresetUserIconId(iconId) ? String(iconId).trim() : '';
            const options = getPresetUserIconOptions();
            const match = options.find(o => o.id === id) || null;
            const svg = match?.svg || icons.user;
            const safeId = match?.id || 'icon_10';

            return `
                <span class="user-icon" data-icon-id="${escapeHtml(safeId)}" style="width:${Number(sizePx)}px; height:${Number(sizePx)}px;">
                    ${svg}
                </span>
            `;
        }

        function renderAccountIconGrid() {
            const grid = document.getElementById('account-icon-grid');
            if (!grid) return;

            const options = getPresetUserIconOptions();
            grid.innerHTML = options.map((opt) => {
                const pressed = accountSelectedIconId === opt.id;
                return `
                    <button type="button" class="account-icon-btn" data-account-icon-id="${escapeHtml(opt.id)}" aria-pressed="${pressed ? 'true' : 'false'}" title="${escapeHtml(opt.id)}">
                        ${renderUserIconHtml(opt.id, 34)}
                    </button>
                `;
            }).join('');
        }

        function syncAccountIconUI() {
            const hidden = document.getElementById('account-icon');
            if (hidden) hidden.value = String(accountSelectedIconId || '').trim();

            const grid = document.getElementById('account-icon-grid');
            if (!grid) return;
            grid.querySelectorAll('[data-account-icon-id]').forEach((btn) => {
                const id = String(btn?.dataset?.accountIconId || '').trim();
                const on = id && id === accountSelectedIconId;
                btn.setAttribute('aria-pressed', on ? 'true' : 'false');
            });
        }

        function normalizeUsername(raw) {
            const s = String(raw || '').trim().replace(/^@+/, '').toLowerCase();
            return s;
        }

        function validateUsername(username) {
            const u = normalizeUsername(username);
            if (!u) return 'Username is required.';
            if (u.length < 3 || u.length > 20) return 'Username must be 320 characters.';
            if (!/^[a-z0-9_]+$/.test(u)) return 'Username can only include letters, numbers, and underscore.';
            return '';
        }

        function initAccountPage() {
            if (accountBound) return;
            accountBound = true;

            document.addEventListener('click', async (e) => {
                const iconBtn = e?.target?.closest ? e.target.closest('[data-account-icon-id]') : null;
                if (iconBtn) {
                    const id = String(iconBtn.dataset.accountIconId || '').trim();
                    if (isValidPresetUserIconId(id)) {
                        accountSelectedIconId = id;
                        syncAccountIconUI();
                    }
                    return;
                }

                const btn = e?.target?.closest ? e.target.closest('[data-account-action]') : null;
                if (!btn) return;
                const action = String(btn.dataset.accountAction || '').trim();

                if (action === 'reload') {
                    await loadAccountPage();
                    return;
                }

                if (action === 'logout') {
                    await handleLogoutClick(e);
                    return;
                }
            });

            document.addEventListener('submit', async (e) => {
                const form = e?.target;
                if (!form || !(form instanceof HTMLFormElement)) return;

                if (form.id === 'account-profile-form') {
                    e.preventDefault();
                    await saveAccountProfile();
                    return;
                }

                if (form.id === 'account-password-form') {
                    e.preventDefault();
                    await changeAccountPassword();
                    return;
                }
            });
        }

        async function loadAccountPage() {
            const profileStatus = document.getElementById('account-profile-status');
            const passwordStatus = document.getElementById('account-password-status');
            const emailEl = document.getElementById('account-email');
            const usernameEl = document.getElementById('account-username');
            const dnEl = document.getElementById('account-display-name');
            const iconHidden = document.getElementById('account-icon');

            if (profileStatus) profileStatus.textContent = '';
            if (passwordStatus) passwordStatus.textContent = '';

            if (!supabaseClient || !cachedIsAuthed) {
                if (profileStatus) profileStatus.textContent = 'Log in to manage your account.';
                if (emailEl) emailEl.textContent = '';
                return;
            }

            let user = cachedAuthUser;
            try {
                const { data: udata } = await supabaseClient.auth.getUser();
                user = udata?.user || user;
            } catch (_) {}

            const uid = String(user?.id || '').trim();
            const email = String(user?.email || '').trim();
            if (emailEl) emailEl.textContent = email || '(no email)';

            if (!uid) {
                if (profileStatus) profileStatus.textContent = 'Auth session missing user id.';
                return;
            }

            if (profileStatus) profileStatus.textContent = 'Loading profile';

            // Render picker immediately; selection will update after we load from DB.
            try {
                if (!accountSelectedIconId) accountSelectedIconId = 'icon_01';
                renderAccountIconGrid();
                syncAccountIconUI();
            } catch (_) {}

            try {
                let data = null;
                try {
                    const r1 = await supabaseClient
                        .from('Users')
                        .select('username, display_name, icon')
                        .eq('id', uid)
                        .limit(1);
                    if (r1.error) throw r1.error;
                    data = r1.data;
                } catch (err1) {
                    const msg1 = String(err1?.message || err1);
                    if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                        const r2 = await supabaseClient
                            .from('Users')
                            .select('username, display_name')
                            .eq('id', uid)
                            .limit(1);
                        if (r2.error) throw r2.error;
                        data = r2.data;
                    } else {
                        throw err1;
                    }
                }

                const row = Array.isArray(data) && data.length ? data[0] : null;
                const username = String(row?.username || '').trim();
                const displayName = String(row?.display_name || '').trim();
                const iconId = String(row?.icon || '').trim();

                if (usernameEl) usernameEl.value = username;
                if (dnEl) dnEl.value = displayName;

                if (isValidPresetUserIconId(iconId)) {
                    accountSelectedIconId = iconId;
                } else if (!accountSelectedIconId) {
                    accountSelectedIconId = 'icon_01';
                }
                if (iconHidden) iconHidden.value = accountSelectedIconId;
                renderAccountIconGrid();
                syncAccountIconUI();

                if (profileStatus) profileStatus.textContent = 'Profile loaded.';
            } catch (err) {
                if (profileStatus) profileStatus.textContent = `Could not load profile: ${String(err?.message || err)}`;
            }
        }

        async function saveAccountProfile() {
            const profileStatus = document.getElementById('account-profile-status');
            const saveBtn = document.getElementById('account-save-profile');
            const usernameEl = document.getElementById('account-username');
            const dnEl = document.getElementById('account-display-name');
            const iconHidden = document.getElementById('account-icon');

            if (!supabaseClient || !cachedIsAuthed) {
                showToast('Please log in first.', { level: 'warn' });
                openAuthModal();
                return;
            }

            const uid = String(cachedAuthUser?.id || '').trim();
            if (!uid) {
                showToast('Missing user session.', { level: 'error' });
                return;
            }

            const desiredUsernameRaw = String(usernameEl?.value || '');
            const desiredUsername = normalizeUsername(desiredUsernameRaw);
            const desiredDisplayName = String(dnEl?.value || '').trim();
            const desiredIcon = (() => {
                const v = String(iconHidden?.value || accountSelectedIconId || '').trim();
                return isValidPresetUserIconId(v) ? v : '';
            })();

            const userErr = validateUsername(desiredUsername);
            if (userErr) {
                if (profileStatus) profileStatus.textContent = userErr;
                showToast(userErr, { level: 'warn' });
                return;
            }

            if (desiredDisplayName.length > 50) {
                const msg = 'Display name must be 50 characters or less.';
                if (profileStatus) profileStatus.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }

            const prev = saveBtn?.textContent;
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving';
            }
            if (profileStatus) profileStatus.textContent = 'Saving';

            try {
                const payload = {
                    id: uid,
                    username: desiredUsername,
                    display_name: desiredDisplayName || null,
                    icon: desiredIcon || null,
                };

                let data = null;
                try {
                    const r1 = await supabaseClient
                        .from('Users')
                        .upsert(payload, { onConflict: 'id' })
                        .select('username, display_name, icon')
                        .limit(1);
                    if (r1.error) throw r1.error;
                    data = r1.data;
                } catch (err1) {
                    const msg1 = String(err1?.message || err1);
                    if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                        const payload2 = { id: uid, username: desiredUsername, display_name: desiredDisplayName || null };
                        const r2 = await supabaseClient
                            .from('Users')
                            .upsert(payload2, { onConflict: 'id' })
                            .select('username, display_name')
                            .limit(1);
                        if (r2.error) throw r2.error;
                        data = r2.data;
                    } else {
                        throw err1;
                    }
                }

                const row = Array.isArray(data) && data.length ? data[0] : null;
                const savedDisplayName = String(row?.display_name || '').trim();
                const savedIcon = String(row?.icon || '').trim();

                // Update cached display name so navbar updates immediately.
                cachedUserDisplayNameId = uid;
                cachedUserDisplayName = savedDisplayName;
                cachedUserDisplayNameLoaded = true;
                await refreshAuthStateAndUI();

                if (savedIcon && isValidPresetUserIconId(savedIcon)) {
                    accountSelectedIconId = savedIcon;
                    syncAccountIconUI();
                }

                if (profileStatus) profileStatus.textContent = 'Saved.';
                showToast('Profile updated.');
            } catch (err) {
                const code = String(err?.code || '').trim();
                const msg = String(err?.message || err);
                if (code === '23505' || /duplicate key/i.test(msg)) {
                    if (profileStatus) profileStatus.textContent = 'That username is already taken.';
                    showToast('Username already taken.', { level: 'warn' });
                } else {
                    if (profileStatus) profileStatus.textContent = `Save failed: ${msg}`;
                    showToast(`Save failed: ${msg}`, { level: 'warn' });
                }
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = prev || 'Save profile';
                }
            }
        }

        async function changeAccountPassword() {
            const statusEl = document.getElementById('account-password-status');
            const btn = document.getElementById('account-change-password');
            const newEl = document.getElementById('account-new-password');
            const confirmEl = document.getElementById('account-confirm-password');

            if (!supabaseClient || !cachedIsAuthed) {
                showToast('Please log in first.', { level: 'warn' });
                openAuthModal();
                return;
            }

            const newPassword = String(newEl?.value || '').trim();
            const confirmPassword = String(confirmEl?.value || '').trim();

            if (!newPassword || !confirmPassword) {
                const msg = 'Enter and confirm your new password.';
                if (statusEl) statusEl.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }
            if (newPassword.length < 8) {
                const msg = 'Password must be at least 8 characters.';
                if (statusEl) statusEl.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }
            if (newPassword !== confirmPassword) {
                const msg = 'Passwords do not match.';
                if (statusEl) statusEl.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }

            const prev = btn?.textContent;
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Updating';
            }
            if (statusEl) statusEl.textContent = 'Updating password';

            try {
                const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
                if (error) throw error;

                if (newEl) newEl.value = '';
                if (confirmEl) confirmEl.value = '';
                if (statusEl) statusEl.textContent = 'Password updated.';
                showToast('Password updated.');
            } catch (err) {
                const msg = String(err?.message || err);
                if (statusEl) statusEl.textContent = `Password update failed: ${msg}`;
                showToast(`Password update failed: ${msg}`, { level: 'warn' });
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = prev || 'Change password';
                }
            }
        }

        let toastTimer = null;

        const messageLog = [];
        const MAX_LOG_ITEMS = 300;

        function emitLog(level, message, extra = null) {
            const prefix = '[CinemaTracker]';
            const line = `${prefix} ${String(message || '')}`;

            if (level === 'error') console.error(line, extra ?? '');
            else if (level === 'warn') console.warn(line, extra ?? '');
            else console.log(line, extra ?? '');
        }

        function formatTime(ts) {
            try {
                const d = new Date(ts);
                return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } catch (_) {
                return '';
            }
        }

        function renderMessageLog() {
            const badge = document.getElementById('log-badge');
            const body = document.getElementById('log-body');
            if (badge) badge.innerText = String(messageLog.length);
            if (!body) return;

            body.innerHTML = messageLog
                .map((item) => {
                    const levelClass = item.level === 'error'
                        ? 'log-level-error'
                        : (item.level === 'warn' ? 'log-level-warn' : 'log-level-info');
                    const safeMsg = String(item.message || '').replace(/[&<>"']/g, (c) => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[c]));
                    const safeExtra = item.extra
                        ? String(item.extra).replace(/[&<>"']/g, (c) => ({
                            '&': '&amp;',
                            '<': '&lt;',
                            '>': '&gt;',
                            '"': '&quot;',
                            "'": '&#39;'
                        }[c]))
                        : '';
                    return `
<div class="log-item">
  <div class="log-meta"><span class="${levelClass}">${item.level.toUpperCase()}</span>  ${formatTime(item.ts)}</div>
  <div>${safeMsg}${safeExtra ? `<div class="log-meta">${safeExtra}</div>` : ''}</div>
</div>`;
                })
                .join('');

            // Auto-scroll to bottom
            body.scrollTop = body.scrollHeight;
        }

        function addMessageToLog(level, message, extra = null) {
            messageLog.push({ ts: Date.now(), level, message: String(message ?? ''), extra: extra ? String(extra) : null });
            while (messageLog.length > MAX_LOG_ITEMS) messageLog.shift();
            renderMessageLog();
        }

        function setLogPanelOpen(isOpen) {
            const panel = document.getElementById('log-panel');
            if (!panel) return;
            panel.classList.toggle('open', Boolean(isOpen));
        }

        function showToast(msg, opts = {}) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');

            const text = String(msg ?? '');
            const explicitLevel = String(opts.level || '').toLowerCase();
            const isError = explicitLevel === 'error' || /\b(failed|error)\b/i.test(text);
            const isWarning = explicitLevel === 'warn' || /\bwarning\b/i.test(text);
            const level = isError ? 'error' : (isWarning ? 'warn' : 'info');

            // Persist EVERYTHING (success/warn/error) to the on-page message log.
            addMessageToLog(level, text);

            // Also log errors/warnings to the console.
            if (level === 'error') emitLog('error', text);
            else if (level === 'warn') emitLog('warn', text);

            if (msgEl) msgEl.innerText = text;
            if (iconEl) iconEl.innerHTML = (level === 'info') ? icons.checkCircle : icons.info;

            toast.classList.add('show');

            // Make error toasts stick around longer.
            const durationMs = Number.isFinite(Number(opts.durationMs))
                ? Number(opts.durationMs)
                : (level === 'info' ? 3000 : 15000);

            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toast.classList.remove('show'), durationMs);

            // Allow manual dismiss (click the toast)
            toast.onclick = () => toast.classList.remove('show');
        }

        // Wire up message log UI
        (function initMessageLogUI() {
            const fab = document.getElementById('log-fab');
            const fabIcon = document.getElementById('log-fab-icon');
            const closeBtn = document.getElementById('log-close');
            const clearBtn = document.getElementById('log-clear');
            const copyBtn = document.getElementById('log-copy');

            if (fabIcon) fabIcon.innerHTML = icons.info;

            if (fab) {
                fab.addEventListener('click', () => {
                    const panel = document.getElementById('log-panel');
                    const isOpen = panel?.classList?.contains('open');
                    setLogPanelOpen(!isOpen);
                });
            }

            if (closeBtn) closeBtn.addEventListener('click', () => setLogPanelOpen(false));
            if (clearBtn) clearBtn.addEventListener('click', () => {
                messageLog.length = 0;
                renderMessageLog();
            });
            if (copyBtn) copyBtn.addEventListener('click', async () => {
                const text = messageLog
                    .map((i) => `[${i.level.toUpperCase()} ${formatTime(i.ts)}] ${i.message}${i.extra ? ` | ${i.extra}` : ''}`)
                    .join('\n');
                try {
                    await navigator.clipboard.writeText(text);
                    showToast('Log copied to clipboard');
                } catch (e) {
                    // Fallback
                    try {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        ta.remove();
                        showToast('Log copied to clipboard');
                    } catch (err) {
                        showToast(`Copy failed: ${String(err?.message || err)}`, { level: 'warn' });
                    }
                }
            });

            // Initial render
            renderMessageLog();
        })();

        // Capture uncaught errors and promise rejections too.
        window.addEventListener('error', (e) => {
            try {
                emitLog('error', `Uncaught error: ${e?.message || 'Unknown error'}`);
            } catch (_) {}
        });

        window.addEventListener('unhandledrejection', (e) => {
            try {
                const reason = e?.reason?.message || String(e?.reason || 'Unknown rejection');
                emitLog('error', `Unhandled rejection: ${reason}`);
            } catch (_) {}
        });

        // Keep auth UI synced with session changes.
        if (supabaseClient?.auth?.onAuthStateChange) {
            supabaseClient.auth.onAuthStateChange(() => {
                refreshAuthStateAndUI();
            });
        }

        // Warn if the user tries to save before logging in.
        document.addEventListener('click', (e) => {
            const btn = e?.target?.closest ? e.target.closest('#btn-save-diary') : null;
            if (!btn) return;

            // If the button isn't in the DOM yet, nothing to do.
            if (!supabaseClient) {
                e.preventDefault();
                e.stopPropagation();
                showToast('Supabase SDK failed to load.', { level: 'error' });
                return;
            }

            const ariaDisabled = btn.getAttribute('aria-disabled') === 'true';
            if (ariaDisabled || !cachedIsAuthed) {
                e.preventDefault();
                e.stopPropagation();
                showToast('Please log in first to save to diary.', { level: 'warn' });
                openAuthModal();
            }
        }, true);

        document.addEventListener('click', (e) => {
            const input = document.getElementById('movie-search-input');
            const res = document.getElementById('search-results');
            if(input && res && !input.contains(e.target) && !res.contains(e.target)) {
                res.classList.add('hidden');
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const isRecovery = (() => {
                try {
                    return /type=recovery/i.test(String(window.location.hash || ''));
                } catch (_) {
                    return false;
                }
            })();

            await refreshAuthStateAndUI();
            initListsPage();
            router.init();

            // If we arrived via Supabase password recovery link, send the user to Account.
            if (isRecovery) {
                try {
                    history.replaceState(null, '', window.location.pathname + window.location.search);
                } catch (_) {}
                showToast('Set a new password in Account  Security.', { level: 'info' });
                router.navigate('account');
            }
        });

        document.addEventListener('keydown', (e) => {
            const overlay = document.getElementById('auth-overlay');
            const isOpen = overlay?.classList?.contains('open');
            if (!isOpen) return;

            if (e.key === 'Escape') {
                closeAuthModal();
                return;
            }

            if (e.key === 'Enter') {
                const loginBtn = document.getElementById('auth-login-btn');
                if (loginBtn && loginBtn.style.display !== 'none') {
                    e.preventDefault();
                    loginBtn.click();
                }
            }
        });
    </script>
</body>
</html>
