<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinemaTracker | Your Movie Journey</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;      /* Zinc 950 */
            --surface: #18181b;      /* Zinc 900 */
            --border: #27272a;       /* Zinc 800 */
            --text-main: #e4e4e7;    /* Zinc 200 */
            --text-muted: #a1a1aa;   /* Zinc 400 */
            
            --brand: #14b8a6;        /* Teal 500 */
            --brand-hover: #0d9488;  /* Teal 600 */
            --brand-light: rgba(20, 184, 166, 0.1);

            /* Tier colors (match Data Dashboard tier colors) */
            --tier-s-rgb: 239, 68, 68;   /* Red (#ef4444) */
            --tier-a-rgb: 251, 146, 60;  /* Orange (#fb923c) */
            --tier-b-rgb: 250, 204, 21;  /* Yellow (#facc15) */
            --tier-c-rgb: 74, 222, 128;  /* Green (#4ade80) */
            --tier-d-rgb: 96, 165, 250;  /* Blue (#60a5fa) */
            --tier-f-rgb: 168, 85, 247;  /* Purple (#a855f7) */
            
            --font-family: 'Outfit', sans-serif;
            --container-width: 1280px;
            --header-height: 64px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }

        a { text-decoration: none; color: inherit; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; }
        input, select, textarea { font-family: inherit; }
        .container {
            max-width: var(--container-width);
            margin: 0 auto;
            padding: 0 1.5rem;
            width: 100%;
        }

        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .grid { display: grid; }
        .hidden { display: none !important; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(1, 1fr); } /* Mobile default */
        .grid-4 { grid-template-columns: repeat(2, 1fr); } /* Mobile default */

        @media (min-width: 768px) {
            .grid-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-4 { grid-template-columns: repeat(4, 1fr); }
            .md-block { display: block; }
            .md-hidden { display: none; }
            .md-row { flex-direction: row; }
            .col-span-2 { grid-column: span 2; }
        }
        .fade-in { animation: fadeIn 0.4s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .animate-marquee {
            display: flex;
            width: max-content;
            animation: marquee 40s linear infinite;
        }
        .animate-marquee:hover { animation-play-state: paused; }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .glass-panel {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 50;
            border-bottom: 1px solid var(--border);
        }
        .nav-inner {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-brand { font-size: 1.25rem; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 0.5rem; }
        .nav-brand span { color: var(--brand); }
        .nav-links { display: flex; gap: 0.75rem; }
        .nav-link {
            font-size: 0.95rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            color: rgba(255,255,255,0.9);
            padding: 0.55rem 0.95rem;
            border-radius: 999px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.14);
            transition: background 0.2s, border-color 0.2s, transform 0.2s, box-shadow 0.2s, color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .nav-link:hover {
            color: #fff;
            background: rgba(255,255,255,0.07);
            border-color: rgba(255,255,255,0.30);
            transform: translateY(-1px);
        }
        .nav-link.active {
            color: #fff;
            background: linear-gradient(135deg, rgba(20,184,166,0.28), rgba(168,85,247,0.22));
            border-color: rgba(20,184,166,0.45);
            box-shadow: 0 10px 26px rgba(0,0,0,0.35);
        }
        .mobile-menu-btn { color: var(--text-muted); display: none; }
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .mobile-menu-btn { display: block; }
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary {
            background-color: var(--brand);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(20, 184, 166, 0.3);
        }
        .btn-primary:hover { background-color: var(--brand-hover); }
        
        .btn-glass {
            background: rgba(255,255,255,0.05);
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-glass:hover { background: rgba(255,255,255,0.1); }

        .btn-outline {
            background: var(--surface);
            border: 1px solid var(--border);
            color: white;
        }
        .btn-outline:hover { border-color: var(--brand); }
        .input-group { position: relative; }
        .input-field, .select-field, .textarea-field {
            width: 100%;
            background-color: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: white;
            outline: none;
            transition: border-color 0.2s;
            color-scheme: dark; /* For calendar picker */
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 1px var(--brand);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding-left: 3rem; /* Space for icon */
            font-size: 1.125rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        /* Genre chips (tap/click selection, max 2) */
        .genre-chip-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .genre-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0.75rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: #fff;
            font-size: 0.875rem;
            font-weight: 600;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .genre-chip:hover { border-color: var(--brand); }
        .genre-chip.selected {
            border-color: var(--brand);
            background: var(--brand-light);
        }

        /* Tier selector buttons (single-choice, not locked) */
        .tier-btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.6rem;
        }
        @media (min-width: 768px) {
            .tier-btn-group { grid-template-columns: repeat(6, 1fr); }
        }
        .tier-btn {
            --tier-rgb: 255, 255, 255;
            width: 100%;
            padding: 0.75rem 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(var(--tier-rgb), 0.45);
            color: white;
            font-weight: 800;
            letter-spacing: 0.04em;
            transition: transform 0.15s ease, opacity 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            background: rgba(var(--tier-rgb), 0.22);
        }
        .tier-btn[data-tier="S-Tier"] { --tier-rgb: var(--tier-s-rgb); }
        .tier-btn[data-tier="A-Tier"] { --tier-rgb: var(--tier-a-rgb); }
        .tier-btn[data-tier="B-Tier"] { --tier-rgb: var(--tier-b-rgb); }
        .tier-btn[data-tier="C-Tier"] { --tier-rgb: var(--tier-c-rgb); }
        .tier-btn[data-tier="D-Tier"] { --tier-rgb: var(--tier-d-rgb); }
        .tier-btn[data-tier="F-Tier"] { --tier-rgb: var(--tier-f-rgb); }

        .tier-btn:active { transform: scale(0.98); }
        .tier-btn-group[data-has-selection="true"] .tier-btn {
            opacity: 0.16;
            filter: grayscale(0.75) brightness(0.95);
            box-shadow: none;
        }
        .tier-btn-group[data-has-selection="true"] .tier-btn.selected {
            opacity: 1;
            filter: none;
            transform: translateY(-1px);
            background: rgba(var(--tier-rgb), 0.32);
            border-color: rgba(var(--tier-rgb), 0.75);
            box-shadow:
                0 0 0 2px rgba(var(--tier-rgb), 0.55),
                0 10px 28px rgba(0,0,0,0.45),
                0 0 28px rgba(var(--tier-rgb), 0.22);
        }

        /* Watch-method modal selection highlight */
        .watch-method-option.selected {
            box-shadow: 0 0 0 2px rgba(255,255,255,0.35);
            border-color: rgba(255,255,255,0.45) !important;
        }
        .input-readonly {
            background-color: rgba(255,255,255,0.02);
            color: white;
            cursor: not-allowed;
        }

        /* Cards */
        .movie-card {
            position: relative;
            aspect-ratio: 2/3;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: var(--surface);
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .movie-card:hover {
            transform: scale(1.03);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .movie-card img { width: 100%; height: 100%; object-fit: cover; }
        .movie-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1rem;
        }
        .movie-card:hover .movie-overlay { opacity: 1; }

        /* Trending Card */
        .trending-card {
            flex: 0 0 160px;
            height: 240px;
            border-radius: 0.5rem;
            overflow: hidden;
            margin: 0 0.5rem;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--surface);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .trending-card:hover { transform: scale(1.05); }
        .trending-card img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Search Dropdown */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            margin-top: 0.5rem;
            background-color: #18181b;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 50;
            max-height: 360px;
            overflow-y: auto;
        }
        .search-item {
            padding: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .search-item:hover { background-color: var(--brand-light); }
        .search-item:last-child { border-bottom: none; }

        /* Range Sliders */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .slider-container.slider-vertical {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        .slider-container.slider-vertical .relative {
            width: 100% !important;
        }
        input[type=range] {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--brand);
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: #0d9488;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 100;
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        /* Auth Modal */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 140;
            padding: 1.5rem;
        }
        .auth-overlay.open { display: flex; }
        .auth-modal {
            width: min(480px, 100%);
            border-radius: 1rem;
            background: rgba(24, 24, 27, 0.92);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: 0 24px 60px rgba(0,0,0,0.55);
            padding: 1.25rem;
        }
        .auth-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .auth-modal-title {
            font-size: 1.05rem;
            font-weight: 800;
            color: #fff;
        }
        .auth-modal-close {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 0.7rem;
            padding: 0.45rem 0.65rem;
            color: white;
            font-weight: 800;
        }
        .auth-modal-close:hover { background: rgba(255,255,255,0.10); }
        .auth-modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 0.75rem;
        }

        /* Auth modal is optional; app remains accessible without login (DoNotChange parity) */

        .nav-actions { display: flex; align-items: center; gap: 0.75rem; }
        .nav-auth-btn {
            padding: 0.5rem 0.9rem;
            border-radius: 0.75rem;
            font-weight: 800;
            font-size: 0.875rem;
            background: rgba(255,255,255,0.05);
            color: white;
            border: 1px solid rgba(255,255,255,0.10);
        }
        .nav-auth-btn:hover { background: rgba(255,255,255,0.10); }

        /* Message Log (persistent toast history) */
        .log-fab {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            z-index: 110;
            background: rgba(24, 24, 27, 0.92);
            color: white;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 999px;
            padding: 0.6rem 0.9rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.35);
        }
        .log-fab:hover { border-color: rgba(255,255,255,0.22); }
        .log-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.6rem;
            height: 1.6rem;
            padding: 0 0.45rem;
            border-radius: 999px;
            background: rgba(20, 184, 166, 0.35);
            border: 1px solid rgba(20, 184, 166, 0.55);
            font-size: 0.8rem;
            line-height: 1;
        }
        .log-panel {
            position: fixed;
            left: 1.5rem;
            bottom: 4.5rem;
            width: min(720px, calc(100vw - 3rem));
            max-height: min(60vh, 520px);
            z-index: 120;
            background: rgba(9, 9, 11, 0.96);
            color: white;
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 0.9rem;
            box-shadow: 0 18px 45px rgba(0,0,0,0.5);
            overflow: hidden;
            display: none;
        }
        .log-panel.open { display: flex; flex-direction: column; }
        .log-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            gap: 0.75rem;
        }
        .log-panel-title { font-weight: 800; }
        .log-panel-actions { display: flex; gap: 0.5rem; }
        .log-btn {
            background: rgba(255,255,255,0.08);
            color: white;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 0.6rem;
            padding: 0.45rem 0.65rem;
            cursor: pointer;
            font-weight: 700;
        }
        .log-btn:hover { background: rgba(255,255,255,0.12); }
        .log-body {
            overflow: auto;
            padding: 0.75rem 0.9rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.85rem;
            line-height: 1.35;
            white-space: pre-wrap;
        }
        .log-item { padding: 0.4rem 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
        .log-item:last-child { border-bottom: none; }
        .log-meta { opacity: 0.75; }
        .log-level-error { color: #fb7185; }
        .log-level-warn { color: #fbbf24; }
        .log-level-info { color: #34d399; }

        /* Footer */
        footer {
            background-color: var(--surface);
            border-top: 1px solid var(--border);
            margin-top: auto;
            padding: 2rem 0;
        }

        /* Typography Helpers */
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-xl { font-size: 1.25rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .text-5xl { font-size: 3rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-mono { font-family: monospace; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .text-brand { color: var(--brand); }
        .text-white { color: white; }
        .text-gray { color: var(--text-muted); }
        .uppercase { text-transform: uppercase; letter-spacing: 0.05em; }
        .capitalize { text-transform: capitalize; }
        .mb-2 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        /* Increased label-to-input gap for submit page */
        .label-gap { margin-bottom: 0.5rem !important; }
        /* Force spacing when an input/select/textarea follows a submit label */
        .submit-label + .input-field,
        .submit-label + .select-field,
        .submit-label + .textarea-field { margin-top: 0.5rem !important; }
        /* Handle wrapped controls (e.g., sliders, quote input) */
        .submit-label + .slider-container { margin-top: 0.5rem !important; }
        .submit-label + .relative { margin-top: 0.5rem !important; }
        /* Handle grid blocks (e.g., External Ratings) and read-only inputs */
        .submit-label + .grid { margin-top: 0.5rem !important; }
        
        /* Mobile Menu */
        #mobile-menu { display: none; }
        #mobile-menu.open { display: block; border-top: 1px solid var(--border); padding: 1rem; }
        .mobile-link {
            display: block;
            padding: 0.8rem 0.9rem;
            color: rgba(255,255,255,0.92);
            font-weight: 800;
            letter-spacing: 0.03em;
            border-radius: 0.75rem;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.03);
        }
        .mobile-link:hover {
            background: rgba(255,255,255,0.07);
            color: #fff;
            border-color: rgba(255,255,255,0.25);
        }

        @media (max-width: 768px) {
            .text-5xl { font-size: 2.25rem; }
            .text-4xl { font-size: 1.75rem; }
            .navbar { padding: 0; }
        }

        /* Dashboard helpers */
        .dash-mini-kpi {
            padding: 0.9rem 0.95rem;
            border-radius: 0.75rem;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .dash-mini-kpi-value { line-height: 1; }
        .dash-mini-kpi-label {
            margin-top: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.07em;
        }

        .dash-tier-card {
            padding: 0.9rem 0.95rem;
            border-radius: 0.85rem;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .dash-tier-progress {
            height: 9px;
            background: rgba(255,255,255,0.06);
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .dash-tier-progressFill { height: 100%; }
        .dash-tier-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.07em;
        }
        .dash-tier-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .dash-movie-row {
            padding: 0.6rem 0.75rem;
            border-radius: 0.7rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Icon Size Helper */
        svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm svg { width: 16px; height: 16px; }
        .icon-lg svg { width: 32px; height: 32px; }

        /* Save gating UX */
        #btn-save-diary[aria-disabled="true"] { cursor: not-allowed; }

        /* Dashboard tabs + timeframe buttons */
        .dash-pill-btn {
            padding: 0.6rem 0.95rem !important;
            border-radius: 999px !important;
            font-size: 0.95rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            line-height: 1;
            border-width: 1px;
        }
        .dash-pill-btn.btn-outline {
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.16);
            color: rgba(255,255,255,0.92);
        }
        .dash-pill-btn.btn-outline:hover {
            border-color: rgba(255,255,255,0.32);
            background: rgba(255,255,255,0.07);
        }
        .dash-pill-btn.btn-glass {
            background: linear-gradient(135deg, rgba(20,184,166,0.24), rgba(168,85,247,0.18));
            border-color: rgba(20,184,166,0.42);
            color: #fff;
            box-shadow: 0 10px 26px rgba(0,0,0,0.35);
        }
        .dash-pill-btn.btn-glass:hover {
            background: linear-gradient(135deg, rgba(20,184,166,0.30), rgba(168,85,247,0.22));
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar glass-panel">
        <div class="container nav-inner">
            <div class="nav-brand" onclick="router.navigate('home')" style="cursor:pointer;">
                <span class="icon-wrapper" id="nav-logo-icon"></span>
                <span>Cinema<span>Tracker</span></span>
            </div>
            
            <div class="nav-links">
                <button onclick="router.navigate('home')" class="nav-link">Home</button>
                <button onclick="router.navigate('dashboard')" class="nav-link">Data Dash</button>
            </div>

            <div class="nav-actions">
                <button id="nav-login-btn" class="nav-auth-btn" type="button" onclick="openAuthModal()">Login</button>

                <div class="mobile-menu-btn">
                    <button onclick="toggleMobileMenu()" id="menu-icon-btn"></button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="glass-panel">
            <button onclick="router.navigate('home')" class="mobile-link">Home</button>
            <button onclick="router.navigate('dashboard')" class="mobile-link">Data Dash</button>
            <button onclick="openAuthModal(); document.getElementById('mobile-menu').classList.remove('open');" class="mobile-link">Login</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-root" style="padding-top: var(--header-height);">
        <!-- Content injected by JS -->
    </main>

    <button id="log-fab" class="log-fab" type="button" aria-label="Open message log">
        <span class="icon-sm" id="log-fab-icon"></span>
        Logs <span id="log-badge" class="log-badge">0</span>
    </button>

    <div id="log-panel" class="log-panel" aria-live="polite">
        <div class="log-panel-header">
            <div class="log-panel-title">Message Log</div>
            <div class="log-panel-actions">
                <button id="log-copy" class="log-btn" type="button">Copy</button>
                <button id="log-clear" class="log-btn" type="button">Clear</button>
                <button id="log-close" class="log-btn" type="button">Close</button>
            </div>
        </div>
        <div id="log-body" class="log-body"></div>
    </div>

    <div id="toast" class="toast">
        <span id="toast-icon"></span>
        <span id="toast-message" class="font-semibold">Action successful!</span>
    </div>

    <div id="auth-overlay" class="auth-overlay" onclick="if(event.target === this) closeAuthModal();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="auth-modal-title">Login</div>
                <button class="auth-modal-close" type="button" onclick="closeAuthModal()">Close</button>
            </div>

            <div class="grid md-row gap-6" style="margin-top: 0px;">
                <div style="flex:1;">
                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Email</label>
                    <input id="auth-email" type="email" class="input-field" placeholder="you@example.com" autocomplete="email">
                </div>
                <div style="flex:1;">
                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Password</label>
                    <input id="auth-password" type="password" class="input-field" placeholder="••••••••" autocomplete="current-password">
                </div>
            </div>

            <div class="flex items-center gap-3" style="margin-top: 0.75rem;">
                <div id="auth-modal-status" class="text-sm" style="flex:1; color: var(--text-muted);">Not logged in.</div>
            </div>

            <div class="auth-modal-actions">
                <button type="button" id="auth-login-btn" class="btn btn-glass" onclick="handleLoginClick(event)">Log in</button>
                <button type="button" id="auth-logout-btn" class="btn btn-outline" onclick="handleLogoutClick(event)" style="display:none;">Log out</button>
            </div>
        </div>
    </div>

    <div id="dashboard-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeDashboardAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="dashboard-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="dashboard-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeDashboardAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to view your data dashboard
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeDashboardAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="update-watch-overlay" class="auth-overlay" onclick="if(event.target === this) closeUpdateWatchModal(null);" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="update-watch-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="update-watch-title">Update Ratings</div>
                <button class="auth-modal-close" type="button" onclick="closeUpdateWatchModal(null)">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem;">
                You’re updating an existing rating. Do you also want to add <span class="text-white font-semibold">+1 watch</span>?
            </div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem;">
                <button type="button" id="btn-update-only" class="btn btn-outline" style="flex:1;" onclick="closeUpdateWatchModal('update_only')">Only Update Rating</button>
                <button type="button" id="btn-update-and-watch" class="btn btn-primary" style="flex:1;" onclick="closeUpdateWatchModal('update_and_watch')">Update and +1 to Watch Logs</button>
            </div>
        </div>
    </div>

    <div id="watch-method-overlay" class="auth-overlay" onclick="if(event.target === this) closeWatchMethodModal(null);" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="watch-method-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="watch-method-title">Watch Method</div>
                <button class="auth-modal-close" type="button" onclick="closeWatchMethodModal(null)">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem;">
                How did you watch it?
            </div>

            <div style="margin-top: 0.85rem;">
                <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Date Watched</label>
                <input id="watch-method-date" type="date" class="input-field" required>
                <div class="text-xs text-gray" style="margin-top: 0.35rem;">This date will be saved to your Watch Logs.</div>
            </div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem; flex-wrap: wrap;">
                <button
                    type="button"
                    class="btn watch-method-option"
                    style="flex:1; background-color: rgba(168, 85, 247, 0.35); border: 1px solid rgba(168, 85, 247, 0.5); color: white;"
                    data-watch-method-option="true"
                    onclick="selectWatchMethodModal('At Home')"
                >At Home</button>
                <button
                    type="button"
                    class="btn watch-method-option"
                    style="flex:1; background-color: rgba(20, 184, 166, 0.35); border: 1px solid rgba(20, 184, 166, 0.5); color: white;"
                    data-watch-method-option="true"
                    onclick="selectWatchMethodModal('In Theater')"
                >In Theater</button>
                <button type="button" id="watch-method-save" class="btn btn-primary" style="width: 100%;" onclick="submitWatchMethodModal()" disabled aria-disabled="true" title="Select a watch method first.">
                    <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Save
                </button>
            </div>
        </div>
    </div>

    <div id="prior-watches-overlay" class="auth-overlay" onclick="if(event.target === this) closePriorWatchesModal(null);" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="prior-watches-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="prior-watches-title">Add Previous Watches</div>
                <button class="auth-modal-close" type="button" onclick="closePriorWatchesModal(null)">Close</button>
            </div>

            <div class="text-sm" id="prior-watches-message" style="color: var(--text-muted); margin-top: 0.5rem;"></div>

            <div id="prior-watches-fields" style="margin-top: 0.85rem; display:flex; flex-direction: column; gap: 0.75rem;"></div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem; flex-wrap: wrap;">
                <button type="button" class="btn btn-outline" style="flex:1;" onclick="closePriorWatchesModal({ skipped: true })">Skip</button>
                <button type="button" class="btn btn-primary" style="flex:1;" onclick="submitPriorWatchesModal()">Save Previous Watches</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="auth-overlay" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="loading-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="loading-title">Loading</div>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem; display:flex; align-items:center; gap: 0.5rem;">
                <span class="icon-sm"><svg viewBox="0 0 24 24" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></span>
                <span>Hang tight — fetching your existing entry…</span>
            </div>
        </div>
    </div>
    <footer>
        <div class="container flex flex-col md-row justify-between items-center">
            <div class="mb-4">
                <span class="text-gray text-sm">© 2024 CinemaTracker. Designed for film lovers.</span>
            </div>
            <div class="flex gap-4" id="footer-icons">
            </div>
        </div>
    </footer>

    <script>
        const SUPABASE_URL = 'https://dbxhaseoxpnmzdxbzdpj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_UcpiMVqtkCgky9HN8nu85Q_iFXsVY_r';
        const supabaseClient = window.supabase?.createClient
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
            : null;

        // Column name for the date-only watch date field in both "Movie Ratings" and "Watch Logs".
        // If you rename the column to a different identifier (e.g. "Watch_Date"), update this value.
        const COL_WATCH_DATE = 'watch_date';
        const icons = {
            film: `<svg viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg>`,
            menu: `<svg viewBox="0 0 24 24"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>`,
            checkCircle: `<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            twitter: `<svg viewBox="0 0 24 24"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 14-4.5-4.5 1.6-11.7 8-12 1.1-2 3.5-3.5 6-3.5 0 0 .7 3.4 2.7 4.5"/></svg>`,
            github: `<svg viewBox="0 0 24 24"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>`,
            instagram: `<svg viewBox="0 0 24 24"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/></svg>`,
            search: `<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            plusCircle: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`,
            refreshCw: `<svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>`,
            arrowRight: `<svg viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            arrowRightCircle: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="m12 16 4-4-4-4"/></svg>`,
            clock: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
            barChart2: `<svg viewBox="0 0 24 24"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>`,
            star: `<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
            arrowLeft: `<svg viewBox="0 0 24 24"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>`,
            database: `<svg viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>`,
            info: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`,
            edit3: `<svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>`,
            quote: `<svg viewBox="0 0 24 24"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></svg>`,
            save: `<svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            calendar: `<svg viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            trendingUp: `<svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>`,
            trendingDown: `<svg viewBox="0 0 24 24"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>`,
            percent: `<svg viewBox="0 0 24 24"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="7" cy="7" r="2"/><circle cx="17" cy="17" r="2"/></svg>`,
            activity: `<svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
            pieChart: `<svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>`,
            video: `<svg viewBox="0 0 24 24"><rect x="3" y="7" width="14" height="10" rx="2" ry="2"/><path d="m17 10 4-2v8l-4-2z"/></svg>`,
            tv: `<svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="12" rx="2" ry="2"/><path d="M7 21h10"/><path d="M12 7 8 3"/><path d="M12 7l4-4"/></svg>`,
            user: `<svg viewBox="0 0 24 24"><path d="M20 21a8 8 0 0 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>`,
            loader: `<svg viewBox="0 0 24 24" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`
        };
        document.getElementById('nav-logo-icon').innerHTML = icons.film;
        document.getElementById('menu-icon-btn').innerHTML = icons.menu;
        document.getElementById('toast-icon').innerHTML = icons.checkCircle;
        document.getElementById('footer-icons').innerHTML = `
            <a href="#">${icons.twitter}</a>
            <a href="#">${icons.github}</a>
            <a href="#">${icons.instagram}</a>
        `;
        const router = {
            currentPage: 'home',
            selectedMovie: null,
            pendingTitle: '',
            formMode: 'new',
            
            init() {
                this.navigate('home');
            },

            navigate(page, mode = 'new') {
                // If the user is not logged in, block the Data Dash and prompt them to log in.
                if (page === 'dashboard' && !cachedIsAuthed) {
                    openDashboardAuthWarning();
                    return;
                }

                // Disallow opening the submit form without selecting a movie from the dropdown.
                if (page === 'submit' && String(mode || 'new') === 'new') {
                    const hasPicked = Boolean(this.selectedMovie);
                    const hasDetails = Boolean(this.selectedMovie?.detailsReadonly);
                    if (!hasPicked || !hasDetails) {
                        showToast('Please search and select a movie from the dropdown first.', { level: 'warn' });
                        page = 'home';
                        mode = 'new';
                    }
                }

                this.currentPage = page;
                this.formMode = mode;
                const root = document.getElementById('app-root');
                
                // Active Nav
                document.querySelectorAll('.nav-link').forEach(el => {
                    if (el.innerText.toLowerCase().includes(page === 'home' ? 'home' : page === 'submit' ? 'log' : 'data')) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                });

                document.getElementById('mobile-menu').classList.remove('open');

                if (page === 'home') {
                    root.innerHTML = this.renderHome();
                    this.selectedMovie = null;
                    this.pendingTitle = '';
                    loadTrendingNow();
                } else if (page === 'submit') {
                    root.innerHTML = this.renderSubmit();
                    initializeWatchMethodToggle();
                    refreshAuthStateAndUI();
                } else if (page === 'dashboard') {
                    root.innerHTML = this.renderDashboard();
                    refreshAuthStateAndUI();
                    initDashboardTabs();
                    initDashboardTimeframe();
                    initDashboardFavoritesMetric();
                    setDashboardTimeframe('all_time');
                }
                
                window.scrollTo(0, 0);
            },

            async selectMovie(movie) {
                this.selectedMovie = movie;
                this.pendingTitle = movie?.title || '';
                const input = document.getElementById('movie-search-input');
                const results = document.getElementById('search-results');
                const updateBtn = document.getElementById('update-existing-btn');
                const updateOpts = document.getElementById('update-options');
                const logNewBtn = document.getElementById('btn-log-new-entry');

                if (input) input.value = movie.title;
                if (results) results.classList.add('hidden');

                // Prevent UI flash: hide both buttons immediately.
                if (logNewBtn) logNewBtn.style.display = 'none';
                if (updateBtn) updateBtn.style.display = 'none';
                if (updateOpts) {
                    updateOpts.classList.add('hidden');
                    updateOpts.classList.remove('grid');
                }

                // Show the action area and hide the placeholder text.
                setHomeActionsVisible(true);

                // Default behavior when we can't confirm diary status: allow Log as New Entry.
                const showLogNewOnly = () => {
                    if (logNewBtn) logNewBtn.style.display = '';
                    if (updateBtn) updateBtn.style.display = 'none';
                    if (updateOpts) {
                        updateOpts.classList.add('hidden');
                        updateOpts.classList.remove('grid');
                    }
                };

                const showUpdateOnly = () => {
                    if (logNewBtn) logNewBtn.style.display = 'none';
                    if (updateBtn) {
                        updateBtn.style.display = '';
                        updateBtn.disabled = false;
                        updateBtn.style.opacity = '1';
                        updateBtn.style.pointerEvents = 'auto';
                    }
                };

                try {
                    if (!supabaseClient) {
                        showLogNewOnly();
                        return;
                    }

                    const { data } = await supabaseClient.auth.getSession();
                    const authedUser = data?.session?.user;
                    if (!authedUser?.id) {
                        showLogNewOnly();
                        return;
                    }

                    const movie_id = await resolveDbMovieIdFromSelectedMovie(movie);
                    if (!movie_id) {
                        // If it isn't in Movies yet, it can't be in Movie Ratings.
                        showLogNewOnly();
                        return;
                    }

                    const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id });
                    if (alreadyRated) showUpdateOnly();
                    else showLogNewOnly();
                } catch (_) {
                    // Safe fallback: allow Log as New Entry.
                    showLogNewOnly();
                }
            },

            async startNewEntry() {
                const btn = document.getElementById('btn-log-new-entry');
                const originalHTML = btn ? btn.innerHTML : null;

                try {
                    // Users must pick a movie from the dropdown first.
                    if (!this.selectedMovie) {
                        showToast('Please select a movie from the search dropdown first.', { level: 'warn' });
                        return;
                    }

                    // If the user is logged in and already has a rating for this movie, prevent duplicates.
                    try {
                        if (supabaseClient) {
                            const { data } = await supabaseClient.auth.getSession();
                            const authedUser = data?.session?.user;
                            if (authedUser?.id) {
                                const movie_id = await resolveDbMovieIdFromSelectedMovie(this.selectedMovie);
                                if (movie_id) {
                                    const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id });
                                    if (alreadyRated) {
                                        showToast('This movie is already in your diary. Use “Update Existing” instead.', { level: 'warn' });
                                        return;
                                    }
                                }
                            }
                        }
                    } catch (_) {}

                    // If we already have full details, just navigate.
                    if (this.selectedMovie?.detailsReadonly) {
                        this.navigate('submit', 'new');
                        return;
                    }

                    const tmdb_id = Number(this.selectedMovie?.tmdb_id ?? this.selectedMovie?.id);
                    if (!Number.isFinite(tmdb_id) || tmdb_id <= 0) {
                        showToast('Please select a movie from the search dropdown first.', { level: 'warn' });
                        return;
                    }

                    if (btn) {
                        btn.innerHTML = `${icons.loader} Loading…`;
                        btn.disabled = true;
                        btn.style.opacity = 0.85;
                    }

                    const details = await callSwiftApiGetMovieDetails({ tmdb_id });

                    // Shape the prefill object to match the submit page expectations.
                    const genres = Array.isArray(details?.genres)
                        ? details.genres.map(s => String(s).trim()).filter(Boolean)
                        : [];

                    const joinedGenres = genres.length
                        ? genres.join(', ')
                        : String(details?.genre || this.selectedMovie?.genre || '').trim();

                    this.selectedMovie = {
                        ...this.selectedMovie,
                        tmdb_id: Number(details?.tmdb_id ?? tmdb_id),
                        title: String(details?.title || this.selectedMovie?.title || '').trim(),
                        year: details?.year ?? this.selectedMovie?.year ?? null,
                        mpa: String(details?.mpa || '').trim(),
                        runtime: details?.runtime ?? null,
                        isSeries: Boolean(details?.isSeries),
                        director: String(details?.director || '').trim(),
                        imdb: (details?.imdb_rating_pct === null || details?.imdb_rating_pct === undefined)
                            ? ''
                            : String(details.imdb_rating_pct),
                        genres,
                        genre: joinedGenres,
                        poster_path: details?.poster_path ?? this.selectedMovie?.poster_path ?? null,
                        detailsReadonly: true,
                    };

                    this.navigate('submit', 'new');
                } catch (err) {
                    showToast(`Failed to load movie details: ${String(err?.message || err)}`, { level: 'warn' });
                    // Do not allow manual entry.
                    return;
                } finally {
                    if (btn && originalHTML !== null) {
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                        btn.style.opacity = 1;
                    }
                }
            },

            async quickIncrement() {
                const m = this.selectedMovie;
                if (!m) return;

                try {
                    if (!supabaseClient) {
                        throw new Error('Supabase SDK failed to load.');
                    }
                    const { user: authedUser } = await requireAuthOrThrow();

                    // Resolve the DB UUID from the selected movie (prefer UUID, else map tmdb_id -> Movies.id).
                    const movie_id = await resolveDbMovieIdFromSelectedMovie(m);
                    if (!movie_id) {
                        showToast('Quick Watch is only available for movies already in your diary. Use “Log as New Entry” first.');
                        return;
                    }

                    // Only allow Quick Watch for movies already logged (rated) by this user.
                    const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id });
                    if (!alreadyRated) {
                        showToast('Quick Watch is only for movies you\'ve already logged. Use “Log as New Entry” first.');
                        return;
                    }

                    const watchChoice = await promptWatchMethodChoice();
                    if (!watchChoice) {
                        showToast('Quick Watch canceled.', { level: 'warn' });
                        return;
                    }

                    await insertWatchLog({
                        user_id: authedUser.id,
                        movie_id,
                        watch_method: watchChoice.watch_method,
                        watch_date: watchChoice.watch_date,
                    });
                    showToast(`Added another watch for ${m.title}!`);

                    // Reset
                    const input = document.getElementById('movie-search-input');
                    if (input) input.value = '';
                    const results = document.getElementById('search-results');
                    if (results) {
                        results.classList.add('hidden');
                        results.innerHTML = '';
                    }
                    this.selectedMovie = null;
                    setHomeActionsVisible(false);
                    setUpdateOptionsHidden();
                    const updateBtn = document.getElementById('update-existing-btn');
                    if (updateBtn) updateBtn.style.display = '';
                } catch (err) {
                    showToast(`Quick Watch failed: ${String(err.message || err)}`);
                }
            },

            async startUpdateRatings() {
                const m = this.selectedMovie;
                if (!m) return;

                try {
                    showLoadingOverlay('Hang tight — fetching your existing entry…');
                    if (!supabaseClient) throw new Error('Supabase SDK failed to load.');
                    const { user: authedUser } = await requireAuthOrThrow();

                    // Resolve DB movie UUID using tmdb_id -> Movies.id mapping (read-only).
                    const movie_id = await resolveDbMovieIdFromSelectedMovie(m);
                    if (!movie_id) {
                        showToast('No matching movie found in your database for this selection. Use “Log as New Entry” first.');
                        return;
                    }

                    const existing = await getExistingMovieRatingRow({ user_id: authedUser.id, movie_id });
                    if (!existing) {
                        showToast('No existing rating found for this movie. Use “Log as New Entry” instead.');
                        return;
                    }

                    // Pull movie details from the DB so the update form is fully populated.
                    let movieRow = null;
                    try {
                        movieRow = await getDbMovieRowById(movie_id);
                    } catch (_) {
                        movieRow = null;
                    }

                    const latestWatch = await getLatestWatchLog({ user_id: authedUser.id, movie_id });
                    const earliestWatch = await getEarliestWatchLog({ user_id: authedUser.id, movie_id });
                    let watchCount = null;
                    try {
                        watchCount = await getWatchLogCount({ user_id: authedUser.id, movie_id });
                    } catch (_) {
                        watchCount = null;
                    }
                    const watchedTimes = (() => {
                        const n = Number(watchCount);
                        if (Number.isFinite(n) && n > 0) return n;
                        // Back-compat: older data may be missing Watch Logs rows.
                        return 1;
                    })();
                    const defaultDate = new Date().toISOString().split('T')[0];
                    const date = existing?.[COL_WATCH_DATE]
                        ? String(existing[COL_WATCH_DATE])
                        : (latestWatch?.[COL_WATCH_DATE] ? String(latestWatch[COL_WATCH_DATE]) : defaultDate);

                    const review = {
                        date,
                        tier: existing?.tier ?? '',
                        scores: {
                            overall: Number(existing?.overall_rating ?? 50),
                            sound: Number(existing?.sound_rating ?? 50),
                            pace: Number(existing?.pacing_rating ?? 50),
                            imagery: Number(existing?.imagery_rating ?? 50),
                            acting: Number(existing?.acting_rating ?? 50),
                            plot: Number(existing?.plot_rating ?? 50),
                            dialogue: Number(existing?.dialogue_rating ?? 50),
                        },
                        quote: String(existing?.fav_quote ?? ''),
                        notes: String(existing?.notes ?? ''),
                        watched: watchedTimes,
                        // When updating, show the original (oldest) watch method as the locked form value.
                        watch_method: String(earliestWatch?.watch_method || latestWatch?.watch_method || 'At Home')
                    };

                    const coalesceYear = (row) => {
                        const y = row?.release_year ?? row?.year;
                        const n = Number(y);
                        return Number.isFinite(n) && n > 0 ? n : (m?.year ?? '');
                    };

                    const coalesceRuntime = (row) => {
                        const v = row?.runtime_minutes ?? row?.runtime;
                        const n = Number(v);
                        return Number.isFinite(n) ? n : (m?.runtime ?? '');
                    };

                    const coalesceGenre = (row) => {
                        if (!row) return m?.genre || '';
                        if (typeof row?.genre === 'string') return row.genre;
                        if (Array.isArray(row?.genres)) return row.genres.map(s => String(s).trim()).filter(Boolean).join(', ');
                        if (typeof row?.genres === 'string') return row.genres;
                        return m?.genre || '';
                    };

                    // Director is often missing from the Movies table in this setup.
                    // Prefer DB value, but fall back to TMDb details so the update form is fully populated.
                    let resolvedDirector = String(
                        movieRow?.director ??
                        movieRow?.director_name ??
                        movieRow?.directorName ??
                        m?.director ??
                        ''
                    ).trim();
                    if (!resolvedDirector) {
                        const tmdb_id = Number(movieRow?.tmdb_id ?? m?.tmdb_id ?? getTmdbIdFromSelectedMovie(m) ?? null);
                        if (Number.isFinite(tmdb_id) && tmdb_id > 0) {
                            try {
                                const details = await callSwiftApiGetMovieDetails({ tmdb_id });
                                resolvedDirector = String(details?.director || '').trim();

                                const imdbPct = details?.imdb_rating_pct;
                                if (imdbPct !== null && imdbPct !== undefined) {
                                    m.imdb = String(imdbPct);
                                }
                            } catch (_) {}
                        }
                    }

                    this.selectedMovie = {
                        ...m,
                        id: movie_id,
                        tmdb_id: Number(movieRow?.tmdb_id ?? m?.tmdb_id ?? getTmdbIdFromSelectedMovie(m) ?? null) || undefined,
                        title: String(movieRow?.title ?? m?.title ?? '').trim(),
                        year: coalesceYear(movieRow),
                        director: resolvedDirector,
                        mpa: String(movieRow?.mpa_rating ?? movieRow?.mpa ?? m?.mpa ?? '').trim(),
                        runtime: coalesceRuntime(movieRow),
                        isSeries: (movieRow?.is_series ?? movieRow?.isSeries ?? m?.isSeries) === true,
                        genre: coalesceGenre(movieRow),
                        poster_path: movieRow?.poster_path ?? m?.poster_path ?? m?.posterPath ?? m?.poster_url ?? m?.posterUrl ?? '',
                        detailsReadonly: true,
                        mockUserReview: review
                    };

                    // Close the home dropdown UI if it's open.
                    try {
                        document.getElementById('update-options')?.classList?.add('hidden');
                        document.getElementById('update-options')?.classList?.remove('grid');
                    } catch (_) {}

                    this.navigate('submit', 'update');
                } catch (err) {
                    showToast(`Update Ratings failed: ${String(err?.message || err)}`);
                } finally {
                    hideLoadingOverlay();
                }
            },

            toggleUpdateOptions() {
                const opts = document.getElementById('update-options');
                const updateBtn = document.getElementById('update-existing-btn');
                if (!opts) return;

                if (opts.classList.contains('hidden')) {
                    opts.classList.remove('hidden');
                    opts.classList.add('grid');
                    // Once expanded, hide the "Update Existing" button so only the two options remain.
                    if (updateBtn) updateBtn.style.display = 'none';
                    return;
                }

                // If we ever collapse programmatically, restore the button.
                opts.classList.add('hidden');
                opts.classList.remove('grid');
                if (updateBtn) updateBtn.style.display = '';
            },

            renderHome() {
                return `
                    <div class="fade-in">
                        <!-- Hero (Full Width) -->
                        <div class="relative w-full" style="height: 62vh; margin-bottom: 1.5rem;">
                            <!-- Backgrounds -->
                            <div class="absolute" style="inset:0; background-image: url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=2525&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.4;"></div>
                            <div class="absolute" style="inset:0; background: linear-gradient(to top, var(--bg-dark) 10%, transparent 90%); z-index: -1;"></div>
                            
                            <!-- Content (Containerized) -->
                            <div class="container" style="height: 100%; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 2.25rem;">
                                <span class="text-xs font-semibold text-brand uppercase" style="background: var(--brand-light); padding: 0.25rem 0.75rem; border-radius: 99px; border: 1px solid rgba(20,184,166,0.2); width: fit-content; margin-bottom: 1rem;">Start Logging</span>
                                <h1 class="text-5xl font-bold text-white mb-6" style="line-height: 1.1;">Cinematic <br/> <span style="background: linear-gradient(to right, var(--brand), #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Masterpieces</span></h1>
                                
                                <div style="max-width: 600px; position: relative;">
                                    <p class="text-xl text-gray mb-4">Search for a movie to add it to your diary.</p>
                                    
                                    <!-- Search -->
                                    <div class="input-group mb-4">
                                        <div class="input-icon">${icons.search}</div>
                                        <input type="text" id="movie-search-input" oninput="handleSearch(this.value)" autocomplete="off" placeholder="Type a movie title..." class="input-field glass-input">
                                        <div id="search-results" class="search-dropdown hidden"></div>
                                    </div>

                                    <!-- Action Slot (fixed space so the search UI doesn't jump) -->
                                    <div id="home-action-slot" style="margin-top: 2rem; min-height: 120px;">
                                        <div id="home-action-card" class="glass-panel" style="padding: 1rem; border-radius: 0.75rem;">
                                            <div id="home-action-placeholder" class="text-sm text-gray" style="text-align:center; max-width: 520px; margin: 0 auto;">
                                                Select a movie from the dropdown to log it or update an existing entry.
                                            </div>

                                            <!-- Dynamic Actions (replaces placeholder in the same spot) -->
                                            <div id="movie-actions" class="hidden flex-col gap-4 fade-in">
                                                <div class="flex gap-3">
                                                    <button id="btn-log-new-entry" onclick="router.startNewEntry()" class="btn btn-primary" style="flex:1;">
                                                        ${icons.plusCircle} Log as New Entry
                                                    </button>
                                                    <button id="update-existing-btn" onclick="router.toggleUpdateOptions()" class="btn btn-outline" style="flex:1; border-color: rgba(168, 85, 247, 0.55); background: rgba(168, 85, 247, 0.10);">
                                                        <span style="color:#a855f7; width:20px;">${icons.refreshCw}</span> Update Existing
                                                    </button>
                                                </div>

                                                <div id="update-options" class="hidden grid-2 gap-3" style="padding: 1rem; border-radius: 0.75rem; border-style: dashed; border: 1px solid rgba(255,255,255,0.10);">
                                                    <button onclick="router.startUpdateRatings()" class="text-left" style="padding:0.75rem; border-radius:0.5rem; transition: background 0.2s; border: 1px solid rgba(168, 85, 247, 0.45); background: rgba(168, 85, 247, 0.10);">
                                                        <span class="text-brand font-semibold mb-2" style="display:block;">Update Ratings &rarr;</span>
                                                        <span class="text-xs text-gray">Edit your review, scores, and tier.</span>
                                                    </button>
                                                    <button onclick="router.quickIncrement()" class="text-left" style="padding:0.75rem; border-radius:0.5rem; transition: background 0.2s; border: 1px solid rgba(20, 184, 166, 0.45); background: rgba(20, 184, 166, 0.10);">
                                                        <span class="text-brand font-semibold mb-2" style="display:block;">Quick Watch (+1) &rarr;</span>
                                                        <span class="text-xs text-gray">Simply add a view to your count.</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Marquee (Full Width) -->
                        <div style="background: var(--surface); padding: 3rem 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
                            <div class="container mb-6">
                                <h2 class="text-xl font-semibold text-white">Trending Now</h2>
                            </div>
                            <div class="w-full" style="overflow: hidden; position: relative;">
                                <div class="animate-marquee">
                                    <div class="flex" id="trending-track-1"></div>
                                    <div class="flex" id="trending-track-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderSubmit() {
                const prefill = this.selectedMovie || {};
                const isUpdate = this.formMode === 'update';
                const uuidLike = isUuidLike;
                const hasDbMovie = uuidLike(prefill?.id);
                const detailsReadonly = hasDbMovie || Boolean(prefill?.detailsReadonly);
                const defaultDate = new Date().toISOString().split('T')[0];
                const allowEditMissingDetails = detailsReadonly && !hasDbMovie;

                const u = (isUpdate && prefill.mockUserReview) ? prefill.mockUserReview : {
                    date: defaultDate, tier: "", scores: { overall: 50, sound: 50, pace: 50, imagery: 50, acting: 50, plot: 50, dialogue: 50 },
                    quote: "", notes: "", watched: 1,
                    watch_method: 'At Home'
                };

                const scoreDefaults = { overall: 50, sound: 50, pace: 50, imagery: 50, acting: 50, plot: 50, dialogue: 50 };
                const scores = { ...scoreDefaults, ...(u?.scores || {}) };
                const scoreOrder = ['overall', 'sound', 'pace', 'imagery', 'acting', 'plot', 'dialogue'];

                const tierLetter = String(u.tier || '').trim().charAt(0).toUpperCase();
                
                const m = {
                    title: prefill.title || '', genre: prefill.genre || '', year: prefill.year || '', mpa: prefill.mpa || '',
                    runtime: (prefill.runtime === null || prefill.runtime === undefined) ? '' : String(prefill.runtime),
                    // For DB movies, we can display Yes/No but still submit TRUE/FALSE.
                    isSeriesDisplay: (prefill.isSeries === true) ? 'Yes' : ((prefill.isSeries === false) ? 'No' : ''),
                    isSeriesValue: (prefill.isSeries === true) ? 'TRUE' : ((prefill.isSeries === false) ? 'FALSE' : ''),
                    director: prefill.director || '', imdb: prefill.imdb || '',
                    poster_path: prefill.poster_path || prefill.posterPath || prefill.poster_url || prefill.posterUrl || ''
                };

                const posterUrl = (() => {
                    const raw = String(m.poster_path || '').trim();
                    if (!raw) return '';
                    if (raw.startsWith('http://') || raw.startsWith('https://')) return raw;
                    // TMDb poster_path comes like "/abc.jpg"
                    return `https://image.tmdb.org/t/p/w342${raw}`;
                })();

                const hasText = (v) => {
                    const s = String(v ?? '').trim();
                    if (!s) return false;
                    if (s === '0') return false;
                    return true;
                };
                const hasPositiveInt = (v) => {
                    const n = Number(String(v ?? '').trim());
                    return Number.isFinite(n) && n > 0;
                };

                // DB movies remain fully read-only.
                // TMDb prefill: lock only fields that have meaningful values; allow editing blanks and 0/"0".
                const titleLocked = detailsReadonly && (hasDbMovie || hasText(m.title));
                const yearLocked = detailsReadonly && (hasDbMovie || hasPositiveInt(m.year));
                const mpaLocked = detailsReadonly && (hasDbMovie || hasText(m.mpa));
                const runtimeLocked = detailsReadonly && (hasDbMovie || hasPositiveInt(m.runtime));
                const seriesLocked = detailsReadonly && (hasDbMovie || hasText(m.isSeriesValue));
                const directorLocked = detailsReadonly && (hasDbMovie || hasText(m.director));

                // When updating an existing rating, Times Watched should reflect Watch Logs history,
                // and it should not be editable on the form.
                const timesWatchedLocked = isUpdate;

                // When updating an existing rating, Watch Method should not be editable on the form.
                // New watches are recorded via Watch Logs with a separate watch-method prompt.
                const watchMethodLocked = isUpdate;

                const genreLower = String(m.genre || '').trim().toLowerCase();
                const genrePlaceholder = allowEditMissingDetails && (genreLower === 'movie' || genreLower === '0');
                const genreLocked = detailsReadonly && (hasDbMovie || (hasText(m.genre) && !genrePlaceholder));

                const clampPct = (n) => {
                    const v = Number(n);
                    if (!Number.isFinite(v)) return 0;
                    return Math.max(0, Math.min(100, v));
                };

                const parseExternalPercent = (raw, { imdb = false } = {}) => {
                    const s = String(raw ?? '').trim();
                    if (!s) return 0;
                    const num = parseFloat(s.replace('%', ''));
                    if (!Number.isFinite(num)) return 0;
                    let out = num;
                    // Accept a few common forms:
                    // - 83%  -> 83
                    // - 0.83 -> 83
                    // - IMDb 8.7 (/10) -> 87
                    if (num <= 1) out = num * 100;
                    else if (imdb && num <= 10) out = num * 10;
                    return clampPct(Math.round(out));
                };

                const imdbPct = parseExternalPercent(m.imdb, { imdb: true });
                const imdbLocked = detailsReadonly && (hasDbMovie || imdbPct > 0);

                const selectedGenres = String(m.genre || '')
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean);

                const genreOptions = [
                    'Action','Adventure','Animation','Comedy','Crime','Documentary','Drama','Family','Fantasy','History',
                    'Horror','Music','Mystery','Romance','Sci-Fi','TV Movie','Thriller','War','Western'
                ];

                return `
                    <div class="fade-in">
                        <!-- Background -->
                        <div style="position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1513106580091-1d82408b8cd8?q=80&w=2076&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.15; pointer-events: none;"></div>
                        <div style="position: fixed; inset: 0; background: linear-gradient(to bottom, var(--bg-dark), transparent 20%, var(--bg-dark) 90%); z-index: -1; pointer-events: none;"></div>
                        
                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                        <div class="flex items-center gap-4 mb-8">
                            <button onclick="router.navigate('home')" style="color: var(--text-muted); padding: 0.5rem; border-radius: 50%;">
                                ${icons.arrowLeft}
                            </button>
                            <div>
                                <h1 class="text-3xl font-bold text-white">${isUpdate ? 'Update Entry' : 'Log New Entry'}</h1>
                                ${isUpdate ? '<span class="text-brand text-sm">Editing existing record</span>' : ''}
                            </div>
                        </div>

                        <form onsubmit="handleFormSubmit(event)" class="grid grid-3 gap-6">
                            <input type="hidden" name="entryType" value="${isUpdate ? 'update' : 'new'}">
                            <input type="hidden" id="fld-movie-id" value="${hasDbMovie ? String(prefill.id) : ''}">
                            <input type="hidden" id="fld-tmdb-id" value="${Number.isFinite(Number(prefill?.tmdb_id)) ? String(Number(prefill.tmdb_id)) : ''}">
                            <!-- Read Only Section -->
                            <div class="glass-panel" style="padding: 1.5rem; border-radius: 1rem; background: var(--brand-light); border: 1px solid rgba(20,184,166,0.2);">
                                <div class="flex items-center gap-3 mb-4">
                                    <span class="text-brand">${icons.database}</span>
                                    <h2 class="text-xl font-semibold text-white">Movie Details</h2>
                                </div>
                                <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1.5rem;" class="text-sm flex items-center gap-2">
                                    <span style="width:16px;">${icons.info}</span>
                                    <span style="color: #bfdbfe;">${hasDbMovie ? 'Auto-filled from DB' : (allowEditMissingDetails ? 'Auto-filled from TMDb (edit any missing fields)' : 'Auto-filled from TMDb')}</span>
                                </div>

                                ${posterUrl ? `
                                    <div style="display:flex; justify-content:center; margin-bottom: 1.25rem;">
                                        <img
                                            src="${posterUrl}"
                                            alt="${escapeHtml(m.title || 'Movie poster')}"
                                            style="width: 180px; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 0.9rem; border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 16px 40px rgba(0,0,0,0.35);"
                                            loading="lazy"
                                            onerror="this.onerror=null; this.parentElement.remove();"
                                        >
                                    </div>
                                ` : ''}

                                <div class="flex flex-col gap-4">
                                    <div><label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Title</label><input id="fld-title" name="Title" class="input-field ${titleLocked ? 'input-readonly' : ''}" value="${m.title}" ${titleLocked ? 'readonly' : ''} ${(titleLocked && hasText(m.title)) ? '' : 'required'} placeholder="Type a movie title"></div>
                                    <div class="grid grid-2 gap-4">
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Year</label>
                                            <input
                                                id="fld-year"
                                                name="Year"
                                                type="number"
                                                inputmode="numeric"
                                                step="1"
                                                class="input-field ${yearLocked ? 'input-readonly' : ''}"
                                                value="${m.year}"
                                                ${yearLocked ? 'readonly' : ''}
                                                placeholder="e.g. 2024"
                                            >
                                        </div>
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">MPA</label>
                                            ${mpaLocked ? `
                                                <input id="fld-mpa" name="MPA" class="input-field input-readonly" value="${m.mpa}" readonly>
                                            ` : `
                                                <select id="fld-mpa" name="MPA" class="select-field" required>
                                                    <option value="" disabled ${!String(m.mpa || '').trim() ? 'selected' : ''}>Select...</option>
                                                    <option value="G" ${String(m.mpa).trim() === 'G' ? 'selected' : ''}>G</option>
                                                    <option value="PG" ${String(m.mpa).trim() === 'PG' ? 'selected' : ''}>PG</option>
                                                    <option value="PG-13" ${String(m.mpa).trim() === 'PG-13' ? 'selected' : ''}>PG-13</option>
                                                    <option value="R" ${String(m.mpa).trim() === 'R' ? 'selected' : ''}>R</option>
                                                    <option value="NC-17" ${String(m.mpa).trim() === 'NC-17' ? 'selected' : ''}>NC-17</option>
                                                </select>
                                            `}
                                        </div>
                                    </div>
                                    <div class="grid grid-2 gap-4">
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Runtime (min)</label>
                                            ${runtimeLocked ? `
                                                <input id="fld-runtime" name="Run Time" type="number" inputmode="numeric" step="1" class="input-field input-readonly" value="${m.runtime}" readonly>
                                            ` : `
                                                <input
                                                    id="fld-runtime"
                                                    name="Run Time"
                                                    type="number"
                                                    inputmode="numeric"
                                                    step="1"
                                                    min="0"
                                                    autocomplete="off"
                                                    class="input-field"
                                                    value="${m.runtime}"
                                                    placeholder="Minutes"
                                                >
                                            `}
                                        </div>
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Series?</label>
                                            ${seriesLocked ? `
                                                <input id="fld-series-display" class="input-field input-readonly" value="${m.isSeriesDisplay}" readonly>
                                                <input type="hidden" id="fld-series" name="Series" value="${m.isSeriesValue}">
                                            ` : `
                                                <select id="fld-series" name="Series" class="select-field">
                                                    <option value="" disabled ${!String(m.isSeriesValue || '').trim() ? 'selected' : ''}>Select...</option>
                                                    <option value="TRUE" ${String(m.isSeriesValue).trim() === 'TRUE' ? 'selected' : ''}>Yes</option>
                                                    <option value="FALSE" ${String(m.isSeriesValue).trim() === 'FALSE' ? 'selected' : ''}>No</option>
                                                </select>
                                            `}
                                        </div>
                                    </div>
                                    <div><label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Director</label><input id="fld-director" name="Director" class="input-field ${directorLocked ? 'input-readonly' : ''}" value="${m.director}" ${directorLocked ? 'readonly' : ''}></div>
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Genre</label>
                                        ${genreLocked ? `
                                            <input id="fld-genre" name="Genre" class="input-field input-readonly" value="${m.genre}" readonly>
                                        ` : `
                                            <input type="hidden" id="fld-genre" name="Genre" value="${selectedGenres.join(', ')}">
                                            <div id="genre-chip-wrap" class="genre-chip-wrap">
                                                ${genreOptions.map(g => `
                                                    <button
                                                        type="button"
                                                        class="genre-chip ${selectedGenres.includes(g) ? 'selected' : ''}"
                                                        data-genre="${g}"
                                                        aria-pressed="${selectedGenres.includes(g) ? 'true' : 'false'}"
                                                        onclick="toggleGenreChip(this)"
                                                    >${g}</button>
                                                `).join('')}
                                            </div>
                                            <div class="text-xs text-gray" style="margin-top:0.5rem;">Select any genres that apply</div>
                                        `}
                                    </div>

                                    <div style="border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1rem; margin-top: 0.5rem;">
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">External Ratings</label>
                                        <div class="flex flex-col gap-4">
                                            <div>
                                                <label class="text-xs text-gray submit-label block" style="margin-bottom: 0.25rem;">IMDb Rating</label>
                                                <div class="slider-container">
                                                    <input
                                                        id="fld-imdb-range"
                                                        type="range"
                                                        min="0"
                                                        max="100"
                                                        value="${imdbPct}"
                                                        ${imdbLocked ? 'disabled' : ''}
                                                        ${imdbLocked ? '' : "oninput=\"document.getElementById('fld-imdb').value = this.value\""}
                                                    >
                                                    <div class="relative" style="width: 140px;">
                                                        <input
                                                            type="number"
                                                            id="fld-imdb"
                                                            name="IMDb"
                                                            value="${imdbPct}"
                                                            min="0"
                                                            max="100"
                                                            class="input-field text-center ${imdbLocked ? 'input-readonly' : ''}"
                                                            ${imdbLocked ? 'readonly' : ''}
                                                            ${imdbLocked ? '' : "oninput=\"document.getElementById('fld-imdb-range').value = this.value\""}
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- User Input Section -->
                            <div class="glass-panel col-span-2" style="padding: 2rem; padding-bottom: calc(2rem - 10px); border-radius: 1rem;">
                                <div class="flex justify-between items-center mb-6" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; margin-bottom: 10px;">
                                    <div class="flex items-center gap-3">
                                        <span class="text-brand">${icons.edit3}</span>
                                        <h2 class="text-xl font-semibold text-white">Your Review</h2>
                                    </div>
                                </div>

                                <div class="grid md-row gap-6 mb-6" style="margin-top: 0px;">
                                    <div style="flex:1;">
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Date Watched</label>
                                        <input id="fld-datewatch" name="Date Watch" type="date" class="input-field ${isUpdate ? 'input-readonly' : ''}" value="${u.date}" ${isUpdate ? 'readonly title="Locked while updating"' : ''} required>
                                    </div>
                                    <div style="flex:1;">
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Tier List</label>
                                        <input type="hidden" id="fld-tier" name="Tier List" value="${(['S','A','B','C','D','F'].includes(tierLetter) ? `${tierLetter}-Tier` : String(u.tier || ''))}">
                                        <div class="tier-btn-group" style="margin-top: 0.35rem;" data-target-input="fld-tier" data-has-selection="${String(u.tier || '').trim() ? 'true' : 'false'}">
                                            <button type="button" class="tier-btn ${tierLetter === 'S' ? 'selected' : ''}" data-tier="S-Tier" aria-pressed="${tierLetter === 'S' ? 'true' : 'false'}" onclick="setTierFromButton(this)">S</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'A' ? 'selected' : ''}" data-tier="A-Tier" aria-pressed="${tierLetter === 'A' ? 'true' : 'false'}" onclick="setTierFromButton(this)">A</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'B' ? 'selected' : ''}" data-tier="B-Tier" aria-pressed="${tierLetter === 'B' ? 'true' : 'false'}" onclick="setTierFromButton(this)">B</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'C' ? 'selected' : ''}" data-tier="C-Tier" aria-pressed="${tierLetter === 'C' ? 'true' : 'false'}" onclick="setTierFromButton(this)">C</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'D' ? 'selected' : ''}" data-tier="D-Tier" aria-pressed="${tierLetter === 'D' ? 'true' : 'false'}" onclick="setTierFromButton(this)">D</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'F' ? 'selected' : ''}" data-tier="F-Tier" aria-pressed="${tierLetter === 'F' ? 'true' : 'false'}" onclick="setTierFromButton(this)">F</button>
                                        </div>
                                        <div class="text-xs text-gray" style="margin-top: 0.4rem;">Choose exactly one tier</div>
                                    </div>
                                </div>

                                <div class="mb-8">
                                    <h3 class="text-sm font-bold text-white uppercase mb-4 label-gap">Detailed Scoring (%)</h3>
                                    <div class="grid grid-2 gap-6">
                                        ${scoreOrder.map(key => `
                                            <div style="${key === 'overall' ? 'grid-column: span 2; padding: 1rem; border-radius: 0.75rem; background: var(--brand-light); border: 1px solid rgba(20,184,166,0.22);' : ''}">
                                                <label class="text-sm ${key === 'overall' ? 'text-white' : 'text-white'} font-bold mb-2 label-gap submit-label block capitalize" style="${key === 'overall' ? 'display:flex; align-items:center; gap:0.5rem;' : ''}">${key === 'overall' ? `<span class=\"text-brand\">${icons.star}</span><span>Overall</span>` : key === 'sound' ? 'Score - Sound Design' : key === 'imagery' ? 'Imagery - CGI - Animation' : key === 'acting' ? 'Acting - Character Animation' : key}</label>
                                                <div class="slider-container">
                                                    <input type="range" min="0" max="100" value="${scores[key]}" oninput="document.getElementById('num-${key}').value = this.value">
                                                    <div class="relative" style="width: 140px;">
                                                        <input
                                                            type="number"
                                                            id="num-${key}"
                                                            name="${key === 'overall' ? 'Overall' : key === 'sound' ? 'Score - Sound Design' : key === 'pace' ? 'Pace' : key === 'imagery' ? 'Imagery - CGI - Animation' : key === 'plot' ? 'Plot - Writting' : key === 'acting' ? 'Acting - Character Animation' : key === 'dialogue' ? 'Dialogue' : key}"
                                                            value="${scores[key]}"
                                                            min="0"
                                                            max="100"
                                                            class="input-field text-center ${key === 'overall' ? 'font-bold' : ''}"
                                                            oninput="this.parentElement.previousElementSibling.value = this.value"
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="flex flex-col gap-6" style="margin-bottom: 0px;">
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Favorite Quote</label>
                                        <div class="relative">
                                            <div class="input-icon">${icons.quote}</div>
                                            <input id="fld-quote" name="Fav Quote" type="text" class="input-field" style="padding-left: 2.5rem;" value="${u.quote}" placeholder="One liner...">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Notes / Review</label>
                                        <textarea id="fld-notes" name="Notes" class="textarea-field" rows="4" placeholder="Review...">${u.notes}</textarea>
                                    </div>
                                        <div class="grid grid-2 gap-6">
                                            <div class="flex items-center justify-start" style="gap: 25px;">
                                                <span class="text-sm text-white font-bold label-gap capitalize">Times Watched</span>
                                                <input id="fld-timeswatch" name="Times Watch" type="number" min="1" value="${u.watched}" class="input-field text-center ${timesWatchedLocked ? 'input-readonly' : ''}" style="width: 100px; height: 42px;" ${timesWatchedLocked ? 'readonly' : ''}>
                                            </div>
                                            <div class="flex items-center justify-start" style="gap: 25px;">
                                                <span class="text-sm text-white font-bold label-gap capitalize">Watch Method</span>
                                                <button
                                                    type="button"
                                                    id="watchmethod-toggle"
                                                    class="input-field ${watchMethodLocked ? 'input-readonly' : ''}"
                                                    style="width: 110px; height: 42px; display:flex; align-items:center; justify-content:center; padding:0; background-color: ${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'rgba(20, 184, 166, 0.35)' : 'rgba(168, 85, 247, 0.35)'}; color: white; border-color: ${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'rgba(20, 184, 166, 0.5)' : 'rgba(168, 85, 247, 0.5)'};"
                                                    ${watchMethodLocked ? 'disabled title="Locked while updating"' : 'onclick="toggleWatchMethod(this)"'}
                                                >
                                                    ${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'In Theater' : 'At Home'}
                                                </button>
                                                <input type="hidden" id="fld-watchmethod" name="Watch Method" value="${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'In Theater' : 'At Home'}">
                                            </div>
                                        </div>
                                </div>

                                <div class="flex justify-center" style="border-top: 1px solid rgba(255,255,255,0.05); margin-top: 15px; padding-top: 15px;">
                                    <button id="btn-save-diary" type="submit" class="btn btn-primary" style="margin-top: 0px; opacity: 0.6;" aria-disabled="true" title="Please log in first.">
                                        ${icons.save} Save to Diary
                                    </button>
                                </div>
                            </div>
                        </form>
                        </div>
                    </div>
                `;
            },

            renderDashboard() {
                return `
                    <div class="fade-in">
                        <!-- Background -->
                        <div style="position: fixed; inset: 0; background-image: url('https://images.unsplash.com/photo-1518676590629-3dcbd9c5a5c9?q=80&w=2028&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: -2; opacity: 0.15; pointer-events: none;"></div>
                        <div style="position: fixed; inset: 0; background: linear-gradient(to bottom, var(--bg-dark), transparent 20%, var(--bg-dark) 90%); z-index: -1; pointer-events: none;"></div>

                        <div class="container" style="padding-top: 2rem; position: relative;">
                        <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                            <div>
                                <h1 class="text-3xl font-bold text-white">Data Dashboard</h1>
                                <p class="text-gray mt-2">Insights into your viewing habits.</p>
                            </div>

                            <!-- Tabs (moved up) -->
                            <div class="glass-panel" style="padding: 0.55rem; border-radius: 0.9rem;">
                                <div class="flex" style="gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                    <button type="button" class="btn dash-pill-btn btn-glass" id="dash-tab-general" data-tab="general" style="padding: 0.6rem 0.9rem;">General</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-ratings" data-tab="ratings" style="padding: 0.6rem 0.9rem;">Ratings</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-tiers" data-tab="tiers" style="padding: 0.6rem 0.9rem;">Tiers</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-favorites" data-tab="favorites" style="padding: 0.6rem 0.9rem;">Favorites</button>
                                </div>
                            </div>
                        </div>

                        <!-- Timeframe (shown for all tabs) -->
                        <div style="display:flex; gap: 12px; align-items: flex-start; flex-wrap: wrap; margin-bottom: 1.25rem;">
                            <div class="glass-panel" style="padding: 0.55rem 0.75rem; border-radius: 0.9rem;">
                                <div class="text-xs text-gray" style="margin-bottom: 0.4rem;">Timeframe</div>
                                <div class="flex" style="gap: 10px; flex-wrap: wrap;">
                                    <button type="button" class="btn dash-pill-btn btn-glass" id="dash-range-all-time" data-range="all_time" style="padding: 0.55rem 0.85rem;">All Time</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-range-this-year" data-range="this_year" style="padding: 0.55rem 0.85rem;">This Year</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-range-this-month" data-range="this_month" style="padding: 0.55rem 0.85rem;">This Month</button>
                                </div>
                            </div>

                            <!-- Favorites-only: Rank By controls (shown only when Favorites tab active) -->
                            <div id="dash-fav-metric-panel" class="glass-panel hidden" style="padding: 0.55rem 0.75rem; border-radius: 0.9rem;">
                                <div class="text-xs text-gray" style="margin-bottom: 0.4rem;">Rank by</div>
                                <div id="dash-fav-metric-wrap" class="flex" style="gap: 10px; flex-wrap: wrap;">
                                    <button type="button" class="btn dash-pill-btn btn-glass" data-metric="overall" id="dash-fav-metric-overall" style="padding: 0.55rem 0.85rem;">Overall</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="sound" id="dash-fav-metric-sound" style="padding: 0.55rem 0.85rem;">Sound</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="plot" id="dash-fav-metric-plot" style="padding: 0.55rem 0.85rem;">Plot</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="pace" id="dash-fav-metric-pace" style="padding: 0.55rem 0.85rem;">Pace</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="acting" id="dash-fav-metric-acting" style="padding: 0.55rem 0.85rem;">Acting</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="imagery" id="dash-fav-metric-imagery" style="padding: 0.55rem 0.85rem;">Imagery</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" data-metric="dialogue" id="dash-fav-metric-dialogue" style="padding: 0.55rem 0.85rem;">Dialogue</button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: General -->
                        <div id="dash-pane-general">
                            <div class="grid grid-3 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Watch Events</span><span class="text-brand">${icons.video}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-watch-events-total">—</div>
                                            <div class="dash-mini-kpi-label">Total watches</div>
                                        </div>
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-watch-events-unique">—</div>
                                            <div class="dash-mini-kpi-label">Unique movies</div>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm text-gray" id="dash-general-watch-events-note">&nbsp;</div>
                                </div>

                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Hours Watched</span><span class="text-brand">${icons.clock}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-hours-watched">—</div>
                                            <div class="dash-mini-kpi-label">Total hours</div>
                                        </div>
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-hours-watched-unique">—</div>
                                            <div class="dash-mini-kpi-label">Unique hours</div>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm text-gray" id="dash-general-hours-watched-note">&nbsp;</div>
                                </div>

                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Watch Method</span><span class="text-brand">${icons.tv}</span></div>
                                    <div class="grid grid-2" style="gap: 12px;">
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-at-home">—</div>
                                            <div class="dash-mini-kpi-label">At home • <span class="tabular-nums" id="dash-general-at-home-unique">—</span> unique</div>
                                        </div>
                                        <div class="dash-mini-kpi">
                                            <div class="text-5xl font-bold text-white tabular-nums dash-mini-kpi-value" id="dash-general-in-theater">—</div>
                                            <div class="dash-mini-kpi-label">In theater • <span class="tabular-nums" id="dash-general-in-theater-unique">—</span> unique</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-3 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Genre</span><span class="text-brand">${icons.pieChart}</span></div>
                                    <div class="text-2xl font-bold text-white" id="dash-general-top-genre">—</div>
                                    <div class="mt-2 text-sm text-gray" id="dash-general-top-genre-note">&nbsp;</div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Decade</span><span class="text-brand">${icons.calendar}</span></div>
                                    <div class="text-2xl font-bold text-white" id="dash-general-top-decade">—</div>
                                    <div class="mt-2 text-sm text-gray" id="dash-general-top-decade-note">&nbsp;</div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Director</span><span class="text-brand">${icons.user}</span></div>
                                    <div class="text-2xl font-bold text-white" id="dash-general-top-director">—</div>
                                    <div class="mt-2 text-sm text-gray" id="dash-general-top-director-note">&nbsp;</div>
                                </div>
                            </div>

                            <div class="grid grid-3 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Actor</span><span class="text-brand">${icons.user}</span></div>
                                    <div class="text-2xl font-bold text-white" id="dash-general-top-actor">—</div>
                                    <div class="mt-2 text-sm text-gray" id="dash-general-top-actor-note">&nbsp;</div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched Movie</span><span class="text-brand">${icons.film}</span></div>
                                    <div class="text-xl font-bold text-white" id="dash-general-top-movie">—</div>
                                    <div class="mt-2 text-sm text-gray" id="dash-general-top-movie-note">&nbsp;</div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Most Watched MPA Rating</span><span class="text-brand">${icons.star}</span></div>
                                    <div class="text-2xl font-bold text-white" id="dash-general-top-mpa">—</div>
                                    <div class="mt-2 text-sm text-gray" id="dash-general-top-mpa-note">&nbsp;</div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Ratings (placeholder for now) -->
                        <div id="dash-pane-ratings" class="hidden">
                            <div class="grid grid-2 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4"><span class="text-gray text-sm">Avg Overall</span><span class="text-brand">${icons.percent}</span></div>
                                    <div class="text-5xl font-bold text-white tabular-nums" id="dash-ratings-avg-overall">—</div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Average Abs Diff Rating: You vs IMDb</span>
                                        <span class="text-brand">${icons.activity}</span>
                                    </div>
                                    <div class="text-5xl font-bold text-white tabular-nums" id="dash-ratings-avg-imdb-diff">—</div>
                                </div>
                            </div>

                            <div class="grid grid-2 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Highest Rated Genre</span>
                                        <span class="text-brand">${icons.trendingUp}</span>
                                    </div>
                                    <div class="text-2xl font-bold text-white" id="dash-ratings-top-genre">—</div>
                                    <div class="mt-2 text-sm text-gray">Avg <span class="text-brand tabular-nums" id="dash-ratings-top-genre-avg">—</span> • <span class="tabular-nums" id="dash-ratings-top-genre-n">—</span> movies</div>
                                </div>
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Lowest Rated Genre</span>
                                        <span class="text-brand">${icons.trendingDown}</span>
                                    </div>
                                    <div class="text-2xl font-bold text-white" id="dash-ratings-bottom-genre">—</div>
                                    <div class="mt-2 text-sm text-gray">Avg <span class="text-brand tabular-nums" id="dash-ratings-bottom-genre-avg">—</span> • <span class="tabular-nums" id="dash-ratings-bottom-genre-n">—</span> movies</div>
                                </div>
                            </div>

                            <div class="grid grid-2 gap-6 mb-8">
                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Highest Rated Director</span>
                                        <span class="text-brand">${icons.user}</span>
                                    </div>
                                    <div class="text-2xl font-bold text-white" id="dash-ratings-top-director">—</div>
                                    <div class="mt-2 text-sm text-gray">Avg <span class="text-brand tabular-nums" id="dash-ratings-top-director-avg">—</span> • <span class="tabular-nums" id="dash-ratings-top-director-n">—</span> movies</div>
                                </div>

                                <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                    <div class="flex justify-between mb-4">
                                        <span class="text-gray text-sm">Lowest Rated Director</span>
                                        <span class="text-brand">${icons.user}</span>
                                    </div>
                                    <div class="text-2xl font-bold text-white" id="dash-ratings-bottom-director">—</div>
                                    <div class="mt-2 text-sm text-gray">Avg <span class="text-brand tabular-nums" id="dash-ratings-bottom-director-avg">—</span> • <span class="tabular-nums" id="dash-ratings-bottom-director-n">—</span> movies</div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Tiers (placeholder for now) -->
                        <div id="dash-pane-tiers" class="hidden">
                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem; margin-bottom: 1.25rem;">
                                <div class="flex justify-between mb-4">
                                    <span class="text-gray text-sm">Tier Distribution</span>
                                    <span class="text-brand">${icons.pieChart}</span>
                                </div>
                                <div id="dash-tiers-bars"></div>
                            </div>

                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                <div class="flex justify-between mb-4">
                                    <span class="text-gray text-sm">Movies By Tier</span>
                                    <span class="text-brand">${icons.film}</span>
                                </div>
                                <div id="dash-tiers-lists"></div>
                            </div>
                        </div>

                        <!-- Tab: Favorites -->
                        <div id="dash-pane-favorites" class="hidden">
                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem; margin-bottom: 1.25rem;">
                                <div class="flex justify-between mb-4">
                                    <span style="font-size: 1.05rem; font-weight: 700; color: #34d399;">Top 5</span>
                                    <span style="color: #34d399;">${icons.trendingUp}</span>
                                </div>
                                <div id="dash-fav-top"></div>
                            </div>

                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                <div class="flex justify-between mb-4">
                                    <span style="font-size: 1.05rem; font-weight: 700; color: #fb7185;">Bottom 5</span>
                                    <span style="color: #fb7185;">${icons.trendingDown}</span>
                                </div>
                                <div id="dash-fav-bottom"></div>
                            </div>
                        </div>

                        </div>
                    </div>
                `;
            }
        };

        let homeSearchDebounceTimer = null;
        let homeSearchAbortController = null;
        let homeSearchItems = [];

        let homeTrendingItems = [];
        let homeTrendingAbortController = null;

        async function callSwiftApiPublic(body, { signal } = {}) {
            const url = `${SUPABASE_URL}/functions/v1/swift-api`;

            // If the user is logged in, include Authorization. If not, allow a public call.
            let authHeader = null;
            try {
                const { data } = await supabaseClient?.auth?.getSession?.();
                const token = data?.session?.access_token || null;
                if (token) authHeader = `Bearer ${token}`;
            } catch (_) {}

            const headers = {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
            };
            if (authHeader) headers['Authorization'] = authHeader;

            const res = await fetch(url, {
                method: 'POST',
                headers,
                body: JSON.stringify(body || {}),
                signal,
            });

            const text = await res.text();
            let data = null;
            try {
                data = text ? JSON.parse(text) : null;
            } catch (_) {
                data = text;
            }

            if (!res.ok) {
                const serverMsg =
                    data && typeof data === 'object'
                        ? (data.message || data.error || JSON.stringify(data))
                        : String(data || '');
                throw new Error(`${serverMsg || 'Request failed'}`);
            }

            return data;
        }

        async function loadDashboard() {
            // Called on router.navigate('dashboard') after the DOM is rendered.
            const elUnique = document.getElementById('dash-unique-movies-year');
            const elHours = document.getElementById('dash-total-hours');
            const elAvg = document.getElementById('dash-avg-rating');
            const elGenre = document.getElementById('dash-top-genre');
            const elGenreCount = document.getElementById('dash-top-genre-count');
            const elGenreAvg = document.getElementById('dash-top-genre-avg');

            const elTopMovieTitle = document.getElementById('dash-top-movie-title');
            const elTopMovieRating = document.getElementById('dash-top-movie-rating');
            const elWatchEventsYear = document.getElementById('dash-watch-events-year');
            const elWatchEventsAll = document.getElementById('dash-watch-events-all');

            const elDecade = document.getElementById('dash-most-watched-decade');
            const elDecadeCount = document.getElementById('dash-most-watched-decade-count');
            const elActor = document.getElementById('dash-most-watched-actor');
            const elActorCount = document.getElementById('dash-most-watched-actor-count');
            const elDirector = document.getElementById('dash-most-watched-director');
            const elDirectorCount = document.getElementById('dash-most-watched-director-count');

            const elHighDirector = document.getElementById('dash-highest-rated-director');
            const elHighDirectorAvg = document.getElementById('dash-highest-rated-director-avg');
            const elHighDirectorN = document.getElementById('dash-highest-rated-director-n');

            const elAtHome = document.getElementById('dash-at-home');
            const elInTheater = document.getElementById('dash-in-theater');

            const elTierBars = document.getElementById('dash-tier-bars');

            const required = [
                elUnique, elHours, elAvg, elGenre, elGenreCount, elGenreAvg,
                elTopMovieTitle, elTopMovieRating,
                elWatchEventsYear, elWatchEventsAll,
                elDecade, elDecadeCount,
                elActor, elActorCount,
                elDirector, elDirectorCount,
                elHighDirector, elHighDirectorAvg, elHighDirectorN,
                elAtHome, elInTheater,
                elTierBars,
            ];
            if (required.some(x => !x)) return;

            if (!supabaseClient) {
                elUnique.textContent = '—';
                elHours.textContent = '—';
                elAvg.textContent = '—';
                elGenre.textContent = '—';
                elGenreCount.textContent = '—';
                elGenreAvg.textContent = '—';

                elTopMovieTitle.textContent = '—';
                elTopMovieRating.textContent = '—';
                elWatchEventsYear.textContent = '—';
                elWatchEventsAll.textContent = '—';

                elDecade.textContent = '—';
                elDecadeCount.textContent = '—';
                elActor.textContent = '—';
                elActorCount.textContent = '—';
                elDirector.textContent = '—';
                elDirectorCount.textContent = '—';

                elHighDirector.textContent = '—';
                elHighDirectorAvg.textContent = '—';
                elHighDirectorN.textContent = '—';

                elAtHome.textContent = '—';
                elInTheater.textContent = '—';

                elTierBars.innerHTML = '';
                return;
            }

            // Require auth for dashboard metrics.
            let authedUser = null;
            try {
                const { data } = await supabaseClient.auth.getUser();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!authedUser?.id) {
                elUnique.textContent = '—';
                elHours.textContent = '—';
                elAvg.textContent = '—';
                elGenre.textContent = '—';
                elGenreCount.textContent = '—';
                elGenreAvg.textContent = '—';

                elTopMovieTitle.textContent = '—';
                elTopMovieRating.textContent = '—';
                elWatchEventsYear.textContent = '—';
                elWatchEventsAll.textContent = '—';

                elDecade.textContent = '—';
                elDecadeCount.textContent = '—';
                elActor.textContent = '—';
                elActorCount.textContent = '—';
                elDirector.textContent = '—';
                elDirectorCount.textContent = '—';

                elHighDirector.textContent = '—';
                elHighDirectorAvg.textContent = '—';
                elHighDirectorN.textContent = '—';

                elAtHome.textContent = '—';
                elInTheater.textContent = '—';

                elTierBars.innerHTML = '';
                return;
            }

            // Loading state.
            elUnique.textContent = '…';
            elHours.textContent = '…';
            elAvg.textContent = '…';
            elGenre.textContent = '…';
            elGenreCount.textContent = '…';
            elGenreAvg.textContent = '…';

            elTopMovieTitle.textContent = '…';
            elTopMovieRating.textContent = '…';
            elWatchEventsYear.textContent = '…';
            elWatchEventsAll.textContent = '…';

            elDecade.textContent = '…';
            elDecadeCount.textContent = '…';
            elActor.textContent = '…';
            elActorCount.textContent = '…';
            elDirector.textContent = '…';
            elDirectorCount.textContent = '…';

            elHighDirector.textContent = '…';
            elHighDirectorAvg.textContent = '…';
            elHighDirectorN.textContent = '…';

            elAtHome.textContent = '…';
            elInTheater.textContent = '…';

            elTierBars.innerHTML = '';

            try {
                const { data, error } = await supabaseClient.rpc('get_dashboard_summary');
                if (error) throw error;

                const uniqueMovies = Number(data?.unique_movies_this_year ?? 0);
                const totalHours = Number(data?.total_watch_hours_all_time ?? 0);
                const avgRating = Number(data?.avg_overall_rating ?? 0);
                const topGenre = String(data?.top_genre ?? '').trim();
                const topGenreCount = Number(data?.top_genre_count ?? 0);
                const topGenreAvg = Number(data?.top_genre_avg_overall ?? 0);

                const topMovieTitle = String(data?.highest_rated_movie?.title ?? '').trim();
                const topMovieRating = Number(data?.highest_rated_movie?.overall_rating ?? 0);

                const watchEventsYear = Number(data?.total_watch_events_this_year ?? 0);
                const watchEventsAll = Number(data?.total_watch_events_all_time ?? 0);

                const decade = data?.most_watched_decade?.decade;
                const decadeWatches = Number(data?.most_watched_decade?.watches ?? 0);

                const actorName = String(data?.most_watched_actor?.name ?? '').trim();
                const actorWatches = Number(data?.most_watched_actor?.watches ?? 0);

                const directorName = String(data?.most_watched_director?.name ?? '').trim();
                const directorWatches = Number(data?.most_watched_director?.watches ?? 0);

                const highDirectorName = String(data?.highest_rated_director?.name ?? '').trim();
                const highDirectorAvg = Number(data?.highest_rated_director?.avg_overall ?? 0);
                const highDirectorN = Number(data?.highest_rated_director?.n ?? 0);

                const atHome = Number(data?.watch_method_breakdown?.at_home ?? 0);
                const inTheater = Number(data?.watch_method_breakdown?.in_theater ?? 0);

                const tierDist = Array.isArray(data?.tier_distribution) ? data.tier_distribution : [];

                elUnique.textContent = Number.isFinite(uniqueMovies) ? String(uniqueMovies) : '0';
                elHours.textContent = Number.isFinite(totalHours) ? String(totalHours) : '0';
                elAvg.textContent = Number.isFinite(avgRating) ? String(avgRating) : '0';
                elGenre.textContent = topGenre || '—';
                elGenreCount.textContent = Number.isFinite(topGenreCount) ? String(topGenreCount) : '0';
                elGenreAvg.textContent = Number.isFinite(topGenreAvg) ? String(topGenreAvg) : '0';

                elTopMovieTitle.textContent = topMovieTitle || '—';
                elTopMovieRating.textContent = Number.isFinite(topMovieRating) ? String(topMovieRating) : '0';

                elWatchEventsYear.textContent = Number.isFinite(watchEventsYear) ? String(watchEventsYear) : '0';
                elWatchEventsAll.textContent = Number.isFinite(watchEventsAll) ? String(watchEventsAll) : '0';

                elDecade.textContent = (decade === null || decade === undefined) ? '—' : `${String(decade)}s`;
                elDecadeCount.textContent = Number.isFinite(decadeWatches) ? String(decadeWatches) : '0';

                elActor.textContent = actorName || '—';
                elActorCount.textContent = Number.isFinite(actorWatches) ? String(actorWatches) : '0';

                elDirector.textContent = directorName || '—';
                elDirectorCount.textContent = Number.isFinite(directorWatches) ? String(directorWatches) : '0';

                elHighDirector.textContent = highDirectorName || '—';
                elHighDirectorAvg.textContent = Number.isFinite(highDirectorAvg) ? String(highDirectorAvg) : '0';
                elHighDirectorN.textContent = Number.isFinite(highDirectorN) ? String(highDirectorN) : '0';

                elAtHome.textContent = Number.isFinite(atHome) ? String(atHome) : '0';
                elInTheater.textContent = Number.isFinite(inTheater) ? String(inTheater) : '0';

                const tierColors = {
                    'S': 'rgba(20, 184, 166, 0.35)',
                    'A': 'rgba(168, 85, 247, 0.35)',
                    'B': 'rgba(59, 130, 246, 0.35)',
                    'C': 'rgba(245, 158, 11, 0.35)',
                    'D': 'rgba(239, 68, 68, 0.35)',
                    'F': 'rgba(107, 114, 128, 0.35)',
                };

                elTierBars.innerHTML = tierDist.map((t) => {
                    const tier = String(t?.tier ?? '').trim() || '—';
                    const pct = Number(t?.pct ?? 0);
                    const count = Number(t?.count ?? 0);
                    const width = Number.isFinite(pct) ? Math.max(0, Math.min(100, pct)) : 0;
                    const bg = tierColors[tier.toUpperCase()] || 'rgba(255,255,255,0.10)';
                    return `
                        <div style="min-width: 140px; flex: 1;">
                            <div class="flex justify-between" style="margin-bottom: 6px;">
                                <span class="text-xs text-gray">Tier ${escapeHtml(tier)}</span>
                                <span class="text-xs text-gray">${Number.isFinite(pct) ? pct.toFixed(1) : '0.0'}% (${Number.isFinite(count) ? count : 0})</span>
                            </div>
                            <div style="height: 10px; background: rgba(255,255,255,0.06); border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06);">
                                <div style="height: 100%; width: ${width}%; background: ${bg};"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                // Quiet failure; keep placeholders.
                elUnique.textContent = '—';
                elHours.textContent = '—';
                elAvg.textContent = '—';
                elGenre.textContent = '—';
                elGenreCount.textContent = '—';
                elGenreAvg.textContent = '—';

                elTopMovieTitle.textContent = '—';
                elTopMovieRating.textContent = '—';
                elWatchEventsYear.textContent = '—';
                elWatchEventsAll.textContent = '—';

                elDecade.textContent = '—';
                elDecadeCount.textContent = '—';
                elActor.textContent = '—';
                elActorCount.textContent = '—';
                elDirector.textContent = '—';
                elDirectorCount.textContent = '—';

                elHighDirector.textContent = '—';
                elHighDirectorAvg.textContent = '—';
                elHighDirectorN.textContent = '—';

                elAtHome.textContent = '—';
                elInTheater.textContent = '—';

                elTierBars.innerHTML = '';
            }
        }

        function initDashboardTabs() {
            const wrap = document.getElementById('dash-tab-general')?.parentElement;
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-tab]') : null;
                const tab = btn?.dataset?.tab;
                if (!tab) return;
                setDashboardTab(tab);
            });
        }

        let dashboardTimeframe = 'all_time';
        let dashboardActiveTab = 'general';
        let dashboardAuthWarned = false;
        let dashboardFavoritesMetric = 'overall';

        const dashPosterCacheByTmdbId = new Map();
        const dashRatingCacheByMovieId = new Map();

        function initDashboardFavoritesMetric() {
            const wrap = document.getElementById('dash-fav-metric-wrap');
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-metric]') : null;
                const metric = btn?.dataset?.metric;
                if (!metric) return;
                setDashboardFavoritesMetric(metric);
            });
        }

        function setDashboardFavoritesMetric(metric) {
            const m = String(metric || '').trim().toLowerCase();
            const allowed = new Set(['overall', 'sound', 'plot', 'pace', 'acting', 'imagery', 'dialogue']);
            dashboardFavoritesMetric = allowed.has(m) ? m : 'overall';

            const wrap = document.getElementById('dash-fav-metric-wrap');
            if (wrap) {
                wrap.querySelectorAll('button[data-metric]').forEach((btn) => {
                    const isOn = String(btn.dataset.metric || '').trim().toLowerCase() === dashboardFavoritesMetric;
                    btn.classList.remove('btn-glass', 'btn-outline');
                    btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
                });
            }

            if (dashboardActiveTab === 'favorites') {
                setDashboardTab('favorites');
            }
        }

        function initDashboardTimeframe() {
            const wrap = document.getElementById('dash-range-all-time')?.parentElement;
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-range]') : null;
                const range = btn?.dataset?.range;
                if (!range) return;
                setDashboardTimeframe(range);
            });
        }

        function setDashboardTimeframe(range) {
            const r = String(range || '').trim().toLowerCase();
            const allowed = new Set(['all_time', 'this_year', 'this_month']);
            dashboardTimeframe = allowed.has(r) ? r : 'all_time';

            const btnAll = document.getElementById('dash-range-all-time');
            const btnYear = document.getElementById('dash-range-this-year');
            const btnMonth = document.getElementById('dash-range-this-month');
            const activate = (btn, on) => {
                if (!btn) return;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(on ? 'btn-glass' : 'btn-outline');
            };
            activate(btnAll, dashboardTimeframe === 'all_time');
            activate(btnYear, dashboardTimeframe === 'this_year');
            activate(btnMonth, dashboardTimeframe === 'this_month');

            // Reload the active tab under the new timeframe.
            setDashboardTab(dashboardActiveTab);
        }

        async function setDashboardTab(tab) {
            if (!cachedIsAuthed) {
                openDashboardAuthWarning();
                return;
            }
            const t = String(tab || '').trim().toLowerCase();
            dashboardActiveTab = t || 'general';
            const tabGeneral = document.getElementById('dash-tab-general');
            const tabRatings = document.getElementById('dash-tab-ratings');
            const tabTiers = document.getElementById('dash-tab-tiers');
            const tabFavorites = document.getElementById('dash-tab-favorites');
            const paneGeneral = document.getElementById('dash-pane-general');
            const paneRatings = document.getElementById('dash-pane-ratings');
            const paneTiers = document.getElementById('dash-pane-tiers');
            const paneFavorites = document.getElementById('dash-pane-favorites');
            const favMetricPanel = document.getElementById('dash-fav-metric-panel');
            if (!tabGeneral || !tabRatings || !tabTiers || !tabFavorites || !paneGeneral || !paneRatings || !paneTiers || !paneFavorites) return;

            const activate = (btn, on) => {
                if (!btn) return;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(on ? 'btn-glass' : 'btn-outline');
            };

            const show = (pane, on) => {
                if (!pane) return;
                if (on) pane.classList.remove('hidden');
                else pane.classList.add('hidden');
            };

            activate(tabGeneral, t === 'general');
            activate(tabRatings, t === 'ratings');
            activate(tabTiers, t === 'tiers');
            activate(tabFavorites, t === 'favorites');

            show(paneGeneral, t === 'general');
            show(paneRatings, t === 'ratings');
            show(paneTiers, t === 'tiers');
            show(paneFavorites, t === 'favorites');

            // Favorites-only header controls
            if (favMetricPanel) {
                if (t === 'favorites') favMetricPanel.classList.remove('hidden');
                else favMetricPanel.classList.add('hidden');
            }

            if (t === 'general') {
                await loadDashboardGeneral();
            } else if (t === 'ratings') {
                await loadDashboardRatings();
            } else if (t === 'tiers') {
                await loadDashboardTiers();
            } else if (t === 'favorites') {
                await loadDashboardFavorites();
            }
        }

        async function loadDashboardFavorites() {
            const elTop = document.getElementById('dash-fav-top');
            const elBottom = document.getElementById('dash-fav-bottom');
            if (!elTop || !elBottom) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                elTop.innerHTML = `<div class="text-gray">Log in to view favorites.</div>`;
                elBottom.innerHTML = `<div class="text-gray">Log in to view favorites.</div>`;
                return;
            }

            elTop.innerHTML = `<div class="text-gray">Loading…</div>`;
            elBottom.innerHTML = `<div class="text-gray">Loading…</div>`;

            const formatScore = (n) => {
                const num = Number(n);
                if (!Number.isFinite(num)) return '';
                const rounded = Math.round(num * 10) / 10;
                if (Math.abs(rounded - Math.round(rounded)) < 1e-9) return `${Math.round(rounded)}%`;
                return `${rounded.toFixed(1)}%`;
            };

            const ensurePosterPath = async (item) => {
                const tmdb_id = Number(item?.tmdb_id);
                if (!Number.isFinite(tmdb_id) || tmdb_id <= 0) return null;
                if (dashPosterCacheByTmdbId.has(tmdb_id)) return dashPosterCacheByTmdbId.get(tmdb_id);
                try {
                    const details = await callSwiftApiGetMovieDetails({ tmdb_id });
                    const poster_path = details?.poster_path ? String(details.poster_path) : null;
                    dashPosterCacheByTmdbId.set(tmdb_id, poster_path);
                    return poster_path;
                } catch (_) {
                    dashPosterCacheByTmdbId.set(tmdb_id, null);
                    return null;
                }
            };

            const normalizeTierLabel = (tierRaw) => {
                const t = String(tierRaw ?? '').trim();
                if (!t) return '';
                const u = t.toUpperCase();
                if (u === 'UNRANKED') return 'Unranked';
                if (/^[SABCDF]$/i.test(t)) return `${u}-Tier`;
                if (/^[SABCDF]\s*-?\s*TIER$/i.test(t)) return `${u[0]}-Tier`;
                return t;
            };

            const ensureRatingsForItems = async (items) => {
                const safe = Array.isArray(items) ? items : [];
                const ids = Array.from(new Set(
                    safe
                        .map((r) => r?.movie_id)
                        .filter(Boolean)
                ));
                const missing = ids.filter((id) => !dashRatingCacheByMovieId.has(id));
                if (missing.length === 0) return;

                const { data, error } = await supabaseClient
                    .from('Movie Ratings')
                    .select('movie_id, overall_rating, tier')
                    .eq('user_id', authedUser.id)
                    .in('movie_id', missing);

                if (error) throw error;

                const rows = Array.isArray(data) ? data : [];
                const byId = new Map(rows.map((r) => [r.movie_id, r]));
                for (const id of missing) {
                    dashRatingCacheByMovieId.set(id, byId.get(id) || null);
                }
            };

            const renderRow = async (items) => {
                const safe = Array.isArray(items) ? items.slice(0, 5) : [];
                if (safe.length === 0) {
                    return `<div class="text-gray">No rated movies found for this timeframe.</div>`;
                }

                // Best-effort poster fetch (cached) + rating metadata fetch (cached).
                await Promise.all([
                    Promise.all(safe.map(ensurePosterPath)),
                    ensureRatingsForItems(safe),
                ]);

                const cards = safe.map((r) => {
                    const title = String(r?.title ?? '').trim() || 'Untitled';
                    const year = (r?.release_year === null || r?.release_year === undefined) ? '' : String(r.release_year);
                    const ratingRow = dashRatingCacheByMovieId.get(r?.movie_id) || null;
                    const overall = ratingRow ? ratingRow.overall_rating : null;
                    const overallText = formatScore(overall);
                    const tierLabel = normalizeTierLabel(ratingRow ? ratingRow.tier : '');
                    const tmdb_id = Number(r?.tmdb_id);
                    const poster_path = Number.isFinite(tmdb_id) ? dashPosterCacheByTmdbId.get(tmdb_id) : null;
                    const posterUrl = poster_path ? `https://image.tmdb.org/t/p/w342${poster_path}` : '';

                    const meta = [
                        year || '',
                        overallText ? `${overallText} Overall` : '',
                        tierLabel,
                    ].filter(Boolean).join(' • ');

                    return `
                        <div style="display:flex; flex-direction: column; gap: 8px;">
                            <div style="width: 100%; aspect-ratio: 2/3; border-radius: 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06);">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" alt="${escapeHtml(title)}" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.closest('div')?.remove?.()">`
                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`
                                }
                            </div>
                            <div class="text-sm text-white" style="font-weight: 700; line-height: 1.2;">${escapeHtml(title)}</div>
                            <div class="text-xs text-gray tabular-nums">${escapeHtml(meta)}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px;">
                        ${cards}
                    </div>
                `;
            };

            try {
                let res = await supabaseClient.rpc('get_dashboard_favorites', {
                    p_timeframe: dashboardTimeframe,
                    p_metric: dashboardFavoritesMetric,
                });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const missingRpc = /get_dashboard_favorites/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (missingRpc) {
                        elTop.innerHTML = `<div class="text-gray">Favorites RPC missing. Run dashboard_rpc.sql to add get_dashboard_favorites.</div>`;
                        elBottom.innerHTML = `<div class="text-gray">Favorites RPC missing. Run dashboard_rpc.sql to add get_dashboard_favorites.</div>`;
                        return;
                    }
                }
                if (res?.error) throw res.error;

                const data = res?.data;
                const top = Array.isArray(data?.top) ? data.top : [];
                const bottom = Array.isArray(data?.bottom) ? data.bottom : [];

                elTop.innerHTML = await renderRow(top);
                elBottom.innerHTML = await renderRow(bottom);
            } catch (err) {
                showToast(`Dashboard (Favorites) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard favorites load failed', err);
                elTop.innerHTML = `<div class="text-gray">Unable to load favorites right now.</div>`;
                elBottom.innerHTML = `<div class="text-gray">Unable to load favorites right now.</div>`;
            }
        }

        async function loadDashboardTiers() {
            const elBars = document.getElementById('dash-tiers-bars');
            const elLists = document.getElementById('dash-tiers-lists');
            if (!elBars || !elLists) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                elBars.innerHTML = '';
                elLists.innerHTML = `<div class="text-gray">Log in to view your tier stats.</div>`;
                return;
            }

            elBars.innerHTML = `<div class="text-gray">Loading…</div>`;
            elLists.innerHTML = `<div class="text-gray">Loading…</div>`;

            try {
                let res = await supabaseClient.rpc('get_dashboard_tiers', { p_timeframe: dashboardTimeframe });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const looksLikeOldSignature = /get_dashboard_tiers/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (looksLikeOldSignature) res = await supabaseClient.rpc('get_dashboard_tiers');
                }
                if (res?.error) throw res.error;
                const data = res?.data;

                const ratedTotal = Number(data?.rated_total ?? 0);
                const tierDist = Array.isArray(data?.tier_distribution) ? data.tier_distribution : [];
                const tierMovies = Array.isArray(data?.tier_movies) ? data.tier_movies : [];

                const tierOrder = ['S', 'A', 'B', 'C', 'D', 'F'];
                // Tier colors (requested palette)
                const tierColorSolid = {
                    'S': '#ef4444', // red
                    'A': '#f97316', // orange
                    'B': '#facc15', // yellow
                    'C': '#22c55e', // green
                    'D': '#3b82f6', // blue
                    'F': '#a855f7', // purple
                    'UNRANKED': '#6b7280',
                };
                const tierColorBg = {
                    'S': 'rgba(239, 68, 68, 0.22)',
                    'A': 'rgba(249, 115, 22, 0.22)',
                    'B': 'rgba(250, 204, 21, 0.20)',
                    'C': 'rgba(34, 197, 94, 0.22)',
                    'D': 'rgba(59, 130, 246, 0.22)',
                    'F': 'rgba(168, 85, 247, 0.22)',
                    'UNRANKED': 'rgba(107, 114, 128, 0.22)',
                };

                const tierHelp = {
                    'S': 'The Pantheon. Best of the Best.',
                    'A': 'Great! Highly Recommended Films!',
                    'B': 'Worth a Watch. Solidly Good and Entertaining.',
                    'C': "Totally Average. Fine if it's on, but don't go out of your way.",
                    'D': 'Skip it. Seriously Flawed and Not Worth the Time.',
                    'F': 'Avoid at All Costs. A Genuinely Bad Experience.',
                };

                const distByTier = new Map();
                for (const t of tierDist) {
                    const tier = String(t?.tier ?? '').trim().toUpperCase();
                    if (!tier) continue;
                    distByTier.set(tier, {
                        tier,
                        count: Number(t?.count ?? 0),
                        pct: Number(t?.pct ?? 0),
                    });
                }

                // Render distribution bars (S/A/B/C/D/F first, then anything else like Unranked)
                const extraTiers = [...distByTier.keys()]
                    .filter(t => !tierOrder.includes(t))
                    .sort((a, b) => {
                        if (a === 'UNRANKED') return 1;
                        if (b === 'UNRANKED') return -1;
                        return a.localeCompare(b);
                    });
                const tiersForBars = [...tierOrder.filter(t => distByTier.has(t)), ...extraTiers];

                const formatTierLabel = (tier) => {
                    const t = String(tier ?? '').trim().toUpperCase();
                    if (!t) return '';
                    if (t === 'UNRANKED') return 'Unranked';
                    if (tierOrder.includes(t)) return `${t}-Tier`;
                    return String(tier ?? '').trim();
                };

                // Vertical bar chart distribution (much larger)
                const tiersForChart = [...tierOrder, ...extraTiers.filter(t => t !== 'UNRANKED'), ...(distByTier.has('UNRANKED') ? ['UNRANKED'] : [])];
                const totalCount = Number.isFinite(ratedTotal) && ratedTotal > 0
                    ? ratedTotal
                    : tiersForChart.reduce((sum, t) => sum + (Number(distByTier.get(t)?.count ?? 0) || 0), 0);

                if (!totalCount) {
                    elBars.innerHTML = `<div class="text-gray">No tier data yet. Rate a movie to get started.</div>`;
                } else {
                    const barsHTML = tiersForChart
                        .filter(t => distByTier.has(t))
                        .map((t) => {
                            const label = formatTierLabel(t) || 'Tier';
                            const count = Number(distByTier.get(t)?.count ?? 0) || 0;
                            const pctFromRpc = Number(distByTier.get(t)?.pct ?? 0);
                            const pct = Number.isFinite(pctFromRpc) && pctFromRpc > 0
                                ? pctFromRpc
                                : (count / totalCount) * 100;
                            const h = Math.max(0, Math.min(100, pct));
                            const fill = tierColorSolid[t] || '#6b7280';
                            const bg = tierColorBg[t] || 'rgba(255,255,255,0.10)';
                            return `
                                <div style="width: 100%; min-width: 120px; display:flex; flex-direction: column; gap: 10px; align-items: center;">
                                    <div class="text-xs text-gray tabular-nums" style="height: 16px;">${pct.toFixed(1)}%</div>
                                    <div style="height: 320px; width: 100%; background: rgba(255,255,255,0.06); border-radius: 14px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; display:flex; align-items: flex-end;">
                                        <div style="height: ${h}%; width: 100%; background: ${bg}; display:flex; align-items: flex-end;">
                                            <div style="height: 100%; width: 100%; background: ${fill}; opacity: 0.92;"></div>
                                        </div>
                                    </div>
                                    <div class="text-sm text-white" style="font-weight: 800; line-height: 1.1; text-align: center;">${escapeHtml(label)}</div>
                                    <div class="text-xs text-gray tabular-nums" style="margin-top: -6px;">${count} movie${count === 1 ? '' : 's'}</div>
                                </div>
                            `;
                        })
                        .join('');

                    elBars.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 18px; align-items: flex-end; width: 100%;">
                            ${barsHTML}
                        </div>
                    `;
                }

                // Group movies by tier
                const byTier = new Map();
                for (const row of tierMovies) {
                    const tier = String(row?.tier ?? '').trim().toUpperCase() || '—';
                    if (!byTier.has(tier)) byTier.set(tier, []);
                    byTier.get(tier).push(row);
                }

                const formatMovieRow = (r) => {
                    const title = String(r?.title ?? '').trim();
                    const year = (r?.release_year === null || r?.release_year === undefined) ? '' : String(r.release_year);
                    const rating = (r?.overall_rating === null || r?.overall_rating === undefined) ? '' : String(r.overall_rating);
                    const metaParts = [year, rating ? `Overall ${rating}` : ''].filter(Boolean);

                    return `
                        <div class="flex justify-between dash-movie-row">
                            <div>
                                <div class="text-white" style="font-weight: 600;">${escapeHtml(title || 'Untitled')}</div>
                                <div class="text-xs text-gray tabular-nums">${escapeHtml(metaParts.join(' • ') || '')}</div>
                            </div>
                        </div>
                    `;
                };

                const tiersToRender = [...tierOrder, ...[...byTier.keys()].filter(t => !tierOrder.includes(t) && t !== '—'), ...(byTier.has('—') ? ['—'] : [])];

                const listsHTML = tiersToRender
                    .filter(tier => byTier.has(tier))
                    .map((tier) => {
                        const items = byTier.get(tier) || [];
                        const ratingNums = items
                            .map((r) => Number(r?.overall_rating))
                            .filter((n) => Number.isFinite(n));
                        const avgOverall = ratingNums.length
                            ? (ratingNums.reduce((sum, n) => sum + n, 0) / ratingNums.length)
                            : null;
                        const avgOverallText = avgOverall === null ? '—' : `${Math.round(avgOverall)}%`;
                        const headerBg = tierColorBg[tier] || 'rgba(255,255,255,0.06)';
                        const headerLabel = formatTierLabel(tier) || 'Tier';
                        const help = tierHelp[String(tier ?? '').trim().toUpperCase()] || '';
                        return `
                            <details style="margin-bottom: 10px;">
                                <summary style="list-style: none; cursor: pointer; user-select: none; padding: 0.85rem 1rem; border-radius: 0.75rem; background: ${headerBg}; border: 1px solid rgba(255,255,255,0.08); display:flex; justify-content: space-between; align-items: center;">
                                    <div style="display:flex; flex-direction: column; gap: 2px;">
                                        <span class="text-white" style="font-weight: 800;">${escapeHtml(headerLabel)}</span>
                                        ${help ? `<span class=\"text-xs text-gray\">${escapeHtml(help)}</span>` : ''}
                                    </div>
                                    <div style="display:flex; flex-direction: column; align-items: flex-end; gap: 2px;">
                                        <span class="text-xs text-gray">${items.length} movie${items.length === 1 ? '' : 's'}</span>
                                        <span class="text-xs text-gray" style="white-space: nowrap;">Average Overall Rating: ${escapeHtml(avgOverallText)}</span>
                                    </div>
                                </summary>
                                <div style="padding: 0.85rem 0.5rem 0.25rem 0.5rem; display: grid; gap: 8px;">
                                    ${items.map(formatMovieRow).join('')}
                                </div>
                            </details>
                        `;
                    })
                    .join('');

                elLists.innerHTML = listsHTML || `<div class="text-gray">No tiered movies yet. Rate a movie to populate tiers.</div>`;

                // Small footnote if there are zero ratings
                if (!ratedTotal) {
                    elBars.innerHTML = `<div class="text-gray">No tier data yet. Rate a movie to get started.</div>`;
                }
            } catch (err) {
                showToast(`Dashboard (Tiers) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard tiers load failed', err);
                elBars.innerHTML = '';
                elLists.innerHTML = `<div class="text-gray">Unable to load tiers right now.</div>`;
            }
        }

        async function loadDashboardRatings() {
            const elAvgOverall = document.getElementById('dash-ratings-avg-overall');
            const elAvgImdbDiff = document.getElementById('dash-ratings-avg-imdb-diff');

            const elTopGenre = document.getElementById('dash-ratings-top-genre');
            const elTopGenreAvg = document.getElementById('dash-ratings-top-genre-avg');
            const elTopGenreN = document.getElementById('dash-ratings-top-genre-n');
            const elBottomGenre = document.getElementById('dash-ratings-bottom-genre');
            const elBottomGenreAvg = document.getElementById('dash-ratings-bottom-genre-avg');
            const elBottomGenreN = document.getElementById('dash-ratings-bottom-genre-n');

            const elTopDirector = document.getElementById('dash-ratings-top-director');
            const elTopDirectorAvg = document.getElementById('dash-ratings-top-director-avg');
            const elTopDirectorN = document.getElementById('dash-ratings-top-director-n');

            const elBottomDirector = document.getElementById('dash-ratings-bottom-director');
            const elBottomDirectorAvg = document.getElementById('dash-ratings-bottom-director-avg');
            const elBottomDirectorN = document.getElementById('dash-ratings-bottom-director-n');

            const required = [
                elAvgOverall,
                elAvgImdbDiff,
                elTopGenre, elTopGenreAvg, elTopGenreN,
                elBottomGenre, elBottomGenreAvg, elBottomGenreN,
                elTopDirector, elTopDirectorAvg, elTopDirectorN,
                elBottomDirector, elBottomDirectorAvg, elBottomDirectorN,
            ];
            if (required.some(x => !x)) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            const setAll = (v) => {
                elAvgOverall.textContent = v;
                elAvgImdbDiff.textContent = v;
                elTopGenre.textContent = v;
                elTopGenreAvg.textContent = v;
                elTopGenreN.textContent = v;
                elBottomGenre.textContent = v;
                elBottomGenreAvg.textContent = v;
                elBottomGenreN.textContent = v;
                elTopDirector.textContent = v;
                elTopDirectorAvg.textContent = v;
                elTopDirectorN.textContent = v;
                elBottomDirector.textContent = v;
                elBottomDirectorAvg.textContent = v;
                elBottomDirectorN.textContent = v;
            };

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                setAll('—');
                return;
            }

            setAll('…');

            try {
                let res = await supabaseClient.rpc('get_dashboard_ratings', { p_timeframe: dashboardTimeframe });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const looksLikeOldSignature = /get_dashboard_ratings/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (looksLikeOldSignature) res = await supabaseClient.rpc('get_dashboard_ratings');
                }
                if (res?.error) throw res.error;
                const data = res?.data;

                const formatScore = (n) => {
                    if (!Number.isFinite(n)) return '0';
                    const rounded = Math.round(n * 10) / 10;
                    if (Math.abs(rounded - Math.round(rounded)) < 1e-9) return String(Math.round(rounded));
                    return rounded.toFixed(1);
                };

                const ratedCount = Number(data?.rated_movies_count ?? 0);
                const avgOverall = Number(data?.avg_overall_rating ?? 0);
                const avgImdbDiff = Number(data?.avg_abs_imdb_diff ?? 0);

                const topGenre = data?.highest_rated_genre || {};
                const topGenreName = String(topGenre?.name ?? '').trim();
                const topGenreAvg = Number(topGenre?.avg_overall ?? 0);
                const topGenreN = Number(topGenre?.n ?? 0);

                const bottomGenre = data?.lowest_rated_genre || {};
                const bottomGenreName = String(bottomGenre?.name ?? '').trim();
                const bottomGenreAvg = Number(bottomGenre?.avg_overall ?? 0);
                const bottomGenreN = Number(bottomGenre?.n ?? 0);

                const topDirector = data?.highest_rated_director || {};
                const topDirectorName = String(topDirector?.name ?? '').trim();
                const topDirectorAvg = Number(topDirector?.avg_overall ?? 0);
                const topDirectorN = Number(topDirector?.n ?? 0);

                const bottomDirector = data?.lowest_rated_director || {};
                const bottomDirectorName = String(bottomDirector?.name ?? '').trim();
                const bottomDirectorAvg = Number(bottomDirector?.avg_overall ?? 0);
                const bottomDirectorN = Number(bottomDirector?.n ?? 0);

                // Any KPI that represents a rating shows as a percentage.
                elAvgOverall.textContent = `${formatScore(avgOverall)}%`;
                elAvgImdbDiff.textContent = `${formatScore(avgImdbDiff)}% points`;

                elTopGenre.textContent = topGenreName || '—';
                elTopGenreAvg.textContent = `${formatScore(topGenreAvg)}%`;
                elTopGenreN.textContent = Number.isFinite(topGenreN) ? String(topGenreN) : '0';

                elBottomGenre.textContent = bottomGenreName || '—';
                elBottomGenreAvg.textContent = `${formatScore(bottomGenreAvg)}%`;
                elBottomGenreN.textContent = Number.isFinite(bottomGenreN) ? String(bottomGenreN) : '0';

                elTopDirector.textContent = topDirectorName || '—';
                elTopDirectorAvg.textContent = `${formatScore(topDirectorAvg)}%`;
                elTopDirectorN.textContent = Number.isFinite(topDirectorN) ? String(topDirectorN) : '0';

                elBottomDirector.textContent = bottomDirectorName || '—';
                elBottomDirectorAvg.textContent = `${formatScore(bottomDirectorAvg)}%`;
                elBottomDirectorN.textContent = Number.isFinite(bottomDirectorN) ? String(bottomDirectorN) : '0';
            } catch (err) {
                showToast(`Dashboard (Ratings) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard ratings load failed', err);
                setAll('—');
            }
        }

        async function loadDashboardGeneral() {
            const elEventsTotal = document.getElementById('dash-general-watch-events-total');
            const elEventsUnique = document.getElementById('dash-general-watch-events-unique');
            const elEventsNote = document.getElementById('dash-general-watch-events-note');
            const elHours = document.getElementById('dash-general-hours-watched');
            const elHoursUnique = document.getElementById('dash-general-hours-watched-unique');
            const elHoursNote = document.getElementById('dash-general-hours-watched-note');
            const elAtHome = document.getElementById('dash-general-at-home');
            const elInTheater = document.getElementById('dash-general-in-theater');
            const elAtHomeUnique = document.getElementById('dash-general-at-home-unique');
            const elInTheaterUnique = document.getElementById('dash-general-in-theater-unique');

            const elTopGenre = document.getElementById('dash-general-top-genre');
            const elTopGenreNote = document.getElementById('dash-general-top-genre-note');
            const elTopDirector = document.getElementById('dash-general-top-director');
            const elTopDirectorNote = document.getElementById('dash-general-top-director-note');
            const elTopActor = document.getElementById('dash-general-top-actor');
            const elTopActorNote = document.getElementById('dash-general-top-actor-note');
            const elTopDecade = document.getElementById('dash-general-top-decade');
            const elTopDecadeNote = document.getElementById('dash-general-top-decade-note');

            const elTopMovie = document.getElementById('dash-general-top-movie');
            const elTopMovieNote = document.getElementById('dash-general-top-movie-note');
            const elTopMpa = document.getElementById('dash-general-top-mpa');
            const elTopMpaNote = document.getElementById('dash-general-top-mpa-note');

            const required = [
                elEventsTotal, elEventsUnique, elEventsNote,
                elHours, elHoursUnique, elHoursNote,
                elAtHome, elAtHomeUnique, elInTheater, elInTheaterUnique,
                elTopGenre, elTopGenreNote,
                elTopDirector, elTopDirectorNote,
                elTopActor, elTopActorNote,
                elTopDecade, elTopDecadeNote,
                elTopMovie, elTopMovieNote,
                elTopMpa, elTopMpaNote,
            ];
            if (required.some(x => !x)) return;

            // Require auth for dashboard.
            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            const setAll = (v) => {
                elEventsTotal.textContent = v;
                elEventsUnique.textContent = v;
                elEventsNote.textContent = v;
                elHours.textContent = v;
                elHoursUnique.textContent = v;
                elHoursNote.textContent = v;
                elAtHome.textContent = v;
                elInTheater.textContent = v;
                elAtHomeUnique.textContent = v;
                elInTheaterUnique.textContent = v;
                elTopGenre.textContent = v;
                elTopDirector.textContent = v;
                elTopActor.textContent = v;
                elTopDecade.textContent = v;
                elTopMovie.textContent = v;
                elTopMpa.textContent = v;
            };

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                setAll('—');
                elEventsNote.innerHTML = '&nbsp;';
                elHoursNote.innerHTML = '&nbsp;';
                elTopGenreNote.innerHTML = '&nbsp;';
                elTopDirectorNote.innerHTML = '&nbsp;';
                elTopActorNote.innerHTML = '&nbsp;';
                elTopDecadeNote.innerHTML = '&nbsp;';
                elTopMovieNote.innerHTML = '&nbsp;';
                elTopMpaNote.innerHTML = '&nbsp;';
                return;
            }

            setAll('…');
            elEventsNote.textContent = '…';
            elHoursNote.textContent = '…';
            elTopGenreNote.textContent = '…';
            elTopDirectorNote.textContent = '…';
            elTopActorNote.textContent = '…';
            elTopDecadeNote.textContent = '…';
            elTopMovieNote.textContent = '…';
            elTopMpaNote.textContent = '…';

            try {
                let res = await supabaseClient.rpc('get_dashboard_general', { p_timeframe: dashboardTimeframe });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const looksLikeOldSignature = /get_dashboard_general/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (looksLikeOldSignature) res = await supabaseClient.rpc('get_dashboard_general');
                }
                if (res?.error) throw res.error;
                const data = res?.data;

                const watchEvents = data?.watch_events || {};
                const totalWatches = Number(watchEvents?.watches ?? 0);
                const uniqueMovies = Number(watchEvents?.movies ?? 0);

                const totalHours = Number(data?.hours_watched ?? 0);
                const uniqueHours = Number(data?.hours_watched_unique ?? 0);

                const method = data?.watch_method_breakdown || {};
                const atHomeObj = method?.at_home || {};
                const inTheaterObj = method?.in_theater || {};

                const atHome = Number(atHomeObj?.watches ?? 0);
                const atHomeUnique = Number(atHomeObj?.movies ?? 0);
                const inTheater = Number(inTheaterObj?.watches ?? 0);
                const inTheaterUnique = Number(inTheaterObj?.movies ?? 0);

                const topGenre = data?.most_watched_genre || {};
                const topDirector = data?.most_watched_director || {};
                const topActor = data?.most_watched_actor || {};
                const topDecade = data?.most_watched_decade || {};

                const fmtAcross = (watches, movies) => {
                    const w = Number(watches ?? 0);
                    const m = Number(movies ?? 0);
                    const wTxt = Number.isFinite(w) ? w : 0;
                    const mTxt = Number.isFinite(m) ? m : 0;
                    const wLabel = (wTxt === 1) ? 'watch event' : 'watch events';
                    const mLabel = (mTxt === 1) ? 'unique movie' : 'unique movies';
                    return `${wTxt} ${wLabel} across ${mTxt} ${mLabel}`;
                };

                elEventsTotal.textContent = Number.isFinite(totalWatches) ? String(totalWatches) : '0';
                elEventsUnique.textContent = Number.isFinite(uniqueMovies) ? String(uniqueMovies) : '0';
                elEventsNote.textContent = fmtAcross(totalWatches, uniqueMovies);

                elHours.textContent = Number.isFinite(totalHours) ? String(totalHours) : '0';
                elHoursUnique.textContent = Number.isFinite(uniqueHours) ? String(uniqueHours) : '0';
                elHoursNote.textContent = fmtAcross(totalWatches, uniqueMovies);

                elAtHome.textContent = Number.isFinite(atHome) ? String(atHome) : '0';
                elInTheater.textContent = Number.isFinite(inTheater) ? String(inTheater) : '0';
                elAtHomeUnique.textContent = Number.isFinite(atHomeUnique) ? String(atHomeUnique) : '0';
                elInTheaterUnique.textContent = Number.isFinite(inTheaterUnique) ? String(inTheaterUnique) : '0';

                const genreName = String(topGenre?.name ?? '').trim();
                elTopGenre.textContent = genreName || '—';
                elTopGenreNote.textContent = fmtAcross(topGenre?.watches, topGenre?.movies);

                const directorName = String(topDirector?.name ?? '').trim();
                elTopDirector.textContent = directorName || '—';
                elTopDirectorNote.textContent = fmtAcross(topDirector?.watches, topDirector?.movies);

                const actorName = String(topActor?.name ?? '').trim();
                elTopActor.textContent = actorName || '—';
                elTopActorNote.textContent = fmtAcross(topActor?.watches, topActor?.movies);

                const decade = topDecade?.decade;
                const decadeLabel = (decade === null || decade === undefined) ? '' : `${String(decade)}s`;
                elTopDecade.textContent = decadeLabel || '—';
                elTopDecadeNote.textContent = fmtAcross(topDecade?.watches, topDecade?.movies);

                const topMovie = data?.most_watched_movie || {};
                const topMovieTitle = String(topMovie?.title ?? '').trim();
                const topMovieYear = topMovie?.release_year;
                const topMovieWatches = Number(topMovie?.watches ?? 0);
                elTopMovie.textContent = topMovieTitle ? `${topMovieTitle}${(topMovieYear === null || topMovieYear === undefined || String(topMovieYear).trim() === '') ? '' : ` (${String(topMovieYear)})`}` : '—';
                elTopMovieNote.textContent = fmtAcross(topMovieWatches, topMovieTitle ? 1 : 0);

                const topMpa = data?.most_watched_mpa || {};
                const topMpaRating = String(topMpa?.rating ?? '').trim();
                elTopMpa.textContent = topMpaRating || '—';
                elTopMpaNote.textContent = fmtAcross(topMpa?.watches, topMpa?.movies);
            } catch (err) {
                showToast(`Dashboard (General) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard general load failed', err);
                try {
                    const details = {
                        message: err?.message,
                        code: err?.code,
                        details: err?.details,
                        hint: err?.hint,
                    };
                    addMessageToLog('error', 'Dashboard (General) error details', JSON.stringify(details));
                } catch (_) {}
                setAll('—');
                elEventsNote.innerHTML = '&nbsp;';
                elHoursNote.innerHTML = '&nbsp;';
                elTopGenreNote.innerHTML = '&nbsp;';
                elTopDirectorNote.innerHTML = '&nbsp;';
                elTopActorNote.innerHTML = '&nbsp;';
                elTopDecadeNote.innerHTML = '&nbsp;';
                elTopMovieNote.innerHTML = '&nbsp;';
                elTopMpaNote.innerHTML = '&nbsp;';
            }
        }

        async function callSwiftApiSearchMovies({ query, page = 1, signal }) {
            try {
                return await callSwiftApiPublic({ action: 'search', query, page }, { signal });
            } catch (err) {
                throw new Error(`Search failed: ${String(err?.message || err)}`);
            }
        }

        async function callSwiftApiGetMovieDetails({ tmdb_id, signal }) {
            try {
                return await callSwiftApiPublic({ action: 'details', tmdb_id }, { signal });
            } catch (err) {
                throw new Error(`Details failed: ${String(err?.message || err)}`);
            }
        }

        async function callSwiftApiGetTrendingMovies({ time_window = 'day', limit = 10, signal } = {}) {
            try {
                return await callSwiftApiPublic({ action: 'trending', time_window, limit }, { signal });
            } catch (err) {
                throw new Error(`Trending failed: ${String(err?.message || err)}`);
            }
        }

        function renderTrendingNow(items) {
            const safeItems = Array.isArray(items) ? items : [];
            const cardsHTML = safeItems.map((m) => {
                const title = String(m?.title || '').trim();
                const genre = String(m?.genre || '').trim();
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w342${posterPath}` : '';
                if (!posterUrl) return '';

                return `
                    <div class="trending-card">
                        <img src="${posterUrl}" alt="${escapeHtml(title)}" onerror="this.closest('.trending-card')?.remove?.()">
                        <div class="movie-overlay">
                            ${genre ? `<span class=\"text-xs text-brand font-bold uppercase mb-1\">${escapeHtml(genre)}</span>` : ''}
                            <h4 class="text-white font-bold text-sm">${escapeHtml(title)}</h4>
                        </div>
                    </div>
                `;
            }).join('');

            const track1 = document.getElementById('trending-track-1');
            const track2 = document.getElementById('trending-track-2');
            if (track1) track1.innerHTML = cardsHTML;
            if (track2) track2.innerHTML = cardsHTML;
        }

        async function loadTrendingNow() {
            const track1 = document.getElementById('trending-track-1');
            const track2 = document.getElementById('trending-track-2');
            if (!track1 || !track2) return;

            // Cancel any in-flight trending request (e.g., navigating home repeatedly).
            try { homeTrendingAbortController?.abort?.(); } catch (_) {}
            homeTrendingAbortController = new AbortController();

            // Lightweight loading state (no hardcoded movies/posters).
            track1.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">Loading trending…</div>`;
            track2.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">Loading trending…</div>`;

            try {
                const data = await callSwiftApiGetTrendingMovies({ time_window: 'day', limit: 10, signal: homeTrendingAbortController.signal });
                const items = Array.isArray(data?.results) ? data.results : [];
                homeTrendingItems = items;
                renderTrendingNow(items);
            } catch (err) {
                if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                // Quiet failure: keep marquee area but show a small message.
                const msg = `Trending unavailable`;
                track1.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">${escapeHtml(msg)}</div>`;
                track2.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">${escapeHtml(msg)}</div>`;
            }
        }

        function renderHomeSearchResults(items) {
            const results = document.getElementById('search-results');
            if (!results) return;

            // Keep the dropdown lightweight.
            homeSearchItems = Array.isArray(items) ? items.slice(0, 4) : [];

            if (homeSearchItems.length === 0) {
                results.innerHTML = `<div class="search-item text-gray justify-center">No movies found</div>`;
                results.classList.remove('hidden');
                return;
            }

            results.innerHTML = homeSearchItems.map((m, idx) => {
                const title = String(m?.title || '').trim();
                const year = m?.year ? String(m.year) : '';
                const genres = Array.isArray(m?.genres)
                    ? m.genres.map(s => String(s).trim()).filter(Boolean)
                    : String(m?.genre || '').split(',').map(s => s.trim()).filter(Boolean);
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w154${posterPath}` : '';

                // Dropdown preview: do not show director (only fetched on details after selection).
                const metaParts = [
                    year,
                    (genres.length ? genres.join(', ') : ''),
                ].filter(Boolean);

                return `
                    <div class="search-item" data-idx="${idx}">
                        <div style="display:flex; align-items:center; gap: 0.75rem;">
                            <div style="width: 34px; height: 51px; flex: 0 0 34px; border-radius: 7px; overflow:hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center;">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.style.display='none'; this.parentElement.style.opacity='0.6';">`
                                    : `<div style="opacity:0.65; color: var(--text-muted); width: 16px; height: 16px; display:flex; align-items:center; justify-content:center;">${icons.film}</div>`
                                }
                            </div>
                            <div>
                                <div class="text-white font-semibold">${escapeHtml(title)}</div>
                                <div class="text-xs text-gray">${escapeHtml(metaParts.join(' • '))}</div>
                            </div>
                        </div>
                        <div style="color:var(--text-muted);">${icons.arrowRightCircle}</div>
                    </div>
                `;
            }).join('');
            results.classList.remove('hidden');

            if (!results.dataset.boundClicks) {
                results.dataset.boundClicks = 'true';
                results.addEventListener('click', (e) => {
                    const row = e?.target?.closest ? e.target.closest('.search-item[data-idx]') : null;
                    if (!row) return;
                    const idx = Number(row.getAttribute('data-idx'));
                    const picked = Number.isFinite(idx) ? homeSearchItems[idx] : null;
                    if (!picked) return;
                    router.selectMovie(picked);
                });
            }
        }

        function setHomeActionsVisible(isVisible) {
            const actions = document.getElementById('movie-actions');
            if (!actions) return;
            const placeholder = document.getElementById('home-action-placeholder');
            if (placeholder) {
                placeholder.style.display = isVisible ? 'none' : 'block';
            }
            if (isVisible) {
                actions.classList.remove('hidden');
                actions.classList.add('flex');
            } else {
                actions.classList.add('hidden');
                actions.classList.remove('flex');
            }
        }

        function setUpdateOptionsHidden() {
            const updateBtn = document.getElementById('update-existing-btn');
            const updateOpts = document.getElementById('update-options');
            if (updateOpts) {
                updateOpts.classList.add('hidden');
                updateOpts.classList.remove('grid');
            }
            if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.style.opacity = '0.5';
                updateBtn.style.pointerEvents = 'none';
            }
        }

        function setHomeSearchLoading() {
            const results = document.getElementById('search-results');
            if (!results) return;
            results.innerHTML = `
                <div class="search-item text-gray justify-center" style="gap:0.5rem;">
                    <span class="icon-sm">${icons.loader}</span>
                    Searching…
                </div>
            `;
            results.classList.remove('hidden');
        }

        function clearHomeSearchUI() {
            const results = document.getElementById('search-results');
            if (results) results.classList.add('hidden');
            setHomeActionsVisible(false);
            setUpdateOptionsHidden();
            router.selectedMovie = null;
            router.pendingTitle = '';
            homeSearchItems = [];
        }

        function escapeHtml(s) {
            return String(s ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function handleSearch(query) {
            const results = document.getElementById('search-results');

            const q = String(query || '').trim();
            if (!results || !q || q.length < 1) {
                if (homeSearchDebounceTimer) clearTimeout(homeSearchDebounceTimer);
                if (homeSearchAbortController) homeSearchAbortController.abort();
                clearHomeSearchUI();
                return;
            }

            router.selectedMovie = null;
            router.pendingTitle = q;
            setHomeActionsVisible(false);
            setUpdateOptionsHidden();

            // Debounce + cancel in-flight request
            if (homeSearchDebounceTimer) clearTimeout(homeSearchDebounceTimer);
            if (homeSearchAbortController) homeSearchAbortController.abort();
            homeSearchAbortController = new AbortController();

            // Keep dropdown behavior similar: show results panel quickly, but avoid hammering the server.
            // Do not search until the user types at least 3 characters.
            if (q.length < 3) {
                results.classList.add('hidden');
                homeSearchItems = [];
                return;
            }

            homeSearchDebounceTimer = setTimeout(async () => {
                try {
                    setHomeSearchLoading();

                    const data = await callSwiftApiSearchMovies({
                        query: q,
                        page: 1,
                        signal: homeSearchAbortController.signal,
                    });

                    const items = Array.isArray(data?.results) ? data.results : [];
                    renderHomeSearchResults(items);

                    // If nothing found, do not allow manual entry.
                    if (!items || items.length === 0) {
                        setHomeActionsVisible(false);
                        setUpdateOptionsHidden();
                    }
                } catch (err) {
                    // Ignore aborts
                    if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                    if (String(err?.message || '').toLowerCase().includes('aborted')) return;

                    showToast(`Search failed: ${String(err?.message || err)}`, { level: 'warn' });
                    results.innerHTML = `<div class="search-item text-gray justify-center">Search unavailable — please try again</div>`;
                    results.classList.remove('hidden');
                    setHomeActionsVisible(false);
                    setUpdateOptionsHidden();
                }
            }, 320);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('open');
        }

        function initializeWatchMethodToggle() {
            const btn = document.getElementById('watchmethod-toggle');
            if (!btn) return;
            const hidden = document.getElementById('fld-watchmethod');
            const isTheater = btn.textContent.trim().toLowerCase().includes('theater');
            if (hidden) hidden.value = isTheater ? 'In Theater' : 'At Home';
            if (isTheater) {
                btn.style.backgroundColor = 'rgba(20, 184, 166, 0.35)';
                btn.style.borderColor = 'rgba(20, 184, 166, 0.5)';
            } else {
                btn.style.backgroundColor = 'rgba(168, 85, 247, 0.35)';
                btn.style.borderColor = 'rgba(168, 85, 247, 0.5)';
            }
        }

        function normalizeSeriesValue(seriesText) {
            const s = String(seriesText || '').trim().toLowerCase();
            if (!s) return '';
            if (s === 'yes' || s === 'true' || s === '1') return 'TRUE';
            if (s === 'no' || s === 'false' || s === '0') return 'FALSE';
            return seriesText;
        }

        function parseGenreString(value) {
            return String(value || '')
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);
        }

        function setGenreSelection(selectedGenres) {
            const hidden = document.getElementById('fld-genre');
            if (!hidden) return;
            const unique = Array.from(new Set((selectedGenres || []).map(s => String(s).trim()).filter(Boolean)));
            hidden.value = unique.join(', ');

            const wrap = document.getElementById('genre-chip-wrap');
            if (!wrap) return;

            wrap.querySelectorAll('button[data-genre]').forEach((btn) => {
                const g = btn.getAttribute('data-genre');
                const isOn = unique.includes(g);
                btn.classList.toggle('selected', isOn);
                btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
            });
        }

        function toggleGenreChip(btnEl) {
            if (!btnEl) return;
            const hidden = document.getElementById('fld-genre');
            if (!hidden) return;

            const genre = btnEl.getAttribute('data-genre');
            if (!genre) return;

            const current = parseGenreString(hidden.value);
            const isSelected = current.includes(genre);

            if (isSelected) {
                setGenreSelection(current.filter(g => g !== genre));
                return;
            }

            setGenreSelection([...current, genre]);
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `${icons.loader} Saving...`;
            btn.disabled = true;
            btn.style.opacity = 0.7;

            try {
                if (!supabaseClient) {
                    throw new Error('Supabase SDK failed to load. Check the Supabase <script> include and your network.');
                }
                const { user: authedUser, accessToken } = await requireAuthOrThrow();
                const entryType = String(e.target.querySelector('input[name="entryType"]')?.value || '').trim().toLowerCase();

                const toNumberOrNull = (v) => {
                    const n = Number(v);
                    return Number.isFinite(n) ? n : null;
                };

                const uuidLike = isUuidLike;

                const parseRuntimeMinutes = (raw) => {
                    const s = String(raw || '').trim();
                    if (!s) return null;
                    // Preferred: minutes (e.g., 136)
                    if (!s.includes(':')) {
                        const minutes = Number(s.replace(/\D/g, ''));
                        return Number.isFinite(minutes) ? minutes : null;
                    }
                    // Back-compat: accept HH:MM if someone types it.
                    const [hRaw, mRaw] = s.split(':');
                    const h = Number(String(hRaw || '').replace(/\D/g, ''));
                    const m = Number(String(mRaw || '').replace(/\D/g, ''));
                    if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
                    return h * 60 + m;
                };
                const selectedId = window.router?.selectedMovie?.id;
                const hiddenMovieId = String(document.getElementById('fld-movie-id')?.value || '').trim();
                const hiddenTmdbId = String(document.getElementById('fld-tmdb-id')?.value || '').trim();

                let movie_id = uuidLike(hiddenMovieId)
                    ? hiddenMovieId
                    : (uuidLike(selectedId) ? selectedId : null);

                const movieIdWasSelected = Boolean(movie_id);

                // Updates must target an existing (user,movie) rating row.
                // Do not attempt any title-based resolution/upsert for updates.
                if (entryType === 'update' && !movie_id) {
                    // Last chance: if we have a tmdb_id from the form, map it to a DB UUID.
                    if (hiddenTmdbId) {
                        try {
                            const mapped = await getDbMovieIdByTmdbId(Number(hiddenTmdbId));
                            if (uuidLike(mapped)) movie_id = mapped;
                        } catch (_) {}
                    }

                    if (!movie_id) {
                        throw new Error('To update ratings, open the form via “Update Ratings” for a movie already in your diary.');
                    }
                }

                const shouldSyncPeople = entryType === 'new';

                if (!movie_id) {
                    const title = String(document.getElementById('fld-title')?.value || '').trim();
                    const release_year = toNumberOrNull(document.getElementById('fld-year')?.value);

                    if (!title) throw new Error('Title is required.');

                    // TMDb lookup + Movies upsert happens server-side in an Edge Function.
                    // This avoids exposing a TMDb key in the browser and allows Movies to remain read-only under RLS.
                    const tmdbData = await callSwiftApi(
                        { title, release_year: release_year ?? null, sync_people: shouldSyncPeople },
                        accessToken
                    );

                    movie_id = tmdbData?.movie_id || null;

                    // People sync should never block saving the rating.
                    if (tmdbData?.people_sync && tmdbData.people_sync.ok === false) {
                        const msg = tmdbData.people_sync.details
                            ? `${tmdbData.people_sync.message} (${tmdbData.people_sync.details})`
                            : `${tmdbData.people_sync.message}`;
                        showToast(`Cast sync warning: ${msg}`);

                        // Debug: dump Movie Crew preview rows into the Message Log
                        try {
                            const crew = tmdbData?.people_sync?.crew_sync;
                            const preview = Array.isArray(crew?.preview) ? crew.preview : [];
                            if (preview.length > 0) {
                                const lines = preview.map((r) =>
                                    `movie_id=${r.movie_id} person_id=${r.person_id} name=${r.name} job=${r.job}`
                                );
                                showToast(`Movie Crew preview (${preview.length} rows):\n${lines.join('\n')}`, { level: 'warn', durationMs: 15000 });
                            }
                            const dups = Array.isArray(crew?.duplicates_by_person) ? crew.duplicates_by_person : [];
                            if (dups.length > 0) {
                                const lines = dups.map((d) => `person_id=${d.person_id} count=${d.count}`);
                                showToast(`Movie Crew potential duplicates by person_id:\n${lines.join('\n')}`, { level: 'warn', durationMs: 15000 });
                            }
                        } catch (_) {}
                    }
                }

                // If the movie already exists/was selected, still sync People when logging a New Entry.
                // Avoid calling twice when we just created/resolved the movie via title lookup.
                if (movieIdWasSelected && movie_id && shouldSyncPeople && uuidLike(movie_id)) {
                    try {
                        const peopleRes = await callSwiftApi({ movie_id, sync_people: true }, accessToken);
                        if (peopleRes?.people_sync && peopleRes.people_sync.ok === false) {
                            const msg = peopleRes.people_sync.details
                                ? `${peopleRes.people_sync.message} (${peopleRes.people_sync.details})`
                                : `${peopleRes.people_sync.message}`;
                            showToast(`Cast sync warning: ${msg}`);

                            // Debug: dump Movie Crew preview rows into the Message Log
                            try {
                                const crew = peopleRes?.people_sync?.crew_sync;
                                const preview = Array.isArray(crew?.preview) ? crew.preview : [];
                                if (preview.length > 0) {
                                    const lines = preview.map((r) =>
                                        `movie_id=${r.movie_id} person_id=${r.person_id} name=${r.name} job=${r.job}`
                                    );
                                    showToast(`Movie Crew preview (${preview.length} rows):\n${lines.join('\n')}`, { level: 'warn', durationMs: 15000 });
                                }
                                const dups = Array.isArray(crew?.duplicates_by_person) ? crew.duplicates_by_person : [];
                                if (dups.length > 0) {
                                    const lines = dups.map((d) => `person_id=${d.person_id} count=${d.count}`);
                                    showToast(`Movie Crew potential duplicates by person_id:\n${lines.join('\n')}`, { level: 'warn', durationMs: 15000 });
                                }
                            } catch (_) {}
                        }
                    } catch (e) {
                        showToast(`Cast sync warning: ${String(e?.message || e)}`);
                    }
                }

                if (!movie_id) throw new Error('Failed to determine movie_id.');

                // Ensure external ratings are synced server-side on every save/update.
                // ("Movie External Ratings" has no user_id; it should be written from the Edge Function.)
                try {
                    const syncRes = await callSwiftApi({ movie_id, sync_people: false }, accessToken);
                    const imdbPct = syncRes?.imdb_rating_pct;
                    if (imdbPct !== null && imdbPct !== undefined) {
                        const imdbEl = document.getElementById('fld-imdb');
                        if (imdbEl && !String(imdbEl.value || '').trim()) {
                            imdbEl.value = String(imdbPct);
                        }

                        const imdbPctNum = Number(imdbPct);
                        if (Number.isFinite(imdbPctNum) && imdbPctNum > 0) {
                            try {
                                imdbEl?.setAttribute('readonly', '');
                                imdbEl?.classList?.add('input-readonly');
                                document.getElementById('fld-imdb-range')?.setAttribute('disabled', '');
                            } catch (_) {}
                        }
                    }

                    const ext = syncRes?.external_ratings?.imdb;
                    if (ext && ext.ok === false && ext.error) {
                        showToast(`IMDb sync warning: ${String(ext.error)}`, { level: 'warn' });
                    }
                } catch (e) {
                    showToast(`IMDb sync warning: ${String(e?.message || e)}`, { level: 'warn' });
                }

                const tier = String(document.getElementById('fld-tier')?.value || '').trim() || null;
                const overall_rating = toNumberOrNull(document.getElementById('num-overall')?.value);
                const acting_rating = toNumberOrNull(document.getElementById('num-acting')?.value);
                const pacing_rating = toNumberOrNull(document.getElementById('num-pace')?.value);
                const sound_rating = toNumberOrNull(document.getElementById('num-sound')?.value);
                const imagery_rating = toNumberOrNull(document.getElementById('num-imagery')?.value);
                const plot_rating = toNumberOrNull(document.getElementById('num-plot')?.value);
                const dialogue_rating = toNumberOrNull(document.getElementById('num-dialogue')?.value);
                const notes = String(document.getElementById('fld-notes')?.value || '').trim() || null;
                const fav_quote = String(document.getElementById('fld-quote')?.value || '').trim() || null;
                const watch_method = String(document.getElementById('fld-watchmethod')?.value || '').trim() || null;
                const watch_date_from_form = String(document.getElementById('fld-datewatch')?.value || '').trim();
                const times_watched_raw = toNumberOrNull(document.getElementById('fld-timeswatch')?.value);
                const times_watched = Number.isFinite(times_watched_raw)
                    ? Math.max(1, Math.floor(Number(times_watched_raw)))
                    : 1;

                if (!watch_date_from_form) {
                    throw new Error('Date Watched is required.');
                }

                if (!Number.isFinite(times_watched) || times_watched < 1) {
                    throw new Error('Times Watched must be at least 1.');
                }

                const insertRow = {
                    user_id: authedUser.id,
                    movie_id,
                    [COL_WATCH_DATE]: watch_date_from_form,
                    tier,
                    overall_rating,
                    acting_rating,
                    pacing_rating,
                    sound_rating,
                    imagery_rating,
                    plot_rating,
                    dialogue_rating,
                    notes,
                    fav_quote
                };

                if (entryType === 'update') {
                    const choice = await promptUpdateWatchChoice();
                    if (!choice) {
                        showToast('Update canceled.', { level: 'warn' });
                        return;
                    }
                    const shouldAddWatch = choice === 'update_and_watch';

                    let watchChoice = null;
                    if (shouldAddWatch) {
                        watchChoice = await promptWatchMethodChoice();
                        if (!watchChoice) {
                            showToast('Update canceled.', { level: 'warn' });
                            return;
                        }
                    }

                    const updateRow = {
                        tier,
                        overall_rating,
                        acting_rating,
                        pacing_rating,
                        sound_rating,
                        imagery_rating,
                        plot_rating,
                        dialogue_rating,
                        notes,
                        fav_quote,
                        updated_at: new Date().toISOString(),
                    };

                    const { error: updateError } = await supabaseClient
                        .from('Movie Ratings')
                        .update(updateRow)
                        .eq('user_id', authedUser.id)
                        .eq('movie_id', movie_id);

                    if (updateError) throw updateError;

                    if (shouldAddWatch) {
                        await insertWatchLog({
                            user_id: authedUser.id,
                            movie_id,
                            watch_method: watchChoice.watch_method,
                            watch_date: watchChoice.watch_date,
                        });
                    }

                    showToast(shouldAddWatch ? 'Entry updated (+1 watch added)!' : 'Entry updated successfully!');
                    return;
                }

                const { error: insertError } = await supabaseClient
                    .from('Movie Ratings')
                    .insert(insertRow);

                if (insertError) throw insertError;

                // Only create a Watch Logs row for "Log as New Entry" once per (user,movie),
                // and only after the Movie Ratings insert succeeds.
                if (entryType === 'new') {
                    await insertWatchLogIfMissing({
                        user_id: authedUser.id,
                        movie_id,
                        watch_method,
                        watch_date: watch_date_from_form,
                    });
                }

                {
                    const savedTitle = String(router?.selectedMovie?.title || '').trim();
                    showToast(savedTitle ? `${savedTitle} entry saved successfully` : 'Entry saved successfully!');
                }

                // If user says they've watched this movie multiple times, collect the prior watches now.
                // We treat the current save as 1 watch, and ask for the previous (times_watched - 1) entries.
                if (entryType === 'new' && times_watched > 1) {
                    const priorCount = times_watched - 1;
                    const prior = await promptPriorWatches(priorCount);
                    if (prior && Array.isArray(prior.entries) && prior.entries.length > 0) {
                        await insertWatchLogsBulk({
                            user_id: authedUser.id,
                            movie_id,
                            entries: prior.entries,
                        });
                        showToast(`Added ${prior.entries.length} previous watch${prior.entries.length === 1 ? '' : 'es'}!`);
                    } else if (prior?.skipped) {
                        showToast('Skipped adding previous watches.', { level: 'warn' });
                    }
                }
                return;
            } catch (err) {
                showToast(`Save failed: ${String(err.message || err)}`);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        }

        let updateWatchChoiceResolver = null;
        let watchMethodChoiceResolver = null;
        let watchMethodPendingSelection = null;
        let priorWatchesChoiceResolver = null;
        let priorWatchesPendingCount = 0;

        function openUpdateWatchModal() {
            const overlay = document.getElementById('update-watch-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function closeUpdateWatchModal(choice) {
            const overlay = document.getElementById('update-watch-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }

            try {
                if (typeof updateWatchChoiceResolver === 'function') {
                    const resolve = updateWatchChoiceResolver;
                    updateWatchChoiceResolver = null;
                    resolve(choice);
                }
            } catch (_) {
                updateWatchChoiceResolver = null;
            }
        }

        function promptUpdateWatchChoice() {
            // Returns: 'update_only' | 'update_and_watch' | null
            return new Promise((resolve) => {
                updateWatchChoiceResolver = resolve;
                openUpdateWatchModal();
            });
        }

        function openWatchMethodModal() {
            const overlay = document.getElementById('watch-method-overlay');
            if (!overlay) return;
            const dateEl = document.getElementById('watch-method-date');
            if (dateEl) {
                dateEl.value = new Date().toISOString().split('T')[0];
            }

            // Reset selection every time to prevent accidental saves.
            watchMethodPendingSelection = null;
            try {
                const saveBtn = document.getElementById('watch-method-save');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.setAttribute('aria-disabled', 'true');
                }
                overlay.querySelectorAll('[data-watch-method-option="true"]').forEach((btn) => {
                    btn.classList.remove('selected');
                    btn.setAttribute('aria-pressed', 'false');
                });
            } catch (_) {}

            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function selectWatchMethodModal(method) {
            watchMethodPendingSelection = String(method || '').trim() || null;
            const overlay = document.getElementById('watch-method-overlay');
            if (!overlay) return;

            try {
                overlay.querySelectorAll('[data-watch-method-option="true"]').forEach((btn) => {
                    const isSelected = String(btn.textContent || '').trim() === watchMethodPendingSelection;
                    btn.classList.toggle('selected', isSelected);
                    btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                });
                const saveBtn = document.getElementById('watch-method-save');
                if (saveBtn) {
                    saveBtn.disabled = !watchMethodPendingSelection;
                    saveBtn.setAttribute('aria-disabled', (!watchMethodPendingSelection).toString());
                }
            } catch (_) {}
        }

        function submitWatchMethodModal() {
            if (!watchMethodPendingSelection) {
                showToast('Select At Home or In Theater, then tap Save.', { level: 'warn' });
                return;
            }

            const dateEl = document.getElementById('watch-method-date');
            const watch_date = String(dateEl?.value || '').trim();
            if (!watch_date) {
                showToast('Please select a watch date.', { level: 'warn' });
                try { dateEl?.focus?.(); } catch (_) {}
                return;
            }

            closeWatchMethodModal({
                watch_method: watchMethodPendingSelection,
                watch_date,
            });
        }

        function closeWatchMethodModal(choice) {
            const overlay = document.getElementById('watch-method-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }

            try {
                if (typeof watchMethodChoiceResolver === 'function') {
                    const resolve = watchMethodChoiceResolver;
                    watchMethodChoiceResolver = null;
                    resolve(choice);
                }
            } catch (_) {
                watchMethodChoiceResolver = null;
            }
        }

        function promptWatchMethodChoice() {
            // Returns: { watch_method: 'At Home' | 'In Theater', watch_date: 'YYYY-MM-DD' } | null
            return new Promise((resolve) => {
                watchMethodChoiceResolver = resolve;
                openWatchMethodModal();
            });
        }

        function openPriorWatchesModal(count) {
            priorWatchesPendingCount = Math.max(0, Math.floor(Number(count || 0)));
            const overlay = document.getElementById('prior-watches-overlay');
            const msg = document.getElementById('prior-watches-message');
            const fields = document.getElementById('prior-watches-fields');
            if (!overlay || !fields) return;

            if (msg) {
                msg.textContent = `It looks like you've seen this movie multiple times; please tell us about the first ${priorWatchesPendingCount} time${priorWatchesPendingCount === 1 ? '' : 's'} you've seen this movie.`;
            }

            const today = new Date().toISOString().split('T')[0];
            fields.innerHTML = Array.from({ length: priorWatchesPendingCount }).map((_, i) => {
                const n = i + 1;
                return `
                    <div style="border: 1px solid rgba(255,255,255,0.08); border-radius: 0.75rem; padding: 0.85rem; background: rgba(255,255,255,0.03);">
                        <div class="text-sm text-white font-semibold" style="margin-bottom: 0.5rem;">Previous viewing #${n}</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label class="text-xs text-gray" style="display:block; margin-bottom: 0.35rem;">Date</label>
                                <input id="prior-watch-date-${n}" type="date" class="input-field" max="${today}" required>
                            </div>
                            <div>
                                <label class="text-xs text-gray" style="display:block; margin-bottom: 0.35rem;">Watch Method</label>
                                <select id="prior-watch-method-${n}" class="input-field">
                                    <option value="At Home">At Home</option>
                                    <option value="In Theater">In Theater</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function closePriorWatchesModal(result) {
            const overlay = document.getElementById('prior-watches-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }

            try {
                if (typeof priorWatchesChoiceResolver === 'function') {
                    const resolve = priorWatchesChoiceResolver;
                    priorWatchesChoiceResolver = null;
                    resolve(result);
                }
            } catch (_) {
                priorWatchesChoiceResolver = null;
            }
        }

        function submitPriorWatchesModal() {
            const entries = [];
            for (let i = 1; i <= priorWatchesPendingCount; i++) {
                const dateEl = document.getElementById(`prior-watch-date-${i}`);
                const methodEl = document.getElementById(`prior-watch-method-${i}`);
                const watch_date = String(dateEl?.value || '').trim();
                const watch_method = String(methodEl?.value || '').trim() || null;
                if (!watch_date) {
                    showToast(`Please select a date for previous viewing #${i}.`, { level: 'warn' });
                    try { dateEl?.focus?.(); } catch (_) {}
                    return;
                }
                entries.push({ watch_date, watch_method });
            }

            closePriorWatchesModal({ entries });
        }

        function promptPriorWatches(count) {
            // Returns: { entries: Array<{watch_date, watch_method}> } | { skipped: true } | null
            return new Promise((resolve) => {
                priorWatchesChoiceResolver = resolve;
                openPriorWatchesModal(count);
            });
        }

        function setTierFromButton(btn) {
            try {
                const group = btn?.closest?.('.tier-btn-group');
                if (!group) return;
                const tier = String(btn.getAttribute('data-tier') || '').trim();
                const targetInputId = String(group.getAttribute('data-target-input') || '').trim();
                const input = targetInputId ? document.getElementById(targetInputId) : null;
                if (input) input.value = tier;

                group.querySelectorAll('.tier-btn').forEach((b) => {
                    const isSelected = b === btn;
                    b.classList.toggle('selected', isSelected);
                    b.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                });

                group.setAttribute('data-has-selection', tier ? 'true' : 'false');
            } catch (_) {}
        }

        function showLoadingOverlay(message) {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            if (message) {
                try {
                    const msgEl = overlay.querySelector('.text-sm span:last-child');
                    if (msgEl) msgEl.textContent = String(message);
                } catch (_) {}
            }
            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
            overlay.style.display = 'none';
        }

        function toggleWatchMethod(btn) {
            try {
                if (btn?.disabled) return;
            } catch (_) {}
            const isTheater = btn.textContent.trim().toLowerCase().includes('theater');
            const hidden = document.getElementById('fld-watchmethod');
            if (isTheater) {
                btn.textContent = 'At Home';
                if (hidden) hidden.value = 'At Home';
                btn.style.backgroundColor = 'rgba(168, 85, 247, 0.35)';
                btn.style.borderColor = 'rgba(168, 85, 247, 0.5)';
            } else {
                btn.textContent = 'In Theater';
                if (hidden) hidden.value = 'In Theater';
                btn.style.backgroundColor = 'rgba(20, 184, 166, 0.35)';
                btn.style.borderColor = 'rgba(20, 184, 166, 0.5)';
            }
        }

        async function requireAuthOrThrow() {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const { data, error } = await supabaseClient.auth.getSession();
            if (error) throw error;
            let session = data?.session || null;
            let user = session?.user || null;
            let accessToken = session?.access_token || null;
            if (!user?.id || !accessToken) throw new Error('Please log in first.');

            // Validate the token with Supabase Auth. If invalid/expired, try a refresh.
            const { data: userData, error: userErr } = await supabaseClient.auth.getUser();
            if (userErr || !userData?.user?.id) {
                const { data: refreshed, error: refreshErr } = await supabaseClient.auth.refreshSession();
                if (refreshErr) {
                    throw new Error('Session invalid. Click Log out, then Log in again.');
                }
                session = refreshed?.session || null;
                user = session?.user || null;
                accessToken = session?.access_token || null;
                if (!user?.id || !accessToken) {
                    throw new Error('Session invalid. Click Log out, then Log in again.');
                }

                const { data: userData2, error: userErr2 } = await supabaseClient.auth.getUser();
                if (userErr2 || !userData2?.user?.id) {
                    throw new Error('Invalid JWT. Click Log out, then Log in again.');
                }
            }

            return { user, accessToken };
        }

        async function insertWatchLog({ user_id, movie_id, watch_method = null, watch_date }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');
            const wd = String(watch_date || '').trim();
            if (!wd) throw new Error('Missing watch_date.');

            const row = {
                user_id,
                movie_id,
                watch_method,
                [COL_WATCH_DATE]: wd,
            };

            const { error } = await supabaseClient
                .from('Watch Logs')
                .insert(row);

            if (error) throw error;
        }

        async function insertWatchLogIfMissing({ user_id, movie_id, watch_method = null, watch_date }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');
            const wd = String(watch_date || '').trim();
            if (!wd) throw new Error('Missing watch_date.');

            const { data: existing, error: existsErr } = await supabaseClient
                .from('Watch Logs')
                .select('id')
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .limit(1);

            if (existsErr) throw existsErr;
            if (Array.isArray(existing) && existing.length > 0) return;

            await insertWatchLog({ user_id, movie_id, watch_method, watch_date: wd });
        }

        async function insertWatchLogsBulk({ user_id, movie_id, entries }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');
            if (!Array.isArray(entries) || entries.length === 0) return;

            const rows = entries.map((e) => {
                const wd = String(e?.watch_date || '').trim();
                if (!wd) throw new Error('Missing watch_date.');
                return {
                    user_id,
                    movie_id,
                    watch_method: (e?.watch_method ?? null),
                    [COL_WATCH_DATE]: wd,
                };
            });

            const { error } = await supabaseClient
                .from('Watch Logs')
                .insert(rows);

            if (error) throw error;
        }

        function isUuidLike(v) {
            return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(v || '').trim());
        }

        function getTmdbIdFromSelectedMovie(movie) {
            if (!movie) return null;
            // Common shapes:
            // - movie.tmdb_id (number)
            // - movie.id (TMDb numeric id)
            // - movie.id (uuid) -> ignore
            if (movie?.tmdb_id !== undefined && movie?.tmdb_id !== null) {
                const n = Number(movie.tmdb_id);
                return Number.isFinite(n) && n > 0 ? n : null;
            }

            const rawId = movie?.id;
            if (isUuidLike(rawId)) return null;
            const n = Number(rawId);
            return Number.isFinite(n) && n > 0 ? n : null;
        }

        async function getDbMovieIdByTmdbId(tmdb_id) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const n = Number(tmdb_id);
            if (!Number.isFinite(n) || n <= 0) throw new Error('Missing tmdb_id.');

            const { data, error } = await supabaseClient
                .from('Movies')
                .select('id')
                .eq('tmdb_id', n)
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0]?.id || null;
        }

        async function getDbMovieRowById(movie_id) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Movies')
                .select('*')
                .eq('id', movie_id)
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function resolveDbMovieIdFromSelectedMovie(movie) {
            if (!movie) return null;
            if (isUuidLike(movie?.id)) return movie.id;
            const tmdb_id = getTmdbIdFromSelectedMovie(movie);
            if (!tmdb_id) return null;
            return await getDbMovieIdByTmdbId(tmdb_id);
        }

        async function hasExistingMovieRating({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Movie Ratings')
                .select('id')
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .limit(1);

            if (error) throw error;
            return Array.isArray(data) && data.length > 0;
        }

        async function getExistingMovieRatingRow({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Movie Ratings')
                .select('*')
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function getLatestWatchLog({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Watch Logs')
                .select(`id, watch_method, ${COL_WATCH_DATE}`)
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .order(COL_WATCH_DATE, { ascending: false })
                .order('id', { ascending: false })
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function getEarliestWatchLog({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Watch Logs')
                .select(`id, watch_method, ${COL_WATCH_DATE}`)
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .order(COL_WATCH_DATE, { ascending: true })
                .order('id', { ascending: true })
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function getWatchLogCount({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            // Use an efficient count-only query.
            const { count, error } = await supabaseClient
                .from('Watch Logs')
                .select('id', { count: 'exact', head: true })
                .eq('user_id', user_id)
                .eq('movie_id', movie_id);

            if (error) throw error;
            return Number.isFinite(Number(count)) ? Number(count) : 0;
        }

        function decodeJwtPayload(token) {
            try {
                const parts = String(token || '').split('.');
                if (parts.length < 2) return null;
                const b64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                const padded = b64 + '='.repeat((4 - (b64.length % 4)) % 4);
                const json = atob(padded);
                return JSON.parse(json);
            } catch (_) {
                return null;
            }
        }

        async function callSwiftApi(body, accessToken) {
            const iss = decodeJwtPayload(accessToken)?.iss;
            if (iss && typeof iss === 'string' && !iss.includes(SUPABASE_URL)) {
                throw new Error(
                    `Auth token is for a different Supabase project (iss=${iss}). Check SUPABASE_URL.`
                );
            }

            const url = `${SUPABASE_URL}/functions/v1/swift-api`;
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify(body)
            });

            const text = await res.text();
            let data = null;
            try {
                data = text ? JSON.parse(text) : null;
            } catch (_) {
                data = text;
            }

            if (!res.ok) {
                const serverMsg =
                    data && typeof data === 'object'
                        ? (data.message || data.error || JSON.stringify(data))
                        : String(data || '');
                const serverDetails =
                    data && typeof data === 'object' && data.details
                        ? ` (${String(data.details)})`
                        : '';
                throw new Error(`swift-api failed (HTTP ${res.status}) - ${serverMsg}${serverDetails}`);
            }

            return data;
        }

        let cachedAuthUser = null;
        let cachedIsAuthed = false;

        let cachedUserDisplayNameId = null;
        let cachedUserDisplayName = '';
        let cachedUserDisplayNameLoaded = false;

        function fallbackAccountName(user) {
            const email = String(user?.email || '').trim();
            if (email) return email.split('@')[0] || email;

            const id = String(user?.id || '').trim();
            if (!id) return '';
            return id.length > 8 ? `${id.slice(0, 8)}…` : id;
        }

        async function refreshAuthStateAndUI() {
            if (!supabaseClient) return;

            const navLoginBtn = document.getElementById('nav-login-btn');
            const statusEl = document.getElementById('auth-modal-status');
            const loginBtn = document.getElementById('auth-login-btn');
            const logoutBtn = document.getElementById('auth-logout-btn');
            const emailEl = document.getElementById('auth-email');
            const pwdEl = document.getElementById('auth-password');
            const saveBtn = document.getElementById('btn-save-diary');

            const { data, error } = await supabaseClient.auth.getSession();
            if (error) {
                cachedAuthUser = null;
                cachedIsAuthed = false;
                if (statusEl) statusEl.textContent = 'Auth error.';
                if (statusEl) statusEl.style.color = 'rgba(239,68,68,0.95)';
                if (navLoginBtn) navLoginBtn.textContent = 'Login';
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = 0.6;
                    saveBtn.setAttribute('aria-disabled', 'true');
                    saveBtn.title = 'Please log in first.';
                }
                return;
            }

            const user = data?.session?.user || null;
            const isAuthed = Boolean(user?.id);

            cachedAuthUser = user;
            cachedIsAuthed = isAuthed;

            let displayName = '';
            if (isAuthed) {
                const uid = String(user.id);
                if (cachedUserDisplayNameId !== uid) {
                    cachedUserDisplayNameId = uid;
                    cachedUserDisplayName = '';
                    cachedUserDisplayNameLoaded = false;
                }

                if (!cachedUserDisplayNameLoaded) {
                    cachedUserDisplayNameLoaded = true;
                    try {
                        const { data: usersRows, error: usersErr } = await supabaseClient
                            .from('Users')
                            .select('display_name')
                            .eq('id', uid)
                            .limit(1);
                        if (!usersErr && Array.isArray(usersRows) && usersRows.length > 0) {
                            cachedUserDisplayName = String(usersRows[0]?.display_name || '').trim();
                        }
                    } catch (_) {
                        // RLS or missing table: fall back silently.
                    }
                }

                displayName = String(cachedUserDisplayName || '').trim();
            }

            if (navLoginBtn) {
                if (isAuthed) {
                    const dn = displayName || fallbackAccountName(user);
                    navLoginBtn.textContent = dn ? `${dn} - Account` : 'Account';
                } else {
                    navLoginBtn.textContent = 'Login';
                }
            }
            if (statusEl) {
                if (isAuthed) {
                    const dn = displayName || fallbackAccountName(user);
                    statusEl.textContent = dn ? `Logged in as ${dn}` : `Logged in as ${user.email || user.id}`;
                } else {
                    statusEl.textContent = 'Not logged in.';
                }
                statusEl.style.color = 'var(--text-muted)';
            }
            if (loginBtn) loginBtn.style.display = isAuthed ? 'none' : 'inline-flex';
            if (logoutBtn) logoutBtn.style.display = isAuthed ? 'inline-flex' : 'none';

            if (emailEl) {
                emailEl.disabled = isAuthed;
                emailEl.classList.toggle('input-readonly', isAuthed);
            }
            if (pwdEl) {
                pwdEl.disabled = isAuthed;
                pwdEl.classList.toggle('input-readonly', isAuthed);
            }

            if (saveBtn) {
                const locked = !isAuthed;
                saveBtn.disabled = false;
                saveBtn.style.opacity = locked ? 0.6 : 1;
                saveBtn.setAttribute('aria-disabled', locked ? 'true' : 'false');
                saveBtn.title = locked ? 'Please log in first.' : '';
            }
        }

        async function handleLoginClick(e) {
            e?.preventDefault?.();
            try {
                if (!supabaseClient) throw new Error('Supabase client not initialized.');
                const email = String(document.getElementById('auth-email')?.value || '').trim();
                const password = String(document.getElementById('auth-password')?.value || '').trim();
                if (!email || !password) throw new Error('Enter email + password, then click Log in.');

                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                // Validate immediately (catches Invalid JWT situations early).
                const { data: userData, error: userErr } = await supabaseClient.auth.getUser();
                if (userErr || !userData?.user?.id) {
                    await supabaseClient.auth.signOut();
                    throw new Error('Login succeeded, but session token is invalid for this project. Verify SUPABASE_URL/keys.');
                }

                const pwdEl = document.getElementById('auth-password');
                if (pwdEl) pwdEl.value = '';

                await refreshAuthStateAndUI();
                showToast('Logged in. You can now save.');
                closeAuthModal();
            } catch (err) {
                // Refresh UI first (so button visibility/disabled states are correct),
                // then set the error text last so it doesn't get overwritten.
                await refreshAuthStateAndUI();

                const statusEl = document.getElementById('auth-modal-status');
                if (statusEl) {
                    statusEl.textContent = `Login failed: ${String(err?.message || err)}`;
                    statusEl.style.color = 'rgba(239,68,68,0.95)';
                }
            }
        }

        async function handleLogoutClick(e) {
            e?.preventDefault?.();
            try {
                if (!supabaseClient) return;
                await supabaseClient.auth.signOut();
                await refreshAuthStateAndUI();
                showToast('Logged out.');
                closeAuthModal();
            } catch (err) {
                showToast(`Logout failed: ${String(err.message || err)}`);
            }
        }

        function openAuthModal() {
            const overlay = document.getElementById('auth-overlay');
            if (!overlay) return;
            overlay.classList.add('open');
            refreshAuthStateAndUI();

            // Focus the first enabled field.
            const emailEl = document.getElementById('auth-email');
            const pwdEl = document.getElementById('auth-password');
            if (emailEl && !emailEl.disabled) emailEl.focus();
            else if (pwdEl && !pwdEl.disabled) pwdEl.focus();
        }

        function openDashboardAuthWarning() {
            const overlay = document.getElementById('dashboard-auth-warning');
            if (!overlay) return;
            overlay.classList.add('open');
        }

        function closeDashboardAuthWarning() {
            const overlay = document.getElementById('dashboard-auth-warning');
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        function closeAuthModal() {
            const overlay = document.getElementById('auth-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        let toastTimer = null;

        const messageLog = [];
        const MAX_LOG_ITEMS = 300;

        function emitLog(level, message, extra = null) {
            const prefix = '[CinemaTracker]';
            const line = `${prefix} ${String(message || '')}`;

            if (level === 'error') console.error(line, extra ?? '');
            else if (level === 'warn') console.warn(line, extra ?? '');
            else console.log(line, extra ?? '');

            // If this HTML is running inside a VS Code WebView (e.g., Live Preview),
            // some hosts may pick up console output into VS Code Output/Debug Console.
            // We intentionally avoid hard dependencies on VS Code APIs.
        }

        function formatTime(ts) {
            try {
                const d = new Date(ts);
                return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } catch (_) {
                return '';
            }
        }

        function renderMessageLog() {
            const badge = document.getElementById('log-badge');
            const body = document.getElementById('log-body');
            if (badge) badge.innerText = String(messageLog.length);
            if (!body) return;

            body.innerHTML = messageLog
                .map((item) => {
                    const levelClass = item.level === 'error'
                        ? 'log-level-error'
                        : (item.level === 'warn' ? 'log-level-warn' : 'log-level-info');
                    const safeMsg = String(item.message || '').replace(/[&<>"']/g, (c) => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[c]));
                    const safeExtra = item.extra
                        ? String(item.extra).replace(/[&<>"']/g, (c) => ({
                            '&': '&amp;',
                            '<': '&lt;',
                            '>': '&gt;',
                            '"': '&quot;',
                            "'": '&#39;'
                        }[c]))
                        : '';
                    return `
<div class="log-item">
  <div class="log-meta"><span class="${levelClass}">${item.level.toUpperCase()}</span> • ${formatTime(item.ts)}</div>
  <div>${safeMsg}${safeExtra ? `<div class="log-meta">${safeExtra}</div>` : ''}</div>
</div>`;
                })
                .join('');

            // Auto-scroll to bottom
            body.scrollTop = body.scrollHeight;
        }

        function addMessageToLog(level, message, extra = null) {
            messageLog.push({ ts: Date.now(), level, message: String(message ?? ''), extra: extra ? String(extra) : null });
            while (messageLog.length > MAX_LOG_ITEMS) messageLog.shift();
            renderMessageLog();
        }

        function setLogPanelOpen(isOpen) {
            const panel = document.getElementById('log-panel');
            if (!panel) return;
            panel.classList.toggle('open', Boolean(isOpen));
        }

        function showToast(msg, opts = {}) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');

            const text = String(msg ?? '');
            const explicitLevel = String(opts.level || '').toLowerCase();
            const isError = explicitLevel === 'error' || /\b(failed|error)\b/i.test(text);
            const isWarning = explicitLevel === 'warn' || /\bwarning\b/i.test(text);
            const level = isError ? 'error' : (isWarning ? 'warn' : 'info');

            // Persist EVERYTHING (success/warn/error) to the on-page message log.
            addMessageToLog(level, text);

            // Also log errors/warnings to the console.
            if (level === 'error') emitLog('error', text);
            else if (level === 'warn') emitLog('warn', text);

            if (msgEl) msgEl.innerText = text;
            if (iconEl) iconEl.innerHTML = (level === 'info') ? icons.checkCircle : icons.info;

            toast.classList.add('show');

            // Make error toasts stick around longer.
            const durationMs = Number.isFinite(Number(opts.durationMs))
                ? Number(opts.durationMs)
                : (level === 'info' ? 3000 : 15000);

            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toast.classList.remove('show'), durationMs);

            // Allow manual dismiss (click the toast)
            toast.onclick = () => toast.classList.remove('show');
        }

        // Wire up message log UI
        (function initMessageLogUI() {
            const fab = document.getElementById('log-fab');
            const fabIcon = document.getElementById('log-fab-icon');
            const closeBtn = document.getElementById('log-close');
            const clearBtn = document.getElementById('log-clear');
            const copyBtn = document.getElementById('log-copy');

            if (fabIcon) fabIcon.innerHTML = icons.info;

            if (fab) {
                fab.addEventListener('click', () => {
                    const panel = document.getElementById('log-panel');
                    const isOpen = panel?.classList?.contains('open');
                    setLogPanelOpen(!isOpen);
                });
            }

            if (closeBtn) closeBtn.addEventListener('click', () => setLogPanelOpen(false));
            if (clearBtn) clearBtn.addEventListener('click', () => {
                messageLog.length = 0;
                renderMessageLog();
            });
            if (copyBtn) copyBtn.addEventListener('click', async () => {
                const text = messageLog
                    .map((i) => `[${i.level.toUpperCase()} ${formatTime(i.ts)}] ${i.message}${i.extra ? ` | ${i.extra}` : ''}`)
                    .join('\n');
                try {
                    await navigator.clipboard.writeText(text);
                    showToast('Log copied to clipboard');
                } catch (e) {
                    // Fallback
                    try {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        ta.remove();
                        showToast('Log copied to clipboard');
                    } catch (err) {
                        showToast(`Copy failed: ${String(err?.message || err)}`, { level: 'warn' });
                    }
                }
            });

            // Initial render
            renderMessageLog();
        })();

        // Capture uncaught errors and promise rejections too.
        window.addEventListener('error', (e) => {
            try {
                emitLog('error', `Uncaught error: ${e?.message || 'Unknown error'}`);
            } catch (_) {}
        });

        window.addEventListener('unhandledrejection', (e) => {
            try {
                const reason = e?.reason?.message || String(e?.reason || 'Unknown rejection');
                emitLog('error', `Unhandled rejection: ${reason}`);
            } catch (_) {}
        });

        // Keep auth UI synced with session changes.
        if (supabaseClient?.auth?.onAuthStateChange) {
            supabaseClient.auth.onAuthStateChange(() => {
                refreshAuthStateAndUI();
            });
        }

        // Warn if the user tries to save before logging in.
        document.addEventListener('click', (e) => {
            const btn = e?.target?.closest ? e.target.closest('#btn-save-diary') : null;
            if (!btn) return;

            // If the button isn't in the DOM yet, nothing to do.
            if (!supabaseClient) {
                e.preventDefault();
                e.stopPropagation();
                showToast('Supabase SDK failed to load.', { level: 'error' });
                return;
            }

            const ariaDisabled = btn.getAttribute('aria-disabled') === 'true';
            if (ariaDisabled || !cachedIsAuthed) {
                e.preventDefault();
                e.stopPropagation();
                showToast('Please log in first to save to diary.', { level: 'warn' });
                openAuthModal();
            }
        }, true);

        document.addEventListener('click', (e) => {
            const input = document.getElementById('movie-search-input');
            const res = document.getElementById('search-results');
            if(input && res && !input.contains(e.target) && !res.contains(e.target)) {
                res.classList.add('hidden');
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await refreshAuthStateAndUI();
            router.init();
        });

        document.addEventListener('keydown', (e) => {
            const overlay = document.getElementById('auth-overlay');
            const isOpen = overlay?.classList?.contains('open');
            if (!isOpen) return;

            if (e.key === 'Escape') {
                closeAuthModal();
                return;
            }

            if (e.key === 'Enter') {
                const loginBtn = document.getElementById('auth-login-btn');
                if (loginBtn && loginBtn.style.display !== 'none') {
                    e.preventDefault();
                    loginBtn.click();
                }
            }
        });
    </script>
</body>
</html>
