<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinemaTracker | Your Movie Journey</title>
    <link rel="preconnect" href="https://dbxhaseoxpnmzdxbzdpj.supabase.co">
        <!-- ========================= FAVICON (BOOKMARK/TAB ICON) START =========================
            This is the icon browsers use for tabs + bookmarks.
            To change it later: replace the embedded SVG inside the href="data:image/svg+xml,..." below.
            Tip: If you prefer a file instead of inline, swap these for: <link rel="icon" href="/favicon.ico">.
        ========================== FAVICON (BOOKMARK/TAB ICON) START ========================== -->
        <link rel="icon" type="image/png" sizes="32x32" href="/FaviconBlack.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/FaviconBlack.png">
        <link rel="icon" type="image/png" href="/FaviconBlack.png">
        <link rel="shortcut icon" href="/FaviconBlack.png">
        <link rel="apple-touch-icon" sizes="180x180" href="/FaviconBlack.png">
        <!-- ========================== FAVICON (BOOKMARK/TAB ICON) END ========================== -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;      /* Zinc 950 */
            --surface: #18181b;      /* Zinc 900 */
            --border: #27272a;       /* Zinc 800 */
            --text-main: #e4e4e7;    /* Zinc 200 */
            --text-muted: #a1a1aa;   /* Zinc 400 */
            --glass-border: rgba(255, 255, 255, 0.05);
            --glass-shadow: rgba(0, 0, 0, 0.35);
            --btn-outline-bg: rgba(24, 24, 27, 0.65);
            --focus-ring: rgba(20, 184, 166, 0.6);

            --bg-image: none;
            --bg-overlay: linear-gradient(to bottom, rgba(9,9,11,0.1), rgba(9,9,11,0.55) 50%, rgba(9,9,11,0.9) 100%);

            /* Tier colors (match Data Dashboard tier colors) */
            --tier-s-rgb: 239, 68, 68;   /* Red (#ef4444) */
            --tier-a-rgb: 251, 146, 60;  /* Orange (#fb923c) */
            --tier-b-rgb: 250, 204, 21;  /* Yellow (#facc15) */
            --tier-c-rgb: 74, 222, 128;  /* Green (#4ade80) */
            --tier-d-rgb: 96, 165, 250;  /* Blue (#60a5fa) */
            --tier-f-rgb: 161, 55, 198;  /* Purple (#a137c6) */

            --heatmap-h: 156;
            --heatmap-s: 55%;

            --font-family: 'Outfit', sans-serif;
            --container-width: 1280px;
            --header-height: 80px;
        }


        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            background-image: none;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .theme-background,
        .theme-gradient-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
        }
        .theme-background {
            z-index: -2;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .theme-gradient-overlay {
            z-index: -1;
            background: var(--bg-overlay);
        }
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }

        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .grid { display: grid; }
        .hidden { display: none !important; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(1, 1fr); } /* Mobile default */
        .grid-4 { grid-template-columns: repeat(2, 1fr); } /* Mobile default */

        .container {
            width: 100%;
            max-width: var(--container-width);
            margin: 0 auto;
            padding: 0 2rem;
        }

        @media (min-width: 768px) {
            .grid-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-4 { grid-template-columns: repeat(4, 1fr); }
            .md-block { display: block; }
            .md-hidden { display: none; }
            .md-row { flex-direction: row; }
            .col-span-2 { grid-column: span 2; }
        }
        .fade-in { animation: fadeIn 0.4s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .animate-marquee {
            display: flex;
            width: max-content;
            animation: marquee 60s linear infinite;
        }
        .animate-marquee:hover { animation-play-state: paused; }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 18px 32px var(--glass-shadow);
        }
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 50;
            border-bottom: 1px solid var(--border);
        }
        .nav-inner {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-brand { font-size: 1.25rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 0.5rem; }
        .nav-brand .cinema-title { color: var(--nav-accent); }
        .nav-brand .tracker-title { color: var(--nav-title); }

        /* Navbar logo image */
        .icon-wrapper { display: inline-flex; align-items: center; justify-content: center; width: 120px; height: 120px; }
        .icon-wrapper img { width: 120px; height: 120px; object-fit: contain; display: block; }

        @media (max-width: 768px) {
            :root { --header-height: 96px; }
            .icon-wrapper { width: 96px; height: 96px; }
            .icon-wrapper img { width: 96px; height: 96px; }
        }

        /* Home hero logo (bigger brand mark) */
        .home-hero-logo {
            width: 120px;
            height: 120px;
            object-fit: contain;
            display: block;
            filter: drop-shadow(0 14px 28px rgba(0,0,0,0.45));
        }
        @media (max-width: 768px) {
            .home-hero-logo { width: 96px; height: 96px; }
        }
        .nav-links { display: flex; gap: 0.75rem; }
        .nav-link {
            font-size: 0.95rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            color: rgba(255,255,255,0.9);
            padding: 0.55rem 0.95rem;
            border-radius: 999px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.14);
            transition: background 0.2s, border-color 0.2s, transform 0.2s, box-shadow 0.2s, color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .nav-link:hover {
            color: #fff;
            background: rgba(255,255,255,0.07);
            border-color: rgba(255,255,255,0.30);
            transform: translateY(-1px);
        }
        .nav-link.active {
            color: #fff;
            background: linear-gradient(135deg, var(--nav-active-a), var(--nav-active-b));
            border-color: var(--brand);
            box-shadow: 0 10px 26px rgba(0,0,0,0.35);
        }
        .mobile-menu-btn { color: var(--text-muted); display: none; }
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .mobile-menu-btn { display: block; }
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary {
            background-color: var(--brand);
            color: white;
            box-shadow: 0 4px 14px 0 var(--brand-shadow);
        }
        .btn-primary:hover { background-color: var(--brand-hover); box-shadow: 0 8px 22px 0 var(--brand-shadow); }
        
        .btn-glass {
            background: color-mix(in srgb, var(--brand-2) 20%, rgba(255,255,255,0.04));
            color: white;
            border: 1px solid color-mix(in srgb, var(--brand-2) 50%, rgba(255,255,255,0.12));
        }
        .btn-glass:hover { background: color-mix(in srgb, var(--brand-2) 35%, rgba(255,255,255,0.08)); }

        .btn-outline {
            background: var(--btn-outline-bg);
            border: 1px solid var(--border);
            color: white;
        }
        .btn-outline:hover { border-color: var(--brand); box-shadow: 0 0 0 1px var(--brand); }
        .input-group { position: relative; }
        .input-field, .select-field, .textarea-field {
            width: 100%;
            background-color: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: white;
            font-family: var(--font-family);
            outline: none;
            transition: border-color 0.2s;
            color-scheme: dark; /* For calendar picker */
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 2px var(--focus-ring);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding-left: 3rem; /* Space for icon */
            font-size: 1.125rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        /* Make native date picker indicator easier to find/click (Safari/Chrome) */
        input[type="date"] { cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            width: 22px;
            height: 22px;
            padding: 10px;
            cursor: pointer;
            opacity: 0.95;
        }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        /* Genre chips (tap/click selection, max 2) */
        .genre-chip-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .genre-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0.75rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: #fff;
            font-size: 0.875rem;
            font-weight: 600;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .genre-chip:hover { border-color: var(--brand); }
        .genre-chip.selected {
            border-color: var(--brand);
            background: var(--brand-light);
        }

        /* Tier selector buttons (single-choice, not locked) */
        .tier-btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.6rem;
        }
        @media (min-width: 768px) {
            .tier-btn-group { grid-template-columns: repeat(6, 1fr); }
        }
        .tier-btn {
            --tier-rgb: 255, 255, 255;
            width: 100%;
            padding: 0.75rem 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(var(--tier-rgb), 0.45);
            color: white;
            font-weight: 800;
            letter-spacing: 0.04em;
            transition: transform 0.15s ease, opacity 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            background: rgba(var(--tier-rgb), 0.22);
        }
        .tier-btn[data-tier="S-Tier"] { --tier-rgb: var(--tier-s-rgb); }
        .tier-btn[data-tier="A-Tier"] { --tier-rgb: var(--tier-a-rgb); }
        .tier-btn[data-tier="B-Tier"] { --tier-rgb: var(--tier-b-rgb); }
        .tier-btn[data-tier="C-Tier"] { --tier-rgb: var(--tier-c-rgb); }
        .tier-btn[data-tier="D-Tier"] { --tier-rgb: var(--tier-d-rgb); }
        .tier-btn[data-tier="F-Tier"] { --tier-rgb: var(--tier-f-rgb); }
        .tier-btn-group[data-has-selection="true"] .tier-btn {
            opacity: 0.35;
            filter: grayscale(0.7) saturate(0.6);
        }
        .tier-btn-group[data-has-selection="true"] .tier-btn.selected {
            opacity: 1;
            filter: none;
            background: rgba(var(--tier-rgb), 0.5);
            border-color: rgba(var(--tier-rgb), 0.85);
            box-shadow: 0 0 0 2px rgba(var(--tier-rgb), 0.25), 0 10px 18px rgba(0,0,0,0.35);
            transform: translateY(-1px);
        }
        .dash-heatmap {
            --heatmap-cell: 16px;
            display: grid;
            gap: 18px;
        }
        .dash-heatmap-row {
            display: grid;
            grid-template-columns: 56px 1fr;
            gap: 14px;
            align-items: start;
        }
        .dash-heatmap-year {
            font-size: 0.95rem;
            font-weight: 800;
            color: #fff;
            text-align: right;
            padding-top: 8px;
        }
        .dash-heatmap-year-grid {
            display: grid;
            gap: 6px;
        }
        .dash-heatmap-months {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: var(--heatmap-cell);
            gap: 2px;
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 0.01em;
        }
        .dash-heatmap-month-label {
            grid-column: var(--month-col);
            white-space: nowrap;
        }
        .dash-heatmap-weeks {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: var(--heatmap-cell);
            grid-template-rows: repeat(7, var(--heatmap-cell));
            gap: 2px;
        }
        .dash-heatmap-cell {
            width: var(--heatmap-cell);
            height: var(--heatmap-cell);
            border-radius: 2px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            display: grid;
            place-items: center;
            font-size: 0.65rem;
            font-weight: 700;
            color: rgba(255,255,255,0.85);
        }
        .dash-heatmap-cell.is-month {
            width: auto;
            height: auto;
            aspect-ratio: 1 / 1;
            min-height: 48px;
            font-size: 0.85rem;
        }
        .dash-heatmap-day {
            line-height: 1;
        }
        .dash-heatmap.is-month-view {
            --heatmap-month-cell: 80px;
            --heatmap-month-gap: 2px;
        }
        .dash-heatmap-month {
            display: grid;
            gap: 12px;
        }
        .dash-heatmap-month-title {
            text-align: center;
            font-weight: 800;
            letter-spacing: 0.02em;
            color: #fff;
        }
        .dash-heatmap-weekdays {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: var(--heatmap-month-gap, 6px);
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            width: 100%;
        }
        .dash-heatmap-month-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: var(--heatmap-month-gap, 6px);
            width: 100%;
        }
        .dash-heatmap-day-wrap {
            display: grid;
            grid-template-rows: 14px auto;
            gap: 3px;
            width: 100%;
        }
        .dash-heatmap-day-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: left;
            padding-left: 4px;
        }
        .dash-heatmap-month-grid .dash-heatmap-cell {
            width: 100%;
            aspect-ratio: 1 / 1;
            min-height: var(--heatmap-month-cell);
            height: auto;
            font-size: 0.9rem;
            font-weight: 800;
            padding: 0;
        }
        .dash-heatmap-month-grid .dash-heatmap-cell.is-empty {
            background: transparent;
            border-color: rgba(255,255,255,0.06);
        }
        .dash-heatmap-cell.is-empty {
            background: transparent;
            border-color: transparent;
        }
        .dash-heatmap-l1 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 92%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 86%, 0.9); }
        .dash-heatmap-l2 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 88%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 82%, 0.9); }
        .dash-heatmap-l3 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 82%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 76%, 0.9); }
        .dash-heatmap-l4 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 72%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 66%, 0.9); }
        .dash-heatmap-l5 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 62%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 56%, 0.9); }
        .dash-heatmap-l6 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 52%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 46%, 0.9); }
        .dash-heatmap-l7 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 44%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 38%, 0.9); }
        .dash-heatmap-l8 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 36%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 30%, 0.9); }
        .dash-heatmap-l9 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 30%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 24%, 0.9); }
        .dash-heatmap-l10 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 24%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 18%, 0.9); }
        .dash-heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .dash-heatmap-legend.top-right {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .dash-heatmap-legend-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .dash-heatmap-legend-label {
            font-variant-numeric: tabular-nums;
            color: rgba(255,255,255,0.85);
        }
        .dash-heatmap-legend-swatch {
            width: var(--heatmap-cell);
            height: var(--heatmap-cell);
            border-radius: 2px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .dash-heatmap-legend-swatch.is-empty {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.08);
        }
        .dash-genre-heatmap-wrap {
            overflow-x: auto;
            padding: 4px 10px;
        }
        .dash-genre-heatmap {
            display: grid;
            gap: 8px;
            min-width: 560px;
        }
        .dash-genre-heatmap-header,
        .dash-genre-heatmap-row {
            display: grid;
            gap: 8px;
            align-items: center;
        }
        .dash-genre-heatmap-header {
            font-size: 0.78rem;
            color: var(--text-muted);
        }
        .dash-genre-heatmap-label {
            font-weight: 800;
            color: #fff;
            text-align: left;
            padding-left: 6px;
        }
        .dash-genre-heatmap-decade,
        .dash-heatmap-col-label {
            font-size: 1rem;
            font-weight: 800;
            color: #fff;
            text-align: center;
        }
        .dash-chart-card {
            padding: 1.25rem;
            border-radius: 0.95rem;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
        }
        .dash-chart-stage {
            min-height: 360px;
        }
        .dash-chart-title {
            font-size: 1.05rem;
            font-weight: 800;
            color: #fff;
        }
        .dash-chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }
        #dash-heatmap-select-wrap {
            margin-left: auto;
        }
        #dash-heatmap-pair {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.14);
            color: #fff;
        }
        #dash-heatmap-pair option {
            color: #0b0b0f;
        }
        .dash-chart-body {
            display: grid;
            gap: 10px;
        }
        .dash-genre-heatmap-cell {
            min-height: 42px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.78rem;
            font-weight: 800;
            text-align: center;
            padding: 4px;
            line-height: 1.1;
        }
        .dash-genre-heatmap-cell.is-empty {
            background: transparent;
            border-color: rgba(255,255,255,0.06);
            color: var(--text-muted);
        }
        .dash-genre-heatmap-value {
            font-variant-numeric: tabular-nums;
        }
        .dash-genre-heatmap-cell.dash-heatmap-l1 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 92%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 86%, 0.9); color: #0b1f17; }
        .dash-genre-heatmap-cell.dash-heatmap-l2 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 88%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 82%, 0.9); color: #0b1f17; }
        .dash-genre-heatmap-cell.dash-heatmap-l3 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 82%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 76%, 0.9); color: #0b1f17; }
        .dash-genre-heatmap-cell.dash-heatmap-l4 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 72%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 66%, 0.9); color: #0b1f17; }
        .dash-genre-heatmap-cell.dash-heatmap-l5 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 62%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 56%, 0.9); color: #0b1f17; }
        .dash-genre-heatmap-cell.dash-heatmap-l6 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 52%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 46%, 0.9); color: #0b1f17; }
        .dash-genre-heatmap-cell.dash-heatmap-l7 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 44%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 38%, 0.9); color: #fff; }
        .dash-genre-heatmap-cell.dash-heatmap-l8 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 36%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 30%, 0.9); color: #fff; }
        .dash-genre-heatmap-cell.dash-heatmap-l9 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 30%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 24%, 0.9); color: #fff; }
        .dash-genre-heatmap-cell.dash-heatmap-l10 { background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 24%); border-color: hsla(var(--heatmap-h, 156), var(--heatmap-s, 55%), 18%, 0.9); color: #fff; }
        @media (max-width: 900px) {
            .dash-heatmap.is-month-view { --heatmap-month-cell: 70px; }
        }
        @media (max-width: 640px) {
            .dash-heatmap { --heatmap-cell: 12px; }
            .dash-heatmap-row { grid-template-columns: 44px 1fr; }
            .dash-heatmap.is-month-view { --heatmap-month-cell: 60px; }
            .dash-genre-heatmap { min-width: 360px; }
        }
        @keyframes dashSparkDraw {
            to { stroke-dashoffset: 0; }
        }
        @keyframes dashDotPop {
            to { opacity: 1; transform: scale(1); }
        }

        /* Cards */
        .movie-card {
            position: relative;
            aspect-ratio: 2/3;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: var(--surface);
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .movie-card:hover {
            transform: scale(1.03);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .movie-card img { width: 100%; height: 100%; object-fit: cover; }
        .movie-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1rem;
        }
        .movie-card:hover .movie-overlay { opacity: 1; }

        /* Trending Card */
        .trending-card {
            flex: 0 0 160px;
            height: 240px;
            border-radius: 0.5rem;
            overflow: hidden;
            margin: 0 0.5rem;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--surface);
            cursor: pointer;
            transition: transform 0.3s;
            will-change: transform;
        }
        .trending-card:hover { transform: scale(1.05); }
        .trending-card img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Search Dropdown */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            margin-top: 0.5rem;
            background-color: #18181b;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 1200;
            max-height: 360px;
            overflow-y: auto;
        }
        #theme-creator-search-results {
            z-index: 9999;
        }
        #theme-creator-ai-search-results {
            z-index: 9999;
        }
        #theme-creator-search-panel {
            position: relative;
            z-index: 10000;
            overflow: visible;
        }
        #theme-creator-search-panel .input-group {
            z-index: 10001;
            overflow: visible;
        }
        #theme-creator-backdrops-panel,
        #theme-creator-selected-panel {
            position: relative;
            z-index: 0;
        }
        .search-item {
            padding: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .search-item:hover { background-color: var(--brand-light); }
        .search-item:last-child { border-bottom: none; }

        /* Range Sliders */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .slider-container.slider-vertical {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        .slider-container.slider-vertical .relative {
            width: 100% !important;
        }
        input[type=range] {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--brand);
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: #0d9488;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 100;
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        /* Auth Modal */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.25rem;
            font-size: 1.18rem;
            font-weight: 900;
            letter-spacing: 0.01em;
            overflow-y: auto;
        }
        .auth-overlay.open { display: flex; }
        .auth-modal {
            font-weight: 900;
            font-size: 1.06rem;
            background: rgba(24, 24, 27, 0.92);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: 0 24px 60px rgba(0,0,0,0.55);
            padding: 1.25rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 460px;
            max-height: calc(100dvh - 2.5rem);
            overflow: auto;
        }
        .auth-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .auth-modal-title {
            font-size: 1.05rem;
            font-weight: 800;
            color: #fff;
        }
        .auth-modal-close {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 0.7rem;
            padding: 0.45rem 0.65rem;
            color: white;
            font-weight: 800;
        }
        .auth-modal-close:hover { background: rgba(255,255,255,0.10); }
        .auth-modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        /* Achievements */
        .achievement-grid {
            display: contents;
        }
        .achievement-card {
            --tier-rgb: 148, 163, 184;
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            padding: 0.7rem;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
            display: inline-flex;
            flex-direction: column;
            gap: 0.45rem;
            width: 219px;
            height: 175px;
            margin: 0 0.9rem 0.9rem 0;
            vertical-align: top;
            cursor: pointer;
        }
        .achievement-card:hover {
            border-color: rgba(var(--tier-rgb), 0.5);
            box-shadow: 0 10px 24px rgba(0,0,0,0.35);
            transform: translateY(-2px);
        }
        .achievement-detail-list {
            display: grid;
            gap: 0.6rem;
            margin-top: 0.6rem;
        }
        .achievement-detail-item {
            padding: 0.6rem 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
            align-items: center;
        }
        .achievement-detail-label {
            font-weight: 800;
            color: #fff;
        }
        .achievement-detail-value {
            color: var(--text-muted);
            text-align: right;
        }
        .achievement-card::after {
            content: '';
            position: absolute;
            inset: -20% -20% auto auto;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(var(--tier-rgb), 0.35), transparent 65%);
            opacity: 0.7;
            pointer-events: none;
        }
        .achievement-card.locked {
            opacity: 0.35;
            filter: grayscale(0.75) saturate(0.6);
            background: rgba(0,0,0,0.22);
            border-color: rgba(255,255,255,0.08);
        }
        .achievement-card[data-tier="Bronze"] { --tier-rgb: 206, 137, 70; }
        .achievement-card[data-tier="Silver"] { --tier-rgb: 196, 196, 196; }
        .achievement-card[data-tier="Gold"] { --tier-rgb: 239, 191, 4; }
        .achievement-card[data-tier="Platinum"] { --tier-rgb: 164, 200, 225; }
        .achievement-card[data-tier="Diamond"] { --tier-rgb: 15, 82, 186; }
        .achievement-card[data-tier="Emerald"] { --tier-rgb: 80, 200, 120; }
        .achievement-card[data-tier="Ruby"] { --tier-rgb: 224, 17, 95; }
        .achievement-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
        }
        .achievement-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            line-height: 1;
        }
        .achievement-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
            transform: translateY(6px);
        }
        .achievement-badge {
            font-size: 0.72rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 0.3rem 0.55rem;
            border-radius: 999px;
            background: rgba(var(--tier-rgb), 0.18);
            border: 1px solid rgba(var(--tier-rgb), 0.45);
            color: rgba(255,255,255,0.95);
        }
        .achievement-title {
            font-weight: 800;
            color: #fff;
            font-size: 0.95rem;
            line-height: 1.2;
        }
        .achievement-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.2;
        }
        #achievement-earned-body {
            --tier-rgb: 148, 163, 184;
            border: 1px solid rgba(var(--tier-rgb), 0.45);
            background: linear-gradient(135deg, rgba(var(--tier-rgb), 0.18), rgba(0,0,0,0.22));
        }
        #achievement-earned-body .achievement-icon {
            width: 150px;
            height: 150px;
            border-radius: 32px;
        }
        #achievement-earned-modal {
            --tier-rgb: 148, 163, 184;
            background: radial-gradient(circle at top left, rgba(var(--tier-rgb), 0.28), rgba(24, 24, 27, 0.96) 55%);
            border: 1px solid rgba(var(--tier-rgb), 0.5);
            box-shadow: 0 24px 70px rgba(0,0,0,0.55);
            position: relative;
            overflow: hidden;
        }
        #achievement-earned-modal.achievement-modal {
            max-width: 520px;
            min-height: unset;
        }
        #achievement-earned-modal.achievement-modal .auth-modal-title {
            font-size: 1.2rem;
        }
        #achievement-earned-modal.achievement-modal .achievement-title {
            font-size: 1.25rem;
        }
        #achievement-earned-modal.achievement-modal .achievement-meta {
            font-size: 0.9rem;
        }
        #achievement-splash {
            position: absolute;
            inset: -25% -15%;
            background: conic-gradient(from 120deg, rgba(var(--tier-rgb), 0.25), rgba(255,255,255,0.1), rgba(var(--tier-rgb), 0.35), rgba(0,0,0,0.05), rgba(var(--tier-rgb), 0.28));
            opacity: 0;
            transform: scale(0.7) rotate(-12deg);
            filter: blur(4px) saturate(1.2);
            pointer-events: none;
            z-index: 0;
            will-change: transform, opacity, filter;
        }
        #achievement-swipe {
            position: absolute;
            inset: -10% -10%;
            width: 120%;
            height: 120%;
            opacity: 0;
            pointer-events: none;
            z-index: 1;
        }
        .achievement-swipe-path {
            fill: rgba(var(--tier-rgb), 0.35);
            mix-blend-mode: screen;
            will-change: d, opacity, transform;
        }
        .achievement-swipe-stroke {
            fill: none;
            stroke: rgba(var(--tier-rgb), 0.8);
            stroke-width: 18;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0;
            filter: drop-shadow(0 6px 16px rgba(0,0,0,0.3));
            will-change: opacity, stroke-dasharray, stroke-dashoffset;
        }
        .achievement-motion-path {
            fill: none;
            stroke: none;
        }
        #achievement-pieces {
            position: absolute;
            inset: -10% 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }
        .achievement-piece {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 4px;
            background: rgba(var(--tier-rgb), 0.9);
            box-shadow: 0 6px 14px rgba(0,0,0,0.3);
            mix-blend-mode: screen;
            opacity: 0;
            will-change: transform, opacity;
        }
        #achievement-earned-modal {
            z-index: 2;
        }
        #achievement-earned-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.75rem;
            gap: 0.6rem;
            flex-wrap: wrap;
        }
        #achievement-earned-actions .btn {
            flex: 1 1 auto;
            min-width: 160px;
        }
        #achievement-earned-actions .btn-primary {
            background: rgba(var(--tier-rgb), 0.35);
            border: 1px solid rgba(var(--tier-rgb), 0.6);
            box-shadow: 0 10px 24px rgba(0,0,0,0.35);
        }
        #achievement-earned-actions .btn-primary:hover {
            background: rgba(var(--tier-rgb), 0.5);
        }
        #achievement-earned-actions .btn-outline {
            background: rgba(var(--tier-rgb), 0.12);
            border: 1px solid rgba(var(--tier-rgb), 0.35);
        }
        #achievement-earned-modal::before {
            content: '';
            position: absolute;
            inset: -60% -30% auto auto;
            width: 320px;
            height: 320px;
            background: radial-gradient(circle, rgba(var(--tier-rgb), 0.35), transparent 70%);
            opacity: 0;
            pointer-events: none;
        }
        #achievement-earned-modal::after {
            content: '';
            position: absolute;
            inset: auto -20% -50% auto;
            width: 280px;
            height: 280px;
            background: radial-gradient(circle, rgba(255,255,255,0.18), transparent 70%);
            opacity: 0;
            pointer-events: none;
        }
        #achievement-earned-modal[data-tier="Bronze"] { --tier-rgb: 206, 137, 70; }
        #achievement-earned-modal[data-tier="Silver"] { --tier-rgb: 196, 196, 196; }
        #achievement-earned-modal[data-tier="Gold"] { --tier-rgb: 239, 191, 4; }
        #achievement-earned-modal[data-tier="Platinum"] { --tier-rgb: 164, 200, 225; }
        #achievement-earned-modal[data-tier="Diamond"] { --tier-rgb: 15, 82, 186; }
        #achievement-earned-modal[data-tier="Emerald"] { --tier-rgb: 80, 200, 120; }
        #achievement-earned-modal[data-tier="Ruby"] { --tier-rgb: 224, 17, 95; }
        #achievement-earned-overlay[data-tier="Bronze"] { --tier-rgb: 206, 137, 70; }
        #achievement-earned-overlay[data-tier="Silver"] { --tier-rgb: 196, 196, 196; }
        #achievement-earned-overlay[data-tier="Gold"] { --tier-rgb: 239, 191, 4; }
        #achievement-earned-overlay[data-tier="Platinum"] { --tier-rgb: 164, 200, 225; }
        #achievement-earned-overlay[data-tier="Diamond"] { --tier-rgb: 15, 82, 186; }
        #achievement-earned-overlay[data-tier="Emerald"] { --tier-rgb: 80, 200, 120; }
        #achievement-earned-overlay[data-tier="Ruby"] { --tier-rgb: 224, 17, 95; }
        #achievement-earned-body[data-tier="Bronze"] { --tier-rgb: 206, 137, 70; }
        #achievement-earned-body[data-tier="Silver"] { --tier-rgb: 196, 196, 196; }
        #achievement-earned-body[data-tier="Gold"] { --tier-rgb: 239, 191, 4; }
        #achievement-earned-body[data-tier="Platinum"] { --tier-rgb: 164, 200, 225; }
        #achievement-earned-body[data-tier="Diamond"] { --tier-rgb: 15, 82, 186; }
        #achievement-earned-body[data-tier="Emerald"] { --tier-rgb: 80, 200, 120; }
        #achievement-earned-body[data-tier="Ruby"] { --tier-rgb: 224, 17, 95; }
        .tier-summary-card {
            --tier-rgb: 156, 163, 175;
            border-radius: 1rem;
            padding: 0.6rem;
            border: 1px solid rgba(var(--tier-rgb), 0.45);
            background: linear-gradient(135deg, rgba(var(--tier-rgb), 0.14), rgba(255,255,255,0.03));
            display: grid;
            gap: 0.5rem;
            margin-top: 0.75rem;
            box-shadow: 0 12px 30px rgba(0,0,0,0.35);
            position: relative;
            overflow: hidden;
        }
        #account-tier-summary {
            max-width: 456px;
            width: 456px;
            min-height: 362px;
            height: 362px;
            align-self: stretch;
            display: flex;
            flex-direction: column;
        }
        .tier-summary-card::after {
            content: '';
            position: absolute;
            inset: -40% -10% auto auto;
            width: 220px;
            height: 220px;
            background: radial-gradient(circle, rgba(var(--tier-rgb), 0.35), transparent 70%);
            opacity: 0.8;
            pointer-events: none;
        }
        .tier-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
        }
        #account-tier-summary .tier-summary-header {
            align-items: center;
            justify-content: space-between;
        }
        #account-tier-summary .tier-summary-title {
            margin-right: 0.5rem;
        }
        #account-tier-summary .tier-summary-name {
            margin-top: 0;
            text-align: right;
            white-space: nowrap;
        }
        .tier-summary-title {
            font-size: 0.72rem;
            font-weight: 900;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.7);
        }
        .tier-summary-name {
            font-size: 1.55rem;
            font-weight: 900;
            color: #fff;
            letter-spacing: 0.01em;
            text-shadow: 0 6px 20px rgba(var(--tier-rgb), 0.6);
        }
        .tier-summary-badge {
            font-size: 0.76rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 0.3rem 0.55rem;
            border-radius: 999px;
            background: rgba(var(--tier-rgb), 0.18);
            border: 1px solid rgba(var(--tier-rgb), 0.45);
            color: rgba(255,255,255,0.95);
        }
        .tier-summary-body {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            justify-content: space-between;
        }
        .tier-summary-icon {
            width: 88px;
            height: 88px;
            border-radius: 20px;
            background: rgba(var(--tier-rgb), 0.18);
            border: 1px solid rgba(var(--tier-rgb), 0.45);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: rgba(255,255,255,0.6);
            font-weight: 800;
            line-height: 1;
        }
        #account-tier-summary .tier-summary-icon {
            width: 220px;
            height: 220px;
            border-radius: 38px;
            margin-top: 0.5rem;
        }
        #account-tier-summary .tier-summary-body {
            margin-top: 0.45rem;
        }
        #account-tier-summary .tier-summary-bar {
            height: 28px;
            margin-top: auto;
            width: 100%;
            display: block;
            flex-shrink: 0;
        }
        .tier-summary-stats {
            margin-left: auto;
            text-align: right;
        }
        #account-tier-summary .tier-summary-points {
            font-size: 1.45rem;
        }
        #account-tier-summary .tier-summary-next {
            font-size: 1.05rem;
        }
        .account-achievements-layout {
            position: relative;
            margin-top: 0.75r432em;
        }
        .account-achievements-layout::after {
            content: '';
            display: block;
            clear: both;
        }
        .account-achievements-layout #account-tier-summary {
            margin-top: 0;
            float: left;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }
        .account-achievements-layout #account-achievements-list {
            margin-top: 0;
        }
        .account-achievements-layout #account-achievements-list .text-xs {
            display: block;
            margin-top: 0.85rem;
        }
        @media (max-width: 900px) {
            .achievement-card {
                width: min(100%, 360px);
                margin-right: 0;
            }
        }
        @media (max-width: 900px) {
            .account-achievements-layout {
                display: block;
            }
            .account-achievements-layout #account-tier-summary {
                float: none;
                margin-right: 0;
                max-width: 100%;
                width: 100%;
            }
        }
        .achievement-filter-wrap {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .achievement-filters-pop {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            min-width: 240px;
            padding: 0.75rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(255,255,255,0.18);
            background: rgba(15, 15, 18, 0.92);
            box-shadow: 0 18px 40px rgba(0,0,0,0.45);
            display: none;
            z-index: 20;
        }
        .achievement-filters-pop.is-open {
            display: block;
        }
        .achievement-filters-row {
            display: grid;
            gap: 0.4rem;
        }
        .achievement-filters-row + .achievement-filters-row {
            margin-top: 0.6rem;
        }
        .achievement-filters-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-weight: 800;
            color: rgba(255,255,255,0.7);
        }
        .tier-summary-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
            transform: translateY(6px);
        }
        .tier-summary-points {
            font-weight: 800;
            color: #fff;
        }
        .tier-summary-next {
            font-size: 0.78rem;
            color: var(--text-muted);
        }
        .tier-summary-bar {
            height: 8px;
            border-radius: 999px;
            background: rgba(255,255,255,0.08);
            overflow: hidden;
        }
        .tier-summary-progress {
            height: 100%;
            width: 0%;
            border-radius: inherit;
            background: linear-gradient(90deg, rgba(var(--tier-rgb), 0.35), rgba(var(--tier-rgb), 0.9));
            transition: width 0.4s ease;
        }
        .tier-summary-card[data-tier="Extra"] { --tier-rgb: 156, 163, 175; }
        .tier-summary-card[data-tier="Supporting Cast"] { --tier-rgb: 37, 99, 235; }
        .tier-summary-card[data-tier="Co-Star"] { --tier-rgb: 124, 58, 237; }
        .tier-summary-card[data-tier="Lead"] { --tier-rgb: 185, 28, 28; }
        .tier-summary-card[data-tier="Box Office Icon"] { --tier-rgb: 231, 97, 67; }
        .tier-summary-card[data-tier="Oscar Nominee"] { --tier-rgb: 15, 118, 110; }
        .tier-summary-card[data-tier="Oscar Winner"] { --tier-rgb: 235, 186, 3; }

        /* Lists Page */
        .lists-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 1.3rem;
        }
        @media (max-width: 520px) {
            .lists-grid {
                display: grid;
                grid-template-columns: minmax(0, 1fr);
                gap: 1.2rem;
                margin-bottom: 2rem;
            }
        }
        .lists-movie-card {
            position: relative;
            padding: 1.1rem 1.2rem 1.2rem 1.2rem;
            border-radius: 1.1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.85rem;
            border: 1.2px solid rgba(255,255,255,0.13);
            background: rgba(255,255,255,0.06);
            transition: transform 0.18s ease, border-color 0.18s ease, background 0.18s ease;
            min-width: 0;
            max-width: 290px;
            width: 100%;
            min-width: 0;
            box-sizing: border-box;
        }
        .lists-remove-x {
            position: absolute;
            top: 0.7rem;
            right: 0.7rem;
            background: #b71c1c;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.35rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            z-index: 2;
            opacity: 0.82;
            transition: background 0.18s, opacity 0.18s;
        }
        .lists-remove-x:hover {
            background: #e53935;
            opacity: 1;
        }
        .lists-movie-card:hover {
            transform: translateY(-2px);
            border-color: rgba(20,184,166,0.38);
            background: rgba(20,184,166,0.07);
        }
        .lists-poster-btn {
            width: 100%;
            padding: 0;
            border: 0;
            background: transparent;
            cursor: pointer;
            text-align: left;
        }
        .lists-poster {
            width: 100%;
            aspect-ratio: 2 / 3;
            border-radius: 0.95rem;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06);
        }
        .lists-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .lists-title {
            color: #fff;
            font-weight: 950;
            font-size: 1.35rem;
            line-height: 1.18;
            overflow: hidden;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            min-height: 2.8em;
            max-height: 2.8em;
            text-align: center;
            align-items: center;
            justify-content: center;
        }
        .lists-title-year {
            color: rgba(255,255,255,0.68);
            font-weight: 900;
        }
        .lists-meta {
            margin-top: 0.15rem;
            color: rgba(255,255,255,0.76);
            font-weight: 850;
            font-size: 0.98rem;
            line-height: 1.25;
            overflow-wrap: anywhere;
        }
        .lists-meta-list {
            margin-top: 0.35rem;
            display: grid;
            gap: 6px;
        }
        .lists-meta-item {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            color: rgba(255,255,255,0.76);
            font-weight: 850;
            font-size: 0.98rem;
            line-height: 1.25;
            overflow-wrap: anywhere;
        }
        .lists-bullet {
            color: var(--brand);
            font-weight: 950;
            line-height: 1;
            margin-top: 2px;
            flex: 0 0 auto;
        }
        .lists-card-actions {
            margin-top: 0.35rem;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .lists-watch-options-btn {
            width: 100%;
            border-radius: 0.85rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.95rem;
            font-weight: 850;
            background: rgba(0, 188, 212, 0.18);
            border: 1px solid rgba(0, 188, 212, 0.32);
            color: #fff;
            cursor: pointer;
            transition: background 0.18s, border-color 0.18s;
        }
        .lists-watch-options-btn:hover {
            background: rgba(0, 188, 212, 0.32);
            border-color: #1de9b6;
        }

        .lists-platforms {
            margin-top: 0.55rem;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }
        .lists-platform-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.22rem 0.5rem;
            border-radius: 999px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.82);
            font-weight: 850;
            font-size: 0.78rem;
            line-height: 1;
            white-space: nowrap;
        }
        .lists-platform-pill.more {
            background: rgba(20,184,166,0.10);
            border-color: rgba(20,184,166,0.35);
            color: rgba(20,184,166,0.95);
        }

        .nav-actions { display: flex; align-items: center; gap: 0.75rem; }
        .nav-auth-btn {
            padding: 0.5rem 0.9rem;
            border-radius: 0.75rem;
            font-weight: 800;
            font-size: 0.875rem;
            background: rgba(255,255,255,0.05);
            color: white;
            border: 1px solid rgba(255,255,255,0.10);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
        }
        .nav-auth-btn:hover { background: rgba(255,255,255,0.10); }
        .nav-auth-btn.icon-only {
            padding: 0.2rem;
            width: 64px;
            height: 64px;
            border-radius: 999px;
        }

        .log-fab {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            z-index: 110;
            background: rgba(24, 24, 27, 0.92);
            color: white;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 999px;
            padding: 0.6rem 0.9rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.35);
        }
        .log-fab:hover { border-color: rgba(255,255,255,0.22); }
        .log-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.6rem;
            height: 1.6rem;
            padding: 0 0.45rem;
            border-radius: 999px;
            background: rgba(20, 184, 166, 0.35);
            border: 1px solid rgba(20, 184, 166, 0.55);
            font-size: 0.8rem;
            line-height: 1;
        }
        .log-panel {
            position: fixed;
            left: 1.5rem;
            bottom: 4.5rem;
            width: min(720px, calc(100vw - 3rem));
            max-height: min(60vh, 520px);
            z-index: 120;
            background: rgba(9, 9, 11, 0.96);
            color: white;
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 0.9rem;
            box-shadow: 0 18px 45px rgba(0,0,0,0.5);
            overflow: hidden;
            display: none;
        }
        .log-panel.open { display: flex; flex-direction: column; }
        .log-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            gap: 0.75rem;
        }
        .log-panel-title { font-weight: 800; }
        .log-panel-actions { display: flex; gap: 0.5rem; }
        .log-btn {
            background: rgba(255,255,255,0.08);
            color: white;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 0.6rem;
            padding: 0.45rem 0.65rem;
            cursor: pointer;
            font-weight: 700;
        }
        .log-btn:hover { background: rgba(255,255,255,0.12); }
        .log-body {
            overflow: auto;
            padding: 0.75rem 0.9rem;
            font-family: var(--font-family);
            font-size: 0.85rem;
            line-height: 1.35;
            white-space: pre-wrap;
        }
        .log-item { padding: 0.4rem 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
        .log-item:last-child { border-bottom: none; }
        .log-meta { opacity: 0.75; }
        .log-level-error { color: #fb7185; }
        .log-level-warn { color: #fbbf24; }
        .log-level-info { color: #34d399; }

        /* Footer */
        footer {
            background-color: var(--surface);
            border-top: 1px solid var(--border);
            margin-top: auto;
            padding: 2rem 0;
        }
        footer #footer-icons a {
            color: var(--text-muted);
        }
        footer #footer-icons a:hover {
            color: #fff;
        }

        /* Typography Helpers */
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-xl { font-size: 1.25rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .text-5xl { font-size: 3rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-mono { font-family: var(--font-family); }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .text-brand { color: var(--brand); }
        .text-white { color: white; }
        .text-gray { color: var(--text-muted); }
        .uppercase { text-transform: uppercase; letter-spacing: 0.05em; }
        .capitalize { text-transform: capitalize; }
        .mb-2 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        /* Increased label-to-input gap for submit page */
        .label-gap { margin-bottom: 0.5rem !important; }
        /* Force spacing when an input/select/textarea follows a submit label */
        .submit-label + .input-field,
        .submit-label + .select-field,
        .submit-label + .textarea-field { margin-top: 0.5rem !important; }
        /* Handle wrapped controls (e.g., sliders, quote input) */
        .submit-label + .slider-container { margin-top: 0.5rem !important; }
        .submit-label + .relative { margin-top: 0.5rem !important; }
        /* Handle grid blocks (e.g., External Ratings) and read-only inputs */
        .submit-label + .grid { margin-top: 0.5rem !important; }

        /* Form validation helpers */
        .field-error-msg {
            color: rgba(254, 202, 202, 0.95);
            font-size: 0.78rem;
            font-weight: 800;
            margin-bottom: 0.35rem;
            letter-spacing: 0.01em;
        }
        .field-error-outline {
            outline: 2px solid rgba(239, 68, 68, 0.40);
            outline-offset: 2px;
            border-color: rgba(239, 68, 68, 0.55) !important;
        }
        
        /* Mobile Menu */
        #mobile-menu { display: none; }
        #mobile-menu.open { display: block; border-top: 1px solid var(--border); padding: 1rem; }
        .mobile-link {
            display: block;
            padding: 0.8rem 0.9rem;
            color: rgba(255,255,255,0.92);
            font-weight: 800;
            letter-spacing: 0.03em;
            border-radius: 0.75rem;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.03);
        }
        .mobile-link:hover {
            background: rgba(255,255,255,0.07);
            color: #fff;
            border-color: rgba(255,255,255,0.25);
        }

        @media (max-width: 768px) {
            .text-5xl { font-size: 2.25rem; }
            .text-4xl { font-size: 1.75rem; }
            .navbar { padding: 0; }
        }

        @media (max-width: 520px) {
            :root { --header-height: 84px; }
            .container { padding: 0 1rem; }
            .nav-brand { font-size: 1rem; gap: 0.35rem; }
            .nav-auth-btn { font-size: 0.8rem; padding: 0.4rem 0.7rem; }
            .nav-auth-btn.icon-only { width: 48px; height: 48px; }
            .icon-wrapper { width: 72px; height: 72px; }
            .icon-wrapper img { width: 72px; height: 72px; }
            .home-hero-logo { width: 84px; height: 84px; }

            .auth-overlay {
                align-items: flex-start;
                padding: 1rem;
                font-size: 1rem;
                letter-spacing: 0.005em;
            }
            .auth-modal {
                max-height: calc(100vh - 2rem);
                overflow: auto;
                padding: 1rem;
                font-size: 0.98rem;
            }
            .auth-modal-title { font-size: 0.98rem; }
            .auth-modal-close { padding: 0.4rem 0.6rem; }
            .auth-modal-header { flex-wrap: wrap; }
            .auth-modal-actions { flex-wrap: wrap; justify-content: stretch; }
            .auth-modal .btn { width: 100%; }
            .auth-modal .input-field,
            .auth-modal .select-field,
            .auth-modal input,
            .auth-modal select,
            .auth-modal textarea {
                width: 100%;
                min-width: 0 !important;
            }

            #lists-sortfilter-overlay [style*="grid-template-columns: 1fr 1fr"],
            #library-sortfilter-overlay [style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            #movie-search-filters-toggle {
                position: static !important;
                width: 100%;
                margin-top: 0.5rem;
            }

            .log-fab { left: 1rem; bottom: 1rem; padding: 0.5rem 0.75rem; }
            .log-panel { left: 1rem; bottom: 4rem; width: calc(100vw - 2rem); }
            .log-panel-header { flex-wrap: wrap; }
            .log-panel-actions { width: 100%; justify-content: flex-end; }
            .toast { left: 1rem; right: 1rem; max-width: calc(100vw - 2rem); }
        }

        @media (max-width: 420px) {
            .text-5xl { font-size: 2rem; }
            .text-4xl { font-size: 1.5rem; }
            .nav-brand span { font-size: 0.95rem; }
            .lists-grid { gap: 1rem; }
        }

        /* Dashboard helpers */
        .dash-mini-kpi {
            padding: 0.9rem 0.95rem;
            border-radius: 0.75rem;
            background: var(--glass-bg);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .dash-kpi-strip-large {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        .dash-kpi-tile {
            padding: 1rem 1.1rem;
            border-radius: 0.9rem;
            border: 1px solid rgba(255,255,255,0.08);
            background: var(--glass-bg);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .dash-kpi-tile .dash-kpi-title {
            font-size: 0.72rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        .dash-kpi-sub {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.68);
        }
        .dash-kpi-grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        .dash-kpi-grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        .dash-kpi-span-2 {
            grid-column: span 2;
        }
        .dash-kpi-chart {
            padding: 1.25rem;
            border-radius: 0.95rem;
            border: 1px solid rgba(255,255,255,0.08);
            background: var(--glass-bg);
            display: grid;
            gap: 12px;
        }
        .dash-gen-top {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 210px;
            gap: 16px;
            margin: 0 auto 16px;
            max-width: 1120px;
            width: 100%;
            align-items: stretch;
        }
        .dash-gen-bottom {
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 16px;
            margin: 0 auto 16px;
            max-width: 1120px;
            width: 100%;
        }
        @media (max-width: 1160px) {
            .dash-gen-bottom {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            }
        }
        .dash-dashboard-row {
            max-width: 1120px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }
        .dash-pane-wrap {
            max-width: 1120px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }
        .dash-pie-row {
            display: grid;
            grid-template-columns: 240px minmax(0, 1fr);
            gap: 14px;
            align-items: center;
        }
        .dash-kpi-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .dash-general-pie-toggle {
            display: inline-flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .dash-genre-summary {
            display: flex;
            gap: 18px;
            align-items: baseline;
            flex-wrap: wrap;
        }
        .dash-genre-stat {
            display: grid;
            gap: 2px;
        }
        .dash-genre-bars {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(48px, 1fr));
            gap: 12px;
            align-items: end;
            height: 220px;
            padding: 6px 2px 0;
        }
        .dash-genre-full {
            width: 100%;
        }
        .dash-genre-full .dash-chart-scroll {
            max-height: none;
        }
        .dash-genre-full .dash-genre-bars {
            height: 220px;
        }
        .dash-genre-bar {
            display: grid;
            gap: 6px;
            align-items: end;
            justify-items: center;
        }
        .dash-genre-bar-track {
            width: 100%;
            height: 160px;
            border-radius: 0.8rem;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            overflow: hidden;
            display: flex;
            align-items: flex-end;
        }
        .dash-genre-bar-fill {
            width: 100%;
            height: 0%;
            min-height: 4px;
            transition: height 0.7s ease;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 6px;
            position: relative;
            text-align: center;
            color: rgba(255,255,255,0.92);
        }
        .dash-genre-bar-metrics {
            font-size: 0.7rem;
            line-height: 1.15;
            text-shadow: 0 1px 2px rgba(255,255,255,0.35);
            color: #111;
            display: grid;
            gap: 2px;
        }
        .dash-genre-bar-count {
            font-size: 0.65rem;
            opacity: 0.85;
        }
        .dash-genre-bar-label {
            font-size: 0.7rem;
            text-align: center;
            color: var(--text-muted);
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .dash-genre-bar-value {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.85);
        }
        .dash-genre-bars-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
        }
        .dash-pie {
            width: 240px;
            height: 240px;
            border-radius: 999px;
            position: relative;
            display: grid;
            place-items: center;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
        }
        .dash-pie::after {
            content: '';
            width: 62%;
            height: 62%;
            border-radius: 999px;
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: inset 0 0 24px rgba(0,0,0,0.35);
        }
        .dash-pie-center {
            position: absolute;
            z-index: 1;
            text-align: center;
            display: grid;
            gap: 2px;
        }
        .dash-pie-value {
            font-size: 1.45rem;
            font-weight: 800;
            color: #fff;
        }
        .dash-pie-value-sm {
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
        }
        .dash-pie-label {
            font-size: 0.7rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        @media (max-width: 1100px) {
            .dash-gen-top {
                grid-template-columns: 1fr;
            }
        }
        .dash-watch-label.dash-watch-home {
            color: var(--brand) !important;
        }
        .dash-watch-label.dash-watch-theater {
            color: var(--accent-2, var(--brand)) !important;
        }
        .dash-pie-duo {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
            grid-column: 1 / -1;
        }
        @media (max-width: 980px) {
            .dash-pie-duo { grid-template-columns: 1fr; }
        }
        .dash-vertical-labels {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #fff;
        }
        .dash-watch-method-card .dash-vertical-labels {
            grid-template-columns: 1fr;
            gap: 12px;
            text-align: center;
        }
        .dash-watch-value {
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .dash-watch-count {
            font-size: 0.7rem;
        }
        .dash-vertical-labels .dash-highlight-count {
            color: #fff;
        }
        .dash-highlight-list {
            display: grid;
            gap: 12px;
            height: 100%;
            grid-auto-rows: 1fr;
        }
        .dash-highlights-card {
            min-height: 220px;
        }
        .dash-most-watched-card {
            min-height: 220px;
        }
        .dash-highlight-combined {
            display: grid;
            gap: 14px;
            --mw-poster-size: 160px;
        }
        .dash-highlight-combined-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .dash-highlight-combined-grid {
                grid-template-columns: 1fr;
            }
        }
        .dash-highlight-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 0.9rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.04);
            height: 100%;
        }
        .dash-highlight-card-title {
            font-size: 0.75rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
        }
        .dash-person-card {
            display: grid;
            gap: 10px;
            justify-items: center;
            text-align: center;
        }
        .dash-person-poster {
            width: min(100%, var(--mw-poster-size));
            aspect-ratio: 2 / 3;
            border-radius: 0.8rem;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.08);
            display: grid;
            place-items: center;
        }
        .dash-person-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .dash-person-poster.is-empty {
            background: rgba(255,255,255,0.05);
        }
        .dash-person-name {
            font-weight: 700;
            color: #fff;
            font-size: 1rem;
        }
        .dash-person-count {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }
        .dash-kpi-top-count {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            text-align: center;
        }
        .dash-highlight-row {
            display: grid;
            grid-template-columns: 88px minmax(0, 1fr);
            gap: 10px;
            align-items: center;
            padding: 0.7rem 0.75rem;
            border-radius: 0.65rem;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.04);
        }
        .dash-highlight-row.has-avatar {
            grid-template-columns: 104px 88px minmax(0, 1fr);
            min-height: 96px;
        }
        .dash-highlight-avatar {
            width: 120px;
            height: 120px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.08);
            display: grid;
            place-items: center;
        }
        .dash-highlight-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .dash-highlight-avatar.is-empty {
            background: rgba(255,255,255,0.05);
        }
        .dash-most-movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(var(--mw-poster-min, 140px), 1fr));
            gap: 14px;
            align-items: start;
            justify-items: center;
        }
        .dash-most-movie-card {
            max-width: 180px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 100%;
        }
        .dash-most-movie-poster {
            width: min(100%, var(--mw-poster-size));
            aspect-ratio: 2 / 3;
            border-radius: 0.8rem;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.06);
        }
        .dash-most-movie-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .dash-most-movie-placeholder {
            width: 100%;
            height: 100%;
            display: grid;
            place-items: center;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .dash-most-movie-title {
            font-weight: 700;
            color: #fff;
            font-size: 0.95rem;
            line-height: 1.2;
        }
        .dash-most-movie-meta {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .dash-most-movie-more,
        .dash-kpi-more {
            font-size: 0.85rem;
            font-weight: 700;
            color: #fff;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: auto;
            width: 100%;
            justify-content: center;
            text-align: center;
        }
        .dash-most-movie-more span,
        .dash-kpi-more span {
            color: var(--text-muted);
            font-weight: 600;
        }
        .dash-kpi-tie-list {
            display: grid;
            gap: 10px;
        }
        .dash-kpi-tie-btn {
            display: grid;
            grid-template-columns: 46px minmax(0, 1fr);
            gap: 10px;
            align-items: center;
            padding: 0.65rem 0.85rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            color: #fff;
            text-align: left;
            cursor: pointer;
        }
        .dash-kpi-tie-avatar {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06);
            display: grid;
            place-items: center;
        }
        .dash-kpi-tie-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .dash-kpi-tie-btn:hover {
            border-color: rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.08);
        }
        .dash-kpi-tie-title {
            font-weight: 700;
        }
        .dash-kpi-tie-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .dash-most-movie-rating {
            font-weight: 400;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }
        .dash-tier-pill {
            --tier-rgb: 255, 255, 255;
            padding: 0.2rem 0.45rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            border: 1px solid rgba(var(--tier-rgb), 0.55);
            background: rgba(var(--tier-rgb), 0.2);
            color: #fff;
        }
        .dash-tier-pill[data-tier="S-Tier"] { --tier-rgb: var(--tier-s-rgb); }
        .dash-tier-pill[data-tier="A-Tier"] { --tier-rgb: var(--tier-a-rgb); }
        .dash-tier-pill[data-tier="B-Tier"] { --tier-rgb: var(--tier-b-rgb); }
        .dash-tier-pill[data-tier="C-Tier"] { --tier-rgb: var(--tier-c-rgb); }
        .dash-tier-pill[data-tier="D-Tier"] { --tier-rgb: var(--tier-d-rgb); }
        .dash-tier-pill[data-tier="F-Tier"] { --tier-rgb: var(--tier-f-rgb); }
        .dash-ratings-avg-grid {
            display: grid;
            gap: 12px;
        }
        .dash-ratings-avg-layout {
            display: grid;
            grid-template-columns: minmax(150px, 0.8fr) minmax(0, 2fr);
            grid-template-rows: 70px 70px;
            gap: 12px;
            align-items: stretch;
        }
        .dash-ratings-avg-main {
            display: grid;
            align-content: start;
            gap: 8px;
            grid-row: 1 / span 2;
        }
        .dash-ratings-avg-subgrid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            grid-row: 1 / span 2;
            grid-auto-rows: 70px;
        }
        .dash-ratings-avg-main .dash-ratings-avg-tile {
            height: calc(70px * 2 + 12px);
        }
        .dash-ratings-avg-main .dash-ratings-avg-value {
            font-size: 3rem;
            line-height: 1;
        }
        .dash-ratings-avg-main .dash-ratings-avg-sub {
            font-size: 0.85rem;
        }
        .dash-ratings-avg-subgrid .dash-ratings-avg-tile {
            height: 70px;
        }
        @media (max-width: 900px) {
            .dash-ratings-avg-layout {
                grid-template-columns: 1fr;
            }
            .dash-ratings-avg-subgrid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        .dash-ratings-avg-tile {
            padding: 0.8rem 0.9rem;
            border-radius: 0.8rem;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.04);
            display: grid;
            gap: 4px;
        }
        .dash-ratings-avg-label {
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
        }
        .dash-ratings-avg-value {
            font-size: 1.35rem;
            font-weight: 800;
            color: #fff;
        }
        .dash-ratings-avg-row {
            display: inline-flex;
            align-items: baseline;
            gap: 6px;
        }
        .dash-ratings-avg-sub {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
        }
        .dash-ratings-directors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }
        .dash-kpi-movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 14px;
        }
        .library-movie-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
            justify-content: start;
            justify-items: start;
        }
        .library-movie-grid .dash-kpi-movie-card {
            align-items: flex-start;
            width: 100%;
        }
        .library-movie-grid .dash-kpi-movie-poster {
            width: 100%;
            max-width: none;
        }
        .library-grid-title {
            font-weight: 700;
            line-height: 1.2;
        }
        .library-grid-year {
            color: rgba(255,255,255,0.65);
            font-weight: 700;
        }
        .library-grid-meta {
            font-size: 0.75rem;
            line-height: 1.2;
        }
        .dash-kpi-movie-card {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        .dash-kpi-movie-poster {
            width: 100%;
            max-width: 140px;
            aspect-ratio: 2 / 3;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.06);
            cursor: pointer;
        }
        .dash-kpi-compact-posters .dash-kpi-movie-grid {
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 8px;
            justify-items: center;
        }
        .dash-kpi-compact-posters [data-dash-movie-id] {
            width: 70px !important;
            max-width: 70px !important;
            border-radius: 10px;
            margin-left: auto;
            margin-right: auto;
        }
        .dash-kpi-compact-posters .dash-kpi-movie-poster {
            width: 70px;
            max-width: 70px;
            border-radius: 10px;
        }
        #dash-pane-general.dash-mode-total [data-kpi-mode="unique"],
        #dash-pane-general.dash-mode-unique [data-kpi-mode="total"] {
            display: none !important;
        }
        .dash-highlight-label {
            font-size: 0.9rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        .dash-highlight-main {
            display: grid;
            gap: 2px;
        }
        .dash-highlight-name {
            font-weight: 700;
            color: #fff;
            font-size: 1.25rem;
        }
        .dash-highlight-count {
            font-size: 1rem;
            color: rgba(255,255,255,0.7);
        }
        @media (max-width: 1000px) {
            .dash-gen-top { grid-template-columns: 1fr; }
            .dash-pie-row { grid-template-columns: 1fr; justify-items: center; }
            .dash-pie-legend { width: 100%; }
        }
        .dash-kpi-chart-title {
            font-size: 0.88rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            font-weight: 700;
        }
        .dash-donut-row {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 16px;
            align-items: center;
        }
        .dash-donut {
            width: 180px;
            height: 180px;
            border-radius: 999px;
            background: conic-gradient(var(--brand) 0deg 180deg, var(--accent-2, var(--brand)) 180deg 300deg, rgba(255,255,255,0.08) 300deg 360deg);
            position: relative;
            display: grid;
            place-items: center;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
        }
        .dash-donut::after {
            content: '';
            width: 62%;
            height: 62%;
            border-radius: 999px;
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: inset 0 0 24px rgba(0,0,0,0.35);
        }
        .dash-donut-center {
            position: absolute;
            text-align: center;
            z-index: 1;
            display: grid;
            gap: 2px;
        }
        .dash-donut-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: #fff;
        }
        .dash-donut-sub {
            font-size: 0.78rem;
            color: var(--text-muted);
        }
        .dash-donut-legend {
            display: grid;
            gap: 10px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.85);
        }
        .dash-pie-legend {
            display: grid;
            grid-template-columns: repeat(var(--legend-cols, 2), minmax(0, 1fr));
            gap: 10px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.85);
        }
        .dash-pie-legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 0.5rem 0.65rem;
            border-radius: 0.7rem;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
        }
        .dash-pie-legend-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.82rem;
            color: var(--text-muted);
            min-width: 0;
        }
        .dash-pie-legend-label span:last-child,
        .dash-pie-legend-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dash-stack-bar {
            width: 30px;
            height: 150px;
            margin: 10px auto 12px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            box-sizing: border-box;
        }
        .dash-stack-fill {
            width: 100%;
            height: 0%;
            border-radius: 0;
            transition: height 0.6s ease;
        }
        .dash-stack-fill:first-child {
            border-top-left-radius: 999px;
            border-top-right-radius: 999px;
        }
        .dash-stack-fill:last-child {
            border-bottom-left-radius: 999px;
            border-bottom-right-radius: 999px;
        }
        .dash-stack-fill.is-home {
            background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 82%);
        }
        .dash-stack-fill.is-theater {
            background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 82%);
        }
        .dash-stack-fill.is-strong {
            background: hsl(var(--heatmap-h, 156), var(--heatmap-s, 55%), 44%);
        }
        .dash-donut-legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 0.5rem 0.65rem;
            border-radius: 0.7rem;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .dash-donut-legend-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.82rem;
            color: var(--text-muted);
        }
        .dash-fav-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        @media (min-width: 640px) {
            .dash-fav-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        @media (min-width: 900px) {
            .dash-fav-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        @media (min-width: 1200px) {
            .dash-fav-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        }
        .dash-tier-grid {
            gap: 8px;
        }
        @media (min-width: 1200px) {
            .dash-tier-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        }
        .dash-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
        }
        .dash-rank-list {
            display: grid;
            gap: 10px;
        }
        .dash-rank-row {
            display: grid;
            grid-template-columns: 86px minmax(0, 1fr);
            gap: 8px;
            align-items: center;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 0.7rem;
            padding: 0.55rem 0.7rem;
        }
        .dash-rank-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }
        .dash-rank-name {
            font-weight: 700;
            color: #fff;
            font-size: 0.98rem;
        }
        .dash-rank-count {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.15rem;
        }
        .dash-rank-bar {
            margin-top: 6px;
            height: 6px;
            border-radius: 999px;
            background: rgba(255,255,255,0.08);
            overflow: hidden;
        }
        .dash-rank-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--brand), var(--accent-2, var(--brand)));
            border-radius: 999px;
            transition: width 0.6s ease;
        }
        .dash-ratings-bar {
            height: 8px;
            border-radius: 999px;
            background: rgba(255,255,255,0.08);
            overflow: hidden;
            margin-top: 10px;
        }
        .dash-ratings-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--brand), var(--accent-2, var(--brand)));
            border-radius: 999px;
            transition: width 0.6s ease;
        }
        @media (max-width: 900px) {
            .dash-donut-row { grid-template-columns: 1fr; justify-items: center; }
            .dash-donut-legend { width: 100%; }
            .dash-kpi-span-2 { grid-column: span 1; }
        }

        .dash-kpi-board {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 16px;
        }
        .dash-kpi-strip {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .dash-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }
        .dash-kpi-card {
            position: relative;
            padding: 1.25rem;
            border-radius: 0.95rem;
            overflow: hidden;
        }
        .dash-kpi-card::before {
            content: '';
            position: absolute;
            inset: 0 0 auto 0;
            height: 3px;
            background: linear-gradient(90deg, var(--brand), var(--accent-2, var(--brand)));
            opacity: 0.75;
        }
        .dash-people-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }
        .dash-people-card {
            display: grid;
            gap: 8px;
        }
        .dash-people-poster {
            width: 100%;
            aspect-ratio: 2 / 3;
            border-radius: 0.8rem;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.06);
            display: grid;
            place-items: center;
        }
        .dash-people-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .dash-people-name {
            font-weight: 700;
            color: #fff;
            font-size: 0.95rem;
        }
        .dash-people-meta {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }
        .dash-kpi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 0.85rem;
        }
        .dash-kpi-title {
            font-size: 0.78rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
        }
        .dash-kpi-value-lg {
            font-size: 2.4rem;
            font-weight: 800;
            color: #fff;
            line-height: 1;
        }
        .dash-kpi-value-md {
            font-size: 1.8rem;
            font-weight: 800;
            color: #fff;
            line-height: 1.1;
        }
        .dash-kpi-value-sm {
            font-size: 1.2rem;
            font-weight: 800;
            color: #fff;
            line-height: 1.2;
        }
        .dash-kpi-label {
            margin-top: 0.35rem;
            font-size: 0.72rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .dash-kpi-meta {
            margin-top: 0.35rem;
            font-size: 0.78rem;
            color: rgba(255,255,255,0.75);
        }
        .dash-kpi-note {
            margin-top: 0.55rem;
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .dash-kpi-divider {
            height: 1px;
            background: rgba(255,255,255,0.06);
            margin: 0.9rem 0;
        }
        .dash-kpi-metric-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
        .dash-kpi-metric-grid-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        .dash-kpi-hero {
            grid-column: span 2;
        }
        .dash-kpi-hero-main {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }
        .dash-kpi-hero-sub {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
        .dash-kpi-metric {
            padding: 0.75rem 0.85rem;
            border-radius: 0.75rem;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.08);
        }
        @media (max-width: 1100px) {
            .dash-kpi-board { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .dash-kpi-hero { grid-column: span 2; }
        }
        @media (max-width: 720px) {
            .dash-kpi-board { grid-template-columns: 1fr; }
            .dash-kpi-hero { grid-column: span 1; }
            .dash-kpi-hero-main,
            .dash-kpi-hero-sub {
                grid-template-columns: 1fr;
            }
            .dash-kpi-metric-grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .dash-kpi-clickable {
            cursor: pointer;
            transition: transform 140ms ease, background 140ms ease, border-color 140ms ease;
        }
        .dash-kpi-clickable:hover {
            transform: translateY(-1px);
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.22);
        }
        .dash-mini-kpi-value { line-height: 1; }
        .dash-mini-kpi-label {
            margin-top: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.07em;
        }

        .dash-tier-card {
            padding: 0.9rem 0.95rem;
            border-radius: 0.85rem;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .dash-tier-progress {
            height: 9px;
            background: rgba(255,255,255,0.06);
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .dash-tier-progressFill { height: 100%; }
        .dash-tier-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.07em;
        }
        .dash-tier-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .dash-movie-row {
            padding: 0.6rem 0.75rem;
            border-radius: 0.7rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Help-text emphasis (scores + tiers) */
        .dash-help-score {
            /* Match the CinemaTracker logo color */
            color: var(--brand);
            font-weight: 900;
        }
        .dash-help-tier {
            font-weight: 900;
        }
        .dash-help-tier[data-tier-letter="S"] { color: rgb(var(--tier-s-rgb)); }
        .dash-help-tier[data-tier-letter="A"] { color: rgb(var(--tier-a-rgb)); }
        .dash-help-tier[data-tier-letter="B"] { color: rgb(var(--tier-b-rgb)); }
        .dash-help-tier[data-tier-letter="C"] { color: rgb(var(--tier-c-rgb)); }
        .dash-help-tier[data-tier-letter="D"] { color: rgb(var(--tier-d-rgb)); }
        .dash-help-tier[data-tier-letter="F"] { color: rgb(var(--tier-f-rgb)); }

        /* Feed */
        .feed-actor {
            color: rgba(255,255,255,0.95);
            font-weight: 900;
        }

        .feed-sort-btn {
            padding: 0.55rem 0.8rem;
            font-size: 0.9rem;
        }

        .feed-card-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .feed-card-poster {
            width: 54px;
            height: 78px;
            border-radius: 0.75rem;
            overflow: hidden;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.06);
            flex: 0 0 auto;
        }
        .feed-card-main {
            min-width: 0;
            flex: 1 1 220px;
        }
        .feed-card-actor {
            margin-left: auto;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: nowrap;
            flex: 0 0 auto;
            min-width: 84px;
            text-align: center;
        }
        .feed-card-actor-name {
            color: rgba(255,255,255,0.92);
            font-weight: 900;
            font-size: 0.85rem;
            letter-spacing: 0.01em;
        }

        .feed-item-card {
            cursor: pointer;
        }
        .feed-card-details {
            display: none;
            margin-top: 0.75rem;
        }
        .feed-item-card.is-open .feed-card-details {
            display: block;
        }

        /* Library (My Movies) */
        .library-card-row {
            display: flex;
            gap: 14px;
            align-items: flex-start;
            flex-wrap: nowrap;
        }
        .library-card-left {
            flex: 0 0 auto;
            width: 128px;
            min-width: 128px;
            max-width: 128px;
        }
        .library-card-poster {
            width: 100%;
            height: 190px;
            border-radius: 0.95rem;
            overflow: hidden;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.06);
        }

        .library-poster-flip {
            position: relative;
            width: 100%;
            height: 100%;
            perspective: 900px;
        }
        .library-poster-flip-inner {
            position: absolute;
            inset: 0;
            transform-style: preserve-3d;
            transition: transform 560ms cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .library-card-poster:hover .library-poster-flip-inner {
            transform: rotateY(180deg);
        }
        .library-poster-face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .library-poster-front {
            background: rgba(255,255,255,0.02);
        }
        .library-poster-back {
            transform: rotateY(180deg);
            background: rgba(0,0,0,0.78);
            border: 1px solid rgba(255,255,255,0.10);
            padding: 0.6rem 0.65rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
        }
        .library-poster-back-line {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: baseline;
        }
        .library-poster-back-key {
            color: rgba(255,255,255,0.60);
            font-weight: 850;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            white-space: nowrap;
            flex: 0 0 auto;
            text-align: left;
            font-size: 0.72rem;
        }
        .library-poster-back-val {
            color: rgba(255,255,255,0.94);
            font-weight: 900;
            text-align: right;
            min-width: 0;
            flex: 1 1 auto;
            display: block;
            width: 100%;
            font-size: 0.78rem;
            line-height: 1.25;
            white-space: normal;
            overflow-wrap: normal;
            word-break: normal;
            hyphens: none;
        }
        .library-under {
            margin-top: 0.55rem;
            display: grid;
            gap: 6px;
            font-size: 0.72rem;
            line-height: 1.25;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        .library-under-line {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: baseline;
            flex-wrap: nowrap;
            width: 100%;
            max-width: 100%;
        }
        .library-under-key {
            color: rgba(255,255,255,0.55);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            white-space: nowrap;
            flex: 0 0 auto;
            text-align: left;
        }
        .library-under-val {
            color: rgba(255,255,255,0.92);
            font-weight: 850;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            flex: 1 1 auto;
        }
        .library-under-val-wrap {
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: normal;
            min-width: 0;
            flex: 1 1 auto;
        }

        .library-under-val-multiline {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .library-title-line {
            display: inline;
            white-space: normal;
            font-size: 1.18rem;
            font-weight: 950;
            letter-spacing: 0.01em;
        }
        .library-title-meta {
            color: rgba(255,255,255,0.88);
            font-weight: 900;
            font-size: 1.06rem;
        }

        .library-title-sep {
            color: var(--brand);
            font-weight: 950;
        }

        .library-subratings .dash-quote-pill {
            font-size: 0.98rem;
            padding: 0.32rem 0.72rem;
            border-color: rgba(255,255,255,0.16);
            background: rgba(0,0,0,0.26);
            letter-spacing: 0.02em;
        }
        .library-chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.72rem;
        }
        .library-watch-range {
            display: grid;
            gap: 0.45rem;
        }
        .library-watch-rail {
            position: relative;
            height: 36px;
            display: flex;
            align-items: center;
        }
        .library-watch-rail-track {
            position: absolute;
            left: 0;
            right: 0;
            height: 6px;
            border-radius: 999px;
            background: rgba(255,255,255,0.10);
            border: 1px solid rgba(255,255,255,0.12);
        }
        .library-watch-rail-fill {
            position: absolute;
            height: 6px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(20,184,166,0.4), rgba(20,184,166,0.9));
            left: 0;
            right: 100%;
        }
        .library-watch-handle {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: #0f172a;
            border: 2px solid rgba(255,255,255,0.75);
            box-shadow: 0 6px 14px rgba(0,0,0,0.45);
            transform: translate(-50%, 0);
            cursor: grab;
        }
        .library-watch-handle:active {
            cursor: grabbing;
        }
        .library-watch-rail.is-disabled .library-watch-handle {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .library-watch-rail.is-disabled .library-watch-rail-fill {
            opacity: 0.3;
        }
        .library-watch-range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
        }
        @media (max-width: 520px) {
            .library-card-row { flex-wrap: wrap; }
            .library-card-left { width: 116px; min-width: 116px; max-width: 116px; }
            .library-card-poster { width: 100%; height: 172px; }
        }
        .user-icon {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: 0 10px 24px rgba(0,0,0,0.30);
            color: rgba(255,255,255,0.92);
            flex: 0 0 auto;
            overflow: hidden;
            background: rgba(255,255,255,0.06);
        }
        .user-icon svg {
            width: 16px;
            height: 16px;
            stroke-width: 2.2;
        }
        .user-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .ai-loading-visual {
            margin-top: 0.65rem;
            display: flex;
            justify-content: center;
        }
        .ai-loading-visual img {
            width: 100%;
            max-width: 460px;
            border-radius: 0.85rem;
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: 0 16px 28px rgba(0,0,0,0.35);
            opacity: 0.92;
        }
        
        .feed-metrics {
            margin-top: 0.35rem;
            font-size: 0.95rem;
            line-height: 1.15;
            display: flex;
            align-items: baseline;
            gap: 10px;
            flex-wrap: wrap;
        }
        .feed-metrics .dash-help-score {
            font-size: 1.15rem;
        }
        .feed-metrics .dash-help-tier {
            font-size: 1.0rem;
        }

        /* AI Picks */
        .ai-toggle {
            display: inline-flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .ai-section {
            display: grid;
            gap: 0.85rem;
        }
        .ai-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 0 18px 32px var(--glass-shadow);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 0.95rem;
            padding: 1rem;
        }
        .ai-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
        .ai-grid-2.ai-grid-single {
            grid-template-columns: minmax(0, 1fr);
        }
        @media (max-width: 900px) {
            .ai-grid-2 { grid-template-columns: 1fr; }
        }
        .ai-slider-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }
        .ai-slider-val {
            min-width: 42px;
            text-align: right;
            font-weight: 800;
            color: rgba(255,255,255,0.85);
        }
        .ai-slider-input {
            width: 78px;
            min-width: 78px;
            padding: 0.5rem 0.6rem;
            text-align: center;
        }
        .ai-results {
            display: grid;
            gap: 12px;
        }
        .ai-question-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
        }
        @media (max-width: 900px) {
            .ai-question-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (max-width: 600px) {
            .ai-question-grid { grid-template-columns: 1fr; }
        }
        .ai-slider-row.ai-q-slider {
            grid-template-columns: 1fr auto;
            column-gap: 12px;
        }
        .ai-question-item {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 0.85rem;
            padding: 0.75rem 0.85rem;
            display: grid;
            gap: 0.5rem;
        }
        .ai-question-item .text-xs {
            font-size: 0.9rem;
            line-height: 1.35;
            color: rgba(255,255,255,0.82);
        }
        .ai-mode-btn.is-active {
            color: #fff;
            background: linear-gradient(135deg, var(--nav-active-a), var(--nav-active-b));
            border-color: color-mix(in srgb, var(--brand) 60%, var(--border));
            box-shadow: 0 10px 26px rgba(0,0,0,0.35);
        }

        /* Quote Wall */
        .dash-quote-wall-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 14px;
            align-items: stretch;
        }
        .dash-quote-card {
            position: relative;
            border-radius: 1rem;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.05);
            overflow: hidden;
            cursor: pointer;
            transition: border-color 140ms ease, background 140ms ease, box-shadow 140ms ease;
        }
        .dash-quote-card:hover {
            border-color: color-mix(in srgb, var(--brand) 55%, rgba(255,255,255,0.12));
            background: rgba(255,255,255,0.07);
            box-shadow: 0 18px 50px rgba(0,0,0,0.40);
        }
        .dash-quote-card::before {
            content: "";
            position: absolute;
            inset: -2px;
            background: radial-gradient(600px circle at var(--mx, 40%) var(--my, 25%), var(--brand-2), transparent 45%),
                        radial-gradient(520px circle at var(--mx2, 70%) var(--my2, 80%), var(--brand-light), transparent 50%);
            opacity: 0.85;
            pointer-events: none;
        }
        .dash-quote-card-inner {
            position: relative;
            padding: 1rem 1rem 0.95rem;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
            /* Intentionally no motion: keep text easy to read. */
        }
        .dash-quote-text {
            font-size: 0.98rem;
            line-height: 1.35;
            color: rgba(255,255,255,0.95);
            font-weight: 750;
            letter-spacing: 0.01em;
        }
        .dash-quote-text em { font-style: italic; font-weight: 750; }
        .dash-quote-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            color: rgba(255,255,255,0.78);
            font-size: 0.78rem;
        }
        .dash-quote-pill {
            padding: 0.22rem 0.55rem;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(0,0,0,0.20);
            font-weight: 850;
            letter-spacing: 0.03em;
        }
        .dash-quote-title {
            font-size: 0.92rem;
            font-weight: 900;
            color: rgba(255,255,255,0.96);
            line-height: 1.2;
        }

        /* Icon Size Helper */
        svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm svg { width: 16px; height: 16px; }
        .icon-lg svg { width: 32px; height: 32px; }

        /* Save gating UX */
        #btn-save-diary[aria-disabled="true"] { cursor: not-allowed; }

        /* Dashboard tabs + timeframe buttons */
        .dash-pill-btn {
            padding: 0.6rem 0.95rem !important;
            border-radius: 999px !important;
            font-size: 0.95rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            line-height: 1;
            border-width: 1px;
        }
        .dash-pill-btn.btn-outline {
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.16);
            color: rgba(255,255,255,0.92);
        }
        .dash-pill-btn.btn-outline:hover {
            border-color: rgba(255,255,255,0.32);
            background: rgba(255,255,255,0.07);
        }
        .dash-pill-btn.btn-glass {
            background: linear-gradient(135deg, var(--nav-active-a), var(--nav-active-b));
            border-color: color-mix(in srgb, var(--brand) 65%, var(--border));
            color: #fff;
            box-shadow: 0 10px 26px rgba(0,0,0,0.35);
        }
        .dash-pill-btn.btn-glass:hover {
            background: linear-gradient(
                135deg,
                color-mix(in srgb, var(--nav-active-a) 80%, var(--brand-light)),
                color-mix(in srgb, var(--nav-active-b) 80%, var(--brand-light))
            );
        }
    </style>
</head>
<body>
    <div class="theme-background"></div>
    <div class="theme-gradient-overlay"></div>

    <!-- Navbar -->
    <nav class="navbar glass-panel">
        <div class="container nav-inner">
            <div class="nav-brand" onclick="router.navigate('home')" style="cursor:pointer;">
                <span class="icon-wrapper" id="nav-logo-icon"></span>
                <span><span class="cinema-title">Cinema</span><span class="tracker-title">Tracker</span></span>
            </div>
            
            <div class="nav-links">
                <button onclick="router.navigate('home')" class="nav-link">Home</button>
                <button onclick="router.navigate('feed')" class="nav-link">Feed</button>
                <button onclick="router.navigate('library')" class="nav-link">My Movies</button>
                <button onclick="router.navigate('lists')" class="nav-link">Lists</button>
                <button onclick="router.navigate('ai_picks')" class="nav-link">AI Picks</button>
                <button onclick="router.navigate('dashboard')" class="nav-link">Data Dash</button>
            </div>

            <div class="nav-actions">
                <button id="nav-login-btn" class="nav-auth-btn" type="button" onclick="handleNavAccountButtonClick(event)">Login</button>

                <div class="mobile-menu-btn">
                    <button onclick="toggleMobileMenu()" id="menu-icon-btn"></button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="glass-panel">
            <button onclick="router.navigate('home')" class="mobile-link">Home</button>
            <button onclick="router.navigate('feed')" class="mobile-link">Feed</button>
            <button onclick="router.navigate('library')" class="mobile-link">My Movies</button>
            <button onclick="router.navigate('lists')" class="mobile-link">Lists</button>
            <button onclick="router.navigate('ai_picks')" class="mobile-link">AI Picks</button>
            <button onclick="router.navigate('dashboard')" class="mobile-link">Data Dash</button>
            <button id="mobile-auth-btn" onclick="handleNavAccountButtonClick(event); document.getElementById('mobile-menu').classList.remove('open');" class="mobile-link">Login</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-root" style="padding-top: var(--header-height);">
        <!-- Content injected by JS -->
    </main>

    <button id="log-fab" class="log-fab" type="button" aria-label="Open message log">
        <span class="icon-sm" id="log-fab-icon"></span>
        Logs <span id="log-badge" class="log-badge">0</span>
    </button>

    <div id="log-panel" class="log-panel" aria-live="polite">
        <div class="log-panel-header">
            <div class="log-panel-title">Message Log</div>
            <div class="log-panel-actions">
                <button id="log-copy" class="log-btn" type="button">Copy</button>
                <button id="log-clear" class="log-btn" type="button">Clear</button>
                <button id="log-close" class="log-btn" type="button">Close</button>
            </div>
        </div>
        <div id="log-body" class="log-body"></div>
    </div>

    <div id="toast" class="toast">
        <span id="toast-icon"></span>
        <span id="toast-message" class="font-semibold">Action successful!</span>
    </div>

    <div id="ratings-success-overlay" class="auth-overlay" onclick="if(event.target === this) closeRatingsSuccessModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="ratings-success-title" style="max-width: 420px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="ratings-success-title">Movie Ratings Saved</div>
                <button class="auth-modal-close" type="button" onclick="closeRatingsSuccessModal()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Your diary has been updated.
            </div>
        </div>
    </div>

    <div id="achievement-earned-overlay" class="auth-overlay" onclick="if(event.target === this) closeAchievementPopup();" style="display:none;">
        <div id="achievement-splash" aria-hidden="true"></div>
        <svg id="achievement-swipe" viewBox="0 0 1000 600" preserveAspectRatio="none" aria-hidden="true">
            <path id="achievement-swipe-path" class="achievement-swipe-path" d="M0,340 C210,120 380,120 580,220 C780,320 860,520 1000,470 L1000,600 L0,600 Z"></path>
            <path id="achievement-swipe-stroke" class="achievement-swipe-stroke" d="M0,340 C210,120 380,120 580,220 C780,320 860,520 1000,470"></path>
            <path id="achievement-motion-path" class="achievement-motion-path" d="M-40,520 C180,120 420,60 720,200 C980,340 900,520 1040,620"></path>
        </svg>
        <div id="achievement-pieces" aria-hidden="true"></div>
        <div id="achievement-earned-modal" class="auth-modal achievement-modal" role="dialog" aria-modal="true" aria-labelledby="achievement-earned-title" style="max-width: 520px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="achievement-earned-title">Achievement Unlocked</div>
                <button class="auth-modal-close" type="button" onclick="closeAchievementPopup()">Close</button>
            </div>
            <div id="achievement-earned-body" class="glass-panel" style="margin-top: 0.65rem; padding: 0.85rem; border-radius: 0.85rem; background: rgba(0,0,0,0.12); display:flex; gap: 0.85rem; align-items:center;">
                <div class="achievement-icon" id="achievement-earned-icon"></div>
                <div>
                    <div class="achievement-title" id="achievement-earned-name">Achievement</div>
                    <div class="achievement-meta" id="achievement-earned-desc">Keep rating movies to unlock more.</div>
                </div>
            </div>
            <div id="achievement-earned-actions" class="auth-modal-actions">
                <button id="achievement-replay" type="button" class="btn btn-outline" onclick="replayAchievementCelebration()">Replay Celebration</button>
                <button id="achievement-view" type="button" class="btn btn-primary" onclick="closeAchievementPopup(); router.navigate('account');">View Achievements</button>
            </div>
        </div>
    </div>

    <div id="achievement-detail-overlay" class="auth-overlay" onclick="if(event.target === this) closeAchievementDetail();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="achievement-detail-title" style="max-width: 640px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="achievement-detail-title">Achievement Details</div>
                <button class="auth-modal-close" type="button" onclick="closeAchievementDetail()">Close</button>
            </div>
            <div id="achievement-detail-body" class="text-sm" style="color: var(--text-muted);"></div>
        </div>
    </div>

    <div id="dash-kpi-ties-overlay" class="auth-overlay" onclick="if(event.target === this) closeDashKpiTies();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="dash-kpi-ties-title" style="max-width: 640px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="dash-kpi-ties-title">Tied Leaders</div>
                <button class="auth-modal-close" type="button" onclick="closeDashKpiTies()">Close</button>
            </div>
            <div id="dash-kpi-ties-sub" class="text-xs text-gray" style="margin-top: 0.25rem;"></div>
            <div id="dash-kpi-ties-body" class="dash-kpi-tie-list" style="margin-top: 0.75rem;">Loading</div>
        </div>
    </div>

    <div id="auth-overlay" class="auth-overlay" onclick="if(event.target === this) closeAuthModal();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="auth-modal-title">Login</div>
                <button class="auth-modal-close" type="button" onclick="closeAuthModal()">Close</button>
            </div>

            <div class="grid md-row gap-6" style="margin-top: 0px;">
                <div style="flex:1;">
                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Email</label>
                    <input id="auth-email" type="email" class="input-field" placeholder="you@example.com" autocomplete="email">
                </div>
                <div style="flex:1;">
                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Password</label>
                    <input id="auth-password" type="password" class="input-field" placeholder="" autocomplete="current-password">
                </div>
            </div>

            <div class="flex items-center gap-3" style="margin-top: 0.75rem;">
                <div id="auth-modal-status" class="text-sm" style="flex:1; color: var(--text-muted);">Not logged in.</div>
            </div>

            <div class="auth-modal-actions">
                <button type="button" id="auth-login-btn" class="btn btn-glass" onclick="handleLoginClick(event)">Log in</button>
                <button type="button" id="auth-logout-btn" class="btn btn-outline" onclick="handleLogoutClick(event)" style="display:none;">Log out</button>
            </div>
        </div>
    </div>

    <div id="new-features-overlay" class="auth-overlay" onclick="if(event.target === this) closeNewFeaturesPopup();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="new-features-title" style="max-width: 640px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="new-features-title">New Features Pop Up</div>
                <button class="auth-modal-close" type="button" onclick="closeNewFeaturesPopup()">Close</button>
            </div>
            <div id="new-features-popup-text" class="text-sm" style="color: var(--text-muted); margin-top: 0.4rem; line-height: 1.6;">
                Loading
            </div>
            <label class="text-xs text-gray" style="display:inline-flex; gap: 8px; align-items:center; margin-top: 0.85rem;">
                <input id="new-features-dismiss" type="checkbox" checked />
                Dont show again
            </label>
        </div>
    </div>

    <div id="ai-help-overlay" class="auth-overlay" onclick="if(event.target === this) closeAiHelpPopup();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="ai-help-title" style="max-width: 640px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="ai-help-title">AI Help Pop Up</div>
                <button class="auth-modal-close" type="button" onclick="closeAiHelpPopup()">Close</button>
            </div>
            <div id="ai-help-popup-text" class="text-sm" style="color: var(--text-muted); margin-top: 0.4rem; line-height: 1.6;">
                Loading
            </div>
            <label class="text-xs text-gray" style="display:inline-flex; gap: 8px; align-items:center; margin-top: 0.85rem;">
                <input id="ai-help-dismiss" type="checkbox" />
                Dont show again
            </label>
        </div>
    </div>

    <div id="dashboard-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeDashboardAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="dashboard-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="dashboard-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeDashboardAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to view your data dashboard
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeDashboardAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="feed-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeFeedAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="feed-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="feed-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeFeedAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to view your feed
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeFeedAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="library-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeLibraryAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="library-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="library-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeLibraryAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to view your movies
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeLibraryAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="lists-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeListsAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="lists-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="lists-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeListsAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to view your lists
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeListsAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="list-picker-overlay" class="auth-overlay" onclick="if(event.target === this) closeListPickerModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="list-picker-title" style="max-width: 520px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="list-picker-title">Add to List</div>
                <button class="auth-modal-close" type="button" onclick="closeListPickerModal()">Close</button>
            </div>

            <div id="list-picker-movie" class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;"></div>

            <div class="glass-panel" style="margin-top: 0.85rem; padding: 0.85rem; border-radius: 0.85rem; background: rgba(0,0,0,0.10);">
                <div class="text-white font-bold">Choose a list</div>
                <div id="list-picker-lists" class="text-gray" style="margin-top: 0.65rem; display:flex; flex-direction: column; gap: 0.5rem;">Loading</div>
            </div>

            <form id="list-picker-create-form" style="margin-top: 0.85rem; display:grid; gap: 0.65rem;">
                <div class="text-white font-bold">Or create a new list</div>
                <input id="list-picker-new-name" type="text" class="input-field" placeholder="e.g. 2026 Watchlist" maxlength="80">
                <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Create & Add</button>
                    <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="closeListPickerModal()">Cancel</button>
                </div>
                <div id="list-picker-status" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
            </form>
        </div>
    </div>

    <div id="lists-create-overlay" class="auth-overlay" onclick="if(event.target === this) closeListsCreateModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="lists-create-title" style="max-width: 520px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="lists-create-title">Create New List</div>
                <button class="auth-modal-close" type="button" onclick="closeListsCreateModal()">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Give your list a name (max 80 characters).
            </div>

            <form id="lists-create-form" style="margin-top: 0.85rem; display:grid; gap: 0.65rem;">
                <input id="lists-create-name" type="text" class="input-field" placeholder="e.g. 2026 Watchlist" maxlength="80" autocomplete="off">
                <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Save</button>
                    <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="closeListsCreateModal()">Cancel</button>
                </div>
                <div id="lists-create-status" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
            </form>
        </div>
    </div>

    <div id="lists-rename-overlay" class="auth-overlay" onclick="if(event.target === this) closeListsRenameModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="lists-rename-title" style="max-width: 520px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="lists-rename-title">Rename List</div>
                <button class="auth-modal-close" type="button" onclick="closeListsRenameModal()">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Enter a new name (max 80 characters).
            </div>

            <form id="lists-rename-form" style="margin-top: 0.85rem; display:grid; gap: 0.65rem;">
                <input id="lists-rename-name" type="text" class="input-field" placeholder="New list name" maxlength="80" autocomplete="off">
                <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Save</button>
                    <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="closeListsRenameModal()">Cancel</button>
                </div>
                <div id="lists-rename-status" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
            </form>
        </div>
    </div>

    <div id="lists-delete-overlay" class="auth-overlay" onclick="if(event.target === this) closeListsDeleteModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="lists-delete-title" style="max-width: 520px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="lists-delete-title">Delete List</div>
                <button class="auth-modal-close" type="button" onclick="closeListsDeleteModal()">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                This will permanently delete <span id="lists-delete-name" class="text-white font-semibold"></span> and remove all movies from it. Ratings/logs are not affected.
            </div>

            <div style="margin-top: 0.85rem; display:flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="btn btn-outline" data-lists-action="confirm_delete_list" style="border-radius: 0.85rem; border-color: rgba(239,68,68,0.55); background: rgba(239,68,68,0.10);">Delete</button>
                <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="closeListsDeleteModal()">Cancel</button>
            </div>
            <div id="lists-delete-status" class="text-xs" style="color: rgba(255,255,255,0.60); margin-top: 0.65rem;"></div>
        </div>
    </div>

    <div id="lists-watch-options-overlay" class="auth-overlay" onclick="if(event.target === this) closeListsWatchOptionsModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="lists-watch-options-title" style="max-width: 520px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="lists-watch-options-title">Watch Options</div>
                <button class="auth-modal-close" type="button" onclick="closeListsWatchOptionsModal()">Close</button>
            </div>

            <div id="lists-watch-options-movie" class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;"></div>

            <div id="lists-watch-options-body" class="glass-panel" style="margin-top: 0.85rem; padding: 0.85rem; border-radius: 0.85rem; background: rgba(0,0,0,0.10);">
                <div class="text-gray">Loading</div>
            </div>

            <div class="auth-modal-actions">
                <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="closeListsWatchOptionsModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="lists-sortfilter-overlay" class="auth-overlay" onclick="if(event.target === this) closeListsSortFilterModal({ restoreDraft: true });" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="lists-sortfilter-title" style="max-width: 560px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="lists-sortfilter-title">Filters & Sort</div>
                <button class="auth-modal-close" type="button" data-lists-action="cancel_sort_filter">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Choose filters + sorting, then press <span class="text-white font-semibold">Save</span> to update your list.
            </div>

            <div class="glass-panel" style="margin-top: 0.85rem; padding: 0.85rem; border-radius: 0.85rem; background: rgba(0,0,0,0.10);">
                <div class="text-white font-bold" style="margin-bottom: 0.55rem;">Sort</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="lists-modal-sort-key" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="watch_date">Watch Date</option>
                        <option value="overall">Overall %</option>
                        <option value="sound">Sound %</option>
                        <option value="pace">Pace %</option>
                        <option value="imagery">Imagery %</option>
                        <option value="acting">Acting %</option>
                        <option value="plot">Plot %</option>
                        <option value="dialogue">Dialogue %</option>
                        <option value="imdb">IMDb %</option>
                        <option value="release_year">Release Year</option>
                    </select>
                    <select id="lists-modal-sort-dir" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="desc">Descending</option>
                        <option value="asc">Ascending</option>
                    </select>
                </div>

                <div style="height: 1px; background: rgba(255,255,255,0.06); margin: 0.85rem 0;"></div>

                <div class="text-white font-bold" style="margin-bottom: 0.55rem;">Filters</div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                    <select id="lists-modal-filter-tier" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Tier (All)</option>
                        <option value="S-Tier">S-Tier</option>
                        <option value="A-Tier">A-Tier</option>
                        <option value="B-Tier">B-Tier</option>
                        <option value="C-Tier">C-Tier</option>
                        <option value="D-Tier">D-Tier</option>
                        <option value="F-Tier">F-Tier</option>
                        <option value="UNRANKED">Unranked</option>
                    </select>

                    <select id="lists-modal-filter-decade" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Release Decade (All)</option>
                    </select>

                    <input id="lists-modal-filter-director" class="input-field" placeholder="Director (contains)" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;" />

                    <select id="lists-modal-filter-mpa" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">MPA (All)</option>
                    </select>

                    <select id="lists-modal-filter-genre" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Genre (All)</option>
                    </select>

                    <select id="lists-modal-filter-platform" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Platform (All)</option>
                    </select>
                </div>
            </div>

            <div class="auth-modal-actions" style="margin-top: 0.85rem; display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                <button type="button" class="btn btn-outline" data-lists-action="reset_sort_filter_draft" style="border-radius: 0.85rem;">Reset</button>
                <button type="button" class="btn btn-outline" data-lists-action="cancel_sort_filter" style="border-radius: 0.85rem;">Cancel</button>
                <button type="button" class="btn btn-primary" data-lists-action="save_sort_filter" style="border-radius: 0.85rem;">Save</button>
            </div>
        </div>
    </div>

    <div id="library-sortfilter-overlay" class="auth-overlay" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="library-sortfilter-title" style="max-width: 560px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="library-sortfilter-title">Filters & Sort</div>
                <button class="auth-modal-close" type="button" data-library-action="cancel_sort_filter">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Choose filters + sorting, then press <span class="text-white font-semibold">Save</span> to update your list.
            </div>

            <div class="glass-panel" style="margin-top: 0.85rem; padding: 0.85rem; border-radius: 0.85rem; background: rgba(0,0,0,0.10);">
                <div class="text-white font-bold" style="margin-bottom: 0.55rem;">Sort</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="library-modal-sort-key" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="watch_date">Watch Date</option>
                        <option value="watch_count">Watch Count</option>
                        <option value="overall">Overall %</option>
                        <option value="sound">Sound %</option>
                        <option value="pace">Pace %</option>
                        <option value="imagery">Imagery %</option>
                        <option value="acting">Acting %</option>
                        <option value="plot">Plot %</option>
                        <option value="dialogue">Dialogue %</option>
                        <option value="imdb">IMDb %</option>
                        <option value="release_year">Release Year</option>
                    </select>
                    <select id="library-modal-sort-dir" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="desc">Descending</option>
                        <option value="asc">Ascending</option>
                    </select>
                </div>

                <div style="height: 1px; background: rgba(255,255,255,0.06); margin: 0.85rem 0;"></div>

                <div class="text-white font-bold" style="margin-bottom: 0.55rem;">Filters</div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                    <select id="library-modal-filter-timeframe" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="all_time">Watch Date (All Time)</option>
                        <option value="this_year">Watch Date (This Year)</option>
                        <option value="this_month">Watch Date (This Month)</option>
                    </select>

                    <select id="library-modal-filter-watchmethod" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Watch Method (All)</option>
                        <option value="At Home">At Home</option>
                        <option value="In Theater">In Theater</option>
                    </select>

                    <select id="library-modal-filter-tier" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Tier (All)</option>
                        <option value="S-Tier">S-Tier</option>
                        <option value="A-Tier">A-Tier</option>
                        <option value="B-Tier">B-Tier</option>
                        <option value="C-Tier">C-Tier</option>
                        <option value="D-Tier">D-Tier</option>
                        <option value="F-Tier">F-Tier</option>
                        <option value="UNRANKED">Unranked</option>
                    </select>

                    <select id="library-modal-filter-decade" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Release Decade (All)</option>
                    </select>

                    <input id="library-modal-filter-director" class="input-field" placeholder="Director (contains)" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;" />

                    <input id="library-modal-filter-actor" class="input-field" placeholder="Actor (contains)" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;" />

                    <select id="library-modal-filter-mpa" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">MPA (All)</option>
                    </select>

                    <select id="library-modal-filter-genre" class="input-field" style="padding: 0.55rem 0.75rem; border-radius: 0.85rem;">
                        <option value="">Genre (All)</option>
                    </select>

                    <div class="library-watch-range">
                        <div class="text-xs text-gray" style="margin-bottom: 0.35rem;">Watch Count Range</div>
                        <div id="library-watch-count-rail" class="library-watch-rail" data-min-val="1" data-max-val="1" data-max-avail="0" aria-label="Watch count range">
                            <div class="library-watch-rail-track"></div>
                            <div class="library-watch-rail-fill"></div>
                            <button type="button" class="library-watch-handle" data-handle="min" aria-label="Minimum watch count"></button>
                            <button type="button" class="library-watch-handle" data-handle="max" aria-label="Maximum watch count"></button>
                        </div>
                        <div class="library-watch-range-labels">
                            <span id="library-watch-count-min"></span>
                            <span id="library-watch-count-max"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="auth-modal-actions" style="margin-top: 0.85rem; display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                <button type="button" class="btn btn-outline" data-library-action="reset_sort_filter_draft" style="border-radius: 0.85rem;">Reset</button>
                <button type="button" class="btn btn-outline" data-library-action="cancel_sort_filter" style="border-radius: 0.85rem;">Cancel</button>
                <button type="button" class="btn btn-primary" data-library-action="save_sort_filter" style="border-radius: 0.85rem;">Save</button>
            </div>
        </div>
    </div>

    <div id="account-auth-warning" class="auth-overlay" onclick="if(event.target === this) closeAccountAuthWarning();">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="account-auth-warning-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="account-auth-warning-title">Login Required</div>
                <button class="auth-modal-close" type="button" onclick="closeAccountAuthWarning()">Close</button>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.25rem;">
                Please login to manage your account
            </div>
            <div class="auth-modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeAccountAuthWarning(); openAuthModal();">Log in</button>
            </div>
        </div>
    </div>

    <div id="update-watch-overlay" class="auth-overlay" onclick="if(event.target === this) closeUpdateWatchModal(null);" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="update-watch-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="update-watch-title">Update Ratings</div>
                <button class="auth-modal-close" type="button" onclick="closeUpdateWatchModal(null)">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem;">
                Youre updating an existing rating. Do you also want to add <span class="text-white font-semibold">+1 watch</span>?
            </div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem;">
                <button type="button" id="btn-update-only" class="btn btn-outline" style="flex:1;" onclick="closeUpdateWatchModal('update_only')">Only Update Rating</button>
                <button type="button" id="btn-update-and-watch" class="btn btn-primary" style="flex:1;" onclick="closeUpdateWatchModal('update_and_watch')">Update and +1 to Watch Logs</button>
            </div>
        </div>
    </div>

    <div id="delete-rating-overlay" class="auth-overlay" onclick="if(event.target === this) closeDeleteRatingModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="delete-rating-title" style="max-width: 720px;">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="delete-rating-title">Delete</div>
                <button class="auth-modal-close" type="button" onclick="closeDeleteRatingModal()">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.35rem;">
                Movie: <span id="delete-rating-movie" class="text-white font-semibold">(loading)</span>
            </div>

            <div class="glass-panel" style="margin-top: 0.85rem; padding: 0.95rem; border-radius: 0.95rem; background: rgba(0,0,0,0.10); border: 1px solid rgba(239,68,68,0.25);">
                <div class="text-white font-bold">Option A  Delete rating + all watch logs</div>
                <div class="text-sm" style="color: var(--text-muted); margin-top: 0.4rem;">
                    This permanently deletes your <span class="text-white font-semibold">Movie Ratings</span> row and all related <span class="text-white font-semibold">Watch Logs</span> for this movie.
                </div>
                <div style="margin-top: 0.75rem; display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" style="border-radius: 0.85rem; border-color: rgba(239,68,68,0.55); color: rgba(239,68,68,0.95); background: rgba(239,68,68,0.10);" onclick="confirmDeleteRatingAndAllLogs()">Delete rating + all watch logs</button>
                </div>
                <div id="delete-rating-status" class="text-xs" style="color: rgba(255,255,255,0.60); margin-top: 0.45rem;"></div>
            </div>

            <div class="glass-panel" style="margin-top: 0.85rem; padding: 0.95rem; border-radius: 0.95rem; background: rgba(0,0,0,0.10);">
                <div class="flex justify-between items-center" style="gap: 10px; flex-wrap: wrap;">
                    <div class="text-white font-bold">Option B  Delete selected watch logs</div>
                    <div id="delete-logs-count" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
                </div>
                <div class="text-sm" style="color: var(--text-muted); margin-top: 0.4rem;">
                    Select watch logs to delete. You must keep <span class="text-white font-semibold">at least 1</span> watch log.
                </div>

                <div id="delete-logs-list" style="margin-top: 0.75rem; display:flex; flex-direction: column; gap: 0.5rem; max-height: 280px; overflow: auto; padding-right: 4px;">
                    <div class="text-sm" style="color: rgba(255,255,255,0.65);">Loading watch logs</div>
                </div>

                <div class="auth-modal-actions" style="margin-top: 0.85rem; display:flex; gap: 10px; flex-wrap: wrap; justify-content: space-between;">
                    <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="clearDeleteLogsSelection()">Clear</button>
                        <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="toggleSelectAllDeleteLogs()">Select all</button>
                    </div>
                    <button type="button" id="btn-delete-selected-logs" class="btn btn-primary" style="border-radius: 0.85rem; background: rgba(239,68,68,0.90); border-color: rgba(239,68,68,0.90);" onclick="confirmDeleteSelectedWatchLogs()" disabled aria-disabled="true" title="Select at least one watch log.">Delete selected</button>
                </div>
                <div id="delete-logs-status" class="text-xs" style="color: rgba(255,255,255,0.60); margin-top: 0.45rem;"></div>
            </div>
        </div>
    </div>

    <div id="duplicate-rating-overlay" class="auth-overlay" onclick="if(event.target === this) closeDuplicateRatingModal();" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="duplicate-rating-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="duplicate-rating-title">Already Rated</div>
                <button class="auth-modal-close" type="button" onclick="closeDuplicateRatingModal()">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem;">
                You have already rated <span id="duplicate-rating-movie" class="text-white font-semibold">this movie</span>. Would you like to update your ratings?
            </div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem;">
                <button type="button" class="btn btn-primary" style="flex:1;" onclick="proceedDuplicateUpdateRatings()">Update Ratings</button>
                <button type="button" class="btn btn-outline" style="flex:1;" onclick="proceedDuplicateReturnHome()">Return Home</button>
            </div>
        </div>
    </div>

    <div id="watch-method-overlay" class="auth-overlay" onclick="if(event.target === this) closeWatchMethodModal(null);" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="watch-method-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="watch-method-title">Watch Method</div>
                <button class="auth-modal-close" type="button" onclick="closeWatchMethodModal(null)">Close</button>
            </div>

            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem;">
                How did you watch it?
            </div>

            <div style="margin-top: 0.85rem;">
                <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Date Watched</label>
                <input id="watch-method-date" type="date" class="input-field" onclick="openDatePickerFromInput(this)" onfocus="openDatePickerFromInput(this)" required>
                <div class="text-xs text-gray" style="margin-top: 0.35rem;">This date will be saved to your Watch Logs.</div>
            </div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem; flex-wrap: wrap;">
                <button
                    type="button"
                    class="btn watch-method-option"
                    style="flex:1; background-color: rgba(168, 85, 247, 0.35); border: 1px solid rgba(168, 85, 247, 0.5); color: white;"
                    data-watch-method-option="true"
                    onclick="selectWatchMethodModal('At Home')"
                >At Home</button>
                <button
                    type="button"
                    class="btn watch-method-option"
                    style="flex:1; background-color: rgba(20, 184, 166, 0.35); border: 1px solid rgba(20, 184, 166, 0.5); color: white;"
                    data-watch-method-option="true"
                    onclick="selectWatchMethodModal('In Theater')"
                >In Theater</button>
                <button type="button" id="watch-method-save" class="btn btn-primary" style="width: 100%;" onclick="submitWatchMethodModal()" disabled aria-disabled="true" title="Select a watch method first.">
                    <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Save
                </button>
            </div>
        </div>
    </div>

    <div id="prior-watches-overlay" class="auth-overlay" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="prior-watches-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="prior-watches-title">Add Previous Watches</div>
            </div>

            <div class="text-sm" id="prior-watches-message" style="color: var(--text-muted); margin-top: 0.5rem;"></div>

            <div id="prior-watches-fields" style="margin-top: 0.85rem; display:flex; flex-direction: column; gap: 0.75rem;"></div>

            <div class="auth-modal-actions" style="margin-top: 1rem; display:flex; gap: 0.75rem; flex-wrap: wrap;">
                <button type="button" class="btn btn-primary" style="flex:1;" onclick="submitPriorWatchesModal()">Save Previous Watches</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="auth-overlay" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="loading-title">
            <div class="auth-modal-header">
                <div class="auth-modal-title" id="loading-title">Loading</div>
            </div>
            <div class="text-sm" style="color: var(--text-muted); margin-top: 0.5rem; display:flex; align-items:center; gap: 0.5rem;">
                <span class="icon-sm"><svg viewBox="0 0 24 24" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></span>
                <span>Hang tight  fetching your existing entry</span>
            </div>
        </div>
    </div>
    <footer>
        <div class="container flex flex-col md-row justify-between items-center">
            <div class="mb-4">
                <span class="text-gray text-sm"> 2026 CinemaTracker. Designed for film lovers.</span>
            </div>
            <div class="flex gap-4" id="footer-icons">
            </div>
        </div>
    </footer>

    <script>
        const SUPABASE_URL = 'https://dbxhaseoxpnmzdxbzdpj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_UcpiMVqtkCgky9HN8nu85Q_iFXsVY_r';
        const supabaseClient = window.supabase?.createClient
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
            : null;

        // Column name for the date-only watch date field in both "Movie Ratings" and "Watch Logs".
        // If you rename the column to a different identifier (e.g. "Watch_Date"), update this value.
        const COL_WATCH_DATE = 'watch_date';
        const icons = {
            film: `<svg viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg>`,
            menu: `<svg viewBox="0 0 24 24"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>`,
            checkCircle: `<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            twitter: `<svg viewBox="0 0 24 24"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 14-4.5-4.5 1.6-11.7 8-12 1.1-2 3.5-3.5 6-3.5 0 0 .7 3.4 2.7 4.5"/></svg>`,
            github: `<svg viewBox="0 0 24 24"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>`,
            instagram: `<svg viewBox="0 0 24 24"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/></svg>`,
            search: `<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            plusCircle: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`,
            refreshCw: `<svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>`,
            arrowRight: `<svg viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            arrowRightCircle: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="m12 16 4-4-4-4"/></svg>`,
            clock: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
            barChart2: `<svg viewBox="0 0 24 24"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>`,
            star: `<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
            arrowLeft: `<svg viewBox="0 0 24 24"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>`,
            database: `<svg viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>`,
            info: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`,
            edit3: `<svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>`,
            quote: `<svg viewBox="0 0 24 24"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></svg>`,
            save: `<svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            calendar: `<svg viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            trendingUp: `<svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>`,
            trendingDown: `<svg viewBox="0 0 24 24"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>`,
            percent: `<svg viewBox="0 0 24 24"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="7" cy="7" r="2"/><circle cx="17" cy="17" r="2"/></svg>`,
            activity: `<svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
            pieChart: `<svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>`,
            video: `<svg viewBox="0 0 24 24"><rect x="3" y="7" width="14" height="10" rx="2" ry="2"/><path d="m17 10 4-2v8l-4-2z"/></svg>`,
            tv: `<svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="12" rx="2" ry="2"/><path d="M7 21h10"/><path d="M12 7 8 3"/><path d="M12 7l4-4"/></svg>`,
            user: `<svg viewBox="0 0 24 24"><path d="M20 21a8 8 0 0 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>`,
            loader: `<svg viewBox="0 0 24 24" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`
        };
        const navLogoEl = document.getElementById('nav-logo-icon');
        if (navLogoEl) {
            navLogoEl.innerHTML = '';
        }

        async function fetchNavLogoUrl(themeId) {
            if (!supabaseClient) return null;
            const themeKey = String(themeId || '').trim();
            if (!themeKey) return null;
            const query = supabaseClient
                .from('Logos')
                .select('url')
                .order('created_at', { ascending: false })
                .limit(1);

            const { data, error } = await query.eq('theme_id', themeKey).maybeSingle();
            if (error || !data?.url) return null;
            return data.url;
        }

        async function loadNavLogoForTheme(themeId) {
            if (!navLogoEl) return;
            try {
                const themeKey = String(themeId || '').trim();
                let url = await fetchNavLogoUrl(themeKey);
                navLogoEl.innerHTML = url
                    ? `<img src="${url}" alt="CinemaTracker" loading="lazy" decoding="async" />`
                    : '';
            } catch (_) {
                navLogoEl.innerHTML = '';
            }
        }
        document.getElementById('menu-icon-btn').innerHTML = icons.menu;
        document.getElementById('toast-icon').innerHTML = icons.checkCircle;
        document.getElementById('footer-icons').innerHTML = `
            <a href="#">${icons.twitter}</a>
            <a href="#">${icons.github}</a>
            <a href="#">${icons.instagram}</a>
        `;
        const router = {
            currentPage: 'home',
            selectedMovie: null,
            pendingTitle: '',
            formMode: 'new',
            navStack: [],
            
            init() {
                window.addEventListener('popstate', (e) => {
                    const state = e?.state || {};
                    const page = String(state.page || 'home').trim() || 'home';
                    const mode = String(state.mode || 'new').trim() || 'new';
                    this.navigate(page, mode, 'pop');
                });

                const state = history.state || {};
                if (state.page) {
                    this.navigate(String(state.page), String(state.mode || 'new'), 'pop');
                } else {
                    history.replaceState({ page: 'home', mode: 'new' }, '', location.pathname);
                    this.navigate('home', 'new', 'pop');
                }
            },

            goBack() {
                const prev = this.navStack.pop();
                if (prev?.page) {
                    if (prev.page === 'dashboard') {
                        if (prev.dashboardActiveTab) dashboardActiveTab = prev.dashboardActiveTab;
                        if (prev.dashboardTimeframe) dashboardTimeframe = prev.dashboardTimeframe;
                        if (prev.dashboardChartsTab) dashboardChartsTab = prev.dashboardChartsTab;
                        if (prev.dashboardHeatmapPair) dashboardHeatmapPair = prev.dashboardHeatmapPair;
                        if (prev.dashboardRatingsChartTab) dashboardRatingsChartTab = prev.dashboardRatingsChartTab;
                        if (prev.dashboardFavoritesMetric) dashboardFavoritesMetric = prev.dashboardFavoritesMetric;
                        if (Number.isFinite(prev.dashboardFavoritesLimit)) dashboardFavoritesLimit = prev.dashboardFavoritesLimit;
                        if (prev.dashboardGeneralMode) dashboardGeneralMode = prev.dashboardGeneralMode;
                        if (prev.dashboardGeneralPieMode) dashboardGeneralPieMode = prev.dashboardGeneralPieMode;
                    }
                    this.navigate(prev.page, prev.mode || 'new', 'replace');
                    return;
                }
                try {
                    if (history.length > 1) {
                        history.back();
                        return;
                    }
                } catch (_) {}
                this.navigate('home', 'new', 'replace');
            },

            navigate(page, mode = 'new', navMode = 'push') {
                // If the user is not logged in, block the Data Dash and prompt them to log in.
                if ((page === 'dashboard' || page === 'dashboard_kpi' || page === 'dashboard_pie_filter') && !cachedIsAuthed) {
                    openDashboardAuthWarning();
                    return;
                }

                // If the user is not logged in, block the Feed page and prompt them to log in.
                if (page === 'feed' && !cachedIsAuthed) {
                    openFeedAuthWarning();
                    return;
                }

                // If the user is not logged in, block the Library page and prompt them to log in.
                if (page === 'library' && !cachedIsAuthed) {
                    openLibraryAuthWarning();
                    return;
                }

                // If the user is not logged in, block the Lists page and prompt them to log in.
                if (page === 'lists' && !cachedIsAuthed) {
                    openListsAuthWarning();
                    return;
                }

                // If the user is not logged in, block the Account page and prompt them to log in.
                if (page === 'account' && !cachedIsAuthed) {
                    openAccountAuthWarning();
                    return;
                }

                // If the user is not logged in, block Theme Creator.
                if (page === 'theme_creator' && !cachedIsAuthed) {
                    openAccountAuthWarning();
                    return;
                }

                // Disallow opening the submit form without selecting a movie from the dropdown.
                if (page === 'submit' && String(mode || 'new') === 'new') {
                    const hasPicked = Boolean(this.selectedMovie);
                    const hasDetails = Boolean(this.selectedMovie?.detailsReadonly);
                    if (!hasPicked || !hasDetails) {
                        showToast('Please search and select a movie from the dropdown first.', { level: 'warn' });
                        page = 'home';
                        mode = 'new';
                    }
                }

                if (page === 'dashboard_kpi' || page === 'dashboard_pie_filter') {
                    page = 'library';
                }

                const prevPage = this.currentPage;
                const prevMode = this.formMode;
                if (navMode === 'push' && page !== prevPage) {
                    this.navStack.push({
                        page: prevPage,
                        mode: prevMode,
                        dashboardActiveTab,
                        dashboardTimeframe,
                        dashboardChartsTab,
                        dashboardHeatmapPair,
                        dashboardRatingsChartTab,
                        dashboardFavoritesMetric,
                        dashboardFavoritesLimit,
                        dashboardGeneralMode,
                        dashboardGeneralPieMode,
                    });
                }

                this.currentPage = page;
                this.formMode = mode;
                if (navMode !== 'pop') {
                    const state = { page, mode };
                    if (navMode === 'replace') history.replaceState(state, '', location.pathname);
                    else history.pushState(state, '', location.pathname);
                }
                document.body.dataset.page = page;
                const root = document.getElementById('app-root');
                
                // Active Nav
                document.querySelectorAll('.nav-link').forEach(el => {
                    let label = '';
                    if (page === 'home') label = 'home';
                    else if (page === 'submit') label = 'log';
                    else if (page === 'library') label = 'movies';
                    else if (page === 'lists') label = 'lists';
                    else if (page === 'feed') label = 'feed';
                    else if (page === 'account') label = 'account';
                    else if (page === 'ai_picks') label = 'ai picks';
                    else if (page === 'dashboard' || page === 'dashboard_kpi' || page === 'dashboard_pie_filter') label = 'data';
                    if (label && el.innerText.toLowerCase().includes(label)) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                });

                document.getElementById('mobile-menu').classList.remove('open');

                if (page === 'home') {
                    root.innerHTML = this.renderHome();
                    this.selectedMovie = null;
                    this.pendingTitle = '';
                    resetHomeSearchAndFilters();
                    loadTrendingNow();
                } else if (page === 'feed') {
                    root.innerHTML = this.renderFeed();
                    refreshAuthStateAndUI();
                    initFeedPage();
                    loadFeedPage();
                } else if (page === 'library') {
                    root.innerHTML = this.renderLibrary();
                    refreshAuthStateAndUI();
                    initLibraryPage();
                    loadLibraryPage({ reset: true });
                } else if (page === 'lists') {
                    root.innerHTML = this.renderLists();
                    refreshAuthStateAndUI();
                    initListsPage();
                    loadListsPage({ reset: true });
                } else if (page === 'ai_picks') {
                    root.innerHTML = this.renderAiPicks();
                    refreshAuthStateAndUI();
                    initAiPicksPage();
                    showAiHelpPopupIfNeeded().catch(() => null);
                } else if (page === 'account') {
                    root.innerHTML = this.renderAccount();
                    refreshAuthStateAndUI();
                    initAccountPage();
                    loadAccountPage();
                } else if (page === 'theme_creator') {
                    root.innerHTML = this.renderThemeCreator();
                    refreshAuthStateAndUI();
                    initThemeCreatorPage();
                } else if (page === 'submit') {
                    root.innerHTML = this.renderSubmit();
                    initializeWatchMethodToggle();
                    refreshAuthStateAndUI();
                } else if (page === 'dashboard') {
                    root.innerHTML = this.renderDashboard();
                    refreshAuthStateAndUI();
                    initDashboardTabs();
                    initDashboardTimeframe();
                    initDashboardFavoritesMetric();
                    initDashboardFavoritesLimitToggle();
                    initDashboardGeneralModeControls();
                    initDashboardGeneralPieControls();
                    initDashboardGeneralPieLegendClicks();
                    initDashboardChartsTabControls();
                    initDashboardHeatmapSelect();
                    initDashboardGeneralKpiClicks();
                    initDashKpiTiesModal();
                    initDashboardRatingsKpiClicks();
                    initDashboardRatingsChartControls();
                    initDashboardPosterUpdateRatingsClicks();
                    setDashboardTimeframe(dashboardTimeframe || 'all_time');
                    syncDashboardFavoritesMetricUI();
                    syncDashboardFavoritesLimitUI();
                    syncDashboardGeneralModeUI();
                    syncDashboardGeneralPieUI();
                    syncDashboardChartsTabUI();
                    syncDashboardHeatmapSelectUI();
                    syncDashboardRatingsChartUI();
                }
                
                window.scrollTo(0, 0);
            },

            async selectMovie(movie) {
                this.selectedMovie = movie;
                this.pendingTitle = movie?.title || '';
                const input = document.getElementById('movie-search-input');
                const results = document.getElementById('search-results');
                const updateBtn = document.getElementById('update-existing-btn');
                const updateOpts = document.getElementById('update-options');
                const logNewBtn = document.getElementById('btn-log-new-entry');

                if (input) input.value = movie.title;
                if (results) results.classList.add('hidden');

                // Prevent UI flash: hide both buttons immediately.
                if (logNewBtn) logNewBtn.style.display = 'none';
                if (updateBtn) updateBtn.style.display = 'none';
                if (updateOpts) {
                    updateOpts.classList.add('hidden');
                    updateOpts.classList.remove('grid');
                }

                // Show the action area and hide the placeholder text.
                setHomeActionsVisible(true);

                // Default behavior when we can't confirm diary status: allow Log as New Entry.
                const showLogNewOnly = () => {
                    if (logNewBtn) logNewBtn.style.display = '';
                    if (updateBtn) updateBtn.style.display = 'none';
                    if (updateOpts) {
                        updateOpts.classList.add('hidden');
                        updateOpts.classList.remove('grid');
                    }
                };

                const showUpdateOnly = () => {
                    if (logNewBtn) logNewBtn.style.display = 'none';
                    if (updateBtn) {
                        updateBtn.style.display = '';
                        updateBtn.disabled = false;
                        updateBtn.style.opacity = '1';
                        updateBtn.style.pointerEvents = 'auto';
                    }
                };

                try {
                    if (!supabaseClient) {
                        showLogNewOnly();
                        return;
                    }

                    const { data } = await supabaseClient.auth.getSession();
                    const authedUser = data?.session?.user;
                    if (!authedUser?.id) {
                        showLogNewOnly();
                        return;
                    }

                    const movie_id = await resolveDbMovieIdFromSelectedMovie(movie);
                    if (!movie_id) {
                        // If it isn't in Movies yet, it can't be in Movie Ratings.
                        showLogNewOnly();
                        return;
                    }

                    const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id });
                    if (alreadyRated) showUpdateOnly();
                    else showLogNewOnly();
                } catch (_) {
                    // Safe fallback: allow Log as New Entry.
                    showLogNewOnly();
                }
            },

            async startNewEntry() {
                const btn = document.getElementById('btn-log-new-entry');
                const originalHTML = btn ? btn.innerHTML : null;

                try {
                    // Users must pick a movie from the dropdown first.
                    if (!this.selectedMovie) {
                        showToast('Please select a movie from the search dropdown first.', { level: 'warn' });
                        return;
                    }

                    // If the user is logged in and already has a rating for this movie, prevent duplicates.
                    try {
                        if (supabaseClient) {
                            const { data } = await supabaseClient.auth.getSession();
                            const authedUser = data?.session?.user;
                            if (authedUser?.id) {
                                const movie_id = await resolveDbMovieIdFromSelectedMovie(this.selectedMovie);
                                if (movie_id) {
                                    const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id });
                                    if (alreadyRated) {
                                        showToast('This movie is already in your diary. Use Update Existing instead.', { level: 'warn' });
                                        return;
                                    }
                                }
                            }
                        }
                    } catch (_) {}

                    // If we already have full details, just navigate.
                    if (this.selectedMovie?.detailsReadonly) {
                        this.navigate('submit', 'new');
                        return;
                    }

                    const tmdb_id = Number(this.selectedMovie?.tmdb_id ?? this.selectedMovie?.id);
                    if (!Number.isFinite(tmdb_id) || tmdb_id <= 0) {
                        showToast('Please select a movie from the search dropdown first.', { level: 'warn' });
                        return;
                    }

                    if (btn) {
                        btn.innerHTML = `${icons.loader} Loading`;
                        btn.disabled = true;
                        btn.style.opacity = 0.85;
                    }

                    const details = await callSwiftApiGetMovieDetails({ tmdb_id });

                    // Shape the prefill object to match the submit page expectations.
                    const genres = Array.isArray(details?.genres)
                        ? details.genres.map(s => String(s).trim()).filter(Boolean)
                        : [];

                    const joinedGenres = genres.length
                        ? genres.join(', ')
                        : String(details?.genre || this.selectedMovie?.genre || '').trim();

                    this.selectedMovie = {
                        ...this.selectedMovie,
                        tmdb_id: Number(details?.tmdb_id ?? tmdb_id),
                        title: String(details?.title || this.selectedMovie?.title || '').trim(),
                        year: details?.year ?? this.selectedMovie?.year ?? null,
                        mpa: String(details?.mpa || '').trim(),
                        runtime: details?.runtime ?? null,
                        isSeries: Boolean(details?.isSeries),
                        director: String(details?.director || '').trim(),
                        imdb: (details?.imdb_rating_pct === null || details?.imdb_rating_pct === undefined)
                            ? ''
                            : String(details.imdb_rating_pct),
                        genres,
                        genre: joinedGenres,
                        poster_path: details?.poster_path ?? this.selectedMovie?.poster_path ?? null,
                        detailsReadonly: true,
                    };

                    this.navigate('submit', 'new');
                } catch (err) {
                    showToast(`Failed to load movie details: ${String(err?.message || err)}`, { level: 'warn' });
                    // Do not allow manual entry.
                    return;
                } finally {
                    if (btn && originalHTML !== null) {
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                        btn.style.opacity = 1;
                    }
                }
            },

            async quickIncrement() {
                const m = this.selectedMovie;
                if (!m) return;

                try {
                    if (!supabaseClient) {
                        throw new Error('Supabase SDK failed to load.');
                    }
                    const { user: authedUser } = await requireAuthOrThrow();

                    // Resolve the DB UUID from the selected movie (prefer UUID, else map tmdb_id -> Movies.id).
                    const movie_id = await resolveDbMovieIdFromSelectedMovie(m);
                    if (!movie_id) {
                        showToast('Quick Watch is only available for movies already in your diary. Use Log as New Entry first.');
                        return;
                    }

                    // Only allow Quick Watch for movies already logged (rated) by this user.
                    const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id });
                    if (!alreadyRated) {
                        showToast('Quick Watch is only for movies you\'ve already logged. Use Log as New Entry first.');
                        return;
                    }

                    const watchChoice = await promptWatchMethodChoice();
                    if (!watchChoice) {
                        showToast('Quick Watch canceled.', { level: 'warn' });
                        return;
                    }

                    await insertWatchLog({
                        user_id: authedUser.id,
                        movie_id,
                        watch_method: watchChoice.watch_method,
                        watch_date: watchChoice.watch_date,
                    });
                    showToast(`Added another watch for ${m.title}!`);

                    // Reset
                    const input = document.getElementById('movie-search-input');
                    if (input) input.value = '';
                    const results = document.getElementById('search-results');
                    if (results) {
                        results.classList.add('hidden');
                        results.innerHTML = '';
                    }
                    this.selectedMovie = null;
                    setHomeActionsVisible(false);
                    setUpdateOptionsHidden();
                    const updateBtn = document.getElementById('update-existing-btn');
                    if (updateBtn) updateBtn.style.display = '';
                } catch (err) {
                    showToast(`Quick Watch failed: ${String(err.message || err)}`);
                }
            },

            async startUpdateRatings() {
                const m = this.selectedMovie;
                if (!m) return;

                try {
                    showLoadingOverlay('Hang tight  fetching your existing entry');
                    if (!supabaseClient) throw new Error('Supabase SDK failed to load.');
                    const { user: authedUser } = await requireAuthOrThrow();

                    // Resolve DB movie UUID using tmdb_id -> Movies.id mapping (read-only).
                    const movie_id = await resolveDbMovieIdFromSelectedMovie(m);
                    if (!movie_id) {
                        showToast('No matching movie found in your database for this selection. Use Log as New Entry first.');
                        return;
                    }

                    const existing = await getExistingMovieRatingRow({ user_id: authedUser.id, movie_id });
                    if (!existing) {
                        showToast('No existing rating found for this movie. Use Log as New Entry instead.');
                        return;
                    }

                    // Pull movie details from the DB so the update form is fully populated.
                    let movieRow = null;
                    try {
                        movieRow = await getDbMovieRowById(movie_id);
                    } catch (_) {
                        movieRow = null;
                    }

                    const latestWatch = await getLatestWatchLog({ user_id: authedUser.id, movie_id });
                    const earliestWatch = await getEarliestWatchLog({ user_id: authedUser.id, movie_id });
                    let watchCount = null;
                    try {
                        watchCount = await getWatchLogCount({ user_id: authedUser.id, movie_id });
                    } catch (_) {
                        watchCount = null;
                    }
                    const watchedTimes = (() => {
                        const n = Number(watchCount);
                        if (Number.isFinite(n) && n > 0) return n;
                        // Back-compat: older data may be missing Watch Logs rows.
                        return 1;
                    })();
                    const defaultDate = getLocalISODate();
                    const date = existing?.[COL_WATCH_DATE]
                        ? String(existing[COL_WATCH_DATE])
                        : (latestWatch?.[COL_WATCH_DATE] ? String(latestWatch[COL_WATCH_DATE]) : defaultDate);

                    const review = {
                        date,
                        tier: existing?.tier ?? '',
                        scores: {
                            overall: Number(existing?.overall_rating ?? 50),
                            sound: Number(existing?.sound_rating ?? 50),
                            pace: Number(existing?.pacing_rating ?? 50),
                            imagery: Number(existing?.imagery_rating ?? 50),
                            acting: Number(existing?.acting_rating ?? 50),
                            plot: Number(existing?.plot_rating ?? 50),
                            dialogue: Number(existing?.dialogue_rating ?? 50),
                        },
                        quote: (() => {
                            const fromDb = String(existing?.fav_quote ?? '').trim();
                            if (fromDb) return fromDb;
                            const fromSelection = String(m?.prefill_quote ?? m?.prefillQuote ?? m?.quote ?? '').trim();
                            return fromSelection;
                        })(),
                        notes: String(existing?.notes ?? ''),
                        watched: watchedTimes,
                        // When updating, show the original (oldest) watch method as the locked form value.
                        watch_method: String(earliestWatch?.watch_method || latestWatch?.watch_method || 'At Home')
                    };

                    const coalesceYear = (row) => {
                        const y = row?.release_year ?? row?.year;
                        const n = Number(y);
                        return Number.isFinite(n) && n > 0 ? n : (m?.year ?? '');
                    };

                    const coalesceRuntime = (row) => {
                        const v = row?.runtime_minutes ?? row?.runtime;
                        const n = Number(v);
                        return Number.isFinite(n) ? n : (m?.runtime ?? '');
                    };

                    const coalesceGenre = (row) => {
                        if (!row) return m?.genre || '';
                        if (typeof row?.genre === 'string') return row.genre;
                        if (Array.isArray(row?.genres)) return row.genres.map(s => String(s).trim()).filter(Boolean).join(', ');
                        if (typeof row?.genres === 'string') return row.genres;
                        return m?.genre || '';
                    };

                    const isGenrePlaceholder = (raw) => {
                        const s = String(raw ?? '').trim();
                        if (!s) return true;
                        const lower = s.toLowerCase();
                        return lower === 'movie' || lower === '0';
                    };

                    // Director/genre can be missing or placeholder in the Movies table.
                    // Prefer DB values, but fall back to TMDb details so the update form matches the Search-bar flow.
                    let resolvedDirector = String(
                        movieRow?.director ??
                        movieRow?.director_name ??
                        movieRow?.directorName ??
                        m?.director ??
                        ''
                    ).trim();

                    let resolvedGenre = String(coalesceGenre(movieRow) ?? '').trim();

                    let resolvedPosterPath = String(
                        movieRow?.poster_path ??
                        m?.poster_path ??
                        m?.posterPath ??
                        m?.poster_url ??
                        m?.posterUrl ??
                        ''
                    ).trim();

                    const tmdb_id = Number(movieRow?.tmdb_id ?? m?.tmdb_id ?? getTmdbIdFromSelectedMovie(m) ?? null);
                    const needsTmdbDetails = (
                        (!resolvedDirector) ||
                        isGenrePlaceholder(resolvedGenre) ||
                        (!resolvedPosterPath)
                    ) && (Number.isFinite(tmdb_id) && tmdb_id > 0);

                    if (needsTmdbDetails) {
                        try {
                            const details = await callSwiftApiGetMovieDetails({ tmdb_id });

                            if (!resolvedDirector) {
                                resolvedDirector = String(details?.director || '').trim();
                            }

                            if (isGenrePlaceholder(resolvedGenre)) {
                                const genres = Array.isArray(details?.genres)
                                    ? details.genres.map(s => String(s).trim()).filter(Boolean)
                                    : [];
                                const joined = genres.length
                                    ? genres.join(', ')
                                    : String(details?.genre || '').trim();
                                if (joined) resolvedGenre = joined;
                            }

                            if (!resolvedPosterPath) {
                                const p = String(details?.poster_path ?? '').trim();
                                if (p) resolvedPosterPath = p;
                            }

                            const imdbPct = details?.imdb_rating_pct;
                            if (imdbPct !== null && imdbPct !== undefined) {
                                m.imdb = String(imdbPct);
                            }
                        } catch (_) {}
                    }

                    this.selectedMovie = {
                        ...m,
                        id: movie_id,
                        tmdb_id: Number(movieRow?.tmdb_id ?? m?.tmdb_id ?? getTmdbIdFromSelectedMovie(m) ?? null) || undefined,
                        title: String(movieRow?.title ?? m?.title ?? '').trim(),
                        year: coalesceYear(movieRow),
                        director: resolvedDirector,
                        mpa: String(movieRow?.mpa_rating ?? movieRow?.mpa ?? m?.mpa ?? '').trim(),
                        runtime: coalesceRuntime(movieRow),
                        isSeries: (movieRow?.is_series ?? movieRow?.isSeries ?? m?.isSeries) === true,
                        genre: resolvedGenre,
                        poster_path: resolvedPosterPath,
                        detailsReadonly: true,
                        mockUserReview: review
                    };

                    // Close the home dropdown UI if it's open.
                    try {
                        document.getElementById('update-options')?.classList?.add('hidden');
                        document.getElementById('update-options')?.classList?.remove('grid');
                    } catch (_) {}

                    this.navigate('submit', 'update');
                } catch (err) {
                    showToast(`Update Ratings failed: ${String(err?.message || err)}`);
                } finally {
                    hideLoadingOverlay();
                }
            },

            toggleUpdateOptions() {
                const opts = document.getElementById('update-options');
                const updateBtn = document.getElementById('update-existing-btn');
                if (!opts) return;

                if (opts.classList.contains('hidden')) {
                    opts.classList.remove('hidden');
                    opts.classList.add('grid');
                    // Once expanded, hide the "Update Existing" button so only the two options remain.
                    if (updateBtn) updateBtn.style.display = 'none';
                    return;
                }

                // If we ever collapse programmatically, restore the button.
                opts.classList.add('hidden');
                opts.classList.remove('grid');
                if (updateBtn) updateBtn.style.display = '';
            },

            renderHome() {
                return `
                    <div>
                        <div class="fade-in">
                        <!-- Hero (Full Width) -->
                        <div class="relative w-full" style="height: 62vh; margin-bottom: 1.5rem;">
                            <!-- Content (Containerized) -->
                            <div class="container" style="height: 100%; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 2.25rem;">
                                <span class="text-xs font-semibold text-brand uppercase" style="background: var(--brand-light); padding: 0.25rem 0.75rem; border-radius: 99px; border: 1px solid color-mix(in srgb, var(--brand) 35%, transparent); width: fit-content; margin-bottom: 1rem;">Start Logging</span>
                                <h1 class="text-5xl font-bold text-white mb-6" style="line-height: 1.1; color: var(--text-main);">Cinematic <br/> <span style="background: linear-gradient(to right, var(--brand), var(--accent-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Masterpieces</span></h1>
                                
                                <div style="max-width: 600px; position: relative;">
                                    <p class="text-xl text-gray mb-4">Search for a movie to add it to your diary.</p>
                                    
                                    <!-- Search -->
                                    <div style="position: relative;">
                                        <div class="input-group mb-4">
                                            <div class="input-icon">${icons.search}</div>
                                            <input type="text" id="movie-search-input" oninput="handleSearch(this.value)" autocomplete="off" placeholder="Type a movie title..." class="input-field glass-input" style="border-radius: 0.85rem;">
                                            <div id="search-results" class="search-dropdown hidden"></div>
                                        </div>
                                        <button type="button" id="movie-search-filters-toggle" class="btn btn-glass" onclick="toggleSearchFiltersPanel()" style="position:absolute; right: 0; top: -36px; height: 30px; padding: 0 0.75rem; border-radius: 0.85rem; font-size: 0.75rem; font-weight: 800; letter-spacing: 0.02em;">Use Filters</button>
                                    </div>

                                    <!-- Optional Filters -->
                                    <div id="movie-search-filters" class="hidden" style="margin-top: -0.25rem; margin-bottom: 1rem; width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 0.75rem; align-items: stretch;">
                                        <input
                                            type="text"
                                            id="movie-search-year"
                                            inputmode="numeric"
                                            placeholder="Year"
                                            class="input-field glass-input"
                                            style="width: 100%; padding-left: 0.9rem; height: 46px; border-radius: 0.85rem;"
                                            oninput="markSearchFiltersDirty()"
                                        />
                                        <select
                                            id="movie-search-mpa"
                                            class="select-field"
                                            style="width: 100%; height: 46px; border-radius: 0.85rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); color: white; padding: 0 0.75rem;"
                                            onchange="markSearchFiltersDirty()"
                                        >
                                            <option value="">MPA</option>
                                            <option value="G">G</option>
                                            <option value="PG">PG</option>
                                            <option value="PG-13">PG-13</option>
                                            <option value="R">R</option>
                                            <option value="NC-17">NC-17</option>
                                            <option value="NR">NR / Unrated</option>
                                        </select>
                                        <button type="button" class="btn btn-glass" style="width: 100%; height:46px; padding: 0 1rem; border-radius: 0.85rem;" onclick="applySearchFilters()">Apply Filters</button>
                                        <button type="button" class="btn btn-glass" style="width: 100%; height:46px; padding: 0 1rem; border-radius: 0.85rem;" onclick="clearSearchFilters()">Clear</button>
                                    </div>

                                    <!-- Action Slot (fixed space so the search UI doesn't jump) -->
                                    <div id="home-action-slot" style="margin-top: 2rem; min-height: 120px;">
                                        <div id="home-action-card" class="glass-panel" style="padding: 1rem; border-radius: 0.75rem;">
                                            <div id="home-action-placeholder" class="text-sm text-gray" style="text-align:center; max-width: 520px; margin: 0 auto;">
                                                Select a movie from the dropdown to log it or update an existing entry.
                                            </div>

                                            <!-- Dynamic Actions (replaces placeholder in the same spot) -->
                                            <div id="movie-actions" class="hidden flex-col gap-4 fade-in">
                                                <div class="flex gap-3">
                                                    <button id="btn-log-new-entry" onclick="router.startNewEntry()" class="btn btn-primary" style="flex:1;">
                                                        ${icons.plusCircle} Log as New Entry
                                                    </button>
                                                    <button id="update-existing-btn" onclick="router.toggleUpdateOptions()" class="btn btn-outline" style="flex:1; border-color: color-mix(in srgb, var(--brand-2) 60%, transparent); background: color-mix(in srgb, var(--brand-2) 30%, transparent);">
                                                        <span style="color: var(--accent-2); width:20px;">${icons.refreshCw}</span> Update Existing
                                                    </button>
                                                </div>

                                                <div class="flex gap-3">
                                                    <button id="btn-add-to-list" type="button" onclick="openAddToListModal()" class="btn btn-glass" style="flex:1; border-radius: 0.85rem;">
                                                        ${icons.plusCircle} Add to List
                                                    </button>
                                                    <button type="button" onclick="router.navigate('lists')" class="btn btn-outline" style="flex:1; border-radius: 0.85rem;">
                                                        ${icons.arrowRight} View Lists
                                                    </button>
                                                </div>

                                                <div id="update-options" class="hidden grid-2 gap-3" style="padding: 1rem; border-radius: 0.75rem; border-style: dashed; border: 1px solid rgba(255,255,255,0.10);">
                                                    <button onclick="router.startUpdateRatings()" class="text-left" style="padding:0.75rem; border-radius:0.5rem; transition: background 0.2s; border: 1px solid rgba(168, 85, 247, 0.45); background: rgba(168, 85, 247, 0.10);">
                                                        <span class="text-brand font-semibold mb-2" style="display:block;">Update Ratings &rarr;</span>
                                                        <span class="text-xs text-gray">Edit your review, scores, and tier.</span>
                                                    </button>
                                                    <button onclick="router.quickIncrement()" class="text-left" style="padding:0.75rem; border-radius:0.5rem; transition: background 0.2s; border: 1px solid rgba(20, 184, 166, 0.45); background: rgba(20, 184, 166, 0.10);">
                                                        <span class="text-brand font-semibold mb-2" style="display:block;">Quick Watch (+1) &rarr;</span>
                                                        <span class="text-xs text-gray">Simply add a view to your count.</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Marquee (Full Width) -->
                        <div style="background: var(--surface); padding: 3rem 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
                            <div class="container mb-6">
                                <h2 class="text-xl font-semibold text-white">Trending Now</h2>
                            </div>
                            <div class="w-full" style="overflow: hidden; position: relative;">
                                <div class="animate-marquee">
                                    <div class="flex" id="trending-track-1"></div>
                                    <div class="flex" id="trending-track-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderLists() {
                return `
                    <div class="fade-in">
                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div>
                                    <h1 class="text-3xl font-bold text-white">Lists</h1>
                                </div>
                                <div class="flex" style="gap: 10px; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-primary" onclick="openListsCreateModal()" style="border-radius: 0.85rem;">New List</button>
                                    <button type="button" class="btn btn-outline" data-lists-action="refresh" style="border-radius: 0.85rem;">Refresh</button>
                                </div>
                            </div>

                            <div class="grid md-row gap-6" style="align-items: stretch;">
                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem; width: 100%; max-width: 360px;">
                                    <div class="text-white font-bold" style="font-size:2.1rem;">Your Lists</div>
                                    <div id="lists-list" class="text-gray" style="margin-top: 0.85rem; display:flex; align-items:center; gap:0.7rem;">
                                        <label for="lists-select" style="margin:0; font-size:1.1rem; font-weight:700; color:#fff;">List:</label>
                                        <select id="lists-select" class="input-field" style="width:100%; border-radius: 0.85rem; max-width:180px;">
                                            <option value="">Loading</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem; flex: 1;">
                                    <div class="flex justify-between items-center" style="gap: 10px; flex-wrap: wrap;">
                                        <div>
                                            <div id="lists-active-title" class="text-white font-bold">Select a list</div>
                                            <div id="lists-active-subtitle" class="text-xs text-gray" style="margin-top: 0.25rem;"></div>
                                        </div>

                                        <div class="flex items-center" style="gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                            <button
                                                id="lists-filter-btn"
                                                type="button"
                                                class="btn btn-outline"
                                                data-lists-action="open_sort_filter"
                                                style="border-radius: 0.75rem; height: 34px; padding: 0.45rem 0.65rem; font-size: 0.85rem;"
                                                disabled
                                            >Filters/Sort</button>
                                            <button
                                                id="lists-rename-btn"
                                                type="button"
                                                class="btn btn-outline"
                                                data-lists-action="rename_list"
                                                style="border-radius: 0.75rem; height: 34px; padding: 0.45rem 0.65rem; font-size: 0.85rem;"
                                                disabled
                                            >Rename</button>
                                            <button
                                                id="lists-delete-btn"
                                                type="button"
                                                class="btn btn-outline"
                                                data-lists-action="delete_list"
                                                style="border-radius: 0.75rem; height: 34px; padding: 0.45rem 0.65rem; font-size: 0.85rem; border-color: rgba(239,68,68,0.55); background: rgba(239,68,68,0.10);"
                                                disabled
                                            >Delete</button>

                                            <!-- Lists-only Search (adds directly to the active list) -->
                                            <div style="position: relative; width: 260px; max-width: 100%;">
                                                <div class="input-group" style="margin: 0;">
                                                    <div class="input-icon" style="height: 34px; display:flex; align-items:center;">${icons.search}</div>
                                                    <input
                                                        type="text"
                                                        id="lists-movie-search-input"
                                                        oninput="handleListsAddMovieSearch(this.value)"
                                                        autocomplete="off"
                                                        placeholder="Select a list to add movies"
                                                        class="input-field glass-input"
                                                        style="border-radius: 0.75rem; height: 34px; font-size: 0.85rem; padding-left: 2.35rem;"
                                                        disabled
                                                    >
                                                    <div id="lists-movie-search-results" class="search-dropdown hidden"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="lists-items" class="text-gray" style="margin-top: 0.85rem;">Choose a list on the left.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderSubmit() {
                const prefill = this.selectedMovie || {};
                const isUpdate = this.formMode === 'update';
                const uuidLike = isUuidLike;
                const hasDbMovie = uuidLike(prefill?.id);
                const detailsReadonly = hasDbMovie || Boolean(prefill?.detailsReadonly);
                const defaultDate = getLocalISODate();
                const allowEditMissingDetails = detailsReadonly && !hasDbMovie;

                const formAccent = isUpdate
                    ? { color: 'var(--brand-2)', name: 'Update Ratings' }
                    : { color: 'var(--brand)', name: 'Log New Entry' };

                const u = (isUpdate && prefill.mockUserReview) ? prefill.mockUserReview : {
                    date: defaultDate, tier: "", scores: { overall: 50, sound: 50, pace: 50, imagery: 50, acting: 50, plot: 50, dialogue: 50 },
                    quote: "", notes: "", watched: 1,
                    watch_method: 'At Home'
                };

                const scoreDefaults = { overall: 50, sound: 50, pace: 50, imagery: 50, acting: 50, plot: 50, dialogue: 50 };
                const scores = { ...scoreDefaults, ...(u?.scores || {}) };
                const scoreOrder = ['overall', 'sound', 'pace', 'imagery', 'acting', 'plot', 'dialogue'];

                const tierLetter = String(u.tier || '').trim().charAt(0).toUpperCase();

                const tierHelpText = (() => {
                    const t = (['S','A','B','C','D','F'].includes(tierLetter)) ? `${tierLetter}-Tier` : String(u.tier || '').trim();
                    if (t === 'S-Tier') return 'The Pantheon. Best of the Best.';
                    if (t === 'A-Tier') return 'Great! Highly recommended films!';
                    if (t === 'B-Tier') return 'Worth a Watch. Solidly good and Entertaining';
                    if (t === 'C-Tier') return "Totally Average. Fine if it's on, but don't go out of your way.";
                    if (t === 'D-Tier') return 'Skip it. Seriously Flawed and not worth the time.';
                    if (t === 'F-Tier') return 'Avoid at all costs! A genuinely bad experience.';
                    return 'Choose exactly one tier';
                })();
                
                const m = {
                    title: prefill.title || '', genre: prefill.genre || '', year: prefill.year || '', mpa: prefill.mpa || '',
                    runtime: (prefill.runtime === null || prefill.runtime === undefined) ? '' : String(prefill.runtime),
                    // For DB movies, we can display Yes/No but still submit TRUE/FALSE.
                    isSeriesDisplay: (prefill.isSeries === true) ? 'Yes' : ((prefill.isSeries === false) ? 'No' : ''),
                    isSeriesValue: (prefill.isSeries === true) ? 'TRUE' : ((prefill.isSeries === false) ? 'FALSE' : ''),
                    director: prefill.director || '', imdb: prefill.imdb || '',
                    poster_path: prefill.poster_path || prefill.posterPath || prefill.poster_url || prefill.posterUrl || ''
                };

                const posterUrl = (() => {
                    const raw = String(m.poster_path || '').trim();
                    if (!raw) return '';
                    if (raw.startsWith('http://') || raw.startsWith('https://')) return raw;
                    // TMDb poster_path comes like "/abc.jpg"
                    return `https://image.tmdb.org/t/p/w342${raw}`;
                })();

                const hasText = (v) => {
                    const s = String(v ?? '').trim();
                    if (!s) return false;
                    if (s === '0') return false;
                    return true;
                };
                const hasPositiveInt = (v) => {
                    const n = Number(String(v ?? '').trim());
                    return Number.isFinite(n) && n > 0;
                };

                // Lock only fields that already have meaningful values.
                // This prevents users getting stuck with blank read-only fields while we enforce required inputs.
                const titleLocked = detailsReadonly && hasText(m.title);
                const yearLocked = detailsReadonly && hasPositiveInt(m.year);
                const mpaLocked = detailsReadonly && hasText(m.mpa);
                const runtimeLocked = detailsReadonly && hasPositiveInt(m.runtime);
                const seriesLocked = detailsReadonly && hasText(m.isSeriesValue);
                const directorLocked = detailsReadonly && hasText(m.director);

                // When updating an existing rating, Times Watched should reflect Watch Logs history,
                // and it should not be editable on the form.
                const timesWatchedLocked = isUpdate;

                // When updating an existing rating, Watch Method should not be editable on the form.
                // New watches are recorded via Watch Logs with a separate watch-method prompt.
                const watchMethodLocked = isUpdate;

                const genreLower = String(m.genre || '').trim().toLowerCase();
                const genrePlaceholder = allowEditMissingDetails && (genreLower === 'movie' || genreLower === '0');
                const genreLocked = detailsReadonly && (hasText(m.genre) && !genrePlaceholder);

                const clampPct = (n) => {
                    const v = Number(n);
                    if (!Number.isFinite(v)) return 0;
                    return Math.max(0, Math.min(100, v));
                };

                const parseExternalPercent = (raw, { imdb = false } = {}) => {
                    const s = String(raw ?? '').trim();
                    if (!s) return 0;
                    const num = parseFloat(s.replace('%', ''));
                    if (!Number.isFinite(num)) return 0;
                    let out = num;
                    // Accept a few common forms:
                    // - 83%  -> 83
                    // - 0.83 -> 83
                    // - IMDb 8.7 (/10) -> 87
                    if (num <= 1) out = num * 100;
                    else if (imdb && num <= 10) out = num * 10;
                    return clampPct(Math.round(out));
                };

                const imdbPct = parseExternalPercent(m.imdb, { imdb: true });
                // Only lock IMDb when we actually have a real (non-zero) value.
                // DB movies can legitimately be missing IMDb; do not lock the user out at 0.
                const imdbLocked = detailsReadonly && (imdbPct > 0);

                const selectedGenres = String(m.genre || '')
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean);

                const genreOptions = [
                    'Action','Adventure','Animation','Comedy','Crime','Documentary','Drama','Family','Fantasy','History',
                    'Horror','Music','Mystery','Romance','Sci-Fi','TV Movie','Thriller','War','Western'
                ];

                return `
                    <div class="fade-in">
                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                        <div class="flex items-center gap-4 mb-8">
                            <button onclick="router.goBack()" style="color: var(--text-muted); padding: 0.5rem; border-radius: 50%;">
                                ${icons.arrowLeft}
                            </button>
                            <div>
                                <div class="flex items-center gap-2" style="flex-wrap: wrap;">
                                    <h1 class="text-3xl font-bold text-white">${isUpdate ? 'Update Ratings' : 'Log New Entry'}</h1>
                                    <span style="display:inline-flex; align-items:center; height: 28px; padding: 0 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 900; letter-spacing: 0.06em; text-transform: uppercase; color: rgba(255,255,255,0.95); background: color-mix(in srgb, ${formAccent.color} 16%, transparent); border: 1px solid color-mix(in srgb, ${formAccent.color} 35%, transparent);">
                                        ${formAccent.name}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <form onsubmit="handleFormSubmit(event)" class="grid grid-3 gap-6" style="border: 1px solid color-mix(in srgb, ${formAccent.color} 18%, transparent); border-radius: 1.2rem; padding: 0.75rem; background: rgba(0,0,0,0.12);">
                            <input type="hidden" name="entryType" value="${isUpdate ? 'update' : 'new'}">
                            <input type="hidden" id="fld-movie-id" value="${hasDbMovie ? String(prefill.id) : ''}">
                            <input type="hidden" id="fld-tmdb-id" value="${Number.isFinite(Number(prefill?.tmdb_id)) ? String(Number(prefill.tmdb_id)) : ''}">
                            <!-- Read Only Section -->
                            <div class="glass-panel" style="padding: 1.5rem; border-radius: 1rem; background: color-mix(in srgb, ${formAccent.color} 10%, transparent); border: 1px solid color-mix(in srgb, ${formAccent.color} 22%, transparent);">
                                <div class="flex items-center gap-3 mb-4">
                                    <span style="color: ${formAccent.color};">${icons.database}</span>
                                    <h2 class="text-xl font-semibold text-white">Movie Details</h2>
                                </div>
                                <div style="background: color-mix(in srgb, var(--brand) 12%, transparent); border: 1px solid color-mix(in srgb, var(--brand) 22%, transparent); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1.5rem;" class="text-sm flex items-center gap-2">
                                    <span style="width:16px;">${icons.info}</span>
                                    <span style="color: var(--text-main);">${hasDbMovie ? 'Auto-filled from DB' : (allowEditMissingDetails ? 'Auto-filled from TMDb (edit any missing fields)' : 'Auto-filled from TMDb')}</span>
                                </div>

                                ${posterUrl ? `
                                    <div style="display:flex; justify-content:center; margin-bottom: 1.25rem;">
                                        <img
                                            src="${posterUrl}"
                                            alt="${escapeHtml(m.title || 'Movie poster')}"
                                            style="width: 180px; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 0.9rem; border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 16px 40px rgba(0,0,0,0.35);"
                                            loading="lazy"
                                            onerror="this.onerror=null; this.parentElement.remove();"
                                        >
                                    </div>
                                ` : ''}

                                <div class="flex flex-col gap-4">
                                    <div><label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Title</label><input id="fld-title" name="Title" class="input-field ${titleLocked ? 'input-readonly' : ''}" value="${m.title}" ${titleLocked ? 'readonly' : ''} ${(titleLocked && hasText(m.title)) ? '' : 'required'} placeholder="Type a movie title"></div>
                                    <div class="grid grid-2 gap-4">
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Year</label>
                                            <input
                                                id="fld-year"
                                                name="Year"
                                                type="number"
                                                inputmode="numeric"
                                                step="1"
                                                class="input-field ${yearLocked ? 'input-readonly' : ''}"
                                                value="${m.year}"
                                                ${yearLocked ? 'readonly' : ''}
                                                placeholder="e.g. 2024"
                                            >
                                        </div>
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">MPA</label>
                                            ${mpaLocked ? `
                                                <input id="fld-mpa" name="MPA" class="input-field input-readonly" value="${m.mpa}" readonly>
                                            ` : `
                                                <select id="fld-mpa" name="MPA" class="select-field" required>
                                                    <option value="" disabled ${!String(m.mpa || '').trim() ? 'selected' : ''}>Select...</option>
                                                    <option value="G" ${String(m.mpa).trim() === 'G' ? 'selected' : ''}>G</option>
                                                    <option value="PG" ${String(m.mpa).trim() === 'PG' ? 'selected' : ''}>PG</option>
                                                    <option value="PG-13" ${String(m.mpa).trim() === 'PG-13' ? 'selected' : ''}>PG-13</option>
                                                    <option value="R" ${String(m.mpa).trim() === 'R' ? 'selected' : ''}>R</option>
                                                    <option value="NC-17" ${String(m.mpa).trim() === 'NC-17' ? 'selected' : ''}>NC-17</option>
                                                </select>
                                            `}
                                        </div>
                                    </div>
                                    <div class="grid grid-2 gap-4">
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Runtime (min)</label>
                                            ${runtimeLocked ? `
                                                <input id="fld-runtime" name="Run Time" type="number" inputmode="numeric" step="1" class="input-field input-readonly" value="${m.runtime}" readonly>
                                            ` : `
                                                <input
                                                    id="fld-runtime"
                                                    name="Run Time"
                                                    type="number"
                                                    inputmode="numeric"
                                                    step="1"
                                                    min="0"
                                                    autocomplete="off"
                                                    class="input-field"
                                                    value="${m.runtime}"
                                                    placeholder="Minutes"
                                                >
                                            `}
                                        </div>
                                        <div>
                                            <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Series?</label>
                                            ${seriesLocked ? `
                                                <input id="fld-series-display" class="input-field input-readonly" value="${m.isSeriesDisplay}" readonly>
                                                <input type="hidden" id="fld-series" name="Series" value="${m.isSeriesValue}">
                                            ` : `
                                                <select id="fld-series" name="Series" class="select-field">
                                                    <option value="" disabled ${!String(m.isSeriesValue || '').trim() ? 'selected' : ''}>Select...</option>
                                                    <option value="TRUE" ${String(m.isSeriesValue).trim() === 'TRUE' ? 'selected' : ''}>Yes</option>
                                                    <option value="FALSE" ${String(m.isSeriesValue).trim() === 'FALSE' ? 'selected' : ''}>No</option>
                                                </select>
                                            `}
                                        </div>
                                    </div>
                                    <div><label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Director</label><input id="fld-director" name="Director" class="input-field ${directorLocked ? 'input-readonly' : ''}" value="${m.director}" ${directorLocked ? 'readonly' : ''}></div>
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Genre</label>
                                        ${genreLocked ? `
                                            <input id="fld-genre" name="Genre" class="input-field input-readonly" value="${m.genre}" readonly>
                                        ` : `
                                            <input type="hidden" id="fld-genre" name="Genre" value="${selectedGenres.join(', ')}">
                                            <div id="genre-chip-wrap" class="genre-chip-wrap">
                                                ${genreOptions.map(g => `
                                                    <button
                                                        type="button"
                                                        class="genre-chip ${selectedGenres.includes(g) ? 'selected' : ''}"
                                                        data-genre="${g}"
                                                        aria-pressed="${selectedGenres.includes(g) ? 'true' : 'false'}"
                                                        onclick="toggleGenreChip(this)"
                                                    >${g}</button>
                                                `).join('')}
                                            </div>
                                            <div class="text-xs text-gray" style="margin-top:0.5rem;">Select any genres that apply</div>
                                        `}
                                    </div>

                                    <div style="border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1rem; margin-top: 0.5rem;">
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">External Ratings</label>
                                        <div class="flex flex-col gap-4">
                                            <div>
                                                <label class="text-xs text-gray submit-label block" style="margin-bottom: 0.25rem;">IMDb Rating</label>
                                                <div class="slider-container">
                                                    <input
                                                        id="fld-imdb-range"
                                                        type="range"
                                                        min="0"
                                                        max="100"
                                                        value="${imdbPct}"
                                                        ${imdbLocked ? 'disabled' : ''}
                                                        ${imdbLocked ? '' : "oninput=\"document.getElementById('fld-imdb').value = this.value\""}
                                                    >
                                                    <div class="relative" style="width: 140px;">
                                                        <input
                                                            type="number"
                                                            id="fld-imdb"
                                                            name="IMDb"
                                                            value="${imdbPct}"
                                                            min="0"
                                                            max="100"
                                                            class="input-field text-center ${imdbLocked ? 'input-readonly' : ''}"
                                                            ${imdbLocked ? 'readonly' : ''}
                                                            ${imdbLocked ? '' : "oninput=\"document.getElementById('fld-imdb-range').value = this.value\""}
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- User Input Section -->
                            <div class="glass-panel col-span-2" style="padding: 2rem; padding-bottom: calc(2rem - 10px); border-radius: 1rem; border: 1px solid rgba(${formAccent.rgb}, 0.14);">
                                <div class="flex justify-between items-center mb-6" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; margin-bottom: 10px;">
                                    <div class="flex items-center gap-3">
                                        <span style="color: ${formAccent.hex};">${icons.edit3}</span>
                                        <h2 class="text-xl font-semibold text-white">Your Review</h2>
                                    </div>
                                </div>

                                <div class="grid md-row gap-6 mb-6" style="margin-top: 0px;">
                                    <div style="flex:1;">
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Date Watched</label>
                                        <input id="fld-datewatch" name="Date Watch" type="date" class="input-field ${isUpdate ? 'input-readonly' : ''}" value="${u.date}" ${isUpdate ? 'readonly title="Locked while updating"' : ''} onclick="openDatePickerFromInput(this)" onfocus="openDatePickerFromInput(this)" required>
                                    </div>
                                    <div style="flex:1;">
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Tier List</label>
                                        <input type="hidden" id="fld-tier" name="Tier List" value="${(['S','A','B','C','D','F'].includes(tierLetter) ? `${tierLetter}-Tier` : String(u.tier || ''))}">
                                        <div class="tier-btn-group" style="margin-top: 0.35rem;" data-target-input="fld-tier" data-has-selection="${String(u.tier || '').trim() ? 'true' : 'false'}">
                                            <button type="button" class="tier-btn ${tierLetter === 'S' ? 'selected' : ''}" data-tier="S-Tier" aria-pressed="${tierLetter === 'S' ? 'true' : 'false'}" onclick="setTierFromButton(this)">S</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'A' ? 'selected' : ''}" data-tier="A-Tier" aria-pressed="${tierLetter === 'A' ? 'true' : 'false'}" onclick="setTierFromButton(this)">A</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'B' ? 'selected' : ''}" data-tier="B-Tier" aria-pressed="${tierLetter === 'B' ? 'true' : 'false'}" onclick="setTierFromButton(this)">B</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'C' ? 'selected' : ''}" data-tier="C-Tier" aria-pressed="${tierLetter === 'C' ? 'true' : 'false'}" onclick="setTierFromButton(this)">C</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'D' ? 'selected' : ''}" data-tier="D-Tier" aria-pressed="${tierLetter === 'D' ? 'true' : 'false'}" onclick="setTierFromButton(this)">D</button>
                                            <button type="button" class="tier-btn ${tierLetter === 'F' ? 'selected' : ''}" data-tier="F-Tier" aria-pressed="${tierLetter === 'F' ? 'true' : 'false'}" onclick="setTierFromButton(this)">F</button>
                                        </div>
                                        <div class="text-xs text-gray" id="tier-help-text" style="margin-top: 0.4rem;">${tierHelpText}</div>
                                    </div>
                                </div>

                                <div class="mb-8">
                                    <h3 class="text-sm font-bold text-white uppercase mb-4 label-gap">Detailed Scoring (%)</h3>
                                    <div class="grid grid-2 gap-6">
                                        ${scoreOrder.map(key => `
                                            <div style="${key === 'overall' ? 'grid-column: span 2; padding: 1rem; border-radius: 0.75rem; background: var(--brand-light); border: 1px solid rgba(20,184,166,0.22);' : ''}">
                                                <label class="text-sm ${key === 'overall' ? 'text-white' : 'text-white'} font-bold mb-2 label-gap submit-label block capitalize" style="${key === 'overall' ? 'display:flex; align-items:center; gap:0.5rem;' : ''}">${key === 'overall' ? `<span class=\"text-brand\">${icons.star}</span><span>Overall</span>` : key === 'sound' ? 'Score - Sound Design' : key === 'imagery' ? 'Imagery - CGI - Animation' : key === 'acting' ? 'Acting - Character Animation' : key}</label>
                                                <div class="slider-container">
                                                    <input type="range" min="0" max="100" value="${scores[key]}" oninput="document.getElementById('num-${key}').value = this.value">
                                                    <div class="relative" style="width: 140px;">
                                                        <input
                                                            type="number"
                                                            id="num-${key}"
                                                            name="${key === 'overall' ? 'Overall' : key === 'sound' ? 'Score - Sound Design' : key === 'pace' ? 'Pace' : key === 'imagery' ? 'Imagery - CGI - Animation' : key === 'plot' ? 'Plot - Writting' : key === 'acting' ? 'Acting - Character Animation' : key === 'dialogue' ? 'Dialogue' : key}"
                                                            value="${scores[key]}"
                                                            min="0"
                                                            max="100"
                                                            class="input-field text-center ${key === 'overall' ? 'font-bold' : ''}"
                                                            oninput="this.parentElement.previousElementSibling.value = this.value"
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="flex flex-col gap-6" style="margin-bottom: 0px;">
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Favorite Quote</label>
                                        <div class="relative">
                                            <div class="input-icon">${icons.quote}</div>
                                            <input id="fld-quote" name="Fav Quote" type="text" class="input-field" style="padding-left: 2.5rem;" value="${escapeHtml(u.quote)}" placeholder="One liner...">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block capitalize">Notes / Review</label>
                                        <textarea id="fld-notes" name="Notes" class="textarea-field" rows="4" placeholder="Review...">${u.notes}</textarea>
                                    </div>
                                        <div class="grid grid-2 gap-6">
                                            <div class="flex items-center justify-start" style="gap: 25px;">
                                                <span class="text-sm text-white font-bold label-gap capitalize">Times Watched</span>
                                                <input id="fld-timeswatch" name="Times Watch" type="number" min="1" value="${u.watched}" class="input-field text-center ${timesWatchedLocked ? 'input-readonly' : ''}" style="width: 100px; height: 42px;" ${timesWatchedLocked ? 'readonly' : ''}>
                                            </div>
                                            <div class="flex items-center justify-start" style="gap: 25px;">
                                                <span class="text-sm text-white font-bold label-gap capitalize">Watch Method</span>
                                                <button
                                                    type="button"
                                                    id="watchmethod-toggle"
                                                    class="input-field ${watchMethodLocked ? 'input-readonly' : ''}"
                                                    style="width: 110px; height: 42px; display:flex; align-items:center; justify-content:center; padding:0; background-color: ${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'rgba(20, 184, 166, 0.35)' : 'rgba(168, 85, 247, 0.35)'}; color: white; border-color: ${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'rgba(20, 184, 166, 0.5)' : 'rgba(168, 85, 247, 0.5)'};"
                                                    ${watchMethodLocked ? 'disabled title="Locked while updating"' : 'onclick="toggleWatchMethod(this)"'}
                                                >
                                                    ${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'In Theater' : 'At Home'}
                                                </button>
                                                <input type="hidden" id="fld-watchmethod" name="Watch Method" value="${String(u.watch_method || 'At Home').toLowerCase().includes('theater') ? 'In Theater' : 'At Home'}">
                                            </div>
                                        </div>
                                </div>

                                <div class="flex" style="border-top: 1px solid rgba(255,255,255,0.05); margin-top: 15px; padding-top: 15px; justify-content: ${isUpdate ? 'space-between' : 'center'}; gap: 10px; flex-wrap: wrap;">
                                    ${isUpdate ? `
                                        <button id="btn-delete-rating" type="button" class="btn btn-outline" style="margin-top: 0px; border-radius: 0.85rem; border-color: rgba(239,68,68,0.55); color: rgba(239,68,68,0.95); background: rgba(239,68,68,0.10);" onclick="openDeleteRatingModal()">
                                            Delete
                                        </button>
                                    ` : ''}
                                    <button id="btn-save-diary" type="submit" class="btn btn-primary" style="margin-top: 0px; opacity: 0.6;" aria-disabled="true" title="Please log in first.">
                                        ${icons.save} Save to Diary
                                    </button>
                                </div>
                            </div>
                        </form>
                        </div>
                    </div>
                `;
            },

            renderDashboard() {
                return `
                    <div class="fade-in">
                        <div class="container" style="padding-top: 2rem; position: relative;">
                        <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                            <div>
                                <h1 class="text-3xl font-bold text-white">Data Dashboard</h1>
                                <p class="text-gray mt-2">Insights into your viewing habits.</p>
                            </div>

                            <!-- Tabs (moved up) -->
                            <div class="glass-panel" style="padding: 0.55rem; border-radius: 0.9rem;">
                                <div class="flex" style="gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                    <button type="button" class="btn dash-pill-btn btn-glass" id="dash-tab-general" data-tab="general" style="padding: 0.6rem 0.9rem;">General</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-ratings" data-tab="ratings" style="padding: 0.6rem 0.9rem;">Ratings</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-tiers" data-tab="tiers" style="padding: 0.6rem 0.9rem;">Tiers</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-favorites" data-tab="favorites" style="padding: 0.6rem 0.9rem;">Favorites</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-charts" data-tab="charts" style="padding: 0.6rem 0.9rem;">Heatmaps</button>
                                    <button type="button" class="btn dash-pill-btn btn-outline" id="dash-tab-quotes" data-tab="quotes" style="padding: 0.6rem 0.9rem;">Quote Wall</button>
                                </div>
                            </div>
                        </div>

                        <!-- Timeframe (shown for all tabs) -->
                        <div class="dash-dashboard-row" style="display:flex; gap: 16px; align-items: flex-start; justify-content: space-between; flex-wrap: nowrap; margin-bottom: 1.25rem;">
                            <div style="display:flex; gap: 12px; align-items: flex-start; flex-wrap: nowrap;">
                                <div class="glass-panel" style="padding: 0.55rem 0.75rem; border-radius: 0.9rem; flex: 0 0 auto;">
                                    <div class="text-xs text-gray" style="margin-bottom: 0.4rem;">Timeframe</div>
                                    <div class="flex" style="gap: 10px; flex-wrap: wrap;">
                                        <button type="button" class="btn dash-pill-btn btn-glass" id="dash-range-all-time" data-range="all_time" style="padding: 0.55rem 0.85rem;">All Time</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" id="dash-range-this-year" data-range="this_year" style="padding: 0.55rem 0.85rem;">This Year</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" id="dash-range-this-month" data-range="this_month" style="padding: 0.55rem 0.85rem;">This Month</button>
                                    </div>
                                </div>

                                <div id="dash-general-mode-panel" class="glass-panel hidden" style="padding: 0.55rem 0.75rem; border-radius: 0.9rem; flex: 0 0 auto;">
                                    <div class="text-xs text-gray" style="margin-bottom: 0.4rem;">Counts</div>
                                    <div id="dash-general-mode-wrap" class="flex" style="gap: 10px; flex-wrap: wrap;">
                                        <button type="button" class="btn dash-pill-btn btn-glass" data-mode="total" id="dash-general-mode-total" style="padding: 0.55rem 0.85rem;">Total Watches</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-mode="unique" id="dash-general-mode-unique" style="padding: 0.55rem 0.85rem;">Unique Movies</button>
                                    </div>
                                </div>

                                <!-- Charts-only: Chart selector (shown only when Charts tab active) -->
                                <div id="dash-chart-tab-panel" class="glass-panel hidden" style="padding: 0.55rem 0.75rem; border-radius: 0.9rem; flex: 0 0 auto;">
                                    <div class="text-xs text-gray" style="margin-bottom: 0.4rem;">Heatmaps</div>
                                    <div id="dash-chart-tab-wrap" class="flex" style="gap: 10px; flex-wrap: wrap;">
                                        <button type="button" class="btn dash-pill-btn btn-glass" data-chart="heatmap" id="dash-chart-tab-heatmap" style="padding: 0.55rem 0.85rem;">Ratings Compare</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-chart="activity" id="dash-chart-tab-activity" style="padding: 0.55rem 0.85rem;">Activity</button>
                                    </div>
                                </div>
                            </div>

                            <div style="display:flex; gap: 12px; align-items: flex-start; flex-wrap: nowrap;">
                                <!-- Favorites-only: Rank By controls (shown only when Favorites tab active) -->
                                <div id="dash-fav-metric-panel" class="glass-panel hidden" style="padding: 0.55rem 0.75rem; border-radius: 0.9rem; flex: 0 0 auto;">
                                    <div class="text-xs text-gray" style="margin-bottom: 0.4rem;">Rank by</div>
                                    <div id="dash-fav-metric-wrap" class="flex" style="gap: 10px; flex-wrap: wrap;">
                                        <button type="button" class="btn dash-pill-btn btn-glass" data-metric="overall" id="dash-fav-metric-overall" style="padding: 0.55rem 0.85rem;">Overall</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-metric="sound" id="dash-fav-metric-sound" style="padding: 0.55rem 0.85rem;">Sound</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-metric="plot" id="dash-fav-metric-plot" style="padding: 0.55rem 0.85rem;">Plot</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-metric="pace" id="dash-fav-metric-pace" style="padding: 0.55rem 0.85rem;">Pace</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-metric="acting" id="dash-fav-metric-acting" style="padding: 0.55rem 0.85rem;">Acting</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-metric="imagery" id="dash-fav-metric-imagery" style="padding: 0.55rem 0.85rem;">Imagery</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-metric="dialogue" id="dash-fav-metric-dialogue" style="padding: 0.55rem 0.85rem;">Dialogue</button>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Tab: General -->
                        <div id="dash-pane-general" class="dash-pane-wrap">
                            <div class="dash-gen-top">
                                <div class="glass-panel dash-kpi-chart dash-general-pie-card">
                                    <div class="dash-kpi-header-row">
                                        <div class="dash-kpi-chart-title" id="dash-general-pie-title">MPA Share</div>
                                        <div class="dash-general-pie-toggle" id="dash-general-pie-toggle">
                                            <button type="button" class="btn dash-pill-btn btn-glass" data-pie="mpa" style="padding: 0.45rem 0.7rem;">MPA</button>
                                            <button type="button" class="btn dash-pill-btn btn-outline" data-pie="decade" style="padding: 0.45rem 0.7rem;">Decade</button>
                                            <button type="button" class="btn dash-pill-btn btn-outline" data-pie="genre" style="padding: 0.45rem 0.7rem;">Genre</button>
                                        </div>
                                    </div>
                                    <div class="dash-pie-row">
                                        <div class="dash-pie" id="dash-general-share-pie">
                                            <div class="dash-pie-center">
                                                <div class="dash-pie-value tabular-nums" id="dash-general-watch-events-total"></div>
                                                <div class="dash-pie-label" id="dash-general-watch-label">Watches</div>
                                                <div class="dash-pie-value-sm tabular-nums" id="dash-general-hours-watched"></div>
                                                <div class="dash-pie-label" id="dash-general-hours-label">Hours</div>
                                            </div>
                                        </div>
                                        <div class="dash-pie-legend" id="dash-general-share-legend"></div>
                                    </div>
                                </div>
                                <div class="glass-panel dash-kpi-chart dash-watch-method-card">
                                    <div class="dash-kpi-chart-title">Watch Method</div>
                                    <div class="dash-stack-bar" aria-hidden="true">
                                        <div class="dash-stack-fill is-home" id="dash-general-stack-home"></div>
                                        <div class="dash-stack-fill is-theater" id="dash-general-stack-theater"></div>
                                    </div>
                                    <div class="dash-vertical-labels">
                                        <div class="dash-kpi-clickable" data-watch-method="At Home" role="button" tabindex="0">
                                            <div class="dash-highlight-label dash-watch-label dash-watch-home">At home</div>
                                            <div class="dash-highlight-name tabular-nums dash-watch-value" id="dash-general-at-home-watches"></div>
                                            <div class="dash-highlight-count dash-watch-count" id="dash-general-at-home-label">Watch events</div>
                                        </div>
                                        <div class="dash-kpi-clickable" data-watch-method="In Theater" role="button" tabindex="0">
                                            <div class="dash-highlight-label dash-watch-label dash-watch-theater">In theater</div>
                                            <div class="dash-highlight-name tabular-nums dash-watch-value" id="dash-general-in-theater-watches"></div>
                                            <div class="dash-highlight-count dash-watch-count" id="dash-general-in-theater-label">Watch events</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="dash-gen-bottom">
                                <div class="glass-panel dash-kpi-chart dash-highlight-combined">
                                    <div class="dash-kpi-chart-title">Most Watched</div>
                                    <div class="dash-highlight-combined-grid">
                                        <div class="dash-highlight-card dash-kpi-clickable" data-general-kpi="most_watched_director">
                                            <div class="dash-highlight-card-title">Director(s)</div>
                                            <div class="dash-person-card">
                                                <div class="dash-kpi-top-count tabular-nums" id="dash-general-top-director-events-count">&nbsp;</div>
                                                <div class="dash-person-poster is-empty">
                                                    <img id="dash-general-top-director-avatar" alt="Top director" loading="lazy" onerror="this.removeAttribute('src'); this.closest('.dash-person-poster')?.classList.add('is-empty');">
                                                </div>
                                                <div class="dash-person-name" id="dash-general-top-director-events"></div>
                                                <div class="dash-person-count tabular-nums" id="dash-general-top-director-avg">&nbsp;</div>
                                            </div>
                                            <div class="dash-kpi-more" id="dash-general-top-director-more"></div>
                                        </div>
                                        <div class="dash-highlight-card dash-kpi-clickable" data-general-kpi="most_watched_movie">
                                            <div class="dash-highlight-card-title">Movie(s)</div>
                                            <div class="dash-most-movie-grid" id="dash-general-top-movie-grid">
                                                <div class="text-gray">Loading</div>
                                            </div>
                                        </div>
                                        <div class="dash-highlight-card dash-kpi-clickable" data-general-kpi="most_watched_actor">
                                            <div class="dash-highlight-card-title">Actor(s)</div>
                                            <div class="dash-person-card">
                                                <div class="dash-kpi-top-count tabular-nums" id="dash-general-top-actor-events-count">&nbsp;</div>
                                                <div class="dash-person-poster is-empty">
                                                    <img id="dash-general-top-actor-avatar" alt="Top actor" loading="lazy" onerror="this.removeAttribute('src'); this.closest('.dash-person-poster')?.classList.add('is-empty');">
                                                </div>
                                                <div class="dash-person-name" id="dash-general-top-actor-events"></div>
                                                <div class="dash-person-count tabular-nums" id="dash-general-top-actor-avg">&nbsp;</div>
                                            </div>
                                            <div class="dash-kpi-more" id="dash-general-top-actor-more"></div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Tab: Ratings -->
                        <div id="dash-pane-ratings" class="dash-pane-wrap hidden">
                            <div class="glass-panel dash-kpi-chart dash-genre-full" style="margin-bottom: 1rem;">
                                <div class="dash-kpi-header-row" style="align-items: flex-start;">
                                    <div>
                                        <div class="dash-kpi-chart-title" id="dash-ratings-chart-title">Average Rating by Genre</div>
                                        <div class="text-xs text-gray" id="dash-ratings-genre-meta"></div>
                                    </div>
                                    <div id="dash-ratings-chart-tab-wrap" class="flex" style="gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                        <button type="button" class="btn dash-pill-btn btn-glass" data-chart="genre" id="dash-ratings-tab-genre" style="padding: 0.45rem 0.7rem;">Genre</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-chart="decade" id="dash-ratings-tab-decade" style="padding: 0.45rem 0.7rem;">Decade</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-chart="mpa" id="dash-ratings-tab-mpa" style="padding: 0.45rem 0.7rem;">MPA</button>
                                    </div>
                                </div>
                                <div id="dash-ratings-genre-bars" class="dash-chart-scroll text-gray">Loading</div>
                            </div>

                            <div class="glass-panel dash-kpi-chart" style="margin-bottom: 1rem;">
                                <div class="dash-kpi-chart-title">Average Ratings</div>
                                <div class="dash-ratings-avg-grid" id="dash-ratings-avg-grid">
                                    <div class="text-gray">Loading</div>
                                </div>
                            </div>

                            <div class="glass-panel dash-kpi-chart">
                                <div class="dash-kpi-chart-title">Director Ratings</div>
                                <div class="dash-ratings-directors-grid">
                                    <div class="dash-highlight-card dash-kpi-clickable" data-ratings-kpi="ratings_highest_director">
                                        <div class="dash-highlight-card-title">Highest Rated</div>
                                        <div class="dash-person-card">
                                            <div class="dash-person-poster is-empty">
                                                <img id="dash-ratings-top-director-avatar" alt="Highest rated director" loading="lazy" onerror="this.removeAttribute('src'); this.closest('.dash-person-poster')?.classList.add('is-empty');">
                                            </div>
                                            <div class="dash-person-name" id="dash-ratings-top-director"></div>
                                            <div class="dash-person-count tabular-nums" id="dash-ratings-top-director-meta">&nbsp;</div>
                                        </div>
                                    </div>
                                    <div class="dash-highlight-card dash-kpi-clickable" data-ratings-kpi="ratings_lowest_director">
                                        <div class="dash-highlight-card-title">Lowest Rated</div>
                                        <div class="dash-person-card">
                                            <div class="dash-person-poster is-empty">
                                                <img id="dash-ratings-bottom-director-avatar" alt="Lowest rated director" loading="lazy" onerror="this.removeAttribute('src'); this.closest('.dash-person-poster')?.classList.add('is-empty');">
                                            </div>
                                            <div class="dash-person-name" id="dash-ratings-bottom-director"></div>
                                            <div class="dash-person-count tabular-nums" id="dash-ratings-bottom-director-meta">&nbsp;</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Tiers (placeholder for now) -->
                        <div id="dash-pane-tiers" class="dash-pane-wrap hidden">
                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem; margin-bottom: 1.25rem;">
                                <div class="flex justify-between mb-4">
                                    <span class="text-gray text-sm">Tier Distribution</span>
                                    <span class="text-brand">${icons.pieChart}</span>
                                </div>
                                <div id="dash-tiers-bars"></div>
                            </div>

                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                <div class="flex justify-between mb-4">
                                    <span class="text-gray text-sm">Movies By Tier</span>
                                    <span class="text-brand">${icons.film}</span>
                                </div>
                                <div id="dash-tiers-lists"></div>
                            </div>
                        </div>

                        <!-- Tab: Favorites -->
                        <div id="dash-pane-favorites" class="dash-pane-wrap hidden">
                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem; margin-bottom: 1.25rem;">
                                <div class="flex justify-between mb-4">
                                    <span id="dash-fav-top-label" style="font-size: 1.05rem; font-weight: 700; color: #34d399;">Top 5</span>
                                    <div style="display:flex; align-items:center; gap: 8px;">
                                        <button type="button" class="btn btn-outline" id="dash-fav-limit-toggle-top" style="padding: 0.35rem 0.6rem; border-radius: 0.75rem;">Show 10</button>
                                        <span style="color: #34d399;">${icons.trendingUp}</span>
                                    </div>
                                </div>
                                <div id="dash-fav-top"></div>
                            </div>

                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.75rem;">
                                <div class="flex justify-between mb-4">
                                    <span id="dash-fav-bottom-label" style="font-size: 1.05rem; font-weight: 700; color: #fb7185;">Bottom 5</span>
                                    <div style="display:flex; align-items:center; gap: 8px;">
                                        <button type="button" class="btn btn-outline" id="dash-fav-limit-toggle-bottom" style="padding: 0.35rem 0.6rem; border-radius: 0.75rem;">Show 10</button>
                                        <span style="color: #fb7185;">${icons.trendingDown}</span>
                                    </div>
                                </div>
                                <div id="dash-fav-bottom"></div>
                            </div>
                        </div>

                        <!-- Tab: Charts -->
                        <div id="dash-pane-charts" class="dash-pane-wrap hidden">
                            <div class="glass-panel dash-chart-card dash-chart-stage">
                                <div class="dash-chart-header">
                                    <div id="dash-chart-title" class="dash-chart-title">Genre/Decade Heatmap</div>
                                    <div id="dash-heatmap-select-wrap" style="display:none;">
                                        <select id="dash-heatmap-pair" class="input-field" style="min-width: 220px; padding: 0.5rem 0.75rem; border-radius: 0.75rem; font-weight: 700;">
                                            <option value="genre_decade">Genre v Decade</option>
                                            <option value="genre_mpa">Genre v MPA</option>
                                            <option value="decade_mpa">MPA v Decade</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="dash-chart-body" class="dash-chart-body text-gray">Loading</div>
                            </div>
                        </div>

                        <!-- Tab: Quote Wall -->
                        <div id="dash-pane-quotes" class="dash-pane-wrap hidden">
                            <div class="glass-panel" style="padding:1.5rem; border-radius:0.95rem;">
                                <div class="flex justify-between mb-4" style="gap: 14px; align-items: flex-start; flex-wrap: wrap;">
                                    <div>
                                        <div class="text-white" style="font-size: 1.1rem; font-weight: 800;">Quote Wall</div>
                                        <div class="text-xs text-gray" style="margin-top: 0.35rem;">Top quotes (max 50), ranked by Overall rating. Click a card to jump to Update Ratings.</div>
                                    </div>
                                    <div class="text-xs text-gray" id="dash-quote-wall-meta" style="text-align:right;"></div>
                                </div>
                                <div id="dash-quote-wall" class="text-gray">Loading</div>
                            </div>
                        </div>

                        </div>
                    </div>
                `;
            },

            renderFeed() {
                return `
                    <div class="fade-in">
                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div>
                                    <h1 class="text-3xl font-bold text-white">Feed</h1>
                                    <p class="text-gray mt-2">New and updated ratings from people you follow.</p>
                                </div>
                            </div>

                            <div class="grid" style="grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: start;">
                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem;">
                                    <div class="flex justify-between items-center" style="gap: 12px; flex-wrap: wrap;">
                                        <div>
                                            <div class="text-white font-bold">Following Activity</div>
                                            <div id="feed-meta" class="text-xs text-gray" style="margin-top: 0.25rem;"></div>
                                        </div>
                                        <div style="display:flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: flex-end;">
                                            <button id="feed-sort-watched" type="button" class="nav-link feed-sort-btn" data-feed-action="set_sort" data-feed-sort-mode="watch_date">Watched</button>
                                            <button id="feed-sort-updated" type="button" class="nav-link feed-sort-btn" data-feed-action="set_sort" data-feed-sort-mode="updated_at">Updated</button>
                                            <button id="feed-refresh" type="button" class="btn btn-outline" data-feed-action="refresh" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Refresh</button>
                                        </div>
                                    </div>

                                    <div id="feed-list" style="margin-top: 0.9rem; display: grid; gap: 12px;"></div>
                                </div>

                                <div class="glass-panel" style="padding: 1rem; border-radius: 1rem;">
                                    <div class="text-white font-bold">Follow People</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.25rem;">Search by username.</div>

                                    <form id="feed-search-form" style="margin-top: 0.85rem;">
                                        <div class="relative">
                                            <input id="feed-search-input" type="text" class="input-field" placeholder="username" autocomplete="off" style="padding-right: 130px;">
                                            <div style="position:absolute; right: 8px; top: 50%; transform: translateY(-50%); display:flex; gap: 8px;">
                                                <button id="feed-search-btn" type="submit" class="btn btn-primary" style="padding: 0.5rem 0.75rem; border-radius: 0.75rem;">Search</button>
                                                <button id="feed-clear-btn" type="button" class="btn btn-outline" style="padding: 0.5rem 0.75rem; border-radius: 0.75rem;">Clear</button>
                                            </div>
                                        </div>
                                    </form>

                                    <div id="feed-search-results" style="margin-top: 0.9rem; display: grid; gap: 10px;"></div>

                                    <div style="height: 1px; background: rgba(255,255,255,0.06); margin: 1rem 0;"></div>

                                    <div class="text-white font-bold">Following</div>
                                    <div id="feed-following" style="margin-top: 0.75rem; display: grid; gap: 10px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderAiPicks() {
                return `
                    <div class="fade-in">
                        <div class="container" style="padding-top: 1.25rem; padding-bottom: 2.6rem; position: relative;">
                            <div class="glass-panel" style="padding: 1.1rem 1.2rem; border-radius: 1.1rem; margin-bottom: 1rem; display:flex; flex-wrap: wrap; gap: 12px; align-items:center; justify-content: space-between;">
                                <div>
                                    <div class="text-xs text-gray" style="letter-spacing: 0.08em; text-transform: uppercase;">AI Picks</div>
                                    <h1 class="text-3xl font-bold text-white" style="margin-top: 0.2rem;">Find your next movie</h1>
                                    <p class="text-gray" style="margin-top: 0.35rem;">Tell us the vibe, then pick a few similar movies or use Filters.</p>
                                </div>
                                <div style="display:flex; gap: 10px; align-items:center;">
                                    <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" onclick="openAiFiltersModal()">Open Filters</button>
                                </div>
                            </div>

                            <div id="ai-inputs-wrap" class="ai-grid-2 ai-grid-single" style="display:grid; grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr); gap: 16px; align-items:start;">
                                <div style="display:flex; flex-direction: column; gap: 12px;">
                                    <div class="ai-card" style="padding: 1rem; border-radius: 1rem;">
                                        <div class="text-white font-bold">Describe what you want</div>
                                        <div id="ai-prompt-panel" class="ai-section" style="margin-top: 0.5rem;">
                                            <div class="text-xs text-gray" style="margin-bottom: 0.35rem;">Example: Lighthearted, characterdriven, post2000, strong performances.</div>
                                            <textarea id="ai-prompt-input" class="textarea-field" rows="6" maxlength="2000" placeholder="Describe the movie you want..."></textarea>
                                            <div id="ai-prompt-remaining" class="text-xs text-gray" style="margin-top: 0.25rem; text-align: right;">2000 characters remaining</div>
                                        </div>
                                    </div>

                                    <div class="ai-card" style="padding: 1rem; border-radius: 1rem;">
                                        <div class="text-white font-bold">Pick similar movies</div>
                                        <div class="text-xs text-gray" style="margin-top: 0.2rem;">Optional, up to 5.</div>
                                        <div style="margin-top: 0.6rem; display:flex; gap: 10px; align-items:flex-start; flex-wrap: wrap;">
                                            <div style="max-width: 340px; position: relative; flex: 1 1 260px;">
                                                <div class="input-group">
                                                    <div class="input-icon">${icons.search}</div>
                                                    <input id="ai-similar-input" type="text" class="input-field glass-input" placeholder="Search for a similar movie" autocomplete="off" style="padding-right: 90px; width: 100%; border-radius: 0.85rem;">
                                                    <div id="ai-similar-results" class="search-dropdown hidden"></div>
                                                </div>
                                                <div style="position:absolute; right: 8px; top: 50%; transform: translateY(-50%); display:flex; gap: 8px;">
                                                    <button id="ai-similar-clear" type="button" class="btn btn-outline" style="padding: 0.35rem 0.55rem; border-radius: 0.7rem;">Clear</button>
                                                </div>
                                            </div>
                                            <div id="ai-similar-selected" style="display:flex; flex-wrap: wrap; gap: 6px; align-content:flex-start; min-height: 28px; flex: 1 1 240px; padding: 0.25rem 0;">
                                            </div>
                                        </div>
                                        <input id="ai-similar-tmdb-id" type="hidden" value="">
                                    </div>

                                    <div class="ai-card" style="padding: 0.9rem 1rem; border-radius: 1rem; display:flex; gap: 10px; flex-wrap: wrap; align-items:center; justify-content: space-between;">
                                        <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                                            <button id="ai-generate-btn" type="button" class="btn btn-primary" style="border-radius: 0.85rem;">Generate Suggestions</button>
                                            <button id="ai-clear-btn" type="button" class="btn btn-outline" style="border-radius: 0.85rem;">Clear</button>
                                        </div>
                                        <label class="text-xs text-gray" style="display:inline-flex; gap: 6px; align-items:center;">
                                            <input id="ai-debug-toggle" type="checkbox" /> Debug
                                        </label>
                                    </div>

                                </div>

                                <div style="display:flex; flex-direction: column; gap: 12px;">
                                    <div class="ai-card" style="padding: 1rem; border-radius: 1rem;">
                                        <div class="text-white font-bold">Refine with Filters</div>
                                        <div class="text-xs text-gray" style="margin-top: 0.35rem; line-height: 1.5;">Filters are required unless you pick at least one similar movie.</div>
                                        <button type="button" class="btn btn-outline" style="border-radius: 0.85rem; margin-top: 0.6rem; width: 100%;" onclick="openAiFiltersModal()">Open Filters</button>
                                    </div>

                                    <div class="ai-card" style="padding: 0.85rem 1rem; border-radius: 1rem; display:flex; align-items:center; justify-content: space-between; gap: 12px;">
                                        <div>
                                            <div class="text-white font-bold" style="font-size: 0.95rem;">Exclude already watched</div>
                                            <div class="text-xs text-gray" style="margin-top: 0.2rem;">Hide movies youve already rated or logged.</div>
                                        </div>
                                        <label style="display:inline-flex; align-items:center; gap: 10px; padding: 0.35rem 0.6rem; border-radius: 0.8rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);">
                                            <input id="ai-filter-exclude-watched" type="checkbox" style="transform: scale(1.2); accent-color: #38bdf8;" />
                                            <span class="text-xs" style="color: #e2e8f0; font-weight: 700; letter-spacing: 0.02em;">Exclude</span>
                                        </label>
                                    </div>

                                    <div class="ai-card" style="padding: 1rem; border-radius: 1rem;">
                                        <div class="text-white font-bold">How it works</div>
                                        <div class="text-xs text-gray" style="margin-top: 0.4rem; line-height: 1.5;">
                                            1) Describe the vibe you want. <br>
                                            2) Add similar movies or use movie detail filters. <br>
                                            3) Generate suggestions and explore.
                                        </div>
                                    </div>

                                    <div class="ai-card" style="padding: 1rem; border-radius: 1rem;">
                                        <div class="text-white font-bold">Tips</div>
                                        <ul class="text-xs text-gray" style="margin-top: 0.4rem; padding-left: 1rem; line-height: 1.5;">
                                            <li>Use mood + era + pacing.</li>
                                            <li>Combine genres for better results.</li>
                                            <li>Add 13 similar movies for accuracy.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div id="ai-loading" class="glass-panel hidden" style="margin-top: 1.25rem; padding: 1rem; border-radius: 1rem;">
                                <div class="text-white font-bold">Loading</div>
                                <div class="text-xs text-gray" style="margin-top: 0.25rem;">Were generating your suggestions.</div>
                                <div class="ai-loading-visual">
                                    <img
                                        id="ai-loading-image"
                                        alt="Loading animation"
                                        loading="lazy"
                                        decoding="async"
                                    />
                                </div>
                            </div>

                            <div id="ai-results-panel" class="glass-panel hidden" style="margin-top: 1.25rem; padding: 1rem; border-radius: 1rem;">
                                <div class="text-white font-bold">Top Suggestions</div>
                                <div class="text-xs text-gray" style="margin-top: 0.25rem;">Results will appear here after generation.</div>
                                <div id="ai-results" class="ai-results" style="margin-top: 0.85rem;">
                                    <div class="text-gray">No results yet.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="ai-filters-overlay" class="auth-overlay" onclick="if(event.target === this) closeAiFiltersModal();">
                        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="ai-filters-title" style="max-width: 560px;">
                            <div class="auth-modal-header">
                                <div class="auth-modal-title" id="ai-filters-title">Filters</div>
                                <button class="auth-modal-close" type="button" onclick="closeAiFiltersModal()">Close</button>
                            </div>
                            <div class="text-xs text-gray" style="margin-top: 0.25rem;">Required unless you pick a similar movie. If you choose filters, fill out all fields.</div>

                            <div class="ai-section" style="margin-top: 0.85rem;">
                                <div>
                                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Minimum TMDb rating (0100)</label>
                                    <div class="ai-slider-row">
                                        <input id="ai-filter-tmdb" type="range" min="0" max="100" step="1" value="0" class="w-full" />
                                        <input id="ai-filter-tmdb-num" type="number" min="0" max="100" step="1" value="0" class="input-field ai-slider-input" />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Release year range</label>
                                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <input id="ai-filter-year-from" type="number" class="input-field" placeholder="From (e.g. 1990)">
                                        <input id="ai-filter-year-to" type="number" class="input-field" placeholder="To (e.g. 2024)">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Genres (include)</label>
                                    <div id="ai-filter-genres-include" class="ai-genre-grid" style="display:flex; flex-wrap: wrap; gap: 8px;">
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Action" aria-pressed="false">Action</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Adventure" aria-pressed="false">Adventure</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Animation" aria-pressed="false">Animation</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Comedy" aria-pressed="false">Comedy</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Crime" aria-pressed="false">Crime</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Documentary" aria-pressed="false">Documentary</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Drama" aria-pressed="false">Drama</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Family" aria-pressed="false">Family</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Fantasy" aria-pressed="false">Fantasy</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="History" aria-pressed="false">History</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Horror" aria-pressed="false">Horror</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Music" aria-pressed="false">Music</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Mystery" aria-pressed="false">Mystery</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Romance" aria-pressed="false">Romance</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Sci-Fi" aria-pressed="false">SciFi</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="TV Movie" aria-pressed="false">TV Movie</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Thriller" aria-pressed="false">Thriller</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="War" aria-pressed="false">War</button>
                                        <button type="button" class="btn btn-outline ai-genre-btn" data-ai-genre-role="include" data-genre="Western" aria-pressed="false">Western</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Watch options (US)</label>
                                    <div style="margin-bottom: 0.4rem;">
                                        <button type="button" class="btn btn-outline" style="border-radius: 0.75rem; padding: 0.35rem 0.7rem;" onclick="selectAllAiProviders()">Select all</button>
                                    </div>
                                    <div id="ai-filter-providers" class="ai-genre-grid" style="display:flex; flex-wrap: wrap; gap: 8px;">
                                        <button type="button" class="btn btn-outline ai-provider-btn" data-ai-provider="Netflix" aria-pressed="false">Netflix</button>
                                        <button type="button" class="btn btn-outline ai-provider-btn" data-ai-provider="Prime Video" aria-pressed="false">Prime Video</button>
                                        <button type="button" class="btn btn-outline ai-provider-btn" data-ai-provider="Hulu" aria-pressed="false">Hulu</button>
                                        <button type="button" class="btn btn-outline ai-provider-btn" data-ai-provider="Disney+" aria-pressed="false">Disney+</button>
                                        <button type="button" class="btn btn-outline ai-provider-btn" data-ai-provider="Max" aria-pressed="false">HBO Max</button>
                                        <button type="button" class="btn btn-outline ai-provider-btn" data-ai-provider="Apple TV+" aria-pressed="false">Apple TV+</button>
                                        <button type="button" class="btn btn-outline ai-provider-btn" data-ai-provider="Paramount+" aria-pressed="false">Paramount+</button>
                                        <button type="button" class="btn btn-outline ai-provider-btn" data-ai-provider="Peacock" aria-pressed="false">Peacock</button>
                                    </div>
                                </div>
                            </div>

                            <div class="auth-modal-actions" style="margin-top: 1rem;">
                                <button type="button" class="btn btn-primary" style="flex:1; border-radius: 0.85rem;" onclick="closeAiFiltersModal()">Save</button>
                                <button type="button" class="btn btn-outline" style="flex:1; border-radius: 0.85rem;" onclick="closeAiFiltersModal()">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderLibrary() {
                return `
                    <div class="fade-in">
                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div>
                                    <h1 class="text-3xl font-bold text-white">My Movies</h1>
                                    <p class="text-gray mt-2">Your most recent watches, with all stored details and ratings.</p>
                                </div>
                                <div style="display:flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: flex-end;">
                                    <div id="library-view-toggle" class="flex" style="gap: 8px; flex-wrap: wrap;">
                                        <button type="button" class="btn dash-pill-btn btn-glass" data-library-action="set_view" data-library-view="list" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">List View</button>
                                        <button type="button" class="btn dash-pill-btn btn-outline" data-library-action="set_view" data-library-view="grid" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Grid View</button>
                                    </div>
                                    <button id="library-open-sortfilter" type="button" class="btn btn-outline" data-library-action="open_sort_filter" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Filters/Sort</button>
                                    <button id="library-refresh" type="button" class="btn btn-outline" data-library-action="refresh" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Refresh</button>
                                </div>
                            </div>

                            <div class="glass-panel" id="theme-creator-search-panel" style="padding: 1rem; border-radius: 1rem;">
                                <div class="flex justify-between items-center" style="gap: 12px; flex-wrap: wrap;">
                                    <div>
                                        <div class="text-white font-bold">Recent Watches</div>
                                        <div id="library-meta" class="text-xs text-gray" style="margin-top: 0.25rem;"></div>
                                    </div>
                                </div>
                                <div id="library-list" style="margin-top: 0.9rem; display: grid; gap: 12px;"></div>

                                <div id="library-load-more-wrap" style="margin-top: 1rem; display:none; justify-content: center;">
                                    <button id="library-load-more" type="button" class="btn btn-glass" data-library-action="load_more" style="padding: 0.75rem 1.25rem; border-radius: 0.95rem;">Load More</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderAccount() {
                return `
                    <div class="fade-in">
                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div>
                                    <h1 class="text-3xl font-bold text-white">Account</h1>
                                    <p class="text-gray mt-2">Update your profile and password.</p>
                                </div>
                                <div style="display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                    <button type="button" class="btn btn-outline" data-account-action="logout" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Log out</button>
                                    <button type="button" class="btn btn-outline" onclick="router.navigate('home')" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Back</button>
                                </div>
                            </div>

                            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; align-items: stretch;">
                                <button type="button" class="glass-panel" data-account-action="open_profile" style="padding: 1rem; border-radius: 1rem; text-align: left;">
                                    <div class="text-white font-bold">Profile</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.35rem;">Username, display name, and icon.</div>
                                </button>
                                <button type="button" class="glass-panel hidden" id="theme-creator-card" data-account-action="theme_creator" style="padding: 1rem; border-radius: 1rem; text-align: left;">
                                    <div class="text-white font-bold">Theme Creator</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.35rem;">Build themed backdrops from TMDb.</div>
                                </button>
                                <button type="button" class="glass-panel" data-account-action="open_security" style="padding: 1rem; border-radius: 1rem; text-align: left;">
                                    <div class="text-white font-bold">Security</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.35rem;">Update your password and view email.</div>
                                </button>
                                <button type="button" class="glass-panel" data-account-action="open_feature" style="padding: 1rem; border-radius: 1rem; text-align: left;">
                                    <div class="text-white font-bold">Feature Requests</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.35rem;">Send ideas and suggestions.</div>
                                </button>
                                <button type="button" class="glass-panel" data-account-action="logout" style="padding: 1rem; border-radius: 1rem; text-align: left;">
                                    <div class="text-white font-bold">Log out</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.35rem;">Sign out of your account.</div>
                                </button>
                                <div class="glass-panel" id="account-theme-panel" style="padding: 1rem; border-radius: 1rem; display:flex; align-items:center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                                    <div>
                                        <div class="text-white font-bold">Theme</div>
                                        <div class="text-xs text-gray" style="margin-top: 0.35rem;">Choose a visual style.</div>
                                    </div>
                                    <select id="account-theme-select" class="input-field" style="min-width: 120px; width: 150px;">
                                        ${buildThemeCreatorOptions(themeOptions, getStoredTheme())}
                                    </select>
                                </div>
                            </div>
                            <div class="glass-panel" id="account-achievements-panel" style="margin-top: 1rem; padding: 1rem; border-radius: 1rem;">
                                <div style="display:flex; align-items:center; justify-content: space-between; gap: 0.6rem; flex-wrap: wrap;">
                                    <div class="text-white font-bold">Achievements</div>
                                    <div style="display:flex; gap: 0.4rem; align-items:center; flex-wrap: wrap;">
                                        <div class="achievement-filter-wrap">
                                            <button id="account-achievement-filters-btn" type="button" class="btn btn-outline" style="padding: 0.35rem 0.6rem; border-radius: 0.75rem;">Sort/Filter</button>
                                            <div id="account-achievement-filters-pop" class="achievement-filters-pop" aria-hidden="true">
                                                <div class="achievement-filters-row">
                                                    <div class="achievement-filters-label">Sort</div>
                                                    <select id="account-achievement-sort" class="input-field">
                                                        <option value="points_asc" selected>Points: Low to High</option>
                                                        <option value="points_desc">Points: High to Low</option>
                                                    </select>
                                                </div>
                                                <div class="achievement-filters-row">
                                                    <div class="achievement-filters-label">Type</div>
                                                    <select id="account-achievement-filter" class="input-field">
                                                        <option value="all">All types</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="account-achievements-layout">
                                    <div id="account-tier-summary" class="tier-summary-card" aria-live="polite" data-tier="Extra">
                                        <div class="tier-summary-header">
                                            <div class="tier-summary-title">Current Tier</div>
                                            <div class="tier-summary-name" id="account-tier-name"></div>
                                        </div>
                                        <div class="tier-summary-body">
                                            <div class="tier-summary-icon" id="account-tier-icon">?</div>
                                            <div class="tier-summary-stats">
                                                <div class="tier-summary-points" id="account-tier-points">0 pts</div>
                                                <div class="tier-summary-next" id="account-tier-next">Earn more points to level up.</div>
                                            </div>
                                        </div>
                                        <div class="tier-summary-bar">
                                            <div class="tier-summary-progress" id="account-tier-progress"></div>
                                        </div>
                                    </div>
                                    <div id="account-achievements-list" class="achievement-grid">
                                        <div class="text-xs text-gray">Loading achievements</div>
                                    </div>
                                </div>
                            </div>
                            <div class="glass-panel" id="account-achievement-test-panel" style="margin-top: 1rem; padding: 1rem; border-radius: 1rem; display:none;">
                                <div style="display:flex; align-items:center; justify-content: space-between; gap: 0.6rem; flex-wrap: wrap;">
                                    <div>
                                        <div class="text-white font-bold">Achievement Testing</div>
                                        <div class="text-xs text-gray" style="margin-top: 0.35rem;">Trigger a test popup on demand.</div>
                                    </div>
                                    <div style="display:flex; gap: 0.4rem; align-items:center; flex-wrap: wrap;">
                                        <select id="account-test-achievement-select" class="input-field" style="min-width: 180px;"></select>
                                        <button id="account-test-achievement-btn" type="button" class="btn btn-outline" style="padding: 0.35rem 0.6rem; border-radius: 0.75rem;" onclick="triggerTestAchievementPopup()">Test Achievement</button>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>

                    <div id="account-profile-overlay" class="auth-overlay" onclick="if(event.target === this) closeAccountSectionModal('profile');">
                        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="account-profile-title" style="max-width: 640px;">
                            <div class="auth-modal-header">
                                <div class="auth-modal-title" id="account-profile-title">Profile</div>
                                <button class="auth-modal-close" type="button" data-account-action="close_modal" data-modal="profile">Close</button>
                            </div>
                            <div class="text-xs text-gray" style="margin-top: 0.25rem;">Your username is used for search + following.</div>

                            <div id="account-profile-status" class="text-xs" style="margin-top: 0.6rem; color: rgba(255,255,255,0.60);"></div>

                            <form id="account-profile-form" style="margin-top: 0.85rem; display:grid; gap: 0.75rem;">
                                <div>
                                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Username</label>
                                    <input id="account-username" type="text" class="input-field" placeholder="e.g. landon" autocomplete="username" spellcheck="false">
                                    <div class="text-xs text-gray" style="margin-top: 0.35rem;">320 chars  letters/numbers/underscore  stored without @.</div>
                                </div>
                                <div>
                                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Display name</label>
                                    <input id="account-display-name" type="text" class="input-field" placeholder="e.g. Landon James" autocomplete="name">
                                </div>
                                <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                    <button id="account-save-profile" type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Save profile</button>
                                    <button type="button" class="btn btn-outline" style="border-radius: 0.85rem;" data-account-action="reload">Reload</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="account-security-overlay" class="auth-overlay" onclick="if(event.target === this) closeAccountSectionModal('security');">
                        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="account-security-title" style="max-width: 560px;">
                            <div class="auth-modal-header">
                                <div class="auth-modal-title" id="account-security-title">Security</div>
                                <button class="auth-modal-close" type="button" data-account-action="close_modal" data-modal="security">Close</button>
                            </div>
                            <div class="text-xs text-gray" style="margin-top: 0.25rem;">Password changes update Supabase Auth (not your Users table).</div>

                            <div style="margin-top: 0.85rem; display:grid; gap: 0.75rem;">
                                <div>
                                    <div class="text-sm text-white font-bold">Email</div>
                                    <div id="account-email" class="text-xs" style="margin-top: 0.25rem; color: rgba(255,255,255,0.70);"></div>
                                </div>

                                <form id="account-password-form" style="display:grid; gap: 0.75rem;">
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">New password</label>
                                        <input id="account-new-password" type="password" class="input-field" placeholder="" autocomplete="new-password">
                                    </div>
                                    <div>
                                        <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Confirm new password</label>
                                        <input id="account-confirm-password" type="password" class="input-field" placeholder="" autocomplete="new-password">
                                    </div>
                                    <div id="account-password-status" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
                                    <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                        <button id="account-change-password" type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Change password</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div id="account-feature-overlay" class="auth-overlay" onclick="if(event.target === this) closeAccountSectionModal('feature');">
                        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="account-feature-title" style="max-width: 640px;">
                            <div class="auth-modal-header">
                                <div class="auth-modal-title" id="account-feature-title">Feature Requests</div>
                                <button class="auth-modal-close" type="button" data-account-action="close_modal" data-modal="feature">Close</button>
                            </div>
                            <div class="text-xs text-gray" style="margin-top: 0.25rem;">Have an idea? Send it here.</div>

                            <form id="feature-request-form" style="margin-top: 0.85rem; display:grid; gap: 0.75rem;">
                                <div>
                                    <label class="text-sm text-white font-bold mb-2 label-gap submit-label block">Request</label>
                                    <textarea id="feature-request-text" class="textarea-field" rows="4" maxlength="2000" placeholder="Describe your feature idea"></textarea>
                                    <div class="text-xs text-gray" style="margin-top: 0.35rem;">
                                        <span id="feature-request-remaining">2000 characters remaining</span>
                                    </div>
                                </div>
                                <div id="feature-request-status" class="text-xs" style="color: rgba(255,255,255,0.60);"></div>
                                <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                    <button id="feature-request-submit" type="submit" class="btn btn-primary" style="border-radius: 0.85rem;">Send request</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    </div>
                `;
            },

            renderThemeCreator() {
                return `
                    <div class="fade-in">
                        <div class="container" style="padding-top: 2rem; padding-bottom: 3rem; position: relative;">
                            <div class="flex justify-between items-center mb-6" style="gap: 14px; flex-wrap: wrap;">
                                <div>
                                    <h1 class="text-3xl font-bold text-white">Theme Creator</h1>
                                    <p class="text-gray mt-2">Build a theme step by step: pick mode, name it, choose backdrops, pick the AI movie, then save.</p>
                                </div>
                                <div style="display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                    <button type="button" class="btn btn-outline" onclick="router.navigate('account')" style="padding: 0.55rem 0.8rem; border-radius: 0.85rem;">Back</button>
                                </div>
                            </div>

                            <div class="glass-panel" id="theme-creator-step-mode" style="padding: 1rem; border-radius: 1rem;">
                                <div class="text-white font-bold">Step 1  Mode</div>
                                <div class="text-xs text-gray" style="margin-top: 0.25rem;">Choose whether you are creating a new theme or editing an existing one.</div>
                                <div style="margin-top: 0.75rem; display:flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                    <button type="button" class="btn btn-primary" id="theme-creator-mode-create" style="padding: 0.55rem 0.9rem; border-radius: 0.85rem;">Create New</button>
                                    <button type="button" class="btn btn-outline" id="theme-creator-mode-edit" style="padding: 0.55rem 0.9rem; border-radius: 0.85rem;">Edit Existing</button>
                                    <button type="button" class="btn btn-outline" id="theme-creator-mode-continue" style="padding: 0.55rem 0.9rem; border-radius: 0.85rem;">Continue</button>
                                </div>
                            </div>

                            <div class="glass-panel hidden" id="theme-creator-step-name" style="margin-top: 1rem; padding: 1rem; border-radius: 1rem;">
                                <div class="text-white font-bold">Step 2  Name</div>
                                <div class="text-xs text-gray" style="margin-top: 0.25rem;">Set or select your theme name before adding assets.</div>

                                <div id="theme-creator-create-panel" style="margin-top: 0.75rem; display:grid; gap: 8px;">
                                    <label class="text-xs text-gray">New theme name</label>
                                    <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                        <input id="theme-creator-new-name" type="text" class="input-field" placeholder="e.g. Neon Noir" style="min-width: 220px;">
                                        <button type="button" class="btn btn-outline" id="theme-creator-create-btn" style="padding: 0.55rem 0.9rem; border-radius: 0.85rem;">Create Theme & Continue</button>
                                    </div>
                                </div>

                                <div id="theme-creator-edit-panel" class="hidden" style="margin-top: 0.75rem; display:grid; gap: 8px;">
                                    <label class="text-xs text-gray">Select theme</label>
                                    <select id="theme-creator-edit-select" class="input-field" style="min-width: 220px;">
                                        ${buildThemeCreatorOptions(getThemeCreatorThemeOptions(), '')}
                                    </select>
                                    <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                        <button type="button" class="btn btn-outline" id="theme-creator-edit-continue" style="padding: 0.55rem 0.9rem; border-radius: 0.85rem;">Continue to Backdrops</button>
                                    </div>
                                    <label class="text-xs text-gray">Rename theme</label>
                                    <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                        <input id="theme-creator-edit-name" type="text" class="input-field" placeholder="New theme name" style="min-width: 220px;">
                                        <button type="button" class="btn btn-outline" id="theme-creator-update-btn" style="padding: 0.55rem 0.9rem; border-radius: 0.85rem;">Update Name</button>
                                    </div>
                                    <div style="margin-top: 0.5rem; display:flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                        <button type="button" class="btn btn-outline" id="theme-creator-delete-theme" style="padding: 0.55rem 0.9rem; border-radius: 0.85rem;">Delete Theme</button>
                                    </div>
                                </div>

                                <div id="theme-creator-theme-status" class="text-xs" style="margin-top: 0.6rem; color: rgba(255,255,255,0.60);"></div>
                            </div>

                            <div class="glass-panel hidden" id="theme-creator-step-backdrops" style="margin-top: 1rem; padding: 1rem; border-radius: 1rem;">
                                <div class="text-white font-bold">Step 3  Backdrops</div>
                                <div class="text-xs text-gray" style="margin-top: 0.25rem;">Search multiple movies and pick up to 6 backdrops total.</div>
                                <div style="margin-top: 0.75rem; position: relative;">
                                    <div class="input-group">
                                        <div class="input-icon">${icons.search}</div>
                                        <input
                                            type="text"
                                            id="theme-creator-search-input"
                                            autocomplete="off"
                                            placeholder="Search a movie for backdrops..."
                                            class="input-field glass-input"
                                            style="border-radius: 0.85rem;"
                                        >
                                        <div id="theme-creator-search-results" class="search-dropdown hidden"></div>
                                    </div>
                                </div>

                                <div class="glass-panel" id="theme-creator-selected-panel" style="margin-top: 1rem; padding: 1rem; border-radius: 1rem;">
                                    <div class="flex" style="justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
                                        <div>
                                            <div class="text-white font-bold">Backdrops</div>
                                            <div id="theme-creator-selected-movie" class="text-xs text-gray" style="margin-top: 0.25rem;">No backdrop movie selected yet.</div>
                                        </div>
                                        <div class="text-xs text-gray">Click up to 6 images.</div>
                                    </div>
                                    <div id="theme-creator-backdrops" style="margin-top: 0.9rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;"></div>
                                </div>

                                <div class="glass-panel" style="margin-top: 1rem; padding: 1rem; border-radius: 1rem;">
                                    <div class="flex" style="justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
                                        <div>
                                            <div class="text-white font-bold">Selected Images</div>
                                            <div class="text-xs text-gray" style="margin-top: 0.25rem;">Assign a page for each selection.</div>
                                            <div class="text-xs text-gray" style="margin-top: 0.25rem;">Active theme: <span id="theme-creator-active-name">None</span></div>
                                        </div>
                                        <div class="text-xs text-gray" id="theme-creator-count">0 / 6 selected</div>
                                    </div>

                                    <div id="theme-creator-selected" style="margin-top: 0.9rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;"></div>

                                    <div style="margin-top: 1rem; display:flex; gap: 10px; flex-wrap: wrap;">
                                        <button type="button" class="btn btn-outline" id="theme-creator-clear" style="border-radius: 0.85rem;">Clear Selection</button>
                                        <button type="button" class="btn btn-outline" id="theme-creator-backdrops-continue" style="border-radius: 0.85rem;">Continue to AI Movie</button>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-panel hidden" id="theme-creator-step-ai" style="margin-top: 1rem; padding: 1rem; border-radius: 1rem;">
                                <div class="text-white font-bold">Step 4  AI Movie</div>
                                <div class="text-xs text-gray" style="margin-top: 0.25rem;">Pick the single movie that will drive the AI color palette.</div>
                                <div style="margin-top: 0.75rem; position: relative;">
                                    <div class="input-group">
                                        <div class="input-icon">${icons.search}</div>
                                        <input
                                            type="text"
                                            id="theme-creator-ai-search-input"
                                            autocomplete="off"
                                            placeholder="Search the AI palette movie..."
                                            class="input-field glass-input"
                                            style="border-radius: 0.85rem;"
                                        >
                                        <div id="theme-creator-ai-search-results" class="search-dropdown hidden"></div>
                                    </div>
                                </div>
                                <div id="theme-creator-ai-selected-movie" class="text-xs text-gray" style="margin-top: 0.6rem;">No AI movie selected yet.</div>
                                <div style="margin-top: 1rem; display:flex; gap: 10px; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-outline" id="theme-creator-ai-continue" style="border-radius: 0.85rem;">Continue to Prompt</button>
                                </div>
                            </div>

                            <div class="glass-panel hidden" id="theme-creator-step-prompt" style="margin-top: 1rem; padding: 1rem; border-radius: 1rem;">
                                <div class="text-white font-bold">Step 5  Style Prompt & Save</div>
                                <div class="text-xs text-gray" style="margin-top: 0.25rem;">Add any extra color direction, then save to trigger uploads + AI.</div>
                                <label class="text-xs text-gray" style="margin-top: 0.75rem;">Color style prompt (optional)</label>
                                <textarea id="theme-creator-style-prompt" class="input-field textarea-field" rows="3" placeholder="e.g. Moody noir with teal highlights, warm skin tones, subtle gold accents."></textarea>
                                <div class="text-xs text-gray" style="margin-top: 0.4rem;">This helps the AI pick cohesive colors for the new theme.</div>
                                <div style="margin-top: 1rem; display:flex; gap: 10px; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-primary" id="theme-creator-save" style="border-radius: 0.85rem;">Save Theme Assets + Colors</button>
                                    <button type="button" class="btn btn-outline" id="theme-creator-regenerate" style="border-radius: 0.85rem;">Re-generate Colors</button>
                                </div>
                                <div id="theme-creator-status" class="text-xs" style="margin-top: 0.6rem; color: rgba(255,255,255,0.60);"></div>
                            </div>
                        </div>
                    </div>
                `;
            },

        };

        let homeSearchDebounceTimer = null;
        let homeSearchAbortController = null;
        let homeSearchItems = [];

        let homeTrendingItems = [];
        let homeTrendingAbortController = null;

        async function callSwiftApiPublic(body, { signal } = {}) {
            const url = `${SUPABASE_URL}/functions/v1/swift-api`;

            // If the user is logged in, include Authorization. If not, allow a public call.
            let authHeader = null;
            try {
                const { data } = await supabaseClient?.auth?.getSession?.();
                const token = data?.session?.access_token || null;
                if (token) authHeader = `Bearer ${token}`;
            } catch (_) {}

            const headers = {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
            };
            if (authHeader) headers['Authorization'] = authHeader;

            const res = await fetch(url, {
                method: 'POST',
                headers,
                body: JSON.stringify(body || {}),
                signal,
            });

            const text = await res.text();
            let data = null;
            try {
                data = text ? JSON.parse(text) : null;
            } catch (_) {
                data = text;
            }

            if (!res.ok) {
                const serverMsg =
                    data && typeof data === 'object'
                        ? (data.message || data.error || JSON.stringify(data))
                        : String(data || '');
                throw new Error(`${serverMsg || 'Request failed'}`);
            }

            return data;
        }

        async function loadDashboard() {
            // Called on router.navigate('dashboard') after the DOM is rendered.
            const elUnique = document.getElementById('dash-unique-movies-year');
            const elHours = document.getElementById('dash-total-hours');
            const elAvg = document.getElementById('dash-avg-rating');
            const elGenre = document.getElementById('dash-top-genre');
            const elGenreCount = document.getElementById('dash-top-genre-count');
            const elGenreAvg = document.getElementById('dash-top-genre-avg');

            const elTopMovieTitle = document.getElementById('dash-top-movie-title');
            const elTopMovieRating = document.getElementById('dash-top-movie-rating');
            const elWatchEventsYear = document.getElementById('dash-watch-events-year');
            const elWatchEventsAll = document.getElementById('dash-watch-events-all');

            const elDecade = document.getElementById('dash-most-watched-decade');
            const elDecadeCount = document.getElementById('dash-most-watched-decade-count');
            const elActor = document.getElementById('dash-most-watched-actor');
            const elActorCount = document.getElementById('dash-most-watched-actor-count');
            const elDirector = document.getElementById('dash-most-watched-director');
            const elDirectorCount = document.getElementById('dash-most-watched-director-count');

            const elHighDirector = document.getElementById('dash-highest-rated-director');
            const elHighDirectorAvg = document.getElementById('dash-highest-rated-director-avg');
            const elHighDirectorN = document.getElementById('dash-highest-rated-director-n');

            const elAtHome = document.getElementById('dash-at-home');
            const elInTheater = document.getElementById('dash-in-theater');

            const elTierBars = document.getElementById('dash-tier-bars');

            const required = [
                elUnique, elHours, elAvg, elGenre, elGenreCount, elGenreAvg,
                elTopMovieTitle, elTopMovieRating,
                elWatchEventsYear, elWatchEventsAll,
                elDecade, elDecadeCount,
                elActor, elActorCount,
                elDirector, elDirectorCount,
                elHighDirector, elHighDirectorAvg, elHighDirectorN,
                elAtHome, elInTheater,
                elTierBars,
            ];
            if (required.some(x => !x)) return;

            if (!supabaseClient) {
                elUnique.textContent = '';
                elHours.textContent = '';
                elAvg.textContent = '';
                elGenre.textContent = '';
                elGenreCount.textContent = '';
                elGenreAvg.textContent = '';

                elTopMovieTitle.textContent = '';
                elTopMovieRating.textContent = '';
                elWatchEventsYear.textContent = '';
                elWatchEventsAll.textContent = '';

                elDecade.textContent = '';
                elDecadeCount.textContent = '';
                elActor.textContent = '';
                elActorCount.textContent = '';
                elDirector.textContent = '';
                elDirectorCount.textContent = '';

                elHighDirector.textContent = '';
                elHighDirectorAvg.textContent = '';
                elHighDirectorN.textContent = '';

                elAtHome.textContent = '';
                elInTheater.textContent = '';

                elTierBars.innerHTML = '';
                return;
            }

            // Require auth for dashboard metrics.
            let authedUser = null;
            try {
                const { data } = await supabaseClient.auth.getUser();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!authedUser?.id) {
                elUnique.textContent = '';
                elHours.textContent = '';
                elAvg.textContent = '';
                elGenre.textContent = '';
                elGenreCount.textContent = '';
                elGenreAvg.textContent = '';

                elTopMovieTitle.textContent = '';
                elTopMovieRating.textContent = '';
                elWatchEventsYear.textContent = '';
                elWatchEventsAll.textContent = '';

                elDecade.textContent = '';
                elDecadeCount.textContent = '';
                elActor.textContent = '';
                elActorCount.textContent = '';
                elDirector.textContent = '';
                elDirectorCount.textContent = '';

                elHighDirector.textContent = '';
                elHighDirectorAvg.textContent = '';
                elHighDirectorN.textContent = '';

                elAtHome.textContent = '';
                elInTheater.textContent = '';

                elTierBars.innerHTML = '';
                return;
            }

            // Loading state.
            elUnique.textContent = '';
            elHours.textContent = '';
            elAvg.textContent = '';
            elGenre.textContent = '';
            elGenreCount.textContent = '';
            elGenreAvg.textContent = '';

            elTopMovieTitle.textContent = '';
            elTopMovieRating.textContent = '';
            elWatchEventsYear.textContent = '';
            elWatchEventsAll.textContent = '';

            elDecade.textContent = '';
            elDecadeCount.textContent = '';
            elActor.textContent = '';
            elActorCount.textContent = '';
            elDirector.textContent = '';
            elDirectorCount.textContent = '';

            elHighDirector.textContent = '';
            elHighDirectorAvg.textContent = '';
            elHighDirectorN.textContent = '';

            elAtHome.textContent = '';
            elInTheater.textContent = '';

            elTierBars.innerHTML = '';

            try {
                const { data, error } = await supabaseClient.rpc('get_dashboard_summary');
                if (error) throw error;

                const uniqueMovies = Number(data?.unique_movies_this_year ?? 0);
                const totalHours = Number(data?.total_watch_hours_all_time ?? 0);
                const avgRating = Number(data?.avg_overall_rating ?? 0);
                const topGenre = String(data?.top_genre ?? '').trim();
                const topGenreCount = Number(data?.top_genre_count ?? 0);
                const topGenreAvg = Number(data?.top_genre_avg_overall ?? 0);

                const topMovieTitle = String(data?.highest_rated_movie?.title ?? '').trim();
                const topMovieRating = Number(data?.highest_rated_movie?.overall_rating ?? 0);

                const watchEventsYear = Number(data?.total_watch_events_this_year ?? 0);
                const watchEventsAll = Number(data?.total_watch_events_all_time ?? 0);

                const decade = data?.most_watched_decade?.decade;
                const decadeWatches = Number(data?.most_watched_decade?.watches ?? 0);

                const actorName = String(data?.most_watched_actor?.name ?? '').trim();
                const actorWatches = Number(data?.most_watched_actor?.watches ?? 0);

                const directorName = String(data?.most_watched_director?.name ?? '').trim();
                const directorWatches = Number(data?.most_watched_director?.watches ?? 0);

                const highDirectorName = String(data?.highest_rated_director?.name ?? '').trim();
                const highDirectorAvg = Number(data?.highest_rated_director?.avg_overall ?? 0);
                const highDirectorN = Number(data?.highest_rated_director?.n ?? 0);

                const atHome = Number(data?.watch_method_breakdown?.at_home ?? 0);
                const inTheater = Number(data?.watch_method_breakdown?.in_theater ?? 0);

                const tierDist = Array.isArray(data?.tier_distribution) ? data.tier_distribution : [];

                elUnique.textContent = Number.isFinite(uniqueMovies) ? String(uniqueMovies) : '0';
                elHours.textContent = Number.isFinite(totalHours) ? String(totalHours) : '0';
                elAvg.textContent = Number.isFinite(avgRating) ? String(avgRating) : '0';
                elGenre.textContent = topGenre || '';
                elGenreCount.textContent = Number.isFinite(topGenreCount) ? String(topGenreCount) : '0';
                elGenreAvg.textContent = Number.isFinite(topGenreAvg) ? String(topGenreAvg) : '0';

                elTopMovieTitle.textContent = topMovieTitle || '';
                elTopMovieRating.textContent = Number.isFinite(topMovieRating) ? String(topMovieRating) : '0';

                elWatchEventsYear.textContent = Number.isFinite(watchEventsYear) ? String(watchEventsYear) : '0';
                elWatchEventsAll.textContent = Number.isFinite(watchEventsAll) ? String(watchEventsAll) : '0';

                elDecade.textContent = (decade === null || decade === undefined) ? '' : `${String(decade)}s`;
                elDecadeCount.textContent = Number.isFinite(decadeWatches) ? String(decadeWatches) : '0';

                elActor.textContent = actorName || '';
                elActorCount.textContent = Number.isFinite(actorWatches) ? String(actorWatches) : '0';

                elDirector.textContent = directorName || '';
                elDirectorCount.textContent = Number.isFinite(directorWatches) ? String(directorWatches) : '0';

                elHighDirector.textContent = highDirectorName || '';
                elHighDirectorAvg.textContent = Number.isFinite(highDirectorAvg) ? String(highDirectorAvg) : '0';
                elHighDirectorN.textContent = Number.isFinite(highDirectorN) ? String(highDirectorN) : '0';

                elAtHome.textContent = Number.isFinite(atHome) ? String(atHome) : '0';
                elInTheater.textContent = Number.isFinite(inTheater) ? String(inTheater) : '0';

                const tierColors = {
                    'S': 'rgba(var(--tier-s-rgb), 0.35)',
                    'A': 'rgba(var(--tier-a-rgb), 0.35)',
                    'B': 'rgba(var(--tier-b-rgb), 0.35)',
                    'C': 'rgba(var(--tier-c-rgb), 0.35)',
                    'D': 'rgba(var(--tier-d-rgb), 0.35)',
                    'F': 'rgba(var(--tier-f-rgb), 0.35)',
                };

                elTierBars.innerHTML = tierDist.map((t) => {
                    const tier = String(t?.tier ?? '').trim() || '';
                    const pct = Number(t?.pct ?? 0);
                    const count = Number(t?.count ?? 0);
                    const width = Number.isFinite(pct) ? Math.max(0, Math.min(100, pct)) : 0;
                    const bg = tierColors[tier.toUpperCase()] || 'rgba(255,255,255,0.10)';
                    const tierLetter = String(tier || '').trim().toUpperCase();
                    const tierText = /^[SABCDF]$/.test(tierLetter)
                        ? `Tier <span class=\"dash-help-tier\" data-tier-letter=\"${escapeHtml(tierLetter)}\">${escapeHtml(tierLetter)}</span>`
                        : `Tier ${escapeHtml(tier)}`;
                    return `
                        <div style="min-width: 140px; flex: 1;">
                            <div class="flex justify-between" style="margin-bottom: 6px;">
                                <span class="text-xs text-gray">${tierText}</span>
                                <span class="text-xs text-gray">${Number.isFinite(pct) ? pct.toFixed(1) : '0.0'}% (${Number.isFinite(count) ? count : 0})</span>
                            </div>
                            <div style="height: 10px; background: rgba(255,255,255,0.06); border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06);">
                                <div style="height: 100%; width: ${width}%; background: ${bg};"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                // Quiet failure; keep placeholders.
                elUnique.textContent = '';
                elHours.textContent = '';
                elAvg.textContent = '';
                elGenre.textContent = '';
                elGenreCount.textContent = '';
                elGenreAvg.textContent = '';

                elTopMovieTitle.textContent = '';
                elTopMovieRating.textContent = '';
                elWatchEventsYear.textContent = '';
                elWatchEventsAll.textContent = '';

                elDecade.textContent = '';
                elDecadeCount.textContent = '';
                elActor.textContent = '';
                elActorCount.textContent = '';
                elDirector.textContent = '';
                elDirectorCount.textContent = '';

                elHighDirector.textContent = '';
                elHighDirectorAvg.textContent = '';
                elHighDirectorN.textContent = '';

                elAtHome.textContent = '';
                elInTheater.textContent = '';

                elTierBars.innerHTML = '';
            }
        }

        function initDashboardTabs() {
            const wrap = document.getElementById('dash-tab-general')?.parentElement;
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-tab]') : null;
                const tab = btn?.dataset?.tab;
                if (!tab) return;
                setDashboardTab(tab);
            });
        }

        let dashboardTimeframe = 'all_time';
        let dashboardActiveTab = 'general';
        let dashboardAuthWarned = false;
        let dashboardFavoritesMetric = 'overall';
        let dashboardFavoritesLimit = 5;
        let dashboardChartsTab = 'heatmap';
        let dashboardChartsLastData = null;
        let dashboardChartsActivityMax = null;
        let dashboardHeatmapPair = 'genre_decade';
        let dashboardRatingsChartTab = 'genre';
        let dashboardRatingsChartsLastData = null;
        let dashboardRatingsShowAllGenres = false;
        let dashboardGeneralPieMode = 'mpa';
        let dashboardGeneralPieData = null;
        let dashboardGeneralMode = 'total';

        let dashboardGeneralLastData = null;
        let dashboardRatingsLastData = null;

        const dashPosterCacheByTmdbId = new Map();
        const dashRatingCacheByMovieId = new Map();
        const dashPersonAvatarCache = new Map();

        function dashNormalizePosterPath(p) {
            const raw = String(p ?? '').trim();
            if (!raw) return '';
            // Allow full URLs (future-proof).
            if (raw.startsWith('http://') || raw.startsWith('https://')) return raw;
            // TMDb poster_path should be "/abc.jpg" but some sources may provide "abc.jpg".
            return raw.startsWith('/') ? raw : `/${raw}`;
        }

        function dashBuildPosterUrl(posterPath, size = 'w342') {
            const normalized = dashNormalizePosterPath(posterPath);
            if (!normalized) return '';
            if (normalized.startsWith('http://') || normalized.startsWith('https://')) return normalized;
            return `https://image.tmdb.org/t/p/${String(size || 'w342')}${normalized}`;
        }

        function dashBuildPersonUrl(profilePath, size = 'w185') {
            const raw = String(profilePath ?? '').trim();
            if (!raw) return '';
            if (raw.startsWith('http://') || raw.startsWith('https://')) return raw;
            const normalized = raw.startsWith('/') ? raw : `/${raw}`;
            return `https://image.tmdb.org/t/p/${String(size || 'w185')}${normalized}`;
        }

        async function dashFetchPersonProfile({ name, department }) {
            const key = `${String(name || '').trim().toLowerCase()}|${String(department || '').trim().toLowerCase()}`;
            if (!key || key === '|') return null;
            if (dashPersonAvatarCache.has(key)) return dashPersonAvatarCache.get(key);

            let profilePath = null;
            try {
                const data = await callSwiftApiPublic({ action: 'person', query: name, department });
                const results = Array.isArray(data?.results) ? data.results : [];
                const pick = results.find((r) => String(r?.profile_path || '').trim()) || results[0] || null;
                profilePath = pick?.profile_path ? String(pick.profile_path).trim() : null;
            } catch (_) {
                profilePath = null;
            }

            dashPersonAvatarCache.set(key, profilePath);
            return profilePath;
        }

        async function dashEnsurePosterPath(item) {
            // 1) If the item already has a poster path, use it (no DB needed).
            const direct = dashNormalizePosterPath(item?.poster_path ?? item?.posterPath ?? item?.poster_url ?? item?.posterUrl ?? '');
            if (direct) return direct;

            const tmdb_id = Number(item?.tmdb_id);
            if (Number.isFinite(tmdb_id) && tmdb_id > 0) {
                if (dashPosterCacheByTmdbId.has(tmdb_id)) return dashPosterCacheByTmdbId.get(tmdb_id);
            }

            // Prefer DB if the movie exists there; never call TMDb here.
            if (!supabaseClient) {
                if (Number.isFinite(tmdb_id) && tmdb_id > 0) dashPosterCacheByTmdbId.set(tmdb_id, null);
                return null;
            }

            const movie_id = String(item?.movie_id ?? item?.movieId ?? item?.id ?? '').trim();

            // 2) DB lookup by movie_id (most reliable in this app)
            if (isUuidLike(movie_id)) {
                try {
                    const { data, error } = await supabaseClient
                        .from('Movies')
                        .select('tmdb_id, poster_path')
                        .eq('id', movie_id)
                        .maybeSingle();
                    if (error) throw error;

                    const pRaw = String(data?.poster_path || '').trim();
                    const p = pRaw ? (dashNormalizePosterPath(pRaw) || null) : null;
                    const tmdbFromDb = Number(data?.tmdb_id);
                    if (Number.isFinite(tmdbFromDb) && tmdbFromDb > 0) dashPosterCacheByTmdbId.set(tmdbFromDb, p);
                    if (Number.isFinite(tmdb_id) && tmdb_id > 0) dashPosterCacheByTmdbId.set(tmdb_id, p);
                    return p;
                } catch (_) {
                    if (Number.isFinite(tmdb_id) && tmdb_id > 0) dashPosterCacheByTmdbId.set(tmdb_id, null);
                    return null;
                }
            }

            // 3) DB lookup by tmdb_id fallback
            if (!Number.isFinite(tmdb_id) || tmdb_id <= 0) return null;
            try {
                const { data, error } = await supabaseClient
                    .from('Movies')
                    .select('poster_path')
                    .eq('tmdb_id', tmdb_id)
                    .maybeSingle();
                if (error) throw error;
                const pRaw = String(data?.poster_path || '').trim();
                const p = pRaw ? (dashNormalizePosterPath(pRaw) || null) : null;
                dashPosterCacheByTmdbId.set(tmdb_id, p);
                return p;
            } catch (_) {
                dashPosterCacheByTmdbId.set(tmdb_id, null);
                return null;
            }
        }

        function dashFormatScore(n) {
            const num = Number(n);
            if (!Number.isFinite(num)) return '';
            const rounded = Math.round(num * 10) / 10;
            return `${rounded.toFixed(1)}%`;
        }

        function dashFormatScoreWhole(n) {
            const num = Number(n);
            if (!Number.isFinite(num)) return '';
            return `${Math.round(num)}%`;
        }

        function dashNormalizeTierLabel(tierRaw) {
            const t = String(tierRaw ?? '').trim();
            if (!t) return '';
            const u = t.toUpperCase();
            if (u === 'UNRANKED') return 'Unranked';
            if (/^[SABCDF]$/i.test(t)) return `${u}-Tier`;
            if (/^[SABCDF]\s*-?\s*TIER$/i.test(t)) return `${u[0]}-Tier`;
            return t;
        }

        function dashTierLetterFromLabel(label) {
            const raw = String(label ?? '').trim();
            if (!raw) return '';
            const upper = raw.toUpperCase();
            if (upper === 'UNRANKED') return '';
            const m = upper.match(/^([SABCDF])/);
            return m ? m[1] : '';
        }

        function dashRenderHelpScore(scoreText) {
            const s = String(scoreText ?? '').trim();
            if (!s) return '';
            return `<span class="dash-help-score tabular-nums">${escapeHtml(s)}</span>`;
        }

        function dashRenderHelpTier(tierLabel) {
            const t = String(tierLabel ?? '').trim();
            if (!t) return '';
            const letter = dashTierLetterFromLabel(t);
            const attr = letter ? ` data-tier-letter="${escapeHtml(letter)}"` : '';
            return `<span class="dash-help-tier"${attr}>${escapeHtml(t)}</span>`;
        }

        function dashJoinHelpParts(parts) {
            return (Array.isArray(parts) ? parts : []).filter(Boolean).join('  ');
        }

        function openFeedAuthWarning() {
            const el = document.getElementById('feed-auth-warning');
            if (!el) return;
            el.style.display = 'flex';
        }

        function closeFeedAuthWarning() {
            const el = document.getElementById('feed-auth-warning');
            if (!el) return;
            el.style.display = 'none';
        }

        function openLibraryAuthWarning() {
            const el = document.getElementById('library-auth-warning');
            if (!el) return;
            el.style.display = 'flex';
        }

        function closeLibraryAuthWarning() {
            const el = document.getElementById('library-auth-warning');
            if (!el) return;
            el.style.display = 'none';
        }

        function openListsAuthWarning() {
            const el = document.getElementById('lists-auth-warning');
            if (!el) return;
            el.style.display = 'flex';
        }

        function closeListsAuthWarning() {
            const el = document.getElementById('lists-auth-warning');
            if (!el) return;
            el.style.display = 'none';
        }

        let listsBound = false;
        let listsLoading = false;
        let listsActiveListId = null;
        let listsActiveListName = '';
        let cachedLists = [];
        let cachedListsUserId = null;

        let listsMoviePrefillById = new Map();
        let listsPlatformsByMovieId = new Map();

        let cachedBucketListId = null;
        let bucketListEnsuredForUserId = null;

        let listPickerSelectedMovie = null;
        let listPickerBusy = false;
        let listsCreateBusy = false;
        let listsRenameBusy = false;
        let listsDeleteBusy = false;

        function isBucketList({ list_id, list_name } = {}) {
            const lid = String(list_id || '').trim();
            if (lid && cachedBucketListId && String(cachedBucketListId) === lid) return true;
            const name = String(list_name || '').trim().toLowerCase();
            return name === 'bucket list';
        }

        function closeListPickerModal() {
            const overlay = document.getElementById('list-picker-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';

            const statusEl = document.getElementById('list-picker-status');
            if (statusEl) statusEl.textContent = '';
            const nameEl = document.getElementById('list-picker-new-name');
            if (nameEl) nameEl.value = '';
            listPickerSelectedMovie = null;
            listPickerBusy = false;
        }

        function openListsCreateModal() {
            const overlay = document.getElementById('lists-create-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';

            const statusEl = document.getElementById('lists-create-status');
            if (statusEl) statusEl.textContent = '';
            const input = document.getElementById('lists-create-name');
            if (input) {
                input.value = '';
                try { input.focus(); } catch (_) {}
            }
            listsCreateBusy = false;
        }

        function closeListsCreateModal() {
            const overlay = document.getElementById('lists-create-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';
            const statusEl = document.getElementById('lists-create-status');
            if (statusEl) statusEl.textContent = '';
            const input = document.getElementById('lists-create-name');
            if (input) input.value = '';
            listsCreateBusy = false;
        }

        function openListsRenameModal() {
            const lid = String(listsActiveListId || '').trim();
            if (!lid) {
                showToast('Select a list first.', { level: 'warn' });
                return;
            }
            if (isBucketList({ list_id: lid, list_name: listsActiveListName })) {
                showToast('Bucket List cant be renamed.', { level: 'warn' });
                return;
            }

            const overlay = document.getElementById('lists-rename-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';

            const statusEl = document.getElementById('lists-rename-status');
            if (statusEl) statusEl.textContent = '';
            const input = document.getElementById('lists-rename-name');
            if (input) {
                input.value = String(listsActiveListName || '').trim();
                try { input.focus(); input.select?.(); } catch (_) {}
            }
            listsRenameBusy = false;
        }

        function closeListsRenameModal() {
            const overlay = document.getElementById('lists-rename-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';
            const statusEl = document.getElementById('lists-rename-status');
            if (statusEl) statusEl.textContent = '';
            const input = document.getElementById('lists-rename-name');
            if (input) input.value = '';
            listsRenameBusy = false;
        }

        function openListsDeleteModal() {
            const lid = String(listsActiveListId || '').trim();
            if (!lid) {
                showToast('Select a list first.', { level: 'warn' });
                return;
            }
            if (isBucketList({ list_id: lid, list_name: listsActiveListName })) {
                showToast('Bucket List cant be deleted.', { level: 'warn' });
                return;
            }

            const overlay = document.getElementById('lists-delete-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';

            const statusEl = document.getElementById('lists-delete-status');
            if (statusEl) statusEl.textContent = '';
            const nameEl = document.getElementById('lists-delete-name');
            if (nameEl) nameEl.textContent = `${String(listsActiveListName || 'this list').trim() || 'this list'}`;
            listsDeleteBusy = false;
        }

        function closeListsDeleteModal() {
            const overlay = document.getElementById('lists-delete-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';
            const statusEl = document.getElementById('lists-delete-status');
            if (statusEl) statusEl.textContent = '';
            const nameEl = document.getElementById('lists-delete-name');
            if (nameEl) nameEl.textContent = '';
            listsDeleteBusy = false;
        }

        function hexToRgba(hex, alpha) {
            const h = String(hex || '').trim().replace('#', '');
            if (!/^[0-9a-f]{6}$/i.test(h)) return `rgba(255,255,255,${Number(alpha) || 0.15})`;
            const r = parseInt(h.slice(0, 2), 16);
            const g = parseInt(h.slice(2, 4), 16);
            const b = parseInt(h.slice(4, 6), 16);
            const a = Math.max(0, Math.min(1, Number(alpha)));
            return `rgba(${r},${g},${b},${a})`;
        }

        function platformBrandTheme(platformName) {
            const raw = normalizePlatformName(platformName);
            const n = raw.toLowerCase();

            // Defaults (neutral).
            let bg = 'rgba(255,255,255,0.06)';
            let border = 'rgba(255,255,255,0.14)';
            let text = 'rgba(255,255,255,0.92)';

            const solid = (hex) => {
                bg = hexToRgba(hex, 0.18);
                border = hexToRgba(hex, 0.55);
                text = '#fff';
            };

            if (n.includes('netflix')) {
                solid('#E50914');
            } else if (n.includes('prime video') || (n.includes('amazon') && n.includes('prime'))) {
                solid('#00A8E1');
            } else if (n === 'amazon video' || (n.includes('amazon') && !n.includes('prime'))) {
                solid('#FF9900');
            } else if (n.includes('disney')) {
                bg = 'linear-gradient(90deg, rgba(17,60,207,0.30), rgba(0,209,255,0.22))';
                border = 'rgba(0,209,255,0.55)';
                text = '#fff';
            } else if (n === 'max' || n.includes('hbo') || n.includes('hbo max')) {
                solid('#7D2AE8');
            } else if (n.includes('hulu')) {
                solid('#1CE783');
            } else if (n.includes('apple tv') || n === 'apple tv+' || n.includes('itunes')) {
                bg = 'rgba(255,255,255,0.10)';
                border = 'rgba(255,255,255,0.35)';
                text = '#fff';
            } else if (n.includes('paramount')) {
                solid('#0064FF');
            } else if (n.includes('peacock')) {
                solid('#00A7E1');
            } else if (n.includes('crunchyroll')) {
                solid('#F47521');
            } else if (n.includes('tubi')) {
                solid('#FF1D5E');
            } else if (n.includes('pluto')) {
                bg = 'rgba(255, 236, 0, 0.18)';
                border = 'rgba(255, 236, 0, 0.55)';
                text = 'rgba(255,255,255,0.95)';
            } else if (n.includes('youtube')) {
                solid('#FF0000');
            } else if (n.includes('google play') || (n.includes('google') && n.includes('play'))) {
                solid('#34A853');
            } else if (n.includes('vudu')) {
                solid('#0077C8');
            } else if (n.includes('plex')) {
                solid('#E5A00D');
            } else if (n.includes('mubi')) {
                bg = 'rgba(255,255,255,0.10)';
                border = 'rgba(255,255,255,0.28)';
                text = '#fff';
            }

            return { bg, border, text };
        }

        function openListsWatchOptionsModal({ movie_id, title } = {}) {
            const mid = String(movie_id || '').trim();
            if (!mid) return;

            const overlay = document.getElementById('lists-watch-options-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';

            const movieEl = document.getElementById('lists-watch-options-movie');
            if (movieEl) {
                const t = String(title || '').trim();
                movieEl.textContent = t ? `Movie: ${t}` : 'Movie';
            }

            const bodyEl = document.getElementById('lists-watch-options-body');
            if (!bodyEl) return;

            const platforms = listsPlatformsByMovieId.get(mid) || [];
            if (!platforms.length) {
                bodyEl.innerHTML = `<div class="text-gray">No watch options found yet.</div>`;
                return;
            }

            bodyEl.innerHTML = `
                <div class="text-white font-bold" style="margin-bottom: 0.55rem;">Available on</div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    ${platforms.map((p) => {
                        const full = normalizePlatformName(p);
                        const label = platformShortLabel(full) || full;
                        const theme = platformBrandTheme(full);
                        const pillStyle = `background: ${theme.bg}; border: 1px solid ${theme.border}; color: ${theme.text};`;

                        return `
                            <div style="display:flex; align-items:center; justify-content: center; padding: 0.7rem; border-radius: 0.85rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10);">
                                <span style="display:inline-flex; align-items:center; padding: 0.28rem 0.6rem; border-radius: 999px; font-weight: 900; font-size: 0.88rem; line-height: 1; ${pillStyle}">${escapeHtml(label)}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function closeListsWatchOptionsModal() {
            const overlay = document.getElementById('lists-watch-options-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';
            const movieEl = document.getElementById('lists-watch-options-movie');
            if (movieEl) movieEl.textContent = '';
            const bodyEl = document.getElementById('lists-watch-options-body');
            if (bodyEl) bodyEl.innerHTML = `<div class="text-gray">Loading</div>`;
        }

        function setListsActiveListActionsEnabledState() {
            const renameBtn = document.getElementById('lists-rename-btn');
            const deleteBtn = document.getElementById('lists-delete-btn');
            const filterBtn = document.getElementById('lists-filter-btn');
            const lid = String(listsActiveListId || '').trim();
            const isBucket = isBucketList({ list_id: lid, list_name: listsActiveListName });
            const enabled = Boolean(lid) && !isBucket;
            if (renameBtn) renameBtn.disabled = !enabled || listsRenameBusy;
            if (deleteBtn) deleteBtn.disabled = !enabled || listsDeleteBusy;

            // Bucket List should not expose a Delete entry point.
            if (deleteBtn) deleteBtn.style.display = isBucket ? 'none' : '';

            // Filters/Sort works for all lists (including Bucket List).
            const filtersEnabled = Boolean(lid) && !listsLoading;
            if (filterBtn) filterBtn.disabled = !filtersEnabled;

            if (filterBtn) {
                ensureListsSortFilterStateInitialized();
                const labels = {
                    sortKey: {
                        watch_date: 'Watch Date',
                        watch_count: 'Watch Count',
                        overall: 'Overall %',
                        sound: 'Sound %',
                        pace: 'Pace %',
                        imagery: 'Imagery %',
                        acting: 'Acting %',
                        plot: 'Plot %',
                        dialogue: 'Dialogue %',
                        imdb: 'IMDb %',
                        release_year: 'Release Year',
                    }
                };
                const model = buildSortFilterChipModel({
                    state: listsSortFilterState,
                    defaults: getDefaultListsSortFilterStateForActiveList(),
                    labels,
                });

                filterBtn.title = model?.summaryText || '';
                if (model?.isDefault) {
                    filterBtn.style.borderColor = '';
                    filterBtn.style.background = '';
                } else {
                    filterBtn.style.borderColor = 'rgba(20, 184, 166, 0.65)';
                    filterBtn.style.background = 'rgba(20, 184, 166, 0.12)';
                }
            }
        }

        let listsSortFilterState = null;
        let listsSortFilterDraft = null;
        let listsFacetOptions = { decades: [], mpas: [], genres: [], platforms: [] };

        function buildSortFilterStatusLine({ state, defaults, labels }) {
            const st = state || {};
            const def = defaults || {};

            const sortKey = String(st.sortKey || def.sortKey || '').trim();
            const sortDir = String(st.sortDir || def.sortDir || '').trim().toLowerCase();
            const sortDefault = (sortKey === String(def.sortKey || '').trim()) && (sortDir === String(def.sortDir || '').trim().toLowerCase());

            const parts = [];

            const filterPairs = [];
            const pushFilter = (k, v, { label = '' } = {}) => {
                const val = String(v || '').trim();
                if (!val) return;
                filterPairs.push({ k, label: label || k, v: val });
            };

            pushFilter('tier', st.tier, { label: 'Tier' });
            pushFilter('decade', st.decade, { label: 'Decade' });
            pushFilter('directorContains', st.directorContains, { label: 'Director' });
            pushFilter('actorContains', st.actorContains, { label: 'Actor' });
            pushFilter('movieId', st.movieTitle || st.movieId, { label: 'Movie' });
            pushFilter('mpa', st.mpa, { label: 'MPA' });
            pushFilter('genre', st.genre, { label: 'Genre' });
            pushFilter('watchMethod', st.watchMethod, { label: 'Watch Method' });
            pushFilter('platform', st.platform, { label: 'Platform' });
            if (st.watchCountMin || st.watchCountMax) {
                const minVal = String(st.watchCountMin || '').trim();
                const maxVal = String(st.watchCountMax || '').trim();
                const label = minVal && maxVal ? `${minVal}-${maxVal}` : (minVal ? `${minVal}+` : ` ${maxVal}`);
                pushFilter('watchCount', label, { label: 'Watch Count' });
            }

            const hasAnyFilters = filterPairs.length > 0;

            const sortLabel = labels?.sortKey?.[sortKey] || sortKey || 'Watch Date';
            const dirArrow = (sortDir === 'asc') ? '' : '';
            const sortPart = `Sort: ${sortLabel} ${dirArrow}`;

            const formatFilter = (p) => {
                if (p.k === 'directorContains') return `${p.label} contains ${p.v}`;
                if (p.k === 'actorContains') return `${p.label} contains ${p.v}`;
                if (p.k === 'watchCount') return `${p.label}: ${p.v}`;
                if (p.k === 'watchMethod') return `${p.label}: ${p.v}`;
                if (p.k === 'platform' && p.v === '__NONE__') return `${p.label}: None`;
                if (p.k === 'tier' && p.v === 'UNRANKED') return `${p.label}: Unranked`;
                if (p.k === 'timeframe') return `${p.label}: ${p.v}`;
                return `${p.label}: ${p.v}`;
            };

            if (!hasAnyFilters && sortDefault) {
                return { isDefault: true, text: 'Filters/Sort: Default' };
            }

            if (hasAnyFilters) {
                const shown = filterPairs.slice(0, 3).map(formatFilter);
                const extra = filterPairs.length - shown.length;
                parts.push(`Filters: ${shown.join(', ')}${extra > 0 ? ` (+${extra})` : ''}`);
            }
            if (!sortDefault) parts.push(sortPart);
            if (sortDefault && hasAnyFilters) parts.push('Sort: Default');

            return { isDefault: false, text: parts.join('  ') };
        }

        function buildSortFilterChipModel({ state, defaults, labels }) {
            const st = state || {};
            const def = defaults || {};
            const status = buildSortFilterStatusLine({ state: st, defaults: def, labels });

            const sortKey = String(st.sortKey || def.sortKey || '').trim();
            const sortDir = String(st.sortDir || def.sortDir || '').trim().toLowerCase();
            const sortChanged = (sortKey !== String(def.sortKey || '').trim()) || (sortDir !== String(def.sortDir || '').trim().toLowerCase());

            const sortLabel = labels?.sortKey?.[sortKey] || sortKey || 'Watch Date';
            const dirArrow = (sortDir === 'asc') ? '' : '';

            const chips = [];

            const addFilterChip = (part, text) => {
                const t = String(text || '').trim();
                if (!t) return;
                chips.push({ part, kind: 'filter', text: t });
            };

            const tier = String(st.tier || '').trim();
            if (tier) addFilterChip('tier', `Tier: ${tier === 'UNRANKED' ? 'Unranked' : tier}`);

            const decade = String(st.decade || '').trim();
            if (decade) addFilterChip('decade', `Decade: ${decade}`);

            const director = String(st.directorContains || '').trim();
            if (director) addFilterChip('directorContains', `Director contains ${director}`);

            const actor = String(st.actorContains || '').trim();
            if (actor) addFilterChip('actorContains', `Actor contains ${actor}`);

            const movieLabel = String(st.movieTitle || st.movieId || '').trim();
            if (movieLabel) addFilterChip('movieId', `Movie: ${movieLabel}`);

            const mpa = String(st.mpa || '').trim();
            if (mpa) addFilterChip('mpa', `MPA: ${mpa}`);

            const genre = String(st.genre || '').trim();
            if (genre) addFilterChip('genre', `Genre: ${genre}`);

            const watchMethod = String(st.watchMethod || '').trim();
            if (watchMethod) addFilterChip('watchMethod', `Watch Method: ${watchMethod}`);

            const watchMin = String(st.watchCountMin || '').trim();
            const watchMax = String(st.watchCountMax || '').trim();
            if (watchMin || watchMax) {
                const label = watchMin && watchMax ? `${watchMin}-${watchMax}` : (watchMin ? `${watchMin}+` : ` ${watchMax}`);
                addFilterChip('watchCount', `Watch Count: ${label}`);
            }

            const timeframe = String(st.timeframe || '').trim();
            if (timeframe && timeframe !== 'all_time') addFilterChip('timeframe', `Timeframe: ${timeframe}`);

            const platform = String(st.platform || '').trim();
            if (platform) addFilterChip('platform', `Platform: ${platform === '__NONE__' ? 'None' : platform}`);

            if (sortChanged) {
                chips.push({ part: 'sort', kind: 'sort', text: `Sort: ${sortLabel} ${dirArrow}` });
            }

            return {
                isDefault: Boolean(status?.isDefault),
                summaryText: String(status?.text || ''),
                chips,
            };
        }

        function renderSortFilterChipsHtml({ model, namespace }) {
            const m = model || { isDefault: true, summaryText: '', chips: [] };
            const ns = String(namespace || '').trim();
            const wrapStyle = 'display:flex; flex-wrap: wrap; gap: 8px; align-items: center;';
            const xStyle = 'width: 18px; height: 18px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.22); background: rgba(0,0,0,0.18); color: rgba(255,255,255,0.80); font-weight: 900; line-height: 1; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;';

            const defaultChip = `<span class="dash-quote-pill" style="display:inline-flex; align-items:center; gap: 8px; opacity: 0.9;">Default</span>`;
            if (m.isDefault) {
                return `<div style="${wrapStyle}">${defaultChip}</div>`;
            }

            const chipHtml = (c) => {
                const text = String(c?.text || '').trim();
                const part = String(c?.part || '').trim();
                if (!text || !part) return '';
                const clearBtn = `<button type="button" style="${xStyle}" data-${escapeHtml(ns)}-action="clear_sort_filter_part" data-part="${escapeHtml(part)}" aria-label="Clear ${escapeHtml(text)}" title="Clear"></button>`;
                return `<span class="dash-quote-pill" style="display:inline-flex; align-items:center; gap: 8px;">${escapeHtml(text)}${clearBtn}</span>`;
            };

            const chips = (Array.isArray(m.chips) ? m.chips : []).map(chipHtml).filter(Boolean).join('');
            return `<div style="${wrapStyle}">${chips || defaultChip}</div>`;
        }

        function getDefaultListsSortFilterState({ isBucket = false } = {}) {
            // Bucket List: movies are generally unwatched/unrated, so avoid rating-based defaults.
            // Also avoid "Watch Date" since it will typically be null.
            if (isBucket) {
                return {
                    sortKey: 'release_year',
                    sortDir: 'desc',
                    tier: '',
                    decade: '',
                    directorContains: '',
                    mpa: '',
                    genre: '',
                    platform: '',
                };
            }

            return {
                sortKey: 'watch_date',
                sortDir: 'desc',
                tier: '',
                decade: '',
                directorContains: '',
                mpa: '',
                genre: '',
                platform: '',
            };
        }

        function getDefaultListsSortFilterStateForActiveList() {
            const lid = String(listsActiveListId || '').trim();
            const isBucket = isBucketList({ list_id: lid, list_name: listsActiveListName });
            return getDefaultListsSortFilterState({ isBucket });
        }

        function getAllowedListsSortKeysForActiveList() {
            const lid = String(listsActiveListId || '').trim();
            const isBucket = isBucketList({ list_id: lid, list_name: listsActiveListName });

            if (isBucket) {
                // Bucket List: no user rating sorts; no watch-date sort.
                return ['release_year', 'imdb'];
            }

            return [
                'watch_date',
                'overall',
                'sound',
                'pace',
                'imagery',
                'acting',
                'plot',
                'dialogue',
                'imdb',
                'release_year',
            ];
        }

        function ensureListsSortFilterStateInitialized() {
            if (!listsSortFilterState) {
                listsSortFilterState = getDefaultListsSortFilterStateForActiveList();
            }
        }

        function configureListsSortFilterModalForActiveList() {
            const els = getListsSortFilterModalEls();
            if (!els.sortKey) return;

            const lid = String(listsActiveListId || '').trim();
            const isBucket = isBucketList({ list_id: lid, list_name: listsActiveListName });
            const allowed = new Set(getAllowedListsSortKeysForActiveList());

            const sortOptions = [
                { value: 'watch_date', label: 'Watch Date' },
                { value: 'overall', label: 'Overall %' },
                { value: 'sound', label: 'Sound %' },
                { value: 'pace', label: 'Pace %' },
                { value: 'imagery', label: 'Imagery %' },
                { value: 'acting', label: 'Acting %' },
                { value: 'plot', label: 'Plot %' },
                { value: 'dialogue', label: 'Dialogue %' },
                { value: 'imdb', label: 'IMDb %' },
                { value: 'release_year', label: 'Release Year' },
            ].filter(o => allowed.has(o.value));

            const prev = String(els.sortKey.value || '').trim();
            els.sortKey.innerHTML = sortOptions.map(o => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join('');
            if (prev && allowed.has(prev)) {
                els.sortKey.value = prev;
            }

            // Bucket List shouldn't expose tier controls.
            if (els.tier) {
                els.tier.value = '';
                els.tier.disabled = isBucket;
                els.tier.style.display = isBucket ? 'none' : '';
            }

            // If current state is incompatible with this list, coerce it.
            ensureListsSortFilterStateInitialized();
            const def = getDefaultListsSortFilterState({ isBucket });
            const next = { ...listsSortFilterState };

            if (!allowed.has(String(next.sortKey || '').trim())) {
                next.sortKey = def.sortKey;
                next.sortDir = def.sortDir;
            }

            if (isBucket) {
                next.tier = '';
            }

            listsSortFilterState = next;
        }

        function getListsSortFilterModalEls() {
            return {
                overlay: document.getElementById('lists-sortfilter-overlay'),
                sortKey: document.getElementById('lists-modal-sort-key'),
                sortDir: document.getElementById('lists-modal-sort-dir'),
                tier: document.getElementById('lists-modal-filter-tier'),
                decade: document.getElementById('lists-modal-filter-decade'),
                director: document.getElementById('lists-modal-filter-director'),
                mpa: document.getElementById('lists-modal-filter-mpa'),
                genre: document.getElementById('lists-modal-filter-genre'),
                platform: document.getElementById('lists-modal-filter-platform'),
            };
        }

        function setSelectOptions(el, { baseOptions = [], values = [] } = {}) {
            if (!el) return;
            const keep = baseOptions.map(o => ({ value: String(o?.value ?? ''), label: String(o?.label ?? '') }));
            const uniq = Array.from(new Set((Array.isArray(values) ? values : []).map(v => String(v || '').trim()).filter(Boolean)));
            const items = uniq.sort((a, b) => a.localeCompare(b));
            el.innerHTML = [
                ...keep.map(o => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`),
                ...items.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`),
            ].join('');
        }

        function loadListsFacetsIntoModal() {
            const els = getListsSortFilterModalEls();
            setSelectOptions(els.decade, {
                baseOptions: [{ value: '', label: 'Release Decade (All)' }],
                values: listsFacetOptions?.decades || [],
            });
            setSelectOptions(els.mpa, {
                baseOptions: [{ value: '', label: 'MPA (All)' }],
                values: listsFacetOptions?.mpas || [],
            });
            setSelectOptions(els.genre, {
                baseOptions: [{ value: '', label: 'Genre (All)' }],
                values: listsFacetOptions?.genres || [],
            });
            setSelectOptions(els.platform, {
                baseOptions: [
                    { value: '', label: 'Platform (All)' },
                    { value: '__NONE__', label: 'No Watch Options' },
                ],
                values: listsFacetOptions?.platforms || [],
            });
        }

        function setListsSortFilterModalFromState(state) {
            const els = getListsSortFilterModalEls();
            if (!els.sortKey || !els.sortDir) return;
            els.sortKey.value = String(state?.sortKey || 'watch_date');
            els.sortDir.value = (String(state?.sortDir || 'desc') === 'asc') ? 'asc' : 'desc';
            if (els.tier && !els.tier.disabled) els.tier.value = String(state?.tier || '');
            if (els.decade) els.decade.value = String(state?.decade || '');
            if (els.director) els.director.value = String(state?.directorContains || '');
            if (els.mpa) els.mpa.value = String(state?.mpa || '');
            if (els.genre) els.genre.value = String(state?.genre || '');
            if (els.platform) els.platform.value = String(state?.platform || '');
        }

        function readListsSortFilterModalState() {
            const els = getListsSortFilterModalEls();
            const getVal = (el) => String(el?.value || '').trim();
            return {
                sortKey: getVal(els.sortKey) || 'watch_date',
                sortDir: (getVal(els.sortDir) === 'asc') ? 'asc' : 'desc',
                tier: (els.tier && els.tier.disabled) ? '' : getVal(els.tier),
                decade: getVal(els.decade),
                directorContains: getVal(els.director),
                mpa: getVal(els.mpa),
                genre: getVal(els.genre),
                platform: getVal(els.platform),
            };
        }

        function openListsSortFilterModal() {
            ensureListsSortFilterStateInitialized();
            const els = getListsSortFilterModalEls();
            if (!els.overlay) return;
            const lid = String(listsActiveListId || '').trim();
            if (!lid) {
                showToast('Select a list first.', { level: 'warn' });
                return;
            }
            listsSortFilterDraft = { ...listsSortFilterState };
            loadListsFacetsIntoModal();
            setListsSortFilterModalFromState(listsSortFilterState);
            els.overlay.style.display = 'flex';
            setTimeout(() => {
                try { els.sortKey?.focus?.(); } catch (_) {}
            }, 0);
        }

        function closeListsSortFilterModal({ restoreDraft = false } = {}) {
            const els = getListsSortFilterModalEls();
            if (!els.overlay) return;
            if (restoreDraft && listsSortFilterDraft) {
                loadListsFacetsIntoModal();
                setListsSortFilterModalFromState(listsSortFilterDraft);
            }
            els.overlay.style.display = 'none';
        }

        function saveListsSortFilterModal() {
            ensureListsSortFilterStateInitialized();
            const next = readListsSortFilterModalState();
            listsSortFilterState = next;
            listsSortFilterDraft = null;
            closeListsSortFilterModal({ restoreDraft: false });
            loadListsPage({ reset: false }).catch(() => null);
        }

        function resetListsSortFilterDraft() {
            ensureListsSortFilterStateInitialized();
            const next = getDefaultListsSortFilterStateForActiveList();
            listsSortFilterDraft = next;
            configureListsSortFilterModalForActiveList();
            loadListsFacetsIntoModal();
            setListsSortFilterModalFromState(next);
        }

        function listsDecadeLabelFromYear(year) {
            const y = Number(year);
            if (!Number.isFinite(y) || y <= 0) return '';
            const decade = Math.floor(y / 10) * 10;
            return `${decade}s`;
        }

        // Utility: De-duplicate array of strings, preserving order
        function uniqStrings(arr) {
            if (!Array.isArray(arr)) return [];
            const seen = new Set();
            const out = [];
            for (const s of arr) {
                const v = String(s || '').trim();
                if (v && !seen.has(v)) {
                    seen.add(v);
                    out.push(v);
                }
            }
            return out;
        }

        function listsNormalizeGenresToArray(movie) {
            if (!movie) return [];
            if (Array.isArray(movie?.genres) && movie.genres.length) {
                return uniqStrings(movie.genres.map(x => String(x || '').trim()).filter(Boolean));
            }
            const raw = String(movie?.genre || '').trim();
            if (!raw) return [];
            return uniqStrings(raw.split(',').map(s => String(s || '').trim()).filter(Boolean));
        }

        function applyListsSortFilter(items, state) {
            const st = state || getDefaultListsSortFilterStateForActiveList();
            const wantedTier = String(st.tier || '').trim();
            const wantedDecade = String(st.decade || '').trim();
            const wantedDirector = String(st.directorContains || '').trim().toLowerCase();
            const wantedMpa = String(st.mpa || '').trim().toLowerCase();
            const wantedGenre = String(st.genre || '').trim().toLowerCase();
            const wantedPlatform = String(st.platform || '').trim();

            const filtered = (Array.isArray(items) ? items : []).filter((it) => {
                if (!it) return false;

                if (wantedTier) {
                    const t = String(it?.tier || '').trim();
                    if (wantedTier === 'UNRANKED') {
                        if (t) return false;
                    } else {
                        if (t !== wantedTier) return false;
                    }
                }

                if (wantedDecade) {
                    const decade = listsDecadeLabelFromYear(it?.release_year);
                    if (decade !== wantedDecade) return false;
                }

                if (wantedDirector) {
                    const dir = String(it?.director || '').toLowerCase();
                    if (!dir.includes(wantedDirector)) return false;
                }

                if (wantedMpa) {
                    const mpa = String(it?.mpa_rating || '').trim().toLowerCase();
                    if (!mpa || mpa !== wantedMpa) return false;
                }

                if (wantedGenre) {
                    const genres = Array.isArray(it?.genresArr) ? it.genresArr : [];
                    const ok = genres.some(g => String(g || '').trim().toLowerCase() === wantedGenre);
                    if (!ok) return false;
                }

                if (wantedPlatform) {
                    const plats = Array.isArray(it?.platforms) ? it.platforms : [];
                    if (wantedPlatform === '__NONE__') {
                        if (plats.length) return false;
                    } else {
                        if (!plats.includes(wantedPlatform)) return false;
                    }
                }

                return true;
            });

            const sortKey = String(st.sortKey || 'watch_date');
            const asc = String(st.sortDir || 'desc') === 'asc';
            const dirMul = asc ? 1 : -1;

            const getSortVal = (it) => {
                if (sortKey === 'watch_date') {
                    const raw = String(it?.latest_watch_date || '').trim();
                    if (!raw) return null;
                    const d = new Date(raw.includes('T') ? raw : `${raw}T00:00:00`);
                    return Number.isNaN(d.getTime()) ? null : d.getTime();
                }
                if (sortKey === 'release_year') {
                    const y = Number(it?.release_year);
                    return Number.isFinite(y) ? y : null;
                }
                if (sortKey === 'imdb') {
                    const n = parsePercentLike(it?.imdb_rating_pct ?? it?.imdb_pct ?? it?.imdb_rating ?? it?.imdb, { imdb: true });
                    return (n === null || n === undefined) ? null : Number(n);
                }
                if (sortKey === 'overall') return (it?.overall_rating === null || it?.overall_rating === undefined) ? null : Number(it.overall_rating);
                if (sortKey === 'sound') return (it?.sound_rating === null || it?.sound_rating === undefined) ? null : Number(it.sound_rating);
                if (sortKey === 'pace') return (it?.pacing_rating === null || it?.pacing_rating === undefined) ? null : Number(it.pacing_rating);
                if (sortKey === 'imagery') return (it?.imagery_rating === null || it?.imagery_rating === undefined) ? null : Number(it.imagery_rating);
                if (sortKey === 'acting') return (it?.acting_rating === null || it?.acting_rating === undefined) ? null : Number(it.acting_rating);
                if (sortKey === 'plot') return (it?.plot_rating === null || it?.plot_rating === undefined) ? null : Number(it.plot_rating);
                if (sortKey === 'dialogue') return (it?.dialogue_rating === null || it?.dialogue_rating === undefined) ? null : Number(it.dialogue_rating);
                return null;
            };

            const cmp = (a, b) => {
                const av = getSortVal(a);
                const bv = getSortVal(b);
                const aNull = (av === null || av === undefined || Number.isNaN(av));
                const bNull = (bv === null || bv === undefined || Number.isNaN(bv));
                if (aNull && bNull) {
                    const at = String(a?.title || '').toLowerCase();
                    const bt = String(b?.title || '').toLowerCase();
                    return at.localeCompare(bt);
                }
                if (aNull) return 1;
                if (bNull) return -1;
                if (av < bv) return -1 * dirMul;
                if (av > bv) return 1 * dirMul;
                const at = String(a?.title || '').toLowerCase();
                const bt = String(b?.title || '').toLowerCase();
                return at.localeCompare(bt);
            };

            return filtered.sort(cmp);
        }

        async function ensureBucketListForUser({ user_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            if (!uid) throw new Error('Missing user_id.');

            if (bucketListEnsuredForUserId === uid && cachedBucketListId) return cachedBucketListId;

            const row = { user_id: uid, list_name: 'Bucket List' };
            const { data, error } = await supabaseClient
                .from('Lists')
                .upsert(row, { onConflict: 'user_id,list_name' })
                .select('id, list_name')
                .single();

            if (error) throw error;
            cachedBucketListId = data?.id || null;
            bucketListEnsuredForUserId = uid;
            return cachedBucketListId;
        }

        function normalizeListName(name) {
            const s = String(name ?? '').trim();
            if (!s) return '';
            return s.replace(/\s+/g, ' ').trim();
        }

        function normalizePlatformName(name) {
            const s = String(name ?? '').trim();
            if (!s) return '';
            return s.replace(/\s+/g, ' ').trim();
        }

        function platformShortLabel(platformName) {
            const raw = normalizePlatformName(platformName);
            const n = raw.toLowerCase();
            if (!n) return '';

            if (n.includes('netflix')) return 'Netflix';
            if (n.includes('amazon') || n.includes('prime video') || n === 'prime') return 'Prime';
            if (n.includes('disney')) return 'Disney+';
            if (n === 'max' || n.includes('hbo') || n.includes('hbo max')) return 'Max';
            if (n.includes('hulu')) return 'Hulu';
            if (n.includes('apple tv') || n.includes('apple') || n.includes('itunes')) return 'Apple TV';
            if (n.includes('paramount')) return 'Paramount+';
            if (n.includes('peacock')) return 'Peacock';
            if (n.includes('crunchyroll')) return 'Crunchyroll';
            if (n.includes('tubi')) return 'Tubi';
            if (n.includes('pluto')) return 'Pluto';
            if (n.includes('youtube')) return 'YouTube';
            if (n.includes('google play') || n.includes('google') || n.includes('play')) return 'Google Play';
            if (n.includes('vudu')) return 'Vudu';
            if (n.includes('mubi')) return 'MUBI';
            if (n.includes('kanopy')) return 'Kanopy';
            if (n.includes('plex')) return 'Plex';

            // Fallback: keep short names readable.
            if (raw.length <= 14) return raw;
            return raw.slice(0, 12).trim() + '';
        }

        function renderPlatformPills(platformNames) {
            const names = Array.isArray(platformNames) ? platformNames : [];
            const labels = [];
            const seen = new Set();

            for (const name of names) {
                const label = platformShortLabel(name);
                const key = String(label || '').toLowerCase();
                if (!label || seen.has(key)) continue;
                seen.add(key);
                labels.push(label);
            }

            const max = 4;
            const head = labels.slice(0, max);
            const more = labels.length - head.length;

            const chips = head.map((l) => (`<span class="lists-platform-pill">${escapeHtml(l)}</span>`));
            if (more > 0) chips.push(`<span class="lists-platform-pill more">+${escapeHtml(String(more))}</span>`);
            return chips.join('');
        }

        async function loadUserLists({ user_id, force = false } = {}) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            if (!uid) throw new Error('Missing user_id.');

            if (!force && cachedListsUserId === uid && Array.isArray(cachedLists) && cachedLists.length) {
                return cachedLists;
            }

            const { data, error } = await supabaseClient
                .from('Lists')
                .select('id, list_name, created_at')
                .eq('user_id', uid)
                .order('created_at', { ascending: true });
            if (error) throw error;

            const rows = Array.isArray(data) ? data : [];
            rows.sort((a, b) => {
                const an = String(a?.list_name || '').toLowerCase();
                const bn = String(b?.list_name || '').toLowerCase();
                if (an === 'bucket list' && bn !== 'bucket list') return -1;
                if (bn === 'bucket list' && an !== 'bucket list') return 1;
                return 0;
            });

            cachedLists = rows;
            cachedListsUserId = uid;

            const bucket = rows.find(r => String(r?.list_name || '').toLowerCase() === 'bucket list');
            if (bucket?.id) {
                cachedBucketListId = bucket.id;
                bucketListEnsuredForUserId = uid;
            }

            return cachedLists;
        }

        async function createUserList({ user_id, list_name }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            const name = normalizeListName(list_name);
            if (!uid) throw new Error('Missing user_id.');
            if (!name) throw new Error('List name is required.');

            const { data, error } = await supabaseClient
                .from('Lists')
                .insert({ user_id: uid, list_name: name })
                .select('id, list_name, created_at')
                .single();

            if (error) throw error;
            return data;
        }

        async function addMovieToList({ user_id, list_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            const lid = String(list_id || '').trim();
            const mid = String(movie_id || '').trim();
            if (!uid) throw new Error('Missing user_id.');
            if (!lid) throw new Error('Missing list_id.');
            if (!mid) throw new Error('Missing movie_id.');

            const { error } = await supabaseClient
                .from('Movie Lists')
                .insert({ user_id: uid, list_id: lid, movie_id: mid });

            if (error) throw error;
        }

        async function removeMovieFromList({ user_id, list_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const uid = String(user_id || '').trim();
            const lid = String(list_id || '').trim();
            const mid = String(movie_id || '').trim();
            if (!uid || !lid || !mid) return;

            const { error } = await supabaseClient
                .from('Movie Lists')
                .delete()
                .eq('user_id', uid)
                .eq('list_id', lid)
                .eq('movie_id', mid);
            if (error) throw error;
        }

        async function removeMovieFromBucketList({ user_id, movie_id }) {
            const uid = String(user_id || '').trim();
            const mid = String(movie_id || '').trim();
            if (!uid || !mid) return;

            let bucketId = cachedBucketListId;
            try {
                bucketId = await ensureBucketListForUser({ user_id: uid });
            } catch (_) {}
            if (!bucketId) return;

            await removeMovieFromList({ user_id: uid, list_id: bucketId, movie_id: mid });
        }

        async function openAddToListModal() {
            if (!supabaseClient) {
                showToast('Supabase SDK failed to load.', { level: 'warn' });
                return;
            }

            let authedUser = null;
            let accessToken = null;
            try {
                const res = await requireAuthOrThrow();
                authedUser = res.user;
                accessToken = res.accessToken;
            } catch (_) {
                openAuthModal();
                return;
            }

            const picked = router?.selectedMovie || null;
            if (!picked) {
                showToast('Select a movie first.', { level: 'warn' });
                return;
            }

            const title = String(picked?.title || '').trim();
            const year = Number(picked?.year ?? picked?.release_year ?? null);
            const tmdbId = Number(picked?.tmdb_id ?? picked?.tmdbId ?? picked?.id ?? null);
            const existingDbMovieId = (isUuidLike(picked?.id) ? String(picked.id).trim() : '');

            listPickerSelectedMovie = {
                title,
                year: Number.isFinite(year) ? year : null,
                tmdb_id: Number.isFinite(tmdbId) ? tmdbId : null,
                db_movie_id: existingDbMovieId || null,
                accessToken,
                user_id: authedUser.id,
            };

            const overlay = document.getElementById('list-picker-overlay');
            if (overlay) overlay.style.display = 'flex';

            const movieEl = document.getElementById('list-picker-movie');
            if (movieEl) {
                movieEl.textContent = title ? `Movie: ${title}${(Number.isFinite(year) && year > 0) ? ` (${year})` : ''}` : 'Movie: (unknown)';
            }

            await ensureBucketListForUser({ user_id: authedUser.id }).catch(() => null);
            const lists = await loadUserLists({ user_id: authedUser.id, force: true }).catch(() => []);
            renderListPickerLists(lists);
        }

        function renderListPickerLists(lists) {
            const el = document.getElementById('list-picker-lists');
            if (!el) return;
            const rows = Array.isArray(lists) ? lists : [];
            if (rows.length === 0) {
                el.innerHTML = `<div class="text-gray">No lists yet.</div>`;
                return;
            }
            el.innerHTML = rows
                .map((l) => {
                    const name = String(l?.list_name || '').trim() || 'Untitled';
                    const id = String(l?.id || '').trim();
                    if (!id) return '';
                    const isBucket = name.toLowerCase() === 'bucket list';
                    return `
                        <button
                            type="button"
                            class="btn ${isBucket ? 'btn-primary' : 'btn-glass'}"
                            data-list-picker-action="add"
                            data-list-id="${escapeHtml(id)}"
                            style="width:100%; display:flex; justify-content: space-between; align-items: center; border-radius: 0.85rem;"
                        >
                            <span style="font-weight: 800;">${escapeHtml(name)}</span>
                            <span style="opacity: 0.8;">Add</span>
                        </button>
                    `;
                })
                .filter(Boolean)
                .join('');
        }

        async function ensureMovieFullySyncedForLists({ accessToken, title, release_year, tmdb_id, movie_id }) {
            const token = String(accessToken || '').trim();
            if (!token) throw new Error('Missing access token.');

            const uuidLike = isUuidLike;
            let dbMovieId = uuidLike(movie_id) ? String(movie_id).trim() : null;

            if (!dbMovieId && Number.isFinite(Number(tmdb_id)) && Number(tmdb_id) > 0) {
                try {
                    const mapped = await getDbMovieIdByTmdbId(Number(tmdb_id));
                    if (uuidLike(mapped)) dbMovieId = mapped;
                } catch (_) {}
            }

            if (dbMovieId) {
                const res = await callSwiftApi({ movie_id: dbMovieId, sync_people: true }, token);
                const outId = res?.movie_id || dbMovieId;
                return String(outId || '').trim();
            }

            const t = String(title || '').trim();
            const y = (release_year === null || release_year === undefined) ? null : Number(release_year);
            if (!t) throw new Error('Missing movie title.');

            const res = await callSwiftApi({ title: t, release_year: Number.isFinite(y) ? y : null, sync_people: true }, token);
            return String(res?.movie_id || '').trim();
        }

        async function handleListPickerAddToList(list_id) {
            if (listPickerBusy) return;
            const lid = String(list_id || '').trim();
            if (!lid) return;

            if (!listPickerSelectedMovie) {
                showToast('No movie selected.', { level: 'warn' });
                return;
            }

            const statusEl = document.getElementById('list-picker-status');
            const setStatus = (s) => {
                if (statusEl) statusEl.textContent = String(s || '');
            };

            listPickerBusy = true;
            setStatus('Syncing movie metadata');

            try {
                const uid = String(listPickerSelectedMovie.user_id || '').trim();
                const accessToken = String(listPickerSelectedMovie.accessToken || '').trim();

                const ensuredMovieId = await ensureMovieFullySyncedForLists({
                    accessToken,
                    title: listPickerSelectedMovie.title,
                    release_year: listPickerSelectedMovie.year,
                    tmdb_id: listPickerSelectedMovie.tmdb_id,
                    movie_id: listPickerSelectedMovie.db_movie_id,
                });

                if (!ensuredMovieId) throw new Error('Failed to ensure movie exists.');
                setStatus('Adding to list');

                try {
                    await addMovieToList({ user_id: uid, list_id: lid, movie_id: ensuredMovieId });
                } catch (err) {
                    const msg = String(err?.message || err);
                    if (/duplicate|unique/i.test(msg)) {
                        showToast('Already in that list.', { level: 'warn' });
                        closeListPickerModal();
                        return;
                    }
                    throw err;
                }

                showToast('Added to list!', { level: 'success' });

                // Refresh lists page if it's open.
                if (router?.currentPage === 'lists') {
                    await loadListsPage({ reset: false });
                }

                closeListPickerModal();
            } catch (err) {
                setStatus('');
                showToast(`Add to list failed: ${String(err?.message || err)}`, { level: 'warn' });
            } finally {
                listPickerBusy = false;
            }
        }

        function initListsPage() {
            if (listsBound) return;
            listsBound = true;

            document.addEventListener('click', (e) => {
                const el = e?.target?.closest ? e.target.closest('[data-lists-action]') : null;
                if (!el) return;
                const action = String(el.dataset.listsAction || '').trim();
                if (!action) return;

                if (action === 'refresh') {
                    (async () => {
                        await loadListsPage({ reset: true });
                    })().catch(() => {});
                    return;
                }

                if (action === 'rename_list') {
                    openListsRenameModal();
                    return;
                }

                if (action === 'delete_list') {
                    openListsDeleteModal();
                    return;
                }

                if (action === 'open_sort_filter') {
                    openListsSortFilterModal();
                    return;
                }

                if (action === 'cancel_sort_filter') {
                    closeListsSortFilterModal({ restoreDraft: true });
                    return;
                }

                if (action === 'save_sort_filter') {
                    saveListsSortFilterModal();
                    return;
                }

                if (action === 'reset_sort_filter_draft') {
                    resetListsSortFilterDraft();
                    return;
                }

                if (action === 'clear_sort_filter_part') {
                    ensureListsSortFilterStateInitialized();
                    const part = String(el.dataset.part || '').trim();
                    const def = getDefaultListsSortFilterStateForActiveList();
                    const next = { ...listsSortFilterState };

                    if (part === 'sort') {
                        next.sortKey = def.sortKey;
                        next.sortDir = def.sortDir;
                    } else if (Object.prototype.hasOwnProperty.call(next, part)) {
                        next[part] = '';
                    }

                    listsSortFilterState = next;
                    listsSortFilterDraft = null;
                    loadListsPage({ reset: false }).catch(() => null);
                    return;
                }

                if (action === 'confirm_delete_list') {
                    (async () => {
                        if (listsDeleteBusy) return;

                        const lid = String(listsActiveListId || '').trim();
                        if (!lid) return;
                        if (isBucketList({ list_id: lid, list_name: listsActiveListName })) {
                            showToast('Bucket List cant be deleted.', { level: 'warn' });
                            return;
                        }

                        const statusEl = document.getElementById('lists-delete-status');
                        const setStatus = (s) => { if (statusEl) statusEl.textContent = String(s || ''); };

                        let authedUser = null;
                        try {
                            const { user } = await requireAuthOrThrow();
                            authedUser = user;
                        } catch (_) {
                            setStatus('Please log in first.');
                            openAuthModal();
                            return;
                        }

                        listsDeleteBusy = true;
                        setListsActiveListActionsEnabledState();
                        setStatus('Deleting');

                        try {
                            // Remove joins first (safe even if there are none).
                            const { error: joinsErr } = await supabaseClient
                                .from('Movie Lists')
                                .delete()
                                .eq('user_id', authedUser.id)
                                .eq('list_id', lid);
                            if (joinsErr) throw joinsErr;

                            const { error: delErr } = await supabaseClient
                                .from('Lists')
                                .delete()
                                .eq('user_id', authedUser.id)
                                .eq('id', lid);
                            if (delErr) throw delErr;

                            cachedListsUserId = null;
                            listsActiveListId = null;
                            listsActiveListName = '';

                            closeListsDeleteModal();
                            await loadListsPage({ reset: true });
                            showToast('List deleted.', { level: 'success' });
                        } catch (err) {
                            setStatus('');
                            showToast(`Delete failed: ${String(err?.message || err)}`, { level: 'warn' });
                        } finally {
                            listsDeleteBusy = false;
                            setListsActiveListActionsEnabledState();
                        }
                    })().catch(() => {});
                    return;
                }

                if (action === 'watch_options') {
                    const mid = String(el.dataset.movieId || '').trim();
                    if (!mid) return;
                    const title = String(el.dataset.movieTitle || '').trim();
                    openListsWatchOptionsModal({ movie_id: mid, title });
                    return;
                }

                if (action === 'open_movie') {
                    const mid = String(el.dataset.movieId || '').trim();
                    if (!mid) return;

                    (async () => {
                        const prefill = listsMoviePrefillById.get(mid) || null;
                        if (!prefill) {
                            showToast('Movie details not available yet. Try Refresh.', { level: 'warn' });
                            return;
                        }

                        // Decide whether to open fully-populated Log New Entry (no existing rating)
                        // or fully-populated Update Ratings (existing rating).
                        let authedUser = null;
                        try {
                            const res = await requireAuthOrThrow();
                            authedUser = res.user;
                        } catch (_) {
                            openAuthModal();
                            return;
                        }

                        const alreadyRated = await hasExistingMovieRating({ user_id: authedUser.id, movie_id: mid });

                        // Start from our cached DB prefill, but route through the existing flows
                        // so MPA/Runtime/Series and rating fields are always filled correctly.
                        router.selectedMovie = { ...prefill, id: mid, detailsReadonly: false };
                        router.pendingTitle = String(prefill?.title || '').trim();

                        if (alreadyRated) {
                            await router.startUpdateRatings();
                        } else {
                            await router.startNewEntry();
                        }
                    })().catch((err) => {
                        showToast(`Open entry failed: ${String(err?.message || err)}`, { level: 'warn' });
                    });
                    return;
                }

                if (action === 'remove_movie') {
                    const lid = String(el.dataset.listId || '').trim();
                    const mid = String(el.dataset.movieId || '').trim();
                    if (!lid || !mid) return;

                    (async () => {
                        let authedUser = null;
                        try {
                            const { user } = await requireAuthOrThrow();
                            authedUser = user;
                        } catch (_) {
                            openAuthModal();
                            return;
                        }

                        try {
                            await removeMovieFromList({ user_id: authedUser.id, list_id: lid, movie_id: mid });
                            showToast('Removed.', { level: 'success' });
                            await loadListsPage({ reset: false });
                        } catch (err) {
                            showToast(`Remove failed: ${String(err?.message || err)}`, { level: 'warn' });
                        }
                    })().catch(() => {});
                }
            }, { capture: true });

            document.addEventListener('change', async (e) => {
                const sel = e?.target?.closest ? e.target.closest('#lists-select') : null;
                if (!sel) return;
                const lid = String(sel.value || '').trim();
                if (!lid) return;
                listsActiveListId = lid;
                const label = String(sel.selectedOptions?.[0]?.textContent || '').trim();
                if (label) listsActiveListName = label;

                // Reset the quick-add search UI when changing lists.
                try {
                    const input = document.getElementById('lists-movie-search-input');
                    if (input) input.value = '';
                    clearListsSearchUI();
                    setListsQuickAddEnabledState();
                } catch (_) {}

                await loadListsPage({ reset: false });
            }, { capture: true });

            document.addEventListener('click', async (e) => {
                const el = e?.target?.closest ? e.target.closest('[data-list-picker-action]') : null;
                if (!el) return;
                const action = String(el.dataset.listPickerAction || '').trim();
                if (action !== 'add') return;
                const lid = String(el.dataset.listId || '').trim();
                if (!lid) return;
                await handleListPickerAddToList(lid);
            }, { capture: true });

            const createForm = document.getElementById('list-picker-create-form');
            if (createForm) {
                createForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (listPickerBusy) return;

                    const statusEl = document.getElementById('list-picker-status');
                    const nameEl = document.getElementById('list-picker-new-name');
                    const setStatus = (s) => { if (statusEl) statusEl.textContent = String(s || ''); };

                    let authedUser = null;
                    let accessToken = null;
                    try {
                        const res = await requireAuthOrThrow();
                        authedUser = res.user;
                        accessToken = res.accessToken;
                    } catch (_) {
                        openAuthModal();
                        return;
                    }

                    const name = normalizeListName(nameEl?.value || '');
                    if (!name) {
                        setStatus('List name is required.');
                        return;
                    }

                    if (!listPickerSelectedMovie) {
                        setStatus('Select a movie first.');
                        return;
                    }

                    listPickerBusy = true;
                    setStatus('Creating list');

                    try {
                        const newList = await createUserList({ user_id: authedUser.id, list_name: name });
                        cachedListsUserId = null;

                        setStatus('Syncing movie metadata');
                        const ensuredMovieId = await ensureMovieFullySyncedForLists({
                            accessToken,
                            title: listPickerSelectedMovie.title,
                            release_year: listPickerSelectedMovie.year,
                            tmdb_id: listPickerSelectedMovie.tmdb_id,
                            movie_id: listPickerSelectedMovie.db_movie_id,
                        });

                        if (!ensuredMovieId) throw new Error('Failed to ensure movie exists.');
                        setStatus('Adding to list');
                        await addMovieToList({ user_id: authedUser.id, list_id: newList.id, movie_id: ensuredMovieId });

                        showToast('Created list and added movie!', { level: 'success' });
                        closeListPickerModal();
                    } catch (err) {
                        const msg = String(err?.message || err);
                        if (/duplicate|unique/i.test(msg)) {
                            setStatus('You already have a list with that name.');
                            return;
                        }
                        setStatus('');
                        showToast(`Create/add failed: ${msg}`, { level: 'warn' });
                    } finally {
                        listPickerBusy = false;
                    }
                }, { capture: true });
            }

            const listsCreateForm = document.getElementById('lists-create-form');
            if (listsCreateForm) {
                listsCreateForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (listsCreateBusy) return;

                    const statusEl = document.getElementById('lists-create-status');
                    const nameEl = document.getElementById('lists-create-name');
                    const setStatus = (s) => { if (statusEl) statusEl.textContent = String(s || ''); };

                    const name = normalizeListName(nameEl?.value || '');
                    if (!name) {
                        setStatus('List name is required.');
                        return;
                    }

                    let authedUser = null;
                    try {
                        const { user } = await requireAuthOrThrow();
                        authedUser = user;
                    } catch (_) {
                        setStatus('Please log in first.');
                        openAuthModal();
                        return;
                    }

                    listsCreateBusy = true;
                    setStatus('Saving');

                    try {
                        const created = await createUserList({ user_id: authedUser.id, list_name: name });
                        cachedListsUserId = null;

                        // Auto-select the newly created list.
                        if (created?.id) {
                            listsActiveListId = String(created.id);
                            listsActiveListName = String(created?.list_name || name).trim();
                        }

                        closeListsCreateModal();
                        await loadListsPage({ reset: true });
                        showToast('List created!', { level: 'success' });
                    } catch (err) {
                        const msg = String(err?.message || err);
                        if (/duplicate|unique/i.test(msg)) {
                            setStatus('You already have a list with that name.');
                            return;
                        }
                        setStatus('');
                        showToast(`Create list failed: ${msg}`, { level: 'warn' });
                    } finally {
                        listsCreateBusy = false;
                    }
                }, { capture: true });
            }

            const listsRenameForm = document.getElementById('lists-rename-form');
            if (listsRenameForm) {
                listsRenameForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (listsRenameBusy) return;

                    const lid = String(listsActiveListId || '').trim();
                    if (!lid) return;
                    if (isBucketList({ list_id: lid, list_name: listsActiveListName })) {
                        showToast('Bucket List cant be renamed.', { level: 'warn' });
                        return;
                    }

                    const statusEl = document.getElementById('lists-rename-status');
                    const nameEl = document.getElementById('lists-rename-name');
                    const setStatus = (s) => { if (statusEl) statusEl.textContent = String(s || ''); };

                    const name = normalizeListName(nameEl?.value || '');
                    if (!name) {
                        setStatus('List name is required.');
                        return;
                    }

                    if (name.toLowerCase() === 'bucket list') {
                        setStatus('That name is reserved.');
                        return;
                    }

                    if (String(listsActiveListName || '').trim() === name) {
                        closeListsRenameModal();
                        return;
                    }

                    let authedUser = null;
                    try {
                        const { user } = await requireAuthOrThrow();
                        authedUser = user;
                    } catch (_) {
                        setStatus('Please log in first.');
                        openAuthModal();
                        return;
                    }

                    listsRenameBusy = true;
                    setListsActiveListActionsEnabledState();
                    setStatus('Saving');

                    try {
                        const { data, error } = await supabaseClient
                            .from('Lists')
                            .update({ list_name: name })
                            .eq('user_id', authedUser.id)
                            .eq('id', lid)
                            .select('id, list_name')
                            .single();
                        if (error) throw error;

                        cachedListsUserId = null;
                        listsActiveListName = String(data?.list_name || name).trim();

                        closeListsRenameModal();
                        await loadListsPage({ reset: true });
                        showToast('List renamed!', { level: 'success' });
                    } catch (err) {
                        const msg = String(err?.message || err);
                        if (/duplicate|unique/i.test(msg)) {
                            setStatus('You already have a list with that name.');
                            return;
                        }
                        setStatus('');
                        showToast(`Rename failed: ${msg}`, { level: 'warn' });
                    } finally {
                        listsRenameBusy = false;
                        setListsActiveListActionsEnabledState();
                    }
                }, { capture: true });
            }
        }

        async function loadListsPage({ reset = true } = {}) {
            const elLists = document.getElementById('lists-list');
            const elItems = document.getElementById('lists-items');
            const elTitle = document.getElementById('lists-active-title');
            const elSub = document.getElementById('lists-active-subtitle');
            if (!elLists || !elItems) return;

            listsMoviePrefillById = new Map();
            listsPlatformsByMovieId = new Map();

            if (!supabaseClient || !cachedIsAuthed) {
                elLists.innerHTML = `<div class="text-gray">Log in to view your lists.</div>`;
                elItems.innerHTML = `<div class="text-gray">Log in to view your lists.</div>`;
                if (elTitle) elTitle.textContent = 'Lists';
                if (elSub) elSub.textContent = '';
                try { setListsQuickAddEnabledState(); } catch (_) {}
                return;
            }

            if (listsLoading) return;
            listsLoading = true;
            if (reset) {
                elLists.innerHTML = `<div class="text-gray">Loading</div>`;
                elItems.innerHTML = `<div class="text-gray">Loading</div>`;
            }

            try {
                const { user } = await requireAuthOrThrow();

                await ensureBucketListForUser({ user_id: user.id }).catch(() => null);
                const lists = await loadUserLists({ user_id: user.id, force: true });

                if (!listsActiveListId) {
                    listsActiveListId = cachedBucketListId || (lists[0]?.id || null);
                }

                const active = lists.find(l => String(l?.id || '') === String(listsActiveListId || '')) || null;
                listsActiveListName = String(active?.list_name || listsActiveListName || '').trim();

                // If user switches lists (especially into Bucket List), make sure we don't keep incompatible sort/filter state.
                configureListsSortFilterModalForActiveList();

                elLists.innerHTML = lists.length
                    ? `
                        <select id="lists-select" class="input-field" style="width:100%; border-radius: 0.85rem;">
                            ${lists.map((l) => {
                                const id = String(l?.id || '').trim();
                                const name = String(l?.list_name || '').trim() || 'Untitled';
                                if (!id) return '';
                                const selected = (String(listsActiveListId || '') === id) ? 'selected' : '';
                                return `<option value="${escapeHtml(id)}" ${selected}>${escapeHtml(name)}</option>`;
                            }).filter(Boolean).join('')}
                        </select>
                    `
                    : `
                        <select id="lists-select" class="input-field" style="width:100%; border-radius: 0.85rem;" disabled>
                            <option value="">No lists found</option>
                        </select>
                    `;

                if (elTitle) elTitle.textContent = listsActiveListName || 'List';
                if (elSub) {
                    ensureListsSortFilterStateInitialized();
                    const labels = {
                        sortKey: {
                            watch_date: 'Watch Date',
                            overall: 'Overall %',
                            sound: 'Sound %',
                            pace: 'Pace %',
                            imagery: 'Imagery %',
                            acting: 'Acting %',
                            plot: 'Plot %',
                            dialogue: 'Dialogue %',
                            imdb: 'IMDb %',
                            release_year: 'Release Year',
                        }
                    };
                    const model = buildSortFilterChipModel({
                        state: listsSortFilterState,
                        defaults: getDefaultListsSortFilterStateForActiveList(),
                        labels,
                    });
                    elSub.innerHTML = renderSortFilterChipsHtml({ model, namespace: 'lists' });
                }
                try { setListsQuickAddEnabledState(); } catch (_) {}
                try { setListsActiveListActionsEnabledState(); } catch (_) {}

                if (!listsActiveListId) {
                    elItems.innerHTML = `<div class="text-gray">Create a list to get started.</div>`;
                    try { setListsQuickAddEnabledState(); } catch (_) {}
                    return;
                }

                const { data: joins, error: joinErr } = await supabaseClient
                    .from('Movie Lists')
                    .select('movie_id, created_at')
                    .eq('user_id', user.id)
                    .eq('list_id', listsActiveListId)
                    .order('created_at', { ascending: false });
                if (joinErr) throw joinErr;

                const joinRows = Array.isArray(joins) ? joins : [];
                const movieIds = joinRows.map(r => r?.movie_id).filter(Boolean);
                if (movieIds.length === 0) {
                    elItems.innerHTML = `<div class="text-gray">No movies in this list yet.</div>`;
                    try { setListsQuickAddEnabledState(); } catch (_) {}
                    try { setListsActiveListActionsEnabledState(); } catch (_) {}
                    return;
                }

                const { data: movies, error: moviesErr } = await supabaseClient
                    .from('Movies')
                    .select('*')
                    .in('id', movieIds);
                if (moviesErr) throw moviesErr;

                const moviesById = new Map();
                for (const m of (Array.isArray(movies) ? movies : [])) {
                    if (m?.id) moviesById.set(m.id, m);
                }

                // Fetch genres and IMDb rating from external API for each movie (like rating/log flow)
                await Promise.allSettled(Array.from(moviesById.values()).map(async (movie) => {
                    const tmdb_id = Number(movie?.tmdb_id);
                    if (!Number.isFinite(tmdb_id) || tmdb_id <= 0) return;
                    try {
                        const details = await callSwiftApiGetMovieDetails({ tmdb_id });
                        if (details) {
                            if (Array.isArray(details.genres)) movie.genres = details.genres;
                            if (typeof details.genre === 'string') movie.genre = details.genre;
                            if (details.imdb_rating_pct !== undefined && details.imdb_rating_pct !== null) movie.imdb_rating_pct = details.imdb_rating_pct;
                        }
                    } catch (_) {}
                }));

                // Fetch user ratings for these movies (best-effort).
                const ratingsByMovieId = new Map();
                try {
                    const { data: ratings, error: ratingsErr } = await supabaseClient
                        .from('Movie Ratings')
                        .select('movie_id, overall_rating, sound_rating, pacing_rating, imagery_rating, acting_rating, plot_rating, dialogue_rating, tier')
                        .eq('user_id', user.id)
                        .in('movie_id', movieIds);
                    if (!ratingsErr) {
                        for (const r of (Array.isArray(ratings) ? ratings : [])) {
                            const mid = String(r?.movie_id || '').trim();
                            if (!mid) continue;
                            ratingsByMovieId.set(mid, r);
                        }
                    }
                } catch (_) {
                    // Ignore ratings fetch errors.
                }

                // Fetch latest watch date per movie (best-effort).
                const latestWatchByMovieId = new Map();
                try {
                    const { data: lw, error: lwErr } = await supabaseClient
                        .from('user_movie_latest_watch')
                        .select('movie_id, latest_watch_date')
                        .eq('user_id', user.id)
                        .in('movie_id', movieIds);
                    if (!lwErr) {
                        for (const r of (Array.isArray(lw) ? lw : [])) {
                            const mid = String(r?.movie_id || '').trim();
                            if (!mid) continue;
                            latestWatchByMovieId.set(mid, r?.latest_watch_date || null);
                        }
                    }
                } catch (_) {
                    // Ignore latest watch fetch errors.
                }

                // Fetch watch platforms for these movies (best-effort; do not fail page).
                const platformsByMovieId = new Map();
                try {
                    const { data: mpRows, error: mpErr } = await supabaseClient
                        .from('Movie Platforms')
                        .select('movie_id, platform_id')
                        .in('movie_id', movieIds);
                    if (!mpErr) {
                        const rows = Array.isArray(mpRows) ? mpRows : [];
                        const platformIds = Array.from(new Set(rows.map(r => r?.platform_id).filter(Boolean)));

                        let platformNameById = new Map();
                        if (platformIds.length > 0) {
                            const { data: plats, error: platsErr } = await supabaseClient
                                .from('Platforms')
                                .select('id, name')
                                .in('id', platformIds);
                            if (!platsErr) {
                                platformNameById = new Map(
                                    (Array.isArray(plats) ? plats : [])
                                        .filter(p => p?.id)
                                        .map(p => [p.id, normalizePlatformName(p?.name) || String(p?.name || '').trim()]),
                                );
                            }
                        }

                        for (const r of rows) {
                            const mid = String(r?.movie_id || '').trim();
                            const pid = r?.platform_id;
                            if (!mid || pid === null || pid === undefined) continue;
                            const pname = platformNameById.get(pid);
                            if (!pname) continue;
                            const arr = platformsByMovieId.get(mid) || [];
                            arr.push(pname);
                            platformsByMovieId.set(mid, arr);
                        }

                        // De-dupe + keep stable ordering.
                        for (const [mid, arr] of platformsByMovieId.entries()) {
                            platformsByMovieId.set(mid, uniqStrings(arr));
                        }
                    }
                } catch (_) {
                    // Ignore platform fetch errors.
                }

                // Promote to global map for the Watch Options modal.
                listsPlatformsByMovieId = platformsByMovieId;

                // Compute facets for Lists filters.
                try {
                    const decades = new Set();
                    const mpas = new Set();
                    const genres = new Set();
                    const platforms = new Set();

                    for (const id of movieIds) {
                        const movie = moviesById.get(id) || null;
                        if (!movie) continue;

                        const dec = listsDecadeLabelFromYear(movie?.release_year);
                        if (dec) decades.add(dec);

                        const mpa = normalizeMovieFieldValue(movie?.mpa_rating ?? movie?.mpa);
                        if (mpa) mpas.add(mpa);

                        for (const g of listsNormalizeGenresToArray(movie)) {
                            if (g) genres.add(g);
                        }

                        const plats = platformsByMovieId.get(String(id)) || [];
                        for (const p of plats) {
                            const name = normalizePlatformName(p);
                            if (name) platforms.add(name);
                        }
                    }

                    const decadeArr = Array.from(decades);
                    decadeArr.sort((a, b) => {
                        const an = Number(String(a).replace(/\D/g, ''));
                        const bn = Number(String(b).replace(/\D/g, ''));
                        if (Number.isFinite(an) && Number.isFinite(bn)) return bn - an;
                        return String(b).localeCompare(String(a));
                    });

                    listsFacetOptions = {
                        decades: decadeArr,
                        mpas: Array.from(mpas).sort((a, b) => a.localeCompare(b)),
                        genres: Array.from(genres).sort((a, b) => a.localeCompare(b)),
                        platforms: Array.from(platforms).sort((a, b) => a.localeCompare(b)),
                    };
                } catch (_) {
                    // Ignore facet computation errors.
                }

                ensureListsSortFilterStateInitialized();

                // Refresh subtitle now that platform facets exist.
                if (elSub) {
                    const labels = {
                        sortKey: {
                            watch_date: 'Watch Date',
                            overall: 'Overall %',
                            sound: 'Sound %',
                            pace: 'Pace %',
                            imagery: 'Imagery %',
                            acting: 'Acting %',
                            plot: 'Plot %',
                            dialogue: 'Dialogue %',
                            imdb: 'IMDb %',
                            release_year: 'Release Year',
                        }
                    };
                    const model = buildSortFilterChipModel({
                        state: listsSortFilterState,
                        defaults: getDefaultListsSortFilterStateForActiveList(),
                        labels,
                    });
                    elSub.innerHTML = renderSortFilterChipsHtml({ model, namespace: 'lists' });
                }

                const items = movieIds.map((id) => {
                    const movie = moviesById.get(id) || null;
                    const r = ratingsByMovieId.get(String(id)) || null;
                    const genresArr = listsNormalizeGenresToArray(movie);
                    return {
                        movie_id: String(id),
                        title: String(movie?.title || '').trim() || 'Untitled',
                        release_year: movie?.release_year ?? null,
                        director: normalizeMovieFieldValue(movie?.director ?? movie?.director_name),
                        mpa_rating: normalizeMovieFieldValue(movie?.mpa_rating ?? movie?.mpa),
                        genre: normalizeMovieFieldValue(movie?.genre),
                        genresArr,
                        imdb_rating_pct: movie?.imdb_rating_pct ?? movie?.imdb_pct ?? movie?.imdb_rating ?? movie?.imdb,
                        latest_watch_date: latestWatchByMovieId.get(String(id)) || null,
                        overall_rating: r?.overall_rating ?? null,
                        sound_rating: r?.sound_rating ?? null,
                        pacing_rating: r?.pacing_rating ?? null,
                        imagery_rating: r?.imagery_rating ?? null,
                        acting_rating: r?.acting_rating ?? null,
                        plot_rating: r?.plot_rating ?? null,
                        dialogue_rating: r?.dialogue_rating ?? null,
                        tier: String(r?.tier || '').trim(),
                        platforms: platformsByMovieId.get(String(id)) || [],
                    };
                });

                const visibleItems = applyListsSortFilter(items, listsSortFilterState);

                const cards = visibleItems
                    .map((it) => {
                        const id = String(it?.movie_id || '').trim();
                        const movie = moviesById.get(id) || null;
                        const title = String(movie?.title || '').trim() || 'Untitled';
                        const year = (movie?.release_year === null || movie?.release_year === undefined) ? '' : String(movie.release_year);
                        const tmdb_id = Number(movie?.tmdb_id);
                        const poster_path = String(movie?.poster_path || '').trim();
                        const posterUrl = poster_path ? `https://image.tmdb.org/t/p/w500${poster_path.startsWith('/') ? poster_path : `/${poster_path}`}` : '';

                        const directorVal = normalizeMovieFieldValue(movie?.director ?? movie?.director_name);
                        const genreVal = (() => {
                            if (Array.isArray(movie?.genres) && movie.genres.length) {
                                return normalizeMovieFieldValue(movie.genres.map(s => String(s).trim()).filter(Boolean).join(', '));
                            }
                            return normalizeMovieFieldValue(movie?.genre);
                        })();
                        const imdbVal = (() => {
                            const raw = (movie?.imdb_rating_pct ?? movie?.imdb_pct ?? movie?.imdb_rating ?? movie?.imdb);
                            const n = parsePercentLike(raw, { imdb: true });
                            return (n !== null && n !== undefined) ? formatPctForDisplay(n) : '';
                        })();

                        const mpaVal = normalizeMovieFieldValue(movie?.mpa_rating ?? movie?.mpa);

                        const metaLines = [];
                        if (directorVal) metaLines.push({ label: 'Director', value: directorVal });
                        if (genreVal) metaLines.push({ label: 'Genres', value: genreVal });
                        if (imdbVal) metaLines.push({ label: 'IMDb', value: imdbVal });

                        const platforms = platformsByMovieId.get(String(id)) || [];

                        // Cache a prefill object for poster-click navigation to the Log New Entry flow.
                        listsMoviePrefillById.set(String(id), {
                            ...(movie || {}),
                            id: String(id),
                            title,
                            year: year || null,
                            release_year: movie?.release_year ?? null,
                            director: directorVal || normalizeMovieFieldValue(movie?.director ?? movie?.director_name) || '',
                            genre: genreVal || normalizeMovieFieldValue(movie?.genre) || '',
                            imdb: imdbVal || '',
                            tmdb_id: Number.isFinite(tmdb_id) ? tmdb_id : undefined,
                            poster_path: poster_path || movie?.posterPath || movie?.poster_url || movie?.posterUrl || '',
                            mpa: String(movie?.mpa_rating ?? movie?.mpa ?? '').trim(),
                            runtime: (() => {
                                const n = Number(movie?.runtime_minutes ?? movie?.runtime);
                                return Number.isFinite(n) ? n : (movie?.runtime_minutes ?? movie?.runtime ?? null);
                            })(),
                            isSeries: (movie?.is_series ?? movie?.isSeries) === true,
                            detailsReadonly: false,
                        });

                        return `
                            <div class="lists-movie-card">
                                <button type="button" class="lists-remove-x" title="Remove from list" data-lists-action="remove_movie" data-list-id="${escapeHtml(String(listsActiveListId))}" data-movie-id="${escapeHtml(String(id))}">&times;</button>

                                <button type="button" class="lists-poster-btn" data-lists-action="open_movie" data-movie-id="${escapeHtml(String(id))}" title="Open entry" style="width:100%; max-width:220px; margin:0 auto;">
                                    <div class="lists-poster" style="width:100%; aspect-ratio:2/3; min-height:180px;">
                                        ${posterUrl
                                            ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="display:block; width:100%; height:100%; object-fit:cover;">`
                                            : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`}
                                    </div>
                                </button>

                                <div style="width:100%; display:flex; flex-direction:column; align-items:center; gap:0.32rem;">
                                    <div class="lists-title" style="margin-top:0.2rem; text-align:center;">
                                        ${escapeHtml(title)}
                                        ${year ? ` <span style=\"color:#b0b0b0; font-weight:700;\">(${escapeHtml(year)})</span>` : ''}
                                        ${mpaVal ? ` <span style=\"color:#1de9b6; font-weight:900; font-size:1.1em;\">-</span> <span style=\"color:#7c256a; background:rgba(124,37,106,0.13); border-radius:0.35em; padding:0.04em 0.38em; font-weight:800; font-size:0.98em;\">${mpaVal}</span>` : ''}
                                    </div>
                                    <div class="lists-meta-list" style="font-size:1.01rem; width:100%; max-width:320px; margin:0 auto; display:flex; flex-direction:row; align-items:center; gap:1.2em; justify-content:center;">
                                        <div class="lists-meta-item" style="gap:4px; color:rgba(255,255,255,0.82);">
                                            <span style="font-weight:700;">IMDb:</span> <span>${imdbVal || ''}</span>
                                        </div>
                                        <div class="lists-meta-item" style="gap:4px; color:rgba(255,255,255,0.82);">
                                            <span>${(() => {
                                                const n = Number(movie?.runtime_minutes ?? movie?.runtime);
                                                if (!Number.isFinite(n) || n <= 0) return '';
                                                const h = Math.floor(n / 60);
                                                const m = n % 60;
                                                let out = '';
                                                if (h > 0) out += `${h}h`;
                                                if (m > 0 || h === 0) out += `${h > 0 ? ' ' : ''}${m}m`;
                                                return out.trim();
                                            })()}</span>
                                        </div>
                                    </div>
                                    <button type="button" class="lists-watch-options-btn" data-lists-action="watch_options" data-movie-id="${escapeHtml(String(id))}" data-movie-title="${escapeHtml(title)}" style="margin:0.5rem auto 0.2rem auto; display:block;">Watch Options</button>
                                </div>
                            </div>
                        `;
                    })
                    .join('');

                elItems.innerHTML = `
                    <div class="text-xs" style="color: rgba(255,255,255,0.70); margin-bottom: 0.65rem;">Showing ${visibleItems.length} of ${movieIds.length}</div>
                    <div class="lists-grid">${cards}</div>
                `;
            } catch (err) {
                const msg = String(err?.message || err);
                elLists.innerHTML = `<div class="text-gray">Failed to load lists: ${escapeHtml(msg)}</div>`;
                elItems.innerHTML = `<div class="text-gray">Failed to load list items.</div>`;
            } finally {
                try { setListsQuickAddEnabledState(); } catch (_) {}
                listsLoading = false;
                try { setListsActiveListActionsEnabledState(); } catch (_) {}
            }
        }

        let feedBound = false;
        let feedFollowingIds = new Set();
        let feedLastSearchQuery = '';
        let feedSortMode = 'watch_date'; // 'updated_at' | 'watch_date'

        let libraryBound = false;
        let libraryOffset = 0;
        const libraryLimit = 25;
        let libraryHasMore = true;
        let libraryLoading = false;
        let libraryViewMode = 'list';
        let libraryWatchCountMax = 0;
        let libraryPendingWatchCountMaxOnly = false;

        const LIBRARY_LATEST_WATCH_VIEW = 'user_movie_latest_watch';
        const LIBRARY_ITEMS_VIEW = 'user_library_items_v2';
        let libraryItems = [];
        let libraryFacetsLoaded = false;

        // (director filter is applied via modal Save)

        function formatFeedTimestamp(ts) {
            if (!ts) return '';
            const d = new Date(ts);
            if (Number.isNaN(d.getTime())) return '';
            try {
                return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            } catch (_) {
                return String(ts);
            }
        }

        function initFeedPage() {
            if (feedBound) return;
            feedBound = true;

            document.addEventListener('click', (e) => {
                const card = e?.target?.closest ? e.target.closest('[data-feed-card]') : null;
                if (!card) return;

                // Don't toggle when clicking buttons/controls.
                const actionEl = e?.target?.closest ? e.target.closest('[data-feed-action]') : null;
                if (actionEl) return;

                card.classList.toggle('is-open');
            });

            document.addEventListener('click', async (e) => {
                const btn = e?.target?.closest ? e.target.closest('[data-feed-action]') : null;
                if (!btn) return;
                const action = String(btn.dataset.feedAction || '').trim();
                const targetUserId = String(btn.dataset.feedUserId || '').trim();
                if (!action) return;

                if (action === 'refresh') {
                    await loadFeedPage();
                    return;
                }

                if (action === 'set_sort') {
                    const mode = String(btn.dataset.feedSortMode || '').trim();
                    feedSortMode = (mode === 'watch_date') ? 'watch_date' : 'updated_at';
                    syncFeedSortUI();
                    await loadFeedItems();
                    return;
                }

                if (!supabaseClient) {
                    showToast('Supabase SDK failed to load.', { level: 'warn' });
                    return;
                }

                let authedUser = null;
                try {
                    const { user } = await requireAuthOrThrow();
                    authedUser = user;
                } catch (err) {
                    showToast(String(err?.message || err), { level: 'warn' });
                    return;
                }

                if (!targetUserId) return;
                if (targetUserId === authedUser.id) {
                    showToast('You cannot follow yourself.', { level: 'warn' });
                    return;
                }

                try {
                    if (action === 'follow') {
                        const { error } = await supabaseClient
                            .from('Follows')
                            .insert({ follower_id: authedUser.id, followed_id: targetUserId });
                        if (error) throw error;
                        showToast('Followed!', { level: 'success' });
                    }

                    if (action === 'unfollow') {
                        const { error } = await supabaseClient
                            .from('Follows')
                            .delete()
                            .eq('follower_id', authedUser.id)
                            .eq('followed_id', targetUserId);
                        if (error) throw error;
                        showToast('Unfollowed.', { level: 'success' });
                    }

                    await loadMyFollowingIds();
                    await loadFeedFollowingList();
                    await loadFeedItems();
                    if (feedLastSearchQuery) {
                        await searchFeedUsers(feedLastSearchQuery);
                    }
                } catch (err) {
                    const msg = String(err?.message || err);
                    // Common duplicate follow error
                    if (/duplicate|unique/i.test(msg)) {
                        showToast('You are already following that user.', { level: 'warn' });
                        return;
                    }
                    showToast(`Feed action failed: ${msg}`, { level: 'warn' });
                }
            }, { capture: true });
        }

        function initLibraryPage() {
            if (libraryBound) return;
            libraryBound = true;

            document.addEventListener('click', async (e) => {
                const btn = e?.target?.closest ? e.target.closest('[data-library-action]') : null;
                if (!btn) return;
                const action = String(btn.dataset.libraryAction || '').trim();
                if (!action) return;

                if (action === 'refresh') {
                    await loadLibraryPage({ reset: true });
                    return;
                }
                if (action === 'set_view') {
                    const view = String(btn.dataset.libraryView || '').trim().toLowerCase();
                    setLibraryViewMode(view);
                    return;
                }
                if (action === 'load_more') {
                    await loadLibraryMore({ replace: false });
                    return;
                }

                if (action === 'open_sort_filter') {
                    openLibrarySortFilterModal();
                    return;
                }

                if (action === 'cancel_sort_filter') {
                    closeLibrarySortFilterModal({ restoreDraft: true });
                    return;
                }

                if (action === 'reset_sort_filter_draft') {
                    ensureLibrarySortFilterStateInitialized();
                    setLibrarySortFilterModalFromState(getDefaultLibrarySortFilterState());
                    return;
                }

                if (action === 'save_sort_filter') {
                    saveLibrarySortFilterModal();
                    return;
                }

                if (action === 'clear_sort_filter_part') {
                    const part = String(btn.dataset.part || '').trim();
                    if (!clearLibrarySortFilterPart(part)) return;
                    await loadLibraryPage({ reset: true });
                    return;
                }

                if (action === 'delete_entry') {
                    const mid = String(btn.dataset.movieId || '').trim();
                    const title = String(btn.dataset.movieTitle || '').trim();
                    if (!mid) return;

                    (async () => {
                        try {
                            await openDeleteRatingModalForMovie({ movie_id: mid, title, source: 'library' });
                        } catch (err) {
                            const msg = String(err?.message || err);
                            if (/log in/i.test(msg)) {
                                openAuthModal();
                                return;
                            }
                            showToast(msg, { level: 'warn' });
                        }
                    })().catch(() => {});
                    return;
                }
            }, { capture: true });

            syncLibraryViewUI();
        }

        function setLibraryViewMode(view) {
            const next = String(view || '').trim().toLowerCase() === 'grid' ? 'grid' : 'list';
            libraryViewMode = next;
            syncLibraryViewUI();
            renderLibraryList();
        }

        function syncLibraryViewUI() {
            const wrap = document.getElementById('library-view-toggle');
            if (!wrap) return;
            wrap.querySelectorAll('[data-library-view]').forEach((btn) => {
                const isOn = String(btn.dataset.libraryView || '').trim().toLowerCase() === libraryViewMode;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
                btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
            });
        }

        function getLibraryWatchCountRangeEls() {
            return {
                rail: document.getElementById('library-watch-count-rail'),
                minLabel: document.getElementById('library-watch-count-min'),
                maxLabel: document.getElementById('library-watch-count-max'),
            };
        }

        function setLibraryWatchCountRangeUI({ minVal, maxVal, maxAvail }) {
            const els = getLibraryWatchCountRangeEls();
            if (!els.rail) return;

            const maxAvailable = Math.max(0, Number(maxAvail) || 0);
            const minV = Number.isFinite(Number(minVal)) ? Number(minVal) : 1;
            const maxV = Number.isFinite(Number(maxVal)) ? Number(maxVal) : maxAvailable || 1;

            els.rail.dataset.minVal = String(minV);
            els.rail.dataset.maxVal = String(maxV);
            els.rail.dataset.maxAvail = String(maxAvailable);

            const disabled = maxAvailable <= 0;
            els.rail.classList.toggle('is-disabled', disabled);
            if (els.minLabel) els.minLabel.textContent = disabled ? '' : String(minV);
            if (els.maxLabel) els.maxLabel.textContent = disabled ? '' : String(maxV);

            const fill = els.rail.querySelector('.library-watch-rail-fill');
            const minHandle = els.rail.querySelector('[data-handle="min"]');
            const maxHandle = els.rail.querySelector('[data-handle="max"]');
            if (!fill || !minHandle || !maxHandle || disabled) {
                if (fill) {
                    fill.style.left = '0%';
                    fill.style.right = '100%';
                }
                if (minHandle) minHandle.style.left = '0%';
                if (maxHandle) maxHandle.style.left = '100%';
                return;
            }

            const denom = Math.max(1, maxAvailable - 1);
            const minPct = ((minV - 1) / denom) * 100;
            const maxPct = ((maxV - 1) / denom) * 100;
            const left = Math.max(0, Math.min(100, minPct));
            const right = Math.max(0, Math.min(100, 100 - maxPct));
            fill.style.left = `${left}%`;
            fill.style.right = `${right}%`;
            minHandle.style.left = `${left}%`;
            maxHandle.style.left = `${maxPct}%`;
        }

        function setLibraryWatchCountRangeFromState(state) {
            const maxAvailable = Math.max(0, Number(libraryWatchCountMax) || 0);
            const minState = Number(state?.watchCountMin);
            const maxState = Number(state?.watchCountMax);
            let minVal = Number.isFinite(minState) && minState > 0 ? minState : 1;
            let maxVal = Number.isFinite(maxState) && maxState > 0 ? maxState : (maxAvailable || 1);
            if (maxAvailable > 0) {
                minVal = Math.max(1, Math.min(minVal, maxAvailable));
                maxVal = Math.max(minVal, Math.min(maxVal, maxAvailable));
            }
            setLibraryWatchCountRangeUI({ minVal, maxVal, maxAvail: maxAvailable });
        }

        function initLibraryWatchCountRange() {
            const els = getLibraryWatchCountRangeEls();
            if (!els.rail) return;
            if (els.rail.dataset.boundRange) return;
            els.rail.dataset.boundRange = 'true';

            let activeHandle = null;

            const valueFromClientX = (clientX) => {
                const maxAvailable = Math.max(0, Number(els.rail.dataset.maxAvail) || 0);
                if (maxAvailable <= 0) return 1;
                const rect = els.rail.getBoundingClientRect();
                const raw = (clientX - rect.left) / Math.max(1, rect.width);
                const pct = Math.max(0, Math.min(1, raw));
                const val = Math.round(1 + pct * Math.max(1, maxAvailable - 1));
                return Math.max(1, Math.min(maxAvailable, val));
            };

            const updateValues = (nextMin, nextMax) => {
                const maxAvailable = Math.max(0, Number(els.rail.dataset.maxAvail) || 0);
                if (maxAvailable <= 0) return;
                let minVal = Math.max(1, Math.min(nextMin, maxAvailable));
                let maxVal = Math.max(1, Math.min(nextMax, maxAvailable));
                if (minVal > maxVal) {
                    if (activeHandle === 'min') minVal = maxVal;
                    else maxVal = minVal;
                }
                setLibraryWatchCountRangeUI({ minVal, maxVal, maxAvail: maxAvailable });
            };

            const pickNearestHandle = (clientX) => {
                const minVal = Number(els.rail.dataset.minVal) || 1;
                const maxVal = Number(els.rail.dataset.maxVal) || 1;
                const targetVal = valueFromClientX(clientX);
                return Math.abs(targetVal - minVal) <= Math.abs(targetVal - maxVal) ? 'min' : 'max';
            };

            const onPointerMove = (e) => {
                if (!activeHandle) return;
                const minVal = Number(els.rail.dataset.minVal) || 1;
                const maxVal = Number(els.rail.dataset.maxVal) || 1;
                const nextVal = valueFromClientX(e.clientX);
                if (activeHandle === 'min') updateValues(nextVal, maxVal);
                else updateValues(minVal, nextVal);
            };

            const onPointerUp = () => {
                activeHandle = null;
                document.removeEventListener('pointermove', onPointerMove);
                document.removeEventListener('pointerup', onPointerUp);
            };

            els.rail.addEventListener('pointerdown', (e) => {
                if (els.rail.classList.contains('is-disabled')) return;
                const handle = e?.target?.closest ? e.target.closest('[data-handle]') : null;
                activeHandle = handle ? String(handle.dataset.handle || '').trim() : pickNearestHandle(e.clientX);
                onPointerMove(e);
                document.addEventListener('pointermove', onPointerMove);
                document.addEventListener('pointerup', onPointerUp);
            });
        }

        let librarySortFilterState = null;
        let librarySortFilterDraft = null;

        function getDefaultLibrarySortFilterState() {
            return {
                sortKey: 'watch_date',
                sortDir: 'desc',
                tier: '',
                decade: '',
                directorContains: '',
                actorContains: '',
                movieId: '',
                movieTitle: '',
                mpa: '',
                genre: '',
                watchMethod: '',
                watchCountMin: '',
                watchCountMax: '',
                timeframe: 'all_time',
            };
        }

        function ensureLibrarySortFilterStateInitialized() {
            if (!librarySortFilterState) {
                librarySortFilterState = getDefaultLibrarySortFilterState();
            }
        }

        function clearLibrarySortFilterPart(part) {
            const key = String(part || '').trim();
            if (!key) return false;
            ensureLibrarySortFilterStateInitialized();
            const def = getDefaultLibrarySortFilterState();
            const next = { ...librarySortFilterState };

            if (key === 'sort') {
                next.sortKey = def.sortKey;
                next.sortDir = def.sortDir;
            } else if (key === 'timeframe') {
                next.timeframe = def.timeframe;
            } else if (key === 'watchCount') {
                next.watchCountMin = '';
                next.watchCountMax = '';
            } else if (key === 'movieId') {
                next.movieId = '';
                next.movieTitle = '';
            } else if (Object.prototype.hasOwnProperty.call(next, key)) {
                next[key] = '';
            } else {
                return false;
            }

            librarySortFilterState = next;
            librarySortFilterDraft = null;
            return true;
        }

        function getLibrarySortFilterModalEls() {
            return {
                overlay: document.getElementById('library-sortfilter-overlay'),
                sortKey: document.getElementById('library-modal-sort-key'),
                sortDir: document.getElementById('library-modal-sort-dir'),
                tier: document.getElementById('library-modal-filter-tier'),
                decade: document.getElementById('library-modal-filter-decade'),
                director: document.getElementById('library-modal-filter-director'),
                actor: document.getElementById('library-modal-filter-actor'),
                mpa: document.getElementById('library-modal-filter-mpa'),
                genre: document.getElementById('library-modal-filter-genre'),
                watchMethod: document.getElementById('library-modal-filter-watchmethod'),
                timeframe: document.getElementById('library-modal-filter-timeframe'),
            };
        }

        function setLibrarySortFilterModalFromState(state) {
            const els = getLibrarySortFilterModalEls();
            if (!els.sortKey || !els.sortDir) return;
            els.sortKey.value = String(state?.sortKey || 'watch_date');
            els.sortDir.value = (String(state?.sortDir || 'desc') === 'asc') ? 'asc' : 'desc';
            if (els.tier) els.tier.value = String(state?.tier || '');
            if (els.decade) els.decade.value = String(state?.decade || '');
            if (els.director) els.director.value = String(state?.directorContains || '');
            if (els.actor) els.actor.value = String(state?.actorContains || '');
            if (els.mpa) els.mpa.value = String(state?.mpa || '');
            if (els.genre) els.genre.value = String(state?.genre || '');
            if (els.watchMethod) els.watchMethod.value = String(state?.watchMethod || '');
            if (els.timeframe) els.timeframe.value = String(state?.timeframe || 'all_time');
            setLibraryWatchCountRangeFromState(state || {});
        }

        function readLibrarySortFilterModalState() {
            const els = getLibrarySortFilterModalEls();
            const getVal = (el) => String(el?.value || '').trim();
            const rangeEls = getLibraryWatchCountRangeEls();
            const maxAvail = Number(rangeEls.rail?.dataset?.maxAvail ?? 0);
            const rawMin = Number(rangeEls.rail?.dataset?.minVal ?? NaN);
            const rawMax = Number(rangeEls.rail?.dataset?.maxVal ?? NaN);
            const minVal = Number.isFinite(rawMin) ? rawMin : '';
            const maxVal = Number.isFinite(rawMax) ? rawMax : '';
            const useMin = (Number.isFinite(minVal) && maxAvail > 0 && minVal > 1) ? minVal : '';
            const useMax = (Number.isFinite(maxVal) && maxAvail > 0 && maxVal < maxAvail) ? maxVal : '';
            return {
                sortKey: getVal(els.sortKey) || 'watch_date',
                sortDir: (getVal(els.sortDir) === 'asc') ? 'asc' : 'desc',
                tier: getVal(els.tier),
                decade: getVal(els.decade),
                directorContains: getVal(els.director),
                actorContains: getVal(els.actor),
                movieId: '',
                movieTitle: '',
                mpa: getVal(els.mpa),
                genre: getVal(els.genre),
                watchMethod: getVal(els.watchMethod),
                watchCountMin: useMin,
                watchCountMax: useMax,
                timeframe: getVal(els.timeframe) || 'all_time',
            };
        }

        function openLibrarySortFilterModal() {
            ensureLibrarySortFilterStateInitialized();
            const els = getLibrarySortFilterModalEls();
            if (!els.overlay) return;
            // snapshot current inputs as draft
            librarySortFilterDraft = { ...librarySortFilterState };
            loadLibraryFacets().catch(() => null);
            setLibrarySortFilterModalFromState(librarySortFilterState);
            initLibraryWatchCountRange();
            setLibraryWatchCountRangeFromState(librarySortFilterState);
            els.overlay.style.display = 'flex';
            setTimeout(() => {
                try { els.sortKey?.focus?.(); } catch (_) {}
            }, 0);
        }

        function closeLibrarySortFilterModal({ restoreDraft = false } = {}) {
            const els = getLibrarySortFilterModalEls();
            if (!els.overlay) return;
            if (restoreDraft && librarySortFilterDraft) {
                setLibrarySortFilterModalFromState(librarySortFilterDraft);
            }
            els.overlay.style.display = 'none';
        }

        function saveLibrarySortFilterModal() {
            ensureLibrarySortFilterStateInitialized();
            const next = readLibrarySortFilterModalState();
            next.movieId = String(librarySortFilterState?.movieId || '').trim();
            next.movieTitle = String(librarySortFilterState?.movieTitle || '').trim();
            librarySortFilterState = next;
            librarySortFilterDraft = null;
            closeLibrarySortFilterModal({ restoreDraft: false });
            loadLibraryPage({ reset: true }).catch(() => null);
        }

        function renderLibraryList() {
            const elList = document.getElementById('library-list');
            const elMeta = document.getElementById('library-meta');
            const wrap = document.getElementById('library-load-more-wrap');
            if (!elList) return;

            const isGrid = String(libraryViewMode || '').trim().toLowerCase() === 'grid';
            elList.style.display = isGrid ? 'block' : 'grid';
            elList.style.gap = '12px';

            const shown = Array.isArray(libraryItems) ? libraryItems.length : 0;
            const slice = Array.isArray(libraryItems) ? libraryItems : [];

            const formatIsoDateLabel = (iso) => {
                const raw = String(iso || '').trim();
                if (!raw) return '';
                const d = new Date(raw.includes('T') ? raw : `${raw}T00:00:00`);
                if (Number.isNaN(d.getTime())) return raw;
                try {
                    return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                } catch (_) {
                    return raw;
                }
            };

            const html = slice.map((it) => {
                const movie_id = String(it?.movie_id || '').trim();
                const title = String(it?.title || '').trim() || 'Untitled';
                const year = (it?.release_year === null || it?.release_year === undefined) ? '' : String(it.release_year);
                const poster_path = String(it?.poster_path || '').trim();
                const posterUrl = poster_path ? `https://image.tmdb.org/t/p/w342${poster_path.startsWith('/') ? poster_path : `/${poster_path}`}` : '';

                const tierLabel = dashNormalizeTierLabel(it?.tier);

                if (isGrid) {
                    const overallGrid = dashFormatScore(it?.overall_rating);
                    const watchCountRaw = Number(it?.watch_count ?? 0);
                    const watchCount = Number.isFinite(watchCountRaw) ? watchCountRaw : 0;
                    const metaParts = [];
                    if (overallGrid) metaParts.push(dashRenderHelpScore(overallGrid));
                    if (tierLabel) metaParts.push(dashRenderHelpTier(tierLabel));
                    if (watchCount > 0) metaParts.push(`<span class="text-gray">${watchCount} Times</span>`);
                    return `
                        <div class="dash-kpi-movie-card">
                            <div class="dash-kpi-movie-poster">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.closest('div')?.remove?.()">`
                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`
                                }
                            </div>
                            <div class="library-grid-title text-sm text-white">${escapeHtml(title)}${year ? ` <span class="library-grid-year">(${escapeHtml(year)})</span>` : ''}</div>
                            <div class="library-grid-meta tabular-nums">${metaParts.join(' - ')}</div>
                        </div>
                    `;
                }

                const overall = dashFormatScoreWhole(it?.overall_rating);
                const quote = String(it?.fav_quote ?? '').trim();
                const notes = String(it?.notes ?? '').trim();

                const mostRecentLabel = formatIsoDateLabel(it?.latest_watch_date);

                const runtimeRaw = (it?.runtime_minutes ?? it?.runtime);
                const runtimeVal = (() => {
                    const v = normalizeMovieFieldValue(runtimeRaw);
                    if (!v) return '';
                    const n = Number(v);
                    if (Number.isFinite(n) && n > 0) return `${Math.round(n)} min`;
                    return /min/i.test(v) ? v : v;
                })();
                const mpaVal = normalizeMovieFieldValue(it?.mpa_rating ?? it?.mpa);
                const directorVal = normalizeMovieFieldValue(it?.director);
                const genreVal = normalizeMovieFieldValue(it?.genre);
                const imdbVal = (() => {
                    const raw = (it?.imdb_rating_pct ?? it?.imdb_pct ?? it?.imdb_rating ?? it?.imdb);
                    const n2 = parsePercentLike(raw, { imdb: true });
                    if (n2 !== null && n2 !== undefined) return formatPctForDisplay(n2);
                    return '';
                })();

                const ratingChips = [
                    overall ? dashRenderHelpScore(overall) : '',
                    tierLabel ? dashRenderHelpTier(tierLabel) : '',
                ].join('');

                const subRatingRows = [
                    { k: 'Sound', v: dashFormatScoreWhole(it?.sound_rating) },
                    { k: 'Pace', v: dashFormatScoreWhole(it?.pacing_rating) },
                    { k: 'Imagery', v: dashFormatScoreWhole(it?.imagery_rating) },
                    { k: 'Acting', v: dashFormatScoreWhole(it?.acting_rating) },
                    { k: 'Plot', v: dashFormatScoreWhole(it?.plot_rating) },
                    { k: 'Dialogue', v: dashFormatScoreWhole(it?.dialogue_rating) },
                ].filter(x => String(x.v || '').trim());

                const extraMovieChips = renderLibraryInfoChips(it || {}, {
                    blacklist: [
                        // Identity / paging
                        'id', 'user_id', 'movie_id', 'latest_watch_date',

                        // Already shown elsewhere on the card
                        'title', 'release_year', 'tmdb_id', 'imdb_id',
                        'genre', 'genres', 'director', 'director_name',
                        'runtime', 'runtime_minutes', 'mpa', 'mpa_rating', 'is_series',
                        'imdb', 'imdb_rating', 'imdb_pct', 'imdb_rating_pct',

                        // Ratings + tier are already rendered as chips/subchips
                        'overall_rating', 'tier',
                        'sound_rating', 'pacing_rating', 'imagery_rating', 'acting_rating', 'plot_rating', 'dialogue_rating',

                        // Notes/quote already have dedicated sections
                        'fav_quote', 'notes',

                        // Misc
                        'poster_path', 'posterPath', 'poster_url', 'posterUrl',
                        'created_at', 'updated_at',
                    ],
                });

                const posterBackDetailsHtml = (() => {
                    const lines = [];
                    const genreBackHtml = (() => {
                        const raw = String(genreVal || '').trim();
                        if (!raw) return '';
                        const parts = raw
                            .split(/[,|;]/g)
                            .map(s => String(s).trim())
                            .filter(Boolean);
                        if (!parts.length) return '';
                        return parts.map(p => escapeHtml(p)).join('<br>');
                    })();
                    if (runtimeVal) lines.push(`<div class="library-poster-back-line"><span class="library-poster-back-key">Runtime</span><span class="library-poster-back-val">${escapeHtml(runtimeVal)}</span></div>`);
                    if (mpaVal) lines.push(`<div class="library-poster-back-line"><span class="library-poster-back-key">MPA</span><span class="library-poster-back-val">${escapeHtml(mpaVal)}</span></div>`);
                    if (genreBackHtml) lines.push(`<div class="library-poster-back-line"><span class="library-poster-back-key">Genre</span><span class="library-poster-back-val">${genreBackHtml}</span></div>`);
                    if (imdbVal) lines.push(`<div class="library-poster-back-line"><span class="library-poster-back-key">IMDb</span><span class="library-poster-back-val">${escapeHtml(imdbVal)}</span></div>`);
                    return lines.join('');
                })();

                return `
                    <div class="glass-panel" style="padding: 0.9rem; border-radius: 1rem;">
                        <div class="library-card-row">
                            <div class="library-card-left">
                                <div class="library-card-poster">
                                    <div class="library-poster-flip">
                                        <div class="library-poster-flip-inner">
                                            <div class="library-poster-face library-poster-front">
                                                ${posterUrl
                                                    ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width:100%; height:100%; object-fit: cover; display:block;" onerror="this.style.display='none';">`
                                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`}
                                            </div>
                                            <div class="library-poster-face library-poster-back">
                                                ${posterBackDetailsHtml || `<div class="text-xs text-gray" style="text-align:center;">No details</div>`}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="library-under">
                                    ${mostRecentLabel
                                        ? `<div class="text-xs text-gray tabular-nums" style="margin-top: 0.55rem;">Most Recent Watch: ${escapeHtml(mostRecentLabel)}</div>`
                                        : ''
                                    }
                                </div>
                            </div>

                            <div class="feed-card-main">
                                <div class="text-white font-bold" style="white-space: normal; overflow: hidden;">
                                    <span class="library-title-line">${escapeHtml(title)}${year ? ` <span style="color: rgba(255,255,255,0.65); font-weight: 800;">(${escapeHtml(year)})</span>` : ''}</span>
                                    ${(directorVal || mpaVal)
                                        ? `<span class="library-title-meta">${directorVal ? `<span class="library-title-sep">  </span>${escapeHtml(directorVal)}` : ''}${mpaVal ? `<span class="library-title-sep">  </span>${escapeHtml(mpaVal)}` : ''}</span>`
                                        : ''}
                                </div>

                                ${(overall || tierLabel)
                                    ? `<div class="feed-metrics">${ratingChips}</div>`
                                    : `<div class="text-xs text-gray" style="margin-top: 0.25rem;">No rating yet</div>`
                                }

                                ${movie_id ? `
                                    <div style="margin-top: 0.65rem; display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                        <button
                                            type="button"
                                            class="btn btn-outline"
                                            data-library-action="delete_entry"
                                            data-movie-id="${escapeHtml(movie_id)}"
                                            data-movie-title="${escapeHtml(title)}"
                                            style="border-radius: 0.85rem; padding: 0.5rem 0.75rem; border-color: rgba(239,68,68,0.55); color: rgba(239,68,68,0.95); background: rgba(239,68,68,0.10);"
                                            title="Delete rating and/or watch logs"
                                        >Delete</button>
                                    </div>
                                ` : ''}

                                <div class="library-chip-row library-subratings" style="margin-top: 0.6rem;">
                                    ${subRatingRows.map(d => `<span class=\"dash-quote-pill\">${escapeHtml(d.k)}: ${escapeHtml(d.v)}</span>`).join('')}
                                </div>

                                ${String(extraMovieChips || '').trim()
                                    ? `<div class="library-chip-row" style="margin-top: 0.55rem;">${extraMovieChips}</div>`
                                    : ''
                                }

                                ${quote ? `
                                    <div style="margin-top: 0.75rem;">
                                        <div class="text-xs text-gray" style="margin-bottom: 0.25rem;">Favorite Quote</div>
                                        <div class="text-white" style="line-height: 1.4;">${escapeHtml(quote)}</div>
                                    </div>
                                ` : ''}
                                ${notes ? `
                                    <div style="margin-top: 0.75rem;">
                                        <div class="text-xs text-gray" style="margin-bottom: 0.25rem;">Notes</div>
                                        <div class="text-white" style="line-height: 1.4; white-space: pre-wrap;">${escapeHtml(notes)}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (isGrid) {
                elList.innerHTML = html
                    ? `<div class="dash-kpi-movie-grid library-movie-grid">${html}</div>`
                    : `<div class="text-gray">No watched movies found yet.</div>`;
            } else {
                elList.innerHTML = html || `<div class="text-gray">No watched movies found yet.</div>`;
            }

            syncLibraryViewUI();

            if (elMeta) {
                ensureLibrarySortFilterStateInitialized();
                const labels = {
                    sortKey: {
                        watch_date: 'Watch Date',
                        overall: 'Overall %',
                        sound: 'Sound %',
                        pace: 'Pace %',
                        imagery: 'Imagery %',
                        acting: 'Acting %',
                        plot: 'Plot %',
                        dialogue: 'Dialogue %',
                        imdb: 'IMDb %',
                        release_year: 'Release Year',
                    }
                };
                const model = buildSortFilterChipModel({
                    state: librarySortFilterState,
                    defaults: getDefaultLibrarySortFilterState(),
                    labels,
                });
                const top = `Showing ${shown}${libraryHasMore ? '  Load more to continue' : ''}`;
                const chipsHtml = renderSortFilterChipsHtml({ model, namespace: 'library' });
                elMeta.innerHTML = `
                    <div>${escapeHtml(top)}</div>
                    <div style="margin-top: 0.35rem; color: rgba(255,255,255,0.72);">${chipsHtml}</div>
                `;

                const openBtn = document.getElementById('library-open-sortfilter');
                if (openBtn) {
                    openBtn.title = model?.summaryText || '';
                    if (model?.isDefault) {
                        openBtn.style.borderColor = '';
                        openBtn.style.background = '';
                    } else {
                        openBtn.style.borderColor = 'rgba(20, 184, 166, 0.65)';
                        openBtn.style.background = 'rgba(20, 184, 166, 0.12)';
                    }
                }
            }
            if (wrap) wrap.style.display = libraryHasMore ? 'flex' : 'none';
        }

        async function loadLibraryFacets() {
            if (libraryFacetsLoaded) return;
            if (!supabaseClient || !cachedIsAuthed) return;

            const decadeEl = document.getElementById('library-modal-filter-decade');
            const mpaEl = document.getElementById('library-modal-filter-mpa');
            const genreEl = document.getElementById('library-modal-filter-genre');
            const timeframeEl = document.getElementById('library-modal-filter-timeframe');
            if (!decadeEl || !mpaEl || !genreEl) return;

            let authedUser = null;
            try {
                const { user } = await requireAuthOrThrow();
                authedUser = user;
            } catch (_) {
                return;
            }

            try {
                // Grab a capped sample to populate dropdowns without loading the full dataset.
                const { data, error } = await supabaseClient
                    .from(LIBRARY_ITEMS_VIEW)
                    .select('release_year, mpa_rating, genres, genre, latest_watch_date, user_id')
                    .eq('user_id', authedUser.id)
                    .range(0, 999);
                if (error) throw error;
                const rows = Array.isArray(data) ? data : [];

                const decades = new Set();
                const mpas = new Set();
                const genres = new Set();
                const months = new Set();
                for (const r of rows) {
                    const y = Number(r?.release_year);
                    if (Number.isFinite(y) && y > 0) decades.add(Math.floor(y / 10) * 10);
                    const mpa = String(r?.mpa_rating || '').trim();
                    if (mpa) mpas.add(mpa);
                    const arr = Array.isArray(r?.genres) ? r.genres : [];
                    for (const g of arr) {
                        const s = String(g || '').trim();
                        if (s) genres.add(s);
                    }
                    const rawGenre = String(r?.genre || '').trim();
                    if (rawGenre) {
                        rawGenre.split(/[,|;]/g).map(s => String(s).trim()).filter(Boolean).forEach(g => genres.add(g));
                    }

                    const watchRaw = String(r?.latest_watch_date || '').trim();
                    if (watchRaw) {
                        const d = new Date(watchRaw.includes('T') ? watchRaw : `${watchRaw}T00:00:00`);
                        if (!Number.isNaN(d.getTime())) {
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const key = `${d.getFullYear()}-${month}`;
                            months.add(key);
                        }
                    }
                }

                const sortedDecades = Array.from(decades).filter(Number.isFinite).sort((a, b) => b - a);
                const sortedMpas = Array.from(mpas).sort((a, b) => a.localeCompare(b));
                const sortedGenres = Array.from(genres).sort((a, b) => a.localeCompare(b));
                const sortedMonths = Array.from(months).sort((a, b) => b.localeCompare(a));

                let maxWatchCount = 0;
                try {
                    const { data: wcRows, error: wcError } = await supabaseClient
                        .from(LIBRARY_ITEMS_VIEW)
                        .select('watch_count')
                        .eq('user_id', authedUser.id)
                        .order('watch_count', { ascending: false, nullsFirst: false })
                        .range(0, 0);
                    if (!wcError) {
                        const raw = Number(wcRows?.[0]?.watch_count ?? 0);
                        maxWatchCount = Number.isFinite(raw) ? raw : 0;
                    }
                } catch (_) {
                    maxWatchCount = 0;
                }
                libraryWatchCountMax = Math.max(0, maxWatchCount);

                const keep = {
                    decade: String(decadeEl.value || ''),
                    mpa: String(mpaEl.value || ''),
                    genre: String(genreEl.value || ''),
                    timeframe: String(timeframeEl?.value || ''),
                };

                decadeEl.innerHTML = `<option value="">Release Decade (All)</option>` +
                    sortedDecades.map(d => `<option value="${escapeHtml(String(d))}">${escapeHtml(String(d))}s</option>`).join('');
                mpaEl.innerHTML = `<option value="">MPA (All)</option>` +
                    sortedMpas.map(v => `<option value="${escapeHtml(String(v))}">${escapeHtml(String(v))}</option>`).join('');
                genreEl.innerHTML = `<option value="">Genre (All)</option>` +
                    sortedGenres.map(v => `<option value="${escapeHtml(String(v))}">${escapeHtml(String(v))}</option>`).join('');

                if (timeframeEl) {
                    const monthOptions = sortedMonths.map((m) => {
                        const parts = m.split('-');
                        const year = Number(parts[0]);
                        const month = Number(parts[1]);
                        const labelDate = Number.isFinite(year) && Number.isFinite(month)
                            ? new Date(year, month - 1, 1)
                            : null;
                        const label = labelDate
                            ? labelDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long' })
                            : m;
                        return `<option value="${escapeHtml(m)}">${escapeHtml(label)}</option>`;
                    }).join('');

                    timeframeEl.innerHTML = `
                        <option value="all_time">Watch Date (All Time)</option>
                        <option value="this_year">Watch Date (This Year)</option>
                        <option value="this_month">Watch Date (This Month)</option>
                        ${monthOptions}
                    `;
                }

                decadeEl.value = keep.decade;
                mpaEl.value = keep.mpa;
                genreEl.value = keep.genre;
                if (timeframeEl) timeframeEl.value = keep.timeframe || 'all_time';
                setLibraryWatchCountRangeFromState(librarySortFilterState || {});
                libraryFacetsLoaded = true;
            } catch (_) {
                // Keep defaults; do not block modal.
            }
        }

        async function loadLibraryWatchCountMaxForUser(userId) {
            if (!supabaseClient || !userId) return 0;
            try {
                const { data, error } = await supabaseClient
                    .from(LIBRARY_ITEMS_VIEW)
                    .select('watch_count')
                    .eq('user_id', userId)
                    .order('watch_count', { ascending: false, nullsFirst: false })
                    .range(0, 0);
                if (error) return 0;
                const raw = Number(data?.[0]?.watch_count ?? 0);
                return Number.isFinite(raw) ? raw : 0;
            } catch (_) {
                return 0;
            }
        }

        function normalizeMovieFieldValue(v) {
            if (v === null || v === undefined) return '';
            if (typeof v === 'boolean') return v ? 'Yes' : 'No';
            if (typeof v === 'number') return Number.isFinite(v) ? String(v) : '';
            return String(v).trim();
        }

        function parsePercentLike(raw, { imdb = false } = {}) {
            if (raw === null || raw === undefined) return null;
            if (typeof raw === 'number') {
                if (!Number.isFinite(raw)) return null;
                if (imdb && raw <= 10) return raw * 10;
                return raw;
            }
            const s = String(raw).trim();
            if (!s) return null;
            const m = s.match(/([0-9]+(?:\.[0-9]+)?)/);
            if (!m) return null;
            const n = Number(m[1]);
            if (!Number.isFinite(n)) return null;
            if (imdb && n <= 10) return n * 10;
            return n;
        }

        function formatPctForDisplay(pct) {
            const n = Number(pct);
            if (!Number.isFinite(n)) return '';
            const v = String(dashFormatScore(n) || '').trim();
            if (!v) return '';
            return /%\s*$/.test(v) ? v : `${v}%`;
        }

        function getAnyStringField(row, { preferKeys = [], avoidKeysRe = null } = {}) {
            if (!row || typeof row !== 'object') return '';
            const avoid = avoidKeysRe instanceof RegExp ? avoidKeysRe : null;
            for (const k of preferKeys) {
                const v = row?.[k];
                if (typeof v === 'string' && v.trim()) return v.trim();
            }
            for (const [k, v] of Object.entries(row)) {
                if (avoid && avoid.test(k)) continue;
                if (typeof v === 'string' && v.trim()) return v.trim();
            }
            return '';
        }

        function getMovieIdFromAnyRow(r) {
            if (!r || typeof r !== 'object') return '';
            const candidates = [
                r?.movie_id,
                r?.movieId,
                r?.movie_uuid,
                r?.movieUuid,
                r?.movie,
                r?.movieID,
            ];
            for (const c of candidates) {
                const s = String(c ?? '').trim();
                if (s) return s;
            }
            return '';
        }

        async function selectAllFromFirstAvailableTable(tableNames, idCandidates, ids) {
            const tables = Array.isArray(tableNames) ? tableNames : [];
            const cols = Array.isArray(idCandidates) ? idCandidates : [];
            let lastErr = null;

            for (const table of tables) {
                for (const col of cols) {
                    try {
                        const { data, error } = await supabaseClient
                            .from(table)
                            .select('*')
                            .in(col, ids);
                        if (error) throw error;
                        return data;
                    } catch (err) {
                        lastErr = err;
                        const msg = String(err?.message || err);
                        // Try next table/column on common schema mismatches.
                        if (/relation\s+"?.+"?\s+does\s+not\s+exist/i.test(msg)) continue;
                        if (/column\s+"?.+"?\s+does\s+not\s+exist/i.test(msg)) continue;
                        // Otherwise bubble up.
                        throw err;
                    }
                }
            }

            if (lastErr) throw lastErr;
            return null;
        }

        async function loadLibraryHydratedGenreDirectorImdb({ movieIds }) {
            const genresByMovieId = new Map();
            const directorByMovieId = new Map();
            const imdbPctByMovieId = new Map();
            const ids = Array.isArray(movieIds) ? movieIds : [];
            if (!supabaseClient || ids.length === 0) {
                return { genresByMovieId, directorByMovieId, imdbPctByMovieId };
            }

            // Genres
            try {
                const genreRows = await selectAllFromFirstAvailableTable(
                    ['Movies Genres', 'Movie Genres', 'Movies_Genres', 'movie_genres', 'movies_genres'],
                    ['movie_id', 'movieId', 'movie_uuid', 'movieUuid'],
                    ids
                );
                const rows = Array.isArray(genreRows) ? genreRows : [];
                for (const r of rows) {
                    const mid = getMovieIdFromAnyRow(r);
                    if (!mid) continue;
                    const g = getAnyStringField(r, {
                        preferKeys: ['genre', 'genre_name', 'name', 'genreName', 'genre_title', 'title'],
                        avoidKeysRe: /(id|uuid|created|updated|tmdb|imdb)/i,
                    });
                    if (!g) continue;
                    const arr = genresByMovieId.get(mid) || [];
                    if (!arr.includes(g)) arr.push(g);
                    genresByMovieId.set(mid, arr);
                }
            } catch (_) {}

            // Directors (from crew)
            try {
                const crewRows = await selectAllFromFirstAvailableTable(
                    ['Movie Crew', 'Movie Crew Table', 'Movies Crew', 'movie_crew', 'movies_crew'],
                    ['movie_id', 'movieId', 'movie_uuid', 'movieUuid'],
                    ids
                );
                const rows = Array.isArray(crewRows) ? crewRows : [];
                for (const r of rows) {
                    const mid = getMovieIdFromAnyRow(r);
                    if (!mid || directorByMovieId.has(mid)) continue;
                    const job = String(r?.job ?? r?.role ?? r?.credit_job ?? r?.job_name ?? r?.job_title ?? r?.position ?? '').trim();
                    const dept = String(r?.department ?? r?.dept ?? r?.known_for_department ?? '').trim();
                    const isDirector = (r?.is_director === true) || /director/i.test(job) || (/directing/i.test(dept) && (!job || /director/i.test(job)));
                    if (!isDirector) continue;
                    const name = getAnyStringField(r, {
                        preferKeys: ['name', 'person_name', 'crew_name', 'full_name', 'display_name', 'person'],
                        avoidKeysRe: /(movie|job|role|department|dept|id|uuid|created|updated)/i,
                    });
                    if (!name) continue;
                    directorByMovieId.set(mid, name);
                }
            } catch (_) {}

            // IMDb (external ratings)
            try {
                const extRows = await selectAllFromFirstAvailableTable(
                    ['Movie External Ratings', 'Movies External Ratings', 'movie_external_ratings', 'movies_external_ratings'],
                    ['movie_id', 'movieId', 'movie_uuid', 'movieUuid'],
                    ids
                );
                const rows = Array.isArray(extRows) ? extRows : [];
                for (const r of rows) {
                    const mid = getMovieIdFromAnyRow(r);
                    if (!mid) continue;

                    // Common schema: a single row per movie with imdb_rating_pct
                    const directPct = parsePercentLike(r?.imdb_rating_pct ?? r?.imdbPct ?? r?.imdb_rating ?? r?.imdb, { imdb: true });
                    if (directPct !== null && directPct !== undefined) {
                        imdbPctByMovieId.set(mid, directPct);
                        continue;
                    }

                    // Multi-source schema: provider/source + rating
                    const provider = String(r?.provider ?? r?.source ?? r?.site ?? r?.rating_source ?? r?.type ?? '').trim().toLowerCase();
                    if (provider && !provider.includes('imdb')) continue;
                    const pct = parsePercentLike(r?.rating_pct ?? r?.ratingPercent ?? r?.percent ?? r?.score_pct ?? r?.scorePercent ?? r?.score ?? r?.rating, { imdb: true });
                    if (pct !== null && pct !== undefined) {
                        imdbPctByMovieId.set(mid, pct);
                    }
                }
            } catch (_) {}

            return { genresByMovieId, directorByMovieId, imdbPctByMovieId };
        }

        async function loadLibraryTmdbFallbackForMovies({ movieIds, moviesById, genresByMovieId, directorByMovieId }) {
            if (!Array.isArray(movieIds) || movieIds.length === 0) return;

            // Build a list of tmdb_ids we still need details for.
            const needs = [];
            for (const id of movieIds) {
                const m = moviesById.get(id) || null;
                const mid = String(m?.id || id || '').trim();
                if (!mid) continue;

                const hasGenre = (() => {
                    const arr = genresByMovieId.get(mid);
                    if (Array.isArray(arr) && arr.length) return true;
                    if (Array.isArray(m?.genres) && m.genres.length) return true;
                    return Boolean(String(m?.genre ?? '').trim());
                })();
                const hasDirector = (() => {
                    if (directorByMovieId.has(mid)) return true;
                    return Boolean(String(m?.director ?? m?.director_name ?? '').trim());
                })();

                if (hasGenre && hasDirector) continue;
                const tmdb = Number(m?.tmdb_id);
                if (!Number.isFinite(tmdb) || tmdb <= 0) continue;
                needs.push({ mid, tmdb, needGenre: !hasGenre, needDirector: !hasDirector });
            }

            if (needs.length === 0) return;

            // De-dupe by tmdb_id (1:1 in your schema, but safe).
            const byTmdb = new Map();
            for (const n of needs) {
                const prev = byTmdb.get(n.tmdb) || { tmdb: n.tmdb, movieIds: [], needGenre: false, needDirector: false };
                prev.movieIds.push(n.mid);
                prev.needGenre = prev.needGenre || n.needGenre;
                prev.needDirector = prev.needDirector || n.needDirector;
                byTmdb.set(n.tmdb, prev);
            }

            const items = Array.from(byTmdb.values());
            const concurrency = 4;
            for (let i = 0; i < items.length; i += concurrency) {
                const chunk = items.slice(i, i + concurrency);
                await Promise.allSettled(chunk.map(async (it) => {
                    try {
                        const details = await callSwiftApiGetMovieDetails({ tmdb_id: it.tmdb });
                        const genres = Array.isArray(details?.genres)
                            ? details.genres.map(s => String(s).trim()).filter(Boolean)
                            : (String(details?.genre || '').trim() ? [String(details.genre).trim()] : []);
                        const director = String(details?.director || '').trim();

                        for (const mid of it.movieIds) {
                            if (it.needGenre && genres.length) {
                                genresByMovieId.set(mid, genres);
                            }
                            if (it.needDirector && director) {
                                directorByMovieId.set(mid, director);
                            }
                        }
                    } catch (_) {
                        // ignore
                    }
                }));
            }
        }

        function renderLibraryInfoChips(obj, opts = {}) {
            const blacklist = Array.isArray(opts.blacklist) ? opts.blacklist : [];
            const order = Array.isArray(opts.order) ? opts.order : [];
            const max = Number.isFinite(opts.max) ? Number(opts.max) : 0;

            const keys = Object.keys(obj || {});
            const filtered = keys
                .filter(k => !blacklist.includes(k))
                .filter(k => !/(cast|crew|actor|actress|writers?|producers?)/i.test(k));

            const orderedKeys = [];
            for (const k of order) {
                if (filtered.includes(k)) orderedKeys.push(k);
            }
            for (const k of filtered) {
                if (!orderedKeys.includes(k)) orderedKeys.push(k);
            }

            const chips = [];
            for (const k of orderedKeys) {
                const raw = obj?.[k];
                if (raw === null || raw === undefined) continue;
                if (typeof raw === 'object') continue;
                const v = normalizeMovieFieldValue(raw);
                if (!v) continue;
                chips.push(`<span class="dash-quote-pill">${escapeHtml(k)}: ${escapeHtml(v)}</span>`);
                if (max > 0 && chips.length >= max) break;
            }
            return chips.join('');
        }

        async function loadLibraryPage({ reset = true } = {}) {
            const elList = document.getElementById('library-list');
            const elMeta = document.getElementById('library-meta');
            const wrap = document.getElementById('library-load-more-wrap');
            if (!elList) return;

            if (!supabaseClient || !cachedIsAuthed) {
                elList.innerHTML = `<div class="text-gray">Log in to view your movies.</div>`;
                if (elMeta) elMeta.textContent = '';
                if (wrap) wrap.style.display = 'none';
                return;
            }

            if (reset) {
                libraryOffset = 0;
                libraryHasMore = true;
                libraryLoading = false;
                libraryItems = [];
                elList.innerHTML = `<div class="text-gray">Loading</div>`;
                if (wrap) wrap.style.display = 'none';
            }

            await loadLibraryMore({ replace: true });
        }

        function libraryBuildServerQuery({ userId, offset, limit }) {
            ensureLibrarySortFilterStateInitialized();
            const state = librarySortFilterState;

            const sortKey = String(state?.sortKey || 'watch_date');
            const sortDir = (String(state?.sortDir || 'desc') === 'asc') ? 'asc' : 'desc';

            let q = supabaseClient
                .from(LIBRARY_ITEMS_VIEW)
                .select('user_id, movie_id, latest_watch_date, title, release_year, tmdb_id, poster_path, mpa_rating, runtime_minutes, director, actors, genres, genre, imdb_rating_pct, imdb_pct, imdb_rating, overall_rating, tier, fav_quote, notes, sound_rating, pacing_rating, imagery_rating, acting_rating, plot_rating, dialogue_rating, watch_count, watch_method')
                .eq('user_id', userId);

            const range = libraryComputeTimeframeRange(state?.timeframe);
            if (range?.start_date && range?.end_date) {
                q = q.gte('latest_watch_date', range.start_date).lt('latest_watch_date', range.end_date);
            }

            // Filters
            const tierWanted = String(state?.tier || '').trim();
            if (tierWanted) {
                if (tierWanted === 'UNRANKED') {
                    // null/empty or an explicit 'Unranked' value
                    q = q.or('tier.is.null,tier.eq.,tier.eq.UNRANKED,tier.eq.Unranked');
                } else {
                    q = q.eq('tier', tierWanted);
                }
            }

            const decadeWanted = String(state?.decade || '').trim();
            if (decadeWanted) {
                const d = Number(decadeWanted);
                if (Number.isFinite(d)) {
                    q = q.gte('release_year', d).lte('release_year', d + 9);
                }
            }

            const directorNeedle = String(state?.directorContains || '').trim();
            if (directorNeedle) {
                q = q.ilike('director', `%${directorNeedle}%`);
            }

            const actorNeedle = String(state?.actorContains || '').trim();
            if (actorNeedle) {
                q = q.ilike('actors', `%${actorNeedle}%`);
            }

            const movieId = String(state?.movieId || '').trim();
            if (movieId) {
                q = q.eq('movie_id', movieId);
            }

            const watchMethod = String(state?.watchMethod || '').trim();
            if (watchMethod) {
                const needle = watchMethod.toLowerCase().includes('theater')
                    ? '%theater%'
                    : (watchMethod.toLowerCase().includes('home') ? '%home%' : watchMethod);
                q = q.ilike('watch_method', needle);
            }

            const watchMinStr = String(state?.watchCountMin || '').trim();
            const watchMaxStr = String(state?.watchCountMax || '').trim();
            const watchMinVal = watchMinStr ? Number(watchMinStr) : null;
            const watchMaxVal = watchMaxStr ? Number(watchMaxStr) : null;
            const watchMin = Number.isFinite(watchMinVal) && watchMinVal > 0 ? watchMinVal : null;
            const watchMax = Number.isFinite(watchMaxVal) && watchMaxVal > 0 ? watchMaxVal : null;
            if (watchMin !== null) q = q.gte('watch_count', watchMin);
            if (watchMax !== null) q = q.lte('watch_count', watchMax);

            const mpaWanted = String(state?.mpa || '').trim();
            if (mpaWanted) {
                // stored as raw label (e.g. PG-13)
                q = q.ilike('mpa_rating', mpaWanted);
            }

            const genreWanted = String(state?.genre || '').trim();
            if (genreWanted) {
                // Try array first; if the column isn't an array this will error and be handled by caller.
                q = q.contains('genres', [genreWanted]);
            }

            // Sorting
            const asc = (sortDir === 'asc');
            const addOrder = (col) => q.order(col, { ascending: asc, nullsFirst: false }).order('movie_id', { ascending: true });

            if (sortKey === 'watch_date') addOrder('latest_watch_date');
            else if (sortKey === 'release_year') addOrder('release_year');
            else if (sortKey === 'imdb') addOrder('imdb_rating_pct');
            else if (sortKey === 'overall') addOrder('overall_rating');
            else if (sortKey === 'watch_count') addOrder('watch_count');
            else if (sortKey === 'sound') addOrder('sound_rating');
            else if (sortKey === 'pace') addOrder('pacing_rating');
            else if (sortKey === 'imagery') addOrder('imagery_rating');
            else if (sortKey === 'acting') addOrder('acting_rating');
            else if (sortKey === 'plot') addOrder('plot_rating');
            else if (sortKey === 'dialogue') addOrder('dialogue_rating');
            else addOrder('latest_watch_date');

            // Pagination (+1 to detect hasMore)
            q = q.range(offset, offset + limit);
            return q;
        }

        function libraryComputeTimeframeRange(timeframe) {
            const tf = String(timeframe || 'all_time').trim().toLowerCase();
            if (tf === 'all_time') return null;

            const now = new Date();
            if (tf === 'this_year') {
                const start = new Date(now.getFullYear(), 0, 1);
                const end = new Date(now.getFullYear() + 1, 0, 1);
                return { start_date: getLocalISODate(start), end_date: getLocalISODate(end) };
            }
            if (tf === 'this_month') {
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                const end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                return { start_date: getLocalISODate(start), end_date: getLocalISODate(end) };
            }

            const m = tf.match(/^(\d{4})-(\d{2})$/);
            if (m) {
                const year = Number(m[1]);
                const month = Number(m[2]) - 1;
                if (Number.isFinite(year) && Number.isFinite(month) && month >= 0 && month <= 11) {
                    const start = new Date(year, month, 1);
                    const end = new Date(year, month + 1, 1);
                    return { start_date: getLocalISODate(start), end_date: getLocalISODate(end) };
                }
            }
            return null;
        }

        function mapDashboardTimeframeToLibrary(tf) {
            const t = String(tf || '').trim().toLowerCase();
            if (t === 'this_year') return 'this_year';
            if (t === 'this_month') {
                const now = new Date();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                return `${now.getFullYear()}-${month}`;
            }
            return 'all_time';
        }

        async function loadLibraryMore({ replace = false } = {}) {
            const elList = document.getElementById('library-list');
            const wrap = document.getElementById('library-load-more-wrap');
            const btn = document.getElementById('library-load-more');

            if (!elList || !supabaseClient || !cachedIsAuthed) return;
            if (libraryLoading) return;
            if (!libraryHasMore && !replace) return;

            libraryLoading = true;
            if (btn) btn.disabled = true;

            let authedUser = null;
            try {
                const { user } = await requireAuthOrThrow();
                authedUser = user;
            } catch (err) {
                libraryLoading = false;
                if (btn) btn.disabled = false;
                showToast(String(err?.message || err), { level: 'warn' });
                return;
            }

            if (libraryPendingWatchCountMaxOnly) {
                const maxVal = await loadLibraryWatchCountMaxForUser(authedUser?.id);
                libraryWatchCountMax = Math.max(0, Number(maxVal) || 0);
                ensureLibrarySortFilterStateInitialized();
                if (libraryWatchCountMax > 0) {
                    librarySortFilterState.watchCountMin = libraryWatchCountMax;
                    librarySortFilterState.watchCountMax = libraryWatchCountMax;
                }
                libraryPendingWatchCountMaxOnly = false;
            }

            const start = replace ? 0 : libraryOffset;
            const limitPlusOne = libraryLimit; // we pass extra via range end

            try {
                // Primary: server-side sort/filter/paging via `user_library_items`.
                let q = libraryBuildServerQuery({ userId: authedUser.id, offset: start, limit: limitPlusOne });
                let { data, error } = await q;

                // If genres column isn't an array, `.contains` may fail; retry genre filter via `genre` string.
                if (error && String(error?.message || '').toLowerCase().includes('operator')) {
                    ensureLibrarySortFilterStateInitialized();
                    const genreWanted = String(librarySortFilterState?.genre || '').trim();
                    if (genreWanted) {
                        q = supabaseClient
                            .from(LIBRARY_ITEMS_VIEW)
                            .select('user_id, movie_id, latest_watch_date, title, release_year, tmdb_id, poster_path, mpa_rating, runtime_minutes, director, actors, genres, genre, imdb_rating_pct, imdb_pct, imdb_rating, overall_rating, tier, fav_quote, notes, sound_rating, pacing_rating, imagery_rating, acting_rating, plot_rating, dialogue_rating, watch_count, watch_method')
                            .eq('user_id', authedUser.id);

                        const range = libraryComputeTimeframeRange(librarySortFilterState?.timeframe);
                        if (range?.start_date && range?.end_date) {
                            q = q.gte('latest_watch_date', range.start_date).lt('latest_watch_date', range.end_date);
                        }

                        const state = librarySortFilterState;
                        const tierWanted = String(state?.tier || '').trim();
                        if (tierWanted) {
                            if (tierWanted === 'UNRANKED') q = q.or('tier.is.null,tier.eq.,tier.eq.UNRANKED,tier.eq.Unranked');
                            else q = q.eq('tier', tierWanted);
                        }
                        const decadeWanted = String(state?.decade || '').trim();
                        if (decadeWanted) {
                            const d = Number(decadeWanted);
                            if (Number.isFinite(d)) q = q.gte('release_year', d).lte('release_year', d + 9);
                        }
                        const directorNeedle = String(state?.directorContains || '').trim();
                        if (directorNeedle) q = q.ilike('director', `%${directorNeedle}%`);
                        const actorNeedle = String(state?.actorContains || '').trim();
                        if (actorNeedle) q = q.ilike('actors', `%${actorNeedle}%`);

                        const watchMethod = String(state?.watchMethod || '').trim();
                        if (watchMethod) {
                            const needle = watchMethod.toLowerCase().includes('theater')
                                ? '%theater%'
                                : (watchMethod.toLowerCase().includes('home') ? '%home%' : watchMethod);
                            q = q.ilike('watch_method', needle);
                        }

                        const watchMinStr = String(state?.watchCountMin || '').trim();
                        const watchMaxStr = String(state?.watchCountMax || '').trim();
                        const watchMinVal = watchMinStr ? Number(watchMinStr) : null;
                        const watchMaxVal = watchMaxStr ? Number(watchMaxStr) : null;
                        const watchMin = Number.isFinite(watchMinVal) && watchMinVal > 0 ? watchMinVal : null;
                        const watchMax = Number.isFinite(watchMaxVal) && watchMaxVal > 0 ? watchMaxVal : null;
                        if (watchMin !== null) q = q.gte('watch_count', watchMin);
                        if (watchMax !== null) q = q.lte('watch_count', watchMax);
                        const mpaWanted = String(state?.mpa || '').trim();
                        if (mpaWanted) q = q.ilike('mpa_rating', mpaWanted);

                        q = q.ilike('genre', `%${genreWanted}%`);

                        const sortKey = String(state?.sortKey || 'watch_date');
                        const sortDir = (String(state?.sortDir || 'desc') === 'asc') ? 'asc' : 'desc';
                        const asc = (sortDir === 'asc');
                        const addOrder = (col) => q.order(col, { ascending: asc, nullsFirst: false }).order('movie_id', { ascending: true });
                        if (sortKey === 'watch_date') addOrder('latest_watch_date');
                        else if (sortKey === 'release_year') addOrder('release_year');
                        else if (sortKey === 'imdb') addOrder('imdb_rating_pct');
                        else if (sortKey === 'overall') addOrder('overall_rating');
                        else if (sortKey === 'watch_count') addOrder('watch_count');
                        else if (sortKey === 'sound') addOrder('sound_rating');
                        else if (sortKey === 'pace') addOrder('pacing_rating');
                        else if (sortKey === 'imagery') addOrder('imagery_rating');
                        else if (sortKey === 'acting') addOrder('acting_rating');
                        else if (sortKey === 'plot') addOrder('plot_rating');
                        else if (sortKey === 'dialogue') addOrder('dialogue_rating');
                        else addOrder('latest_watch_date');
                        q = q.range(start, start + limitPlusOne);

                        ({ data, error } = await q);
                    }
                }

                if (error) throw error;
                const rows = Array.isArray(data) ? data : [];

                // PostgREST range is inclusive; we requested `limit`+1 via range end.
                const hasMore = rows.length > libraryLimit;
                const page = hasMore ? rows.slice(0, libraryLimit) : rows;

                libraryHasMore = hasMore;
                if (replace) {
                    libraryItems = page;
                    libraryOffset = page.length;
                } else {
                    libraryItems = libraryItems.concat(page);
                    libraryOffset += page.length;
                }

                renderLibraryList();
                if (wrap) wrap.style.display = libraryHasMore ? 'flex' : 'none';
            } catch (err) {
                const msg = String(err?.message || err);
                if (replace) {
                    elList.innerHTML = `<div class="text-gray">Could not load movies: ${escapeHtml(msg)}</div>`;
                } else {
                    showToast(`Could not load more: ${msg}`, { level: 'warn' });
                }
                if (wrap) wrap.style.display = 'none';
            } finally {
                libraryLoading = false;
                if (btn) btn.disabled = false;
            }
        }

        async function loadMyFollowingIds() {
            feedFollowingIds = new Set();
            if (!supabaseClient) return;
            let authedUser = null;
            try {
                const { data } = await supabaseClient.auth.getUser();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }
            if (!authedUser?.id) return;

            const { data, error } = await supabaseClient
                .from('Follows')
                .select('followed_id')
                .eq('follower_id', authedUser.id);
            if (error) throw error;
            const rows = Array.isArray(data) ? data : [];
            for (const r of rows) {
                const id = String(r?.followed_id || '').trim();
                if (id) feedFollowingIds.add(id);
            }
        }

        async function loadFeedPage() {
            // Bind per-render DOM elements.
            syncFeedSortUI();

            const form = document.getElementById('feed-search-form');
            const input = document.getElementById('feed-search-input');
            const clearBtn = document.getElementById('feed-clear-btn');

            if (form && !form.dataset.bound) {
                form.dataset.bound = 'true';
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const q = String(input?.value || '').trim();
                    await searchFeedUsers(q);
                });
            }

            if (clearBtn && !clearBtn.dataset.bound) {
                clearBtn.dataset.bound = 'true';
                clearBtn.addEventListener('click', async () => {
                    if (input) input.value = '';
                    feedLastSearchQuery = '';
                    const el = document.getElementById('feed-search-results');
                    if (el) el.innerHTML = '';
                });
            }

            try {
                await loadMyFollowingIds();
                await loadFeedFollowingList();
                await loadFeedItems();
            } catch (err) {
                showToast(`Feed failed: ${String(err?.message || err)}`, { level: 'warn' });
            }
        }

        function syncFeedSortUI() {
            const btnUpdated = document.getElementById('feed-sort-updated');
            const btnWatched = document.getElementById('feed-sort-watched');
            const activate = (btn, on) => {
                if (!btn) return;
                btn.classList.toggle('active', Boolean(on));
            };
            activate(btnUpdated, feedSortMode === 'updated_at');
            activate(btnWatched, feedSortMode === 'watch_date');
        }

        async function loadFeedFollowingList() {
            const el = document.getElementById('feed-following');
            if (!el) return;

            if (!supabaseClient || !cachedIsAuthed) {
                el.innerHTML = `<div class="text-gray">Log in to manage follows.</div>`;
                return;
            }

            const ids = Array.from(feedFollowingIds);
            if (ids.length === 0) {
                el.innerHTML = `<div class="text-gray">You arent following anyone yet.</div>`;
                return;
            }

            let data = null;
            try {
                const r1 = await supabaseClient
                    .from('Users')
                    .select('id, username, display_name, privacy_level, icon')
                    .in('id', ids);
                if (r1.error) throw r1.error;
                data = r1.data;
            } catch (err1) {
                const msg1 = String(err1?.message || err1);
                if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                    const r2 = await supabaseClient
                        .from('Users')
                        .select('id, username, display_name, privacy_level')
                        .in('id', ids);
                    if (r2.error) throw r2.error;
                    data = r2.data;
                } else {
                    throw err1;
                }
            }

            const rows = Array.isArray(data) ? data : [];
            // Preserve the order of ids.
            const map = new Map(rows.map(r => [String(r?.id || '').trim(), r]));
            const ordered = ids.map(id => map.get(id)).filter(Boolean);

            el.innerHTML = ordered.map((u) => {
                const id = String(u?.id || '').trim();
                const username = String(u?.username || '').trim();
                const name = String(u?.display_name || '').trim() || (username ? `@${username}` : 'User');
                const privacy = String(u?.privacy_level || 'public').trim();
                const iconId = String(u?.icon || '').trim();
                return `
                    <div class="glass-panel" style="padding: 0.75rem; border-radius: 0.9rem; display:flex; align-items:center; justify-content: space-between; gap: 10px;">
                        <div style="min-width:0; display:flex; gap: 10px; align-items: center;">
                            ${renderUserIconHtml(iconId, 28)}
                            <div style="min-width:0;">
                                <div class="text-white font-semibold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(name)}</div>
                                <div class="text-xs text-gray" style="margin-top: 0.15rem;">${username ? `@${escapeHtml(username)}` : ''}${privacy ? `  ${escapeHtml(privacy)}` : ''}</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline" data-feed-action="unfollow" data-feed-user-id="${escapeHtml(id)}" style="padding: 0.45rem 0.7rem; border-radius: 0.75rem;">Unfollow</button>
                    </div>
                `;
            }).join('');
        }

        async function searchFeedUsers(query) {
            const el = document.getElementById('feed-search-results');
            if (!el) return;
            const q = String(query || '').trim();
            feedLastSearchQuery = q;

            if (!q) {
                el.innerHTML = `<div class="text-gray">Type a username to search.</div>`;
                return;
            }

            if (!supabaseClient || !cachedIsAuthed) {
                el.innerHTML = `<div class="text-gray">Log in to search users.</div>`;
                return;
            }

            el.innerHTML = `<div class="text-gray">Searching</div>`;

            let data = null;
            try {
                const r1 = await supabaseClient
                    .from('Users')
                    .select('id, username, display_name, privacy_level, icon')
                    .ilike('username', `%${q}%`)
                    .limit(20);
                if (r1.error) throw r1.error;
                data = r1.data;
            } catch (err1) {
                const msg1 = String(err1?.message || err1);
                if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                    const r2 = await supabaseClient
                        .from('Users')
                        .select('id, username, display_name, privacy_level')
                        .ilike('username', `%${q}%`)
                        .limit(20);
                    if (r2.error) throw r2.error;
                    data = r2.data;
                } else {
                    throw err1;
                }
            }

            const rows = Array.isArray(data) ? data : [];
            if (rows.length === 0) {
                el.innerHTML = `<div class="text-gray">No users found for ${escapeHtml(q)}.</div>`;
                return;
            }

            // Determine authed user id so we can hide follow-self.
            let authedUserId = '';
            try {
                const { data: udata } = await supabaseClient.auth.getUser();
                authedUserId = String(udata?.user?.id || '').trim();
            } catch (_) {
                authedUserId = '';
            }

            el.innerHTML = rows.map((u) => {
                const id = String(u?.id || '').trim();
                const username = String(u?.username || '').trim();
                const name = String(u?.display_name || '').trim() || (username ? `@${username}` : 'User');
                const privacy = String(u?.privacy_level || 'public').trim();
                const iconId = String(u?.icon || '').trim();
                const isMe = authedUserId && id === authedUserId;
                const isFollowing = feedFollowingIds.has(id);

                const right = isMe
                    ? `<span class="text-xs text-gray" style="white-space: nowrap;">This is you</span>`
                    : (isFollowing
                        ? `<button type="button" class="btn btn-outline" data-feed-action="unfollow" data-feed-user-id="${escapeHtml(id)}" style="padding: 0.45rem 0.7rem; border-radius: 0.75rem;">Unfollow</button>`
                        : `<button type="button" class="btn btn-primary" data-feed-action="follow" data-feed-user-id="${escapeHtml(id)}" style="padding: 0.45rem 0.7rem; border-radius: 0.75rem;">Follow</button>`);

                return `
                    <div class="glass-panel" style="padding: 0.75rem; border-radius: 0.9rem; display:flex; align-items:center; justify-content: space-between; gap: 10px;">
                        <div style="min-width:0; display:flex; gap: 10px; align-items: center;">
                            ${renderUserIconHtml(iconId, 28)}
                            <div style="min-width:0;">
                                <div class="text-white font-semibold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(name)}</div>
                                <div class="text-xs text-gray" style="margin-top: 0.15rem;">${username ? `@${escapeHtml(username)}` : ''}${privacy ? `  ${escapeHtml(privacy)}` : ''}</div>
                            </div>
                        </div>
                        ${right}
                    </div>
                `;
            }).join('');
        }

        async function loadFeedItems() {
            const elList = document.getElementById('feed-list');
            const elMeta = document.getElementById('feed-meta');
            if (!elList) return;

            if (!supabaseClient || !cachedIsAuthed) {
                elList.innerHTML = `<div class="text-gray">Log in to view your feed.</div>`;
                if (elMeta) elMeta.textContent = '';
                return;
            }

            const followedIds = Array.from(feedFollowingIds);
            if (followedIds.length === 0) {
                elList.innerHTML = `<div class="text-gray">Follow someone to see activity here.</div>`;
                if (elMeta) elMeta.textContent = '';
                return;
            }

            elList.innerHTML = `<div class="text-gray">Loading</div>`;
            if (elMeta) elMeta.textContent = '';

            let rows = [];

            // Mode A: sort by rating updated_at (most recently created/updated ratings)
            if (feedSortMode === 'updated_at') {
                const { data: ratings, error } = await supabaseClient
                    .from('Movie Ratings')
                    .select('user_id, movie_id, overall_rating, tier, watch_date, updated_at, fav_quote, notes, sound_rating, pacing_rating, imagery_rating, acting_rating, plot_rating, dialogue_rating')
                    .in('user_id', followedIds)
                    .order('updated_at', { ascending: false })
                    .limit(15);
                if (error) throw error;
                rows = Array.isArray(ratings) ? ratings : [];
            }

            // Mode B: sort by most recent watch_date (ignores rating edits that weren't watched)
            if (feedSortMode === 'watch_date') {
                const { data: watches, error: wErr } = await supabaseClient
                    .from('Watch Logs')
                    .select('user_id, movie_id, watch_date')
                    .in('user_id', followedIds)
                    .order('watch_date', { ascending: false })
                    .limit(15);
                if (wErr) throw wErr;
                const wrows = Array.isArray(watches) ? watches : [];

                if (wrows.length) {
                    const movieIds2 = Array.from(new Set(wrows.map(r => r?.movie_id).filter(Boolean)));
                    const userIds2 = Array.from(new Set(wrows.map(r => r?.user_id).filter(Boolean)));
                    const { data: ratings2, error: rErr } = await supabaseClient
                        .from('Movie Ratings')
                        .select('user_id, movie_id, overall_rating, tier, watch_date, updated_at, fav_quote, notes, sound_rating, pacing_rating, imagery_rating, acting_rating, plot_rating, dialogue_rating')
                        .in('movie_id', movieIds2)
                        .in('user_id', userIds2);
                    if (rErr) throw rErr;

                    const ratingMap = new Map();
                    for (const rr of (Array.isArray(ratings2) ? ratings2 : [])) {
                        const k = `${String(rr?.user_id || '').trim()}|${String(rr?.movie_id || '').trim()}`;
                        if (k !== '|') ratingMap.set(k, rr);
                    }

                    rows = wrows.map((w) => {
                        const k = `${String(w?.user_id || '').trim()}|${String(w?.movie_id || '').trim()}`;
                        const rr = ratingMap.get(k) || {};
                        // Ensure watch_date comes from Watch Logs sort mode.
                        return { ...rr, user_id: w?.user_id, movie_id: w?.movie_id, watch_date: w?.watch_date };
                    });
                } else {
                    rows = [];
                }
            }

            if (rows.length === 0) {
                const msg = (feedSortMode === 'watch_date')
                    ? 'No recent watch logs found from people you follow (or their privacy blocks access).'
                    : 'No ratings found from people you follow (or their privacy blocks access).';
                elList.innerHTML = `<div class="text-gray">${msg}</div>`;
                if (elMeta) elMeta.textContent = '';
                return;
            }

            const movieIds = Array.from(new Set(rows.map(r => r?.movie_id).filter(Boolean)));
            const userIds = Array.from(new Set(rows.map(r => r?.user_id).filter(Boolean)));

            const moviesById = new Map();
            if (movieIds.length) {
                const { data: moviesData, error: moviesErr } = await supabaseClient
                    .from('Movies')
                    .select('id, title, release_year, tmdb_id, poster_path')
                    .in('id', movieIds);
                if (moviesErr) throw moviesErr;
                const mrows = Array.isArray(moviesData) ? moviesData : [];
                for (const m of mrows) moviesById.set(m.id, m);
            }

            const usersById = new Map();
            if (userIds.length) {
                let usersData = null;
                try {
                    const r1 = await supabaseClient
                        .from('Users')
                        .select('id, username, display_name, icon')
                        .in('id', userIds);
                    if (r1.error) throw r1.error;
                    usersData = r1.data;
                } catch (err1) {
                    const msg1 = String(err1?.message || err1);
                    if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                        const r2 = await supabaseClient
                            .from('Users')
                            .select('id, username, display_name')
                            .in('id', userIds);
                        if (r2.error) throw r2.error;
                        usersData = r2.data;
                    } else {
                        throw err1;
                    }
                }

                const urows = Array.isArray(usersData) ? usersData : [];
                for (const u of urows) usersById.set(u.id, u);
            }

            // Posters are lazy-loaded from stored DB poster_path; no TMDb calls.

            if (elMeta) {
                const label = (feedSortMode === 'watch_date') ? 'Most recent watches first' : 'Most recent updates first';
                elMeta.textContent = `${rows.length} item${rows.length === 1 ? '' : 's'}  ${label}`;
            }

            elList.innerHTML = rows.map((r) => {
                const actorId = String(r?.user_id || '').trim();
                const actor = usersById.get(actorId) || null;
                const actorUsernameRaw = String(actor?.username || '').trim().replace(/^@+/, '');
                const actorUsername = actorUsernameRaw ? `@${actorUsernameRaw}` : 'User';
                const actorIconId = String(actor?.icon || '').trim();

                const movie = moviesById.get(r?.movie_id) || null;
                const title = String(movie?.title || '').trim() || 'Untitled';
                const year = (movie?.release_year === null || movie?.release_year === undefined) ? '' : String(movie.release_year);

                const overall = dashFormatScoreWhole(r?.overall_rating);
                const tierLabel = dashNormalizeTierLabel(r?.tier);

                const tmdb_id = Number(movie?.tmdb_id);
                const poster_path = dashNormalizePosterPath(String(movie?.poster_path ?? '').trim() || (Number.isFinite(tmdb_id) ? (dashPosterCacheByTmdbId.get(tmdb_id) || '') : ''));
                const posterUrl = dashBuildPosterUrl(poster_path, 'w342');

                const quote = String(r?.fav_quote ?? '').trim();
                const notes = String(r?.notes ?? '').trim();
                const updatedAt = formatFeedTimestamp(r?.updated_at);
                const watched = String(r?.watch_date ?? '').trim();

                const subRatingRows = [
                    { k: 'Sound', v: dashFormatScoreWhole(r?.sound_rating) },
                    { k: 'Pace', v: dashFormatScoreWhole(r?.pacing_rating) },
                    { k: 'Imagery', v: dashFormatScoreWhole(r?.imagery_rating) },
                    { k: 'Acting', v: dashFormatScoreWhole(r?.acting_rating) },
                    { k: 'Plot', v: dashFormatScoreWhole(r?.plot_rating) },
                    { k: 'Dialogue', v: dashFormatScoreWhole(r?.dialogue_rating) },
                ].filter(x => String(x.v || '').trim());

                return `
                    <div class="glass-panel feed-item-card" data-feed-card="1" style="padding: 0.9rem; border-radius: 1rem;">
                        <div class="feed-card-row">
                            <div class="feed-card-poster">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width:100%; height:100%; object-fit: cover; display:block;" onerror="this.style.display='none';">`
                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`}
                            </div>

                            <div class="feed-card-main">
                                <div class="text-white font-bold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(title)}${year ? ` <span style="color: rgba(255,255,255,0.65); font-weight: 800;">(${escapeHtml(year)})</span>` : ''}</div>

                                ${(overall || tierLabel)
                                    ? `<div class="feed-metrics">${overall ? dashRenderHelpScore(overall) : ''}${tierLabel ? dashRenderHelpTier(tierLabel) : ''}</div>`
                                    : `<div class="text-xs text-gray" style="margin-top: 0.25rem;">No rating yet</div>`
                                }

                                ${(feedSortMode === 'watch_date')
                                    ? (watched ? `<div class="text-xs" style="margin-top: 0.25rem; color: rgba(255,255,255,0.55);">Watched: ${escapeHtml(watched)}</div>` : '')
                                    : (updatedAt ? `<div class="text-xs" style="margin-top: 0.25rem; color: rgba(255,255,255,0.55);">Updated: ${escapeHtml(updatedAt)}</div>` : '')
                                }
                            </div>

                            <div class="feed-card-actor" title="${escapeHtml(actorUsernameRaw || '')}">
                                ${renderUserIconHtml(actorIconId, 52)}
                                <span class="feed-card-actor-name">${escapeHtml(actorUsername)}</span>
                            </div>
                        </div>

                        <div class="feed-card-details">
                            ${subRatingRows.length
                                ? `<div class="library-chip-row" style="margin-top: 0.55rem;">
                                        ${subRatingRows.map(d => `<span class=\"dash-quote-pill\">${escapeHtml(d.k)}: ${escapeHtml(d.v)}</span>`).join('')}
                                   </div>`
                                : ''}

                            ${quote ? `
                                <div style="margin-top: 0.75rem;">
                                    <div class="text-xs text-gray" style="margin-bottom: 0.25rem;">Favorite Quote</div>
                                    <div class="text-white" style="line-height: 1.4;">${escapeHtml(quote)}</div>
                                </div>
                            ` : ''}

                            ${notes ? `
                                <div style="margin-top: 0.75rem;">
                                    <div class="text-xs text-gray" style="margin-bottom: 0.25rem;">Notes</div>
                                    <div class="text-white" style="line-height: 1.4; white-space: pre-wrap;">${escapeHtml(notes)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }


        function initDashboardGeneralKpiClicks() {
            const pane = document.getElementById('dash-pane-general');
            if (!pane) return;
            if (pane.dataset.boundKpiClicks) return;
            pane.dataset.boundKpiClicks = 'true';

            pane.addEventListener('click', (e) => {
                const watchEl = e?.target?.closest ? e.target.closest('[data-watch-method]') : null;
                const watchMethod = String(watchEl?.dataset?.watchMethod || '').trim();
                if (watchMethod) {
                    applyLibraryFiltersFromDashboard({ watchMethod });
                    return;
                }

                const el = e?.target?.closest ? e.target.closest('[data-general-kpi]') : null;
                const rawKey = String(el?.dataset?.generalKpi ?? '').trim();
                if (!rawKey) return;

                const useUnique = String(dashboardGeneralMode || '').trim().toLowerCase() === 'unique';
                const data = dashboardGeneralLastData || {};
                const tieSubtitle = useUnique ? 'Tied by unique movies' : 'Tied by watch events';
                const pluralizeLabel = (n, one, many) => {
                    const num = Number(n);
                    if (!Number.isFinite(num)) return '';
                    return `${num} ${num === 1 ? one : many}`;
                };

                const openTiesModal = (title, items, type) => {
                    const overlay = document.getElementById('dash-kpi-ties-overlay');
                    const titleEl = document.getElementById('dash-kpi-ties-title');
                    const subEl = document.getElementById('dash-kpi-ties-sub');
                    const bodyEl = document.getElementById('dash-kpi-ties-body');
                    if (!overlay || !titleEl || !bodyEl) return;

                    titleEl.textContent = title;
                    if (subEl) subEl.textContent = tieSubtitle;

                    const rows = Array.isArray(items) ? items : [];
                    if (!rows.length) {
                        bodyEl.innerHTML = `<div class="text-gray">No tied leaders found.</div>`;
                        overlay.style.display = 'flex';
                        return;
                    }

                    bodyEl.innerHTML = rows.map((item) => {
                        const label = String(item?.label || '').trim();
                        const meta = String(item?.meta || '').trim();
                        const value = String(item?.value || '').trim();
                        if (!label) return '';
                        return `
                            <button type="button" class="dash-kpi-tie-btn" data-kpi-type="${escapeHtml(type)}" data-kpi-value="${escapeHtml(value)}" data-kpi-label="${escapeHtml(label)}">
                                <div class="dash-kpi-tie-avatar" data-kpi-avatar="${escapeHtml(label)}">
                                    <span class="text-xs text-gray"></span>
                                </div>
                                <div>
                                    <div class="dash-kpi-tie-title">${escapeHtml(label)}</div>
                                    ${meta ? `<div class="dash-kpi-tie-meta">${escapeHtml(meta)}</div>` : ''}
                                </div>
                            </button>
                        `;
                    }).join('');

                    overlay.style.display = 'flex';

                    if (type === 'director' || type === 'actor') {
                        const department = type === 'director' ? 'directing' : 'acting';
                        rows.forEach(async (item) => {
                            const name = String(item?.label || '').trim();
                            if (!name) return;
                            const avatarWrap = bodyEl.querySelector(`[data-kpi-avatar="${CSS.escape(name)}"]`);
                            if (!avatarWrap) return;
                            try {
                                const profilePath = await dashFetchPersonProfile({ name, department });
                                const url = dashBuildPersonUrl(profilePath);
                                if (!url) return;
                                avatarWrap.innerHTML = `<img src="${escapeHtml(url)}" alt="${escapeHtml(name)}" loading="lazy">`;
                            } catch (_) {}
                        });
                    }
                };

                if (rawKey === 'most_watched_director') {
                    const tieRows = Array.isArray(useUnique ? data?.most_watched_directors_unique : data?.most_watched_directors)
                        ? (useUnique ? data.most_watched_directors_unique : data.most_watched_directors)
                        : [];
                    if (tieRows.length > 1) {
                        openTiesModal('Most Watched Director(s)', tieRows.map((row) => {
                            const name = String(row?.name || '').trim();
                            const movies = pluralizeLabel(row?.movies, 'movie', 'movies');
                            const watches = !useUnique ? pluralizeLabel(row?.watches, 'watch event', 'watch events') : '';
                            const meta = [movies, watches].filter(Boolean).join('  ');
                            return { label: name, value: name, meta };
                        }).filter(Boolean), 'director');
                        return;
                    }
                    const name = String(useUnique ? data?.most_watched_director_unique?.name : data?.most_watched_director?.name || '').trim();
                    if (!name) {
                        showToast('No director data yet.', { level: 'warn' });
                        return;
                    }
                    applyLibraryFiltersFromDashboard({ director: name });
                    return;
                }

                if (rawKey === 'most_watched_actor') {
                    const tieRows = Array.isArray(useUnique ? data?.most_watched_actors_unique : data?.most_watched_actors)
                        ? (useUnique ? data.most_watched_actors_unique : data.most_watched_actors)
                        : [];
                    if (tieRows.length > 1) {
                        openTiesModal('Most Watched Actor(s)', tieRows.map((row) => {
                            const name = String(row?.name || '').trim();
                            const movies = pluralizeLabel(row?.movies, 'movie', 'movies');
                            const watches = !useUnique ? pluralizeLabel(row?.watches, 'watch event', 'watch events') : '';
                            const meta = [movies, watches].filter(Boolean).join('  ');
                            return { label: name, value: name, meta };
                        }).filter(Boolean), 'actor');
                        return;
                    }
                    const name = String(useUnique ? data?.most_watched_actor_unique?.name : data?.most_watched_actor?.name || '').trim();
                    if (!name) {
                        showToast('No actor data yet.', { level: 'warn' });
                        return;
                    }
                    applyLibraryFiltersFromDashboard({ actor: name });
                    return;
                }

                if (rawKey === 'most_watched_movie') {
                    applyLibraryFiltersFromDashboard({ watchCountMaxOnly: true, sortKey: 'watch_count', sortDir: 'desc' });
                }
            });
        }

        function closeDashKpiTies() {
            const overlay = document.getElementById('dash-kpi-ties-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';
            const bodyEl = document.getElementById('dash-kpi-ties-body');
            if (bodyEl) bodyEl.innerHTML = 'Loading';
        }

        function initDashKpiTiesModal() {
            const overlay = document.getElementById('dash-kpi-ties-overlay');
            if (!overlay) return;
            if (overlay.dataset.boundClicks) return;
            overlay.dataset.boundClicks = 'true';

            overlay.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('[data-kpi-type]') : null;
                if (!btn) return;
                const type = String(btn.dataset.kpiType || '').trim();
                const value = String(btn.dataset.kpiValue || '').trim();
                const label = String(btn.dataset.kpiLabel || '').trim();
                if (!type || !value) return;

                if (type === 'director') {
                    closeDashKpiTies();
                    applyLibraryFiltersFromDashboard({ director: label || value });
                    return;
                }
                if (type === 'actor') {
                    closeDashKpiTies();
                    applyLibraryFiltersFromDashboard({ actor: label || value });
                    return;
                }
            });
        }


        function initDashboardRatingsKpiClicks() {
            const pane = document.getElementById('dash-pane-ratings');
            if (!pane) return;
            if (pane.dataset.boundKpiClicks) return;
            pane.dataset.boundKpiClicks = 'true';

            pane.addEventListener('click', (e) => {
                const barEl = e?.target?.closest ? e.target.closest('[data-rating-bar="true"]') : null;
                if (barEl) {
                    const rawType = String(barEl.dataset.barType || '').trim().toLowerCase();
                    const rawLabel = String(barEl.dataset.barLabel || '').trim();
                    if (!rawLabel) return;
                    if (rawType === 'genre') {
                        applyLibraryFiltersFromDashboard({ genre: rawLabel });
                        return;
                    }
                    if (rawType === 'decade') {
                        applyLibraryFiltersFromDashboard({ decade: normalizeLibraryDecadeLabel(rawLabel) });
                        return;
                    }
                    if (rawType === 'mpa') {
                        applyLibraryFiltersFromDashboard({ mpa: rawLabel });
                        return;
                    }
                }

                const el = e?.target?.closest ? e.target.closest('[data-ratings-kpi]') : null;
                const key = String(el?.dataset?.ratingsKpi ?? '').trim();
                if (!key) return;

                const data = dashboardRatingsLastData || {};
                if (key === 'ratings_highest_director') {
                    const name = String(data?.highest_rated_director?.name ?? '').trim();
                    if (!name) {
                        showToast('No director data yet.', { level: 'warn' });
                        return;
                    }
                    applyLibraryFiltersFromDashboard({ director: name });
                    return;
                }
                if (key === 'ratings_lowest_director') {
                    const name = String(data?.lowest_rated_director?.name ?? '').trim();
                    if (!name) {
                        showToast('No director data yet.', { level: 'warn' });
                        return;
                    }
                    applyLibraryFiltersFromDashboard({ director: name });
                    return;
                }
            });
        }

        function initDashboardPosterUpdateRatingsClicks() {
            // Global delegation so it works for Favorites + KPI detail pages.
            // Bound once per session.
            if (document.documentElement.dataset.boundDashPosterClicks === 'true') return;
            document.documentElement.dataset.boundDashPosterClicks = 'true';

            const shouldHandleNow = () => {
                const p = String(router?.currentPage || '').trim().toLowerCase();
                return p === 'dashboard' || p === 'dashboard_kpi' || p === 'dashboard_pie_filter';
            };

            document.addEventListener('click', async (e) => {
                if (!shouldHandleNow()) return;
                const target = e?.target?.closest ? e.target.closest('[data-dash-movie-id]') : null;
                if (!target) return;

                const movieIdRaw = String(target.dataset.dashMovieId || '').trim();
                const tmdbIdRaw = String(target.dataset.dashTmdbId || '').trim();
                const titleRaw = String(target.dataset.dashMovieTitle || '').trim();
                const posterRaw = String(target.dataset.dashPosterPath || '').trim();
                const quoteRaw = String(target.dataset.dashMovieQuote || '').trim();

                if (!movieIdRaw && !tmdbIdRaw) return;

                e.preventDefault?.();
                e.stopPropagation?.();

                // Reuse the exact same update flow as the Home dropdown "Update Ratings" path.
                // startUpdateRatings() resolves the DB movie id and loads existing rating + watch log data.
                router.selectedMovie = {
                    id: movieIdRaw || undefined,
                    db_movie_id: movieIdRaw || undefined,
                    tmdb_id: tmdbIdRaw ? Number(tmdbIdRaw) : undefined,
                    title: titleRaw || undefined,
                    poster_path: posterRaw || undefined,
                    prefill_quote: quoteRaw || undefined,
                };

                await router.startUpdateRatings();
            }, { capture: true });

            // Cosmetic: move the Quote Wall glow with the mouse.
            document.addEventListener('mousemove', (e) => {
                if (!shouldHandleNow()) return;
                const card = e?.target?.closest ? e.target.closest('.dash-quote-card') : null;
                if (!card) return;
                const rect = card.getBoundingClientRect();
                const x = Math.max(0, Math.min(100, ((e.clientX - rect.left) / Math.max(1, rect.width)) * 100));
                const y = Math.max(0, Math.min(100, ((e.clientY - rect.top) / Math.max(1, rect.height)) * 100));
                card.style.setProperty('--mx', `${x}%`);
                card.style.setProperty('--my', `${y}%`);
                card.style.setProperty('--mx2', `${100 - x}%`);
                card.style.setProperty('--my2', `${100 - y}%`);
            }, { passive: true });
        }

        function initDashboardFavoritesMetric() {
            const wrap = document.getElementById('dash-fav-metric-wrap');
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-metric]') : null;
                const metric = btn?.dataset?.metric;
                if (!metric) return;
                setDashboardFavoritesMetric(metric);
            });
        }

        function initDashboardFavoritesLimitToggle() {
            const btnTop = document.getElementById('dash-fav-limit-toggle-top');
            const btnBottom = document.getElementById('dash-fav-limit-toggle-bottom');
            const bind = (btn) => {
                if (!btn) return;
                if (btn.dataset.boundClicks) return;
                btn.dataset.boundClicks = 'true';
                btn.addEventListener('click', () => {
                    const next = Number(dashboardFavoritesLimit) === 10 ? 5 : 10;
                    setDashboardFavoritesLimit(next);
                });
            };
            bind(btnTop);
            bind(btnBottom);
        }

        function initDashboardGeneralModeControls() {
            const wrap = document.getElementById('dash-general-mode-wrap');
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-mode]') : null;
                const mode = btn?.dataset?.mode;
                if (!mode) return;
                setDashboardGeneralMode(mode);
            });
        }

        function initDashboardGeneralPieControls() {
            const wrap = document.getElementById('dash-general-pie-toggle');
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-pie]') : null;
                const pie = btn?.dataset?.pie;
                if (!pie) return;
                setDashboardGeneralPieMode(pie);
            });
        }

        function normalizeLibraryDecadeLabel(raw) {
            const s = String(raw || '').trim();
            if (!s) return '';
            const m = s.match(/\d{4}/);
            return m ? m[0] : '';
        }

        function applyLibraryFiltersFromDashboard({ genre, decade, mpa, director, actor, movieId, movieTitle, watchMethod, watchCountMaxOnly = false, sortKey, sortDir } = {}) {
            const def = getDefaultLibrarySortFilterState();
            const timeframe = mapDashboardTimeframeToLibrary(dashboardTimeframe || 'all_time');
            librarySortFilterState = {
                ...def,
                sortKey: sortKey || (watchCountMaxOnly ? 'watch_count' : def.sortKey),
                sortDir: sortDir || (watchCountMaxOnly ? 'desc' : def.sortDir),
                timeframe,
                genre: String(genre || '').trim(),
                decade: String(decade || '').trim(),
                mpa: String(mpa || '').trim(),
                directorContains: String(director || '').trim(),
                actorContains: String(actor || '').trim(),
                movieId: String(movieId || '').trim(),
                movieTitle: String(movieTitle || '').trim(),
                watchMethod: String(watchMethod || '').trim(),
                watchCountMin: '',
                watchCountMax: '',
            };
            librarySortFilterDraft = null;
            libraryPendingWatchCountMaxOnly = Boolean(watchCountMaxOnly);
            router.navigate('library');
        }

        function initDashboardGeneralPieLegendClicks() {
            const legend = document.getElementById('dash-general-share-legend');
            if (!legend) return;
            if (legend.dataset.boundLegendClicks) return;
            legend.dataset.boundLegendClicks = 'true';

            const activate = (item) => {
                let label = '';
                const encoded = String(item?.dataset?.dashPieValue || '').trim();
                if (encoded) {
                    try {
                        label = decodeURIComponent(encoded);
                    } catch (_) {
                        label = encoded;
                    }
                }
                if (!label) label = String(item?.dataset?.dashPieLabel || '').trim();
                const type = String(legend.dataset.pieType || '').trim().toLowerCase();
                if (!label || !type) return;

                if (type === 'genre') {
                    applyLibraryFiltersFromDashboard({ genre: label });
                    return;
                }
                if (type === 'mpa') {
                    applyLibraryFiltersFromDashboard({ mpa: label });
                    return;
                }
                if (type === 'decade') {
                    applyLibraryFiltersFromDashboard({ decade: normalizeLibraryDecadeLabel(label) });
                    return;
                }
            };

            legend.addEventListener('click', (e) => {
                const item = e?.target?.closest ? e.target.closest('.dash-pie-legend-item') : null;
                if (!item) return;
                activate(item);
            });

            legend.addEventListener('keydown', (e) => {
                const key = String(e?.key || '').toLowerCase();
                if (key !== 'enter' && key !== ' ') return;
                const item = e?.target?.closest ? e.target.closest('.dash-pie-legend-item') : null;
                if (!item) return;
                e.preventDefault?.();
                activate(item);
            });
        }

        function initDashboardChartsTabControls() {
            const wrap = document.getElementById('dash-chart-tab-wrap');
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-chart]') : null;
                const chart = btn?.dataset?.chart;
                if (!chart) return;
                setDashboardChartsTab(chart);
            });
        }

        function initDashboardHeatmapSelect() {
            const select = document.getElementById('dash-heatmap-pair');
            if (!select) return;
            if (select.dataset.boundChange) return;
            select.dataset.boundChange = 'true';

            select.addEventListener('change', () => {
                const value = String(select.value || '').trim().toLowerCase();
                setDashboardHeatmapPair(value);
            });
        }

        function initDashboardHeatmapAxisControls() {
            const panel = document.getElementById('dash-heatmap-axis-panel');
            if (!panel) return;
            if (panel.dataset.boundClicks) return;
            panel.dataset.boundClicks = 'true';

            panel.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-axis]') : null;
                if (!btn) return;
                const axis = btn.dataset.axis;
                const value = btn.dataset.value;
                if (!axis || !value) return;
                setDashboardHeatmapAxis(axis, value);
            });
        }

        function initDashboardRatingsChartControls() {
            const wrap = document.getElementById('dash-ratings-chart-tab-wrap');
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-chart]') : null;
                const chart = btn?.dataset?.chart;
                if (!chart) return;
                setDashboardRatingsChartTab(chart);
            });
        }

        function syncDashboardFavoritesMetricUI() {
            const m = String(dashboardFavoritesMetric || '').trim().toLowerCase();
            const allowed = new Set(['overall', 'sound', 'plot', 'pace', 'acting', 'imagery', 'dialogue']);
            dashboardFavoritesMetric = allowed.has(m) ? m : 'overall';

            const wrap = document.getElementById('dash-fav-metric-wrap');
            if (!wrap) return;
            wrap.querySelectorAll('button[data-metric]').forEach((btn) => {
                const isOn = String(btn.dataset.metric || '').trim().toLowerCase() === dashboardFavoritesMetric;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
            });
        }

        function syncDashboardFavoritesLimitUI() {
            const limit = Number(dashboardFavoritesLimit) === 10 ? 10 : 5;
            dashboardFavoritesLimit = limit;

            const btnTop = document.getElementById('dash-fav-limit-toggle-top');
            const btnBottom = document.getElementById('dash-fav-limit-toggle-bottom');
            const update = (btn) => {
                if (!btn) return;
                btn.textContent = limit === 10 ? 'Show 5' : 'Show 10';
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(limit === 10 ? 'btn-glass' : 'btn-outline');
                btn.setAttribute('aria-pressed', limit === 10 ? 'true' : 'false');
            };
            update(btnTop);
            update(btnBottom);

            const topLabel = document.getElementById('dash-fav-top-label');
            if (topLabel) topLabel.textContent = `Top ${limit}`;
            const bottomLabel = document.getElementById('dash-fav-bottom-label');
            if (bottomLabel) bottomLabel.textContent = `Bottom ${limit}`;
        }

        function syncDashboardGeneralModeUI() {
            const m = String(dashboardGeneralMode || '').trim().toLowerCase();
            const allowed = new Set(['total', 'unique']);
            dashboardGeneralMode = allowed.has(m) ? m : 'total';

            const wrap = document.getElementById('dash-general-mode-wrap');
            if (wrap) {
                wrap.querySelectorAll('button[data-mode]').forEach((btn) => {
                    const isOn = String(btn.dataset.mode || '').trim().toLowerCase() === dashboardGeneralMode;
                    btn.classList.remove('btn-glass', 'btn-outline');
                    btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
                });
            }

            const pane = document.getElementById('dash-pane-general');
            if (pane) {
                pane.classList.remove('dash-mode-total', 'dash-mode-unique');
                pane.classList.add(dashboardGeneralMode === 'unique' ? 'dash-mode-unique' : 'dash-mode-total');
            }

            const watchLabel = document.getElementById('dash-general-watch-label');
            const hoursLabel = document.getElementById('dash-general-hours-label');
            if (watchLabel) watchLabel.textContent = dashboardGeneralMode === 'unique' ? 'Unique Movies' : 'Watches';
            if (hoursLabel) hoursLabel.textContent = dashboardGeneralMode === 'unique' ? 'Unique Hours' : 'Hours';

            const atHomeLabel = document.getElementById('dash-general-at-home-label');
            if (atHomeLabel) atHomeLabel.textContent = dashboardGeneralMode === 'unique' ? 'Unique movies' : 'Watch events';
            const inTheaterLabel = document.getElementById('dash-general-in-theater-label');
            if (inTheaterLabel) inTheaterLabel.textContent = dashboardGeneralMode === 'unique' ? 'Unique movies' : 'Watch events';
        }

        function syncDashboardGeneralPieUI() {
            const mode = String(dashboardGeneralPieMode || '').trim().toLowerCase();
            dashboardGeneralPieMode = (mode === 'decade' || mode === 'genre') ? mode : 'mpa';

            const wrap = document.getElementById('dash-general-pie-toggle');
            if (wrap) {
                wrap.querySelectorAll('button[data-pie]').forEach((btn) => {
                    const isOn = String(btn.dataset.pie || '').trim().toLowerCase() === dashboardGeneralPieMode;
                    btn.classList.remove('btn-glass', 'btn-outline');
                    btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
                });
            }

            const title = document.getElementById('dash-general-pie-title');
            if (title) {
                title.textContent = dashboardGeneralPieMode === 'decade'
                    ? 'Decade Share'
                    : (dashboardGeneralPieMode === 'genre' ? 'Genre Share' : 'MPA Share');
            }

            renderDashboardGeneralSharePie();
        }

        function syncDashboardChartsTabUI() {
            const t = String(dashboardChartsTab || '').trim().toLowerCase();
            const allowed = new Set(['heatmap', 'activity']);
            dashboardChartsTab = allowed.has(t) ? t : 'heatmap';

            const wrap = document.getElementById('dash-chart-tab-wrap');
            if (!wrap) return;
            wrap.querySelectorAll('button[data-chart]').forEach((btn) => {
                const isOn = String(btn.dataset.chart || '').trim().toLowerCase() === dashboardChartsTab;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
            });
            syncDashboardHeatmapSelectUI();
        }

        function syncDashboardRatingsChartUI() {
            const t = String(dashboardRatingsChartTab || '').trim().toLowerCase();
            const allowed = new Set(['genre', 'decade', 'mpa']);
            dashboardRatingsChartTab = allowed.has(t) ? t : 'genre';

            const wrap = document.getElementById('dash-ratings-chart-tab-wrap');
            if (wrap) {
                wrap.querySelectorAll('button[data-chart]').forEach((btn) => {
                    const isOn = String(btn.dataset.chart || '').trim().toLowerCase() === dashboardRatingsChartTab;
                    btn.classList.remove('btn-glass', 'btn-outline');
                    btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
                });
            }

            const title = document.getElementById('dash-ratings-chart-title');
            if (title) title.textContent = dashRatingsChartTitleForTab(dashboardRatingsChartTab);
        }

        function setDashboardFavoritesMetric(metric) {
            const m = String(metric || '').trim().toLowerCase();
            const allowed = new Set(['overall', 'sound', 'plot', 'pace', 'acting', 'imagery', 'dialogue']);
            dashboardFavoritesMetric = allowed.has(m) ? m : 'overall';

            // The Favorites poster meta line shows the selected metric. Clear cached rating rows so we
            // always have the needed columns for the currently selected metric.
            try {
                dashRatingCacheByMovieId.clear();
            } catch (_) {}

            const wrap = document.getElementById('dash-fav-metric-wrap');
            if (wrap) {
                wrap.querySelectorAll('button[data-metric]').forEach((btn) => {
                    const isOn = String(btn.dataset.metric || '').trim().toLowerCase() === dashboardFavoritesMetric;
                    btn.classList.remove('btn-glass', 'btn-outline');
                    btn.classList.add(isOn ? 'btn-glass' : 'btn-outline');
                });
            }

            if (dashboardActiveTab === 'favorites') {
                setDashboardTab('favorites');
            }
        }

        function setDashboardFavoritesLimit(limit) {
            const n = Number(limit);
            dashboardFavoritesLimit = n === 10 ? 10 : 5;
            syncDashboardFavoritesLimitUI();

            if (dashboardActiveTab === 'favorites') {
                loadDashboardFavorites();
            }
        }

        function setDashboardGeneralMode(mode) {
            const m = String(mode || '').trim().toLowerCase();
            const allowed = new Set(['total', 'unique']);
            dashboardGeneralMode = allowed.has(m) ? m : 'total';
            syncDashboardGeneralModeUI();

            if (dashboardActiveTab === 'general') {
                loadDashboardGeneral();
            }
        }

        function setDashboardGeneralPieMode(mode) {
            const m = String(mode || '').trim().toLowerCase();
            dashboardGeneralPieMode = (m === 'decade' || m === 'genre') ? m : 'mpa';
            syncDashboardGeneralPieUI();
        }

        function setDashboardChartsTab(chart) {
            const t = String(chart || '').trim().toLowerCase();
            const allowed = new Set(['heatmap', 'activity']);
            dashboardChartsTab = allowed.has(t) ? t : 'heatmap';
            syncDashboardChartsTabUI();

            if (dashboardActiveTab === 'charts') {
                if (dashboardChartsLastData) {
                    renderDashboardChartsFromData(dashboardChartsLastData);
                } else {
                    loadDashboardCharts();
                }
            }
        }

        function syncDashboardHeatmapSelectUI() {
            const allowed = new Set(['genre_decade', 'genre_mpa', 'decade_mpa']);
            const value = allowed.has(String(dashboardHeatmapPair || '').trim().toLowerCase())
                ? String(dashboardHeatmapPair || '').trim().toLowerCase()
                : 'genre_decade';
            dashboardHeatmapPair = value;

            const select = document.getElementById('dash-heatmap-pair');
            if (select && select.value !== value) select.value = value;

            const wrap = document.getElementById('dash-heatmap-select-wrap');
            if (wrap) {
                wrap.style.display = dashboardChartsTab === 'heatmap' ? 'block' : 'none';
            }
        }

        function setDashboardHeatmapPair(value) {
            const allowed = new Set(['genre_decade', 'genre_mpa', 'decade_mpa']);
            dashboardHeatmapPair = allowed.has(String(value || '').trim().toLowerCase())
                ? String(value || '').trim().toLowerCase()
                : 'genre_decade';
            syncDashboardHeatmapSelectUI();

            if (dashboardActiveTab === 'charts' && dashboardChartsTab === 'heatmap') {
                if (dashboardChartsLastData) {
                    renderDashboardChartsFromData(dashboardChartsLastData);
                } else {
                    loadDashboardCharts();
                }
            }
        }

        function setDashboardRatingsChartTab(chart) {
            const t = String(chart || '').trim().toLowerCase();
            const allowed = new Set(['genre', 'decade', 'mpa']);
            dashboardRatingsChartTab = allowed.has(t) ? t : 'genre';
            syncDashboardRatingsChartUI();

            if (dashboardActiveTab === 'ratings') {
                if (dashboardRatingsChartsLastData) {
                    renderDashboardRatingsChartsFromData(dashboardRatingsChartsLastData);
                } else {
                    loadDashboardRatings();
                }
            }
        }

        function initDashboardTimeframe() {
            const wrap = document.getElementById('dash-range-all-time')?.parentElement;
            if (!wrap) return;
            if (wrap.dataset.boundClicks) return;
            wrap.dataset.boundClicks = 'true';

            wrap.addEventListener('click', (e) => {
                const btn = e?.target?.closest ? e.target.closest('button[data-range]') : null;
                const range = btn?.dataset?.range;
                if (!range) return;
                setDashboardTimeframe(range);
            });
        }

        function setDashboardTimeframe(range) {
            const r = String(range || '').trim().toLowerCase();
            const allowed = new Set(['all_time', 'this_year', 'this_month']);
            dashboardTimeframe = allowed.has(r) ? r : 'all_time';

            const btnAll = document.getElementById('dash-range-all-time');
            const btnYear = document.getElementById('dash-range-this-year');
            const btnMonth = document.getElementById('dash-range-this-month');
            const activate = (btn, on) => {
                if (!btn) return;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(on ? 'btn-glass' : 'btn-outline');
            };
            activate(btnAll, dashboardTimeframe === 'all_time');
            activate(btnYear, dashboardTimeframe === 'this_year');
            activate(btnMonth, dashboardTimeframe === 'this_month');

            // Reload the active tab under the new timeframe.
            setDashboardTab(dashboardActiveTab);
        }

        async function setDashboardTab(tab) {
            if (!cachedIsAuthed) {
                openDashboardAuthWarning();
                return;
            }
            const t = String(tab || '').trim().toLowerCase();
            dashboardActiveTab = t || 'general';
            const tabGeneral = document.getElementById('dash-tab-general');
            const tabRatings = document.getElementById('dash-tab-ratings');
            const tabTiers = document.getElementById('dash-tab-tiers');
            const tabFavorites = document.getElementById('dash-tab-favorites');
            const tabCharts = document.getElementById('dash-tab-charts');
            const tabQuotes = document.getElementById('dash-tab-quotes');
            const paneGeneral = document.getElementById('dash-pane-general');
            const paneRatings = document.getElementById('dash-pane-ratings');
            const paneTiers = document.getElementById('dash-pane-tiers');
            const paneFavorites = document.getElementById('dash-pane-favorites');
            const paneCharts = document.getElementById('dash-pane-charts');
            const paneQuotes = document.getElementById('dash-pane-quotes');
            const favMetricPanel = document.getElementById('dash-fav-metric-panel');
            const chartTabPanel = document.getElementById('dash-chart-tab-panel');
            const generalModePanel = document.getElementById('dash-general-mode-panel');
            if (!tabGeneral || !tabRatings || !tabTiers || !tabFavorites || !tabCharts || !tabQuotes || !paneGeneral || !paneRatings || !paneTiers || !paneFavorites || !paneCharts || !paneQuotes) return;

            const activate = (btn, on) => {
                if (!btn) return;
                btn.classList.remove('btn-glass', 'btn-outline');
                btn.classList.add(on ? 'btn-glass' : 'btn-outline');
            };

            const show = (pane, on) => {
                if (!pane) return;
                if (on) pane.classList.remove('hidden');
                else pane.classList.add('hidden');
            };

            activate(tabGeneral, t === 'general');
            activate(tabRatings, t === 'ratings');
            activate(tabTiers, t === 'tiers');
            activate(tabFavorites, t === 'favorites');
            activate(tabCharts, t === 'charts');
            activate(tabQuotes, t === 'quotes');

            show(paneGeneral, t === 'general');
            show(paneRatings, t === 'ratings');
            show(paneTiers, t === 'tiers');
            show(paneFavorites, t === 'favorites');
            show(paneCharts, t === 'charts');
            show(paneQuotes, t === 'quotes');

            // Favorites-only header controls
            if (favMetricPanel) {
                if (t === 'favorites') favMetricPanel.classList.remove('hidden');
                else favMetricPanel.classList.add('hidden');
            }
            if (chartTabPanel) {
                if (t === 'charts') chartTabPanel.classList.remove('hidden');
                else chartTabPanel.classList.add('hidden');
            }
            if (generalModePanel) {
                if (t === 'general') generalModePanel.classList.remove('hidden');
                else generalModePanel.classList.add('hidden');
            }

            if (t === 'charts') {
                syncDashboardChartsTabUI();
            }
            if (t === 'general') {
                syncDashboardGeneralModeUI();
                syncDashboardGeneralPieUI();
            }

            if (t === 'general') {
                await loadDashboardGeneral();
            } else if (t === 'ratings') {
                await loadDashboardRatings();
            } else if (t === 'tiers') {
                await loadDashboardTiers();
            } else if (t === 'favorites') {
                await loadDashboardFavorites();
            } else if (t === 'charts') {
                await loadDashboardCharts();
            } else if (t === 'quotes') {
                await loadDashboardQuoteWall();
            }
        }

        async function loadDashboardFavorites() {
            const elTop = document.getElementById('dash-fav-top');
            const elBottom = document.getElementById('dash-fav-bottom');
            if (!elTop || !elBottom) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                elTop.innerHTML = `<div class="text-gray">Log in to view favorites.</div>`;
                elBottom.innerHTML = `<div class="text-gray">Log in to view favorites.</div>`;
                return;
            }

            elTop.innerHTML = `<div class="text-gray">Loading</div>`;
            elBottom.innerHTML = `<div class="text-gray">Loading</div>`;

            const metricFieldForFavorites = (metric) => {
                const m = String(metric || '').trim().toLowerCase();
                if (m === 'sound') return { field: 'sound_rating', label: 'Sound' };
                if (m === 'plot') return { field: 'plot_rating', label: 'Plot' };
                if (m === 'pace') return { field: 'pacing_rating', label: 'Pace' };
                if (m === 'acting') return { field: 'acting_rating', label: 'Acting' };
                if (m === 'imagery') return { field: 'imagery_rating', label: 'Imagery' };
                if (m === 'dialogue') return { field: 'dialogue_rating', label: 'Dialogue' };
                return { field: 'overall_rating', label: 'Overall' };
            };

            const ensureRatingsForItems = async (items) => {
                const safe = Array.isArray(items) ? items : [];
                const ids = Array.from(new Set(
                    safe
                        .map((r) => r?.movie_id)
                        .filter(Boolean)
                ));
                const missing = ids.filter((id) => !dashRatingCacheByMovieId.has(id));
                if (missing.length === 0) return;

                const { data, error } = await supabaseClient
                    .from('Movie Ratings')
                    .select('movie_id, overall_rating, sound_rating, plot_rating, pacing_rating, acting_rating, imagery_rating, dialogue_rating, tier')
                    .eq('user_id', authedUser.id)
                    .in('movie_id', missing);

                if (error) throw error;

                const rows = Array.isArray(data) ? data : [];
                const byId = new Map(rows.map((r) => [r.movie_id, r]));
                for (const id of missing) {
                    dashRatingCacheByMovieId.set(id, byId.get(id) || null);
                }
            };

            const renderRow = async (items) => {
                const limit = Number(dashboardFavoritesLimit) === 10 ? 10 : 5;
                const safe = Array.isArray(items) ? items.slice(0, limit) : [];
                if (safe.length === 0) {
                    return `<div class="text-gray">No rated movies found for this timeframe.</div>`;
                }

                // Posters are lazy-loaded from stored DB poster_path.
                await ensureRatingsForItems(safe);

                // Ensure we have poster_path from Movies even if the RPC doesn't return it.
                const ensuredPosterPaths = await Promise.all(safe.map((r) => dashEnsurePosterPath(r)));

                const cards = safe.map((r, idx) => {
                    const title = String(r?.title ?? '').trim() || 'Untitled';
                    const year = (r?.release_year === null || r?.release_year === undefined) ? '' : String(r.release_year);
                    const ratingRow = dashRatingCacheByMovieId.get(r?.movie_id) || null;

                    const dashMovieId = String(r?.movie_id ?? '').trim();
                    const dashTmdbId = (r?.tmdb_id === null || r?.tmdb_id === undefined) ? '' : String(r.tmdb_id);

                    const { field: metricField, label: metricLabel } = metricFieldForFavorites(dashboardFavoritesMetric);
                    const metricValue = ratingRow ? ratingRow?.[metricField] : null;
                    const metricText = dashFormatScore(metricValue);
                    const tierLabel = dashNormalizeTierLabel(ratingRow ? ratingRow.tier : '');
                    const tmdb_id = Number(r?.tmdb_id);
                    const ensured = ensuredPosterPaths[idx] || '';
                    const poster_path = dashNormalizePosterPath(ensured || String(r?.poster_path ?? '').trim() || (Number.isFinite(tmdb_id) ? (dashPosterCacheByTmdbId.get(tmdb_id) || '') : ''));
                    const posterUrl = dashBuildPosterUrl(poster_path, 'w342');

                    const metaHtml = dashJoinHelpParts([
                        year ? escapeHtml(year) : '',
                        metricText ? `${dashRenderHelpScore(metricText)} ${escapeHtml(metricLabel)}` : '',
                        tierLabel ? dashRenderHelpTier(tierLabel) : '',
                    ]);

                    return `
                        <div style="display:flex; flex-direction: column; gap: 8px;">
                            <div
                                data-dash-movie-id="${escapeHtml(dashMovieId)}"
                                data-dash-tmdb-id="${escapeHtml(dashTmdbId)}"
                                data-dash-movie-title="${escapeHtml(title)}"
                                data-dash-poster-path="${escapeHtml(poster_path)}"
                                role="button"
                                tabindex="0"
                                aria-label="Update Ratings for ${escapeHtml(title)}"
                                style="width: 100%; aspect-ratio: 2/3; border-radius: 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); cursor: pointer;"
                            >
                                ${posterUrl
                                    ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.closest('div')?.remove?.()">`
                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`
                                }
                            </div>
                            <div class="text-sm text-white" style="font-weight: 700; line-height: 1.2;">${escapeHtml(title)}</div>
                            <div class="text-xs text-gray tabular-nums">${metaHtml}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="dash-fav-grid">
                        ${cards}
                    </div>
                `;
            };

            try {
                let res = await supabaseClient.rpc('get_dashboard_favorites', {
                    p_timeframe: dashboardTimeframe,
                    p_metric: dashboardFavoritesMetric,
                    p_limit: dashboardFavoritesLimit,
                });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const missingRpc = /get_dashboard_favorites/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (missingRpc) {
                        elTop.innerHTML = `<div class="text-gray">Favorites RPC missing. Run dashboard_rpc.sql to add get_dashboard_favorites.</div>`;
                        elBottom.innerHTML = `<div class="text-gray">Favorites RPC missing. Run dashboard_rpc.sql to add get_dashboard_favorites.</div>`;
                        return;
                    }
                    const looksLikeOldSignature = /get_dashboard_favorites/i.test(msg) && /no function matches|function .* does not exist/i.test(msg);
                    if (looksLikeOldSignature) {
                        res = await supabaseClient.rpc('get_dashboard_favorites', {
                            p_timeframe: dashboardTimeframe,
                            p_metric: dashboardFavoritesMetric,
                        });
                    }
                }
                if (res?.error) throw res.error;

                const data = res?.data;
                const top = Array.isArray(data?.top) ? data.top : [];
                const bottom = Array.isArray(data?.bottom) ? data.bottom : [];

                elTop.innerHTML = await renderRow(top);
                elBottom.innerHTML = await renderRow(bottom);
            } catch (err) {
                showToast(`Dashboard (Favorites) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard favorites load failed', err);
                elTop.innerHTML = `<div class="text-gray">Unable to load favorites right now.</div>`;
                elBottom.innerHTML = `<div class="text-gray">Unable to load favorites right now.</div>`;
            }
        }

        function dashChartFormatPct(n) {
            const num = Number(n);
            if (!Number.isFinite(num)) return '';
            return `${(Math.round(num * 10) / 10).toFixed(1)}%`;
        }

        function dashChartFormatCount(n) {
            const num = Number(n);
            if (!Number.isFinite(num)) return '0 movies';
            return `${num} movie${num === 1 ? '' : 's'}`;
        }

        function dashComputeActivityMax(items) {
            const rows = Array.isArray(items) ? items : [];
            let maxCount = 0;
            rows.forEach((r) => {
                const count = Number(r?.count ?? 0);
                if (Number.isFinite(count) && count > maxCount) maxCount = count;
            });
            return maxCount;
        }

        function dashRenderActivityHeatmap(items, timeframe, maxCountOverride) {
            const rows = Array.isArray(items) ? items : [];
            if (!rows.length) return `<div class="text-gray">No activity yet.</div>`;

            const countsByDate = new Map();
            let minDate = null;
            let maxDate = null;
            let maxCount = 0;

            rows.forEach((r) => {
                const raw = String(r?.bucket ?? r?.date ?? '').slice(0, 10);
                if (!raw) return;
                const parsed = new Date(`${raw}T00:00:00`);
                if (Number.isNaN(parsed.getTime())) return;
                const count = Number(r?.count ?? 0);
                const safeCount = Number.isFinite(count) ? count : 0;
                countsByDate.set(raw, safeCount);
                if (!minDate || parsed < minDate) minDate = parsed;
                if (!maxDate || parsed > maxDate) maxDate = parsed;
                if (safeCount > maxCount) maxCount = safeCount;
            });

            if (!minDate || !maxDate) return `<div class="text-gray">No activity yet.</div>`;

            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sept','Oct','Nov','Dec'];
            const startYear = minDate.getFullYear();
            const endYear = maxDate.getFullYear();
            const weekMs = 7 * 24 * 60 * 60 * 1000;
            const tf = String(timeframe || '').trim().toLowerCase();
            const effectiveMax = Number.isFinite(maxCountOverride) && maxCountOverride > 0 ? maxCountOverride : maxCount;
            const maxLevels = 10;
            const dynamicLevels = Math.max(1, Math.min(maxLevels, Math.floor(effectiveMax)));
            const mapLevel = (step) => {
                if (dynamicLevels <= 1) return maxLevels;
                const spread = 1 + Math.round(((step - 1) * (maxLevels - 1)) / (dynamicLevels - 1));
                return Math.min(maxLevels, Math.max(1, spread));
            };
            const getLevel = (count) => {
                if (!Number.isFinite(count) || count <= 0 || effectiveMax <= 0) return 0;
                if (effectiveMax <= maxLevels) {
                    const step = Math.min(dynamicLevels, count);
                    return mapLevel(step);
                }
                return Math.min(maxLevels, Math.ceil((count / effectiveMax) * maxLevels));
            };
            const buildLegendRanges = () => {
                if (!Number.isFinite(effectiveMax) || effectiveMax <= 0) {
                    return [];
                }
                if (effectiveMax <= maxLevels) {
                    return Array.from({ length: dynamicLevels }, (_, i) => ({ min: i + 1, max: i + 1 }));
                }
                const ranges = [];
                let prev = 1;
                for (let i = 1; i <= maxLevels; i += 1) {
                    const upper = Math.max(prev, Math.ceil((effectiveMax * i) / maxLevels));
                    ranges.push({ min: prev, max: upper });
                    prev = upper + 1;
                }
                return ranges;
            };
            const legendRanges = buildLegendRanges();
            const yearRows = [];

            if (tf === 'this_month') {
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                const monthLabel = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
                const weekdayLabels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

                const cells = [];
                const leadingBlanks = monthStart.getDay();
                for (let i = 0; i < leadingBlanks; i += 1) {
                    cells.push(
                        `<div class="dash-heatmap-day-wrap">
                            <div class="dash-heatmap-day-label"></div>
                            <div class="dash-heatmap-cell is-month is-empty"></div>
                        </div>`
                    );
                }
                const cursor = new Date(monthStart);
                while (cursor < monthEnd) {
                    const dateKey = `${cursor.getFullYear()}-${String(cursor.getMonth() + 1).padStart(2, '0')}-${String(cursor.getDate()).padStart(2, '0')}`;
                    const count = countsByDate.get(dateKey) || 0;
                    const level = getLevel(count);
                    const levelClass = level > 0 ? `dash-heatmap-l${level}` : '';
                    const dayNum = cursor.getDate();
                    const title = `${dateKey}  ${count} movie${count === 1 ? '' : 's'}`;
                    cells.push(
                        `<div class="dash-heatmap-day-wrap">
                            <div class="dash-heatmap-day-label">${dayNum}</div>
                            <div class="dash-heatmap-cell is-month ${levelClass}" title="${escapeHtml(title)}"></div>
                        </div>`
                    );
                    cursor.setDate(cursor.getDate() + 1);
                }

                yearRows.push(`
                    <div class="dash-heatmap-month">
                        <div class="dash-heatmap-month-title">${escapeHtml(monthLabel)}</div>
                        <div class="dash-heatmap-weekdays">
                            ${weekdayLabels.map((d) => `<div>${escapeHtml(d)}</div>`).join('')}
                        </div>
                        <div class="dash-heatmap-month-grid">
                            ${cells.join('')}
                        </div>
                    </div>
                `);
            } else {
                const years = [];
                for (let year = startYear; year <= endYear; year += 1) years.push(year);
                if (tf === 'all_time') years.reverse();

                years.forEach((year) => {
                    const yearStart = new Date(year, 0, 1);
                    const yearEnd = new Date(year + 1, 0, 1);

                    const gridStart = new Date(yearStart);
                    gridStart.setDate(gridStart.getDate() - gridStart.getDay());
                    const gridEnd = new Date(yearEnd);
                    gridEnd.setDate(gridEnd.getDate() + (6 - gridEnd.getDay()));

                    const monthLabels = [];
                    for (let m = 0; m < 12; m += 1) {
                        const monthStart = new Date(year, m, 1);
                        if (monthStart < yearStart || monthStart >= yearEnd) continue;
                        const weekIndex = Math.floor((monthStart - gridStart) / weekMs) + 1;
                        monthLabels.push(
                            `<div class="dash-heatmap-month-label" style="--month-col:${weekIndex};">${monthNames[m]}</div>`
                        );
                    }

                    const cells = [];
                    const cursor = new Date(gridStart);
                    while (cursor <= gridEnd) {
                        const inYear = cursor >= yearStart && cursor < yearEnd;
                        const dateKey = `${cursor.getFullYear()}-${String(cursor.getMonth() + 1).padStart(2, '0')}-${String(cursor.getDate()).padStart(2, '0')}`;
                        const count = inYear ? (countsByDate.get(dateKey) || 0) : 0;
                        const level = getLevel(count);
                        const levelClass = level > 0 ? `dash-heatmap-l${level}` : '';
                        const emptyClass = inYear ? '' : 'is-empty';
                        const title = inYear ? `${dateKey}  ${count} movie${count === 1 ? '' : 's'}` : '';
                        cells.push(
                            `<div class="dash-heatmap-cell ${levelClass} ${emptyClass}" title="${escapeHtml(title)}"></div>`
                        );
                        cursor.setDate(cursor.getDate() + 1);
                    }

                    yearRows.push(`
                        <div class="dash-heatmap-row">
                            <div class="dash-heatmap-year">${escapeHtml(String(year))}</div>
                            <div class="dash-heatmap-year-grid">
                                <div class="dash-heatmap-months">${monthLabels.join('')}</div>
                                <div class="dash-heatmap-weeks">${cells.join('')}</div>
                            </div>
                        </div>
                    `);
                });
            }
            const legendItems = legendRanges.map((range, idx) => {
                const label = range.min === range.max ? `${range.min}` : `${range.min}-${range.max}`;
                const level = effectiveMax <= maxLevels ? mapLevel(idx + 1) : Math.min(idx + 1, maxLevels);
                return `<span class="dash-heatmap-legend-item"><span class="dash-heatmap-legend-swatch dash-heatmap-l${level}"></span><span class="dash-heatmap-legend-label">${label}</span></span>`;
            }).join('');

            const legend = `
                <div class="dash-heatmap-legend top-right">
                    <span>Less</span>
                    <span class="dash-heatmap-legend-item"><span class="dash-heatmap-legend-swatch is-empty"></span><span class="dash-heatmap-legend-label">0</span></span>
                    ${legendItems}
                    <span>More</span>
                </div>
            `;

            return `
                <div class="dash-heatmap ${tf === 'this_month' ? 'is-month-view' : ''}">
                    ${legend}
                    ${yearRows.join('')}
                </div>
            `;
        }

        function dashGetHeatmapHslVars() {
            const style = getComputedStyle(document.documentElement);
            const hRaw = String(style.getPropertyValue('--heatmap-h') || '').trim();
            const sRaw = String(style.getPropertyValue('--heatmap-s') || '').trim();
            const h = Number(hRaw);
            const s = Number(sRaw.replace('%', ''));
            return {
                h: Number.isFinite(h) ? h : 156,
                s: Number.isFinite(s) ? s : 55,
            };
        }

        function dashGenreHeatmapCellClass(avg, minAvg, maxAvg) {
            const val = Number(avg);
            if (!Number.isFinite(val)) return '';
            if (val <= 0) return '';
            const clamped = Math.max(0, Math.min(100, val));
            const bucket = Math.min(10, Math.max(1, Math.ceil(clamped / 10)));
            return `dash-heatmap-l${bucket}`;
        }

        function dashHeatmapAxisLabel(axis) {
            const a = String(axis || '').trim().toLowerCase();
            if (a === 'decade') return 'Decade';
            if (a === 'mpa') return 'MPA';
            return 'Genre';
        }

        function dashHeatmapPairTitle(pair) {
            const p = String(pair || '').trim().toLowerCase();
            if (p === 'genre_mpa') return 'Genre/MPA Heatmap';
            if (p === 'decade_mpa') return 'MPA/Decade Heatmap';
            return 'Genre/Decade Heatmap';
        }

        function dashHeatmapAxisValueLabel(axis, value) {
            const a = String(axis || '').trim().toLowerCase();
            if (a === 'decade') {
                const num = Number(value);
                return Number.isFinite(num) ? `${num}s` : '';
            }
            return String(value ?? '').trim() || '';
        }

        function dashHeatmapNormalizeAxisValue(axis, raw) {
            const a = String(axis || '').trim().toLowerCase();
            if (a === 'decade') {
                const num = Number(raw);
                return Number.isFinite(num) ? num : null;
            }
            const str = String(raw ?? '').trim();
            return str ? str : null;
        }

        function dashHeatmapAxisSortValue(axis, value) {
            const a = String(axis || '').trim().toLowerCase();
            if (a === 'decade') {
                const num = Number(value);
                return Number.isFinite(num) ? num : 99999;
            }
            if (a === 'mpa') {
                const order = ['G', 'PG', 'PG-13', 'PG13', 'R', 'NC-17', 'NC17', 'UNRATED', 'NR', 'NOTRATED'];
                const normalized = String(value ?? '').trim().toUpperCase().replace(/\s+/g, '');
                const idx = order.indexOf(normalized);
                return idx === -1 ? 99999 : idx;
            }
            return String(value ?? '').trim().toLowerCase();
        }

        function dashHeatmapValueCompare(axis, a, b) {
            const aKey = dashHeatmapAxisSortValue(axis, a);
            const bKey = dashHeatmapAxisSortValue(axis, b);
            if (typeof aKey === 'number' && typeof bKey === 'number' && aKey !== bKey) return aKey - bKey;
            const aStr = String(a ?? '').trim().toLowerCase();
            const bStr = String(b ?? '').trim().toLowerCase();
            return aStr.localeCompare(bStr);
        }

        function dashRenderAxisHeatmap({ items, rowAxis, colAxis }) {
            const rows = Array.isArray(items) ? items : [];
            if (!rows.length) return `<div class="text-gray">No data yet.</div>`;

            const colSet = new Set();
            const rowStats = new Map();
            const cellMap = new Map();

            rows.forEach((r) => {
                const rowVal = dashHeatmapNormalizeAxisValue(rowAxis, r?.[rowAxis]);
                const colVal = dashHeatmapNormalizeAxisValue(colAxis, r?.[colAxis]);
                const avg = Number(r?.avg);
                const n = Number(r?.n ?? 0);
                if (rowVal === null || colVal === null || !Number.isFinite(avg)) return;

                colSet.add(colVal);
                cellMap.set(`${String(rowVal)}||${String(colVal)}`, { avg, n });

                const weight = Number.isFinite(n) && n > 0 ? n : 1;
                const stat = rowStats.get(rowVal) || { sum: 0, count: 0 };
                stat.sum += avg * weight;
                stat.count += weight;
                rowStats.set(rowVal, stat);
            });

            const cols = Array.from(colSet).sort((a, b) => dashHeatmapValueCompare(colAxis, a, b));
            const rowsSorted = Array.from(rowStats.entries())
                .map(([key, stat]) => ({
                    key,
                    avg: stat.count ? (stat.sum / stat.count) : 0,
                }))
                .sort((a, b) => {
                    if (rowAxis === 'genre') {
                        if (b.avg !== a.avg) return b.avg - a.avg;
                    }
                    if (rowAxis === 'decade') {
                        return dashHeatmapValueCompare(rowAxis, a.key, b.key);
                    }
                    if (rowAxis === 'mpa') {
                        return dashHeatmapValueCompare(rowAxis, a.key, b.key);
                    }
                    return dashHeatmapValueCompare(rowAxis, a.key, b.key);
                })
                .map((r) => r.key);

            if (!cols.length || !rowsSorted.length) return `<div class="text-gray">No data yet.</div>`;

            const gridTemplate = `minmax(120px, 1fr) repeat(${cols.length}, minmax(52px, 1fr))`;
            const header = `
                <div class="dash-genre-heatmap-header" style="grid-template-columns: ${gridTemplate};">
                    <div class="dash-genre-heatmap-label">${escapeHtml(dashHeatmapAxisLabel(rowAxis))}</div>
                    ${cols.map((c) => `<div class="dash-heatmap-col-label">${escapeHtml(dashHeatmapAxisValueLabel(colAxis, c))}</div>`).join('')}
                </div>
            `;

            const body = rowsSorted.map((rowVal) => {
                const rowLabel = dashHeatmapAxisValueLabel(rowAxis, rowVal);
                const cells = cols.map((colVal) => {
                    const cell = cellMap.get(`${String(rowVal)}||${String(colVal)}`);
                    if (!cell) {
                        return `<div class="dash-genre-heatmap-cell is-empty"></div>`;
                    }
                    const avg = Number(cell.avg);
                    const n = Number(cell.n ?? 0);
                    const levelClass = dashGenreHeatmapCellClass(avg);
                    const colLabel = dashHeatmapAxisValueLabel(colAxis, colVal);
                    const title = `${rowLabel}  ${colLabel}  ${dashChartFormatPct(avg)}  ${dashChartFormatCount(n)}`;
                    return `
                        <div class="dash-genre-heatmap-cell ${escapeHtml(levelClass)}" title="${escapeHtml(title)}">
                            <span class="dash-genre-heatmap-value">${escapeHtml(dashChartFormatPct(avg))}</span>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="dash-genre-heatmap-row" style="grid-template-columns: ${gridTemplate};">
                        <div class="dash-genre-heatmap-label">${escapeHtml(rowLabel)}</div>
                        ${cells}
                    </div>
                `;
            }).join('');

            return `
                <div class="dash-genre-heatmap-wrap">
                    <div class="dash-genre-heatmap">
                        ${header}
                        ${body}
                    </div>
                </div>
            `;
        }


        function dashChartTitleForTab(tab) {
            const t = String(tab || '').trim().toLowerCase();
            if (t === 'heatmap') {
                return dashHeatmapPairTitle(dashboardHeatmapPair);
            }
            if (t === 'activity') return 'Watch Activity Calendar';
            return 'Genre/Decade Heatmap';
        }

        function dashRatingsChartTitleForTab(tab) {
            const t = String(tab || '').trim().toLowerCase();
            if (t === 'decade') return 'Average Rating by Decade';
            if (t === 'mpa') return 'Average Rating by MPA';
            return 'Average Rating by Genre';
        }

        function renderDashboardChartsFromData(data) {
            const elTitle = document.getElementById('dash-chart-title');
            const elBody = document.getElementById('dash-chart-body');
            if (!elTitle || !elBody) return;

            const payload = data || {};
            const genreHeatmap = Array.isArray(payload?.genre_heatmap) ? payload.genre_heatmap : [];
            const genreMpaHeatmap = Array.isArray(payload?.genre_mpa_heatmap) ? payload.genre_mpa_heatmap : [];
            const decadeMpaHeatmap = Array.isArray(payload?.decade_mpa_heatmap) ? payload.decade_mpa_heatmap : [];
            const activity = Array.isArray(payload?.activity) ? payload.activity : [];

            const tab = String(dashboardChartsTab || '').trim().toLowerCase();

            if (tab === 'activity') {
                elTitle.textContent = 'Watch Activity Calendar';
                elBody.innerHTML = dashRenderActivityHeatmap(activity, dashboardTimeframe, dashboardChartsActivityMax);
                return;
            }
            const pair = String(dashboardHeatmapPair || '').trim().toLowerCase();
            let heatmap = genreHeatmap;
            let axisA = 'genre';
            let axisB = 'decade';
            if (pair === 'genre_mpa') {
                heatmap = genreMpaHeatmap;
                axisA = 'genre';
                axisB = 'mpa';
            } else if (pair === 'decade_mpa') {
                heatmap = decadeMpaHeatmap;
                axisA = 'mpa';
                axisB = 'decade';
            }

            const chooseAxes = (items, a, b) => {
                const aSet = new Set();
                const bSet = new Set();
                (Array.isArray(items) ? items : []).forEach((r) => {
                    const aVal = dashHeatmapNormalizeAxisValue(a, r?.[a]);
                    const bVal = dashHeatmapNormalizeAxisValue(b, r?.[b]);
                    if (aVal !== null) aSet.add(aVal);
                    if (bVal !== null) bSet.add(bVal);
                });
                if (bSet.size > aSet.size) return { row: b, col: a };
                if (aSet.size > bSet.size) return { row: a, col: b };
                return { row: a, col: b };
            };

            const axes = chooseAxes(heatmap, axisA, axisB);
            elTitle.textContent = dashChartTitleForTab('heatmap');
            elBody.innerHTML = dashRenderAxisHeatmap({ items: heatmap, rowAxis: axes.row, colAxis: axes.col });
        }

        function renderDashboardRatingsChartsFromData(data) {
            const elTitle = document.getElementById('dash-ratings-chart-title');
            const elBody = document.getElementById('dash-ratings-genre-bars');
            if (!elTitle || !elBody) return;

            const payload = data || {};
            const genres = Array.isArray(payload?.genres) ? payload.genres : [];
            const decades = Array.isArray(payload?.decades) ? payload.decades : [];
            const mpa = Array.isArray(payload?.mpa) ? payload.mpa : [];

            const tab = String(dashboardRatingsChartTab || '').trim().toLowerCase();
            elTitle.textContent = dashRatingsChartTitleForTab(tab);

            if (tab === 'decade') {
                const items = decades.map((r) => ({
                    label: r?.decade !== null && r?.decade !== undefined ? `${String(r.decade)}s` : '',
                    avg: Number(r?.avg ?? 0),
                    n: Number(r?.n ?? 0),
                }));
                elBody.innerHTML = dashRenderVerticalBars({
                    items,
                    labelKey: 'label',
                    valueKey: 'avg',
                    countKey: 'n',
                    barType: 'decade',
                });
                return;
            }

            if (tab === 'mpa') {
                const items = mpa.map((r) => ({
                    label: r?.mpa ?? '',
                    avg: Number(r?.avg ?? 0),
                    n: Number(r?.n ?? 0),
                }));
                elBody.innerHTML = dashRenderVerticalBars({
                    items,
                    labelKey: 'label',
                    valueKey: 'avg',
                    countKey: 'n',
                    barType: 'mpa',
                });
                return;
            }

            const allItems = genres.map((r) => ({
                label: r?.genre ?? '',
                avg: Number(r?.avg ?? 0),
                n: Number(r?.n ?? 0),
            }));
            const limit = 10;
            const showAll = Boolean(dashboardRatingsShowAllGenres);
            const items = showAll ? allItems : allItems.slice(0, limit);
            const showToggle = allItems.length > limit;
            const toggleLabel = showAll ? 'Show Top 10' : 'Show All';
            const barsHtml = dashRenderVerticalBars({
                items,
                labelKey: 'label',
                valueKey: 'avg',
                countKey: 'n',
                barType: 'genre',
            });
            elBody.innerHTML = `
                <div>
                    ${showToggle ? `
                        <div class="dash-genre-bars-toggle">
                            <button type="button" class="btn btn-outline" id="dash-ratings-genre-toggle" style="padding: 0.35rem 0.65rem; border-radius: 0.7rem;">${toggleLabel}</button>
                        </div>
                    ` : ''}
                    ${barsHtml}
                </div>
            `;
            if (showToggle) {
                const btn = elBody.querySelector('#dash-ratings-genre-toggle');
                if (btn && !btn.dataset.bound) {
                    btn.dataset.bound = 'true';
                    btn.addEventListener('click', () => {
                        dashboardRatingsShowAllGenres = !dashboardRatingsShowAllGenres;
                        renderDashboardRatingsChartsFromData(dashboardRatingsChartsLastData || data);
                    });
                }
            }
        }

        async function loadDashboardCharts() {
            const elTitle = document.getElementById('dash-chart-title');
            const elBody = document.getElementById('dash-chart-body');
            if (!elTitle || !elBody) return;

            elTitle.textContent = dashChartTitleForTab(dashboardChartsTab);

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                elBody.innerHTML = `<div class="text-gray">Log in to view charts.</div>`;
                return;
            }

            elBody.innerHTML = `<div class="text-gray">Loading</div>`;

            try {
                let res = await supabaseClient.rpc('get_dashboard_charts', {
                    p_timeframe: dashboardTimeframe,
                });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const missingRpc = /get_dashboard_charts/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (missingRpc) {
                        const text = 'Charts RPC missing. Run dashboard_rpc.sql to add get_dashboard_charts.';
                        elBody.innerHTML = `<div class="text-gray">${text}</div>`;
                        return;
                    }
                }
                if (res?.error) throw res.error;

                const data = res?.data || {};
                dashboardChartsLastData = data;
                if (dashboardTimeframe === 'all_time') {
                    dashboardChartsActivityMax = dashComputeActivityMax(data?.activity);
                }
                if (!Number.isFinite(dashboardChartsActivityMax) || dashboardChartsActivityMax <= 0) {
                    try {
                        const allRes = await supabaseClient.rpc('get_dashboard_charts', { p_timeframe: 'all_time' });
                        if (!allRes?.error) {
                            dashboardChartsActivityMax = dashComputeActivityMax(allRes?.data?.activity);
                        }
                    } catch (_) {}
                }
                renderDashboardChartsFromData(data);
            } catch (err) {
                showToast(`Dashboard (Charts) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard charts load failed', err);
                elBody.innerHTML = `<div class="text-gray">Unable to load charts right now.</div>`;
            }
        }

        async function loadDashboardQuoteWall() {
            const elWall = document.getElementById('dash-quote-wall');
            const elMeta = document.getElementById('dash-quote-wall-meta');
            if (!elWall) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your Quote Wall.', { level: 'warn' });
                }
                elWall.innerHTML = `<div class="text-gray">Log in to view your Quote Wall.</div>`;
                if (elMeta) elMeta.textContent = '';
                return;
            }

            elWall.innerHTML = `<div class="text-gray">Loading</div>`;
            if (elMeta) elMeta.textContent = '';

            const computeRange = () => {
                const tf = String(dashboardTimeframe || 'all_time').trim().toLowerCase();
                if (tf === 'this_year') {
                    const now = new Date();
                    const start = new Date(now.getFullYear(), 0, 1);
                    const end = new Date(now.getFullYear() + 1, 0, 1);
                    return { start_date: getLocalISODate(start), end_date: getLocalISODate(end) };
                }
                if (tf === 'this_month') {
                    const now = new Date();
                    const start = new Date(now.getFullYear(), now.getMonth(), 1);
                    const end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    return { start_date: getLocalISODate(start), end_date: getLocalISODate(end) };
                }
                return { start_date: null, end_date: null };
            };

            const isNonBlank = (v) => {
                const s = String(v ?? '').trim();
                return s.length > 0;
            };

            try {
                const { start_date, end_date } = computeRange();

                let q = supabaseClient
                    .from('Movie Ratings')
                    .select('movie_id, overall_rating, tier, fav_quote, updated_at, watch_date')
                    .eq('user_id', authedUser.id)
                    .not('overall_rating', 'is', null)
                    .not('fav_quote', 'is', null)
                    .neq('fav_quote', '');

                if (start_date && end_date) {
                    q = q.gte('watch_date', start_date).lt('watch_date', end_date);
                }

                // Pull more than 50 to account for whitespace-only quotes.
                q = q
                    .order('overall_rating', { ascending: false })
                    .order('updated_at', { ascending: false })
                    .order('watch_date', { ascending: false })
                    .limit(140);

                const { data, error } = await q;
                if (error) throw error;

                const rows = Array.isArray(data) ? data : [];
                const filtered = rows
                    .filter((r) => isNonBlank(r?.fav_quote))
                    .slice(0, 50);

                if (filtered.length === 0) {
                    elWall.innerHTML = `<div class="text-gray">No quotes found. Add a Favorite Quote on a movie and it will appear here.</div>`;
                    if (elMeta) elMeta.textContent = '';
                    return;
                }

                const movieIds = Array.from(new Set(filtered.map((r) => r?.movie_id).filter(Boolean)));
                const moviesById = new Map();
                if (movieIds.length) {
                    const { data: moviesData, error: moviesErr } = await supabaseClient
                        .from('Movies')
                        .select('id, title, release_year, tmdb_id')
                        .in('id', movieIds);
                    if (moviesErr) throw moviesErr;
                    const mrows = Array.isArray(moviesData) ? moviesData : [];
                    for (const m of mrows) moviesById.set(m.id, m);
                }

                if (elMeta) {
                    const tfLabel = (() => {
                        const tf = String(dashboardTimeframe || 'all_time').trim().toLowerCase();
                        if (tf === 'this_year') return 'This Year';
                        if (tf === 'this_month') return 'This Month';
                        return 'All Time';
                    })();
                    elMeta.textContent = `${filtered.length} quote${filtered.length === 1 ? '' : 's'}  ${tfLabel}`;
                }

                const cardsHtml = filtered.map((r, i) => {
                    const quote = String(r?.fav_quote ?? '').trim();
                    const movie_id = String(r?.movie_id ?? '').trim();
                    const overall = dashFormatScore(r?.overall_rating);
                    const tierLabel = dashNormalizeTierLabel(r?.tier);

                    const movie = moviesById.get(r?.movie_id) || null;
                    const title = String(movie?.title ?? '').trim() || 'Untitled';
                    const year = (movie?.release_year === null || movie?.release_year === undefined) ? '' : String(movie.release_year);
                    const tmdb_id = (movie?.tmdb_id === null || movie?.tmdb_id === undefined) ? '' : String(movie.tmdb_id);
                    const poster_path = '';

                    const floatDelay = `${(i % 11) * 0.22}s`;
                    const tilt = `${(((i * 37) % 7) - 3) * 0.35}deg`;
                    const mx = `${35 + ((i * 19) % 45)}%`;
                    const my = `${18 + ((i * 29) % 55)}%`;
                    const mx2 = `${20 + ((i * 13) % 60)}%`;
                    const my2 = `${35 + ((i * 23) % 55)}%`;

                    const metaParts = [
                        overall ? { kind: 'score', value: overall } : null,
                        tierLabel ? { kind: 'tier', value: tierLabel } : null,
                    ].filter(Boolean);

                    return `
                        <div
                            class="dash-quote-card"
                            data-dash-movie-id="${escapeHtml(movie_id)}"
                            data-dash-tmdb-id="${escapeHtml(tmdb_id)}"
                            data-dash-movie-title="${escapeHtml(title)}"
                            data-dash-poster-path="${escapeHtml(poster_path)}"
                            data-dash-movie-quote="${escapeHtml(quote)}"
                            role="button"
                            tabindex="0"
                            aria-label="Update Ratings for ${escapeHtml(title)}"
                            style="--floatDelay:${escapeHtml(floatDelay)}; --tilt:${escapeHtml(tilt)}; --mx:${escapeHtml(mx)}; --my:${escapeHtml(my)}; --mx2:${escapeHtml(mx2)}; --my2:${escapeHtml(my2)};"
                        >
                            <div class="dash-quote-card-inner">
                                <div class="dash-quote-text">${escapeHtml(quote)}</div>
                                <div class="dash-quote-title">${escapeHtml(title)}${year ? ` <span style="color: rgba(255,255,255,0.65); font-weight: 800;">(${escapeHtml(year)})</span>` : ''}</div>
                                <div class="dash-quote-meta">
                                    ${metaParts.map((p) => {
                                        if (p.kind === 'score') {
                                            return `<span class=\"dash-quote-pill\">${dashRenderHelpScore(p.value)} Overall</span>`;
                                        }
                                        if (p.kind === 'tier') {
                                            const letter = dashTierLetterFromLabel(p.value);
                                            const attr = letter ? ` data-tier-letter=\"${escapeHtml(letter)}\"` : '';
                                            return `<span class=\"dash-quote-pill dash-help-tier\"${attr}>${escapeHtml(p.value)}</span>`;
                                        }
                                        return '';
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                elWall.innerHTML = `<div class="dash-quote-wall-grid">${cardsHtml}</div>`;
            } catch (err) {
                showToast(`Dashboard (Quote Wall) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard quote wall load failed', err);
                elWall.innerHTML = `<div class="text-gray">Unable to load Quote Wall right now.</div>`;
                if (elMeta) elMeta.textContent = '';
            }
        }

        async function loadDashboardTiers() {
            const elBars = document.getElementById('dash-tiers-bars');
            const elLists = document.getElementById('dash-tiers-lists');
            if (!elBars || !elLists) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                elBars.innerHTML = '';
                elLists.innerHTML = `<div class="text-gray">Log in to view your tier stats.</div>`;
                return;
            }

            elBars.innerHTML = `<div class="text-gray">Loading</div>`;
            elLists.innerHTML = `<div class="text-gray">Loading</div>`;

            try {
                let res = await supabaseClient.rpc('get_dashboard_tiers', { p_timeframe: dashboardTimeframe });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const looksLikeOldSignature = /get_dashboard_tiers/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (looksLikeOldSignature) res = await supabaseClient.rpc('get_dashboard_tiers');
                }
                if (res?.error) throw res.error;
                const data = res?.data;

                const ratedTotal = Number(data?.rated_total ?? 0);
                const tierDist = Array.isArray(data?.tier_distribution) ? data.tier_distribution : [];
                const tierMovies = Array.isArray(data?.tier_movies) ? data.tier_movies : [];
                const ensuredTierPosters = await Promise.all(tierMovies.map((r) => dashEnsurePosterPath(r)));
                const tierPosterById = new Map();
                tierMovies.forEach((r, idx) => {
                    const id = String(r?.movie_id ?? '').trim();
                    if (!id) return;
                    const fromEnsure = ensuredTierPosters[idx] || '';
                    const fromRow = String(r?.poster_path ?? '').trim();
                    tierPosterById.set(id, fromEnsure || fromRow || '');
                });

                const tierOrder = ['S', 'A', 'B', 'C', 'D', 'F'];
                // Tier colors (requested palette)
                const tierColorSolid = {
                    'S': '#ef4444', // red
                    'A': '#f97316', // orange
                    'B': '#facc15', // yellow
                    'C': '#22c55e', // green
                    'D': '#3b82f6', // blue
                    'F': '#a855f7', // purple
                    'UNRANKED': '#6b7280',
                };
                const tierColorBg = {
                    'S': 'rgba(239, 68, 68, 0.22)',
                    'A': 'rgba(249, 115, 22, 0.22)',
                    'B': 'rgba(250, 204, 21, 0.20)',
                    'C': 'rgba(34, 197, 94, 0.22)',
                    'D': 'rgba(59, 130, 246, 0.22)',
                    'F': 'rgba(168, 85, 247, 0.22)',
                    'UNRANKED': 'rgba(107, 114, 128, 0.22)',
                };

                const tierHelp = {
                    'S': 'The Pantheon. Best of the Best.',
                    'A': 'Great! Highly Recommended Films!',
                    'B': 'Worth a Watch. Solidly Good and Entertaining.',
                    'C': "Totally Average. Fine if it's on, but don't go out of your way.",
                    'D': 'Skip it. Seriously Flawed and Not Worth the Time.',
                    'F': 'Avoid at All Costs. A Genuinely Bad Experience.',
                };

                const distByTier = new Map();
                for (const t of tierDist) {
                    const tier = String(t?.tier ?? '').trim().toUpperCase();
                    if (!tier) continue;
                    distByTier.set(tier, {
                        tier,
                        count: Number(t?.count ?? 0),
                        pct: Number(t?.pct ?? 0),
                    });
                }

                // Render distribution bars (S/A/B/C/D/F first, then anything else like Unranked)
                const extraTiers = [...distByTier.keys()]
                    .filter(t => !tierOrder.includes(t))
                    .sort((a, b) => {
                        if (a === 'UNRANKED') return 1;
                        if (b === 'UNRANKED') return -1;
                        return a.localeCompare(b);
                    });
                const tiersForBars = [...tierOrder.filter(t => distByTier.has(t)), ...extraTiers];

                const formatTierLabel = (tier) => {
                    const t = String(tier ?? '').trim().toUpperCase();
                    if (!t) return '';
                    if (t === 'UNRANKED') return 'Unranked';
                    if (tierOrder.includes(t)) return `${t}-Tier`;
                    return String(tier ?? '').trim();
                };

                // Vertical bar chart distribution (much larger)
                const tiersForChart = [...tierOrder, ...extraTiers.filter(t => t !== 'UNRANKED'), ...(distByTier.has('UNRANKED') ? ['UNRANKED'] : [])];
                const totalCount = Number.isFinite(ratedTotal) && ratedTotal > 0
                    ? ratedTotal
                    : tiersForChart.reduce((sum, t) => sum + (Number(distByTier.get(t)?.count ?? 0) || 0), 0);

                if (!totalCount) {
                    elBars.innerHTML = `<div class="text-gray">No tier data yet. Rate a movie to get started.</div>`;
                } else {
                    const barsHTML = tiersForChart
                        .filter(t => distByTier.has(t))
                        .map((t) => {
                            const label = formatTierLabel(t) || 'Tier';
                            const count = Number(distByTier.get(t)?.count ?? 0) || 0;
                            const pctFromRpc = Number(distByTier.get(t)?.pct ?? 0);
                            const pct = Number.isFinite(pctFromRpc) && pctFromRpc > 0
                                ? pctFromRpc
                                : (count / totalCount) * 100;
                            const h = Math.max(0, Math.min(100, pct));
                            const fill = tierColorSolid[t] || '#6b7280';
                            const bg = tierColorBg[t] || 'rgba(255,255,255,0.10)';
                            return `
                                <div style="width: 100%; min-width: 120px; display:flex; flex-direction: column; gap: 10px; align-items: center;">
                                    <div class="text-sm text-gray tabular-nums" style="height: 18px;">${pct.toFixed(1)}%</div>
                                    <div style="height: 320px; width: 100%; background: rgba(255,255,255,0.06); border-radius: 14px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; display:flex; align-items: flex-end;">
                                        <div style="height: ${h}%; width: 100%; background: ${bg}; display:flex; align-items: flex-end;">
                                            <div style="height: 100%; width: 100%; background: ${fill}; opacity: 0.92;"></div>
                                        </div>
                                    </div>
                                    <div class="text-sm text-white" style="font-weight: 800; line-height: 1.1; text-align: center;">${escapeHtml(label)}</div>
                                    <div class="text-xs text-gray tabular-nums" style="margin-top: -6px;">${count} movie${count === 1 ? '' : 's'}</div>
                                </div>
                            `;
                        })
                        .join('');

                    elBars.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 18px; align-items: flex-end; width: 100%;">
                            ${barsHTML}
                        </div>
                    `;
                }

                // Group movies by tier
                const byTier = new Map();
                for (const row of tierMovies) {
                    const tier = String(row?.tier ?? '').trim().toUpperCase() || '';
                    if (!byTier.has(tier)) byTier.set(tier, []);
                    byTier.get(tier).push(row);
                }

                const renderTierPosterCard = (r) => {
                    const title = String(r?.title ?? '').trim() || 'Untitled';
                    const year = (r?.release_year === null || r?.release_year === undefined) ? '' : String(r.release_year);
                    const overall = dashFormatScore(r?.overall_rating);

                    const dashMovieId = String(r?.movie_id ?? '').trim();
                    const dashTmdbId = (r?.tmdb_id === null || r?.tmdb_id === undefined) ? '' : String(r.tmdb_id);

                    const ensured = tierPosterById.get(dashMovieId) || '';
                    const poster_path = dashNormalizePosterPath(ensured || String(r?.poster_path ?? '').trim());
                    const posterUrl = dashBuildPosterUrl(poster_path, 'w342');

                    const metaParts = [
                        year ? escapeHtml(year) : '',
                        overall ? `${dashRenderHelpScore(overall)} Overall` : '',
                    ].filter(Boolean);

                    return `
                        <div style="display:flex; flex-direction: column; gap: 8px;">
                            <div
                                data-dash-movie-id="${escapeHtml(dashMovieId)}"
                                data-dash-tmdb-id="${escapeHtml(dashTmdbId)}"
                                data-dash-movie-title="${escapeHtml(title)}"
                                data-dash-poster-path="${escapeHtml(poster_path)}"
                                role="button"
                                tabindex="0"
                                aria-label="Update Ratings for ${escapeHtml(title)}"
                                style="width: 100%; aspect-ratio: 2/3; border-radius: 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); cursor: pointer;"
                            >
                                ${posterUrl
                                    ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.closest('div')?.remove?.()">`
                                    : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`
                                }
                            </div>
                            <div class="text-sm text-white" style="font-weight: 700; line-height: 1.2;">${escapeHtml(title)}</div>
                            <div class="text-xs text-gray tabular-nums">${metaParts.join('  ')}</div>
                        </div>
                    `;
                };

                const tiersToRender = [...tierOrder, ...[...byTier.keys()].filter(t => !tierOrder.includes(t) && t !== ''), ...(byTier.has('') ? [''] : [])];

                const listsHTML = tiersToRender
                    .filter(tier => byTier.has(tier))
                    .map((tier) => {
                        const items = byTier.get(tier) || [];
                        const ratingNums = items
                            .map((r) => Number(r?.overall_rating))
                            .filter((n) => Number.isFinite(n));
                        const avgOverall = ratingNums.length
                            ? (ratingNums.reduce((sum, n) => sum + n, 0) / ratingNums.length)
                            : null;
                        const avgOverallText = avgOverall === null ? '' : `${Math.round(avgOverall)}%`;
                        const headerBg = tierColorBg[tier] || 'rgba(255,255,255,0.06)';
                        const headerLabel = formatTierLabel(tier) || 'Tier';
                        const help = tierHelp[String(tier ?? '').trim().toUpperCase()] || '';
                        return `
                            <details style="margin-bottom: 10px;">
                                <summary style="list-style: none; cursor: pointer; user-select: none; padding: 0.85rem 1rem; border-radius: 0.75rem; background: ${headerBg}; border: 1px solid rgba(255,255,255,0.08); display:flex; justify-content: space-between; align-items: center;">
                                    <div style="display:flex; flex-direction: column; gap: 2px;">
                                        <span class="text-white" style="font-weight: 800;">${escapeHtml(headerLabel)}</span>
                                        ${help ? `<span class=\"text-xs text-gray\">${escapeHtml(help)}</span>` : ''}
                                    </div>
                                    <div style="display:flex; flex-direction: column; align-items: flex-end; gap: 2px;">
                                        <span class="text-xs text-gray">${items.length} movie${items.length === 1 ? '' : 's'}</span>
                                        <span class="text-xs text-gray" style="white-space: nowrap;">Average Overall Rating: ${escapeHtml(avgOverallText)}</span>
                                    </div>
                                </summary>
                                <div style="padding: 0.85rem 0.5rem 0.25rem 0.5rem;">
                                    <div class="dash-fav-grid dash-tier-grid">
                                        ${items.map(renderTierPosterCard).join('')}
                                    </div>
                                </div>
                            </details>
                        `;
                    })
                    .join('');

                elLists.innerHTML = listsHTML || `<div class="text-gray">No tiered movies yet. Rate a movie to populate tiers.</div>`;

                // Small footnote if there are zero ratings
                if (!ratedTotal) {
                    elBars.innerHTML = `<div class="text-gray">No tier data yet. Rate a movie to get started.</div>`;
                }
            } catch (err) {
                showToast(`Dashboard (Tiers) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard tiers load failed', err);
                elBars.innerHTML = '';
                elLists.innerHTML = `<div class="text-gray">Unable to load tiers right now.</div>`;
            }
        }

        async function loadDashboardRatings() {
            const elGenreBars = document.getElementById('dash-ratings-genre-bars');
            const elGenreMeta = document.getElementById('dash-ratings-genre-meta');
            const elAvgGrid = document.getElementById('dash-ratings-avg-grid');

            const elTopDirector = document.getElementById('dash-ratings-top-director');
            const elTopDirectorMeta = document.getElementById('dash-ratings-top-director-meta');
            const elTopDirectorAvatar = document.getElementById('dash-ratings-top-director-avatar');

            const elBottomDirector = document.getElementById('dash-ratings-bottom-director');
            const elBottomDirectorMeta = document.getElementById('dash-ratings-bottom-director-meta');
            const elBottomDirectorAvatar = document.getElementById('dash-ratings-bottom-director-avatar');

            const required = [
                elGenreBars,
                elGenreMeta,
                elAvgGrid,
                elTopDirector,
                elTopDirectorMeta,
                elTopDirectorAvatar,
                elBottomDirector,
                elBottomDirectorMeta,
                elBottomDirectorAvatar,
            ];
            if (required.some(x => !x)) return;

            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            const setAvatar = (imgEl, url) => {
                if (!imgEl) return;
                const wrap = imgEl.closest('.dash-person-poster');
                if (!url) {
                    imgEl.removeAttribute('src');
                    if (wrap) wrap.classList.add('is-empty');
                    return;
                }
                imgEl.src = url;
                if (wrap) wrap.classList.remove('is-empty');
            };

            const formatPct = (value) => {
                const raw = Number(value);
                if (!Number.isFinite(raw)) return '';
                const fixed = raw.toFixed(1);
                const trimmed = fixed.endsWith('.0') ? fixed.slice(0, -2) : fixed;
                return `${trimmed}%`;
            };
            const formatPctFixed = (value, decimals = 1) => {
                const raw = Number(value);
                if (!Number.isFinite(raw)) return '';
                return `${raw.toFixed(decimals)}%`;
            };

            const renderAvgGrid = (items) => {
                const rows = Array.isArray(items) ? items : [];
                if (!rows.length) {
                    elAvgGrid.innerHTML = `<div class="text-gray">No ratings yet.</div>`;
                    return;
                }
                const [overall, ...rest] = rows;
                const renderTile = (r) => `
                    <div class="dash-ratings-avg-tile">
                        <div class="dash-ratings-avg-label">${escapeHtml(String(r.label || ''))}</div>
                        <div class="dash-ratings-avg-row">
                            <div class="dash-ratings-avg-value tabular-nums">${escapeHtml(r.value || '')}</div>
                            <div class="dash-ratings-avg-sub">${escapeHtml(String(r.sub || ''))}</div>
                        </div>
                        ${r.note ? `<div class="dash-ratings-avg-sub">${escapeHtml(String(r.note || ''))}</div>` : ''}
                    </div>
                `;

                const mainTile = overall ? renderTile(overall) : '';
                const subTiles = rest.map(renderTile).join('');

                elAvgGrid.innerHTML = `
                    <div class="dash-ratings-avg-layout">
                        <div class="dash-ratings-avg-main">
                            ${mainTile}
                        </div>
                        <div class="dash-ratings-avg-subgrid">
                            ${subTiles}
                        </div>
                    </div>
                `;
            };

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                elGenreBars.innerHTML = `<div class="text-gray">Log in to view ratings.</div>`;
                elAvgGrid.innerHTML = `<div class="text-gray">Log in to view ratings.</div>`;
                elTopDirector.textContent = '';
                elTopDirectorMeta.innerHTML = '&nbsp;';
                elBottomDirector.textContent = '';
                elBottomDirectorMeta.innerHTML = '&nbsp;';
                setAvatar(elTopDirectorAvatar, null);
                setAvatar(elBottomDirectorAvatar, null);
                return;
            }

            syncDashboardRatingsChartUI();

            elGenreBars.innerHTML = `<div class="text-gray">Loading</div>`;
            elAvgGrid.innerHTML = `<div class="text-gray">Loading</div>`;
            elTopDirector.textContent = '';
            elTopDirectorMeta.textContent = '';
            elBottomDirector.textContent = '';
            elBottomDirectorMeta.textContent = '';
            setAvatar(elTopDirectorAvatar, null);
            setAvatar(elBottomDirectorAvatar, null);

            try {
                let res = await supabaseClient.rpc('get_dashboard_ratings', { p_timeframe: dashboardTimeframe });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const looksLikeOldSignature = /get_dashboard_ratings/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (looksLikeOldSignature) res = await supabaseClient.rpc('get_dashboard_ratings');
                }
                if (res?.error) throw res.error;
                const data = res?.data || {};
                dashboardRatingsLastData = data;

                const ratedCount = Number(data?.rated_movies_count ?? 0);
                const avgOverall = formatPct(data?.avg_overall_rating);
                const avgSound = formatPct(data?.avg_sound_rating);
                const avgPlot = formatPct(data?.avg_plot_rating);
                const avgPace = formatPct(data?.avg_pacing_rating);
                const avgActing = formatPct(data?.avg_acting_rating);
                const avgImagery = formatPct(data?.avg_imagery_rating);
                const avgDialogue = formatPct(data?.avg_dialogue_rating);
                const avgImdbDiff = formatPctFixed(data?.avg_imdb_diff ?? data?.avg_imdb_diff_rating ?? data?.avg_abs_imdb_diff, 1);

                const avgItems = [
                    { label: 'Overall', value: avgOverall, sub: 'Avg', note: avgImdbDiff !== '' ? `${avgImdbDiff} Avg ABS Diff to IMDb` : '' },
                    { label: 'Sound', value: avgSound, sub: 'Avg' },
                    { label: 'Plot', value: avgPlot, sub: 'Avg' },
                    { label: 'Pace', value: avgPace, sub: 'Avg' },
                    { label: 'Acting', value: avgActing, sub: 'Avg' },
                    { label: 'Imagery', value: avgImagery, sub: 'Avg' },
                    { label: 'Dialogue', value: avgDialogue, sub: 'Avg' },
                ];
                renderAvgGrid(avgItems);

                let chartsData = null;
                if (dashboardRatingsChartsLastData && String(dashboardRatingsChartsLastData?.timeframe || '') === String(dashboardTimeframe || '')) {
                    chartsData = dashboardRatingsChartsLastData;
                } else if (dashboardChartsLastData && String(dashboardChartsLastData?.timeframe || '') === String(dashboardTimeframe || '')) {
                    chartsData = dashboardChartsLastData;
                } else {
                    const chartsRes = await supabaseClient.rpc('get_dashboard_charts', { p_timeframe: dashboardTimeframe });
                    if (!chartsRes?.error) {
                        chartsData = chartsRes?.data || null;
                        dashboardChartsLastData = chartsData;
                        dashboardRatingsChartsLastData = chartsData;
                    }
                }

                if (chartsData) {
                    dashboardRatingsChartsLastData = chartsData;
                    renderDashboardRatingsChartsFromData(chartsData);
                } else {
                    elGenreBars.innerHTML = `<div class="text-gray">No rated genres yet.</div>`;
                }
                const tfLabel = (() => {
                    const tf = String(dashboardTimeframe || '').trim().toLowerCase();
                    if (tf === 'this_year') return 'This Year';
                    if (tf === 'this_month') return 'This Month';
                    return 'All Time';
                })();
                elGenreMeta.textContent = `${ratedCount} rated movie${ratedCount === 1 ? '' : 's'}  ${tfLabel}`;

                const topDirector = data?.highest_rated_director || {};
                const bottomDirector = data?.lowest_rated_director || {};

                const topDirectorName = String(topDirector?.name ?? '').trim();
                const topDirectorAvg = formatPct(topDirector?.avg_overall);
                const topDirectorN = Number(topDirector?.n ?? 0);
                elTopDirector.textContent = topDirectorName || '';
                elTopDirectorMeta.textContent = topDirectorName
                    ? `${topDirectorAvg} Overall  ${topDirectorN} movie${topDirectorN === 1 ? '' : 's'}`
                    : '';

                const bottomDirectorName = String(bottomDirector?.name ?? '').trim();
                const bottomDirectorAvg = formatPct(bottomDirector?.avg_overall);
                const bottomDirectorN = Number(bottomDirector?.n ?? 0);
                elBottomDirector.textContent = bottomDirectorName || '';
                elBottomDirectorMeta.textContent = bottomDirectorName
                    ? `${bottomDirectorAvg} Overall  ${bottomDirectorN} movie${bottomDirectorN === 1 ? '' : 's'}`
                    : '';

                try {
                    if (topDirectorName) {
                        const profile = await dashFetchPersonProfile({
                            name: topDirectorName,
                            department: 'directing',
                        });
                        setAvatar(elTopDirectorAvatar, dashBuildPersonUrl(profile));
                    }
                    if (bottomDirectorName) {
                        const profile = await dashFetchPersonProfile({
                            name: bottomDirectorName,
                            department: 'directing',
                        });
                        setAvatar(elBottomDirectorAvatar, dashBuildPersonUrl(profile));
                    }
                } catch (_) {
                    setAvatar(elTopDirectorAvatar, null);
                    setAvatar(elBottomDirectorAvatar, null);
                }
            } catch (err) {
                showToast(`Dashboard (Ratings) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard ratings load failed', err);
                elGenreBars.innerHTML = `<div class="text-gray">Unable to load ratings right now.</div>`;
                elAvgGrid.innerHTML = `<div class="text-gray">Unable to load ratings right now.</div>`;
                elTopDirector.textContent = '';
                elTopDirectorMeta.innerHTML = '&nbsp;';
                elBottomDirector.textContent = '';
                elBottomDirectorMeta.innerHTML = '&nbsp;';
                setAvatar(elTopDirectorAvatar, null);
                setAvatar(elBottomDirectorAvatar, null);
            }
        }

        function dashSetInlineBar(el, value, maxValue) {
            if (!el) return;
            const val = Number(value);
            const max = Number(maxValue);
            if (!Number.isFinite(val) || !Number.isFinite(max) || max <= 0 || val <= 0) {
                el.style.width = '0%';
                return;
            }
            const pct = Math.max(0, Math.min(100, (val / max) * 100));
            el.style.width = `${pct}%`;
        }

        function dashSetVerticalBar(el, value, maxValue) {
            if (!el) return;
            const val = Number(value);
            const max = Number(maxValue);
            if (!Number.isFinite(val) || !Number.isFinite(max) || max <= 0 || val <= 0) {
                el.style.height = '0%';
                return;
            }
            const pct = Math.max(0, Math.min(100, (val / max) * 100));
            const minPct = 6;
            el.style.height = `${Math.max(minPct, pct)}%`;
        }

        function dashSetStackBar(elA, elB, aValue, bValue) {
            if (!elA || !elB) return;
            const a = Number(aValue);
            const b = Number(bValue);
            const total = (Number.isFinite(a) ? a : 0) + (Number.isFinite(b) ? b : 0);
            const aStrong = (Number.isFinite(a) ? a : 0) >= (Number.isFinite(b) ? b : 0);
            elA.classList.toggle('is-strong', aStrong && total > 0);
            elB.classList.toggle('is-strong', !aStrong && total > 0);
            if (!Number.isFinite(total) || total <= 0) {
                elA.style.height = '0%';
                elB.style.height = '0%';
                return;
            }
            const aPct = Math.max(0, Math.min(100, (a / total) * 100));
            const bPct = Math.max(0, Math.min(100, (b / total) * 100));
            const minPct = 4;
            elA.style.height = `${Math.max(aPct > 0 ? minPct : 0, aPct)}%`;
            elB.style.height = `${Math.max(bPct > 0 ? minPct : 0, bPct)}%`;
        }

        function dashBuildPalette(count) {
            const total = Math.max(1, Number(count) || 1);
            const style = getComputedStyle(document.documentElement);
            const baseColors = [
                String(style.getPropertyValue('--brand') || '').trim() || '#4e79a7',
                String(style.getPropertyValue('--accent-2') || '').trim() || '#f28e2b',
                String(style.getPropertyValue('--brand-2') || '').trim() || '#76b7b2',
            ];
            const shadeSteps = [85, 70, 55, 40];
            return Array.from({ length: total }, (_, i) => {
                const base = baseColors[i % baseColors.length];
                const shade = shadeSteps[Math.floor(i / baseColors.length) % shadeSteps.length];
                return `color-mix(in srgb, ${base} ${shade}%, white)`;
            });
        }

        function dashRenderPieChart({ el, legendEl, items, labelKey, valueKey, maxSlices = 999 }) {
            if (!el || !legendEl) return;
            if (legendEl.classList) {
                const wantsCompact = legendEl.id === 'dash-general-genre-legend' || legendEl.dataset.compact === 'true';
                legendEl.classList.toggle('compact', wantsCompact);
            }
            const rows = Array.isArray(items) ? items : [];
            const clean = rows
                .map((r) => ({
                    label: String(r?.[labelKey] ?? '').trim(),
                    value: Number(r?.[valueKey] ?? 0),
                }))
                .filter((r) => r.label && Number.isFinite(r.value) && r.value > 0)
                .sort((a, b) => b.value - a.value);

            if (!clean.length) {
                el.style.background = 'conic-gradient(rgba(255,255,255,0.08) 0deg 360deg)';
                legendEl.innerHTML = `<div class="text-gray">No data yet.</div>`;
                return;
            }

            const sliceCount = Math.max(1, Math.min(maxSlices, clean.length));
            const top = clean.slice(0, sliceCount);
            const legendCols = top.length <= 6 ? 1 : Math.ceil(top.length / 6);
            legendEl.style.setProperty('--legend-cols', String(legendCols));

            const total = top.reduce((sum, r) => sum + r.value, 0);
            const colors = dashBuildPalette(top.length);
            let current = 0;
            const stops = top.map((r, idx) => {
                const portion = total > 0 ? (r.value / total) : 0;
                const start = current;
                const end = current + (portion * 360);
                current = end;
                return { start, end, color: colors[idx] };
            });

            const gradient = stops.map((s) => `${s.color} ${s.start.toFixed(1)}deg ${s.end.toFixed(1)}deg`).join(', ');
            el.style.background = `conic-gradient(${gradient})`;

            legendEl.innerHTML = top.map((r, idx) => {
                const pct = total > 0 ? ((r.value / total) * 100) : 0;
                const pctText = pct.toFixed(1);
                return `
                    <div class="dash-pie-legend-item" role="button" tabindex="0" data-dash-pie-value="${escapeHtml(encodeURIComponent(String(r.label)))}" data-dash-pie-label="${escapeHtml(r.label)}">
                        <span class="dash-pie-legend-label" title="${escapeHtml(r.label)}"><span class="dash-legend-dot" style="background:${colors[idx]}"></span>${escapeHtml(r.label)}</span>
                        <span class="tabular-nums">${escapeHtml(pctText)}% (${escapeHtml(String(r.value))})</span>
                    </div>
                `;
            }).join('');
        }

        function renderDashboardGeneralSharePie() {
            const elPie = document.getElementById('dash-general-share-pie');
            const elLegend = document.getElementById('dash-general-share-legend');
            if (!elPie || !elLegend) return;

            const rawMode = String(dashboardGeneralPieMode || '').trim().toLowerCase();
            const mode = rawMode === 'decade' ? 'decade' : (rawMode === 'genre' ? 'genre' : 'mpa');
            const data = dashboardGeneralPieData || {};
            const items = mode === 'decade'
                ? (data.decadeItems || [])
                : (mode === 'genre' ? (data.genreItems || []) : (data.mpaItems || []));
            elLegend.dataset.compact = mode === 'genre' ? 'true' : 'false';
            elLegend.dataset.pieType = mode;
            dashRenderPieChart({
                el: elPie,
                legendEl: elLegend,
                items,
                labelKey: 'label',
                valueKey: 'value',
            });
        }

        function dashRenderVerticalBars({ items, labelKey, valueKey, countKey, barType }) {
            const rows = Array.isArray(items) ? items : [];
            if (!rows.length) return `<div class="text-gray">No data yet.</div>`;
            const max = rows.reduce((m, r) => Math.max(m, Number(r?.[valueKey]) || 0), 0) || 0;
            const colors = dashBuildPalette(rows.length);
            const scale = 0.8;
            return `
                <div class="dash-genre-bars">
                    ${rows.map((r, idx) => {
                        const label = String(r?.[labelKey] ?? '').trim();
                        const val = Number(r?.[valueKey]) || 0;
                        const pct = max > 0 ? ((val / max) * 100 * scale) : 0;
                        const count = (countKey && r?.[countKey] !== undefined) ? Number(r[countKey]) : null;
                        const valueText = `${Number(val).toFixed(1)}%`;
                        const countText = Number.isFinite(count)
                            ? `${count} movie${count === 1 ? '' : 's'}`
                            : '';
                        return `
                            <div class="dash-genre-bar" title="${escapeHtml(label)}" role="button" tabindex="0" data-rating-bar="true" data-bar-type="${escapeHtml(String(barType || 'genre'))}" data-bar-label="${escapeHtml(label)}">
                                <div class="dash-genre-bar-track">
                                    <div class="dash-genre-bar-fill" style="height:${pct.toFixed(2)}%; background:${colors[idx]};">
                                        <div class="dash-genre-bar-metrics tabular-nums">
                                            <div>${escapeHtml(valueText)}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="dash-genre-bar-label">${escapeHtml(label || '')}</div>
                                ${countText ? `<div class="dash-genre-bar-value tabular-nums">${escapeHtml(countText)}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function dashSetDonut(el, aValue, bValue) {
            if (!el) return;
            const a = Number(aValue);
            const b = Number(bValue);
            const total = (Number.isFinite(a) ? a : 0) + (Number.isFinite(b) ? b : 0);
            if (total <= 0) {
                el.style.background = 'conic-gradient(rgba(255,255,255,0.08) 0deg 360deg)';
                return;
            }
            const aDeg = Math.round((a / total) * 360);
            const bDeg = Math.round((b / total) * 360);
            const split = Math.min(360, Math.max(0, aDeg));
            const end = Math.min(360, split + bDeg);
            el.style.background = `conic-gradient(var(--brand) 0deg ${split}deg, var(--accent-2, var(--brand)) ${split}deg ${end}deg, rgba(255,255,255,0.08) ${end}deg 360deg)`;
        }

        async function loadDashboardGeneral() {
            const elEventsTotal = document.getElementById('dash-general-watch-events-total');
            const elHours = document.getElementById('dash-general-hours-watched');
            const elAtHomeWatches = document.getElementById('dash-general-at-home-watches');
            const elInTheaterWatches = document.getElementById('dash-general-in-theater-watches');

            const elStackHome = document.getElementById('dash-general-stack-home');
            const elStackTheater = document.getElementById('dash-general-stack-theater');

            const elTopGenreEvents = document.getElementById('dash-general-top-genre-events');
            const elTopGenreEventsCount = document.getElementById('dash-general-top-genre-events-count');

            const elTopDirectorEvents = document.getElementById('dash-general-top-director-events');
            const elTopDirectorEventsCount = document.getElementById('dash-general-top-director-events-count');
            const elTopDirectorAvatar = document.getElementById('dash-general-top-director-avatar');
            const elTopDirectorMore = document.getElementById('dash-general-top-director-more');
            const elTopDirectorAvg = document.getElementById('dash-general-top-director-avg');

            const elTopActorEvents = document.getElementById('dash-general-top-actor-events');
            const elTopActorEventsCount = document.getElementById('dash-general-top-actor-events-count');
            const elTopActorAvatar = document.getElementById('dash-general-top-actor-avatar');
            const elTopActorMore = document.getElementById('dash-general-top-actor-more');
            const elTopActorAvg = document.getElementById('dash-general-top-actor-avg');

            const elTopDecadeEvents = document.getElementById('dash-general-top-decade-events');
            const elTopDecadeEventsCount = document.getElementById('dash-general-top-decade-events-count');
            const elTopMovieGrid = document.getElementById('dash-general-top-movie-grid');

            const elTopMpaEvents = document.getElementById('dash-general-top-mpa-events');
            const elTopMpaEventsCount = document.getElementById('dash-general-top-mpa-events-count');

            const safeText = (el, v) => { if (el) el.textContent = v; };
            const safeHtml = (el, v) => { if (el) el.innerHTML = v; };
            const setAvatar = (imgEl, url) => {
                if (!imgEl) return;
                const wrap = imgEl.closest('.dash-person-poster');
                if (!url) {
                    imgEl.removeAttribute('src');
                    if (wrap) wrap.classList.add('is-empty');
                    return;
                }
                imgEl.src = url;
                if (wrap) wrap.classList.remove('is-empty');
            };

            // Require auth for dashboard.
            let authedUser = null;
            try {
                const { data } = await supabaseClient?.auth?.getUser?.();
                authedUser = data?.user || null;
            } catch (_) {
                authedUser = null;
            }

            const setAll = (v) => {
                safeText(elEventsTotal, v);
                safeText(elHours, v);
                safeText(elAtHomeWatches, v);
                safeText(elInTheaterWatches, v);
                safeText(elTopGenreEvents, v);
                safeHtml(elTopGenreEventsCount, '&nbsp;');
                safeText(elTopDirectorEvents, v);
                safeHtml(elTopDirectorEventsCount, '&nbsp;');
                safeHtml(elTopDirectorAvg, '&nbsp;');
                safeHtml(elTopDirectorMore, '');
                safeText(elTopActorEvents, v);
                safeHtml(elTopActorEventsCount, '&nbsp;');
                safeHtml(elTopActorAvg, '&nbsp;');
                safeHtml(elTopActorMore, '');
                setAvatar(elTopDirectorAvatar, null);
                setAvatar(elTopActorAvatar, null);
                safeText(elTopDecadeEvents, v);
                safeHtml(elTopDecadeEventsCount, '&nbsp;');
                safeHtml(elTopMovieGrid, '<div class="text-gray"></div>');
                safeText(elTopMpaEvents, v);
                safeHtml(elTopMpaEventsCount, '&nbsp;');
                dashSetStackBar(elStackHome, elStackTheater, 0, 0);
                dashboardGeneralPieData = { mpaItems: [], decadeItems: [], genreItems: [] };
                renderDashboardGeneralSharePie();
            };

            const pluralize = (n, one, many) => {
                const x = Number(n);
                const v = Number.isFinite(x) ? x : 0;
                return `${v} ${v === 1 ? one : many}`;
            };
            const formatHoursClock = (value) => {
                const raw = Number(value);
                if (!Number.isFinite(raw) || raw <= 0) return '0:00';
                const totalMinutes = Math.round(raw * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours}:${String(minutes).padStart(2, '0')}`;
            };
            const formatPct = (value) => {
                const raw = Number(value);
                if (!Number.isFinite(raw)) return '';
                const fixed = raw.toFixed(1);
                const trimmed = fixed.endsWith('.0') ? fixed.slice(0, -2) : fixed;
                return `${trimmed}%`;
            };
            const useUnique = String(dashboardGeneralMode || '').trim().toLowerCase() === 'unique';
            const renderMostWatchedMovies = async (movies, fallbackMovie) => {
                if (!elTopMovieGrid) return;
                const list = Array.isArray(movies) ? movies : [];
                const items = list.length ? list : (fallbackMovie?.title ? [fallbackMovie] : []);
                if (!items.length) {
                    safeHtml(elTopMovieGrid, '<div class="text-gray">No data yet.</div>');
                    return;
                }

                const first = items[0];
                const extra = Math.max(0, items.length - 1);
                elTopMovieGrid.style.setProperty('--mw-poster-min', '160px');

                const title = String(first?.title ?? '').trim();
                const year = first?.release_year;
                const label = title
                    ? `${title}${(year === null || year === undefined || String(year).trim() === '') ? '' : ` (${String(year)})`}`
                    : '';

                let posterPath = String(first?.poster_path ?? '').trim();
                if (!posterPath) {
                    const resolved = await dashEnsurePosterPath({
                        movie_id: first?.movie_id ?? first?.movieId ?? first?.id ?? null,
                        tmdb_id: first?.tmdb_id ?? null,
                        poster_path: posterPath || null,
                    });
                    if (resolved) posterPath = String(resolved).trim();
                }
                const posterUrl = posterPath ? dashBuildPosterUrl(posterPath, 'w342') : '';

                const ratingRaw = Number(first?.overall_rating ?? NaN);
                const ratingText = formatPct(ratingRaw);
                const ratingLabel = ratingText === '' ? ' Overall' : `${ratingText} Overall`;
                const tierRaw = String(first?.tier ?? '').trim();
                const tierLabel = tierRaw || '';
                const tierHtml = tierRaw
                    ? `<span class="dash-tier-pill" data-tier="${escapeHtml(tierRaw)}">${escapeHtml(tierLabel)}</span>`
                    : `<span class="text-gray">Tier </span>`;
                const watchCount = Number(first?.watches ?? fallbackMovie?.watches ?? NaN);
                const watchCountText = (!useUnique && Number.isFinite(watchCount))
                    ? pluralize(watchCount, 'watch event', 'watch events')
                    : '';

                const moreHtml = extra > 0
                    ? `<div class="dash-kpi-more">+ ${extra} more <span>view all</span></div>`
                    : '';

                safeHtml(elTopMovieGrid, `
                    <div class="dash-most-movie-card">
                        ${watchCountText ? `<div class="dash-kpi-top-count tabular-nums">${escapeHtml(watchCountText)}</div>` : ''}
                        <div class="dash-most-movie-poster">
                            ${posterUrl
                                ? `<img src="${escapeHtml(posterUrl)}" alt="${escapeHtml(title)}" loading="lazy">`
                                : `<div class="dash-most-movie-placeholder text-gray">No poster</div>`}
                        </div>
                        <div class="dash-most-movie-title">${escapeHtml(label)}</div>
                        <div class="dash-most-movie-meta">
                            <span class="dash-most-movie-rating">${escapeHtml(ratingLabel)}</span>
                            ${tierHtml}
                        </div>
                        ${moreHtml}
                    </div>
                `);
            };

            if (!supabaseClient || !authedUser?.id) {
                if (!dashboardAuthWarned) {
                    dashboardAuthWarned = true;
                    showToast('Log in to view your dashboard stats.', { level: 'warn' });
                }
                setAll('');
                return;
            }

            setAll('');

            try {
                let res = await supabaseClient.rpc('get_dashboard_general', { p_timeframe: dashboardTimeframe });
                if (res?.error) {
                    const msg = String(res.error?.message || res.error);
                    const looksLikeOldSignature = /get_dashboard_general/i.test(msg) && /(does not exist|not found|no function matches|function .* does not exist)/i.test(msg);
                    if (looksLikeOldSignature) res = await supabaseClient.rpc('get_dashboard_general');
                }
                if (res?.error) throw res.error;
                const data = res?.data;
                dashboardGeneralLastData = data;

                const watchEvents = data?.watch_events || {};
                const totalWatches = Number(watchEvents?.watches ?? 0);
                const uniqueMovies = Number(watchEvents?.movies ?? 0);

                const totalHours = Number(data?.hours_watched ?? 0);
                const uniqueHours = Number(data?.hours_watched_unique ?? 0);

                const method = data?.watch_method_breakdown || {};
                const atHomeObj = method?.at_home || {};
                const inTheaterObj = method?.in_theater || {};

                const atHome = Number(atHomeObj?.watches ?? 0);
                const atHomeUnique = Number(atHomeObj?.movies ?? 0);
                const inTheater = Number(inTheaterObj?.watches ?? 0);
                const inTheaterUnique = Number(inTheaterObj?.movies ?? 0);

                const useUnique = String(dashboardGeneralMode || '').trim().toLowerCase() === 'unique';
                const displayWatches = useUnique ? uniqueMovies : totalWatches;
                const displayHours = useUnique ? uniqueHours : totalHours;
                const displayAtHome = useUnique ? atHomeUnique : atHome;
                const displayTheater = useUnique ? (Number.isFinite(inTheaterUnique) && inTheaterUnique > 0 ? inTheaterUnique : inTheater) : inTheater;

                const topGenre = data?.most_watched_genre || {};
                const topGenreUnique = data?.most_watched_genre_unique || {};
                const topDirector = data?.most_watched_director || {};
                const topDirectorUnique = data?.most_watched_director_unique || {};
                const topDirectors = Array.isArray(useUnique ? data?.most_watched_directors_unique : data?.most_watched_directors)
                    ? (useUnique ? data.most_watched_directors_unique : data.most_watched_directors)
                    : [];
                const topActor = data?.most_watched_actor || {};
                const topActorUnique = data?.most_watched_actor_unique || {};
                const topActors = Array.isArray(useUnique ? data?.most_watched_actors_unique : data?.most_watched_actors)
                    ? (useUnique ? data.most_watched_actors_unique : data.most_watched_actors)
                    : [];
                const topDecade = data?.most_watched_decade || {};
                const topDecadeUnique = data?.most_watched_decade_unique || {};

                safeText(elEventsTotal, Number.isFinite(displayWatches) ? String(displayWatches) : '0');
                safeText(elHours, formatHoursClock(displayHours));

                const methodTotal = (Number.isFinite(displayAtHome) ? displayAtHome : 0) + (Number.isFinite(displayTheater) ? displayTheater : 0);
                const atHomePct = methodTotal > 0 ? ((displayAtHome / methodTotal) * 100) : 0;
                const theaterPct = methodTotal > 0 ? ((displayTheater / methodTotal) * 100) : 0;
                safeText(elAtHomeWatches, `${atHomePct.toFixed(1)}% (${Number.isFinite(displayAtHome) ? displayAtHome : 0})`);
                safeText(elInTheaterWatches, `${theaterPct.toFixed(1)}% (${Number.isFinite(displayTheater) ? displayTheater : 0})`);

                dashSetStackBar(elStackHome, elStackTheater, displayAtHome, displayTheater);

                const genreEventsName = String(topGenre?.name ?? '').trim();
                const genreUniqueName = String(topGenreUnique?.name ?? '').trim();
                safeText(elTopGenreEvents, (useUnique ? genreUniqueName : genreEventsName) || '');
                safeText(elTopGenreEventsCount, useUnique
                    ? pluralize(topGenreUnique?.movies, 'unique movie', 'unique movies')
                    : pluralize(topGenre?.watches, 'watch event', 'watch events'));

                const directorEventsName = String(topDirector?.name ?? '').trim();
                const directorUniqueName = String(topDirectorUnique?.name ?? '').trim();
                const directorDisplayName = (useUnique ? directorUniqueName : directorEventsName) || '';
                safeText(elTopDirectorEvents, directorDisplayName || '');
                const directorMovies = useUnique ? topDirectorUnique?.movies : topDirector?.movies;
                const directorWatches = useUnique ? null : topDirector?.watches;
                const directorAvg = useUnique ? topDirectorUnique?.avg_overall : topDirector?.avg_overall;
                const directorExtra = Math.max(0, topDirectors.length - 1);
                const directorAvgText = formatPct(directorAvg);
                const directorCountText = (directorMovies !== undefined && directorMovies !== null)
                    ? pluralize(directorMovies, 'movie', 'movies')
                    : '';
                const directorWatchText = (!useUnique && directorWatches !== undefined && directorWatches !== null)
                    ? pluralize(directorWatches, 'watch event', 'watch events')
                    : '';
                const directorTopParts = [directorCountText, directorWatchText].filter(Boolean);
                safeText(elTopDirectorEventsCount, directorTopParts.length ? directorTopParts.join('  ') : '');
                safeText(elTopDirectorAvg, directorAvgText === '' ? ' Overall' : `${directorAvgText} Overall`);
                safeHtml(elTopDirectorMore, directorExtra > 0
                    ? `+ ${directorExtra} more <span>view all</span>`
                    : '');

                const actorEventsName = String(topActor?.name ?? '').trim();
                const actorUniqueName = String(topActorUnique?.name ?? '').trim();
                const actorDisplayName = (useUnique ? actorUniqueName : actorEventsName) || '';
                safeText(elTopActorEvents, actorDisplayName || '');
                const actorMovies = useUnique ? topActorUnique?.movies : topActor?.movies;
                const actorWatches = useUnique ? null : topActor?.watches;
                const actorAvg = useUnique ? topActorUnique?.avg_acting : topActor?.avg_acting;
                const actorExtra = Math.max(0, topActors.length - 1);
                const actorAvgText = formatPct(actorAvg);
                const actorCountText = (actorMovies !== undefined && actorMovies !== null)
                    ? pluralize(actorMovies, 'movie', 'movies')
                    : '';
                const actorWatchText = (!useUnique && actorWatches !== undefined && actorWatches !== null)
                    ? pluralize(actorWatches, 'watch event', 'watch events')
                    : '';
                const actorTopParts = [actorCountText, actorWatchText].filter(Boolean);
                safeText(elTopActorEventsCount, actorTopParts.length ? actorTopParts.join('  ') : '');
                safeText(elTopActorAvg, actorAvgText === '' ? ' Acting' : `${actorAvgText} Acting`);
                safeHtml(elTopActorMore, actorExtra > 0
                    ? `+ ${actorExtra} more <span>view all</span>`
                    : '');

                try {
                    if (directorDisplayName) {
                        const directorProfile = await dashFetchPersonProfile({
                            name: directorDisplayName,
                            department: 'directing',
                        });
                        setAvatar(elTopDirectorAvatar, dashBuildPersonUrl(directorProfile));
                    } else {
                        setAvatar(elTopDirectorAvatar, null);
                    }

                    if (actorDisplayName) {
                        const actorProfile = await dashFetchPersonProfile({
                            name: actorDisplayName,
                            department: 'acting',
                        });
                        setAvatar(elTopActorAvatar, dashBuildPersonUrl(actorProfile));
                    } else {
                        setAvatar(elTopActorAvatar, null);
                    }
                } catch (_) {
                    setAvatar(elTopDirectorAvatar, null);
                    setAvatar(elTopActorAvatar, null);
                }

                const decadeEvents = topDecade?.decade;
                const decadeEventsLabel = (decadeEvents === null || decadeEvents === undefined) ? '' : `${String(decadeEvents)}s`;
                const decadeUnique = topDecadeUnique?.decade;
                const decadeUniqueLabel = (decadeUnique === null || decadeUnique === undefined) ? '' : `${String(decadeUnique)}s`;
                safeText(elTopDecadeEvents, (useUnique ? decadeUniqueLabel : decadeEventsLabel) || '');
                safeText(elTopDecadeEventsCount, useUnique
                    ? pluralize(topDecadeUnique?.movies, 'unique movie', 'unique movies')
                    : pluralize(topDecade?.watches, 'watch event', 'watch events'));

                const topMovie = data?.most_watched_movie || {};
                const topMovies = Array.isArray(data?.most_watched_movies) ? data.most_watched_movies : [];
                await renderMostWatchedMovies(topMovies, topMovie);

                const topMpa = data?.most_watched_mpa || {};
                const topMpaUnique = data?.most_watched_mpa_unique || {};
                const topMpaRating = String(topMpa?.rating ?? '').trim();
                const topMpaRatingUnique = String(topMpaUnique?.rating ?? '').trim();
                safeText(elTopMpaEvents, (useUnique ? topMpaRatingUnique : topMpaRating) || '');
                safeText(elTopMpaEventsCount, useUnique
                    ? pluralize(topMpaUnique?.movies, 'unique movie', 'unique movies')
                    : pluralize(topMpa?.watches, 'watch event', 'watch events'));

                try {
                    let chartsData = null;
                    if (dashboardChartsLastData && String(dashboardChartsLastData?.timeframe || '') === String(dashboardTimeframe || '')) {
                        chartsData = dashboardChartsLastData;
                    } else {
                        const chartsRes = await supabaseClient.rpc('get_dashboard_charts', { p_timeframe: dashboardTimeframe });
                        if (!chartsRes?.error) chartsData = chartsRes?.data || null;
                    }

                    const genreSource = useUnique ? chartsData?.genre_counts_unique : chartsData?.genre_counts_total;
                    const pickCount = (row, unique) => {
                        const direct = Number(row?.count ?? NaN);
                        if (Number.isFinite(direct)) return direct;
                        const fallback = Number(unique ? row?.movies : row?.watches);
                        return Number.isFinite(fallback) ? fallback : 0;
                    };
                    const genreItems = Array.isArray(genreSource)
                        ? genreSource.map((r) => ({ label: r?.genre, value: pickCount(r, useUnique) }))
                        : (Array.isArray(chartsData?.genres)
                            ? chartsData.genres.map((r) => ({ label: r?.genre, value: Number(r?.n ?? 0) }))
                            : []);
                    const mpaSource = useUnique ? chartsData?.mpa_counts_unique : chartsData?.mpa_counts_total;
                    const mpaItems = Array.isArray(mpaSource)
                        ? mpaSource.map((r) => ({ label: r?.mpa, value: pickCount(r, useUnique) }))
                        : (Array.isArray(chartsData?.mpa)
                            ? chartsData.mpa.map((r) => ({ label: r?.mpa, value: Number(r?.n ?? 0) }))
                            : []);

                    const decadeSource = useUnique ? chartsData?.decade_counts_unique : chartsData?.decade_counts_total;
                    const decadeItems = Array.isArray(decadeSource)
                        ? decadeSource.map((r) => ({ label: r?.decade !== null && r?.decade !== undefined ? `${String(r.decade)}s` : '', value: pickCount(r, useUnique) }))
                        : (Array.isArray(chartsData?.decades)
                            ? chartsData.decades.map((r) => ({ label: r?.decade !== null && r?.decade !== undefined ? `${String(r.decade)}s` : '', value: Number(r?.n ?? 0) }))
                            : []);
                    dashboardGeneralPieData = { mpaItems, decadeItems, genreItems };
                    renderDashboardGeneralSharePie();
                } catch (_) {
                    dashboardGeneralPieData = { mpaItems: [], decadeItems: [], genreItems: [] };
                    renderDashboardGeneralSharePie();
                }
            } catch (err) {
                showToast(`Dashboard (General) failed: ${String(err?.message || err)}`, { level: 'warn' });
                emitLog('error', 'Dashboard general load failed', err);
                try {
                    const details = {
                        message: err?.message,
                        code: err?.code,
                        details: err?.details,
                        hint: err?.hint,
                    };
                    addMessageToLog('error', 'Dashboard (General) error details', JSON.stringify(details));
                } catch (_) {}
                setAll('');
            }
        }

        async function callSwiftApiSearchMovies({ query, page = 1, signal }) {
            try {
                const year = homeSearchAppliedYear;
                const mpa = homeSearchAppliedMpa;
                return await callSwiftApiPublic({ action: 'search', query, page, year, mpa, limit: 8 }, { signal });
            } catch (err) {
                throw new Error(`Search failed: ${String(err?.message || err)}`);
            }
        }

        async function callSwiftApiSearchMoviesForLists({ query, page = 1, signal }) {
            try {
                // Lists page search should be dedicated to adding movies to lists only.
                // It intentionally does not use the Home page filter state.
                return await callSwiftApiPublic({ action: 'search', query, page, limit: 8 }, { signal });
            } catch (err) {
                throw new Error(`Search failed: ${String(err?.message || err)}`);
            }
        }

        async function callSwiftApiGetMovieDetails({ tmdb_id, signal }) {
            try {
                return await callSwiftApiPublic({ action: 'details', tmdb_id }, { signal });
            } catch (err) {
                throw new Error(`Details failed: ${String(err?.message || err)}`);
            }
        }

        async function callSwiftApiGetTrendingMovies({ time_window = 'day', limit = 10, signal } = {}) {
            try {
                return await callSwiftApiPublic({ action: 'trending', time_window, limit }, { signal });
            } catch (err) {
                throw new Error(`Trending failed: ${String(err?.message || err)}`);
            }
        }

        function renderTrendingNow(items) {
            const safeItems = Array.isArray(items) ? items : [];
            const cardsHTML = safeItems.map((m) => {
                const title = String(m?.title || '').trim();
                const genre = String(m?.genre || '').trim();
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w342${posterPath}` : '';
                if (!posterUrl) return '';

                return `
                    <div class="trending-card">
                        <img src="${posterUrl}" alt="${escapeHtml(title)}" onerror="this.closest('.trending-card')?.remove?.()">
                        <div class="movie-overlay">
                            ${genre ? `<span class=\"text-xs text-brand font-bold uppercase mb-1\">${escapeHtml(genre)}</span>` : ''}
                            <h4 class="text-white font-bold text-sm">${escapeHtml(title)}</h4>
                        </div>
                    </div>
                `;
            }).join('');

            const track1 = document.getElementById('trending-track-1');
            const track2 = document.getElementById('trending-track-2');
            if (track1) track1.innerHTML = cardsHTML;
            if (track2) track2.innerHTML = cardsHTML;
        }

        async function loadTrendingNow() {
            const track1 = document.getElementById('trending-track-1');
            const track2 = document.getElementById('trending-track-2');
            if (!track1 || !track2) return;

            // Cancel any in-flight trending request (e.g., navigating home repeatedly).
            try { homeTrendingAbortController?.abort?.(); } catch (_) {}
            homeTrendingAbortController = new AbortController();

            // Lightweight loading state (no hardcoded movies/posters).
            track1.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">Loading trending</div>`;
            track2.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">Loading trending</div>`;

            try {
                const data = await callSwiftApiGetTrendingMovies({ time_window: 'day', limit: 20, signal: homeTrendingAbortController.signal });
                const items = Array.isArray(data?.results) ? data.results : [];
                homeTrendingItems = items;
                renderTrendingNow(items);
            } catch (err) {
                if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                // Quiet failure: keep marquee area but show a small message.
                const msg = `Trending unavailable`;
                track1.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">${escapeHtml(msg)}</div>`;
                track2.innerHTML = `<div class="text-gray" style="padding: 0 1.5rem;">${escapeHtml(msg)}</div>`;
            }
        }

        function renderHomeSearchResults(items) {
            const results = document.getElementById('search-results');
            if (!results) return;

            // Keep the dropdown lightweight.
            homeSearchItems = Array.isArray(items) ? items.slice(0, 4) : [];

            if (homeSearchItems.length === 0) {
                results.innerHTML = `<div class="search-item text-gray justify-center">No movies found</div>`;
                results.classList.remove('hidden');
                return;
            }

            results.innerHTML = homeSearchItems.map((m, idx) => {
                const title = String(m?.title || '').trim();
                const year = m?.year ? String(m.year) : '';
                const genres = Array.isArray(m?.genres)
                    ? m.genres.map(s => String(s).trim()).filter(Boolean)
                    : String(m?.genre || '').split(',').map(s => s.trim()).filter(Boolean);
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w154${posterPath}` : '';

                // Dropdown preview: do not show director (only fetched on details after selection).
                const metaParts = [
                    year,
                    (genres.length ? genres.join(', ') : ''),
                ].filter(Boolean);

                return `
                    <div class="search-item" data-idx="${idx}">
                        <div style="display:flex; align-items:center; gap: 0.75rem;">
                            <div style="width: 34px; height: 51px; flex: 0 0 34px; border-radius: 7px; overflow:hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center;">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.style.display='none'; this.parentElement.style.opacity='0.6';">`
                                    : `<div style="opacity:0.65; color: var(--text-muted); width: 16px; height: 16px; display:flex; align-items:center; justify-content:center;">${icons.film}</div>`
                                }
                            </div>
                            <div>
                                <div class="text-white font-semibold">${escapeHtml(title)}</div>
                                <div class="text-xs text-gray">${escapeHtml(metaParts.join('  '))}</div>
                            </div>
                        </div>
                        <div style="color:var(--text-muted);">${icons.arrowRightCircle}</div>
                    </div>
                `;
            }).join('');
            results.classList.remove('hidden');

            if (!results.dataset.boundClicks) {
                results.dataset.boundClicks = 'true';
                results.addEventListener('click', (e) => {
                    const row = e?.target?.closest ? e.target.closest('.search-item[data-idx]') : null;
                    if (!row) return;
                    const idx = Number(row.getAttribute('data-idx'));
                    const picked = Number.isFinite(idx) ? homeSearchItems[idx] : null;
                    if (!picked) return;
                    router.selectMovie(picked);
                });
            }
        }

        let listsSearchItems = [];
        let listsSearchDebounceTimer = null;
        let listsSearchAbortController = null;
        let listsQuickAddBusy = false;

        function setListsQuickAddEnabledState() {
            const input = document.getElementById('lists-movie-search-input');
            if (!input) return;
            const hasList = Boolean(String(listsActiveListId || '').trim());
            input.disabled = !hasList || listsQuickAddBusy;
            input.placeholder = hasList
                ? `Add movies to ${String(listsActiveListName || 'this list').trim() || 'this list'}`
                : 'Select a list to add movies';

            try { setListsActiveListActionsEnabledState(); } catch (_) {}
        }

        async function addListsSearchMovieToActiveList(picked) {
            if (listsQuickAddBusy) return;

            if (!supabaseClient) {
                showToast('Supabase SDK failed to load.', { level: 'warn' });
                return;
            }

            const lid = String(listsActiveListId || '').trim();
            if (!lid) {
                showToast('Select a list first.', { level: 'warn' });
                setListsQuickAddEnabledState();
                return;
            }

            let authedUser = null;
            let accessToken = null;
            try {
                const res = await requireAuthOrThrow();
                authedUser = res.user;
                accessToken = res.accessToken;
            } catch (_) {
                openAuthModal();
                return;
            }

            const title = String(picked?.title || '').trim();
            const year = Number(picked?.year ?? picked?.release_year ?? null);
            const tmdbId = Number(picked?.tmdb_id ?? picked?.tmdbId ?? picked?.id ?? null);
            const existingDbMovieId = (isUuidLike(picked?.id) ? String(picked.id).trim() : '');

            if (!title) {
                showToast('Movie title missing. Try a different result.', { level: 'warn' });
                return;
            }

            listsQuickAddBusy = true;
            setListsQuickAddEnabledState();

            try {
                const ensuredMovieId = await ensureMovieFullySyncedForLists({
                    accessToken,
                    title,
                    release_year: Number.isFinite(year) ? year : null,
                    tmdb_id: Number.isFinite(tmdbId) ? tmdbId : null,
                    movie_id: existingDbMovieId || null,
                });

                if (!ensuredMovieId) throw new Error('Failed to ensure movie exists.');

                try {
                    await addMovieToList({ user_id: authedUser.id, list_id: lid, movie_id: ensuredMovieId });
                } catch (err) {
                    const msg = String(err?.message || err);
                    if (/duplicate|unique/i.test(msg)) {
                        showToast('Already in this list.', { level: 'warn' });
                        return;
                    }
                    throw err;
                }

                const listLabel = String(listsActiveListName || '').trim() || 'list';
                showToast(`Added to ${listLabel}!`, { level: 'success' });
                await loadListsPage({ reset: false });
            } catch (err) {
                showToast(`Add failed: ${String(err?.message || err)}`, { level: 'warn' });
            } finally {
                listsQuickAddBusy = false;
                setListsQuickAddEnabledState();
            }
        }

        function setListsSearchLoading() {
            const results = document.getElementById('lists-movie-search-results');
            if (!results) return;
            results.innerHTML = `
                <div class="search-item text-gray justify-center" style="gap:0.5rem;">
                    <span class="icon-sm">${icons.loader}</span>
                    Searching
                </div>
            `;
            results.classList.remove('hidden');
        }

        function clearListsSearchUI() {
            const results = document.getElementById('lists-movie-search-results');
            if (results) results.classList.add('hidden');
            listsSearchItems = [];
        }

        function renderListsAddMovieSearchResults(items) {
            const results = document.getElementById('lists-movie-search-results');
            if (!results) return;

            listsSearchItems = Array.isArray(items) ? items.slice(0, 6) : [];
            if (listsSearchItems.length === 0) {
                results.innerHTML = `<div class="search-item text-gray justify-center">No movies found</div>`;
                results.classList.remove('hidden');
                return;
            }

            results.innerHTML = listsSearchItems.map((m, idx) => {
                const title = String(m?.title || '').trim();
                const year = m?.year ? String(m.year) : '';
                const genres = Array.isArray(m?.genres)
                    ? m.genres.map(s => String(s).trim()).filter(Boolean)
                    : String(m?.genre || '').split(',').map(s => s.trim()).filter(Boolean);
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w154${posterPath}` : '';
                const metaParts = [year, (genres.length ? genres.join(', ') : '')].filter(Boolean);

                return `
                    <div class="search-item" data-lists-idx="${idx}" title="Add to list">
                        <div style="display:flex; align-items:center; gap: 0.75rem;">
                            <div style="width: 34px; height: 51px; flex: 0 0 34px; border-radius: 7px; overflow:hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center;">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.style.display='none'; this.parentElement.style.opacity='0.6';">`
                                    : `<div style="opacity:0.65; color: var(--text-muted); width: 16px; height: 16px; display:flex; align-items:center; justify-content:center;">${icons.film}</div>`
                                }
                            </div>
                            <div>
                                <div class="text-white font-semibold">${escapeHtml(title)}</div>
                                <div class="text-xs text-gray">${escapeHtml(metaParts.join('  '))}</div>
                            </div>
                        </div>
                        <div style="color:var(--text-muted);">${icons.plusCircle}</div>
                    </div>
                `;
            }).join('');
            results.classList.remove('hidden');

            if (!results.dataset.boundClicks) {
                results.dataset.boundClicks = 'true';
                results.addEventListener('click', (e) => {
                    const row = e?.target?.closest ? e.target.closest('.search-item[data-lists-idx]') : null;
                    if (!row) return;
                    const idx = Number(row.getAttribute('data-lists-idx'));
                    const picked = Number.isFinite(idx) ? listsSearchItems[idx] : null;
                    if (!picked) return;

                    // This Lists-only search does ONE thing: add the picked movie to the active list.
                    const input = document.getElementById('lists-movie-search-input');
                    if (input) input.value = '';
                    clearListsSearchUI();
                    addListsSearchMovieToActiveList(picked).catch(() => null);
                });
            }
        }

        function handleListsAddMovieSearch(query, opts = {}) {
            const inputEl = document.getElementById('lists-movie-search-input');
            const results = document.getElementById('lists-movie-search-results');
            // If the Lists page isn't mounted, do nothing.
            if (!inputEl || !results) return;

            if (inputEl.disabled) return;

            const q = String(query || '').trim();
            if (!q || q.length < 1) {
                if (listsSearchDebounceTimer) clearTimeout(listsSearchDebounceTimer);
                if (listsSearchAbortController) listsSearchAbortController.abort();
                clearListsSearchUI();
                return;
            }

            // Debounce + cancel in-flight request.
            if (listsSearchDebounceTimer) clearTimeout(listsSearchDebounceTimer);
            if (listsSearchAbortController) listsSearchAbortController.abort();
            listsSearchAbortController = new AbortController();

            // Keep it lightweight; wait until the user types at least 3 characters.
            if (q.length < 3) {
                results.classList.add('hidden');
                listsSearchItems = [];
                return;
            }

            const debounceMs = opts?.force ? 0 : 320;
            listsSearchDebounceTimer = setTimeout(async () => {
                try {
                    setListsSearchLoading();

                    const data = await callSwiftApiSearchMoviesForLists({
                        query: q,
                        page: 1,
                        signal: listsSearchAbortController.signal,
                    });

                    const items = Array.isArray(data?.results) ? data.results : [];
                    renderListsAddMovieSearchResults(items);
                } catch (err) {
                    // Ignore aborts
                    if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                    if (String(err?.message || '').toLowerCase().includes('aborted')) return;

                    results.innerHTML = `<div class="search-item text-gray justify-center">Search unavailable  please try again</div>`;
                    results.classList.remove('hidden');
                }
            }, debounceMs);
        }

        function setHomeActionsVisible(isVisible) {
            const actions = document.getElementById('movie-actions');
            if (!actions) return;
            const placeholder = document.getElementById('home-action-placeholder');
            if (placeholder) {
                placeholder.style.display = isVisible ? 'none' : 'block';
            }
            if (isVisible) {
                actions.classList.remove('hidden');
                actions.classList.add('flex');
            } else {
                actions.classList.add('hidden');
                actions.classList.remove('flex');
            }
        }

        function setUpdateOptionsHidden() {
            const updateBtn = document.getElementById('update-existing-btn');
            const updateOpts = document.getElementById('update-options');
            if (updateOpts) {
                updateOpts.classList.add('hidden');
                updateOpts.classList.remove('grid');
            }
            if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.style.opacity = '0.5';
                updateBtn.style.pointerEvents = 'none';
            }
        }

        function setHomeSearchLoading() {
            const results = document.getElementById('search-results');
            if (!results) return;
            results.innerHTML = `
                <div class="search-item text-gray justify-center" style="gap:0.5rem;">
                    <span class="icon-sm">${icons.loader}</span>
                    Searching
                </div>
            `;
            results.classList.remove('hidden');
        }

        function clearHomeSearchUI() {
            const results = document.getElementById('search-results');
            if (results) results.classList.add('hidden');
            setHomeActionsVisible(false);
            setUpdateOptionsHidden();
            router.selectedMovie = null;
            router.pendingTitle = '';
            homeSearchItems = [];
        }

        function escapeHtml(s) {
            return String(s ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        let homeSearchAppliedYear = '';
        let homeSearchAppliedMpa = '';
        let homeSearchFiltersDirty = false;

        function resetHomeSearchAndFilters() {
            // Clear applied filter state (so nothing is accidentally carried over).
            homeSearchAppliedYear = '';
            homeSearchAppliedMpa = '';
            homeSearchFiltersDirty = false;

            const input = document.getElementById('movie-search-input');
            if (input) input.value = '';

            const yearEl = document.getElementById('movie-search-year');
            const mpaEl = document.getElementById('movie-search-mpa');
            if (yearEl) yearEl.value = '';
            if (mpaEl) mpaEl.value = '';

            const panel = document.getElementById('movie-search-filters');
            if (panel) panel.classList.add('hidden');

            const btn = document.getElementById('movie-search-filters-toggle');
            if (btn) btn.textContent = 'Use Filters';

            // Clear any results/actions from prior home interactions.
            try { clearHomeSearchUI(); } catch (_) {}
        }

        function toggleSearchFiltersPanel() {
            const panel = document.getElementById('movie-search-filters');
            if (!panel) return;
            const btn = document.getElementById('movie-search-filters-toggle');
            const isHidden = panel.classList.contains('hidden');
            if (isHidden) {
                panel.classList.remove('hidden');
                if (btn) btn.textContent = 'Hide Filters';
            } else {
                panel.classList.add('hidden');
                if (btn) btn.textContent = 'Use Filters';
            }
        }

        function markSearchFiltersDirty() {
            homeSearchFiltersDirty = true;
        }

        function applySearchFilters() {
            const yearEl = document.getElementById('movie-search-year');
            const mpaEl = document.getElementById('movie-search-mpa');
            const yearRaw = yearEl ? String(yearEl.value || '').trim() : '';
            const year = yearRaw && /^\d{4}$/.test(yearRaw) ? yearRaw : '';
            const mpa = mpaEl ? String(mpaEl.value || '').trim() : '';

            homeSearchAppliedYear = year;
            homeSearchAppliedMpa = mpa;
            homeSearchFiltersDirty = false;

            const input = document.getElementById('movie-search-input');
            const q = String(input?.value || '').trim();
            if (q.length < 3) {
                showToast('Type at least 3 characters, then apply filters.', { level: 'warn' });
                return;
            }
            handleSearch(q, { force: true });
        }

        function clearSearchFilters() {
            const yearEl = document.getElementById('movie-search-year');
            const mpaEl = document.getElementById('movie-search-mpa');
            if (yearEl) yearEl.value = '';
            if (mpaEl) mpaEl.value = '';
            homeSearchAppliedYear = '';
            homeSearchAppliedMpa = '';
            homeSearchFiltersDirty = false;
            const input = document.getElementById('movie-search-input');
            const q = String(input?.value || '').trim();
            if (!q) {
                clearHomeSearchUI();
                return;
            }
            handleSearch(q, { force: true });
        }

        let duplicateRatingContext = null;

        function openDuplicateRatingModal({ movie_id, tmdb_id, title } = {}) {
            duplicateRatingContext = {
                movie_id: movie_id || null,
                tmdb_id: tmdb_id || null,
                title: String(title || '').trim(),
            };

            const overlay = document.getElementById('duplicate-rating-overlay');
            const label = document.getElementById('duplicate-rating-movie');
            if (label) label.textContent = duplicateRatingContext.title || 'this movie';
            if (!overlay) return;
            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function closeDuplicateRatingModal() {
            const overlay = document.getElementById('duplicate-rating-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }
            duplicateRatingContext = null;
        }

        async function proceedDuplicateUpdateRatings() {
            const ctx = duplicateRatingContext;
            closeDuplicateRatingModal();

            const movieId = String(ctx?.movie_id || '').trim();
            if (!isUuidLike(movieId)) {
                showToast('Could not determine this movie record. Please search and select it again.', { level: 'warn' });
                router.navigate('home');
                return;
            }

            // Reuse the same update flow as the Home dropdown "Update Ratings" entry point
            // so we get the same prefill + locks.
            router.selectedMovie = {
                id: movieId,
                tmdb_id: Number.isFinite(Number(ctx?.tmdb_id)) ? Number(ctx.tmdb_id) : undefined,
                title: String(ctx?.title || '').trim(),
                detailsReadonly: true,
            };
            router.pendingTitle = router.selectedMovie.title || '';

            try {
                await router.startUpdateRatings();
            } catch (err) {
                showToast(`Update Ratings failed: ${String(err?.message || err)}`, { level: 'warn' });
            }
        }

        function proceedDuplicateReturnHome() {
            closeDuplicateRatingModal();
            router.navigate('home');
        }

        function handleSearch(query, opts = {}) {
            const results = document.getElementById('search-results');

            const q = String(query || '').trim();
            if (!results || !q || q.length < 1) {
                if (homeSearchDebounceTimer) clearTimeout(homeSearchDebounceTimer);
                if (homeSearchAbortController) homeSearchAbortController.abort();
                clearHomeSearchUI();
                return;
            }

            router.selectedMovie = null;
            router.pendingTitle = q;
            setHomeActionsVisible(false);
            setUpdateOptionsHidden();

            // Debounce + cancel in-flight request
            if (homeSearchDebounceTimer) clearTimeout(homeSearchDebounceTimer);
            if (homeSearchAbortController) homeSearchAbortController.abort();
            homeSearchAbortController = new AbortController();

            // Keep dropdown behavior similar: show results panel quickly, but avoid hammering the server.
            // Do not search until the user types at least 3 characters.
            if (q.length < 3) {
                results.classList.add('hidden');
                homeSearchItems = [];
                return;
            }

            const debounceMs = opts?.force ? 0 : 320;
            homeSearchDebounceTimer = setTimeout(async () => {
                try {
                    setHomeSearchLoading();

                    const data = await callSwiftApiSearchMovies({
                        query: q,
                        page: 1,
                        signal: homeSearchAbortController.signal,
                    });

                    const items = Array.isArray(data?.results) ? data.results : [];
                    renderHomeSearchResults(items);

                    // If nothing found, do not allow manual entry.
                    if (!items || items.length === 0) {
                        setHomeActionsVisible(false);
                        setUpdateOptionsHidden();
                    }
                } catch (err) {
                    // Ignore aborts
                    if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                    if (String(err?.message || '').toLowerCase().includes('aborted')) return;

                    showToast(`Search failed: ${String(err?.message || err)}`, { level: 'warn' });
                    results.innerHTML = `<div class="search-item text-gray justify-center">Search unavailable  please try again</div>`;
                    results.classList.remove('hidden');
                    setHomeActionsVisible(false);
                    setUpdateOptionsHidden();
                }
            }, debounceMs);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('open');
        }

        // Close the Lists-only movie search dropdown when clicking outside it.
        // (This is separate from the Home page search UI.)
        document.addEventListener('click', (e) => {
            const results = document.getElementById('lists-movie-search-results');
            const input = document.getElementById('lists-movie-search-input');
            if (!results || !input) return;
            const within = (e?.target && (results.contains(e.target) || input.contains(e.target)));
            if (!within) {
                try { results.classList.add('hidden'); } catch (_) {}
            }
        }, { capture: true });

        function initializeWatchMethodToggle() {
            const btn = document.getElementById('watchmethod-toggle');
            if (!btn) return;
            const hidden = document.getElementById('fld-watchmethod');
            const isTheater = btn.textContent.trim().toLowerCase().includes('theater');
            if (hidden) hidden.value = isTheater ? 'In Theater' : 'At Home';
            if (isTheater) {
                btn.style.backgroundColor = 'rgba(20, 184, 166, 0.35)';
                btn.style.borderColor = 'rgba(20, 184, 166, 0.5)';
            } else {
                btn.style.backgroundColor = 'rgba(168, 85, 247, 0.35)';
                btn.style.borderColor = 'rgba(168, 85, 247, 0.5)';
            }
        }

        function normalizeSeriesValue(seriesText) {
            const s = String(seriesText || '').trim().toLowerCase();
            if (!s) return '';
            if (s === 'yes' || s === 'true' || s === '1') return 'TRUE';
            if (s === 'no' || s === 'false' || s === '0') return 'FALSE';
            return seriesText;
        }

        function parseGenreString(value) {
            return String(value || '')
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);
        }

        function setGenreSelection(selectedGenres) {
            const hidden = document.getElementById('fld-genre');
            if (!hidden) return;
            const unique = Array.from(new Set((selectedGenres || []).map(s => String(s).trim()).filter(Boolean)));
            hidden.value = unique.join(', ');

            const wrap = document.getElementById('genre-chip-wrap');
            if (!wrap) return;

            wrap.querySelectorAll('button[data-genre]').forEach((btn) => {
                const g = btn.getAttribute('data-genre');
                const isOn = unique.includes(g);
                btn.classList.toggle('selected', isOn);
                btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
            });
        }

        function toggleGenreChip(btnEl) {
            if (!btnEl) return;
            const hidden = document.getElementById('fld-genre');
            if (!hidden) return;

            const genre = btnEl.getAttribute('data-genre');
            if (!genre) return;

            const current = parseGenreString(hidden.value);
            const isSelected = current.includes(genre);

            if (isSelected) {
                setGenreSelection(current.filter(g => g !== genre));
                return;
            }

            setGenreSelection([...current, genre]);
        }

        function clearInlineValidationHints() {
            try {
                document.querySelectorAll('.field-error-msg[data-inline-validation="true"]').forEach((n) => n.remove());
                document.querySelectorAll('.field-error-outline').forEach((n) => n.classList.remove('field-error-outline'));
            } catch (_) {}
        }

        function addInlineValidationHint(targetEl, message) {
            if (!targetEl) return;
            const msg = String(message || '').trim() || 'Required';

            const anchor = (() => {
                // Prefer a visual container for certain composite controls.
                const id = String(targetEl?.id || '').trim();
                if (id === 'fld-genre') return document.getElementById('genre-chip-wrap') || targetEl;
                if (id === 'fld-tier') {
                    return document.querySelector('.tier-btn-group[data-target-input="fld-tier"]') || targetEl;
                }
                if (id === 'fld-watchmethod') return document.getElementById('watchmethod-toggle') || targetEl;
                return targetEl;
            })();

            try {
                anchor?.classList?.add('field-error-outline');
            } catch (_) {}

            const wrap = anchor?.parentElement;
            if (!wrap) return;

            // Avoid duplicate messages if multiple validations run.
            try {
                const existing = wrap.querySelector('.field-error-msg[data-inline-validation="true"]');
                if (existing) return;
            } catch (_) {}

            const div = document.createElement('div');
            div.className = 'field-error-msg';
            div.setAttribute('data-inline-validation', 'true');
            div.textContent = msg;
            wrap.insertBefore(div, anchor);
        }

        function ensureMissingMovieDetailsOverlay() {
            let overlay = document.getElementById('missing-movie-details-overlay');
            if (overlay) return overlay;

            overlay = document.createElement('div');
            overlay.id = 'missing-movie-details-overlay';
            overlay.style.cssText = [
                'display:none',
                'position:fixed',
                'inset:0',
                'z-index:9999',
                'background:rgba(0,0,0,0.60)',
                'backdrop-filter: blur(6px)',
                '-webkit-backdrop-filter: blur(6px)',
                'align-items:center',
                'justify-content:center',
                'padding: 1.25rem'
            ].join(';');

            overlay.innerHTML = `
                <div class="glass-panel" style="max-width: 680px; width: 100%; border-radius: 1rem; padding: 1.25rem; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.55);">
                    <div class="flex" style="justify-content: space-between; align-items: flex-start; gap: 0.75rem;">
                        <div>
                            <div class="text-white" style="font-size: 1.15rem; font-weight: 950; letter-spacing: 0.01em;">Missing Movie Details</div>
                            <div class="text-gray" style="margin-top: 0.35rem; line-height: 1.45;">
                                Unfortunately this our API calls were unable to populate the following movie details for you:
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline" id="missing-movie-details-close" style="white-space: nowrap;">Close</button>
                    </div>
                    <div id="missing-movie-details-list" style="margin-top: 0.9rem; display:flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                    <div class="text-gray" style="margin-top: 0.95rem; line-height: 1.45;">
                        Please search the web and update these fields accordingly.
                    </div>
                </div>
            `;

            overlay.addEventListener('click', (e) => {
                if (e?.target === overlay) {
                    overlay.style.display = 'none';
                }
            });

            // Close button
            setTimeout(() => {
                const btn = document.getElementById('missing-movie-details-close');
                if (btn) btn.onclick = () => { overlay.style.display = 'none'; };
            }, 0);

            document.body.appendChild(overlay);
            return overlay;
        }

        function openMissingMovieDetailsOverlay(missingLabels) {
            const labels = Array.from(new Set((missingLabels || []).map((s) => String(s || '').trim()).filter(Boolean)));
            if (labels.length === 0) return;

            const overlay = ensureMissingMovieDetailsOverlay();
            const list = overlay.querySelector('#missing-movie-details-list');
            if (list) {
                list.innerHTML = labels
                    .map((l) => `<span class="dash-quote-pill" style="background: rgba(239, 68, 68, 0.12); border-color: rgba(239, 68, 68, 0.28);">${escapeHtml(l)}</span>`)
                    .join('');
            }

            overlay.style.display = 'flex';
        }

        function openDatePickerFromInput(el) {
            try {
                if (!el || el.disabled || el.readOnly) return;
                // Modern browsers: open the picker programmatically.
                if (typeof el.showPicker === 'function') {
                    el.showPicker();
                    return;
                }

                // Fallback: at least focus the field.
                if (typeof el.focus === 'function') el.focus();
            } catch (_) {}
        }

        function getMissingRequiredFieldsForDiaryFormCore() {
            // Core fields required before we do any network/save work.
            // This excludes Movie Details fields that we can attempt to re-hydrate from the API.
            const missing = [];

            const getEl = (id) => document.getElementById(id);
            const getText = (id) => String(getEl(id)?.value ?? '').trim();
            const isBlank = (v) => String(v ?? '').trim() === '';

            const ensureText = (id, label, { kind = 'review', anchorEl = null } = {}) => {
                const el = anchorEl || getEl(id);
                const v = getText(id);
                if (!el || isBlank(v)) missing.push({ label, el, kind });
            };

            const ensureNumber = (id, label, { min = null, max = null, kind = 'review', anchorEl = null } = {}) => {
                const el = anchorEl || getEl(id);
                const raw = getText(id);
                if (!el || isBlank(raw)) {
                    missing.push({ label, el, kind });
                    return;
                }
                const n = Number(raw);
                if (!Number.isFinite(n)) {
                    missing.push({ label, el, kind });
                    return;
                }
                if (min !== null && n < min) {
                    missing.push({ label, el, kind });
                    return;
                }
                if (max !== null && n > max) {
                    missing.push({ label, el, kind });
                    return;
                }
            };

            // Basic required fields
            ensureText('fld-datewatch', 'Date Watched');

            // Tier uses a hidden input + button group.
            {
                const tierEl = document.getElementById('fld-tier');
                const tierRaw = getText('fld-tier');
                const anchor = document.querySelector('.tier-btn-group[data-target-input="fld-tier"]') || tierEl;
                if (!anchor || isBlank(tierRaw)) missing.push({ label: 'Tier List', el: anchor, kind: 'review' });
            }

            // Need these to resolve the movie (and they're required regardless).
            ensureText('fld-title', 'Title', { kind: 'movie_details' });
            ensureNumber('fld-year', 'Year', { kind: 'movie_details', min: 1 });

            // Ratings
            ensureNumber('num-overall', 'Overall', { min: 0, max: 100 });
            ensureNumber('num-sound', 'Score (Sound)', { min: 0, max: 100 });
            ensureNumber('num-pace', 'Pace', { min: 0, max: 100 });
            ensureNumber('num-imagery', 'Imagery', { min: 0, max: 100 });
            ensureNumber('num-acting', 'Acting', { min: 0, max: 100 });
            ensureNumber('num-plot', 'Plot', { min: 0, max: 100 });
            ensureNumber('num-dialogue', 'Dialogue', { min: 0, max: 100 });

            ensureText('fld-notes', 'Notes');
            ensureNumber('fld-timeswatch', 'Times Watched', { min: 1 });

            // Watch method is stored in a hidden input controlled by a toggle button.
            {
                const el = document.getElementById('watchmethod-toggle') || getEl('fld-watchmethod');
                const raw = getText('fld-watchmethod');
                if (!el || isBlank(raw)) missing.push({ label: 'Watch Method', el, kind: 'review' });
            }

            return missing;
        }

        function getMissingRequiredFieldsForDiaryFormStrict() {
            const missing = [];

            const getEl = (id) => document.getElementById(id);
            const getText = (id) => String(getEl(id)?.value ?? '').trim();
            const isBlank = (v) => String(v ?? '').trim() === '';

            const ensureText = (id, label, { kind = 'review', anchorEl = null } = {}) => {
                const el = anchorEl || getEl(id);
                const v = getText(id);
                if (!el || isBlank(v)) missing.push({ label, el, kind });
            };

            const ensureNumber = (id, label, { min = null, max = null, kind = 'review', anchorEl = null } = {}) => {
                const el = anchorEl || getEl(id);
                const raw = getText(id);
                if (!el || isBlank(raw)) {
                    missing.push({ label, el, kind });
                    return;
                }
                const n = Number(raw);
                if (!Number.isFinite(n)) {
                    missing.push({ label, el, kind });
                    return;
                }
                if (min !== null && n < min) {
                    missing.push({ label, el, kind });
                    return;
                }
                if (max !== null && n > max) {
                    missing.push({ label, el, kind });
                    return;
                }
            };

            ensureText('fld-datewatch', 'Date Watched');

            // Tier uses a hidden input + button group.
            {
                const tierEl = document.getElementById('fld-tier');
                const tierRaw = getText('fld-tier');
                const anchor = document.querySelector('.tier-btn-group[data-target-input="fld-tier"]') || tierEl;
                if (!anchor || isBlank(tierRaw)) missing.push({ label: 'Tier List', el: anchor, kind: 'review' });
            }

            // Movie details (must be present before submit)
            ensureText('fld-title', 'Title', { kind: 'movie_details' });
            ensureNumber('fld-year', 'Year', { kind: 'movie_details', min: 1 });
            ensureText('fld-mpa', 'MPA', { kind: 'movie_details' });
            ensureNumber('fld-runtime', 'Runtime (min)', { kind: 'movie_details', min: 1 });
            ensureText('fld-series', 'Series?', { kind: 'movie_details' });
            ensureText('fld-director', 'Director', { kind: 'movie_details' });

            // Genre is submitted via a hidden input when using chips.
            {
                const el = document.getElementById('genre-chip-wrap') || getEl('fld-genre');
                const raw = getText('fld-genre');
                const picked = Array.isArray(parseGenreString(raw)) ? parseGenreString(raw) : [];
                if (!el || picked.length === 0) missing.push({ label: 'Genre', el, kind: 'movie_details' });
            }

            // Ratings
            ensureNumber('num-overall', 'Overall', { min: 0, max: 100 });
            ensureNumber('num-sound', 'Score (Sound)', { min: 0, max: 100 });
            ensureNumber('num-pace', 'Pace', { min: 0, max: 100 });
            ensureNumber('num-imagery', 'Imagery', { min: 0, max: 100 });
            ensureNumber('num-acting', 'Acting', { min: 0, max: 100 });
            ensureNumber('num-plot', 'Plot', { min: 0, max: 100 });
            ensureNumber('num-dialogue', 'Dialogue', { min: 0, max: 100 });

            ensureText('fld-notes', 'Notes');
            ensureNumber('fld-timeswatch', 'Times Watched', { min: 1 });

            // Watch method is stored in a hidden input controlled by a toggle button.
            {
                const el = document.getElementById('watchmethod-toggle') || getEl('fld-watchmethod');
                const raw = getText('fld-watchmethod');
                if (!el || isBlank(raw)) missing.push({ label: 'Watch Method', el, kind: 'review' });
            }

            // IMPORTANT: IMDb rating is required and 0 means "missing" in this UI.
            // Block save unless it's a real value.
            ensureNumber('fld-imdb', 'IMDb Rating', { kind: 'movie_details', min: 1, max: 100 });

            return missing;
        }

        function blockSubmitWithValidationUI(missing) {
            const items = Array.isArray(missing) ? missing : [];
            if (items.length === 0) return;

            clearInlineValidationHints();
            for (const m of items) {
                addInlineValidationHint(m?.el, `Missing: ${String(m?.label || '').trim() || 'Required field'}`);
            }

            const missingMovieDetails = items
                .filter((m) => String(m?.kind || '') === 'movie_details')
                .map((m) => m.label);
            if (missingMovieDetails.length > 0) {
                openMissingMovieDetailsOverlay(missingMovieDetails);
            }

            const labels = items.map(m => m.label);
            const list = labels.join(', ');
            showToast(`Please fill out: ${list}`, { level: 'warn', durationMs: 8000 });
            try {
                const firstEl = items.find(m => m?.el)?.el;
                if (firstEl && typeof firstEl.focus === 'function') firstEl.focus();
            } catch (_) {}
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const entryType = String(e.target.querySelector('input[name="entryType"]')?.value || '').trim().toLowerCase();
            // Hard guarantee: no DB writes if anything (except Favorite Quote) is missing.
            // Phase 1: validate core fields required to proceed.
            const coreMissing = getMissingRequiredFieldsForDiaryFormCore();
            if (coreMissing.length > 0) {
                blockSubmitWithValidationUI(coreMissing);
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `${icons.loader} Saving...`;
            btn.disabled = true;
            btn.style.opacity = 0.7;

            let lastKnownMovieId = null;
            let lastKnownTmdbId = null;
            let lastKnownTitle = '';
            let lastKnownEntryType = entryType;

            try {
                if (!supabaseClient) {
                    throw new Error('Supabase SDK failed to load. Check the Supabase <script> include and your network.');
                }
                const { user: authedUser, accessToken } = await requireAuthOrThrow();
                lastKnownEntryType = entryType;

                const toNumberOrNull = (v) => {
                    const n = Number(v);
                    return Number.isFinite(n) ? n : null;
                };

                const uuidLike = isUuidLike;

                const parseRuntimeMinutes = (raw) => {
                    const s = String(raw || '').trim();
                    if (!s) return null;
                    // Preferred: minutes (e.g., 136)
                    if (!s.includes(':')) {
                        const minutes = Number(s.replace(/\D/g, ''));
                        return Number.isFinite(minutes) ? minutes : null;
                    }
                    // Back-compat: accept HH:MM if someone types it.
                    const [hRaw, mRaw] = s.split(':');
                    const h = Number(String(hRaw || '').replace(/\D/g, ''));
                    const m = Number(String(mRaw || '').replace(/\D/g, ''));
                    if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
                    return h * 60 + m;
                };
                const selectedId = router?.selectedMovie?.id;
                const hiddenMovieId = String(document.getElementById('fld-movie-id')?.value || '').trim();
                const hiddenTmdbId = String(document.getElementById('fld-tmdb-id')?.value || '').trim();

                lastKnownTmdbId = hiddenTmdbId || String(router?.selectedMovie?.tmdb_id || '').trim();
                lastKnownTitle = String(document.getElementById('fld-title')?.value || router?.selectedMovie?.title || '').trim();

                // Best-effort: if any Movie Details fields are missing (including IMDb), try re-hydrating
                // from the public details endpoint BEFORE we decide whether to block saving.
                try {
                    const strictPre = getMissingRequiredFieldsForDiaryFormStrict();
                    const missingMovieLabels = strictPre
                        .filter((m) => String(m?.kind || '') === 'movie_details')
                        .map((m) => m.label);

                    const tmdbIdNum = Number(hiddenTmdbId || lastKnownTmdbId || 0);
                    if (missingMovieLabels.length > 0 && Number.isFinite(tmdbIdNum) && tmdbIdNum > 0) {
                        const details = await callSwiftApiGetMovieDetails({ tmdb_id: tmdbIdNum });
                        if (details) {
                            const title = String(details?.title ?? '').trim();
                            const year = Number(details?.year ?? 0);
                            const runtime = Number(details?.runtime ?? 0);
                            const mpa = String(details?.mpa ?? '').trim();
                            const isSeries = details?.isSeries;
                            const director = String(details?.director ?? '').trim();
                            const genres = Array.isArray(details?.genres) ? details.genres : [];
                            const imdbPct = Number(details?.imdb_rating_pct ?? 0);

                            if (title) {
                                const el = document.getElementById('fld-title');
                                if (el) el.value = title;
                            }
                            if (Number.isFinite(year) && year > 0) {
                                const el = document.getElementById('fld-year');
                                if (el && !String(el.value || '').trim()) el.value = String(year);
                            }
                            if (mpa) {
                                const el = document.getElementById('fld-mpa');
                                if (el && !String(el.value || '').trim()) el.value = mpa;
                            }
                            if (Number.isFinite(runtime) && runtime > 0) {
                                const el = document.getElementById('fld-runtime');
                                if (el && !String(el.value || '').trim()) el.value = String(runtime);
                            }
                            if (isSeries === true || isSeries === false) {
                                const el = document.getElementById('fld-series');
                                const val = isSeries ? 'TRUE' : 'FALSE';
                                if (el && !String(el.value || '').trim()) el.value = val;
                            }
                            if (director) {
                                const el = document.getElementById('fld-director');
                                if (el && !String(el.value || '').trim()) el.value = director;
                            }
                            if (genres.length > 0) {
                                try {
                                    const current = parseGenreString(String(document.getElementById('fld-genre')?.value || ''));
                                    if (!Array.isArray(current) || current.length === 0) {
                                        setGenreSelection(genres);
                                    }
                                } catch (_) {}
                            }
                            if (Number.isFinite(imdbPct) && imdbPct > 0) {
                                const el = document.getElementById('fld-imdb');
                                const range = document.getElementById('fld-imdb-range');
                                if (el && (!String(el.value || '').trim() || Number(el.value) === 0)) el.value = String(Math.round(imdbPct));
                                if (range) range.value = String(Math.round(imdbPct));
                            }
                        }
                    }
                } catch (_) {
                    // Ignore hydration failures; strict validation below will catch missing fields.
                }

                // Phase 2: strict validation (includes Movie Details + IMDb).
                // If anything is still missing, BLOCK before any DB writes.
                const strictMissing = getMissingRequiredFieldsForDiaryFormStrict();
                if (strictMissing.length > 0) {
                    blockSubmitWithValidationUI(strictMissing);
                    return;
                }

                // Clear any stale validation messages once the form is valid.
                clearInlineValidationHints();

                let movie_id = uuidLike(hiddenMovieId)
                    ? hiddenMovieId
                    : (uuidLike(selectedId) ? selectedId : null);

                const movieIdWasSelected = Boolean(movie_id);

                // Updates must target an existing (user,movie) rating row.
                // Do not attempt any title-based resolution/upsert for updates.
                if (entryType === 'update' && !movie_id) {
                    // Last chance: if we have a tmdb_id from the form, map it to a DB UUID.
                    if (hiddenTmdbId) {
                        try {
                            const mapped = await getDbMovieIdByTmdbId(Number(hiddenTmdbId));
                            if (uuidLike(mapped)) movie_id = mapped;
                        } catch (_) {}
                    }

                    if (!movie_id) {
                        throw new Error('To update ratings, open the form via Update Ratings for a movie already in your diary.');
                    }
                }

                const shouldSyncPeople = entryType === 'new';

                if (!movie_id) {
                    const title = String(document.getElementById('fld-title')?.value || '').trim();
                    const release_year = toNumberOrNull(document.getElementById('fld-year')?.value);

                    if (!title) throw new Error('Title is required.');

                    // TMDb lookup + Movies upsert happens server-side in an Edge Function.
                    // This avoids exposing a TMDb key in the browser and allows Movies to remain read-only under RLS.
                    const tmdbData = await callSwiftApi(
                        { title, release_year: release_year ?? null, sync_people: shouldSyncPeople },
                        accessToken
                    );

                    movie_id = tmdbData?.movie_id || null;

                    // People sync should never block saving the rating.
                    if (tmdbData?.people_sync && tmdbData.people_sync.ok === false) {
                        const msg = tmdbData.people_sync.details
                            ? `${tmdbData.people_sync.message} (${tmdbData.people_sync.details})`
                            : `${tmdbData.people_sync.message}`;
                        showToast(`Cast sync warning: ${msg}`);
                    }
                }

                // If the movie already exists/was selected, still sync People when logging a New Entry.
                // Avoid calling twice when we just created/resolved the movie via title lookup.
                if (movieIdWasSelected && movie_id && shouldSyncPeople && uuidLike(movie_id)) {
                    try {
                        const peopleRes = await callSwiftApi({ movie_id, sync_people: true }, accessToken);
                        if (peopleRes?.people_sync && peopleRes.people_sync.ok === false) {
                            const msg = peopleRes.people_sync.details
                                ? `${peopleRes.people_sync.message} (${peopleRes.people_sync.details})`
                                : `${peopleRes.people_sync.message}`;
                            showToast(`Cast sync warning: ${msg}`);
                        }
                    } catch (e) {
                        showToast(`Cast sync warning: ${String(e?.message || e)}`);
                    }
                }

                if (!movie_id) throw new Error('Failed to determine movie_id.');

                lastKnownMovieId = movie_id;

                // NOTE: Only after strict validation passes do we run any server-side sync that writes to DB.
                // ("Movie External Ratings" has no user_id; it should be written from the Edge Function.)
                try {
                    const syncRes = await callSwiftApi({ movie_id, sync_people: false }, accessToken);
                    const imdbPct = syncRes?.imdb_rating_pct;
                    if (imdbPct !== null && imdbPct !== undefined) {
                        const imdbEl = document.getElementById('fld-imdb');
                        const imdbVal = String(imdbEl?.value || '').trim();
                        if (imdbEl && (!imdbVal || Number(imdbVal) === 0)) {
                            imdbEl.value = String(imdbPct);
                        }

                        const imdbPctNum = Number(imdbPct);
                        if (Number.isFinite(imdbPctNum) && imdbPctNum > 0) {
                            try {
                                imdbEl?.setAttribute('readonly', '');
                                imdbEl?.classList?.add('input-readonly');
                                document.getElementById('fld-imdb-range')?.setAttribute('disabled', '');
                            } catch (_) {}
                        }
                    }

                    const ext = syncRes?.external_ratings?.imdb;
                    if (ext && ext.ok === false && ext.error) {
                        showToast(`IMDb sync warning: ${String(ext.error)}`, { level: 'warn' });
                    }
                } catch (e) {
                    showToast(`IMDb sync warning: ${String(e?.message || e)}`, { level: 'warn' });
                }

                const tier = String(document.getElementById('fld-tier')?.value || '').trim() || null;
                const overall_rating = toNumberOrNull(document.getElementById('num-overall')?.value);
                const acting_rating = toNumberOrNull(document.getElementById('num-acting')?.value);
                const pacing_rating = toNumberOrNull(document.getElementById('num-pace')?.value);
                const sound_rating = toNumberOrNull(document.getElementById('num-sound')?.value);
                const imagery_rating = toNumberOrNull(document.getElementById('num-imagery')?.value);
                const plot_rating = toNumberOrNull(document.getElementById('num-plot')?.value);
                const dialogue_rating = toNumberOrNull(document.getElementById('num-dialogue')?.value);
                const notes = String(document.getElementById('fld-notes')?.value || '').trim() || null;
                const fav_quote = String(document.getElementById('fld-quote')?.value || '').trim() || null;
                const watch_method = String(document.getElementById('fld-watchmethod')?.value || '').trim() || null;
                const watch_date_from_form = String(document.getElementById('fld-datewatch')?.value || '').trim();
                const times_watched_raw = toNumberOrNull(document.getElementById('fld-timeswatch')?.value);
                const times_watched = Number.isFinite(times_watched_raw)
                    ? Math.max(1, Math.floor(Number(times_watched_raw)))
                    : 1;

                if (!watch_date_from_form) {
                    throw new Error('Date Watched is required.');
                }

                if (!Number.isFinite(times_watched) || times_watched < 1) {
                    throw new Error('Times Watched must be at least 1.');
                }

                const insertRow = {
                    user_id: authedUser.id,
                    movie_id,
                    [COL_WATCH_DATE]: watch_date_from_form,
                    tier,
                    overall_rating,
                    acting_rating,
                    pacing_rating,
                    sound_rating,
                    imagery_rating,
                    plot_rating,
                    dialogue_rating,
                    notes,
                    fav_quote
                };

                if (entryType === 'update') {
                    const choice = await promptUpdateWatchChoice();
                    if (!choice) {
                        showToast('Update canceled.', { level: 'warn' });
                        return;
                    }
                    const shouldAddWatch = choice === 'update_and_watch';

                    let watchChoice = null;
                    if (shouldAddWatch) {
                        watchChoice = await promptWatchMethodChoice();
                        if (!watchChoice) {
                            showToast('Update canceled.', { level: 'warn' });
                            return;
                        }
                    }

                    const updateRow = {
                        tier,
                        overall_rating,
                        acting_rating,
                        pacing_rating,
                        sound_rating,
                        imagery_rating,
                        plot_rating,
                        dialogue_rating,
                        notes,
                        fav_quote,
                        updated_at: new Date().toISOString(),
                    };

                    // Final safety gate: absolutely no DB writes if anything is missing.
                    // (This should already be true, but we re-check right before writing.)
                    {
                        const finalMissing = getMissingRequiredFieldsForDiaryFormStrict();
                        if (finalMissing.length > 0) {
                            blockSubmitWithValidationUI(finalMissing);
                            return;
                        }
                    }

                    const { error: updateError } = await supabaseClient
                        .from('Movie Ratings')
                        .update(updateRow)
                        .eq('user_id', authedUser.id)
                        .eq('movie_id', movie_id);

                    if (updateError) throw updateError;

                    if (shouldAddWatch) {
                        await insertWatchLog({
                            user_id: authedUser.id,
                            movie_id,
                            watch_method: watchChoice.watch_method,
                            watch_date: watchChoice.watch_date,
                        });
                    }

                    // Best-effort: if this movie was in Bucket List, remove it now that it's rated.
                    try {
                        await removeMovieFromBucketList({ user_id: authedUser.id, movie_id });
                    } catch (_) {}

                    checkAndAwardRatingMilestones().catch(() => null);

                    openRatingsSuccessModal('updated');
                    return;
                }

                // Final safety gate: absolutely no DB writes if anything is missing.
                // (This should already be true, but we re-check right before writing.)
                {
                    const finalMissing = getMissingRequiredFieldsForDiaryFormStrict();
                    if (finalMissing.length > 0) {
                        blockSubmitWithValidationUI(finalMissing);
                        return;
                    }
                }

                const { error: insertError } = await supabaseClient
                    .from('Movie Ratings')
                    .insert(insertRow);

                if (insertError) throw insertError;

                // Only create a Watch Logs row for "Log as New Entry" once per (user,movie),
                // and only after the Movie Ratings insert succeeds.
                if (entryType === 'new') {
                    await insertWatchLogIfMissing({
                        user_id: authedUser.id,
                        movie_id,
                        watch_method,
                        watch_date: watch_date_from_form,
                    });
                }

                // If user says they've watched this movie multiple times, collect the prior watches now.
                // We treat the current save as 1 watch, and ask for the previous (times_watched - 1) entries.
                if (entryType === 'new' && times_watched > 1) {
                    const priorCount = times_watched - 1;
                    const prior = await promptPriorWatches(priorCount);
                    if (prior && Array.isArray(prior.entries) && prior.entries.length > 0) {
                        await insertWatchLogsBulk({
                            user_id: authedUser.id,
                            movie_id,
                            entries: prior.entries,
                        });
                        showToast(`Added ${prior.entries.length} previous watch${prior.entries.length === 1 ? '' : 'es'}!`);
                    }
                }

                // Best-effort: if this movie was in Bucket List, remove it now that it's rated.
                try {
                    await removeMovieFromBucketList({ user_id: authedUser.id, movie_id });
                } catch (_) {}

                checkAndAwardRatingMilestones().catch(() => null);

                openRatingsSuccessModal('saved');
                return;
            } catch (err) {
                const msg = String(err?.message || err || 'Unknown error');
                const code = String(err?.code || '').trim();
                const isDuplicate =
                    code === '23505' ||
                    msg.toLowerCase().includes('duplicate key value') ||
                    msg.includes('movie_ratings_user_movie_unique');

                if (isDuplicate && String(lastKnownEntryType || '').toLowerCase() === 'new') {
                    openDuplicateRatingModal({
                        movie_id: lastKnownMovieId,
                        tmdb_id: lastKnownTmdbId,
                        title: lastKnownTitle,
                    });
                    return;
                }

                showToast(`Save failed: ${msg}`);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        }

        let updateWatchChoiceResolver = null;
        let watchMethodChoiceResolver = null;
        let watchMethodPendingSelection = null;
        let priorWatchesChoiceResolver = null;
        let priorWatchesPendingCount = 0;

        let ratingsSuccessTimer = null;
        let achievementPopupQueue = [];
        let achievementPopupOpen = false;
        let achievementsByName = new Map();
        let achievementsList = [];
        let userAchievementIds = new Set();
        let userTierSummary = null;
        let userTiersList = [];
        const TEST_ACHIEVEMENT_EMAIL = 'landon.talus@gmail.com';
        let testAchievementEnabled = false;

        const RATING_MILESTONES = [10, 25, 50, 100, 150, 250, 500, 1000];

        function buildRatingAchievementName(count) {
            return `Rated ${count} Movies`;
        }

        async function loadAchievementsDefinitions() {
            if (!supabaseClient) return;
            const { data, error } = await supabaseClient
                .from('Achievements')
                .select('id, name, description, icon_url, tier, type, points, is_active')
                .order('points', { ascending: true });
            if (error || !Array.isArray(data)) return;

            const nextList = data.filter((row) => row?.is_active !== false);
            const nextMap = new Map();
            nextList.forEach((row) => {
                const name = String(row?.name || '').trim();
                if (name) nextMap.set(name, row);
            });
            achievementsList = nextList;
            achievementsByName = nextMap;
            syncAchievementFilterOptions();
        }

        async function loadUserAchievements(userId) {
            if (!supabaseClient || !userId) return;
            const { data, error } = await supabaseClient
                .from('User Achievements')
                .select('achievement_id, earned_at')
                .eq('user_id', userId);
            if (error || !Array.isArray(data)) return;

            userAchievementIds = new Set(data.map((row) => String(row?.achievement_id || '')).filter(Boolean));
        }

        async function loadUserTierSummary(userId) {
            if (!supabaseClient || !userId) return;

            const { data: userData, error: userError } = await supabaseClient
                .from('Users')
                .select('achievement_points, tier_id')
                .eq('id', userId)
                .limit(1);
            if (userError || !Array.isArray(userData)) return;

            const userRow = userData[0] || null;
            const points = Number(userRow?.achievement_points || 0) || 0;
            const tierId = String(userRow?.tier_id || '').trim();

            const { data: tiersData, error: tiersError } = await supabaseClient
                .from('User Tiers')
                .select('id, name, tier_icon_url, points_needed')
                .order('points_needed', { ascending: true });
            if (tiersError || !Array.isArray(tiersData)) return;

            userTiersList = tiersData;

            let currentTier = tiersData.find((t) => String(t?.id || '').trim() === tierId) || null;
            if (!currentTier) {
                currentTier = tiersData
                    .filter((t) => Number(t?.points_needed || 0) <= points)
                    .slice(-1)[0] || tiersData[0] || null;
            }

            const currentPointsNeeded = Number(currentTier?.points_needed || 0) || 0;
            const nextTier = tiersData.find((t) => Number(t?.points_needed || 0) > points) || null;
            const nextPointsNeeded = Number(nextTier?.points_needed || 0) || 0;
            const span = Math.max(1, nextPointsNeeded - currentPointsNeeded);
            const progress = nextTier ? Math.min(1, Math.max(0, (points - currentPointsNeeded) / span)) : 1;

            userTierSummary = {
                points,
                currentTier,
                nextTier,
                progress,
            };
        }

        function updateTestAchievementVisibility(email) {
            const btn = document.getElementById('account-test-achievement-btn');
            const select = document.getElementById('account-test-achievement-select');
            const panel = document.getElementById('account-achievement-test-panel');
            if (!btn || !select) return;
            const target = String(TEST_ACHIEVEMENT_EMAIL || '').trim().toLowerCase();
            const current = String(email || '').trim().toLowerCase();
            const shouldShow = Boolean(target && current && target === current);
            testAchievementEnabled = shouldShow;
            btn.style.display = shouldShow ? 'inline-flex' : 'none';
            select.style.display = shouldShow ? 'inline-flex' : 'none';
            if (panel) panel.style.display = shouldShow ? 'block' : 'none';
            if (shouldShow) {
                syncTestAchievementOptions();
            }
        }

        function syncTestAchievementOptions() {
            const select = document.getElementById('account-test-achievement-select');
            if (!select) return;
            if (!Array.isArray(achievementsList) || achievementsList.length === 0) {
                select.innerHTML = '<option value="">No achievements loaded</option>';
                return;
            }

            const currentValue = String(select.value || '').trim();
            const options = ['<option value="">Select achievement...</option>'];
            achievementsList.forEach((row) => {
                const id = String(row?.id || '').trim();
                const name = String(row?.name || '').trim();
                const tier = String(row?.tier || '').trim();
                const points = Number(row?.points || 0) || 0;
                if (!id || !name) return;
                const label = [name, tier ? `(${tier})` : '', points ? `- ${points} pts` : ''].filter(Boolean).join(' ');
                options.push(`<option value="${escapeHtml(id)}">${escapeHtml(label)}</option>`);
            });
            select.innerHTML = options.join('');
            if (currentValue) select.value = currentValue;
        }

        let achievementSortMode = 'points_asc';
        let achievementTypeFilter = 'all';
        let achievementFiltersOpen = false;

        function syncAchievementFilterOptions() {
            const select = document.getElementById('account-achievement-filter');
            if (!select) return;
            if (!Array.isArray(achievementsList) || achievementsList.length === 0) {
                select.innerHTML = '<option value="all">All types</option>';
                return;
            }

            const currentValue = String(select.value || achievementTypeFilter || 'all').trim();
            const types = Array.from(new Set(achievementsList
                .map((row) => String(row?.type || '').trim())
                .filter(Boolean))).sort();

            const options = ['<option value="all">All types</option>'];
            types.forEach((type) => {
                options.push(`<option value="${escapeHtml(type)}">${escapeHtml(type)}</option>`);
            });
            select.innerHTML = options.join('');
            select.value = types.includes(currentValue) ? currentValue : 'all';
            achievementTypeFilter = select.value;
        }

        function syncAchievementSortControl() {
            const select = document.getElementById('account-achievement-sort');
            if (!select) return;
            const value = String(achievementSortMode || 'points_desc').trim();
            if (select.value !== value) select.value = value;
        }

        function setAchievementFiltersOpen(isOpen) {
            const pop = document.getElementById('account-achievement-filters-pop');
            const btn = document.getElementById('account-achievement-filters-btn');
            if (!pop || !btn) return;
            achievementFiltersOpen = Boolean(isOpen);
            pop.classList.toggle('is-open', achievementFiltersOpen);
            pop.setAttribute('aria-hidden', achievementFiltersOpen ? 'false' : 'true');
            btn.setAttribute('aria-expanded', achievementFiltersOpen ? 'true' : 'false');
        }

        function toggleAchievementFiltersOpen() {
            setAchievementFiltersOpen(!achievementFiltersOpen);
        }

        function getFilteredAchievementsList() {
            const filtered = achievementsList.filter((row) => {
                if (!achievementTypeFilter || achievementTypeFilter === 'all') return true;
                const type = String(row?.type || '').trim();
                return type === achievementTypeFilter;
            });

            const sorted = filtered.slice().sort((a, b) => {
                const pointsA = Number(a?.points || 0) || 0;
                const pointsB = Number(b?.points || 0) || 0;
                if (pointsA === pointsB) return String(a?.name || '').localeCompare(String(b?.name || ''));
                return achievementSortMode === 'points_asc' ? pointsA - pointsB : pointsB - pointsA;
            });

            return sorted;
        }


        async function triggerTestAchievementPopup() {
            if (!cachedIsAuthed || !testAchievementEnabled) return;
            if (!achievementsList.length) {
                await loadAchievementsDefinitions();
                syncTestAchievementOptions();
            }

            const select = document.getElementById('account-test-achievement-select');
            const selectedId = String(select?.value || '').trim();
            let def = null;

            if (selectedId) {
                def = achievementsList.find((row) => String(row?.id || '').trim() === selectedId) || null;
            }

            if (!def && achievementsList.length > 0) {
                def = achievementsList[0];
            }

            if (!def) return;
            enqueueAchievementPopup(def);
        }

        function renderAccountTierSummary() {
            const card = document.getElementById('account-tier-summary');
            if (!card) return;

            const nameEl = document.getElementById('account-tier-name');
            const iconEl = document.getElementById('account-tier-icon');
            const pointsEl = document.getElementById('account-tier-points');
            const nextEl = document.getElementById('account-tier-next');
            const progressEl = document.getElementById('account-tier-progress');

            if (!cachedIsAuthed) {
                if (nameEl) nameEl.textContent = '';
                if (pointsEl) pointsEl.textContent = 'Log in to view points.';
                if (nextEl) nextEl.textContent = '';
                if (progressEl) progressEl.style.width = '0%';
                if (iconEl) iconEl.textContent = '?';
                card.dataset.tier = 'Extra';
                return;
            }

            const summary = userTierSummary || null;
            const tierName = String(summary?.currentTier?.name || '').trim() || 'Unranked';
            const tierIconUrl = String(summary?.currentTier?.tier_icon_url || '').trim();
            const points = Number(summary?.points || 0) || 0;
            const nextTierName = String(summary?.nextTier?.name || '').trim();
            const nextPointsNeeded = Number(summary?.nextTier?.points_needed || 0) || 0;
            const pct = Math.round((Number(summary?.progress || 0) || 0) * 100);

            if (nameEl) nameEl.textContent = tierName;
            if (pointsEl) pointsEl.textContent = `${points} pts`;
            if (nextEl) {
                nextEl.textContent = nextTierName
                    ? `${nextPointsNeeded - points} to next tier`
                    : 'Top tier achieved.';
            }
            if (progressEl) progressEl.style.width = `${pct}%`;
            card.dataset.tier = tierName || 'Extra';

            if (iconEl) {
                iconEl.innerHTML = tierIconUrl
                    ? `<img src="${tierIconUrl}" alt="${escapeHtml(tierName)}">`
                    : '?';
            }
        }

        function renderAccountAchievements() {
            const list = document.getElementById('account-achievements-list');
            if (!list) return;

            syncAchievementSortControl();
            syncAchievementFilterOptions();

            if (!cachedIsAuthed) {
                list.innerHTML = '<div class="text-xs text-gray">Log in to view your achievements.</div>';
                return;
            }

            if (!achievementsList.length) {
                list.innerHTML = '<div class="text-xs text-gray">No achievements found.</div>';
                return;
            }

            const filtered = getFilteredAchievementsList();
            if (!filtered.length) {
                list.innerHTML = '<div class="text-xs text-gray">No achievements match those filters.</div>';
                return;
            }

            list.innerHTML = filtered.map((row) => {
                const id = String(row?.id || '').trim();
                const name = String(row?.name || '').trim() || 'Achievement';
                const desc = String(row?.description || '').trim();
                const iconUrl = String(row?.icon_url || '').trim();
                const tier = String(row?.tier || '').trim();
                const type = String(row?.type || '').trim();
                const points = Number(row?.points || 0) || 0;
                const earned = id && userAchievementIds.has(id);
                const meta = [points ? `${points} pts` : '', earned ? 'Earned' : 'Locked'].filter(Boolean).join('  ');
                const tierLabel = tier || 'Achievement';

                return `
                    <div class="achievement-card ${earned ? '' : 'locked'}" data-tier="${escapeHtml(tierLabel)}" data-type="${escapeHtml(type)}" data-achievement-id="${escapeHtml(id)}">
                        <div class="achievement-header">
                            <div class="achievement-icon">
                                ${iconUrl ? `<img src="${iconUrl}" alt="${escapeHtml(name)}">` : '<span class="text-xs text-gray">?</span>'}
                            </div>
                            <div class="achievement-badge">${escapeHtml(tierLabel)}</div>
                        </div>
                        <div class="achievement-title">${escapeHtml(name)}</div>
                        ${desc ? `<div class="achievement-meta">${escapeHtml(desc)}</div>` : ''}
                        ${meta ? `<div class="achievement-meta">${escapeHtml(meta)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        let achievementEvidenceCache = null;
        let achievementEvidenceCacheUserId = null;
        let achievementEvidenceLoading = null;

        function closeAchievementDetail() {
            const overlay = document.getElementById('achievement-detail-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';
        }

        async function openAchievementDetail(achievementId) {
            if (!achievementId || !cachedIsAuthed || !supabaseClient) return;
            const overlay = document.getElementById('achievement-detail-overlay');
            const titleEl = document.getElementById('achievement-detail-title');
            const bodyEl = document.getElementById('achievement-detail-body');
            if (!overlay || !titleEl || !bodyEl) return;

            const achievement = achievementsList.find((row) => String(row?.id || '').trim() === achievementId) || null;
            if (!achievement) return;

            titleEl.textContent = String(achievement?.name || 'Achievement Details');
            bodyEl.innerHTML = '<div class="text-xs text-gray">Loading details...</div>';
            overlay.style.display = 'flex';

            const uid = String(cachedAuthUser?.id || '').trim();
            if (!uid) return;

            const data = (await loadAchievementEvidence(uid)) || getEmptyAchievementEvidence();
            const earned = userAchievementIds.has(achievementId);
            bodyEl.innerHTML = buildAchievementEvidenceHtml(achievement, data, earned);
        }

        async function loadAchievementEvidence(userId) {
            if (achievementEvidenceCache && achievementEvidenceCacheUserId === userId) return achievementEvidenceCache;
            if (achievementEvidenceLoading && achievementEvidenceCacheUserId === userId) return achievementEvidenceLoading;

            achievementEvidenceCache = null;
            achievementEvidenceLoading = null;
            achievementEvidenceCacheUserId = userId;

            achievementEvidenceLoading = (async () => {
                const ratingsRes = await supabaseClient
                    .from('Movie Ratings')
                    .select('movie_id, watch_date')
                    .eq('user_id', userId);
                const watchRes = await supabaseClient
                    .from('Watch Logs')
                    .select('movie_id, watch_date')
                    .eq('user_id', userId);

                const ratings = Array.isArray(ratingsRes?.data) ? ratingsRes.data : [];
                const watchLogs = Array.isArray(watchRes?.data) ? watchRes.data : [];

                const ratedMovieIds = Array.from(new Set(ratings.map((row) => String(row?.movie_id || '')).filter(Boolean)));
                const watchedMovieIds = Array.from(new Set(watchLogs.map((row) => String(row?.movie_id || '')).filter(Boolean)));
                const allMovieIds = Array.from(new Set([...ratedMovieIds, ...watchedMovieIds]));

                let movies = [];
                if (allMovieIds.length) {
                    const moviesRes = await supabaseClient
                        .from('Movies')
                        .select('id, title, release_year')
                        .in('id', allMovieIds);
                    movies = Array.isArray(moviesRes?.data) ? moviesRes.data : [];
                }
                const moviesById = new Map(movies.map((m) => [String(m?.id || ''), m]));

                let movieGenres = [];
                if (ratedMovieIds.length) {
                    const mgRes = await supabaseClient
                        .from('Movie Genres')
                        .select('movie_id, genre_id')
                        .in('movie_id', ratedMovieIds);
                    movieGenres = Array.isArray(mgRes?.data) ? mgRes.data : [];
                }

                const genreIds = Array.from(new Set(movieGenres.map((row) => String(row?.genre_id || '')).filter(Boolean)));
                let genres = [];
                if (genreIds.length) {
                    const genresRes = await supabaseClient
                        .from('Genres')
                        .select('id, name')
                        .in('id', genreIds);
                    genres = Array.isArray(genresRes?.data) ? genresRes.data : [];
                }
                const genreNamesById = new Map(genres.map((g) => [String(g?.id || ''), String(g?.name || '')]));

                const allGenresRes = await supabaseClient
                    .from('Genres')
                    .select('id, name');
                const allGenres = Array.isArray(allGenresRes?.data) ? allGenresRes.data : [];
                const allGenreNames = allGenres.map((g) => String(g?.name || '')).filter(Boolean).sort();

                let movieCrew = [];
                if (ratedMovieIds.length) {
                    const crewRes = await supabaseClient
                        .from('Movie Crew')
                        .select('movie_id, person_id, job')
                        .eq('job', 'Director')
                        .in('movie_id', ratedMovieIds);
                    movieCrew = Array.isArray(crewRes?.data) ? crewRes.data : [];
                }

                const directorIds = Array.from(new Set(movieCrew.map((row) => String(row?.person_id || '')).filter(Boolean)));
                let people = [];
                if (directorIds.length) {
                    const peopleRes = await supabaseClient
                        .from('People')
                        .select('id, name')
                        .in('id', directorIds);
                    people = Array.isArray(peopleRes?.data) ? peopleRes.data : [];
                }
                const peopleById = new Map(people.map((p) => [String(p?.id || ''), String(p?.name || '')]));

                const ratingsCount = ratedMovieIds.length;

                const genreSet = new Set();
                movieGenres.forEach((row) => {
                    const name = genreNamesById.get(String(row?.genre_id || ''));
                    if (name) genreSet.add(name);
                });
                const genreList = Array.from(genreSet).sort();

                const decadeSet = new Set();
                ratedMovieIds.forEach((movieId) => {
                    const year = Number(moviesById.get(movieId)?.release_year);
                    if (Number.isFinite(year) && year > 0) {
                        decadeSet.add(Math.floor(year / 10) * 10);
                    }
                });
                const decadeList = Array.from(decadeSet).sort((a, b) => a - b);

                const directorMovieMap = new Map();
                movieCrew.forEach((row) => {
                    const personId = String(row?.person_id || '');
                    const movieId = String(row?.movie_id || '');
                    if (!personId || !movieId) return;
                    if (!directorMovieMap.has(personId)) directorMovieMap.set(personId, new Set());
                    directorMovieMap.get(personId).add(movieId);
                });
                const directorCounts = Array.from(directorMovieMap.entries()).map(([personId, movieSet]) => ({
                    personId,
                    count: movieSet.size,
                    name: peopleById.get(personId) || 'Unknown Director',
                })).sort((a, b) => b.count - a.count);
                const topDirector = directorCounts[0] || null;

                const rewatchMap = new Map();
                watchLogs.forEach((row) => {
                    const movieId = String(row?.movie_id || '');
                    if (!movieId) return;
                    rewatchMap.set(movieId, (rewatchMap.get(movieId) || 0) + 1);
                });
                let topRewatch = null;
                let topRewatchIds = [];
                rewatchMap.forEach((count, movieId) => {
                    if (!topRewatch || count > topRewatch.count) {
                        topRewatch = { movieId, count };
                        topRewatchIds = [movieId];
                    } else if (topRewatch && count === topRewatch.count) {
                        topRewatchIds.push(movieId);
                    }
                });
                const topRewatchTitles = topRewatchIds.map((movieId) => String(moviesById.get(movieId)?.title || 'Unknown Movie'));

                const dailyCounts = new Map();
                const watchLogsByDay = new Map();
                watchLogs.forEach((row) => {
                    const dayNum = toDayNumber(row?.watch_date);
                    const movieId = String(row?.movie_id || '');
                    if (dayNum === null || !movieId) return;
                    dailyCounts.set(dayNum, (dailyCounts.get(dayNum) || 0) + 1);
                    if (!watchLogsByDay.has(dayNum)) watchLogsByDay.set(dayNum, []);
                    watchLogsByDay.get(dayNum).push(movieId);
                });
                const dailyEntries = Array.from(dailyCounts.entries()).sort((a, b) => a[0] - b[0]);

                let maxDayCount = 0;
                let maxDayNum = null;
                dailyEntries.forEach(([dayNum, count]) => {
                    if (count > maxDayCount) {
                        maxDayCount = count;
                        maxDayNum = dayNum;
                    }
                });

                let rollingWeekMax = 0;
                let rollingWeekEnd = null;
                let startIdx = 0;
                let sum = 0;
                for (let i = 0; i < dailyEntries.length; i += 1) {
                    const [dayNum, count] = dailyEntries[i];
                    sum += count;
                    while (dayNum - dailyEntries[startIdx][0] > 6) {
                        sum -= dailyEntries[startIdx][1];
                        startIdx += 1;
                    }
                    if (sum > rollingWeekMax) {
                        rollingWeekMax = sum;
                        rollingWeekEnd = dayNum;
                    }
                }

                let dailyStreakMax = 0;
                let bestStreakStart = null;
                let bestStreakEnd = null;
                let currentStreak = 0;
                let currentStreakStart = null;
                let prevDay = null;
                dailyEntries.forEach(([dayNum]) => {
                    if (prevDay === null || dayNum !== prevDay + 1) {
                        currentStreak = 1;
                        currentStreakStart = dayNum;
                    } else {
                        currentStreak += 1;
                    }
                    if (currentStreak > dailyStreakMax) {
                        dailyStreakMax = currentStreak;
                        bestStreakStart = currentStreakStart;
                        bestStreakEnd = dayNum;
                    }
                    prevDay = dayNum;
                });

                let currentDailyStreak = 0;
                let currentDailyStreakStart = null;
                let currentDailyStreakEnd = null;
                if (dailyEntries.length) {
                    currentDailyStreakEnd = dailyEntries[dailyEntries.length - 1][0];
                    currentDailyStreak = 1;
                    for (let i = dailyEntries.length - 2; i >= 0; i -= 1) {
                        const dayNum = dailyEntries[i][0];
                        const nextDay = dailyEntries[i + 1][0];
                        if (nextDay - dayNum === 1) {
                            currentDailyStreak += 1;
                        } else {
                            break;
                        }
                    }
                    currentDailyStreakStart = currentDailyStreakEnd - (currentDailyStreak - 1);
                }

                const weekStarts = Array.from(new Set(dailyEntries.map(([dayNum]) => getWeekStart(dayNum)))).sort((a, b) => a - b);
                let weeklyStreakMax = 0;
                let bestWeekStart = null;
                let bestWeekEnd = null;
                let currentWeekStreak = 0;
                let currentWeekStart = null;
                let prevWeek = null;
                weekStarts.forEach((weekStart) => {
                    if (prevWeek === null || weekStart !== prevWeek + 7) {
                        currentWeekStreak = 1;
                        currentWeekStart = weekStart;
                    } else {
                        currentWeekStreak += 1;
                    }
                    if (currentWeekStreak > weeklyStreakMax) {
                        weeklyStreakMax = currentWeekStreak;
                        bestWeekStart = currentWeekStart;
                        bestWeekEnd = weekStart;
                    }
                    prevWeek = weekStart;
                });

                let currentWeeklyStreak = 0;
                let currentWeeklyStreakStart = null;
                let currentWeeklyStreakEnd = null;
                if (weekStarts.length) {
                    currentWeeklyStreakEnd = weekStarts[weekStarts.length - 1];
                    currentWeeklyStreak = 1;
                    for (let i = weekStarts.length - 2; i >= 0; i -= 1) {
                        const weekStart = weekStarts[i];
                        const nextWeek = weekStarts[i + 1];
                        if (nextWeek - weekStart === 7) {
                            currentWeeklyStreak += 1;
                        } else {
                            break;
                        }
                    }
                    currentWeeklyStreakStart = currentWeeklyStreakEnd - (currentWeeklyStreak - 1) * 7;
                }

                let rollingWeekCurrent = 0;
                let rollingWeekCurrentEnd = null;
                if (dailyEntries.length) {
                    rollingWeekCurrentEnd = dailyEntries[dailyEntries.length - 1][0];
                    dailyEntries.forEach(([dayNum, count]) => {
                        if (dayNum >= rollingWeekCurrentEnd - 6 && dayNum <= rollingWeekCurrentEnd) {
                            rollingWeekCurrent += count;
                        }
                    });
                }

                const bestDayMovies = maxDayNum !== null
                    ? Array.from(new Set((watchLogsByDay.get(maxDayNum) || []).map((movieId) => String(moviesById.get(movieId)?.title || 'Unknown Movie'))))
                    : [];

                const rollingWeekMovies = rollingWeekEnd !== null
                    ? Array.from(new Set(Array.from(watchLogsByDay.entries())
                        .filter(([dayNum]) => dayNum >= rollingWeekEnd - 6 && dayNum <= rollingWeekEnd)
                        .flatMap(([, movieIds]) => movieIds)
                        .map((movieId) => String(moviesById.get(movieId)?.title || 'Unknown Movie'))))
                    : [];

                const bestDailyStreakMovies = (bestStreakStart !== null && bestStreakEnd !== null)
                    ? Array.from(new Set(Array.from(watchLogsByDay.entries())
                        .filter(([dayNum]) => dayNum >= bestStreakStart && dayNum <= bestStreakEnd)
                        .flatMap(([, movieIds]) => movieIds)
                        .map((movieId) => String(moviesById.get(movieId)?.title || 'Unknown Movie'))))
                    : [];

                achievementEvidenceCache = {
                    ratingsCount,
                    genreList,
                    decadeList,
                    directorCounts,
                    topDirector,
                    rewatchMax: topRewatch ? topRewatch.count : 0,
                    topRewatchTitle: topRewatchTitles[0] || null,
                    topRewatchTitles,
                    maxDayCount,
                    maxDayDate: maxDayNum !== null ? dayNumberToDate(maxDayNum) : null,
                    bestDayMovies,
                    rollingWeekMax,
                    rollingWeekEnd: rollingWeekEnd !== null ? dayNumberToDate(rollingWeekEnd) : null,
                    rollingWeekMovies,
                    rollingWeekCurrent,
                    rollingWeekCurrentEnd: rollingWeekCurrentEnd !== null ? dayNumberToDate(rollingWeekCurrentEnd) : null,
                    dailyStreakMax,
                    bestDailyStreakStart: bestStreakStart !== null ? dayNumberToDate(bestStreakStart) : null,
                    bestDailyStreakEnd: bestStreakEnd !== null ? dayNumberToDate(bestStreakEnd) : null,
                    bestDailyStreakMovies,
                    currentDailyStreak,
                    currentDailyStreakStart: currentDailyStreakStart !== null ? dayNumberToDate(currentDailyStreakStart) : null,
                    currentDailyStreakEnd: currentDailyStreakEnd !== null ? dayNumberToDate(currentDailyStreakEnd) : null,
                    weeklyStreakMax,
                    bestWeeklyStreakStart: bestWeekStart !== null ? dayNumberToDate(bestWeekStart) : null,
                    bestWeeklyStreakEnd: bestWeekEnd !== null ? dayNumberToDate(bestWeekEnd + 6) : null,
                    currentWeeklyStreak,
                    currentWeeklyStreakStart: currentWeeklyStreakStart !== null ? dayNumberToDate(currentWeeklyStreakStart) : null,
                    currentWeeklyStreakEnd: currentWeeklyStreakEnd !== null ? dayNumberToDate(currentWeeklyStreakEnd + 6) : null,
                    allGenres: allGenreNames,
                    missingGenres: allGenreNames.filter((genre) => !genreSet.has(genre)),
                };

                achievementEvidenceLoading = null;
                return achievementEvidenceCache;
            })();

            return achievementEvidenceLoading;
        }

        function getEmptyAchievementEvidence() {
            return {
                ratingsCount: 0,
                genreList: [],
                decadeList: [],
                directorCounts: [],
                topDirector: null,
                rewatchMax: 0,
                topRewatchTitle: null,
                topRewatchTitles: [],
                maxDayCount: 0,
                maxDayDate: null,
                bestDayMovies: [],
                rollingWeekMax: 0,
                rollingWeekEnd: null,
                rollingWeekMovies: [],
                rollingWeekCurrent: 0,
                rollingWeekCurrentEnd: null,
                dailyStreakMax: 0,
                bestDailyStreakStart: null,
                bestDailyStreakEnd: null,
                bestDailyStreakMovies: [],
                currentDailyStreak: 0,
                currentDailyStreakStart: null,
                currentDailyStreakEnd: null,
                weeklyStreakMax: 0,
                bestWeeklyStreakStart: null,
                bestWeeklyStreakEnd: null,
                currentWeeklyStreak: 0,
                currentWeeklyStreakStart: null,
                currentWeeklyStreakEnd: null,
                allGenres: [],
                missingGenres: [],
            };
        }

        function toDayNumber(dateInput) {
            const dateStr = String(dateInput || '').trim();
            if (!dateStr) return null;
            const parts = dateStr.split('-');
            if (parts.length < 3) return null;
            const year = Number(parts[0]);
            const month = Number(parts[1]);
            const day = Number(parts[2]);
            if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return null;
            return Math.floor(Date.UTC(year, month - 1, day) / 86400000);
        }

        function dayNumberToDate(dayNum) {
            const date = new Date(dayNum * 86400000);
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getWeekStart(dayNum) {
            const date = new Date(dayNum * 86400000);
            const dow = date.getUTCDay();
            const offset = (dow + 6) % 7;
            return dayNum - offset;
        }

        function formatNameList(items, limit) {
            const list = Array.isArray(items) ? items.map((item) => String(item || '').trim()).filter(Boolean) : [];
            if (!list.length) return 'None yet';
            if (!limit || list.length <= limit) return list.join(', ');
            return `${list.slice(0, limit).join(', ')} (+${list.length - limit} more)`;
        }

        function buildAchievementEvidenceHtml(achievement, data, earned) {
            const name = String(achievement?.name || '').trim();
            const desc = String(achievement?.description || '').trim();

            const rules = {
                'First Screening': { type: 'ratings', threshold: 10 },
                'Film Buff': { type: 'ratings', threshold: 50 },
                'Dedicated Critic': { type: 'ratings', threshold: 250 },
                'Cinema Archivist': { type: 'ratings', threshold: 750 },
                'Screen Authority': { type: 'ratings', threshold: 1000 },
                'Screen Legend': { type: 'ratings', threshold: 1250 },
                'Master of Cinema': { type: 'ratings', threshold: 1500 },

                'Encore': { type: 'rewatch', threshold: 2 },
                'Comfort Classic': { type: 'rewatch', threshold: 3 },
                'Repeat Viewer': { type: 'rewatch', threshold: 5 },
                'Cult Favorite': { type: 'rewatch', threshold: 7 },
                'Devoted Fan': { type: 'rewatch', threshold: 10 },
                'Legendary Obsession': { type: 'rewatch', threshold: 15 },
                'Timeless Classic': { type: 'rewatch', threshold: 25 },

                'Director Devotee': { type: 'director', threshold: 4 },
                'Director Loyalist': { type: 'director', threshold: 6 },
                'Director Disciple': { type: 'director', threshold: 8 },
                'Director Specialist': { type: 'director', threshold: 10 },
                'Director Scholar': { type: 'director', threshold: 12 },
                'Director Archivist': { type: 'director', threshold: 15 },
                'Director Master': { type: 'director', threshold: 20 },

                'Genre Explorer': { type: 'genre', threshold: 4 },
                'Genre Hopper': { type: 'genre', threshold: 6 },
                'Genre Connoisseur': { type: 'genre', threshold: 8 },
                'Genre Specialist': { type: 'genre', threshold: 10 },
                'Genre Authority': { type: 'genre', threshold: 12 },
                'Genre Virtuoso': { type: 'genre', threshold: 14 },
                'Genre Completionist': { type: 'genre', threshold: 16 },

                'Time Traveler': { type: 'decade', threshold: 3 },
                'Decade Explorer': { type: 'decade', threshold: 5 },
                'Era Enthusiast': { type: 'decade', threshold: 7 },
                'Decade Specialist': { type: 'decade', threshold: 9 },
                'Century Wanderer': { type: 'decade', threshold: 11 },
                'Historical Archivist': { type: 'decade', threshold: 13 },
                'Timeline Master': { type: 'decade', threshold: 14 },

                'Double Feature': { type: 'day', threshold: 2 },
                'Opening Weekend': { type: 'day', threshold: 5 },
                'Marathon Critic': { type: 'week', threshold: 10 },
                'Festival Run': { type: 'day_streak', threshold: 7 },
                'Premiere Season': { type: 'day_streak', threshold: 30 },
                'Endurance Champion': { type: 'day_streak', threshold: 365 },
                'Year-Long Viewer': { type: 'week_streak', threshold: 52 },
            };

            const rule = rules[name] || null;
            const detailItems = [];
            let progressValue = null;

            if (rule?.type === 'ratings') {
                progressValue = data.ratingsCount;
                detailItems.push({ label: 'Total rated', value: `${data.ratingsCount} movies` });
            } else if (rule?.type === 'rewatch') {
                progressValue = data.rewatchMax;
                detailItems.push({ label: 'Most rewatches', value: `${data.rewatchMax} times` });
                detailItems.push({ label: 'Top rewatched', value: formatNameList(data.topRewatchTitles, 5) });
            } else if (rule?.type === 'director') {
                progressValue = data.topDirector ? data.topDirector.count : 0;
                detailItems.push({
                    label: 'Top director',
                    value: data.topDirector ? `${data.topDirector.name} (${data.topDirector.count})` : 'None yet',
                });
                const topDirectors = data.directorCounts.slice(0, 3).map((row) => `${row.name} (${row.count})`);
                detailItems.push({ label: 'Top 3 directors', value: formatNameList(topDirectors, 3) });
            } else if (rule?.type === 'genre') {
                progressValue = data.genreList.length;
                detailItems.push({ label: 'Genres seen', value: formatNameList(data.genreList, 10) });
                detailItems.push({ label: 'Genres missing', value: formatNameList(data.missingGenres, 10) });
                detailItems.push({ label: 'Totals', value: `${data.genreList.length} seen / ${data.allGenres.length} total` });
            } else if (rule?.type === 'decade') {
                progressValue = data.decadeList.length;
                const decades = data.decadeList.map((d) => `${d}s`);
                detailItems.push({ label: 'Decades seen', value: formatNameList(decades, 10) });
                detailItems.push({ label: 'Total decades', value: `${data.decadeList.length}` });
            } else if (rule?.type === 'day') {
                progressValue = data.maxDayCount;
                detailItems.push({
                    label: 'Best day',
                    value: data.maxDayDate ? `${data.maxDayDate} (${data.maxDayCount} movies)` : 'None yet',
                });
                detailItems.push({ label: 'Movies that day', value: formatNameList(data.bestDayMovies, 6) });
            } else if (rule?.type === 'week') {
                progressValue = data.rollingWeekMax;
                detailItems.push({
                    label: 'Best 7-day stretch',
                    value: data.rollingWeekEnd ? `${data.rollingWeekMax} movies (ending ${data.rollingWeekEnd})` : 'None yet',
                });
                detailItems.push({
                    label: 'Current 7-day stretch',
                    value: data.rollingWeekCurrentEnd ? `${data.rollingWeekCurrent} movies (ending ${data.rollingWeekCurrentEnd})` : 'None yet',
                });
                detailItems.push({ label: 'Movies in best stretch', value: formatNameList(data.rollingWeekMovies, 6) });
            } else if (rule?.type === 'day_streak') {
                progressValue = data.dailyStreakMax;
                detailItems.push({
                    label: 'Best streak',
                    value: data.bestDailyStreakStart && data.bestDailyStreakEnd
                        ? `${data.dailyStreakMax} days (${data.bestDailyStreakStart} to ${data.bestDailyStreakEnd})`
                        : 'None yet',
                });
                detailItems.push({
                    label: 'Current streak',
                    value: data.currentDailyStreakEnd
                        ? `${data.currentDailyStreak} days (ending ${data.currentDailyStreakEnd})`
                        : 'None yet',
                });
                detailItems.push({ label: 'Movies in best streak', value: formatNameList(data.bestDailyStreakMovies, 8) });
            } else if (rule?.type === 'week_streak') {
                progressValue = data.weeklyStreakMax;
                detailItems.push({
                    label: 'Best weekly streak',
                    value: data.bestWeeklyStreakStart && data.bestWeeklyStreakEnd
                        ? `${data.weeklyStreakMax} weeks (${data.bestWeeklyStreakStart} to ${data.bestWeeklyStreakEnd})`
                        : 'None yet',
                });
                detailItems.push({
                    label: 'Current weekly streak',
                    value: data.currentWeeklyStreakEnd
                        ? `${data.currentWeeklyStreak} weeks (ending ${data.currentWeeklyStreakEnd})`
                        : 'None yet',
                });
            } else {
                detailItems.push({ label: 'Details', value: 'This achievement needs a custom rule.' });
            }

            const statusText = earned ? 'Earned' : 'Locked';
            const progressText = rule && progressValue !== null
                ? `${Math.min(rule.threshold, progressValue)}/${rule.threshold}`
                : '';

            const detailHtml = detailItems.map((item) => `
                <div class="achievement-detail-item">
                    <div class="achievement-detail-label">${escapeHtml(item.label)}</div>
                    <div class="achievement-detail-value">${escapeHtml(item.value)}</div>
                </div>
            `).join('');

            return `
                <div class="text-xs" style="text-transform: uppercase; letter-spacing: 0.08em; font-weight: 800; color: rgba(255,255,255,0.65);">${escapeHtml(statusText)}</div>
                ${desc ? `<div style="margin-top: 0.35rem;">${escapeHtml(desc)}</div>` : ''}
                <div class="achievement-detail-list">
                    ${rule ? `
                        <div class="achievement-detail-item">
                            <div class="achievement-detail-label">Progress</div>
                            <div class="achievement-detail-value">${escapeHtml(String(progressValue ?? 0))} (${escapeHtml(progressText)})</div>
                        </div>
                    ` : ''}
                    ${detailHtml}
                </div>
            `;
        }

        async function refreshAchievementsUI() {
            if (!cachedIsAuthed) {
                renderAccountTierSummary();
                renderAccountAchievements();
                return;
            }
            const uid = String(cachedAuthUser?.id || '').trim();
            if (!uid) return;
            await Promise.all([
                loadAchievementsDefinitions(),
                loadUserAchievements(uid),
                loadUserTierSummary(uid),
            ]);
            if (testAchievementEnabled) syncTestAchievementOptions();
            renderAccountTierSummary();
            renderAccountAchievements();
        }

        function enqueueAchievementPopup(achievement) {
            if (!achievement) return;
            achievementPopupQueue.push(achievement);
            if (!achievementPopupOpen) showNextAchievementPopup();
        }

        let achievementCloseAnimating = false;

        const ACHIEVEMENT_SWIPE_PATHS = {
            start: 'M0,340 C210,120 380,120 580,220 C780,320 860,520 1000,470 L1000,600 L0,600 Z',
            mid: 'M0,260 C240,60 420,140 640,260 C820,380 860,540 1000,520 L1000,600 L0,600 Z',
            end: 'M0,180 C260,40 480,160 700,300 C860,440 880,600 1000,600 L1000,600 L0,600 Z',
        };
        const ACHIEVEMENT_MOTION_PATH = 'M-40,520 C180,120 420,60 720,200 C980,340 900,520 1040,620';
        const ACHIEVEMENT_ANIM_SLOWDOWN = 3;
        const ACHIEVEMENT_ANIM_TIME_SCALE = 1 / ACHIEVEMENT_ANIM_SLOWDOWN;

        function registerAchievementPlugins() {
            if (!window.gsap) return;
            const plugins = [];
            if (window.MorphSVGPlugin) plugins.push(window.MorphSVGPlugin);
            if (window.MotionPathPlugin) plugins.push(window.MotionPathPlugin);
            if (window.DrawSVGPlugin) plugins.push(window.DrawSVGPlugin);
            if (plugins.length) gsap.registerPlugin(...plugins);
        }

        function buildAchievementPieces(overlay) {
            const container = document.getElementById('achievement-pieces');
            if (!container) return [];

            container.innerHTML = '';
            const pieces = [];
            const pieceCount = 22;
            const tierRgb = getComputedStyle(overlay).getPropertyValue('--tier-rgb').trim() || '148, 163, 184';
            const colors = [
                `rgba(${tierRgb}, 0.95)`,
                'rgba(255, 255, 255, 0.9)',
                `rgba(${tierRgb}, 0.65)`,
            ];

            for (let i = 0; i < pieceCount; i += 1) {
                const piece = document.createElement('div');
                piece.className = 'achievement-piece';
                const size = 8 + Math.random() * 18;
                const radius = Math.random() > 0.6 ? size * 0.5 : size * 0.2;
                piece.style.width = `${size}px`;
                piece.style.height = `${size}px`;
                piece.style.borderRadius = `${radius}px`;
                piece.style.background = colors[i % colors.length];
                piece.style.left = `${Math.random() * 100}%`;
                piece.style.top = `${Math.random() * 100}%`;
                container.appendChild(piece);
                pieces.push(piece);
            }

            return pieces;
        }

        function playAchievementCelebrationBurst({ overlay, splashEl, swipeEl, swipePathEl, swipeStrokeEl, motionPathEl, modal, iconEl }) {
            if (!window.gsap) return;

            registerAchievementPlugins();
            const canMorph = !!window.MorphSVGPlugin;
            const canMotion = !!window.MotionPathPlugin;
            const canDraw = !!window.DrawSVGPlugin;

            const pieces = buildAchievementPieces(overlay);
            gsap.killTweensOf([overlay, splashEl, swipeEl, swipePathEl, swipeStrokeEl, motionPathEl, pieces, modal, iconEl]);

            gsap.set(splashEl, { opacity: 0, scale: 0.35, rotate: -20, filter: 'blur(8px) saturate(1.2)', force3D: true });
            gsap.set(swipeEl, { opacity: 0, scaleX: 0.9, scaleY: 0.95, force3D: true });
            gsap.set(swipePathEl, { attr: { d: ACHIEVEMENT_SWIPE_PATHS.start } });
            gsap.set(swipeStrokeEl, { opacity: 0, force3D: true });
            gsap.set(motionPathEl, { attr: { d: ACHIEVEMENT_MOTION_PATH } });
            gsap.set(pieces, { opacity: 0, scale: 0.2, xPercent: -50, yPercent: -50, force3D: true });

            if (canDraw && swipeStrokeEl) {
                gsap.set(swipeStrokeEl, { drawSVG: '0% 0%' });
            }

            const timeline = gsap.timeline()
                .to(splashEl, { opacity: 0.9, scale: 1.2, rotate: 14, duration: 0.5, ease: 'expo.out' }, 0)
                .to(splashEl, { opacity: 0.35, scale: 1.45, rotate: 28, duration: 0.6, ease: 'sine.out' }, 0.45)
                .to(splashEl, { opacity: 0, scale: 1.7, rotate: 40, duration: 0.5, ease: 'expo.out' }, 1)
                .to(swipeEl, { opacity: 1, scaleX: 1.05, scaleY: 1.05, duration: 0.3, ease: 'sine.out' }, 0)
                .to(swipePathEl, canMorph ? { morphSVG: ACHIEVEMENT_SWIPE_PATHS.mid, duration: 0.45, ease: 'expo.out' } : { attr: { d: ACHIEVEMENT_SWIPE_PATHS.mid }, duration: 0.45, ease: 'expo.out' }, 0)
                .to(swipePathEl, canMorph ? { morphSVG: ACHIEVEMENT_SWIPE_PATHS.end, duration: 0.45, ease: 'expo.inOut' } : { attr: { d: ACHIEVEMENT_SWIPE_PATHS.end }, duration: 0.45, ease: 'expo.inOut' }, 0.45)
                .to(swipeEl, { opacity: 0, duration: 0.35, ease: 'sine.out' }, 0.8)
                .to(pieces, {
                    opacity: 1,
                    scale: 1,
                    x: () => gsap.utils.random(-380, 380),
                    y: () => gsap.utils.random(-260, 260),
                    rotation: () => gsap.utils.random(-200, 200),
                    duration: 0.75,
                    ease: 'back.out(2.2)',
                    stagger: { each: 0.012, from: 'random' },
                }, 0.1)
                .to(pieces, {
                    y: '+=220',
                    x: () => gsap.utils.random(-140, 140),
                    rotation: () => gsap.utils.random(-160, 160),
                    duration: 0.95,
                    ease: 'power2.in',
                    stagger: { each: 0.02, from: 'random' },
                }, 0.85)
                .to(pieces, { opacity: 0, duration: 0.35, ease: 'power1.out', stagger: 0.01 }, 1.35)
                .to(modal, { scale: 1.03, duration: 0.18, ease: 'power1.out' }, 0.25)
                .to(modal, { scale: 1, duration: 0.2, ease: 'power1.inOut' }, 0.43)
                .to(iconEl, { rotate: 8, duration: 0.12, ease: 'power1.out' }, 0.3)
                .to(iconEl, { rotate: 0, duration: 0.18, ease: 'power1.inOut' }, 0.42);

            timeline.timeScale(ACHIEVEMENT_ANIM_TIME_SCALE);

            if (canDraw && swipeStrokeEl) {
                timeline
                    .to(swipeStrokeEl, { opacity: 1, drawSVG: '0% 100%', duration: 0.55, ease: 'power2.out' }, 0.05)
                    .to(swipeStrokeEl, { opacity: 0, duration: 0.3, ease: 'power1.out' }, 0.7);
            }

            if (canMotion && motionPathEl && pieces.length) {
                const motionPieces = pieces.slice(0, 8);
                timeline.to(motionPieces, {
                    opacity: 1,
                    motionPath: {
                        path: motionPathEl,
                        align: motionPathEl,
                        autoRotate: true,
                        alignOrigin: [0.5, 0.5],
                    },
                    duration: 1.1,
                    ease: 'power2.out',
                    stagger: 0.03,
                }, 0.2);
            }
        }

        function replayAchievementCelebration() {
            const overlay = document.getElementById('achievement-earned-overlay');
            if (!overlay || overlay.style.display === 'none') return;

            const splashEl = document.getElementById('achievement-splash');
            const swipeEl = document.getElementById('achievement-swipe');
            const swipePathEl = document.getElementById('achievement-swipe-path');
            const swipeStrokeEl = document.getElementById('achievement-swipe-stroke');
            const motionPathEl = document.getElementById('achievement-motion-path');
            const modalEl = document.getElementById('achievement-earned-modal');
            const iconEl = document.getElementById('achievement-earned-icon');
            if (!splashEl || !swipeEl || !swipePathEl || !swipeStrokeEl || !motionPathEl || !modalEl || !iconEl) return;

            playAchievementCelebrationBurst({
                overlay,
                splashEl,
                swipeEl,
                swipePathEl,
                swipeStrokeEl,
                motionPathEl,
                modal: modalEl,
                iconEl,
            });
        }

        function playAchievementPopupOpen({ overlay, modal, iconEl, titleEl, nameEl, descEl, bodyEl, splashEl, swipeEl, swipePathEl, swipeStrokeEl, motionPathEl }) {
            overlay.style.display = 'flex';
            overlay.classList.add('open');

            if (!window.gsap) return;

            registerAchievementPlugins();
            const canMorph = !!window.MorphSVGPlugin;
            const canDraw = !!window.DrawSVGPlugin;

            const pieces = buildAchievementPieces(overlay);
            gsap.killTweensOf([overlay, modal, iconEl, titleEl, nameEl, descEl, bodyEl, splashEl, swipeEl, swipePathEl, swipeStrokeEl, motionPathEl, pieces]);
            gsap.set(overlay, { opacity: 0 });
            gsap.set(splashEl, { opacity: 0, scale: 0.25, rotate: -25, filter: 'blur(8px) saturate(1.2)', force3D: true });
            gsap.set(swipeEl, { opacity: 0, scaleX: 0.9, scaleY: 0.95, force3D: true });
            gsap.set(swipePathEl, { attr: { d: ACHIEVEMENT_SWIPE_PATHS.start } });
            gsap.set(swipeStrokeEl, { opacity: 0, force3D: true });
            gsap.set(motionPathEl, { attr: { d: ACHIEVEMENT_MOTION_PATH } });
            gsap.set(modal, { opacity: 0, y: 180, scale: 0.3, rotate: -8, force3D: true });
            gsap.set(iconEl, { opacity: 0, scale: 0.2, rotate: -90, force3D: true });
            gsap.set([titleEl, nameEl, descEl], { opacity: 0, y: 24 });
            gsap.set(bodyEl, { opacity: 0, scale: 0.9, force3D: true });
            gsap.set(pieces, { opacity: 0, scale: 0.2, xPercent: -50, yPercent: -50, force3D: true });

            if (canDraw && swipeStrokeEl) {
                gsap.set(swipeStrokeEl, { drawSVG: '0% 0%' });
            }

            const timeline = gsap.timeline()
                .to(overlay, { opacity: 1, duration: 0.2, ease: 'power2.out' }, 0)
                .to(splashEl, { opacity: 0.9, scale: 1.25, rotate: 18, duration: 0.65, ease: 'expo.out' }, 0)
                .to(splashEl, { opacity: 0.35, scale: 1.45, rotate: 36, duration: 0.6, ease: 'sine.out' }, 0.65)
                .to(splashEl, { opacity: 0.28, scale: 1.6, rotate: 52, duration: 0.85, ease: 'expo.out' }, 1.15)
                .to(swipeEl, { opacity: 1, scaleX: 1.05, scaleY: 1.05, duration: 0.3, ease: 'sine.out' }, 0)
                .to(swipePathEl, canMorph ? { morphSVG: ACHIEVEMENT_SWIPE_PATHS.mid, duration: 0.45, ease: 'expo.out' } : { attr: { d: ACHIEVEMENT_SWIPE_PATHS.mid }, duration: 0.45, ease: 'expo.out' }, 0)
                .to(swipePathEl, canMorph ? { morphSVG: ACHIEVEMENT_SWIPE_PATHS.end, duration: 0.45, ease: 'expo.inOut' } : { attr: { d: ACHIEVEMENT_SWIPE_PATHS.end }, duration: 0.45, ease: 'expo.inOut' }, 0.45)
                .to(swipeEl, { opacity: 0, duration: 0.6, ease: 'sine.out' }, 1.8)
                .to(pieces, {
                    opacity: 1,
                    scale: 1,
                    x: () => gsap.utils.random(-380, 380),
                    y: () => gsap.utils.random(-260, 260),
                    rotation: () => gsap.utils.random(-200, 200),
                    duration: 0.8,
                    ease: 'back.out(2.2)',
                    stagger: { each: 0.012, from: 'random' },
                }, 0.1)
                .to(pieces, {
                    y: '+=220',
                    x: () => gsap.utils.random(-140, 140),
                    rotation: () => gsap.utils.random(-160, 160),
                    duration: 0.95,
                    ease: 'power2.in',
                    stagger: { each: 0.02, from: 'random' },
                }, 0.85)
                .to(pieces, { opacity: 0, duration: 0.6, ease: 'power1.out', stagger: 0.01 }, 2.35)
                .to(modal, { opacity: 1, y: 0, scale: 1.08, rotate: 0, duration: 0.8, ease: 'back.out(1.7)' }, 0.5)
                .to(modal, { scale: 1, duration: 0.25, ease: 'power2.out' }, 1.15)
                .to(iconEl, { opacity: 1, scale: 1.2, rotate: 0, duration: 0.6, ease: 'back.out(2.2)' }, 0.55)
                .to(iconEl, { scale: 1, duration: 0.2, ease: 'power2.out' }, 1.12)
                .to(bodyEl, { opacity: 1, scale: 1, duration: 0.22, ease: 'power2.out' }, 0.45)
                .to([titleEl, nameEl, descEl], { opacity: 1, y: 0, duration: 0.24, stagger: 0.05, ease: 'power2.out' }, 0.5)
                .to(splashEl, { opacity: 0, scale: 1.9, duration: 0.8, ease: 'sine.out' }, 2.2);

            timeline.timeScale(ACHIEVEMENT_ANIM_TIME_SCALE);

            if (canDraw && swipeStrokeEl) {
                timeline
                    .to(swipeStrokeEl, { opacity: 1, drawSVG: '0% 100%', duration: 0.55, ease: 'power2.out' }, 0.05)
                    .to(swipeStrokeEl, { opacity: 0, duration: 0.3, ease: 'power1.out' }, 0.7);
            }
        }

        function playAchievementPopupClose({ overlay, modal, iconEl, titleEl, nameEl, descEl, bodyEl, splashEl, swipeEl, swipePathEl, swipeStrokeEl, motionPathEl }) {
            if (!window.gsap) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
                return;
            }

            const pieces = Array.from(document.querySelectorAll('#achievement-pieces .achievement-piece'));
            gsap.killTweensOf([overlay, modal, iconEl, titleEl, nameEl, descEl, bodyEl, splashEl, swipeEl, swipePathEl, swipeStrokeEl, motionPathEl, pieces]);
            const timeline = gsap.timeline()
                .set(splashEl, { opacity: 0, scale: 0.8, rotate: -12 }, 0)
                .set(swipeEl, { opacity: 0, scaleX: 0.9, scaleY: 0.95 }, 0)
                .set(swipePathEl, { attr: { d: ACHIEVEMENT_SWIPE_PATHS.start } }, 0)
                .set(swipeStrokeEl, { opacity: 0 }, 0)
                .set(motionPathEl, { attr: { d: ACHIEVEMENT_MOTION_PATH } }, 0)
                .to([titleEl, nameEl, descEl, bodyEl], { opacity: 0, y: -10, duration: 0.18, ease: 'power1.in' }, 0)
                .to(iconEl, { opacity: 0, scale: 0.6, rotate: -18, duration: 0.2, ease: 'power1.in' }, 0)
                .to(modal, { opacity: 0, y: 60, scale: 0.85, rotate: 6, duration: 0.28, ease: 'power2.in' }, 0.05)
                .to(splashEl, { opacity: 0.35, scale: 1.1, rotate: -28, duration: 0.18, ease: 'power1.out' }, 0.02)
                .to(splashEl, { opacity: 0, scale: 1.4, rotate: -40, duration: 0.26, ease: 'power2.in' }, 0.2)
                .to(pieces, { opacity: 0, duration: 0.2, ease: 'power1.out' }, 0)
                .to(overlay, { opacity: 0, duration: 0.25, ease: 'power1.in' }, 0.12);
            timeline.timeScale(ACHIEVEMENT_ANIM_TIME_SCALE);
        }

        function showNextAchievementPopup() {
            if (achievementPopupOpen) return;
            const next = achievementPopupQueue.shift();
            if (!next) return;
            achievementPopupOpen = true;

            const overlay = document.getElementById('achievement-earned-overlay');
            const nameEl = document.getElementById('achievement-earned-name');
            const descEl = document.getElementById('achievement-earned-desc');
            const iconEl = document.getElementById('achievement-earned-icon');
            const bodyEl = document.getElementById('achievement-earned-body');
            const modalEl = document.getElementById('achievement-earned-modal');
            const splashEl = document.getElementById('achievement-splash');
            const swipeEl = document.getElementById('achievement-swipe');
            const swipePathEl = document.getElementById('achievement-swipe-path');
            const swipeStrokeEl = document.getElementById('achievement-swipe-stroke');
            const motionPathEl = document.getElementById('achievement-motion-path');
            if (!overlay || !nameEl || !descEl || !iconEl || !bodyEl || !modalEl || !splashEl || !swipeEl || !swipePathEl || !swipeStrokeEl || !motionPathEl) return;

            const normalizeAchievementTier = (raw) => {
                const key = String(raw || '').trim().toLowerCase();
                const map = {
                    bronze: 'Bronze',
                    silver: 'Silver',
                    gold: 'Gold',
                    platinum: 'Platinum',
                    diamond: 'Diamond',
                    emerald: 'Emerald',
                    ruby: 'Ruby',
                };
                return map[key] || '';
            };

            const name = String(next?.name || '').trim() || 'Achievement';
            const desc = String(next?.description || '').trim() || 'Achievement earned.';
            const iconUrl = String(next?.icon_url || '').trim();
            const tier = normalizeAchievementTier(next?.tier);
            nameEl.textContent = name;
            descEl.textContent = desc;
            iconEl.innerHTML = iconUrl
                ? `<img src="${iconUrl}" alt="${escapeHtml(name)}">`
                : '<span class="text-xs text-gray">?</span>';
            bodyEl.setAttribute('data-tier', tier || '');
            modalEl.setAttribute('data-tier', tier || '');
            overlay.setAttribute('data-tier', tier || '');

            playAchievementPopupOpen({
                overlay,
                modal: modalEl,
                iconEl,
                titleEl: document.getElementById('achievement-earned-title'),
                nameEl,
                descEl,
                bodyEl,
                splashEl,
                swipeEl,
                swipePathEl,
                swipeStrokeEl,
                motionPathEl,
            });
        }

        function closeAchievementPopup() {
            const overlay = document.getElementById('achievement-earned-overlay');
            if (!overlay || achievementCloseAnimating) return;

            const modalEl = document.getElementById('achievement-earned-modal');
            const iconEl = document.getElementById('achievement-earned-icon');
            const titleEl = document.getElementById('achievement-earned-title');
            const nameEl = document.getElementById('achievement-earned-name');
            const descEl = document.getElementById('achievement-earned-desc');
            const bodyEl = document.getElementById('achievement-earned-body');
            const splashEl = document.getElementById('achievement-splash');
            const swipeEl = document.getElementById('achievement-swipe');
            const swipePathEl = document.getElementById('achievement-swipe-path');
            const swipeStrokeEl = document.getElementById('achievement-swipe-stroke');
            const motionPathEl = document.getElementById('achievement-motion-path');

            achievementCloseAnimating = true;
            playAchievementPopupClose({
                overlay,
                modal: modalEl,
                iconEl,
                titleEl,
                nameEl,
                descEl,
                bodyEl,
                splashEl,
                swipeEl,
                swipePathEl,
                swipeStrokeEl,
                motionPathEl,
            });

            const finalize = () => {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
                achievementPopupOpen = false;
                achievementCloseAnimating = false;
                if (achievementPopupQueue.length) {
                    setTimeout(showNextAchievementPopup, 150);
                }
            };

            if (!window.gsap) {
                finalize();
                return;
            }

            gsap.delayedCall(0.25 * ACHIEVEMENT_ANIM_SLOWDOWN, finalize);
        }

        async function checkAndAwardRatingMilestones() {
            if (!supabaseClient || !cachedIsAuthed) return;
            const uid = String(cachedAuthUser?.id || '').trim();
            if (!uid) return;

            await loadAchievementsDefinitions();
            await loadUserAchievements(uid);

            const { count, error } = await supabaseClient
                .from('Movie Ratings')
                .select('movie_id', { count: 'exact', head: true })
                .eq('user_id', uid);

            if (error || !Number.isFinite(count)) return;

            const newlyEarned = [];
            for (const milestone of RATING_MILESTONES) {
                if (count < milestone) continue;
                const name = buildRatingAchievementName(milestone);
                const def = achievementsByName.get(name);
                const achievementId = String(def?.id || '').trim();
                if (!achievementId || userAchievementIds.has(achievementId)) continue;
                newlyEarned.push({ def, achievementId });
            }

            if (!newlyEarned.length) return;

            const rows = newlyEarned.map((item) => ({
                user_id: uid,
                achievement_id: item.achievementId,
            }));

            const { error: insertError } = await supabaseClient
                .from('User Achievements')
                .insert(rows);

            if (insertError) return;

            newlyEarned.forEach((item) => {
                if (item.achievementId) userAchievementIds.add(item.achievementId);
                if (item.def) enqueueAchievementPopup(item.def);
            });

            renderAccountAchievements();
        }

        function openRatingsSuccessModal(kind) {
            const overlay = document.getElementById('ratings-success-overlay');
            const titleEl = document.getElementById('ratings-success-title');
            if (!overlay) return;

            const k = String(kind || '').toLowerCase();
            if (titleEl) {
                titleEl.textContent = (k === 'updated') ? 'Movie Ratings Updated' : 'Movie Ratings Saved';
            }

            overlay.style.display = 'flex';
            overlay.classList.add('open');

            if (ratingsSuccessTimer) {
                clearTimeout(ratingsSuccessTimer);
                ratingsSuccessTimer = null;
            }

            ratingsSuccessTimer = setTimeout(() => {
                closeRatingsSuccessModal();
            }, 3000);
        }

        function closeRatingsSuccessModal() {
            const overlay = document.getElementById('ratings-success-overlay');

            if (ratingsSuccessTimer) {
                clearTimeout(ratingsSuccessTimer);
                ratingsSuccessTimer = null;
            }

            if (!overlay) return;
            overlay.classList.remove('open');
            overlay.style.display = 'none';
        }

        function openUpdateWatchModal() {
            const overlay = document.getElementById('update-watch-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        let deleteConfirmState = {
            action: null,
            token: null,
            ts: 0,
        };

        let deleteRatingState = {
            user_id: null,
            movie_id: null,
            title: '',
            logs: [],
            source: 'submit',
        };

        function armDeleteConfirmation({ action, token, message, statusElId }) {
            const now = Date.now();
            const statusEl = statusElId ? document.getElementById(statusElId) : null;

            // If the user clicks the same action twice within 8 seconds, treat as confirmed.
            const isSame = (
                deleteConfirmState.action === action &&
                deleteConfirmState.token === token &&
                (now - Number(deleteConfirmState.ts || 0)) < 8000
            );

            if (isSame) {
                deleteConfirmState = { action: null, token: null, ts: 0 };
                if (statusEl) statusEl.textContent = '';
                return true;
            }

            deleteConfirmState = { action, token, ts: now };
            if (statusEl) {
                statusEl.textContent = String(message || 'Click again to confirm.');
                statusEl.style.color = 'rgba(239,68,68,0.95)';
            }
            return false;
        }

        async function openDeleteRatingModalForMovie({ movie_id, title = '', source = 'submit' } = {}) {
            const mid = String(movie_id || '').trim();
            if (!mid) throw new Error('Missing movie_id for delete modal.');

            const { user: authedUser } = await requireAuthOrThrow();

            deleteRatingState = {
                user_id: authedUser.id,
                movie_id: mid,
                title: String(title || '').trim(),
                logs: [],
                source: String(source || 'submit'),
            };

            const overlay = document.getElementById('delete-rating-overlay');
            if (!overlay) return;
            const movieEl = document.getElementById('delete-rating-movie');
            if (movieEl) movieEl.textContent = deleteRatingState.title || 'this movie';

            const statusA = document.getElementById('delete-rating-status');
            const statusB = document.getElementById('delete-logs-status');
            if (statusA) {
                statusA.textContent = '';
                statusA.style.color = 'rgba(255,255,255,0.60)';
            }
            if (statusB) {
                statusB.textContent = '';
                statusB.style.color = 'rgba(255,255,255,0.60)';
            }

            overlay.style.display = 'flex';
            overlay.classList.add('open');

            await loadDeleteRatingWatchLogs();
        }

        function openDeleteRatingModal() {
            (async () => {
                try {
                    let movie_id = String(document.getElementById('fld-movie-id')?.value || '').trim();
                    if (!movie_id) {
                        movie_id = await resolveDbMovieIdFromSelectedMovie(router?.selectedMovie);
                    }
                    if (!movie_id) throw new Error('Missing movie_id for this entry.');

                    const title = String(router?.selectedMovie?.title || '').trim();
                    await openDeleteRatingModalForMovie({ movie_id, title, source: 'submit' });
                } catch (err) {
                    showToast(String(err?.message || err || 'Delete failed.'), { level: 'warn' });
                }
            })();
        }

        function closeDeleteRatingModal() {
            const overlay = document.getElementById('delete-rating-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
            overlay.style.display = 'none';
        }

        async function loadDeleteRatingWatchLogs() {
            const list = document.getElementById('delete-logs-list');
            const countEl = document.getElementById('delete-logs-count');
            const btn = document.getElementById('btn-delete-selected-logs');
            if (list) {
                list.innerHTML = `<div class="text-sm" style="color: rgba(255,255,255,0.65);">Loading watch logs</div>`;
            }

            deleteRatingState.logs = [];

            const { user_id, movie_id } = deleteRatingState;
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id || !movie_id) throw new Error('Missing delete context. Close and re-open Delete.');

            const { data, error } = await supabaseClient
                .from('Watch Logs')
                .select(`id, watch_method, ${COL_WATCH_DATE}`)
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .order(COL_WATCH_DATE, { ascending: false })
                .order('id', { ascending: false });

            if (error) throw error;

            const logs = Array.isArray(data) ? data : [];
            deleteRatingState.logs = logs;

            if (countEl) {
                countEl.textContent = `${logs.length} watch log${logs.length === 1 ? '' : 's'}`;
            }

            if (!list) return;

            if (logs.length === 0) {
                list.innerHTML = `<div class="text-sm" style="color: rgba(255,255,255,0.65);">No watch logs found for this movie.</div>`;
                if (btn) {
                    btn.disabled = true;
                    btn.setAttribute('aria-disabled', 'true');
                    btn.title = 'No watch logs to delete.';
                }
                return;
            }

            const fmt = (raw) => {
                const s = String(raw ?? '').trim();
                return s || '(unknown date)';
            };

            list.innerHTML = logs.map((r) => {
                const id = String(r?.id || '').trim();
                const method = String(r?.watch_method || '');
                const wd = fmt(r?.[COL_WATCH_DATE]);
                const label = method ? `${wd}  ${escapeHtml(method)}` : `${wd}`;
                return `
                    <label style="display:flex; gap: 0.65rem; align-items: flex-start; padding: 0.65rem; border: 1px solid rgba(255,255,255,0.08); border-radius: 0.85rem; background: rgba(255,255,255,0.03);">
                        <input type="checkbox" class="delete-log-checkbox" data-log-id="${escapeHtml(id)}" onchange="handleDeleteLogCheckboxChange()" style="margin-top: 0.25rem;">
                        <div style="display:flex; flex-direction: column; gap: 0.2rem;">
                            <div class="text-white font-semibold" style="font-size: 0.9rem;">${label}</div>
                            <div class="text-xs" style="color: rgba(255,255,255,0.60);">id: ${escapeHtml(id)}</div>
                        </div>
                    </label>
                `;
            }).join('');

            handleDeleteLogCheckboxChange();
        }

        function getDeleteSelectedLogIds() {
            try {
                const checked = Array.from(document.querySelectorAll('#delete-logs-list .delete-log-checkbox:checked'));
                return checked
                    .map((el) => String(el?.getAttribute('data-log-id') || '').trim())
                    .filter(Boolean);
            } catch (_) {
                return [];
            }
        }

        function handleDeleteLogCheckboxChange() {
            const btn = document.getElementById('btn-delete-selected-logs');
            const status = document.getElementById('delete-logs-status');
            const total = Array.isArray(deleteRatingState.logs) ? deleteRatingState.logs.length : 0;
            const selectedIds = getDeleteSelectedLogIds();
            const selectedCount = selectedIds.length;

            if (status) status.textContent = '';

            if (!btn) return;
            if (total === 0 || selectedCount === 0) {
                btn.disabled = true;
                btn.setAttribute('aria-disabled', 'true');
                btn.title = total === 0 ? 'No watch logs to delete.' : 'Select at least one watch log.';
                btn.textContent = 'Delete selected';
                return;
            }

            if (selectedCount >= total) {
                btn.disabled = true;
                btn.setAttribute('aria-disabled', 'true');
                btn.title = 'You must keep at least 1 watch log.';
                btn.textContent = `Delete selected (${selectedCount})`;
                if (status) status.textContent = 'You cannot delete all watch logs. Leave at least 1 unchecked.';
                return;
            }

            btn.disabled = false;
            btn.setAttribute('aria-disabled', 'false');
            btn.title = `Delete ${selectedCount} watch log${selectedCount === 1 ? '' : 's'}.`;
            btn.textContent = `Delete selected (${selectedCount})`;
        }

        function clearDeleteLogsSelection() {
            try {
                document.querySelectorAll('#delete-logs-list .delete-log-checkbox').forEach((el) => {
                    el.checked = false;
                });
            } catch (_) {}
            handleDeleteLogCheckboxChange();
        }

        function toggleSelectAllDeleteLogs() {
            const boxes = Array.from(document.querySelectorAll('#delete-logs-list .delete-log-checkbox'));
            if (boxes.length === 0) return;
            const allChecked = boxes.every(b => b.checked);
            boxes.forEach((b) => { b.checked = !allChecked; });
            handleDeleteLogCheckboxChange();
        }

        async function confirmDeleteSelectedWatchLogs() {
            try {
                const { user_id, movie_id } = deleteRatingState;
                if (!user_id || !movie_id) throw new Error('Missing delete context. Close and re-open Delete.');
                const total = Array.isArray(deleteRatingState.logs) ? deleteRatingState.logs.length : 0;
                const ids = getDeleteSelectedLogIds();
                if (ids.length === 0) {
                    showToast('Select at least one watch log to delete.', { level: 'warn' });
                    return;
                }
                if (total > 0 && ids.length >= total) {
                    showToast('You must keep at least 1 watch log.', { level: 'warn' });
                    return;
                }
                const status = document.getElementById('delete-logs-status');
                if (status) {
                    status.textContent = '';
                    status.style.color = 'rgba(255,255,255,0.60)';
                }

                const token = `${user_id}:${movie_id}:${ids.slice().sort().join(',')}`;
                const confirmed = armDeleteConfirmation({
                    action: 'delete_selected_logs',
                    token,
                    statusElId: 'delete-logs-status',
                    message: `Click Delete selected again to confirm deleting ${ids.length} watch log${ids.length === 1 ? '' : 's'} (you must keep at least 1).`,
                });
                if (!confirmed) return;

                if (status) {
                    status.textContent = 'Deleting selected watch logs';
                    status.style.color = 'rgba(255,255,255,0.60)';
                }

                const { error: delErr } = await supabaseClient
                    .from('Watch Logs')
                    .delete()
                    .in('id', ids)
                    .eq('user_id', user_id)
                    .eq('movie_id', movie_id);

                if (delErr) throw delErr;

                // Keep Movie Ratings watch_date aligned to the latest remaining Watch Logs entry.
                const latest = await getLatestWatchLog({ user_id, movie_id });
                const latestDate = String(latest?.[COL_WATCH_DATE] || '').trim();
                if (latestDate) {
                    const { error: updErr } = await supabaseClient
                        .from('Movie Ratings')
                        .update({
                            [COL_WATCH_DATE]: latestDate,
                            updated_at: new Date().toISOString(),
                        })
                        .eq('user_id', user_id)
                        .eq('movie_id', movie_id);
                    if (updErr) throw updErr;
                }

                const remaining = await getWatchLogCount({ user_id, movie_id });
                const timesEl = document.getElementById('fld-timeswatch');
                if (timesEl && Number.isFinite(Number(remaining)) && Number(remaining) >= 1) {
                    timesEl.value = String(Number(remaining));
                }

                showToast(`Deleted ${ids.length} watch log${ids.length === 1 ? '' : 's'}.`);
                await loadDeleteRatingWatchLogs();

                // If launched from My Movies, refresh the cards behind the modal.
                if (String(deleteRatingState?.source || '') === 'library' && String(router?.currentPage || '') === 'library') {
                    await loadLibraryPage({ reset: true });
                }
            } catch (err) {
                const msg = String(err?.message || err);
                const status = document.getElementById('delete-logs-status');
                if (status) {
                    status.textContent = `Delete failed: ${msg}`;
                    status.style.color = 'rgba(239,68,68,0.95)';
                }
                showToast(`Delete failed: ${msg}`);
            }
        }

        async function confirmDeleteRatingAndAllLogs() {
            try {
                const { user_id, movie_id, title } = deleteRatingState;
                if (!user_id || !movie_id) throw new Error('Missing delete context. Close and re-open Delete.');
                const status = document.getElementById('delete-rating-status');
                if (status) {
                    status.textContent = '';
                    status.style.color = 'rgba(255,255,255,0.60)';
                }

                const token = `${user_id}:${movie_id}`;
                const confirmed = armDeleteConfirmation({
                    action: 'delete_rating_and_all_logs',
                    token,
                    statusElId: 'delete-rating-status',
                    message: `Click again to confirm deleting your rating and all watch logs for ${title || 'this movie'}. This cannot be undone.`,
                });
                if (!confirmed) return;

                if (status) {
                    status.textContent = 'Deleting rating and watch logs';
                    status.style.color = 'rgba(255,255,255,0.60)';
                }

                // Delete logs first (works with or without DB cascades).
                const { error: logsErr } = await supabaseClient
                    .from('Watch Logs')
                    .delete()
                    .eq('user_id', user_id)
                    .eq('movie_id', movie_id);
                if (logsErr) throw logsErr;

                const { error: ratingErr } = await supabaseClient
                    .from('Movie Ratings')
                    .delete()
                    .eq('user_id', user_id)
                    .eq('movie_id', movie_id);
                if (ratingErr) throw ratingErr;

                closeDeleteRatingModal();
                showToast('Deleted rating and watch logs.');
                if (String(deleteRatingState?.source || '') === 'library' && String(router?.currentPage || '') === 'library') {
                    await loadLibraryPage({ reset: true });
                } else {
                    try { router.navigate('library'); } catch (_) { router.navigate('home'); }
                }
            } catch (err) {
                const msg = String(err?.message || err);
                const status = document.getElementById('delete-rating-status');
                if (status) {
                    status.textContent = `Delete failed: ${msg}`;
                    status.style.color = 'rgba(239,68,68,0.95)';
                }
                showToast(`Delete failed: ${msg}`);
            }
        }

        function closeUpdateWatchModal(choice) {
            const overlay = document.getElementById('update-watch-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }

            try {
                if (typeof updateWatchChoiceResolver === 'function') {
                    const resolve = updateWatchChoiceResolver;
                    updateWatchChoiceResolver = null;
                    resolve(choice);
                }
            } catch (_) {
                updateWatchChoiceResolver = null;
            }
        }

        function promptUpdateWatchChoice() {
            // Returns: 'update_only' | 'update_and_watch' | null
            return new Promise((resolve) => {
                updateWatchChoiceResolver = resolve;
                openUpdateWatchModal();
            });
        }

        function openWatchMethodModal() {
            const overlay = document.getElementById('watch-method-overlay');
            if (!overlay) return;
            const dateEl = document.getElementById('watch-method-date');
            if (dateEl) {
                dateEl.value = getLocalISODate();
            }

            // Reset selection every time to prevent accidental saves.
            watchMethodPendingSelection = null;
            try {
                overlay.setAttribute('data-has-selection', 'false');
                const saveBtn = document.getElementById('watch-method-save');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.setAttribute('aria-disabled', 'true');
                }
                overlay.querySelectorAll('[data-watch-method-option="true"]').forEach((btn) => {
                    btn.classList.remove('selected');
                    btn.setAttribute('aria-pressed', 'false');
                });
            } catch (_) {}

            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function selectWatchMethodModal(method) {
            watchMethodPendingSelection = String(method || '').trim() || null;
            const overlay = document.getElementById('watch-method-overlay');
            if (!overlay) return;

            try {
                overlay.setAttribute('data-has-selection', watchMethodPendingSelection ? 'true' : 'false');
                overlay.querySelectorAll('[data-watch-method-option="true"]').forEach((btn) => {
                    const isSelected = String(btn.textContent || '').trim() === watchMethodPendingSelection;
                    btn.classList.toggle('selected', isSelected);
                    btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                });
                const saveBtn = document.getElementById('watch-method-save');
                if (saveBtn) {
                    saveBtn.disabled = !watchMethodPendingSelection;
                    saveBtn.setAttribute('aria-disabled', (!watchMethodPendingSelection).toString());
                }
            } catch (_) {}
        }

        function submitWatchMethodModal() {
            if (!watchMethodPendingSelection) {
                showToast('Select At Home or In Theater, then tap Save.', { level: 'warn' });
                return;
            }

            const dateEl = document.getElementById('watch-method-date');
            const watch_date = String(dateEl?.value || '').trim();
            if (!watch_date) {
                showToast('Please select a watch date.', { level: 'warn' });
                try { dateEl?.focus?.(); } catch (_) {}
                return;
            }

            closeWatchMethodModal({
                watch_method: watchMethodPendingSelection,
                watch_date,
            });
        }

        function closeWatchMethodModal(choice) {
            const overlay = document.getElementById('watch-method-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }

            try {
                if (typeof watchMethodChoiceResolver === 'function') {
                    const resolve = watchMethodChoiceResolver;
                    watchMethodChoiceResolver = null;
                    resolve(choice);
                }
            } catch (_) {
                watchMethodChoiceResolver = null;
            }
        }

        function promptWatchMethodChoice() {
            // Returns: { watch_method: 'At Home' | 'In Theater', watch_date: 'YYYY-MM-DD' } | null
            return new Promise((resolve) => {
                watchMethodChoiceResolver = resolve;
                openWatchMethodModal();
            });
        }

        function openPriorWatchesModal(count) {
            priorWatchesPendingCount = Math.max(0, Math.floor(Number(count || 0)));
            const overlay = document.getElementById('prior-watches-overlay');
            const msg = document.getElementById('prior-watches-message');
            const fields = document.getElementById('prior-watches-fields');
            if (!overlay || !fields) return;

            if (msg) {
                msg.textContent = `It looks like you've seen this movie multiple times; please tell us about the first ${priorWatchesPendingCount} time${priorWatchesPendingCount === 1 ? '' : 's'} you've seen this movie.`;
            }

            const today = getLocalISODate();
            fields.innerHTML = Array.from({ length: priorWatchesPendingCount }).map((_, i) => {
                const n = i + 1;
                return `
                    <div style="border: 1px solid rgba(255,255,255,0.08); border-radius: 0.75rem; padding: 0.85rem; background: rgba(255,255,255,0.03);">
                        <div class="text-sm text-white font-semibold" style="margin-bottom: 0.5rem;">Previous viewing #${n}</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label class="text-xs text-gray" style="display:block; margin-bottom: 0.35rem;">Date</label>
                                <input id="prior-watch-date-${n}" type="date" class="input-field" max="${today}" onclick="openDatePickerFromInput(this)" onfocus="openDatePickerFromInput(this)" required>
                            </div>
                            <div>
                                <label class="text-xs text-gray" style="display:block; margin-bottom: 0.35rem;">Watch Method</label>
                                <select id="prior-watch-method-${n}" class="input-field" required>
                                    <option value="" disabled selected>Select...</option>
                                    <option value="At Home">At Home</option>
                                    <option value="In Theater">In Theater</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function closePriorWatchesModal(result) {
            const overlay = document.getElementById('prior-watches-overlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.style.display = 'none';
            }

            try {
                if (typeof priorWatchesChoiceResolver === 'function') {
                    const resolve = priorWatchesChoiceResolver;
                    priorWatchesChoiceResolver = null;
                    resolve(result);
                }
            } catch (_) {
                priorWatchesChoiceResolver = null;
            }
        }

        function submitPriorWatchesModal() {
            const entries = [];
            for (let i = 1; i <= priorWatchesPendingCount; i++) {
                const dateEl = document.getElementById(`prior-watch-date-${i}`);
                const methodEl = document.getElementById(`prior-watch-method-${i}`);
                const watch_date = String(dateEl?.value || '').trim();
                const watch_method = String(methodEl?.value || '').trim() || null;
                if (!watch_date) {
                    showToast(`Please select a date for previous viewing #${i}.`, { level: 'warn' });
                    try { dateEl?.focus?.(); } catch (_) {}
                    return;
                }
                if (!watch_method) {
                    showToast(`Please select a watch method for previous viewing #${i}.`, { level: 'warn' });
                    try { methodEl?.focus?.(); } catch (_) {}
                    return;
                }
                entries.push({ watch_date, watch_method });
            }

            closePriorWatchesModal({ entries });
        }

        function promptPriorWatches(count) {
            // Returns: { entries: Array<{watch_date, watch_method}> }
            return new Promise((resolve) => {
                priorWatchesChoiceResolver = resolve;
                openPriorWatchesModal(count);
            });
        }

        function getTierHelpText(tier) {
            const t = String(tier || '').trim();
            if (t === 'S-Tier') return 'The Pantheon. Best of the Best.';
            if (t === 'A-Tier') return 'Great! Highly recommended films!';
            if (t === 'B-Tier') return 'Worth a Watch. Solidly good and Entertaining';
            if (t === 'C-Tier') return "Totally Average. Fine if it's on, but don't go out of your way.";
            if (t === 'D-Tier') return 'Skip it. Seriously Flawed and not worth the time.';
            if (t === 'F-Tier') return 'Avoid at all costs! A genuinely bad experience.';
            return 'Choose exactly one tier';
        }

        function setTierFromButton(btn) {
            try {
                const group = btn?.closest?.('.tier-btn-group');
                if (!group) return;
                const tier = String(btn.getAttribute('data-tier') || '').trim();
                const targetInputId = String(group.getAttribute('data-target-input') || '').trim();
                const input = targetInputId ? document.getElementById(targetInputId) : null;
                if (input) input.value = tier;

                group.querySelectorAll('.tier-btn').forEach((b) => {
                    const isSelected = b === btn;
                    b.classList.toggle('selected', isSelected);
                    b.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                });

                group.setAttribute('data-has-selection', tier ? 'true' : 'false');

                const help = document.getElementById('tier-help-text');
                if (help) help.textContent = getTierHelpText(tier);
            } catch (_) {}
        }

        function showLoadingOverlay(message) {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            if (message) {
                try {
                    const msgEl = overlay.querySelector('.text-sm span:last-child');
                    if (msgEl) msgEl.textContent = String(message);
                } catch (_) {}
            }
            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
            overlay.style.display = 'none';
        }

        function toggleWatchMethod(btn) {
            try {
                if (btn?.disabled) return;
            } catch (_) {}
            const isTheater = btn.textContent.trim().toLowerCase().includes('theater');
            const hidden = document.getElementById('fld-watchmethod');
            if (isTheater) {
                btn.textContent = 'At Home';
                if (hidden) hidden.value = 'At Home';
                btn.style.backgroundColor = 'rgba(168, 85, 247, 0.35)';
                btn.style.borderColor = 'rgba(168, 85, 247, 0.5)';
            } else {
                btn.textContent = 'In Theater';
                if (hidden) hidden.value = 'In Theater';
                btn.style.backgroundColor = 'rgba(20, 184, 166, 0.35)';
                btn.style.borderColor = 'rgba(20, 184, 166, 0.5)';
            }
        }

        async function requireAuthOrThrow() {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const { data, error } = await supabaseClient.auth.getSession();
            if (error) throw error;
            let session = data?.session || null;
            let user = session?.user || null;
            let accessToken = session?.access_token || null;
            if (!user?.id || !accessToken) throw new Error('Please log in first.');

            // Validate the token with Supabase Auth. If invalid/expired, try a refresh.
            const { data: userData, error: userErr } = await supabaseClient.auth.getUser();
            if (userErr || !userData?.user?.id) {
                const { data: refreshed, error: refreshErr } = await supabaseClient.auth.refreshSession();
                if (refreshErr) {
                    throw new Error('Session invalid. Click Log out, then Log in again.');
                }
                session = refreshed?.session || null;
                user = session?.user || null;
                accessToken = session?.access_token || null;
                if (!user?.id || !accessToken) {
                    throw new Error('Session invalid. Click Log out, then Log in again.');
                }

                const { data: userData2, error: userErr2 } = await supabaseClient.auth.getUser();
                if (userErr2 || !userData2?.user?.id) {
                    throw new Error('Invalid JWT. Click Log out, then Log in again.');
                }
            }

            return { user, accessToken };
        }

        async function insertWatchLog({ user_id, movie_id, watch_method = null, watch_date }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');
            const wd = String(watch_date || '').trim();
            if (!wd) throw new Error('Missing watch_date.');

            const row = {
                user_id,
                movie_id,
                watch_method,
                [COL_WATCH_DATE]: wd,
            };

            const { error } = await supabaseClient
                .from('Watch Logs')
                .insert(row);

            if (error) throw error;
        }

        async function insertWatchLogIfMissing({ user_id, movie_id, watch_method = null, watch_date }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');
            const wd = String(watch_date || '').trim();
            if (!wd) throw new Error('Missing watch_date.');

            const { data: existing, error: existsErr } = await supabaseClient
                .from('Watch Logs')
                .select('id')
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .limit(1);

            if (existsErr) throw existsErr;
            if (Array.isArray(existing) && existing.length > 0) return;

            await insertWatchLog({ user_id, movie_id, watch_method, watch_date: wd });
        }

        async function insertWatchLogsBulk({ user_id, movie_id, entries }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');
            if (!Array.isArray(entries) || entries.length === 0) return;

            const rows = entries.map((e) => {
                const wd = String(e?.watch_date || '').trim();
                if (!wd) throw new Error('Missing watch_date.');
                return {
                    user_id,
                    movie_id,
                    watch_method: (e?.watch_method ?? null),
                    [COL_WATCH_DATE]: wd,
                };
            });

            const { error } = await supabaseClient
                .from('Watch Logs')
                .insert(rows);

            if (error) throw error;
        }

        function isUuidLike(v) {
            return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(v || '').trim());
        }

        function getTmdbIdFromSelectedMovie(movie) {
            if (!movie) return null;
            // Common shapes:
            // - movie.tmdb_id (number)
            // - movie.id (TMDb numeric id)
            // - movie.id (uuid) -> ignore
            if (movie?.tmdb_id !== undefined && movie?.tmdb_id !== null) {
                const n = Number(movie.tmdb_id);
                return Number.isFinite(n) && n > 0 ? n : null;
            }

            const rawId = movie?.id;
            if (isUuidLike(rawId)) return null;
            const n = Number(rawId);
            return Number.isFinite(n) && n > 0 ? n : null;
        }

        async function getDbMovieIdByTmdbId(tmdb_id) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            const n = Number(tmdb_id);
            if (!Number.isFinite(n) || n <= 0) throw new Error('Missing tmdb_id.');

            const { data, error } = await supabaseClient
                .from('Movies')
                .select('id')
                .eq('tmdb_id', n)
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0]?.id || null;
        }

        async function getDbMovieRowById(movie_id) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Movies')
                .select('*')
                .eq('id', movie_id)
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function resolveDbMovieIdFromSelectedMovie(movie) {
            if (!movie) return null;
            // Allow callers (like Data Dash poster clicks) to pass the DB id explicitly.
            if (movie?.db_movie_id !== undefined && movie?.db_movie_id !== null && String(movie.db_movie_id).trim() !== '') {
                return movie.db_movie_id;
            }
            if (isUuidLike(movie?.id)) return movie.id;
            const tmdb_id = getTmdbIdFromSelectedMovie(movie);
            if (!tmdb_id) return null;
            return await getDbMovieIdByTmdbId(tmdb_id);
        }

        async function hasExistingMovieRating({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Movie Ratings')
                .select('id')
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .limit(1);

            if (error) throw error;
            return Array.isArray(data) && data.length > 0;
        }

        async function getExistingMovieRatingRow({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Movie Ratings')
                .select('*')
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function getLatestWatchLog({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Watch Logs')
                .select(`id, watch_method, ${COL_WATCH_DATE}`)
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .order(COL_WATCH_DATE, { ascending: false })
                .order('id', { ascending: false })
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function getEarliestWatchLog({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            const { data, error } = await supabaseClient
                .from('Watch Logs')
                .select(`id, watch_method, ${COL_WATCH_DATE}`)
                .eq('user_id', user_id)
                .eq('movie_id', movie_id)
                .order(COL_WATCH_DATE, { ascending: true })
                .order('id', { ascending: true })
                .limit(1);

            if (error) throw error;
            if (!Array.isArray(data) || data.length === 0) return null;
            return data[0] || null;
        }

        async function getWatchLogCount({ user_id, movie_id }) {
            if (!supabaseClient) throw new Error('Supabase client not initialized.');
            if (!user_id) throw new Error('Missing user_id.');
            if (!movie_id) throw new Error('Missing movie_id.');

            // Use an efficient count-only query.
            const { count, error } = await supabaseClient
                .from('Watch Logs')
                .select('id', { count: 'exact', head: true })
                .eq('user_id', user_id)
                .eq('movie_id', movie_id);

            if (error) throw error;
            return Number.isFinite(Number(count)) ? Number(count) : 0;
        }

        function getLocalISODate(d = new Date()) {
            const dt = (d instanceof Date) ? d : new Date(d);
            const year = dt.getFullYear();
            const month = String(dt.getMonth() + 1).padStart(2, '0');
            const day = String(dt.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function decodeJwtPayload(token) {
            try {
                const parts = String(token || '').split('.');
                if (parts.length < 2) return null;
                const b64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                const padded = b64 + '='.repeat((4 - (b64.length % 4)) % 4);
                const json = atob(padded);
                return JSON.parse(json);
            } catch (_) {
                return null;
            }
        }

        async function callSwiftApi(body, accessToken) {
            const iss = decodeJwtPayload(accessToken)?.iss;
            if (iss && typeof iss === 'string' && !iss.includes(SUPABASE_URL)) {
                throw new Error(
                    `Auth token is for a different Supabase project (iss=${iss}). Check SUPABASE_URL.`
                );
            }

            const url = `${SUPABASE_URL}/functions/v1/swift-api`;
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify(body)
            });

            const text = await res.text();
            let data = null;
            try {
                data = text ? JSON.parse(text) : null;
            } catch (_) {
                data = text;
            }

            if (!res.ok) {
                const serverMsg =
                    data && typeof data === 'object'
                        ? (data.message || data.error || JSON.stringify(data))
                        : String(data || '');
                const serverDetails =
                    data && typeof data === 'object' && data.details
                        ? ` (${String(data.details)})`
                        : '';
                throw new Error(`swift-api failed (HTTP ${res.status}) - ${serverMsg}${serverDetails}`);
            }

            return data;
        }

        async function callColorThemeEdge(body, accessToken) {
            const iss = decodeJwtPayload(accessToken)?.iss;
            if (iss && typeof iss === 'string' && !iss.includes(SUPABASE_URL)) {
                throw new Error(
                    `Auth token is for a different Supabase project (iss=${iss}). Check SUPABASE_URL.`
                );
            }

            const url = `${SUPABASE_URL}/functions/v1/color-theme`;
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify(body)
            });

            const text = await res.text();
            let data = null;
            try {
                data = text ? JSON.parse(text) : null;
            } catch (_) {
                data = text;
            }

            if (!res.ok) {
                const serverMsg =
                    data && typeof data === 'object'
                        ? (data.message || data.error || JSON.stringify(data))
                        : String(data || '');
                throw new Error(`color-theme failed (HTTP ${res.status}) - ${serverMsg}`);
            }

            return data;
        }

        let cachedAuthUser = null;
        let cachedIsAuthed = false;

        let cachedUserDisplayNameId = null;
        let cachedUserDisplayName = '';
        let cachedUserDisplayNameLoaded = false;
        let cachedUserIconId = null;
        let cachedUserIcon = '';
        let cachedUserIconLoaded = false;

        const NEW_FEATURES_POPUP_PATH = 'new-features-popup.txt';
        const AI_HELP_POPUP_PATH = 'ai-help-popup.txt';
        const popupTextCache = new Map();
        const THEME_STORAGE_KEY = 'ct_theme';
        const DEFAULT_THEME_OPTIONS = [];
        let themeOptions = DEFAULT_THEME_OPTIONS.slice();
        let themeOptionsById = new Map();
        let themeOptionsByName = new Map();
        let themeColorsById = new Map();
        let themeCreatorThemes = [];

        const THEME_CREATOR_OWNER_EMAIL = 'landon.talus@gmail.com';
        const THEME_CREATOR_PAGES = [
            { value: 'home', label: 'Home' },
            { value: 'ai', label: 'AI' },
            { value: 'lists', label: 'Lists' },
            { value: 'feed', label: 'Feed' },
            { value: 'mymovies', label: 'MyMovies' },
            { value: 'dashboard', label: 'Data Dash' },
        ];

        function formatThemeLabel(raw) {
            const name = String(raw || '').trim();
            if (!name) return '';
            if (/\s/.test(name)) return name;
            return name
                .split(/[-_]/g)
                .map((part) => (part ? part[0].toUpperCase() + part.slice(1) : ''))
                .join(' ');
        }

        function normalizeThemeName(raw) {
            return String(raw || '').trim().toLowerCase();
        }

        function buildThemeOptionsFromRows(rows) {
            const items = Array.isArray(rows) ? rows : [];
            return items
                .map((row) => {
                    const id = String(row?.id || '').trim();
                    const name = String(row?.name || '').trim();
                    if (!id || !name) return null;
                    const slug = slugifyThemeCreatorValue(name) || 'theme';
                    return {
                        id,
                        name,
                        value: id,
                        label: name,
                        slug,
                    };
                })
                .filter(Boolean);
        }

        function mergeThemeOptions(baseOptions, extraOptions) {
            const merged = new Map();
            (Array.isArray(baseOptions) ? baseOptions : []).forEach((opt) => {
                if (opt?.value) merged.set(opt.value, opt);
            });
            (Array.isArray(extraOptions) ? extraOptions : []).forEach((opt) => {
                if (opt?.value && !merged.has(opt.value)) merged.set(opt.value, opt);
            });
            return Array.from(merged.values());
        }

        function setThemeOptions(nextOptions) {
            themeOptions = Array.isArray(nextOptions) ? nextOptions : DEFAULT_THEME_OPTIONS.slice();
            themeOptionsById = new Map();
            themeOptionsByName = new Map();
            themeOptions.forEach((opt) => {
                if (opt?.id) themeOptionsById.set(String(opt.id), opt);
                if (opt?.name) themeOptionsByName.set(normalizeThemeName(opt.name), opt);
            });
            themeCreatorThemes = themeOptions.slice();
            updateThemeOptionUIs();
            if (themeCreatorActiveThemeId) {
                setThemeCreatorActiveTheme(themeCreatorActiveThemeId);
            }
        }

        function setThemeColorsMap(rows) {
            const next = new Map();
            const items = Array.isArray(rows) ? rows : [];
            items.forEach((row) => {
                const id = String(row?.id || '').trim();
                if (!id) return;
                const colors = row?.colors && typeof row.colors === 'object' ? row.colors : null;
                if (colors) next.set(id, colors);
            });
            themeColorsById = next;
        }

        function updateThemeOptionUIs() {
            const accountSelect = document.getElementById('account-theme-select');
            if (accountSelect) {
                const current = String(accountSelect.value || getStoredTheme()).trim();
                accountSelect.innerHTML = buildThemeCreatorOptions(themeOptions, current);
                if (current) accountSelect.value = current;
            }

            document.querySelectorAll('select[data-theme-creator-select="theme"]').forEach((select) => {
                if (!(select instanceof HTMLSelectElement)) return;
                const current = String(select.value || '').trim();
                select.innerHTML = buildThemeCreatorOptions(themeCreatorThemes, current);
                if (current) select.value = current;
            });

            const editSelect = document.getElementById('theme-creator-edit-select');
            if (editSelect && editSelect instanceof HTMLSelectElement) {
                const current = String(editSelect.value || '').trim();
                editSelect.innerHTML = buildThemeCreatorOptions(themeCreatorThemes, current);
                if (current) editSelect.value = current;
            }
        }

        async function loadThemeOptions() {
            const defaults = DEFAULT_THEME_OPTIONS.slice();
            if (!supabaseClient) {
                setThemeOptions(defaults);
                return;
            }

            let rows = null;
            try {
                const { data, error } = await supabaseClient
                    .from('Themes')
                    .select('id, name, colors');
                if (error) throw error;
                rows = data;
            } catch (_) {
                setThemeOptions(defaults);
                return;
            }

            const extras = buildThemeOptionsFromRows(rows);
            setThemeColorsMap(rows);
            setThemeOptions(mergeThemeOptions(defaults, extras));
        }

        function getThemeCreatorThemeOptions() {
            return themeCreatorThemes;
        }

        function getThemeOptionById(themeId) {
            if (!themeId) return null;
            return themeOptionsById.get(String(themeId)) || null;
        }

        function getThemeOptionByName(name) {
            const key = normalizeThemeName(name);
            return themeOptionsByName.get(key) || null;
        }

        function addThemeOptionLocal(option) {
            if (!option?.id || !option?.name) return;
            const next = Array.isArray(themeOptions) ? themeOptions.slice() : [];
            const idx = next.findIndex((opt) => String(opt?.value || '') === String(option.value));
            if (idx >= 0) {
                next[idx] = { ...next[idx], ...option };
            } else {
                next.push(option);
            }
            setThemeOptions(next);
        }

        function setThemeCreatorThemeStatus(message, level = 'info') {
            const el = document.getElementById('theme-creator-theme-status');
            if (!el) return;
            el.textContent = String(message || '').trim();
            if (level === 'error') el.style.color = 'rgba(239,68,68,0.95)';
            else if (level === 'success') el.style.color = 'rgba(16,185,129,0.9)';
            else el.style.color = 'rgba(255,255,255,0.60)';
        }

        function setThemeCreatorStep(step) {
            const next = Number(step) || 1;
            themeCreatorStep = next;
            const steps = [
                { id: 'theme-creator-step-mode', step: 1 },
                { id: 'theme-creator-step-name', step: 2 },
                { id: 'theme-creator-step-backdrops', step: 3 },
                { id: 'theme-creator-step-ai', step: 4 },
                { id: 'theme-creator-step-prompt', step: 5 },
            ];
            steps.forEach((item) => {
                const el = document.getElementById(item.id);
                if (!el) return;
                el.classList.toggle('hidden', item.step !== next);
            });
        }

        function setThemeCreatorMode(mode) {
            const createPanel = document.getElementById('theme-creator-create-panel');
            const editPanel = document.getElementById('theme-creator-edit-panel');
            const createBtn = document.getElementById('theme-creator-mode-create');
            const editBtn = document.getElementById('theme-creator-mode-edit');
            const next = mode === 'edit' ? 'edit' : 'create';
            if (createPanel) createPanel.classList.toggle('hidden', next !== 'create');
            if (editPanel) editPanel.classList.toggle('hidden', next !== 'edit');
            if (createBtn) createBtn.classList.toggle('btn-primary', next === 'create');
            if (createBtn) createBtn.classList.toggle('btn-outline', next !== 'create');
            if (editBtn) editBtn.classList.toggle('btn-primary', next === 'edit');
            if (editBtn) editBtn.classList.toggle('btn-outline', next !== 'edit');
            themeCreatorMode = next;
            if (next === 'create') {
                themeCreatorExisting = [];
                renderThemeCreatorBackdrops(themeCreatorBackdrops);
            }
        }

        function setThemeCreatorActiveTheme(themeId) {
            themeCreatorActiveThemeId = themeId || null;
            const opt = getThemeOptionById(themeCreatorActiveThemeId);
            themeCreatorActiveThemeName = String(opt?.name || '').trim();
            const editSelect = document.getElementById('theme-creator-edit-select');
            const editName = document.getElementById('theme-creator-edit-name');
            const activeLabel = document.getElementById('theme-creator-active-name');
            if (editSelect && themeCreatorActiveThemeId) {
                editSelect.value = String(themeCreatorActiveThemeId);
            }
            if (editName) editName.value = themeCreatorActiveThemeName;
            if (activeLabel) activeLabel.textContent = themeCreatorActiveThemeName || 'None';
            renderThemeCreatorSelected();
            if (themeCreatorMode === 'edit' && themeCreatorActiveThemeId) {
                loadThemeCreatorExistingBackdrops(themeCreatorActiveThemeId).catch(() => null);
            }
        }

        function getThemeCreatorStylePrompt() {
            const input = document.getElementById('theme-creator-style-prompt');
            return String(input?.value || '').trim();
        }

        async function generateThemeCreatorColors({ themeId, themeName, stylePrompt }) {
            if (!supabaseClient || !themeCreatorAiMovie?.tmdb_id) return false;

            try {
                const { data } = await supabaseClient.auth.getSession();
                const token = data?.session?.access_token;
                if (!token) throw new Error('Missing session token.');

                let details = null;
                try {
                    details = await callSwiftApiGetMovieDetails({ tmdb_id: Number(themeCreatorAiMovie.tmdb_id) });
                } catch (_) {
                    details = null;
                }

                const genres = Array.isArray(details?.genres)
                    ? details.genres.map((g) => String(g).trim()).filter(Boolean)
                    : [];
                const overview = String(details?.overview || '').trim();
                const year = Number(details?.year ?? themeCreatorAiMovie?.year ?? null);
                const movieYear = Number.isFinite(year) ? year : null;

                const payload = {
                    theme_id: themeId,
                    theme_name: themeName,
                    movie_title: String(details?.title || themeCreatorAiMovie?.title || '').trim(),
                    movie_year: movieYear,
                    movie_genres: genres,
                    movie_overview: overview,
                    style_prompt: String(stylePrompt || '').trim(),
                };

                setThemeCreatorThemeStatus('Generating theme colors');
                const result = await callColorThemeEdge(payload, token);
                if (result?.colors && typeof result.colors === 'object') {
                    themeColorsById.set(String(themeId), result.colors);
                    if (String(getStoredTheme()) === String(themeId)) {
                        applyTheme(themeId);
                    }
                }
                setThemeCreatorThemeStatus('Theme colors generated.', 'success');
                showToast('Theme colors generated.', { level: 'success' });
                return true;
            } catch (err) {
                setThemeCreatorThemeStatus(`Color generation failed: ${String(err?.message || err)}`, 'error');
                showToast(`Color generation failed: ${String(err?.message || err)}`, { level: 'warn' });
                return false;
            }
        }

        async function createThemeCreatorTheme({ advance = true } = {}) {
            const input = document.getElementById('theme-creator-new-name');
            const btn = document.getElementById('theme-creator-create-btn');
            const name = String(input?.value || '').trim();

            if (!name) {
                setThemeCreatorThemeStatus('Enter a theme name first.', 'error');
                return;
            }


            if (getThemeOptionByName(name)) {
                setThemeCreatorThemeStatus('That theme already exists.', 'error');
                return;
            }

            if (!supabaseClient) {
                setThemeCreatorThemeStatus('Supabase SDK failed to load.', 'error');
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.style.opacity = 0.7;
            }
            setThemeCreatorThemeStatus('Creating theme');

            try {
                const { data, error } = await supabaseClient
                    .from('Themes')
                    .insert({ name })
                    .select('id, name')
                    .single();
                if (error) throw error;

                const themeId = String(data?.id || '').trim();
                const themeName = String(data?.name || '').trim() || name;
                if (!themeId) throw new Error('Theme id missing.');

                addThemeOptionLocal({
                    id: themeId,
                    name: themeName,
                    value: themeId,
                    label: themeName,
                    slug: slugifyThemeCreatorValue(themeName) || 'theme',
                });

                if (input) input.value = '';
                setThemeCreatorActiveTheme(themeId);
                setThemeCreatorMode('edit');
                setThemeCreatorThemeStatus('Theme created.', 'success');
                showToast('Theme created.', { level: 'success' });
                if (advance) setThemeCreatorStep(3);
            } catch (err) {
                const msg = String(err?.message || err);
                if (/duplicate key|already exists|unique/i.test(msg)) {
                    setThemeCreatorThemeStatus('That theme already exists.', 'error');
                } else {
                    setThemeCreatorThemeStatus(`Create failed: ${msg}`, 'error');
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = 1;
                }
            }
        }

        async function updateThemeCreatorThemeName() {
            const select = document.getElementById('theme-creator-edit-select');
            const input = document.getElementById('theme-creator-edit-name');
            const btn = document.getElementById('theme-creator-update-btn');
            const themeId = String(select?.value || '').trim();
            const name = String(input?.value || '').trim();

            if (!themeId) {
                setThemeCreatorThemeStatus('Select a theme first.', 'error');
                return;
            }

            if (!name) {
                setThemeCreatorThemeStatus('Enter a new name.', 'error');
                return;
            }


            const existing = getThemeOptionByName(name);
            if (existing && String(existing.id) !== themeId) {
                setThemeCreatorThemeStatus('That theme name already exists.', 'error');
                return;
            }

            if (!supabaseClient) {
                setThemeCreatorThemeStatus('Supabase SDK failed to load.', 'error');
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.style.opacity = 0.7;
            }
            setThemeCreatorThemeStatus('Updating theme');

            try {
                const { error } = await supabaseClient
                    .from('Themes')
                    .update({ name })
                    .eq('id', themeId);
                if (error) throw error;

                addThemeOptionLocal({
                    id: themeId,
                    name,
                    value: themeId,
                    label: name,
                    slug: slugifyThemeCreatorValue(name) || 'theme',
                });
                setThemeCreatorActiveTheme(themeId);
                setThemeCreatorThemeStatus('Theme updated.', 'success');
                showToast('Theme updated.', { level: 'success' });
            } catch (err) {
                const msg = String(err?.message || err);
                setThemeCreatorThemeStatus(`Update failed: ${msg}`, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = 1;
                }
            }
        }

        async function loadThemeBackgroundImages() {
            if (!supabaseClient) return;
            try {
                let data = null;
                try {
                    const res = await supabaseClient
                        .from('Background Images')
                        .select('theme_id, url, page');
                    if (res.error) throw res.error;
                    data = res.data;
                } catch (err) {
                    const msg = String(err?.message || err);
                    if (/column\s+"?theme_id"?\s+does\s+not\s+exist/i.test(msg)) {
                        const res2 = await supabaseClient
                            .from('Background Images')
                            .select('theme_id, url, page');
                        if (res2.error) throw res2.error;
                        data = res2.data;
                    } else {
                        throw err;
                    }
                }

                const rows = Array.isArray(data) ? data : [];
                const rules = [];

                const normalizePage = (raw) => {
                    const s = String(raw || '').trim().toLowerCase();
                    const compact = s.replace(/\s+/g, '');
                    if (!s) return '';
                    if (s === 'home') return 'home';
                    if (s === 'ai') return 'ai_picks';
                    if (s === 'lists') return 'lists';
                    if (s === 'feed') return 'feed';
                    if (s === 'mymovies') return 'library';
                    if (s === 'dashboard' || s === 'dashboard_kpi' || s === 'dashboard_pie_filter' || s === 'data' || compact === 'datadash' || compact === 'dashboardkpi' || compact === 'dashboardpiefilter') return 'dashboard';
                    return '';
                };

                const buildPageSelectors = (pageKey) => {
                    if (!pageKey) return [];
                    if (pageKey === 'dashboard') return ['dashboard', 'dashboard_kpi', 'dashboard_pie_filter'];
                    return [pageKey];
                };

                rows.forEach((row) => {
                    const themeIdRaw = row?.theme_id ?? null;
                    const themeId = String(themeIdRaw || '').trim();
                    const urlRaw = String(row?.url || '').trim();
                    const pageRaw = normalizePage(row?.page);
                    if (!urlRaw) return;

                    const urlEscaped = urlRaw.replace(/"/g, '\\"');
                    const pages = buildPageSelectors(pageRaw);
                    if (!pages.length) return;

                    if (!themeId) {
                        pages.forEach((pageKey) => {
                            rules.push(`body[data-page="${pageKey}"]{--bg-image:url("${urlEscaped}");}`);
                        });
                        return;
                    }

                    pages.forEach((pageKey) => {
                        rules.push(`body[data-theme-id="${themeId}"][data-page="${pageKey}"]{--bg-image:url("${urlEscaped}");}`);
                    });
                });

                const styleId = 'theme-background-images';
                let styleEl = document.getElementById(styleId);
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = styleId;
                    document.head.appendChild(styleEl);
                }
                styleEl.textContent = rules.join('\n');
            } catch (_) {
                // No fallback if load fails.
            }
        }

        function getStoredTheme() {
            try {
                const raw = String(localStorage.getItem(THEME_STORAGE_KEY) || '').trim();
                return raw || '';
            } catch (_) {
                return '';
            }
        }

        function resolveThemeId(input) {
            const candidate = String(input || '').trim();
            if (candidate && themeOptionsById.has(candidate)) return candidate;
            const first = themeOptions[0];
            return String(first?.value || first?.id || '').trim();
        }

        function parseColorToRgb(input) {
            const raw = String(input || '').trim();
            if (!raw) return null;
            if (raw.startsWith('#')) {
                let hex = raw.slice(1);
                if (hex.length === 3) hex = hex.split('').map((c) => c + c).join('');
                if (hex.length === 6) {
                    const num = parseInt(hex, 16);
                    if (!Number.isFinite(num)) return null;
                    return {
                        r: (num >> 16) & 255,
                        g: (num >> 8) & 255,
                        b: num & 255,
                    };
                }
                return null;
            }
            const rgbMatch = raw.match(/rgba?\s*\(\s*([0-9.]+)\s*,\s*([0-9.]+)\s*,\s*([0-9.]+)/i);
            if (rgbMatch) {
                return {
                    r: Number(rgbMatch[1]),
                    g: Number(rgbMatch[2]),
                    b: Number(rgbMatch[3]),
                };
            }
            return null;
        }

        function rgbToHsl(rgb) {
            const r = Math.max(0, Math.min(255, Number(rgb?.r))) / 255;
            const g = Math.max(0, Math.min(255, Number(rgb?.g))) / 255;
            const b = Math.max(0, Math.min(255, Number(rgb?.b))) / 255;
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const delta = max - min;

            let h = 0;
            if (delta > 0) {
                if (max === r) h = ((g - b) / delta) % 6;
                else if (max === g) h = (b - r) / delta + 2;
                else h = (r - g) / delta + 4;
                h = Math.round(h * 60);
                if (h < 0) h += 360;
            }
            const l = (max + min) / 2;
            const s = delta === 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
            return {
                h,
                s: Math.round(s * 100),
            };
        }

        function applyThemeColors(colors) {
            const c = colors && typeof colors === 'object' ? colors : null;
            if (!c) {
                showToast('Theme colors are missing. Add colors in Supabase.', { level: 'warn' });
                return;
            }
            const root = document.documentElement;

            const base = {
                bg_dark: String(c.bg_dark || '').trim(),
                surface: String(c.surface || '').trim(),
                border: String(c.border || '').trim(),
                text_main: String(c.text_main || '').trim(),
                text_muted: String(c.text_muted || '').trim(),
                brand: String(c.brand || '').trim(),
                brand_hover: String(c.brand_hover || '').trim(),
                brand_2: String(c.brand_2 || '').trim(),
                brand_3: String(c.brand_3 || '').trim(),
                accent_1: String(c.accent_1 || '').trim(),
                accent_2: String(c.accent_2 || '').trim(),
                nav_accent: String(c.nav_accent || '').trim(),
                nav_title: String(c.nav_title || '').trim(),
            };

            if (base.bg_dark) root.style.setProperty('--bg-dark', base.bg_dark);
            if (base.surface) root.style.setProperty('--surface', base.surface);
            if (base.border) root.style.setProperty('--border', base.border);
            if (base.text_main) root.style.setProperty('--text-main', base.text_main);
            if (base.text_muted) root.style.setProperty('--text-muted', base.text_muted);
            if (base.brand) root.style.setProperty('--brand', base.brand);
            if (base.brand_hover) root.style.setProperty('--brand-hover', base.brand_hover);
            if (base.brand_2) root.style.setProperty('--brand-2', base.brand_2);
            if (base.brand_3) root.style.setProperty('--brand-3', base.brand_3);
            if (base.accent_1) root.style.setProperty('--accent-1', base.accent_1);
            if (base.accent_2) root.style.setProperty('--accent-2', base.accent_2);
            if (base.nav_accent) root.style.setProperty('--nav-accent', base.nav_accent);
            if (base.nav_title) root.style.setProperty('--nav-title', base.nav_title);

            const derived = {
                brand_light: String(c.brand_light || '').trim(),
                brand_shadow: String(c.brand_shadow || '').trim(),
                nav_active_a: String(c.nav_active_a || '').trim(),
                nav_active_b: String(c.nav_active_b || '').trim(),
                glass_bg: String(c.glass_bg || '').trim(),
                glass_border: String(c.glass_border || '').trim(),
                glass_shadow: String(c.glass_shadow || '').trim(),
                btn_outline_bg: String(c.btn_outline_bg || '').trim(),
                focus_ring: String(c.focus_ring || '').trim(),
                bg_overlay: String(c.bg_overlay || '').trim(),
            };

            if (derived.brand_light) root.style.setProperty('--brand-light', derived.brand_light);
            if (derived.brand_shadow) root.style.setProperty('--brand-shadow', derived.brand_shadow);
            if (derived.nav_active_a) root.style.setProperty('--nav-active-a', derived.nav_active_a);
            if (derived.nav_active_b) root.style.setProperty('--nav-active-b', derived.nav_active_b);
            if (derived.glass_bg) root.style.setProperty('--glass-bg', derived.glass_bg);
            if (derived.glass_border) root.style.setProperty('--glass-border', derived.glass_border);
            if (derived.glass_shadow) root.style.setProperty('--glass-shadow', derived.glass_shadow);
            if (derived.btn_outline_bg) root.style.setProperty('--btn-outline-bg', derived.btn_outline_bg);
            if (derived.focus_ring) root.style.setProperty('--focus-ring', derived.focus_ring);
            if (derived.bg_overlay) root.style.setProperty('--bg-overlay', derived.bg_overlay);

            const heatmapSeed = base.accent_1 || base.accent_2 || base.brand || '';
            const rgb = parseColorToRgb(heatmapSeed);
            if (rgb) {
                const hsl = rgbToHsl(rgb);
                if (Number.isFinite(hsl?.h)) root.style.setProperty('--heatmap-h', String(hsl.h));
                if (Number.isFinite(hsl?.s)) root.style.setProperty('--heatmap-s', `${hsl.s}%`);
            }
        }

        function applyTheme(theme) {
            const t = resolveThemeId(theme);
            if (!t) return;
            document.body.setAttribute('data-theme-id', t);
            const colors = themeColorsById.get(String(t)) || null;
            applyThemeColors(colors);
            loadNavLogoForTheme(t);
            try { localStorage.setItem(THEME_STORAGE_KEY, t); } catch (_) {}
            const select = document.getElementById('account-theme-select');
            if (select) {
                const hasOption = Array.from(select.options || []).some((opt) => opt.value === t);
                if (!hasOption) {
                    const label = getThemeOptionById(t)?.name || formatThemeLabel(t);
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = label;
                    select.appendChild(opt);
                }
                select.value = t;
            }
        }

        async function saveAccountThemeSelection(themeId) {
            if (!supabaseClient || !cachedIsAuthed) return;
            const uid = String(cachedAuthUser?.id || '').trim();
            if (!uid) return;
            const value = themeId || null;
            try {
                const { error } = await supabaseClient
                    .from('Users')
                    .update({ theme_id: value })
                    .eq('id', uid);
                if (error) throw error;
            } catch (err) {
                const msg = String(err?.message || err);
                if (!/column\s+"?theme_id"?\s+does\s+not\s+exist/i.test(msg)) {
                    showToast(`Theme update failed: ${msg}`, { level: 'warn' });
                }
            }
        }

        function canAccessThemeCreator(email) {
            const e = String(email || cachedAuthUser?.email || '').trim().toLowerCase();
            const allowed = String(THEME_CREATOR_OWNER_EMAIL || '').trim().toLowerCase();
            return Boolean(e && allowed && e === allowed);
        }

        function updateThemeCreatorVisibility(email) {
            const card = document.getElementById('theme-creator-card');
            if (!card) return;
            const canView = canAccessThemeCreator(email);
            card.classList.toggle('hidden', !canView);
        }

        function fallbackAccountName(user) {
            const email = String(user?.email || '').trim();
            if (email) return email.split('@')[0] || email;

            const id = String(user?.id || '').trim();
            if (!id) return '';
            return id.length > 8 ? `${id.slice(0, 8)}` : id;
        }

        async function refreshAuthStateAndUI() {
            if (!supabaseClient) return;

            const navLoginBtn = document.getElementById('nav-login-btn');
            const statusEl = document.getElementById('auth-modal-status');
            const loginBtn = document.getElementById('auth-login-btn');
            const logoutBtn = document.getElementById('auth-logout-btn');
            const emailEl = document.getElementById('auth-email');
            const pwdEl = document.getElementById('auth-password');
            const saveBtn = document.getElementById('btn-save-diary');

            const { data, error } = await supabaseClient.auth.getSession();
            if (error) {
                cachedAuthUser = null;
                cachedIsAuthed = false;
                if (statusEl) statusEl.textContent = 'Auth error.';
                if (statusEl) statusEl.style.color = 'rgba(239,68,68,0.95)';
                if (navLoginBtn) {
                    navLoginBtn.textContent = 'Login';
                    navLoginBtn.classList.remove('icon-only');
                    navLoginBtn.removeAttribute('aria-label');
                }
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = 0.6;
                    saveBtn.setAttribute('aria-disabled', 'true');
                    saveBtn.title = 'Please log in first.';
                }
                return;
            }

            const user = data?.session?.user || null;
            const isAuthed = Boolean(user?.id);

            cachedAuthUser = user;
            cachedIsAuthed = isAuthed;

            if (isAuthed) {
                const uid = String(user.id);
                // Best-effort; don't block UI.
                ensureBucketListForUser({ user_id: uid }).catch(() => null);
            } else {
                cachedLists = [];
                cachedListsUserId = null;
                listsActiveListId = null;
                listsActiveListName = '';
                cachedBucketListId = null;
                bucketListEnsuredForUserId = null;
                cachedUserDisplayNameId = null;
                cachedUserDisplayName = '';
                cachedUserDisplayNameLoaded = false;
                cachedUserIconId = null;
                cachedUserIcon = '';
                cachedUserIconLoaded = false;
            }

            let displayName = '';
            if (isAuthed) {
                const uid = String(user.id);
                if (cachedUserDisplayNameId !== uid) {
                    cachedUserDisplayNameId = uid;
                    cachedUserDisplayName = '';
                    cachedUserDisplayNameLoaded = false;
                    cachedUserIconId = uid;
                    cachedUserIcon = '';
                    cachedUserIconLoaded = false;
                }

                if (!cachedUserDisplayNameLoaded || !cachedUserIconLoaded) {
                    cachedUserDisplayNameLoaded = true;
                    cachedUserIconLoaded = true;
                    try {
                        let usersRows = null;
                        try {
                            const res = await supabaseClient
                                .from('Users')
                                .select('display_name, icon, theme_id')
                                .eq('id', uid)
                                .limit(1);
                            if (res.error) throw res.error;
                            usersRows = res.data;
                        } catch (err) {
                            const msg = String(err?.message || err);
                            if (/column\s+"?theme_id"?\s+does\s+not\s+exist/i.test(msg)) {
                                const res2 = await supabaseClient
                                    .from('Users')
                                    .select('display_name, icon')
                                    .eq('id', uid)
                                    .limit(1);
                                if (!res2.error) usersRows = res2.data;
                            }
                        }

                        if (Array.isArray(usersRows) && usersRows.length > 0) {
                            cachedUserDisplayName = String(usersRows[0]?.display_name || '').trim();
                            cachedUserIcon = String(usersRows[0]?.icon || '').trim();
                            const themeId = String(usersRows[0]?.theme_id || '').trim();
                            if (themeId) applyTheme(themeId);
                        }
                    } catch (_) {
                        try {
                            const { data: usersRows, error: usersErr } = await supabaseClient
                                .from('Users')
                                .select('display_name')
                                .eq('id', uid)
                                .limit(1);
                            if (!usersErr && Array.isArray(usersRows) && usersRows.length > 0) {
                                cachedUserDisplayName = String(usersRows[0]?.display_name || '').trim();
                            }
                        } catch (_) {
                            // RLS or missing table: fall back silently.
                        }
                    }
                }

                displayName = String(cachedUserDisplayName || '').trim();
            }

            if (navLoginBtn) {
                if (isAuthed) {
                    const dn = displayName || fallbackAccountName(user);
                    const iconId = String(cachedUserIcon || '').trim();
                    if (iconId) {
                        navLoginBtn.innerHTML = renderUserIconHtml(iconId, 60);
                        navLoginBtn.classList.add('icon-only');
                        navLoginBtn.setAttribute('aria-label', dn ? `Account: ${dn}` : 'Account');
                    } else {
                        navLoginBtn.textContent = dn ? `${dn} - Account` : 'Account';
                        navLoginBtn.classList.remove('icon-only');
                        navLoginBtn.removeAttribute('aria-label');
                    }
                } else {
                    navLoginBtn.textContent = 'Login';
                    navLoginBtn.classList.remove('icon-only');
                    navLoginBtn.removeAttribute('aria-label');
                }
            }

            const mobileAuthBtn = document.getElementById('mobile-auth-btn');
            if (mobileAuthBtn) {
                mobileAuthBtn.textContent = isAuthed
                    ? (displayName ? `${displayName} - Account` : 'Account')
                    : 'Login';
            }
            if (statusEl) {
                if (isAuthed) {
                    const dn = displayName || fallbackAccountName(user);
                    statusEl.textContent = dn ? `Logged in as ${dn}` : `Logged in as ${user.email || user.id}`;
                } else {
                    statusEl.textContent = 'Not logged in.';
                }
                statusEl.style.color = 'var(--text-muted)';
            }
            if (loginBtn) loginBtn.style.display = isAuthed ? 'none' : 'inline-flex';
            if (logoutBtn) logoutBtn.style.display = isAuthed ? 'inline-flex' : 'none';

            if (emailEl) {
                emailEl.disabled = isAuthed;
                emailEl.classList.toggle('input-readonly', isAuthed);
            }
            if (pwdEl) {
                pwdEl.disabled = isAuthed;
                pwdEl.classList.toggle('input-readonly', isAuthed);
            }

            if (saveBtn) {
                const locked = !isAuthed;
                saveBtn.disabled = false;
                saveBtn.style.opacity = locked ? 0.6 : 1;
                saveBtn.setAttribute('aria-disabled', locked ? 'true' : 'false');
                saveBtn.title = locked ? 'Please log in first.' : '';
            }

            if (isAuthed) {
                showNewFeaturesPopupIfNeeded().catch(() => null);
                if (String(router?.currentPage || '') === 'ai_picks') {
                    showAiHelpPopupIfNeeded().catch(() => null);
                }
            }
        }

        async function fetchHelpPopupsRow(userId) {
            const uid = String(userId || '').trim();
            if (!uid || !supabaseClient) return null;
            try {
                const { data, error } = await supabaseClient
                    .from('Help Pop-ups')
                    .select('user_id, "AI Picks Help", "New Feature News"')
                    .eq('user_id', uid)
                    .limit(1);
                if (error) throw error;
                return Array.isArray(data) && data.length > 0 ? data[0] : null;
            } catch (_) {
                return null;
            }
        }

        async function ensureHelpPopupsRow(userId) {
            const uid = String(userId || '').trim();
            if (!uid || !supabaseClient) return;
            try {
                await supabaseClient
                    .from('Help Pop-ups')
                    .upsert({ user_id: uid }, { onConflict: 'user_id' });
            } catch (_) {
                // Best-effort only.
            }
        }

        async function getHelpPopupFlags(userId) {
            const uid = String(userId || '').trim();
            if (!uid) return { known: false, aiPicksHelp: false, newFeaturesNews: false };
            let row = await fetchHelpPopupsRow(uid);
            if (!row) {
                await ensureHelpPopupsRow(uid);
                row = await fetchHelpPopupsRow(uid);
            }
            if (!row) return { known: false, aiPicksHelp: false, newFeaturesNews: false };
            return {
                known: true,
                aiPicksHelp: row?.['AI Picks Help'] === true,
                newFeaturesNews: row?.['New Feature News'] === true,
            };
        }

        async function setHelpPopupFlag(userId, updates = {}) {
            const uid = String(userId || '').trim();
            if (!uid || !supabaseClient) return;
            const payload = { user_id: uid };
            if (updates.aiPicksHelp !== undefined) payload['AI Picks Help'] = Boolean(updates.aiPicksHelp);
            if (updates.newFeaturesNews !== undefined) payload['New Feature News'] = Boolean(updates.newFeaturesNews);
            try {
                await supabaseClient
                    .from('Help Pop-ups')
                    .upsert(payload, { onConflict: 'user_id' });
            } catch (_) {
                // Best-effort only.
            }
        }

        async function loadPopupTextFile(path) {
            const p = String(path || '').trim();
            if (!p) return '';
            if (popupTextCache.has(p)) return popupTextCache.get(p) || '';
            try {
                const res = await fetch(p, { cache: 'no-cache' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const text = await res.text();
                popupTextCache.set(p, text);
                return text;
            } catch (_) {
                return '';
            }
        }

        async function setPopupText(elId, path) {
            const el = document.getElementById(elId);
            if (!el) return;
            const text = await loadPopupTextFile(path);
            if (text) {
                el.innerHTML = text;
            } else {
                el.textContent = 'Unable to load content.';
            }
        }

        function openNewFeaturesPopup() {
            const overlay = document.getElementById('new-features-overlay');
            if (!overlay) return;
            setPopupText('new-features-popup-text', NEW_FEATURES_POPUP_PATH).catch(() => null);
            overlay.style.display = 'flex';
            overlay.classList.add('open');
            try {
                const box = document.getElementById('new-features-dismiss');
                if (box) box.checked = true;
            } catch (_) {}
        }

        function closeNewFeaturesPopup() {
            const overlay = document.getElementById('new-features-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
            overlay.style.display = 'none';
            try {
                const uid = String(cachedAuthUser?.id || '').trim();
                if (uid) {
                    setHelpPopupFlag(uid, { newFeaturesNews: true }).catch(() => null);
                }
            } catch (_) {
                // Best-effort only.
            }
        }

        function openAiHelpPopup() {
            const overlay = document.getElementById('ai-help-overlay');
            if (!overlay) return;
            setPopupText('ai-help-popup-text', AI_HELP_POPUP_PATH).catch(() => null);
            overlay.style.display = 'flex';
            overlay.classList.add('open');
        }

        function closeAiHelpPopup() {
            const overlay = document.getElementById('ai-help-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
            overlay.style.display = 'none';

            try {
                const box = document.getElementById('ai-help-dismiss');
                const checked = Boolean(box?.checked);
                const uid = String(cachedAuthUser?.id || '').trim();
                if (checked && uid) {
                    setHelpPopupFlag(uid, { aiPicksHelp: true }).catch(() => null);
                }
            } catch (_) {
                // Best-effort only.
            }
        }

        async function showNewFeaturesPopupIfNeeded() {
            if (!cachedIsAuthed) return;
            const uid = String(cachedAuthUser?.id || '').trim();
            if (!uid) return;
            const state = await getHelpPopupFlags(uid);
            if (!state.known || state.newFeaturesNews !== false) return;
            openNewFeaturesPopup();
            setHelpPopupFlag(uid, { newFeaturesNews: true }).catch(() => null);
        }

        async function showAiHelpPopupIfNeeded() {
            if (!cachedIsAuthed) return;
            const uid = String(cachedAuthUser?.id || '').trim();
            if (!uid) return;
            const state = await getHelpPopupFlags(uid);
            if (!state.known || state.aiPicksHelp !== false) return;
            const box = document.getElementById('ai-help-dismiss');
            if (box) box.checked = false;
            openAiHelpPopup();
        }

        async function handleLoginClick(e) {
            e?.preventDefault?.();
            try {
                if (!supabaseClient) throw new Error('Supabase client not initialized.');
                const email = String(document.getElementById('auth-email')?.value || '').trim();
                const password = String(document.getElementById('auth-password')?.value || '').trim();
                if (!email || !password) throw new Error('Enter email + password, then click Log in.');

                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                // Validate immediately (catches Invalid JWT situations early).
                const { data: userData, error: userErr } = await supabaseClient.auth.getUser();
                if (userErr || !userData?.user?.id) {
                    await supabaseClient.auth.signOut();
                    throw new Error('Login succeeded, but session token is invalid for this project. Verify SUPABASE_URL/keys.');
                }

                const pwdEl = document.getElementById('auth-password');
                if (pwdEl) pwdEl.value = '';

                await refreshAuthStateAndUI();
                showToast('Logged in. You can now save.');
                closeAuthModal();
            } catch (err) {
                // Refresh UI first (so button visibility/disabled states are correct),
                // then set the error text last so it doesn't get overwritten.
                await refreshAuthStateAndUI();

                const statusEl = document.getElementById('auth-modal-status');
                if (statusEl) {
                    statusEl.textContent = `Login failed: ${String(err?.message || err)}`;
                    statusEl.style.color = 'rgba(239,68,68,0.95)';
                }
            }
        }

        async function handleLogoutClick(e) {
            e?.preventDefault?.();
            try {
                if (!supabaseClient) return;
                await supabaseClient.auth.signOut();
                await refreshAuthStateAndUI();
                showToast('Logged out.');
                closeAuthModal();
            } catch (err) {
                showToast(`Logout failed: ${String(err.message || err)}`);
            }
        }

        function openAuthModal() {
            const overlay = document.getElementById('auth-overlay');
            if (!overlay) return;
            overlay.classList.add('open');
            refreshAuthStateAndUI();

            // Focus the first enabled field.
            const emailEl = document.getElementById('auth-email');
            const pwdEl = document.getElementById('auth-password');
            if (emailEl && !emailEl.disabled) emailEl.focus();
            else if (pwdEl && !pwdEl.disabled) pwdEl.focus();
        }

        function openDashboardAuthWarning() {
            const overlay = document.getElementById('dashboard-auth-warning');
            if (!overlay) return;
            overlay.classList.add('open');
        }

        function openAccountAuthWarning() {
            const overlay = document.getElementById('account-auth-warning');
            if (!overlay) return;
            overlay.classList.add('open');
        }

        function closeDashboardAuthWarning() {
            const overlay = document.getElementById('dashboard-auth-warning');
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        function closeAccountAuthWarning() {
            const overlay = document.getElementById('account-auth-warning');
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        function closeAuthModal() {
            const overlay = document.getElementById('auth-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        function handleNavAccountButtonClick(e) {
            e?.preventDefault?.();
            try {
                if (cachedIsAuthed) {
                    router.navigate('account');
                    return;
                }
                openAuthModal();
            } catch (_) {
                openAuthModal();
            }
        }

        let accountBound = false;

        function isUserIconUrl(iconId) {
            const raw = String(iconId || '').trim();
            if (!raw) return false;
            if (/^https?:\/\//i.test(raw)) return true;
            if (/^data:image\//i.test(raw)) return true;
            return false;
        }

        function renderUserIconHtml(iconId, sizePx = 28) {
            const raw = String(iconId || '').trim();
            if (isUserIconUrl(raw)) {
                return `
                    <span class="user-icon" style="width:${Number(sizePx)}px; height:${Number(sizePx)}px;">
                        <img src="${escapeHtml(raw)}" alt="User icon" loading="lazy" decoding="async" />
                    </span>
                `;
            }

            return `
                <span class="user-icon" style="width:${Number(sizePx)}px; height:${Number(sizePx)}px;">
                    ${icons.user}
                </span>
            `;
        }

        function normalizeUsername(raw) {
            const s = String(raw || '').trim().replace(/^@+/, '').toLowerCase();
            return s;
        }

        function validateUsername(username) {
            const u = normalizeUsername(username);
            if (!u) return 'Username is required.';
            if (u.length < 3 || u.length > 20) return 'Username must be 320 characters.';
            if (!/^[a-z0-9_]+$/.test(u)) return 'Username can only include letters, numbers, and underscore.';
            return '';
        }

        function getAccountSectionOverlay(kind) {
            const k = String(kind || '').trim();
            if (!k) return null;
            return document.getElementById(`account-${k}-overlay`);
        }

        function openAccountSectionModal(kind) {
            const overlay = getAccountSectionOverlay(kind);
            if (!overlay) return;
            overlay.classList.add('open');
            if (kind === 'profile') {
                const input = document.getElementById('account-username');
                if (input) input.focus();
            }
            if (kind === 'security') {
                const input = document.getElementById('account-new-password');
                if (input) input.focus();
            }
            if (kind === 'feature') {
                updateFeatureRequestCounter();
                const input = document.getElementById('feature-request-text');
                if (input) input.focus();
            }
        }

        function closeAccountSectionModal(kind) {
            const overlay = getAccountSectionOverlay(kind);
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        function openAiFiltersModal() {
            const overlay = document.getElementById('ai-filters-overlay');
            if (!overlay) return;
            overlay.classList.add('open');
            syncAiTmdbRatingFilter();
        }

        function closeAiFiltersModal() {
            const overlay = document.getElementById('ai-filters-overlay');
            if (!overlay) return;
            overlay.classList.remove('open');
        }

        function syncAiTmdbRatingFilter() {
            const input = document.getElementById('ai-filter-tmdb');
            const num = document.getElementById('ai-filter-tmdb-num');
            if (!input || !num) return;
            const v = Number(input.value);
            const n = Number.isFinite(v) ? Math.max(0, Math.min(100, v)) : 0;
            input.value = String(n);
            num.value = String(n);
        }

        function setAiInputsHidden(isHidden) {
            const inputs = document.getElementById('ai-inputs-wrap');
            if (inputs) inputs.classList.toggle('hidden', Boolean(isHidden));
        }

        async function getNextLoadingImage() {
            if (!supabaseClient) return { url: '', id: null };
            try {
                const { data, error } = await supabaseClient
                    .from('Loading Images')
                    .select('id, image_url, last_used')
                    .order('last_used', { ascending: true, nullsFirst: true })
                    .limit(1);
                if (error) throw error;
                const row = Array.isArray(data) && data.length > 0 ? data[0] : null;
                const url = String(row?.image_url || '').trim();
                const id = row?.id ? String(row.id).trim() : null;
                return { url, id };
            } catch (_) {
                return { url: '', id: null };
            }
        }

        async function markLoadingImageUsed(id) {
            const imageId = String(id || '').trim();
            if (!imageId || !supabaseClient) return;
            try {
                await supabaseClient
                    .from('Loading Images')
                    .update({ last_used: new Date().toISOString() })
                    .eq('id', imageId);
            } catch (_) {
                // Best-effort only.
            }
        }

        let aiLoadingImageRetryTimer = null;

        async function setNextAiLoadingImage({ retry = true } = {}) {
            const img = document.getElementById('ai-loading-image');
            if (!img) return;
            const { url, id } = await getNextLoadingImage();
            if (!url) {
                img.removeAttribute('src');
                img.style.display = 'none';
                if (retry) {
                    if (aiLoadingImageRetryTimer) clearTimeout(aiLoadingImageRetryTimer);
                    aiLoadingImageRetryTimer = setTimeout(() => {
                        setNextAiLoadingImage({ retry: false }).catch(() => null);
                    }, 600);
                }
                return;
            }
            img.style.display = 'block';
            img.src = url;
            if (id) markLoadingImageUsed(id).catch(() => null);
        }

        function setAiLoading(isLoading) {
            const loading = document.getElementById('ai-loading');
            if (loading) loading.classList.toggle('hidden', !isLoading);
            if (isLoading) {
                setNextAiLoadingImage().catch(() => null);
            }
        }

        function showAiResults(items = []) {
            const panel = document.getElementById('ai-results-panel');
            const list = document.getElementById('ai-results');
            if (!panel || !list) return;
            panel.classList.toggle('hidden', !items.length);
            list.innerHTML = items.length
                ? items.map((it, idx) => {
                    const title = String(it?.title || '').trim() || 'Untitled';
                    const yearVal = it?.year ? String(it.year) : '';
                    const reason = String(it?.reason || '').trim();
                    const num = String(idx + 1).padStart(2, '0');
                    const posterPath = String(it?.poster_path || '').trim();
                    const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w342${posterPath.startsWith('/') ? posterPath : `/${posterPath}`}` : '';
                    const ratingRaw = it?.tmdb_rating ?? it?.vote_average ?? null;
                    const ratingPct = (typeof ratingRaw === 'number' && Number.isFinite(ratingRaw)) ? ratingRaw * 10 : null;
                    const ratingText = ratingPct !== null ? formatPctForDisplay(ratingPct) : '';
                    const mpa = String(it?.mpa_rating || '').trim();
                    return `
                        <div class="glass-panel" style="padding: 0.85rem; border-radius: 0.85rem; display:grid; gap: 10px;">
                            <div style="display:flex; gap: 12px; align-items: center;">
                                <div style="width: 54px; height: 78px; border-radius: 0.75rem; overflow:hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); flex: 0 0 auto;">
                                    ${posterUrl
                                        ? `<img src="${posterUrl}" loading="lazy" decoding="async" alt="${escapeHtml(title)}" style="width:100%; height:100%; object-fit: cover; display:block;" onerror="this.style.display='none';">`
                                        : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No poster</div>`}
                                </div>
                                <div style="min-width:0;">
                                    <div class="text-white font-bold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${num}. ${escapeHtml(title)}${yearVal ? ` <span style=\"color: rgba(255,255,255,0.65); font-weight: 800;\">(${escapeHtml(yearVal)})</span>` : ''}</div>
                                    <div class="text-xs text-gray" style="margin-top: 0.2rem; display:flex; gap: 10px; flex-wrap: wrap;">
                                        ${ratingText ? `<span>TMDb: <span class=\"text-white\">${escapeHtml(ratingText)}</span></span>` : ''}
                                        ${mpa ? `<span>MPA: <span class=\"text-white\">${escapeHtml(mpa)}</span></span>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${reason ? `<div class="text-xs text-gray">${escapeHtml(reason)}</div>` : ''}
                        </div>
                    `;
                }).join('')
                : '<div class="text-gray">No results yet.</div>';
        }

        function parseCommaList(value) {
            return String(value || '')
                .split(',')
                .map((s) => String(s || '').trim())
                .filter(Boolean);
        }

        function updateAiPromptCounter() {
            const input = document.getElementById('ai-prompt-input');
            const remainingEl = document.getElementById('ai-prompt-remaining');
            if (!input || !remainingEl) return;
            const max = 2000;
            const used = String(input.value || '').length;
            const remaining = Math.max(0, max - used);
            remainingEl.textContent = `${remaining} characters remaining`;
        }

        function setAiGenreButtonState(btn, isOn) {
            if (!btn) return;
            btn.classList.toggle('is-selected', isOn);
            btn.classList.toggle('btn-glass', isOn);
            btn.classList.toggle('btn-outline', !isOn);
            btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
            if (isOn) {
                btn.style.backgroundColor = 'color-mix(in srgb, var(--brand-2) 20%, rgba(255,255,255,0.12))';
                btn.style.borderColor = 'color-mix(in srgb, var(--brand) 40%, rgba(255,255,255,0.35))';
                btn.style.boxShadow = '0 0 0 2px color-mix(in srgb, var(--brand) 45%, rgba(255,255,255,0.55)), 0 10px 20px var(--brand-shadow)';
                btn.style.fontWeight = '700';
                btn.style.color = '#ffffff';
            } else {
                btn.style.backgroundColor = '';
                btn.style.borderColor = '';
                btn.style.boxShadow = '';
                btn.style.fontWeight = '';
                btn.style.color = '';
            }
        }

        function setAiProviderButtonState(btn, isOn) {
            if (!btn) return;
            btn.classList.toggle('is-selected', isOn);
            btn.classList.toggle('btn-glass', isOn);
            btn.classList.toggle('btn-outline', !isOn);
            btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
            if (isOn) {
                btn.style.backgroundColor = 'color-mix(in srgb, var(--brand-2) 20%, rgba(255,255,255,0.12))';
                btn.style.borderColor = 'color-mix(in srgb, var(--brand) 40%, rgba(255,255,255,0.35))';
                btn.style.boxShadow = '0 0 0 2px color-mix(in srgb, var(--brand) 45%, rgba(255,255,255,0.55)), 0 10px 20px var(--brand-shadow)';
                btn.style.fontWeight = '700';
                btn.style.color = '#ffffff';
            } else {
                btn.style.backgroundColor = '';
                btn.style.borderColor = '';
                btn.style.boxShadow = '';
                btn.style.fontWeight = '';
                btn.style.color = '';
            }
        }

        function selectAllAiProviders() {
            document.querySelectorAll('.ai-provider-btn').forEach((btn) => {
                setAiProviderButtonState(btn, true);
            });
        }

        function getAiSelectedGenres(role) {
            const list = [];
            document.querySelectorAll(`[data-ai-genre-role="${role}"][data-genre]`).forEach((btn) => {
                if (btn.classList.contains('is-selected')) {
                    const g = String(btn.getAttribute('data-genre') || '').trim();
                    if (g) list.push(g);
                }
            });
            return list;
        }

        function toggleAiGenreSelection(btn) {
            const genre = String(btn?.getAttribute('data-genre') || '').trim();
            if (!genre) return;
            const isOn = btn.classList.contains('is-selected');
            setAiGenreButtonState(btn, !isOn);
        }

        function getAiSelectedProviders() {
            const list = [];
            document.querySelectorAll('[data-ai-provider]').forEach((btn) => {
                if (btn.classList.contains('is-selected')) {
                    const name = String(btn.getAttribute('data-ai-provider') || '').trim();
                    if (name) list.push(name);
                }
            });
            return list;
        }

        function toggleAiProviderSelection(btn) {
            const name = String(btn?.getAttribute('data-ai-provider') || '').trim();
            if (!name) return;
            const isOn = btn.classList.contains('is-selected');
            setAiProviderButtonState(btn, !isOn);
        }

        let aiSimilarSearchItems = [];
        let aiSimilarAbortController = null;
        let aiSimilarDebounceTimer = null;
        let aiSimilarSelected = [];
        const MAX_SIMILAR_MOVIES = 5;

        function setAiSimilarSelected(list) {
            aiSimilarSelected = Array.isArray(list) ? list : [];
            const hidden = document.getElementById('ai-similar-tmdb-id');
            if (hidden) hidden.value = aiSimilarSelected.map((m) => String(m.tmdb_id)).join(',');

            const wrap = document.getElementById('ai-similar-selected');
            if (!wrap) return;
            if (aiSimilarSelected.length === 0) {
                wrap.innerHTML = '';
                return;
            }

            wrap.innerHTML = aiSimilarSelected.map((m) => {
                const title = String(m?.title || '').trim() || 'Untitled';
                const year = m?.year ? String(m.year) : '';
                const label = year ? `${title} (${year})` : title;
                return `
                    <button type="button" class="btn btn-outline" data-ai-similar-remove="${m.tmdb_id}" style="padding: 0.32rem 0.7rem; border-radius: 0.75rem; font-size: 13px; display:inline-flex; gap: 8px; align-items:center;">
                        <span>${escapeHtml(label)}</span>
                        <span style="opacity:0.7;"></span>
                    </button>
                `;
            }).join('');
        }

        function addAiSimilarMovie(movie) {
            if (!movie?.tmdb_id) return;
            const exists = aiSimilarSelected.some((m) => Number(m.tmdb_id) === Number(movie.tmdb_id));
            if (exists) return;
            if (aiSimilarSelected.length >= MAX_SIMILAR_MOVIES) {
                showToast(`You can add up to ${MAX_SIMILAR_MOVIES} similar movies.`, { level: 'warn' });
                return;
            }
            setAiSimilarSelected([...aiSimilarSelected, movie]);
        }

        function removeAiSimilarMovie(tmdbId) {
            const list = aiSimilarSelected.filter((m) => Number(m.tmdb_id) !== Number(tmdbId));
            setAiSimilarSelected(list);
        }

        function clearAiSimilarSelection() {
            setAiSimilarSelected([]);
            const input = document.getElementById('ai-similar-input');
            if (input) input.value = '';
            clearAiSimilarResults();
        }

        function renderAiSimilarResults(items) {
            const results = document.getElementById('ai-similar-results');
            if (!results) return;

            aiSimilarSearchItems = Array.isArray(items) ? items.slice(0, 6) : [];
            if (aiSimilarSearchItems.length === 0) {
                results.innerHTML = `<div class="search-item text-gray justify-center">No movies found</div>`;
                results.classList.remove('hidden');
                return;
            }

            results.innerHTML = aiSimilarSearchItems.map((m, idx) => {
                const title = String(m?.title || '').trim();
                const year = m?.year ? String(m.year) : '';
                const genres = Array.isArray(m?.genres)
                    ? m.genres.map((s) => String(s).trim()).filter(Boolean)
                    : String(m?.genre || '').split(',').map((s) => s.trim()).filter(Boolean);
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w154${posterPath}` : '';
                const metaParts = [year, (genres.length ? genres.join(', ') : '')].filter(Boolean);

                return `
                    <div class="search-item" data-ai-similar-index="${idx}">
                        <div style="display:flex; align-items:center; gap: 0.75rem;">
                            <div style="width: 34px; height: 51px; flex: 0 0 34px; border-radius: 7px; overflow:hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center;">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.style.display='none'; this.parentElement.style.opacity='0.6';">`
                                    : `<div style="opacity:0.65; color: var(--text-muted); width: 16px; height: 16px; display:flex; align-items:center; justify-content:center;">${icons.film}</div>`
                                }
                            </div>
                            <div>
                                <div class="text-white font-semibold">${escapeHtml(title)}</div>
                                <div class="text-xs text-gray">${escapeHtml(metaParts.join('  '))}</div>
                            </div>
                        </div>
                        <div style="color:var(--text-muted);">${icons.arrowRightCircle}</div>
                    </div>
                `;
            }).join('');
            results.classList.remove('hidden');

            if (!results.dataset.boundClicks) {
                results.dataset.boundClicks = 'true';
                results.addEventListener('click', async (e) => {
                    const btn = e?.target?.closest ? e.target.closest('.search-item[data-ai-similar-index]') : null;
                    if (!btn) return;
                    const idx = Number(btn.getAttribute('data-ai-similar-index'));
                    const picked = aiSimilarSearchItems[idx];
                    if (!picked) return;
                    const tmdb_id = Number(picked?.tmdb_id ?? picked?.tmdbId ?? picked?.id ?? null);
                    let details = null;
                    if (Number.isFinite(tmdb_id) && tmdb_id > 0) {
                        try {
                            details = await callSwiftApiGetMovieDetails({ tmdb_id });
                        } catch (_) {
                            details = null;
                        }
                    }

                    const overview = String(details?.overview || '').trim();
                    const runtimeRaw = Number(details?.runtime ?? 0);
                    const runtime = Number.isFinite(runtimeRaw) ? Math.round(runtimeRaw) : 0;
                    const mpaRating = String(details?.mpa ?? details?.mpa_rating ?? '').trim();

                    const yearRaw = Number(picked?.year ?? picked?.release_year ?? 0);
                    const year = Number.isFinite(yearRaw) ? Math.max(0, Math.floor(yearRaw)) : 0;

                    addAiSimilarMovie({
                        tmdb_id: Number.isFinite(tmdb_id) ? tmdb_id : 0,
                        title: String(picked?.title || '').trim(),
                        year,
                        genres: Array.isArray(picked?.genres)
                            ? picked.genres
                            : String(picked?.genre || '').split(',').map((s) => s.trim()).filter(Boolean),
                        mpa_rating: mpaRating,
                        runtime,
                        overview,
                    });
                    const input = document.getElementById('ai-similar-input');
                    if (input) input.value = '';
                    results.classList.add('hidden');
                    results.innerHTML = '';
                });
            }
        }

        function clearAiSimilarResults() {
            const results = document.getElementById('ai-similar-results');
            if (results) {
                results.classList.add('hidden');
                results.innerHTML = '';
            }
            aiSimilarSearchItems = [];
        }

        function handleAiSimilarSearch(query, opts = {}) {
            const inputEl = document.getElementById('ai-similar-input');
            const results = document.getElementById('ai-similar-results');
            if (!inputEl || !results) return;

            const q = String(query || '').trim();
            if (!q || q.length < 1) {
                if (aiSimilarDebounceTimer) clearTimeout(aiSimilarDebounceTimer);
                if (aiSimilarAbortController) aiSimilarAbortController.abort();
                clearAiSimilarResults();
                return;
            }

            if (aiSimilarDebounceTimer) clearTimeout(aiSimilarDebounceTimer);
            if (aiSimilarAbortController) aiSimilarAbortController.abort();
            aiSimilarAbortController = new AbortController();

            if (q.length < 3) {
                results.classList.add('hidden');
                aiSimilarSearchItems = [];
                return;
            }

            const debounceMs = opts?.force ? 0 : 320;
            aiSimilarDebounceTimer = setTimeout(async () => {
                try {
                    const data = await callSwiftApiPublic({ action: 'search', query: q, page: 1, limit: 6 }, { signal: aiSimilarAbortController.signal });
                    const items = Array.isArray(data?.results) ? data.results : [];
                    renderAiSimilarResults(items);
                } catch (err) {
                    if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                    results.innerHTML = `<div class="search-item text-gray justify-center">Search failed</div>`;
                    results.classList.remove('hidden');
                }
            }, debounceMs);
        }

        function getAiSimilarMovie() {
            return Array.isArray(aiSimilarSelected) ? aiSimilarSelected.filter((m) => m?.tmdb_id) : [];
        }

        function hasAiFiltersSet(filters) {
            const f = filters || {};
            const rating = Number(f.tmdb_rating_min ?? 0);
            const yrFrom = Number(f.release_year_from ?? 0);
            const yrTo = Number(f.release_year_to ?? 0);
            const hasRating = Number.isFinite(rating) && rating > 0;
            const hasYear = (Number.isFinite(yrFrom) && yrFrom > 1800) || (Number.isFinite(yrTo) && yrTo > 1800);
            const hasGenres = Array.isArray(f.genres_include) && f.genres_include.length > 0;
            const hasProviders = Array.isArray(f.watch_providers) && f.watch_providers.length > 0;
            return hasRating || hasYear || hasGenres || hasProviders;
        }

        function areAiFiltersComplete(filters) {
            const f = filters || {};
            const rating = Number(f.tmdb_rating_min ?? 0);
            const yrFrom = Number(f.release_year_from ?? 0);
            const yrTo = Number(f.release_year_to ?? 0);
            const hasRating = Number.isFinite(rating) && rating > 0;
            const hasYearFrom = Number.isFinite(yrFrom) && yrFrom > 1800;
            const hasYearTo = Number.isFinite(yrTo) && yrTo > 1800;
            const hasGenres = Array.isArray(f.genres_include) && f.genres_include.length > 0;
            const hasProviders = Array.isArray(f.watch_providers) && f.watch_providers.length > 0;
            return hasRating && hasYearFrom && hasYearTo && hasGenres && hasProviders;
        }

        function getAiFilters() {
            const tmdbNum = document.getElementById('ai-filter-tmdb-num');
            const yearFrom = document.getElementById('ai-filter-year-from');
            const yearTo = document.getElementById('ai-filter-year-to');
            const excludeWatched = document.getElementById('ai-filter-exclude-watched');

            const rating = Number(tmdbNum?.value ?? 0);
            const yrFrom = Number(yearFrom?.value ?? 0);
            const yrTo = Number(yearTo?.value ?? 0);

            return {
                tmdb_rating_min: Number.isFinite(rating) ? Math.max(0, Math.min(100, Math.round(rating))) : 0,
                release_year_from: Number.isFinite(yrFrom) && yrFrom > 1800 ? Math.floor(yrFrom) : 0,
                release_year_to: Number.isFinite(yrTo) && yrTo > 1800 ? Math.floor(yrTo) : 0,
                genres_include: getAiSelectedGenres('include'),
                watch_region: 'US',
                watch_providers: getAiSelectedProviders(),
                exclude_watched: Boolean(excludeWatched?.checked),
            };
        }

        function initAiPicksPage() {
            syncAiTmdbRatingFilter();
            showAiResults([]);
            setAiInputsHidden(false);
            setAiLoading(false);
            updateAiPromptCounter();
            clearAiSimilarSelection();
            document.addEventListener('input', (e) => {
                const el = e?.target;
                if (!el || !(el instanceof HTMLElement)) return;
                if (el.id === 'ai-filter-tmdb') {
                    syncAiTmdbRatingFilter();
                }
                if (el.id === 'ai-filter-tmdb-num' && el instanceof HTMLInputElement) {
                    const v = Number(el.value);
                    const n = Number.isFinite(v) ? Math.max(0, Math.min(100, v)) : 0;
                    const range = document.getElementById('ai-filter-tmdb');
                    if (range) range.value = String(n);
                    el.value = String(n);
                }
                if (el.id === 'ai-prompt-input') {
                    updateAiPromptCounter();
                }
                if (el.id === 'ai-similar-input') {
                    handleAiSimilarSearch(el.value || '');
                }
            });

            document.addEventListener('click', (e) => {
                const genreBtn = e?.target?.closest ? e.target.closest('.ai-genre-btn') : null;
                if (genreBtn) {
                    toggleAiGenreSelection(genreBtn);
                    return;
                }
                const providerBtn = e?.target?.closest ? e.target.closest('.ai-provider-btn') : null;
                if (providerBtn) {
                    toggleAiProviderSelection(providerBtn);
                    return;
                }
                const clearSimilar = e?.target?.closest ? e.target.closest('#ai-similar-clear') : null;
                if (clearSimilar) {
                    clearAiSimilarSelection();
                    return;
                }
                const removeSimilar = e?.target?.closest ? e.target.closest('[data-ai-similar-remove]') : null;
                if (removeSimilar) {
                    const id = removeSimilar.getAttribute('data-ai-similar-remove');
                    if (id) removeAiSimilarMovie(id);
                    return;
                }
            });

            document.addEventListener('click', (e) => {
                const gen = e?.target?.closest ? e.target.closest('#ai-generate-btn') : null;
                if (gen) {
                    const promptEl = document.getElementById('ai-prompt-input');
                    const prompt = String(promptEl?.value || '').trim();
                    if (!prompt) {
                        showToast('Please enter a prompt first.', { level: 'warn' });
                        return;
                    }

                    const filters = getAiFilters();
                    const similarMovies = getAiSimilarMovie();
                    const hasCompleteFilters = areAiFiltersComplete(filters);
                    if (!similarMovies.length && !hasCompleteFilters) {
                        showToast('Please either fill out all filters or select a similar movie.', { level: 'warn' });
                        return;
                    }

                    const debugToggle = document.getElementById('ai-debug-toggle');
                    const debug = Boolean(debugToggle?.checked);

                    showAiResults([]);
                    setAiInputsHidden(true);
                    setAiLoading(true);

                    (async () => {
                        try {
                            try {
                                const { user, accessToken } = await requireAuthOrThrow();
                                await fetch('https://dbxhaseoxpnmzdxbzdpj.supabase.co/functions/v1/swift-responder', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'apikey': SUPABASE_KEY,
                                        'Authorization': `Bearer ${accessToken}`,
                                    },
                                    body: JSON.stringify({ user_id: user.id })
                                });
                            } catch (_) {
                                // Best-effort; do not block AI picks.
                            }

                            const payload = {
                                action: 'ai_picks',
                                mode: similarMovies.length ? 'similar_movie' : 'filters',
                                prompt,
                                filters,
                                similar_movie: similarMovies,
                                taste_profile: {
                                    top_genres: [],
                                    avg_rating_by_genre: {},
                                    favorite_actors: [],
                                    favorite_directors: [],
                                },
                                debug,
                            };
                            const data = await callSwiftApiPublic(payload);
                            const items = Array.isArray(data?.top5) ? data.top5 : (Array.isArray(data?.top10) ? data.top10 : []);
                            if (debug && data?.debug) {
                                try {
                                    addMessageToLog('info', 'AI Picks Debug', JSON.stringify(data.debug, null, 2));
                                    setLogPanelOpen(true);
                                } catch (_) {}
                            }
                            setAiLoading(false);
                            showAiResults(items);
                        } catch (err) {
                            const msg = String(err?.message || err);
                            setAiLoading(false);
                            setAiInputsHidden(false);
                            showAiResults([]);
                            showToast(`AI picks failed: ${msg}`, { level: 'warn' });
                        }
                    })();
                    return;
                }

                const clear = e?.target?.closest ? e.target.closest('#ai-clear-btn') : null;
                if (clear) {
                    setAiLoading(false);
                    setAiInputsHidden(false);
                    showAiResults([]);
                    clearAiSimilarSelection();
                }
            });
        }

        let themeCreatorBackdropSearchItems = [];
        let themeCreatorBackdropSearchDebounceTimer = null;
        let themeCreatorBackdropSearchAbortController = null;
        let themeCreatorBackdropAbortController = null;
        let themeCreatorAiSearchItems = [];
        let themeCreatorAiSearchDebounceTimer = null;
        let themeCreatorAiSearchAbortController = null;
        let themeCreatorBackdrops = [];
        let themeCreatorExisting = [];
        let themeCreatorSelected = [];
        let themeCreatorBackdropMovie = null;
        let themeCreatorAiMovie = null;
        let themeCreatorStep = 1;
        let themeCreatorMode = 'create';
        let themeCreatorActiveThemeId = null;
        let themeCreatorActiveThemeName = '';
        let themeCreatorBound = false;
        let themeCreatorBackdropDropdownDocked = false;
        let themeCreatorBackdropDropdownParent = null;
        let themeCreatorAiDropdownDocked = false;
        let themeCreatorAiDropdownParent = null;

        function buildThemeCreatorOptions(options, selected) {
            const selectedVal = String(selected || '').trim();
            return options
                .map((opt) => {
                    const val = String(opt.value || '').trim();
                    const label = String(opt.label || '').trim() || val;
                    const isSelected = val && val === selectedVal;
                    return `<option value="${escapeHtml(val)}"${isSelected ? ' selected' : ''}>${escapeHtml(label)}</option>`;
                })
                .join('');
        }

        function buildThemeCreatorBackdropUrl(filePath, size = 'w780') {
            const path = String(filePath || '').trim();
            if (!path) return '';
            return `https://image.tmdb.org/t/p/${size}${path.startsWith('/') ? path : `/${path}`}`;
        }

        function setThemeCreatorStatus(message) {
            const el = document.getElementById('theme-creator-status');
            if (el) el.textContent = String(message || '').trim();
        }

        function setThemeCreatorCount() {
            const el = document.getElementById('theme-creator-count');
            if (!el) return;
            el.textContent = `${themeCreatorSelected.length} / 6 selected`;
        }

        function renderThemeCreatorExistingBackdrops() {
            if (!themeCreatorExisting.length) return '';
            const cards = themeCreatorExisting.map((item, idx) => {
                const imgUrl = String(item?.url || '').trim();
                const pageVal = String(item?.page || '').trim();
                const name = String(item?.name || '').trim();
                return `
                    <div class="glass-panel" style="padding: 0.6rem; border-radius: 0.8rem; display:grid; gap: 8px;">
                        <div style="width: 100%; aspect-ratio: 16 / 9; border-radius: 0.7rem; overflow: hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);">
                            ${imgUrl
                                ? `<img src="${imgUrl}" alt="Theme backdrop" loading="lazy" decoding="async" style="width:100%; height:100%; object-fit: cover; display:block;">`
                                : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No image</div>`
                            }
                        </div>
                        <div class="text-xs text-gray" style="word-break: break-all;">${escapeHtml(name || '')}</div>
                        <div style="display:grid; gap: 6px;">
                            <label class="text-xs text-gray">Page</label>
                            <select class="input-field" data-theme-existing-select="page" data-theme-existing-index="${idx}">
                                ${buildThemeCreatorOptions(THEME_CREATOR_PAGES, pageVal)}
                            </select>
                        </div>
                        <button type="button" class="btn btn-outline" data-theme-existing-remove="${idx}" style="padding: 0.35rem 0.6rem; border-radius: 0.7rem;">Remove</button>
                    </div>
                `;
            }).join('');

            return `
                <div style="display:grid; gap: 10px;">
                    <div class="text-xs text-gray">Current theme backdrops</div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">${cards}</div>
                </div>
            `;
        }

        function renderThemeCreatorBackdropSearchResults(items) {
            const results = document.getElementById('theme-creator-search-results');
            if (!results) return;

            themeCreatorBackdropSearchItems = Array.isArray(items) ? items.slice(0, 6) : [];
            if (themeCreatorBackdropSearchItems.length === 0) {
                results.innerHTML = `<div class="search-item text-gray justify-center">No movies found</div>`;
                results.classList.remove('hidden');
                return;
            }

            results.innerHTML = themeCreatorBackdropSearchItems.map((m, idx) => {
                const title = String(m?.title || '').trim();
                const year = m?.year ? String(m.year) : '';
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w154${posterPath}` : '';
                const metaParts = [year].filter(Boolean);

                return `
                    <div class="search-item" data-theme-creator-idx="${idx}">
                        <div style="display:flex; align-items:center; gap: 0.75rem;">
                            <div style="width: 34px; height: 51px; flex: 0 0 34px; border-radius: 7px; overflow:hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center;">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.style.display='none'; this.parentElement.style.opacity='0.6';">`
                                    : `<div style="opacity:0.65; color: var(--text-muted); width: 16px; height: 16px; display:flex; align-items:center; justify-content:center;">${icons.film}</div>`
                                }
                            </div>
                            <div>
                                <div class="text-white font-semibold">${escapeHtml(title)}</div>
                                <div class="text-xs text-gray">${escapeHtml(metaParts.join('  '))}</div>
                            </div>
                        </div>
                        <div style="color:var(--text-muted);">${icons.arrowRightCircle}</div>
                    </div>
                `;
            }).join('');
            results.classList.remove('hidden');
            dockThemeCreatorBackdropDropdown();

            if (!results.dataset.boundClicks) {
                results.dataset.boundClicks = 'true';
                results.addEventListener('click', (e) => {
                    const row = e?.target?.closest ? e.target.closest('.search-item[data-theme-creator-idx]') : null;
                    if (!row) return;
                    const idx = Number(row.getAttribute('data-theme-creator-idx'));
                    const picked = Number.isFinite(idx) ? themeCreatorBackdropSearchItems[idx] : null;
                    if (!picked) return;

                    const tmdb_id = Number(picked?.tmdb_id ?? picked?.tmdbId ?? picked?.id ?? null);
                    const title = String(picked?.title || '').trim();
                    const year = picked?.year ? String(picked.year) : '';
                    if (!Number.isFinite(tmdb_id) || tmdb_id <= 0) return;

                    themeCreatorBackdropMovie = { tmdb_id, title, year };
                    const label = `${title}${year ? ` (${year})` : ''}`;
                    const movieEl = document.getElementById('theme-creator-selected-movie');
                    if (movieEl) movieEl.textContent = `Last backdrop movie: ${label}`;

                    const input = document.getElementById('theme-creator-search-input');
                    if (input) input.value = '';
                    results.classList.add('hidden');
                    results.innerHTML = '';
                    undockThemeCreatorBackdropDropdown();

                    loadThemeCreatorBackdrops(tmdb_id).catch(() => null);
                });
            }
        }

        function renderThemeCreatorAiSearchResults(items) {
            const results = document.getElementById('theme-creator-ai-search-results');
            if (!results) return;

            themeCreatorAiSearchItems = Array.isArray(items) ? items.slice(0, 6) : [];
            if (themeCreatorAiSearchItems.length === 0) {
                results.innerHTML = `<div class="search-item text-gray justify-center">No movies found</div>`;
                results.classList.remove('hidden');
                return;
            }

            results.innerHTML = themeCreatorAiSearchItems.map((m, idx) => {
                const title = String(m?.title || '').trim();
                const year = m?.year ? String(m.year) : '';
                const posterPath = String(m?.poster_path || '').trim();
                const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w154${posterPath}` : '';
                const metaParts = [year].filter(Boolean);

                return `
                    <div class="search-item" data-theme-creator-ai-idx="${idx}">
                        <div style="display:flex; align-items:center; gap: 0.75rem;">
                            <div style="width: 34px; height: 51px; flex: 0 0 34px; border-radius: 7px; overflow:hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center;">
                                ${posterUrl
                                    ? `<img src="${posterUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover; display:block;" onerror="this.style.display='none'; this.parentElement.style.opacity='0.6';">`
                                    : `<div style="opacity:0.65; color: var(--text-muted); width: 16px; height: 16px; display:flex; align-items:center; justify-content:center;">${icons.film}</div>`
                                }
                            </div>
                            <div>
                                <div class="text-white font-semibold">${escapeHtml(title)}</div>
                                <div class="text-xs text-gray">${escapeHtml(metaParts.join('  '))}</div>
                            </div>
                        </div>
                        <div style="color:var(--text-muted);">${icons.arrowRightCircle}</div>
                    </div>
                `;
            }).join('');
            results.classList.remove('hidden');
            dockThemeCreatorAiDropdown();

            if (!results.dataset.boundClicks) {
                results.dataset.boundClicks = 'true';
                results.addEventListener('click', (e) => {
                    const row = e?.target?.closest ? e.target.closest('.search-item[data-theme-creator-ai-idx]') : null;
                    if (!row) return;
                    const idx = Number(row.getAttribute('data-theme-creator-ai-idx'));
                    const picked = Number.isFinite(idx) ? themeCreatorAiSearchItems[idx] : null;
                    if (!picked) return;

                    const tmdb_id = Number(picked?.tmdb_id ?? picked?.tmdbId ?? picked?.id ?? null);
                    const title = String(picked?.title || '').trim();
                    const year = picked?.year ? String(picked.year) : '';
                    if (!Number.isFinite(tmdb_id) || tmdb_id <= 0) return;

                    themeCreatorAiMovie = { tmdb_id, title, year };
                    const label = `${title}${year ? ` (${year})` : ''}`;
                    const movieEl = document.getElementById('theme-creator-ai-selected-movie');
                    if (movieEl) movieEl.textContent = label;

                    const input = document.getElementById('theme-creator-ai-search-input');
                    if (input) input.value = '';
                    results.classList.add('hidden');
                    results.innerHTML = '';
                    undockThemeCreatorAiDropdown();
                });
            }
        }

        function clearThemeCreatorBackdropSearchUI() {
            const results = document.getElementById('theme-creator-search-results');
            if (results) results.classList.add('hidden');
            undockThemeCreatorBackdropDropdown();
            themeCreatorBackdropSearchItems = [];
        }

        function clearThemeCreatorAiSearchUI() {
            const results = document.getElementById('theme-creator-ai-search-results');
            if (results) results.classList.add('hidden');
            undockThemeCreatorAiDropdown();
            themeCreatorAiSearchItems = [];
        }

        function dockThemeCreatorBackdropDropdown() {
            const input = document.getElementById('theme-creator-search-input');
            const results = document.getElementById('theme-creator-search-results');
            if (!input || !results) return;

            if (!themeCreatorBackdropDropdownDocked) {
                themeCreatorBackdropDropdownParent = results.parentElement;
                document.body.appendChild(results);
                themeCreatorBackdropDropdownDocked = true;
            }

            const rect = input.getBoundingClientRect();
            results.style.position = 'fixed';
            results.style.top = `${Math.round(rect.bottom + 8)}px`;
            results.style.left = `${Math.round(rect.left)}px`;
            results.style.width = `${Math.round(rect.width)}px`;
            results.style.zIndex = '20000';
        }

        function undockThemeCreatorBackdropDropdown() {
            const results = document.getElementById('theme-creator-search-results');
            if (!results) return;
            if (themeCreatorBackdropDropdownDocked && themeCreatorBackdropDropdownParent) {
                themeCreatorBackdropDropdownParent.appendChild(results);
            }
            themeCreatorBackdropDropdownDocked = false;
            themeCreatorBackdropDropdownParent = null;
            results.style.position = '';
            results.style.top = '';
            results.style.left = '';
            results.style.width = '';
            results.style.zIndex = '';
        }

        function dockThemeCreatorAiDropdown() {
            const input = document.getElementById('theme-creator-ai-search-input');
            const results = document.getElementById('theme-creator-ai-search-results');
            if (!input || !results) return;

            if (!themeCreatorAiDropdownDocked) {
                themeCreatorAiDropdownParent = results.parentElement;
                document.body.appendChild(results);
                themeCreatorAiDropdownDocked = true;
            }

            const rect = input.getBoundingClientRect();
            results.style.position = 'fixed';
            results.style.top = `${Math.round(rect.bottom + 8)}px`;
            results.style.left = `${Math.round(rect.left)}px`;
            results.style.width = `${Math.round(rect.width)}px`;
            results.style.zIndex = '20000';
        }

        function undockThemeCreatorAiDropdown() {
            const results = document.getElementById('theme-creator-ai-search-results');
            if (!results) return;
            if (themeCreatorAiDropdownDocked && themeCreatorAiDropdownParent) {
                themeCreatorAiDropdownParent.appendChild(results);
            }
            themeCreatorAiDropdownDocked = false;
            themeCreatorAiDropdownParent = null;
            results.style.position = '';
            results.style.top = '';
            results.style.left = '';
            results.style.width = '';
            results.style.zIndex = '';
        }

        function renderThemeCreatorBackdrops(items) {
            const wrap = document.getElementById('theme-creator-backdrops');
            if (!wrap) return;

            const safe = Array.isArray(items) ? items : [];
            const existingHtml = themeCreatorMode === 'edit' ? renderThemeCreatorExistingBackdrops() : '';
            const searchHtml = safe.length
                ? safe.map((b, idx) => {
                const filePath = String(b?.file_path || '').trim();
                const vote = Number(b?.vote_average ?? 0);
                const voteText = Number.isFinite(vote) ? vote.toFixed(1) : '';
                const imgUrl = buildThemeCreatorBackdropUrl(filePath, 'w780');
                const isSelected = themeCreatorSelected.some((s) => String(s.file_path) === filePath);
                return `
                    <div class="glass-panel" style="padding: 0.6rem; border-radius: 0.8rem; display:grid; gap: 8px;">
                        <div style="width: 100%; aspect-ratio: 16 / 9; border-radius: 0.7rem; overflow: hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);">
                            ${imgUrl
                                ? `<img src="${imgUrl}" alt="Backdrop" loading="lazy" decoding="async" style="width:100%; height:100%; object-fit: cover; display:block;">`
                                : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No image</div>`
                            }
                        </div>
                        <div style="display:flex; justify-content: space-between; align-items: center; gap: 8px;">
                            <div class="text-xs text-gray">${voteText ? `Rating ${escapeHtml(voteText)}` : 'Unrated'}</div>
                            <button type="button" class="btn ${isSelected ? 'btn-glass' : 'btn-outline'}" data-theme-creator-backdrop="${idx}" style="padding: 0.35rem 0.6rem; border-radius: 0.7rem;">${isSelected ? 'Selected' : 'Select'}</button>
                        </div>
                    </div>
                `;
            }).join('')
                : '';

            if (!existingHtml && !searchHtml) {
                wrap.innerHTML = `<div class="text-gray">No backdrops found.</div>`;
                return;
            }

            const searchSection = searchHtml
                ? `
                    <div style="display:grid; gap: 10px; margin-top: ${existingHtml ? '12px' : '0'};">
                        <div class="text-xs text-gray">Search results</div>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">${searchHtml}</div>
                    </div>
                `
                : '';

            wrap.innerHTML = `${existingHtml}${searchSection}`;
        }

        async function loadThemeCreatorExistingBackdrops(themeId) {
            if (!supabaseClient || !themeId) {
                themeCreatorExisting = [];
                renderThemeCreatorBackdrops(themeCreatorBackdrops);
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('Background Images')
                    .select('id, name, url, page, theme_id')
                    .eq('theme_id', themeId)
                    .order('created_at', { ascending: false });
                if (error) throw error;
                themeCreatorExisting = Array.isArray(data) ? data : [];
            } catch (err) {
                themeCreatorExisting = [];
                showToast(`Theme backdrops failed: ${String(err?.message || err)}`, { level: 'warn' });
            }

            renderThemeCreatorBackdrops(themeCreatorBackdrops);
        }

        async function updateThemeCreatorExistingPage(idx, pageVal) {
            const row = themeCreatorExisting[idx] || null;
            if (!row || !supabaseClient) return;
            const page = String(pageVal || '').trim();
            if (!page) return;

            try {
                const { error } = await supabaseClient
                    .from('Background Images')
                    .update({ page })
                    .eq('id', row.id);
                if (error) throw error;
                themeCreatorExisting = themeCreatorExisting.map((item, i) => (i === idx ? { ...item, page } : item));
                showToast('Page updated.', { level: 'success' });
            } catch (err) {
                showToast(`Page update failed: ${String(err?.message || err)}`, { level: 'warn' });
            }
        }

        async function deleteThemeCreatorExistingBackdrop(idx) {
            const row = themeCreatorExisting[idx] || null;
            if (!row || !supabaseClient) return;
            const name = String(row?.name || '').trim();

            try {
                if (name) {
                    const { error: storageErr } = await supabaseClient
                        .storage
                        .from('Background Images')
                        .remove([name]);
                    if (storageErr) throw storageErr;
                }

                const { error } = await supabaseClient
                    .from('Background Images')
                    .delete()
                    .eq('id', row.id);
                if (error) throw error;

                themeCreatorExisting = themeCreatorExisting.filter((_, i) => i !== idx);
                renderThemeCreatorBackdrops(themeCreatorBackdrops);
                showToast('Backdrop removed.', { level: 'success' });
            } catch (err) {
                showToast(`Remove failed: ${String(err?.message || err)}`, { level: 'warn' });
            }
        }

        async function deleteThemeCreatorTheme() {
            if (!supabaseClient || !themeCreatorActiveThemeId) return;
            const name = themeCreatorActiveThemeName || 'this theme';
            const ok = window.confirm(`Delete ${name} and all its backdrops? This cannot be undone.`);
            if (!ok) return;

            try {
                const { data, error } = await supabaseClient
                    .from('Background Images')
                    .select('id, name')
                    .eq('theme_id', themeCreatorActiveThemeId);
                if (error) throw error;

                const rows = Array.isArray(data) ? data : [];
                const names = rows.map((r) => String(r?.name || '').trim()).filter(Boolean);

                if (names.length) {
                    const { error: storageErr } = await supabaseClient
                        .storage
                        .from('Background Images')
                        .remove(names);
                    if (storageErr) throw storageErr;
                }

                if (rows.length) {
                    const ids = rows.map((r) => r.id).filter(Boolean);
                    const { error: delErr } = await supabaseClient
                        .from('Background Images')
                        .delete()
                        .in('id', ids);
                    if (delErr) throw delErr;
                }

                const { error: themeErr } = await supabaseClient
                    .from('Themes')
                    .delete()
                    .eq('id', themeCreatorActiveThemeId);
                if (themeErr) throw themeErr;

                themeCreatorActiveThemeId = null;
                themeCreatorActiveThemeName = '';
                themeCreatorExisting = [];
                themeCreatorSelected = [];
                loadThemeOptions().catch(() => null);
                renderThemeCreatorSelected();
                renderThemeCreatorBackdrops(themeCreatorBackdrops);
                setThemeCreatorMode('create');
                setThemeCreatorThemeStatus('Theme deleted.', 'success');
                showToast('Theme deleted.', { level: 'success' });
            } catch (err) {
                showToast(`Theme delete failed: ${String(err?.message || err)}`, { level: 'warn' });
            }
        }

        function renderThemeCreatorSelected() {
            const wrap = document.getElementById('theme-creator-selected');
            if (!wrap) return;

            setThemeCreatorCount();

            if (themeCreatorSelected.length === 0) {
                wrap.innerHTML = `<div class="text-gray">No images selected yet.</div>`;
                return;
            }

            wrap.innerHTML = themeCreatorSelected.map((item, idx) => {
                const filePath = String(item?.file_path || '').trim();
                const imgUrl = buildThemeCreatorBackdropUrl(filePath, 'w780');
                const pageVal = String(item?.page || '').trim();
                const themeName = String(themeCreatorActiveThemeName || '').trim();
                return `
                    <div class="glass-panel" style="padding: 0.6rem; border-radius: 0.8rem; display:grid; gap: 8px;">
                        <div style="width: 100%; aspect-ratio: 16 / 9; border-radius: 0.7rem; overflow: hidden; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);">
                            ${imgUrl
                                ? `<img src="${imgUrl}" alt="Selected backdrop" loading="lazy" decoding="async" style="width:100%; height:100%; object-fit: cover; display:block;">`
                                : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size: 12px;">No image</div>`
                            }
                        </div>
                        <div class="text-xs text-gray">Theme: ${escapeHtml(themeName || 'None')}</div>
                        <div style="display:grid; gap: 6px;">
                            <label class="text-xs text-gray">Page</label>
                            <select class="input-field" data-theme-creator-select="page" data-theme-creator-index="${idx}">
                                ${buildThemeCreatorOptions(THEME_CREATOR_PAGES, pageVal)}
                            </select>
                        </div>
                        <button type="button" class="btn btn-outline" data-theme-creator-remove="${idx}" style="padding: 0.35rem 0.6rem; border-radius: 0.7rem;">Remove</button>
                    </div>
                `;
            }).join('');
        }

        function addThemeCreatorSelection(backdrop) {
            if (themeCreatorSelected.length >= 6) {
                showToast('You can select up to 6 images.', { level: 'warn' });
                return;
            }
            const filePath = String(backdrop?.file_path || '').trim();
            if (!filePath) return;
            const exists = themeCreatorSelected.some((s) => String(s.file_path) === filePath);
            if (exists) return;

            const defaultPage = THEME_CREATOR_PAGES[0]?.value || '';
            const tmdbId = Number(themeCreatorBackdropMovie?.tmdb_id ?? null);

            themeCreatorSelected = [
                ...themeCreatorSelected,
                {
                    file_path: filePath,
                    vote_average: Number(backdrop?.vote_average ?? 0) || 0,
                    page: defaultPage,
                    tmdb_id: Number.isFinite(tmdbId) ? tmdbId : null,
                },
            ];
            renderThemeCreatorSelected();
            renderThemeCreatorBackdrops(themeCreatorBackdrops);
        }

        function removeThemeCreatorSelection(idx) {
            themeCreatorSelected = themeCreatorSelected.filter((_, i) => i !== idx);
            renderThemeCreatorSelected();
            renderThemeCreatorBackdrops(themeCreatorBackdrops);
        }

        async function loadThemeCreatorBackdrops(tmdbId) {
            const wrap = document.getElementById('theme-creator-backdrops');
            if (wrap) {
                wrap.innerHTML = `<div class="text-gray">Loading backdrops</div>`;
            }
            setThemeCreatorStatus('');

            if (themeCreatorBackdropAbortController) themeCreatorBackdropAbortController.abort();
            themeCreatorBackdropAbortController = new AbortController();

            try {
                const data = await callSwiftApiPublic(
                    { action: 'backdrops', tmdb_id: tmdbId },
                    { signal: themeCreatorBackdropAbortController.signal }
                );
                const items = Array.isArray(data?.backdrops) ? data.backdrops : [];
                themeCreatorBackdrops = items;
                renderThemeCreatorBackdrops(items);
            } catch (err) {
                if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                if (wrap) wrap.innerHTML = `<div class="text-gray">Backdrops unavailable.</div>`;
                showToast(`Backdrops failed: ${String(err?.message || err)}`, { level: 'warn' });
            }
        }

        function handleThemeCreatorBackdropSearch(query, opts = {}) {
            const inputEl = document.getElementById('theme-creator-search-input');
            const results = document.getElementById('theme-creator-search-results');
            if (!inputEl || !results) return;

            const q = String(query || '').trim();
            if (!q || q.length < 1) {
                if (themeCreatorBackdropSearchDebounceTimer) clearTimeout(themeCreatorBackdropSearchDebounceTimer);
                if (themeCreatorBackdropSearchAbortController) themeCreatorBackdropSearchAbortController.abort();
                clearThemeCreatorBackdropSearchUI();
                return;
            }

            if (themeCreatorBackdropSearchDebounceTimer) clearTimeout(themeCreatorBackdropSearchDebounceTimer);
            if (themeCreatorBackdropSearchAbortController) themeCreatorBackdropSearchAbortController.abort();
            themeCreatorBackdropSearchAbortController = new AbortController();

            if (q.length < 3) {
                results.classList.add('hidden');
                themeCreatorBackdropSearchItems = [];
                return;
            }

            const debounceMs = opts?.force ? 0 : 320;
            themeCreatorBackdropSearchDebounceTimer = setTimeout(async () => {
                try {
                    results.innerHTML = `
                        <div class="search-item text-gray justify-center" style="gap:0.5rem;">
                            <span class="icon-sm">${icons.loader}</span>
                            Searching
                        </div>
                    `;
                    results.classList.remove('hidden');

                    const data = await callSwiftApiPublic(
                        { action: 'search', query: q, page: 1, limit: 8 },
                        { signal: themeCreatorBackdropSearchAbortController.signal }
                    );
                    const items = Array.isArray(data?.results) ? data.results : [];
                    renderThemeCreatorBackdropSearchResults(items);
                } catch (err) {
                    if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                    results.innerHTML = `<div class="search-item text-gray justify-center">Search unavailable  please try again</div>`;
                    results.classList.remove('hidden');
                }
            }, debounceMs);
        }

        function handleThemeCreatorAiSearch(query, opts = {}) {
            const inputEl = document.getElementById('theme-creator-ai-search-input');
            const results = document.getElementById('theme-creator-ai-search-results');
            if (!inputEl || !results) return;

            const q = String(query || '').trim();
            if (!q || q.length < 1) {
                if (themeCreatorAiSearchDebounceTimer) clearTimeout(themeCreatorAiSearchDebounceTimer);
                if (themeCreatorAiSearchAbortController) themeCreatorAiSearchAbortController.abort();
                clearThemeCreatorAiSearchUI();
                return;
            }

            if (themeCreatorAiSearchDebounceTimer) clearTimeout(themeCreatorAiSearchDebounceTimer);
            if (themeCreatorAiSearchAbortController) themeCreatorAiSearchAbortController.abort();
            themeCreatorAiSearchAbortController = new AbortController();

            if (q.length < 3) {
                results.classList.add('hidden');
                themeCreatorAiSearchItems = [];
                return;
            }

            const debounceMs = opts?.force ? 0 : 320;
            themeCreatorAiSearchDebounceTimer = setTimeout(async () => {
                try {
                    results.innerHTML = `
                        <div class="search-item text-gray justify-center" style="gap:0.5rem;">
                            <span class="icon-sm">${icons.loader}</span>
                            Searching
                        </div>
                    `;
                    results.classList.remove('hidden');

                    const data = await callSwiftApiPublic(
                        { action: 'search', query: q, page: 1, limit: 8 },
                        { signal: themeCreatorAiSearchAbortController.signal }
                    );
                    const items = Array.isArray(data?.results) ? data.results : [];
                    renderThemeCreatorAiSearchResults(items);
                } catch (err) {
                    if (String(err?.name || '').toLowerCase() === 'aborterror') return;
                    results.innerHTML = `<div class="search-item text-gray justify-center">Search unavailable  please try again</div>`;
                    results.classList.remove('hidden');
                }
            }, debounceMs);
        }

        function slugifyThemeCreatorValue(raw) {
            return String(raw || '')
                .trim()
                .toLowerCase()
                .replace(/\s+/g, '')
                .replace(/[^a-z0-9_-]/g, '');
        }

        function getThemeCreatorFileExtension(filePath) {
            const raw = String(filePath || '').trim();
            const dot = raw.lastIndexOf('.');
            if (dot === -1) return '.jpg';
            const ext = raw.slice(dot).toLowerCase();
            return ext.match(/\.jpe?g|\.png|\.webp/) ? ext : '.jpg';
        }

        async function saveThemeCreatorSelections() {
            if (!supabaseClient) {
                showToast('Supabase SDK failed to load.', { level: 'warn' });
                return;
            }

            const selections = Array.isArray(themeCreatorSelected) ? themeCreatorSelected : [];
            if (selections.length === 0) {
                showToast('Select at least one image.', { level: 'warn' });
                return;
            }

            if (!themeCreatorActiveThemeId) {
                showToast('Select or create a theme first.', { level: 'warn' });
                return;
            }

            if (!themeCreatorAiMovie?.tmdb_id) {
                showToast('Pick the AI movie first.', { level: 'warn' });
                return;
            }

            const bad = selections.find((s) => !String(s?.page || '').trim());
            if (bad) {
                showToast('Assign a page for each selection.', { level: 'warn' });
                return;
            }

            const missingTmdb = selections.find((s) => !Number.isFinite(Number(s?.tmdb_id)));
            if (missingTmdb) {
                showToast('Each backdrop needs a source movie. Search and select backdrops again.', { level: 'warn' });
                return;
            }

            const btn = document.getElementById('theme-creator-save');
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = 0.7;
            }

            setThemeCreatorStatus('Uploading images');

            try {
                let uploaded = 0;

                for (let i = 0; i < selections.length; i += 1) {
                    const s = selections[i];
                    const filePath = String(s?.file_path || '').trim();
                    if (!filePath) continue;
                    const tmdbId = Number(s?.tmdb_id ?? null);
                    if (!Number.isFinite(tmdbId) || tmdbId <= 0) continue;
                    const pageSlug = slugifyThemeCreatorValue(s.page);
                    const ext = getThemeCreatorFileExtension(filePath);
                    const objectName = `${themeCreatorActiveThemeId}__${pageSlug}__${tmdbId}__${i + 1}${ext}`;
                    const srcUrl = buildThemeCreatorBackdropUrl(filePath, 'w1280');

                    const imgRes = await fetch(srcUrl);
                    if (!imgRes.ok) throw new Error(`Failed to download backdrop (${imgRes.status}).`);
                    const blob = await imgRes.blob();

                    const { error } = await supabaseClient
                        .storage
                        .from('Background Images')
                        .upload(objectName, blob, {
                            upsert: true,
                            contentType: blob.type || 'image/jpeg',
                        });
                    if (error) throw error;

                    uploaded += 1;
                    setThemeCreatorStatus(`Uploaded ${uploaded} of ${selections.length}`);
                }

                setThemeCreatorStatus(`Uploaded ${uploaded} image${uploaded === 1 ? '' : 's'}. Generating colors`);
                showToast('Theme images uploaded!', { level: 'success' });

                const stylePrompt = getThemeCreatorStylePrompt();
                const colorOk = await generateThemeCreatorColors({
                    themeId: themeCreatorActiveThemeId,
                    themeName: themeCreatorActiveThemeName,
                    stylePrompt,
                });

                themeCreatorSelected = [];
                renderThemeCreatorSelected();
                loadThemeBackgroundImages().catch(() => null);
                if (colorOk) {
                    setThemeCreatorStatus('All done.');
                }
            } catch (err) {
                setThemeCreatorStatus('Upload failed.');
                showToast(`Upload failed: ${String(err?.message || err)}`, { level: 'warn' });
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = 1;
                }
            }
        }

        function initThemeCreatorPage() {
            const email = String(cachedAuthUser?.email || '').trim();
            if (!canAccessThemeCreator(email)) {
                showToast('Theme Creator is restricted to this account.', { level: 'warn' });
                router.navigate('account');
                return;
            }

            renderThemeCreatorSelected();
            setThemeCreatorStatus('');
            setThemeCreatorThemeStatus('');
            setThemeCreatorMode('create');
            setThemeCreatorActiveTheme(null);
            themeCreatorBackdropMovie = null;
            themeCreatorAiMovie = null;
            themeCreatorSelected = [];
            themeCreatorBackdrops = [];
            themeCreatorExisting = [];
            setThemeCreatorStep(1);
            loadThemeOptions().catch(() => null);

            const backdropLabel = document.getElementById('theme-creator-selected-movie');
            if (backdropLabel) backdropLabel.textContent = 'No backdrop movie selected yet.';
            const aiLabel = document.getElementById('theme-creator-ai-selected-movie');
            if (aiLabel) aiLabel.textContent = 'No AI movie selected yet.';

            if (themeCreatorBound) return;
            themeCreatorBound = true;

            document.addEventListener('input', (e) => {
                const el = e?.target;
                if (!el || !(el instanceof HTMLElement)) return;
                if (el.id === 'theme-creator-search-input') {
                    handleThemeCreatorBackdropSearch(el.value || '');
                    dockThemeCreatorBackdropDropdown();
                }
                if (el.id === 'theme-creator-ai-search-input') {
                    handleThemeCreatorAiSearch(el.value || '');
                    dockThemeCreatorAiDropdown();
                }
            });

            window.addEventListener('scroll', () => {
                const results = document.getElementById('theme-creator-search-results');
                if (results && !results.classList.contains('hidden')) {
                    dockThemeCreatorBackdropDropdown();
                }
                const aiResults = document.getElementById('theme-creator-ai-search-results');
                if (aiResults && !aiResults.classList.contains('hidden')) {
                    dockThemeCreatorAiDropdown();
                }
            }, true);

            window.addEventListener('resize', () => {
                const results = document.getElementById('theme-creator-search-results');
                if (results && !results.classList.contains('hidden')) {
                    dockThemeCreatorBackdropDropdown();
                }
                const aiResults = document.getElementById('theme-creator-ai-search-results');
                if (aiResults && !aiResults.classList.contains('hidden')) {
                    dockThemeCreatorAiDropdown();
                }
            });

            document.addEventListener('click', (e) => {
                const modeCreateBtn = e?.target?.closest ? e.target.closest('#theme-creator-mode-create') : null;
                if (modeCreateBtn) {
                    setThemeCreatorMode('create');
                    return;
                }

                const modeEditBtn = e?.target?.closest ? e.target.closest('#theme-creator-mode-edit') : null;
                if (modeEditBtn) {
                    setThemeCreatorMode('edit');
                    return;
                }

                const modeContinueBtn = e?.target?.closest ? e.target.closest('#theme-creator-mode-continue') : null;
                if (modeContinueBtn) {
                    setThemeCreatorStep(2);
                    return;
                }

                const themeCreateBtn = e?.target?.closest ? e.target.closest('#theme-creator-create-btn') : null;
                if (themeCreateBtn) {
                    createThemeCreatorTheme({ advance: true }).catch(() => null);
                    return;
                }

                const editContinueBtn = e?.target?.closest ? e.target.closest('#theme-creator-edit-continue') : null;
                if (editContinueBtn) {
                    const select = document.getElementById('theme-creator-edit-select');
                    const themeId = String(select?.value || '').trim();
                    if (!themeId) {
                        setThemeCreatorThemeStatus('Select a theme first.', 'error');
                        return;
                    }
                    setThemeCreatorActiveTheme(themeId);
                    setThemeCreatorStep(3);
                    return;
                }

                const themeUpdateBtn = e?.target?.closest ? e.target.closest('#theme-creator-update-btn') : null;
                if (themeUpdateBtn) {
                    updateThemeCreatorThemeName().catch(() => null);
                    return;
                }

                const themeDeleteBtn = e?.target?.closest ? e.target.closest('#theme-creator-delete-theme') : null;
                if (themeDeleteBtn) {
                    deleteThemeCreatorTheme().catch(() => null);
                    return;
                }

                const selectBtn = e?.target?.closest ? e.target.closest('[data-theme-creator-backdrop]') : null;
                if (selectBtn) {
                    const idx = Number(selectBtn.getAttribute('data-theme-creator-backdrop'));
                    const picked = Number.isFinite(idx) ? themeCreatorBackdrops[idx] : null;
                    if (picked) addThemeCreatorSelection(picked);
                    return;
                }

                const removeBtn = e?.target?.closest ? e.target.closest('[data-theme-creator-remove]') : null;
                if (removeBtn) {
                    const idx = Number(removeBtn.getAttribute('data-theme-creator-remove'));
                    if (Number.isFinite(idx)) removeThemeCreatorSelection(idx);
                    return;
                }

                const existingRemoveBtn = e?.target?.closest ? e.target.closest('[data-theme-existing-remove]') : null;
                if (existingRemoveBtn) {
                    const idx = Number(existingRemoveBtn.getAttribute('data-theme-existing-remove'));
                    if (Number.isFinite(idx)) deleteThemeCreatorExistingBackdrop(idx).catch(() => null);
                    return;
                }

                const clearBtn = e?.target?.closest ? e.target.closest('#theme-creator-clear') : null;
                if (clearBtn) {
                    themeCreatorSelected = [];
                    renderThemeCreatorSelected();
                    renderThemeCreatorBackdrops(themeCreatorBackdrops);
                    setThemeCreatorStatus('');
                    return;
                }

                const backdropsContinueBtn = e?.target?.closest ? e.target.closest('#theme-creator-backdrops-continue') : null;
                if (backdropsContinueBtn) {
                    if (themeCreatorSelected.length === 0) {
                        showToast('Select at least one backdrop.', { level: 'warn' });
                        return;
                    }
                    setThemeCreatorStep(4);
                    return;
                }

                const aiContinueBtn = e?.target?.closest ? e.target.closest('#theme-creator-ai-continue') : null;
                if (aiContinueBtn) {
                    if (!themeCreatorAiMovie?.tmdb_id) {
                        showToast('Select the AI movie first.', { level: 'warn' });
                        return;
                    }
                    setThemeCreatorStep(5);
                    return;
                }

                const saveBtn = e?.target?.closest ? e.target.closest('#theme-creator-save') : null;
                if (saveBtn) {
                    saveThemeCreatorSelections().catch(() => null);
                }

                const regenBtn = e?.target?.closest ? e.target.closest('#theme-creator-regenerate') : null;
                if (regenBtn) {
                    if (!themeCreatorActiveThemeId) {
                        showToast('Select or create a theme first.', { level: 'warn' });
                        return;
                    }
                    if (!themeCreatorAiMovie?.tmdb_id) {
                        showToast('Select the AI movie first.', { level: 'warn' });
                        return;
                    }
                    const stylePrompt = getThemeCreatorStylePrompt();
                    generateThemeCreatorColors({
                        themeId: themeCreatorActiveThemeId,
                        themeName: themeCreatorActiveThemeName,
                        stylePrompt,
                    }).catch(() => null);
                }
            });

            document.addEventListener('keydown', (e) => {
                const target = e?.target;
                if (e.key !== 'Enter' || !target || !(target instanceof HTMLElement)) return;
                if (target.id === 'theme-creator-new-name') {
                    e.preventDefault();
                    createThemeCreatorTheme().catch(() => null);
                }
                if (target.id === 'theme-creator-edit-name') {
                    e.preventDefault();
                    updateThemeCreatorThemeName().catch(() => null);
                }
            });

            document.addEventListener('change', (e) => {
                const el = e?.target;
                if (!el || !(el instanceof HTMLSelectElement)) return;
                if (el.id === 'theme-creator-edit-select') {
                    const themeId = String(el.value || '').trim();
                    setThemeCreatorActiveTheme(themeId || null);
                    return;
                }
                if (el.hasAttribute('data-theme-existing-select')) {
                    const idx = Number(el.getAttribute('data-theme-existing-index'));
                    const value = String(el.value || '').trim();
                    if (Number.isFinite(idx)) updateThemeCreatorExistingPage(idx, value).catch(() => null);
                    return;
                }
                const kind = el.getAttribute('data-theme-creator-select');
                const idx = Number(el.getAttribute('data-theme-creator-index'));
                if (!kind || !Number.isFinite(idx)) return;
                const value = String(el.value || '').trim();
                themeCreatorSelected = themeCreatorSelected.map((item, i) => {
                    if (i !== idx) return item;
                    return { ...item, [kind]: value };
                });
            });
        }

        function initAccountPage() {
            if (accountBound) return;
            accountBound = true;

            document.addEventListener('click', async (e) => {
                const btn = e?.target?.closest ? e.target.closest('[data-account-action]') : null;
                if (!btn) return;
                const action = String(btn.dataset.accountAction || '').trim();

                if (action === 'reload') {
                    await loadAccountPage();
                    return;
                }

                if (action === 'open_profile') {
                    openAccountSectionModal('profile');
                    return;
                }

                if (action === 'open_security') {
                    openAccountSectionModal('security');
                    return;
                }

                if (action === 'open_feature') {
                    openAccountSectionModal('feature');
                    return;
                }

                if (action === 'theme_creator') {
                    router.navigate('theme_creator');
                    return;
                }

                if (action === 'close_modal') {
                    const kind = String(btn.dataset.modal || '').trim();
                    if (kind) closeAccountSectionModal(kind);
                    return;
                }

                if (action === 'logout') {
                    await handleLogoutClick(e);
                    return;
                }
            });

            document.addEventListener('click', (e) => {
                const filterBtn = e?.target?.closest ? e.target.closest('#account-achievement-filters-btn') : null;
                const pop = document.getElementById('account-achievement-filters-pop');
                if (filterBtn) {
                    e.preventDefault();
                    toggleAchievementFiltersOpen();
                    return;
                }
                if (pop && achievementFiltersOpen) {
                    const insidePop = e?.target?.closest ? e.target.closest('#account-achievement-filters-pop') : null;
                    if (!insidePop) setAchievementFiltersOpen(false);
                }
            });

            document.addEventListener('click', (e) => {
                const card = e?.target?.closest ? e.target.closest('.achievement-card[data-achievement-id]') : null;
                if (!card) return;
                const achievementId = String(card.dataset.achievementId || '').trim();
                if (!achievementId) return;
                openAchievementDetail(achievementId).catch(() => null);
            });

            document.addEventListener('submit', async (e) => {
                const form = e?.target;
                if (!form || !(form instanceof HTMLFormElement)) return;

                if (form.id === 'account-profile-form') {
                    e.preventDefault();
                    await saveAccountProfile();
                    return;
                }

                if (form.id === 'account-password-form') {
                    e.preventDefault();
                    await changeAccountPassword();
                    return;
                }

                if (form.id === 'feature-request-form') {
                    e.preventDefault();
                    await submitFeatureRequest();
                    return;
                }
            });

            document.addEventListener('input', (e) => {
                const el = e?.target;
                if (!el || !(el instanceof HTMLElement)) return;
                if (el.id === 'feature-request-text') {
                    updateFeatureRequestCounter();
                }
            });

            document.addEventListener('change', (e) => {
                const el = e?.target;
                if (!el || !(el instanceof HTMLElement)) return;
                if (el.id === 'account-achievement-sort' && el instanceof HTMLSelectElement) {
                    achievementSortMode = String(el.value || 'points_desc').trim();
                    renderAccountAchievements();
                    return;
                }
                if (el.id === 'account-achievement-filter' && el instanceof HTMLSelectElement) {
                    achievementTypeFilter = String(el.value || 'all').trim();
                    renderAccountAchievements();
                    return;
                }
                if (el.id === 'account-theme-select' && el instanceof HTMLSelectElement) {
                    const value = String(el.value || '').trim();
                    applyTheme(value);
                    saveAccountThemeSelection(value).catch(() => null);
                }
            });

            applyTheme(getStoredTheme());
            refreshAchievementsUI().catch(() => null);
        }

        async function loadAccountPage() {
            const profileStatus = document.getElementById('account-profile-status');
            const passwordStatus = document.getElementById('account-password-status');
            const emailEl = document.getElementById('account-email');
            const usernameEl = document.getElementById('account-username');
            const dnEl = document.getElementById('account-display-name');
            updateFeatureRequestCounter();

            if (profileStatus) profileStatus.textContent = '';
            if (passwordStatus) passwordStatus.textContent = '';

            if (!supabaseClient || !cachedIsAuthed) {
                if (profileStatus) profileStatus.textContent = 'Log in to manage your account.';
                if (emailEl) emailEl.textContent = '';
                updateTestAchievementVisibility('');
                return;
            }

            let user = cachedAuthUser;
            try {
                const { data: udata } = await supabaseClient.auth.getUser();
                user = udata?.user || user;
            } catch (_) {}

            const uid = String(user?.id || '').trim();
            const email = String(user?.email || '').trim();
            if (emailEl) emailEl.textContent = email || '(no email)';
            updateThemeCreatorVisibility(email);
            updateTestAchievementVisibility(email);
            refreshAchievementsUI().catch(() => null);

            if (!uid) {
                if (profileStatus) profileStatus.textContent = 'Auth session missing user id.';
                return;
            }

            if (profileStatus) profileStatus.textContent = 'Loading profile';

            try {
                let data = null;
                try {
                    const r1 = await supabaseClient
                        .from('Users')
                        .select('username, display_name, icon, theme_id')
                        .eq('id', uid)
                        .limit(1);
                    if (r1.error) throw r1.error;
                    data = r1.data;
                } catch (err1) {
                    const msg1 = String(err1?.message || err1);
                    if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                        const r2 = await supabaseClient
                            .from('Users')
                            .select('username, display_name, theme_id')
                            .eq('id', uid)
                            .limit(1);
                        if (r2.error) throw r2.error;
                        data = r2.data;
                    } else if (/column\s+"?theme_id"?\s+does\s+not\s+exist/i.test(msg1)) {
                        const r2 = await supabaseClient
                            .from('Users')
                            .select('username, display_name, icon')
                            .eq('id', uid)
                            .limit(1);
                        if (r2.error) throw r2.error;
                        data = r2.data;
                    } else {
                        throw err1;
                    }
                }

                const row = Array.isArray(data) && data.length ? data[0] : null;
                const username = String(row?.username || '').trim();
                const displayName = String(row?.display_name || '').trim();
                const themeId = String(row?.theme_id || '').trim();
                if (usernameEl) usernameEl.value = username;
                if (dnEl) dnEl.value = displayName;
                const themeSelect = document.getElementById('account-theme-select');
                if (themeSelect) {
                    const value = resolveThemeId(themeId || getStoredTheme());
                    if (value) {
                        themeSelect.value = value;
                        applyTheme(value);
                    }
                }

                if (profileStatus) profileStatus.textContent = 'Profile loaded.';
            } catch (err) {
                if (profileStatus) profileStatus.textContent = `Could not load profile: ${String(err?.message || err)}`;
            }
        }

        async function saveAccountProfile() {
            const profileStatus = document.getElementById('account-profile-status');
            const saveBtn = document.getElementById('account-save-profile');
            const usernameEl = document.getElementById('account-username');
            const dnEl = document.getElementById('account-display-name');

            if (!supabaseClient || !cachedIsAuthed) {
                showToast('Please log in first.', { level: 'warn' });
                openAuthModal();
                return;
            }

            const uid = String(cachedAuthUser?.id || '').trim();
            if (!uid) {
                showToast('Missing user session.', { level: 'error' });
                return;
            }

            const desiredUsernameRaw = String(usernameEl?.value || '');
            const desiredUsername = normalizeUsername(desiredUsernameRaw);
            const desiredDisplayName = String(dnEl?.value || '').trim();
            const userErr = validateUsername(desiredUsername);
            if (userErr) {
                if (profileStatus) profileStatus.textContent = userErr;
                showToast(userErr, { level: 'warn' });
                return;
            }

            if (desiredDisplayName.length > 50) {
                const msg = 'Display name must be 50 characters or less.';
                if (profileStatus) profileStatus.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }

            const prev = saveBtn?.textContent;
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving';
            }
            if (profileStatus) profileStatus.textContent = 'Saving';

            try {
                const payload = {
                    id: uid,
                    username: desiredUsername,
                    display_name: desiredDisplayName || null,
                };

                let data = null;
                try {
                    const r1 = await supabaseClient
                        .from('Users')
                        .upsert(payload, { onConflict: 'id' })
                        .select('username, display_name, icon')
                        .limit(1);
                    if (r1.error) throw r1.error;
                    data = r1.data;
                } catch (err1) {
                    const msg1 = String(err1?.message || err1);
                    if (/column\s+"?icon"?\s+does\s+not\s+exist/i.test(msg1)) {
                        const payload2 = { id: uid, username: desiredUsername, display_name: desiredDisplayName || null };
                        const r2 = await supabaseClient
                            .from('Users')
                            .upsert(payload2, { onConflict: 'id' })
                            .select('username, display_name')
                            .limit(1);
                        if (r2.error) throw r2.error;
                        data = r2.data;
                    } else {
                        throw err1;
                    }
                }

                const row = Array.isArray(data) && data.length ? data[0] : null;
                const savedDisplayName = String(row?.display_name || '').trim();
                // Update cached display name so navbar updates immediately.
                cachedUserDisplayNameId = uid;
                cachedUserDisplayName = savedDisplayName;
                cachedUserDisplayNameLoaded = true;
                await refreshAuthStateAndUI();

                if (profileStatus) profileStatus.textContent = 'Saved.';
                showToast('Profile updated.');
            } catch (err) {
                const code = String(err?.code || '').trim();
                const msg = String(err?.message || err);
                if (code === '23505' || /duplicate key/i.test(msg)) {
                    if (profileStatus) profileStatus.textContent = 'That username is already taken.';
                    showToast('Username already taken.', { level: 'warn' });
                } else {
                    if (profileStatus) profileStatus.textContent = `Save failed: ${msg}`;
                    showToast(`Save failed: ${msg}`, { level: 'warn' });
                }
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = prev || 'Save profile';
                }
            }
        }

        async function changeAccountPassword() {
            const statusEl = document.getElementById('account-password-status');
            const btn = document.getElementById('account-change-password');
            const newEl = document.getElementById('account-new-password');
            const confirmEl = document.getElementById('account-confirm-password');

            if (!supabaseClient || !cachedIsAuthed) {
                showToast('Please log in first.', { level: 'warn' });
                openAuthModal();
                return;
            }

            const newPassword = String(newEl?.value || '').trim();
            const confirmPassword = String(confirmEl?.value || '').trim();

            if (!newPassword || !confirmPassword) {
                const msg = 'Enter and confirm your new password.';
                if (statusEl) statusEl.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }
            if (newPassword.length < 8) {
                const msg = 'Password must be at least 8 characters.';
                if (statusEl) statusEl.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }
            if (newPassword !== confirmPassword) {
                const msg = 'Passwords do not match.';
                if (statusEl) statusEl.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }

            const prev = btn?.textContent;
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Updating';
            }
            if (statusEl) statusEl.textContent = 'Updating password';

            try {
                const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
                if (error) throw error;

                if (newEl) newEl.value = '';
                if (confirmEl) confirmEl.value = '';
                if (statusEl) statusEl.textContent = 'Password updated.';
                showToast('Password updated.');
            } catch (err) {
                const msg = String(err?.message || err);
                if (statusEl) statusEl.textContent = `Password update failed: ${msg}`;
                showToast(`Password update failed: ${msg}`, { level: 'warn' });
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = prev || 'Change password';
                }
            }
        }

        function updateFeatureRequestCounter() {
            const textEl = document.getElementById('feature-request-text');
            const remainingEl = document.getElementById('feature-request-remaining');
            if (!textEl || !remainingEl) return;
            const max = 2000;
            const used = String(textEl.value || '').length;
            const remaining = Math.max(0, max - used);
            remainingEl.textContent = `${remaining} characters remaining`;
        }

        async function submitFeatureRequest() {
            const statusEl = document.getElementById('feature-request-status');
            const textEl = document.getElementById('feature-request-text');
            const btn = document.getElementById('feature-request-submit');

            if (!supabaseClient || !cachedIsAuthed) {
                showToast('Please log in to submit feature requests.', { level: 'warn' });
                openAuthModal();
                return;
            }

            const uid = String(cachedAuthUser?.id || '').trim();
            if (!uid) {
                showToast('Missing user session.', { level: 'error' });
                return;
            }

            const feature = String(textEl?.value || '').trim();
            if (!feature) {
                const msg = 'Please describe your request.';
                if (statusEl) statusEl.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }
            if (feature.length > 2000) {
                const msg = 'Please keep requests under 2000 characters.';
                if (statusEl) statusEl.textContent = msg;
                showToast(msg, { level: 'warn' });
                return;
            }

            const prev = btn?.textContent;
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Sending';
            }
            if (statusEl) statusEl.textContent = 'Sending';

            try {
                const payload = {
                    user_id: uid,
                    feature,
                    created_at: new Date().toISOString(),
                };
                const { error } = await supabaseClient
                    .from('Feature Requests')
                    .insert(payload);
                if (error) throw error;

                if (textEl) textEl.value = '';
                updateFeatureRequestCounter();
                if (statusEl) statusEl.textContent = 'Thanks! Your request has been submitted.';
                showToast('Feature request submitted.');
            } catch (err) {
                const msg = String(err?.message || err);
                if (statusEl) statusEl.textContent = `Submit failed: ${msg}`;
                showToast(`Submit failed: ${msg}`, { level: 'warn' });
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = prev || 'Send request';
                }
            }
        }

        let toastTimer = null;

        const messageLog = [];
        const MAX_LOG_ITEMS = 300;

        function emitLog(level, message, extra = null) {
            const prefix = '[CinemaTracker]';
            const line = `${prefix} ${String(message || '')}`;

            if (level === 'error') console.error(line, extra ?? '');
            else if (level === 'warn') console.warn(line, extra ?? '');
            else console.log(line, extra ?? '');
        }

        function formatTime(ts) {
            try {
                const d = new Date(ts);
                return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } catch (_) {
                return '';
            }
        }

        function renderMessageLog() {
            const badge = document.getElementById('log-badge');
            const body = document.getElementById('log-body');
            if (badge) badge.innerText = String(messageLog.length);
            if (!body) return;

            body.innerHTML = messageLog
                .map((item) => {
                    const levelClass = item.level === 'error'
                        ? 'log-level-error'
                        : (item.level === 'warn' ? 'log-level-warn' : 'log-level-info');
                    const safeMsg = String(item.message || '').replace(/[&<>"']/g, (c) => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[c]));
                    const safeExtra = item.extra
                        ? String(item.extra).replace(/[&<>"']/g, (c) => ({
                            '&': '&amp;',
                            '<': '&lt;',
                            '>': '&gt;',
                            '"': '&quot;',
                            "'": '&#39;'
                        }[c]))
                        : '';
                    return `
<div class="log-item">
  <div class="log-meta"><span class="${levelClass}">${item.level.toUpperCase()}</span>  ${formatTime(item.ts)}</div>
  <div>${safeMsg}${safeExtra ? `<div class="log-meta">${safeExtra}</div>` : ''}</div>
</div>`;
                })
                .join('');

            // Auto-scroll to bottom
            body.scrollTop = body.scrollHeight;
        }

        function addMessageToLog(level, message, extra = null) {
            messageLog.push({ ts: Date.now(), level, message: String(message ?? ''), extra: extra ? String(extra) : null });
            while (messageLog.length > MAX_LOG_ITEMS) messageLog.shift();
            renderMessageLog();
        }

        function setLogPanelOpen(isOpen) {
            const panel = document.getElementById('log-panel');
            if (!panel) return;
            panel.classList.toggle('open', Boolean(isOpen));
        }

        function showToast(msg, opts = {}) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');

            const text = String(msg ?? '');
            const explicitLevel = String(opts.level || '').toLowerCase();
            const isError = explicitLevel === 'error' || /\b(failed|error)\b/i.test(text);
            const isWarning = explicitLevel === 'warn' || /\bwarning\b/i.test(text);
            const level = isError ? 'error' : (isWarning ? 'warn' : 'info');

            // Persist EVERYTHING (success/warn/error) to the on-page message log.
            addMessageToLog(level, text);

            // Also log errors/warnings to the console.
            if (level === 'error') emitLog('error', text);
            else if (level === 'warn') emitLog('warn', text);

            if (msgEl) msgEl.innerText = text;
            if (iconEl) iconEl.innerHTML = (level === 'info') ? icons.checkCircle : icons.info;

            toast.classList.add('show');

            // Make error toasts stick around longer.
            const durationMs = Number.isFinite(Number(opts.durationMs))
                ? Number(opts.durationMs)
                : (level === 'info' ? 3000 : 15000);

            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toast.classList.remove('show'), durationMs);

            // Allow manual dismiss (click the toast)
            toast.onclick = () => toast.classList.remove('show');
        }

        // Wire up message log UI
        (function initMessageLogUI() {
            const fab = document.getElementById('log-fab');
            const fabIcon = document.getElementById('log-fab-icon');
            const closeBtn = document.getElementById('log-close');
            const clearBtn = document.getElementById('log-clear');
            const copyBtn = document.getElementById('log-copy');

            if (fabIcon) fabIcon.innerHTML = icons.info;

            if (fab) {
                fab.addEventListener('click', () => {
                    const panel = document.getElementById('log-panel');
                    const isOpen = panel?.classList?.contains('open');
                    setLogPanelOpen(!isOpen);
                });
            }

            if (closeBtn) closeBtn.addEventListener('click', () => setLogPanelOpen(false));
            if (clearBtn) clearBtn.addEventListener('click', () => {
                messageLog.length = 0;
                renderMessageLog();
            });
            if (copyBtn) copyBtn.addEventListener('click', async () => {
                const text = messageLog
                    .map((i) => `[${i.level.toUpperCase()} ${formatTime(i.ts)}] ${i.message}${i.extra ? ` | ${i.extra}` : ''}`)
                    .join('\n');
                try {
                    await navigator.clipboard.writeText(text);
                    showToast('Log copied to clipboard');
                } catch (e) {
                    // Fallback
                    try {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        ta.remove();
                        showToast('Log copied to clipboard');
                    } catch (err) {
                        showToast(`Copy failed: ${String(err?.message || err)}`, { level: 'warn' });
                    }
                }
            });

            // Initial render
            renderMessageLog();
        })();

        // Capture uncaught errors and promise rejections too.
        window.addEventListener('error', (e) => {
            try {
                emitLog('error', `Uncaught error: ${e?.message || 'Unknown error'}`);
            } catch (_) {}
        });

        window.addEventListener('unhandledrejection', (e) => {
            try {
                const reason = e?.reason?.message || String(e?.reason || 'Unknown rejection');
                emitLog('error', `Unhandled rejection: ${reason}`);
            } catch (_) {}
        });

        // Keep auth UI synced with session changes.
        if (supabaseClient?.auth?.onAuthStateChange) {
            supabaseClient.auth.onAuthStateChange(() => {
                refreshAuthStateAndUI();
                loadThemeOptions().catch(() => null);
            });
        }

        // Warn if the user tries to save before logging in.
        document.addEventListener('click', (e) => {
            const btn = e?.target?.closest ? e.target.closest('#btn-save-diary') : null;
            if (!btn) return;

            // If the button isn't in the DOM yet, nothing to do.
            if (!supabaseClient) {
                e.preventDefault();
                e.stopPropagation();
                showToast('Supabase SDK failed to load.', { level: 'error' });
                return;
            }

            const ariaDisabled = btn.getAttribute('aria-disabled') === 'true';
            if (ariaDisabled || !cachedIsAuthed) {
                e.preventDefault();
                e.stopPropagation();
                showToast('Please log in first to save to diary.', { level: 'warn' });
                openAuthModal();
            }
        }, true);

        document.addEventListener('click', (e) => {
            const input = document.getElementById('movie-search-input');
            const res = document.getElementById('search-results');
            if(input && res && !input.contains(e.target) && !res.contains(e.target)) {
                res.classList.add('hidden');
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const isRecovery = (() => {
                try {
                    return /type=recovery/i.test(String(window.location.hash || ''));
                } catch (_) {
                    return false;
                }
            })();
            await loadThemeOptions();
            await loadThemeBackgroundImages();
            applyTheme(getStoredTheme());
            await refreshAuthStateAndUI();
            initListsPage();
            router.init();

            // If we arrived via Supabase password recovery link, send the user to Account.
            if (isRecovery) {
                try {
                    history.replaceState(null, '', window.location.pathname + window.location.search);
                } catch (_) {}
                showToast('Set a new password in Account  Security.', { level: 'info' });
                router.navigate('account');
            }
        });

        document.addEventListener('keydown', (e) => {
            const overlay = document.getElementById('auth-overlay');
            const isOpen = overlay?.classList?.contains('open');
            if (!isOpen) return;

            if (e.key === 'Escape') {
                closeAuthModal();
                return;
            }

            if (e.key === 'Enter') {
                const loginBtn = document.getElementById('auth-login-btn');
                if (loginBtn && loginBtn.style.display !== 'none') {
                    e.preventDefault();
                    loginBtn.click();
                }
            }
        });
    </script>
</body>
</html>
